cscope 15 $HOME/projects/fc-4.13-ext4               0001382079
	@acl.c

7 
	~<lšux/quÙaİs.h
>

8 
	~"ext4_jbd2.h
"

9 
	~"ext4.h
"

10 
	~"x©Œ.h
"

11 
	~"aş.h
"

16 
posix_aş
 *

17 
	$ext4_aş_äom_disk
(cÚ¡ *
v®ue
, 
size_t
 
size
)

19 cÚ¡ *
’d
 = (*)
v®ue
 + 
size
;

20 
n
, 
couÁ
;

21 
posix_aş
 *
aş
;

23 ià(!
v®ue
)

24  
NULL
;

25 ià(
size
 < (
ext4_aş_h—d”
))

26  
	`ERR_PTR
(-
EINVAL
);

27 ià(((
ext4_aş_h—d”
 *)
v®ue
)->
a_v”siÚ
 !=

28 
	`ıu_to_Ë32
(
EXT4_ACL_VERSION
))

29  
	`ERR_PTR
(-
EINVAL
);

30 
v®ue
 = (*)v®u+ (
ext4_aş_h—d”
);

31 
couÁ
 = 
	`ext4_aş_couÁ
(
size
);

32 ià(
couÁ
 < 0)

33  
	`ERR_PTR
(-
EINVAL
);

34 ià(
couÁ
 == 0)

35  
NULL
;

36 
aş
 = 
	`posix_aş_®loc
(
couÁ
, 
GFP_NOFS
);

37 ià(!
aş
)

38  
	`ERR_PTR
(-
ENOMEM
);

39 
n
 = 0;‚ < 
couÁ
;‚++) {

40 
ext4_aş_’Œy
 *
’Œy
 =

41 (
ext4_aş_’Œy
 *)
v®ue
;

42 ià((*)
v®ue
 + (
ext4_aş_’Œy_shÜt
è> 
’d
)

43 
ç
;

44 
aş
->
a_’Œ›s
[
n
].
e_g
 = 
	`Ë16_to_ıu
(
’Œy
->e_tag);

45 
aş
->
a_’Œ›s
[
n
].
e_³rm
 = 
	`Ë16_to_ıu
(
’Œy
->e_perm);

47 
aş
->
a_’Œ›s
[
n
].
e_g
) {

48 
ACL_USER_OBJ
:

49 
ACL_GROUP_OBJ
:

50 
ACL_MASK
:

51 
ACL_OTHER
:

52 
v®ue
 = (*)value +

53 (
ext4_aş_’Œy_shÜt
);

56 
ACL_USER
:

57 
v®ue
 = (*)v®u+ (
ext4_aş_’Œy
);

58 ià((*)
v®ue
 > 
’d
)

59 
ç
;

60 
aş
->
a_’Œ›s
[
n
].
e_uid
 =

61 
	`make_kuid
(&
š™_u£r_ns
,

62 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

64 
ACL_GROUP
:

65 
v®ue
 = (*)v®u+ (
ext4_aş_’Œy
);

66 ià((*)
v®ue
 > 
’d
)

67 
ç
;

68 
aş
->
a_’Œ›s
[
n
].
e_gid
 =

69 
	`make_kgid
(&
š™_u£r_ns
,

70 
	`Ë32_to_ıu
(
’Œy
->
e_id
));

74 
ç
;

77 ià(
v®ue
 !ğ
’d
)

78 
ç
;

79  
aş
;

81 
ç
:

82 
	`posix_aş_»Ëa£
(
aş
);

83  
	`ERR_PTR
(-
EINVAL
);

84 
	}
}

90 
	$ext4_aş_to_disk
(cÚ¡ 
posix_aş
 *
aş
, 
size_t
 *
size
)

92 
ext4_aş_h—d”
 *
ext_aş
;

93 *
e
;

94 
size_t
 
n
;

96 *
size
 = 
	`ext4_aş_size
(
aş
->
a_couÁ
);

97 
ext_aş
 = 
	`km®loc
((
ext4_aş_h—d”
è+ 
aş
->
a_couÁ
 *

98 (
ext4_aş_’Œy
), 
GFP_NOFS
);

99 ià(!
ext_aş
)

100  
	`ERR_PTR
(-
ENOMEM
);

101 
ext_aş
->
a_v”siÚ
 = 
	`ıu_to_Ë32
(
EXT4_ACL_VERSION
);

102 
e
 = (*)
ext_aş
 + (
ext4_aş_h—d”
);

103 
n
 = 0;‚ < 
aş
->
a_couÁ
;‚++) {

104 cÚ¡ 
posix_aş_’Œy
 *
aş_e
 = &
aş
->
a_’Œ›s
[
n
];

105 
ext4_aş_’Œy
 *
’Œy
 = (ext4_aş_’Œy *)
e
;

106 
’Œy
->
e_g
 = 
	`ıu_to_Ë16
(
aş_e
->e_tag);

107 
’Œy
->
e_³rm
 = 
	`ıu_to_Ë16
(
aş_e
->e_perm);

108 
aş_e
->
e_g
) {

109 
ACL_USER
:

110 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

111 
	`äom_kuid
(&
š™_u£r_ns
, 
aş_e
->
e_uid
));

112 
e
 +ğ(
ext4_aş_’Œy
);

114 
ACL_GROUP
:

115 
’Œy
->
e_id
 = 
	`ıu_to_Ë32
(

116 
	`äom_kgid
(&
š™_u£r_ns
, 
aş_e
->
e_gid
));

117 
e
 +ğ(
ext4_aş_’Œy
);

120 
ACL_USER_OBJ
:

121 
ACL_GROUP_OBJ
:

122 
ACL_MASK
:

123 
ACL_OTHER
:

124 
e
 +ğ(
ext4_aş_’Œy_shÜt
);

128 
ç
;

131  (*)
ext_aş
;

133 
ç
:

134 
	`kä“
(
ext_aş
);

135  
	`ERR_PTR
(-
EINVAL
);

136 
	}
}

143 
posix_aş
 *

144 
	$ext4_g‘_aş
(
šode
 *šode, 
ty³
)

146 
Çme_šdex
;

147 *
v®ue
 = 
NULL
;

148 
posix_aş
 *
aş
;

149 
»tv®
;

151 
ty³
) {

152 
ACL_TYPE_ACCESS
:

153 
Çme_šdex
 = 
EXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

155 
ACL_TYPE_DEFAULT
:

156 
Çme_šdex
 = 
EXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

159 
	`BUG
();

161 
»tv®
 = 
	`ext4_x©Œ_g‘
(
šode
, 
Çme_šdex
, "", 
NULL
, 0);

162 ià(
»tv®
 > 0) {

163 
v®ue
 = 
	`km®loc
(
»tv®
, 
GFP_NOFS
);

164 ià(!
v®ue
)

165  
	`ERR_PTR
(-
ENOMEM
);

166 
»tv®
 = 
	`ext4_x©Œ_g‘
(
šode
, 
Çme_šdex
, "", 
v®ue
,„etval);

168 ià(
»tv®
 > 0)

169 
aş
 = 
	`ext4_aş_äom_disk
(
v®ue
, 
»tv®
);

170 ià(
»tv®
 =ğ-
ENODATA
 ||„‘v® =ğ-
ENOSYS
)

171 
aş
 = 
NULL
;

173 
aş
 = 
	`ERR_PTR
(
»tv®
);

174 
	`kä“
(
v®ue
);

176  
aş
;

177 
	}
}

185 
	$__ext4_£t_aş
(
hªdË_t
 *
hªdË
, 
šode
 *šode, 
ty³
,

186 
posix_aş
 *
aş
, 
x©Œ_æags
)

188 
Çme_šdex
;

189 *
v®ue
 = 
NULL
;

190 
size_t
 
size
 = 0;

191 
”rÜ
;

193 
ty³
) {

194 
ACL_TYPE_ACCESS
:

195 
Çme_šdex
 = 
EXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

198 
ACL_TYPE_DEFAULT
:

199 
Çme_šdex
 = 
EXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

200 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

201  
aş
 ? -
EACCES
 : 0;

205  -
EINVAL
;

207 ià(
aş
) {

208 
v®ue
 = 
	`ext4_aş_to_disk
(
aş
, &
size
);

209 ià(
	`IS_ERR
(
v®ue
))

210  ()
	`PTR_ERR
(
v®ue
);

213 
”rÜ
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
, 
Çme_šdex
, "",

214 
v®ue
, 
size
, 
x©Œ_æags
);

216 
	`kä“
(
v®ue
);

217 ià(!
”rÜ
) {

218 
	`£t_ÿched_aş
(
šode
, 
ty³
, 
aş
);

221  
”rÜ
;

222 
	}
}

225 
	$ext4_£t_aş
(
šode
 *šode, 
posix_aş
 *
aş
, 
ty³
)

227 
hªdË_t
 *
hªdË
;

228 
”rÜ
, 
üed™s
, 
»Œ›s
 = 0;

229 
size_t
 
aş_size
 = 
aş
 ? 
	`ext4_aş_size
×ş->
a_couÁ
) : 0;

230 
umode_t
 
mode
 = 
šode
->
i_mode
;

231 
upd©e_mode
 = 0;

233 
”rÜ
 = 
	`dquÙ_š™Ÿlize
(
šode
);

234 ià(
”rÜ
)

235  
”rÜ
;

236 
»Œy
:

237 
”rÜ
 = 
	`ext4_x©Œ_£t_üed™s
(
šode
, 
aş_size
, 
çl£
 ,

238 &
üed™s
);

239 ià(
”rÜ
)

240  
”rÜ
;

242 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_XATTR
, 
üed™s
);

243 ià(
	`IS_ERR
(
hªdË
))

244  
	`PTR_ERR
(
hªdË
);

246 ià((
ty³
 =ğ
ACL_TYPE_ACCESS
è&& 
aş
) {

247 
”rÜ
 = 
	`posix_aş_upd©e_mode
(
šode
, &
mode
, &
aş
);

248 ià(
”rÜ
)

249 
out_¡İ
;

250 
upd©e_mode
 = 1;

253 
”rÜ
 = 
	`__ext4_£t_aş
(
hªdË
, 
šode
, 
ty³
, 
aş
, 0 );

254 ià(!
”rÜ
 && 
upd©e_mode
) {

255 
šode
->
i_mode
 = 
mode
;

256 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

257 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

258 
	`ext4_fc_Œack_šode
(
šode
);

260 
out_¡İ
:

261 
	`ext4_jouº®_¡İ
(
hªdË
);

262 ià(
”rÜ
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

263 
»Œy
;

264  
”rÜ
;

265 
	}
}

274 
	$ext4_š™_aş
(
hªdË_t
 *
hªdË
, 
šode
 *šode, šod*
dœ
)

276 
posix_aş
 *
deçuÉ_aş
, *
aş
;

277 
”rÜ
;

279 
”rÜ
 = 
	`posix_aş_ü—‹
(
dœ
, &
šode
->
i_mode
, &
deçuÉ_aş
, &
aş
);

280 ià(
”rÜ
)

281  
”rÜ
;

283 ià(
deçuÉ_aş
) {

284 
”rÜ
 = 
	`__ext4_£t_aş
(
hªdË
, 
šode
, 
ACL_TYPE_DEFAULT
,

285 
deçuÉ_aş
, 
XATTR_CREATE
);

286 
	`posix_aş_»Ëa£
(
deçuÉ_aş
);

288 ià(
aş
) {

289 ià(!
”rÜ
)

290 
”rÜ
 = 
	`__ext4_£t_aş
(
hªdË
, 
šode
, 
ACL_TYPE_ACCESS
,

291 
aş
, 
XATTR_CREATE
);

292 
	`posix_aş_»Ëa£
(
aş
);

294  
”rÜ
;

295 
	}
}

	@acl.h

7 
	~<lšux/posix_aş_x©Œ.h
>

9 
	#EXT4_ACL_VERSION
 0x0001

	)

12 
__Ë16
 
	me_g
;

13 
__Ë16
 
	me_³rm
;

14 
__Ë32
 
	me_id
;

15 } 
	text4_aş_’Œy
;

18 
__Ë16
 
	me_g
;

19 
__Ë16
 
	me_³rm
;

20 } 
	text4_aş_’Œy_shÜt
;

23 
__Ë32
 
	ma_v”siÚ
;

24 } 
	text4_aş_h—d”
;

26 
šlše
 
size_t
 
	$ext4_aş_size
(
couÁ
)

28 ià(
couÁ
 <= 4) {

29  (
ext4_aş_h—d”
) +

30 
couÁ
 * (
ext4_aş_’Œy_shÜt
);

32  (
ext4_aş_h—d”
) +

33 4 * (
ext4_aş_’Œy_shÜt
) +

34 (
couÁ
 - 4è* (
ext4_aş_’Œy
);

36 
	}
}

38 
šlše
 
	$ext4_aş_couÁ
(
size_t
 
size
)

40 
ssize_t
 
s
;

41 
size
 -ğ(
ext4_aş_h—d”
);

42 
s
 = 
size
 - 4 * (
ext4_aş_’Œy_shÜt
);

43 ià(
s
 < 0) {

44 ià(
size
 % (
ext4_aş_’Œy_shÜt
))

46  
size
 / (
ext4_aş_’Œy_shÜt
);

48 ià(
s
 % (
ext4_aş_’Œy
))

50  
s
 / (
ext4_aş_’Œy
) + 4;

52 
	}
}

54 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


57 
posix_aş
 *
ext4_g‘_aş
(
šode
 *šode, 
ty³
);

58 
ext4_£t_aş
(
šode
 *šode, 
posix_aş
 *
aş
, 
ty³
);

59 
ext4_š™_aş
(
hªdË_t
 *, 
šode
 *, inode *);

62 
	~<lšux/sched.h
>

63 
	#ext4_g‘_aş
 
NULL


	)

64 
	#ext4_£t_aş
 
NULL


	)

66 
šlše
 

67 
	$ext4_š™_aş
(
hªdË_t
 *
hªdË
, 
šode
 *šode, šod*
dœ
)

70 
	}
}

	@balloc.c

14 
	~<lšux/time.h
>

15 
	~<lšux/ÿ·b™y.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/quÙaİs.h
>

18 
	~<lšux/bufãr_h—d.h
>

19 
	~"ext4.h
"

20 
	~"ext4_jbd2.h
"

21 
	~"mb®loc.h
"

23 
	~<Œaû/ev’ts/ext4.h
>

25 
ext4_num_ba£_m‘a_şu¡”s
(
su³r_block
 *
sb
,

26 
ext4_group_t
 
block_group
);

34 
ext4_group_t
 
	$ext4_g‘_group_numb”
(
su³r_block
 *
sb
,

35 
ext4_fsblk_t
 
block
)

37 
ext4_group_t
 
group
;

39 ià(
	`‹¡_İt2
(
sb
, 
STD_GROUP_SIZE
))

40 
group
 = (
block
 -

41 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_d©a_block
)) >>

42 (
	`EXT4_BLOCK_SIZE_BITS
(
sb
è+ 
	`EXT4_CLUSTER_BITS
(sb) + 3);

44 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
block
, &
group
, 
NULL
);

45  
group
;

46 
	}
}

52 
	$ext4_g‘_group_no_ªd_off£t
(
su³r_block
 *
sb
, 
ext4_fsblk_t
 
blockÄ
,

53 
ext4_group_t
 *
blockg½p
, 
ext4_g½blk_t
 *
off£
)

55 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

56 
ext4_g½blk_t
 
off£t
;

58 
blockÄ
 = blockÄ - 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
);

59 
off£t
 = 
	`do_div
(
blockÄ
, 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)) >>

60 
	`EXT4_SB
(
sb
)->
s_şu¡”_b™s
;

61 ià(
off£
)

62 *
off£
 = 
off£t
;

63 ià(
blockg½p
)

64 *
blockg½p
 = 
blockÄ
;

66 
	}
}

72 
šlše
 
	$ext4_block_š_group
(
su³r_block
 *
sb
,

73 
ext4_fsblk_t
 
block
,

74 
ext4_group_t
 
block_group
)

76 
ext4_group_t
 
aùu®_group
;

78 
aùu®_group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
block
);

79  (
aùu®_group
 =ğ
block_group
) ? 1 : 0;

80 
	}
}

85 
	$ext4_num_ov”h—d_şu¡”s
(
su³r_block
 *
sb
,

86 
ext4_group_t
 
block_group
,

87 
ext4_group_desc
 *
gdp
)

89 
num_şu¡”s
;

90 
block_şu¡”
 = -1, 
šode_şu¡”
 = -1, 
™bl_şu¡”
 = -1, 
i
, 
c
;

91 
ext4_fsblk_t
 
¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
);

92 
ext4_fsblk_t
 
™bl_blk
;

93 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

98 
num_şu¡”s
 = 
	`ext4_num_ba£_m‘a_şu¡”s
(
sb
, 
block_group
);

112 ià(
	`ext4_block_š_group
(
sb
, 
	`ext4_block_b™m­
(sb, 
gdp
), 
block_group
)) {

113 
block_şu¡”
 = 
	`EXT4_B2C
(
sbi
,

114 
	`ext4_block_b™m­
(
sb
, 
gdp
è- 
¡¬t
);

115 ià(
block_şu¡”
 < 
num_şu¡”s
)

116 
block_şu¡”
 = -1;

117 ià(
block_şu¡”
 =ğ
num_şu¡”s
) {

118 
num_şu¡”s
++;

119 
block_şu¡”
 = -1;

123 ià(
	`ext4_block_š_group
(
sb
, 
	`ext4_šode_b™m­
(sb, 
gdp
), 
block_group
)) {

124 
šode_şu¡”
 = 
	`EXT4_B2C
(
sbi
,

125 
	`ext4_šode_b™m­
(
sb
, 
gdp
è- 
¡¬t
);

126 ià(
šode_şu¡”
 < 
num_şu¡”s
)

127 
šode_şu¡”
 = -1;

128 ià(
šode_şu¡”
 =ğ
num_şu¡”s
) {

129 
num_şu¡”s
++;

130 
šode_şu¡”
 = -1;

134 
™bl_blk
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

135 
i
 = 0; i < 
sbi
->
s_™b_³r_group
; i++) {

136 ià(
	`ext4_block_š_group
(
sb
, 
™bl_blk
 + 
i
, 
block_group
)) {

137 
c
 = 
	`EXT4_B2C
(
sbi
, 
™bl_blk
 + 
i
 - 
¡¬t
);

138 ià((
c
 < 
num_şu¡”s
è|| (ø=ğ
šode_şu¡”
) ||

139 (
c
 =ğ
block_şu¡”
è|| (ø=ğ
™bl_şu¡”
))

141 ià(
c
 =ğ
num_şu¡”s
) {

142 
num_şu¡”s
++;

145 
num_şu¡”s
++;

146 
™bl_şu¡”
 = 
c
;

150 ià(
block_şu¡”
 != -1)

151 
num_şu¡”s
++;

152 ià(
šode_şu¡”
 != -1)

153 
num_şu¡”s
++;

155  
num_şu¡”s
;

156 
	}
}

158 
	$num_şu¡”s_š_group
(
su³r_block
 *
sb
,

159 
ext4_group_t
 
block_group
)

161 
blocks
;

163 ià(
block_group
 =ğ
	`ext4_g‘_groups_couÁ
(
sb
) - 1) {

170 
blocks
 = 
	`ext4_blocks_couÁ
(
	`EXT4_SB
(
sb
)->
s_es
) -

171 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
);

173 
blocks
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

174  
	`EXT4_NUM_B2C
(
	`EXT4_SB
(
sb
), 
blocks
);

175 
	}
}

178 
	$ext4_š™_block_b™m­
(
su³r_block
 *
sb
,

179 
bufãr_h—d
 *
bh
,

180 
ext4_group_t
 
block_group
,

181 
ext4_group_desc
 *
gdp
)

183 
b™
, 
b™_max
;

184 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

185 
ext4_fsblk_t
 
¡¬t
, 
tmp
;

186 
æex_bg
 = 0;

187 
ext4_group_šfo
 *
g½
;

189 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_locked
(bh));

193 ià(!
	`ext4_group_desc_csum_v”ify
(
sb
, 
block_group
, 
gdp
)) {

194 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
);

195 ià(!
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
))

196 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

197 
g½
->
bb_ä“
);

198 
	`£t_b™
(
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &
g½
->
bb_¡©e
);

199 ià(!
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
)) {

200 
couÁ
;

201 
couÁ
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
);

202 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“šodes_couÁ”
,

203 
couÁ
);

205 
	`£t_b™
(
EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &
g½
->
bb_¡©e
);

206  -
EFSBADCRC
;

208 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

210 
b™_max
 = 
	`ext4_num_ba£_m‘a_şu¡”s
(
sb
, 
block_group
);

211 ià((
b™_max
 >> 3è>ğ
bh
->
b_size
)

212  -
EFSCORRUPTED
;

214 
b™
 = 0; b™ < 
b™_max
; bit++)

215 
	`ext4_£t_b™
(
b™
, 
bh
->
b_d©a
);

217 
¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
);

219 ià(
	`ext4_has_ã©u»_æex_bg
(
sb
))

220 
æex_bg
 = 1;

223 
tmp
 = 
	`ext4_block_b™m­
(
sb
, 
gdp
);

224 ià(!
æex_bg
 || 
	`ext4_block_š_group
(
sb
, 
tmp
, 
block_group
))

225 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
tmp
 - 
¡¬t
), 
bh
->
b_d©a
);

227 
tmp
 = 
	`ext4_šode_b™m­
(
sb
, 
gdp
);

228 ià(!
æex_bg
 || 
	`ext4_block_š_group
(
sb
, 
tmp
, 
block_group
))

229 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
tmp
 - 
¡¬t
), 
bh
->
b_d©a
);

231 
tmp
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

232 ; 
tmp
 < 
	`ext4_šode_bË
(
sb
, 
gdp
) +

233 
sbi
->
s_™b_³r_group
; 
tmp
++) {

234 ià(!
æex_bg
 || 
	`ext4_block_š_group
(
sb
, 
tmp
, 
block_group
))

235 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
tmp
 - 
¡¬t
), 
bh
->
b_d©a
);

243 
	`ext4_m¬k_b™m­_’d
(
	`num_şu¡”s_š_group
(
sb
, 
block_group
),

244 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

245 
	`ext4_block_b™m­_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bh
);

246 
	`ext4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

248 
	}
}

253 
	$ext4_ä“_şu¡”s_aá”_š™
(
su³r_block
 *
sb
,

254 
ext4_group_t
 
block_group
,

255 
ext4_group_desc
 *
gdp
)

257  
	`num_şu¡”s_š_group
(
sb
, 
block_group
) -

258 
	`ext4_num_ov”h—d_şu¡”s
(
sb
, 
block_group
, 
gdp
);

259 
	}
}

279 
ext4_group_desc
 * 
	$ext4_g‘_group_desc
(
su³r_block
 *
sb
,

280 
ext4_group_t
 
block_group
,

281 
bufãr_h—d
 **
bh
)

283 
group_desc
;

284 
off£t
;

285 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

286 
ext4_group_desc
 *
desc
;

287 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

289 ià(
block_group
 >ğ
ngroups
) {

290 
	`ext4_”rÜ
(
sb
, "block_group >= groups_count - block_group = %u,"

291 " groups_couÁ = %u", 
block_group
, 
ngroups
);

293  
NULL
;

296 
group_desc
 = 
block_group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

297 
off£t
 = 
block_group
 & (
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1);

298 ià(!
sbi
->
s_group_desc
[
group_desc
]) {

299 
	`ext4_”rÜ
(
sb
, "Group descriptor‚ot†oaded - "

301 
block_group
, 
group_desc
, 
off£t
);

302  
NULL
;

305 
desc
 = (
ext4_group_desc
 *)(

306 (
__u8
 *)
sbi
->
s_group_desc
[
group_desc
]->
b_d©a
 +

307 
off£t
 * 
	`EXT4_DESC_SIZE
(
sb
));

308 ià(
bh
)

309 *
bh
 = 
sbi
->
s_group_desc
[
group_desc
];

310  
desc
;

311 
	}
}

317 
ext4_fsblk_t
 
	$ext4_v®id_block_b™m­
(
su³r_block
 *
sb
,

318 
ext4_group_desc
 *
desc
,

319 
ext4_group_t
 
block_group
,

320 
bufãr_h—d
 *
bh
)

322 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

323 
ext4_g½blk_t
 
off£t
;

324 
ext4_g½blk_t
 
Ãxt_z”o_b™
;

325 
ext4_fsblk_t
 
blk
;

326 
ext4_fsblk_t
 
group_fœ¡_block
;

328 ià(
	`ext4_has_ã©u»_æex_bg
(
sb
)) {

337 
group_fœ¡_block
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
);

340 
blk
 = 
	`ext4_block_b™m­
(
sb
, 
desc
);

341 
off£t
 = 
blk
 - 
group_fœ¡_block
;

342 ià(!
	`ext4_‹¡_b™
(
	`EXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

344  
blk
;

347 
blk
 = 
	`ext4_šode_b™m­
(
sb
, 
desc
);

348 
off£t
 = 
blk
 - 
group_fœ¡_block
;

349 ià(!
	`ext4_‹¡_b™
(
	`EXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

351  
blk
;

354 
blk
 = 
	`ext4_šode_bË
(
sb
, 
desc
);

355 
off£t
 = 
blk
 - 
group_fœ¡_block
;

356 
Ãxt_z”o_b™
 = 
	`ext4_fšd_Ãxt_z”o_b™
(
bh
->
b_d©a
,

357 
	`EXT4_B2C
(
sbi
, 
off£t
 + 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
),

358 
	`EXT4_B2C
(
sbi
, 
off£t
));

359 ià(
Ãxt_z”o_b™
 <

360 
	`EXT4_B2C
(
sbi
, 
off£t
 + 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
))

362  
blk
;

364 
	}
}

366 
	$ext4_v®id©e_block_b™m­
(
su³r_block
 *
sb
,

367 
ext4_group_desc
 *
desc
,

368 
ext4_group_t
 
block_group
,

369 
bufãr_h—d
 *
bh
)

371 
ext4_fsblk_t
 
blk
;

372 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
);

373 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

375 ià(
	`bufãr_v”if›d
(
bh
))

377 ià(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
))

378  -
EFSCORRUPTED
;

380 
	`ext4_lock_group
(
sb
, 
block_group
);

381 ià(
	`uÆik–y
(!
	`ext4_block_b™m­_csum_v”ify
(
sb
, 
block_group
,

382 
desc
, 
bh
))) {

383 
	`ext4_uÆock_group
(
sb
, 
block_group
);

384 
	`ext4_”rÜ
(
sb
, "bg %u: bad block b™m­ checksum", 
block_group
);

385 ià(!
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
))

386 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

387 
g½
->
bb_ä“
);

388 
	`£t_b™
(
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &
g½
->
bb_¡©e
);

389  -
EFSBADCRC
;

391 
blk
 = 
	`ext4_v®id_block_b™m­
(
sb
, 
desc
, 
block_group
, 
bh
);

392 ià(
	`uÆik–y
(
blk
 != 0)) {

393 
	`ext4_uÆock_group
(
sb
, 
block_group
);

394 
	`ext4_”rÜ
(
sb
, "bg %u: block %llu: invalid block bitmap",

395 
block_group
, 
blk
);

396 ià(!
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
))

397 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

398 
g½
->
bb_ä“
);

399 
	`£t_b™
(
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &
g½
->
bb_¡©e
);

400  -
EFSCORRUPTED
;

402 
	`£t_bufãr_v”if›d
(
bh
);

403 
	`ext4_uÆock_group
(
sb
, 
block_group
);

405 
	}
}

417 
bufãr_h—d
 *

418 
	$ext4_»ad_block_b™m­_nowa™
(
su³r_block
 *
sb
, 
ext4_group_t
 
block_group
)

420 
ext4_group_desc
 *
desc
;

421 
bufãr_h—d
 *
bh
;

422 
ext4_fsblk_t
 
b™m­_blk
;

423 
”r
;

425 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, 
NULL
);

426 ià(!
desc
)

427  
	`ERR_PTR
(-
EFSCORRUPTED
);

428 
b™m­_blk
 = 
	`ext4_block_b™m­
(
sb
, 
desc
);

429 
bh
 = 
	`sb_g‘blk
(
sb
, 
b™m­_blk
);

430 ià(
	`uÆik–y
(!
bh
)) {

431 
	`ext4_”rÜ
(
sb
, "Cannot get buffer for block bitmap - "

433 
block_group
, 
b™m­_blk
);

434  
	`ERR_PTR
(-
ENOMEM
);

437 ià(
	`b™m­_u±od©e
(
bh
))

438 
v”ify
;

440 
	`lock_bufãr
(
bh
);

441 ià(
	`b™m­_u±od©e
(
bh
)) {

442 
	`uÆock_bufãr
(
bh
);

443 
v”ify
;

445 
	`ext4_lock_group
(
sb
, 
block_group
);

446 ià(
desc
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
)) {

447 
”r
 = 
	`ext4_š™_block_b™m­
(
sb
, 
bh
, 
block_group
, 
desc
);

448 
	`£t_b™m­_u±od©e
(
bh
);

449 
	`£t_bufãr_u±od©e
(
bh
);

450 
	`ext4_uÆock_group
(
sb
, 
block_group
);

451 
	`uÆock_bufãr
(
bh
);

452 ià(
”r
) {

453 
	`ext4_”rÜ
(
sb
, "Failedo init block bitmap for group "

454 "%u: %d", 
block_group
, 
”r
);

455 
out
;

457 
v”ify
;

459 
	`ext4_uÆock_group
(
sb
, 
block_group
);

460 ià(
	`bufãr_u±od©e
(
bh
)) {

465 
	`£t_b™m­_u±od©e
(
bh
);

466 
	`uÆock_bufãr
(
bh
);

467 
v”ify
;

472 
	`£t_bufãr_Ãw
(
bh
);

473 
	`Œaû_ext4_»ad_block_b™m­_lßd
(
sb
, 
block_group
);

474 
bh
->
b_’d_io
 = 
ext4_’d_b™m­_»ad
;

475 
	`g‘_bh
(
bh
);

476 
	`subm™_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

477  
bh
;

478 
v”ify
:

479 
”r
 = 
	`ext4_v®id©e_block_b™m­
(
sb
, 
desc
, 
block_group
, 
bh
);

480 ià(
”r
)

481 
out
;

482  
bh
;

483 
out
:

484 
	`put_bh
(
bh
);

485  
	`ERR_PTR
(
”r
);

486 
	}
}

489 
	$ext4_wa™_block_b™m­
(
su³r_block
 *
sb
, 
ext4_group_t
 
block_group
,

490 
bufãr_h—d
 *
bh
)

492 
ext4_group_desc
 *
desc
;

494 ià(!
	`bufãr_Ãw
(
bh
))

496 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, 
NULL
);

497 ià(!
desc
)

498  -
EFSCORRUPTED
;

499 
	`wa™_Ú_bufãr
(
bh
);

500 ià(!
	`bufãr_u±od©e
(
bh
)) {

501 
	`ext4_”rÜ
(
sb
, "Cannot„ead block bitmap - "

503 
block_group
, (è
bh
->
b_blockÄ
);

504  -
EIO
;

506 
	`ş—r_bufãr_Ãw
(
bh
);

508  
	`ext4_v®id©e_block_b™m­
(
sb
, 
desc
, 
block_group
, 
bh
);

509 
	}
}

511 
bufãr_h—d
 *

512 
	$ext4_»ad_block_b™m­
(
su³r_block
 *
sb
, 
ext4_group_t
 
block_group
)

514 
bufãr_h—d
 *
bh
;

515 
”r
;

517 
bh
 = 
	`ext4_»ad_block_b™m­_nowa™
(
sb
, 
block_group
);

518 ià(
	`IS_ERR
(
bh
))

519  
bh
;

520 
”r
 = 
	`ext4_wa™_block_b™m­
(
sb
, 
block_group
, 
bh
);

521 ià(
”r
) {

522 
	`put_bh
(
bh
);

523  
	`ERR_PTR
(
”r
);

525  
bh
;

526 
	}
}

537 
	$ext4_has_ä“_şu¡”s
(
ext4_sb_šfo
 *
sbi
,

538 
s64
 
nşu¡”s
, 
æags
)

540 
s64
 
ä“_şu¡”s
, 
dœty_şu¡”s
, 
rsv
, 
»sv_şu¡”s
;

541 
³rıu_couÁ”
 *
fcc
 = &
sbi
->
s_ä“şu¡”s_couÁ”
;

542 
³rıu_couÁ”
 *
dcc
 = &
sbi
->
s_dœtyşu¡”s_couÁ”
;

544 
ä“_şu¡”s
 = 
	`³rıu_couÁ”_»ad_pos™ive
(
fcc
);

545 
dœty_şu¡”s
 = 
	`³rıu_couÁ”_»ad_pos™ive
(
dcc
);

546 
»sv_şu¡”s
 = 
	`©omic64_»ad
(&
sbi
->
s_»sv_şu¡”s
);

552 
rsv
 = (
	`ext4_r_blocks_couÁ
(
sbi
->
s_es
è>> sbi->
s_şu¡”_b™s
) +

553 
»sv_şu¡”s
;

555 ià(
ä“_şu¡”s
 - (
nşu¡”s
 + 
rsv
 + 
dœty_şu¡”s
) <

556 
EXT4_FREECLUSTERS_WATERMARK
) {

557 
ä“_şu¡”s
 = 
	`³rıu_couÁ”_sum_pos™ive
(
fcc
);

558 
dœty_şu¡”s
 = 
	`³rıu_couÁ”_sum_pos™ive
(
dcc
);

563 ià(
ä“_şu¡”s
 >ğ(
rsv
 + 
nşu¡”s
 + 
dœty_şu¡”s
))

567 ià(
	`uid_eq
(
sbi
->
s_»suid
, 
	`cu¼’t_fsuid
()) ||

568 (!
	`gid_eq
(
sbi
->
s_»sgid
, 
GLOBAL_ROOT_GID
è&& 
	`š_group_p
(sbi->s_resgid)) ||

569 
	`ÿ·bË
(
CAP_SYS_RESOURCE
) ||

570 (
æags
 & 
EXT4_MB_USE_ROOT_BLOCKS
)) {

572 ià(
ä“_şu¡”s
 >ğ(
nşu¡”s
 + 
dœty_şu¡”s
 +

573 
»sv_şu¡”s
))

577 ià(
æags
 & 
EXT4_MB_USE_RESERVED
) {

578 ià(
ä“_şu¡”s
 >ğ(
nşu¡”s
 + 
dœty_şu¡”s
))

583 
	}
}

585 
	$ext4_şaim_ä“_şu¡”s
(
ext4_sb_šfo
 *
sbi
,

586 
s64
 
nşu¡”s
, 
æags
)

588 ià(
	`ext4_has_ä“_şu¡”s
(
sbi
, 
nşu¡”s
, 
æags
)) {

589 
	`³rıu_couÁ”_add
(&
sbi
->
s_dœtyşu¡”s_couÁ”
, 
nşu¡”s
);

592  -
ENOSPC
;

593 
	}
}

607 
	$ext4_should_»Œy_®loc
(
su³r_block
 *
sb
, *
»Œ›s
)

609 ià(!
	`ext4_has_ä“_şu¡”s
(
	`EXT4_SB
(
sb
), 1, 0) ||

610 (*
»Œ›s
)++ > 3 ||

611 !
	`EXT4_SB
(
sb
)->
s_jouº®
)

614 
	`jbd_debug
(1, "%s:„‘ryšg o³¿tiÚ‡á” ENOSPC\n", 
sb
->
s_id
);

616 
	`smp_mb
();

617 ià(
	`EXT4_SB
(
sb
)->
s_mb_ä“_³ndšg
)

618 
	`jbd2_jouº®_fÜû_comm™_Ã¡ed
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

620 
	}
}

634 
ext4_fsblk_t
 
	$ext4_Ãw_m‘a_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

635 
ext4_fsblk_t
 
gßl
, 
æags
,

636 *
couÁ
, *
”½
)

638 
ext4_®loÿtiÚ_»que¡
 
¬
;

639 
ext4_fsblk_t
 
»t
;

641 
	`mem£t
(&
¬
, 0, (ar));

643 
¬
.
šode
 = inode;

644 
¬
.
gßl
 = goal;

645 
¬
.
Ën
 = 
couÁ
 ? *count : 1;

646 
¬
.
æags
 = flags;

652 
»t
 = 
	`ext4_mb_Ãw_blocks
(
hªdË
, &
¬
, 
”½
);

653 ià(
couÁ
)

654 *
couÁ
 = 
¬
.
Ën
;

659 ià(!(*
”½
è&& (
æags
 & 
EXT4_MB_DELALLOC_RESERVED
)) {

660 
	`dquÙ_®loc_block_noç
(
šode
,

661 
	`EXT4_C2B
(
	`EXT4_SB
(
šode
->
i_sb
), 
¬
.
Ën
));

663  
»t
;

664 
	}
}

672 
ext4_fsblk_t
 
	$ext4_couÁ_ä“_şu¡”s
(
su³r_block
 *
sb
)

674 
ext4_fsblk_t
 
desc_couÁ
;

675 
ext4_group_desc
 *
gdp
;

676 
ext4_group_t
 
i
;

677 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

678 
ext4_group_šfo
 *
g½
;

679 #ifdeà
EXT4FS_DEBUG


680 
ext4_su³r_block
 *
es
;

681 
ext4_fsblk_t
 
b™m­_couÁ
;

682 
x
;

683 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

685 
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

686 
desc_couÁ
 = 0;

687 
b™m­_couÁ
 = 0;

688 
gdp
 = 
NULL
;

690 
i
 = 0; i < 
ngroups
; i++) {

691 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

692 ià(!
gdp
)

694 
g½
 = 
NULL
;

695 ià(
	`EXT4_SB
(
sb
)->
s_group_šfo
)

696 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
i
);

697 ià(!
g½
 || !
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

698 
desc_couÁ
 +ğ
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
);

699 
	`b»l£
(
b™m­_bh
);

700 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
i
);

701 ià(
	`IS_ERR
(
b™m­_bh
)) {

702 
b™m­_bh
 = 
NULL
;

706 
x
 = 
	`ext4_couÁ_ä“
(
b™m­_bh
->
b_d©a
,

707 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

708 
	`´štk
(
KERN_DEBUG
 "group %u: stored = %d, counted = %u\n",

709 
i
, 
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
), 
x
);

710 
b™m­_couÁ
 +ğ
x
;

712 
	`b»l£
(
b™m­_bh
);

713 
	`´štk
(
KERN_DEBUG
 "ext4_count_free_clusters: stored = %llu"

715 
	`EXT4_NUM_B2C
(
	`EXT4_SB
(
sb
), 
	`ext4_ä“_blocks_couÁ
(
es
)),

716 
desc_couÁ
, 
b™m­_couÁ
);

717  
b™m­_couÁ
;

719 
desc_couÁ
 = 0;

720 
i
 = 0; i < 
ngroups
; i++) {

721 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

722 ià(!
gdp
)

724 
g½
 = 
NULL
;

725 ià(
	`EXT4_SB
(
sb
)->
s_group_šfo
)

726 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
i
);

727 ià(!
g½
 || !
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

728 
desc_couÁ
 +ğ
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
);

731  
desc_couÁ
;

733 
	}
}

735 
šlše
 
	$‹¡_roÙ
(
ext4_group_t
 
a
, 
b
)

738 ià(
a
 < 
b
)

740 ià(
a
 =ğ
b
)

742 ià((
a
 % 
b
) != 0)

744 
a
 =‡ / 
b
;

746 
	}
}

756 
	$ext4_bg_has_su³r
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
)

758 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

760 ià(
group
 == 0)

762 ià(
	`ext4_has_ã©u»_¥¬£_su³r2
(
sb
)) {

763 ià(
group
 =ğ
	`Ë32_to_ıu
(
es
->
s_backup_bgs
[0]) ||

764 
group
 =ğ
	`Ë32_to_ıu
(
es
->
s_backup_bgs
[1]))

768 ià((
group
 <ğ1è|| !
	`ext4_has_ã©u»_¥¬£_su³r
(
sb
))

770 ià(!(
group
 & 1))

772 ià(
	`‹¡_roÙ
(
group
, 3) || (test_root(group, 5)) ||

773 
	`‹¡_roÙ
(
group
, 7))

777 
	}
}

779 
	$ext4_bg_num_gdb_m‘a
(
su³r_block
 *
sb
,

780 
ext4_group_t
 
group
)

782 
m‘agroup
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

783 
ext4_group_t
 
fœ¡
 = 
m‘agroup
 * 
	`EXT4_DESC_PER_BLOCK
(
sb
);

784 
ext4_group_t
 
Ï¡
 = 
fœ¡
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1;

786 ià(
group
 =ğ
fœ¡
 || grou°=ğfœ¡ + 1 || grou°=ğ
Ï¡
)

789 
	}
}

791 
	$ext4_bg_num_gdb_nom‘a
(
su³r_block
 *
sb
,

792 
ext4_group_t
 
group
)

794 ià(!
	`ext4_bg_has_su³r
(
sb
, 
group
))

797 ià(
	`ext4_has_ã©u»_m‘a_bg
(
sb
))

798  
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_m‘a_bg
);

800  
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
;

801 
	}
}

812 
	$ext4_bg_num_gdb
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
)

814 
fœ¡_m‘a_bg
 =

815 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_m‘a_bg
);

816 
m‘agroup
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

818 ià(!
	`ext4_has_ã©u»_m‘a_bg
(
sb
è|| 
m‘agroup
 < 
fœ¡_m‘a_bg
)

819  
	`ext4_bg_num_gdb_nom‘a
(
sb
, 
group
);

821  
	`ext4_bg_num_gdb_m‘a
(
sb
,
group
);

823 
	}
}

829 
	$ext4_num_ba£_m‘a_şu¡”s
(
su³r_block
 *
sb
,

830 
ext4_group_t
 
block_group
)

832 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

833 
num
;

836 
num
 = 
	`ext4_bg_has_su³r
(
sb
, 
block_group
);

838 ià(!
	`ext4_has_ã©u»_m‘a_bg
(
sb
) ||

839 
block_group
 < 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_m‘a_bg
) *

840 
sbi
->
s_desc_³r_block
) {

841 ià(
num
) {

842 
num
 +ğ
	`ext4_bg_num_gdb
(
sb
, 
block_group
);

843 
num
 +ğ
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_»£rved_gdt_blocks
);

846 
num
 +ğ
	`ext4_bg_num_gdb
(
sb
, 
block_group
);

848  
	`EXT4_NUM_B2C
(
sbi
, 
num
);

849 
	}
}

857 
ext4_fsblk_t
 
	$ext4_šode_to_gßl_block
(
šode
 *inode)

859 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

860 
ext4_group_t
 
block_group
;

861 
ext4_g½blk_t
 
cŞour
;

862 
æex_size
 = 
	`ext4_æex_bg_size
(
	`EXT4_SB
(
šode
->
i_sb
));

863 
ext4_fsblk_t
 
bg_¡¬t
;

864 
ext4_fsblk_t
 
Ï¡_block
;

866 
block_group
 = 
ei
->
i_block_group
;

867 ià(
æex_size
 >ğ
EXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) {

876 
block_group
 &ğ~(
æex_size
-1);

877 ià(
	`S_ISREG
(
šode
->
i_mode
))

878 
block_group
++;

880 
bg_¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
šode
->
i_sb
, 
block_group
);

881 
Ï¡_block
 = 
	`ext4_blocks_couÁ
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
) - 1;

887 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
))

888  
bg_¡¬t
;

890 ià(
bg_¡¬t
 + 
	`EXT4_BLOCKS_PER_GROUP
(
šode
->
i_sb
è<ğ
Ï¡_block
)

891 
cŞour
 = (
cu¼’t
->
pid
 % 16) *

892 (
	`EXT4_BLOCKS_PER_GROUP
(
šode
->
i_sb
) / 16);

894 
cŞour
 = (
cu¼’t
->
pid
 % 16è* ((
Ï¡_block
 - 
bg_¡¬t
) / 16);

895  
bg_¡¬t
 + 
cŞour
;

896 
	}
}

	@bitmap.c

10 
	~<lšux/bufãr_h—d.h
>

11 
	~"ext4.h
"

13 
	$ext4_couÁ_ä“
(*
b™m­
, 
numch¬s
)

15  
numch¬s
 * 
BITS_PER_BYTE
 - 
	`memweight
(
b™m­
,‚umchars);

16 
	}
}

18 
	$ext4_šode_b™m­_csum_v”ify
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

19 
ext4_group_desc
 *
gdp
,

20 
bufãr_h—d
 *
bh
, 
sz
)

22 
__u32
 
hi
;

23 
__u32
 
´ovided
, 
ÿlcuÏ‹d
;

24 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

26 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

29 
´ovided
 = 
	`Ë16_to_ıu
(
gdp
->
bg_šode_b™m­_csum_lo
);

30 
ÿlcuÏ‹d
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

31 ià(
sbi
->
s_desc_size
 >ğ
EXT4_BG_INODE_BITMAP_CSUM_HI_END
) {

32 
hi
 = 
	`Ë16_to_ıu
(
gdp
->
bg_šode_b™m­_csum_hi
);

33 
´ovided
 |ğ(
hi
 << 16);

35 
ÿlcuÏ‹d
 &= 0xFFFF;

37  
´ovided
 =ğ
ÿlcuÏ‹d
;

38 
	}
}

40 
	$ext4_šode_b™m­_csum_£t
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

41 
ext4_group_desc
 *
gdp
,

42 
bufãr_h—d
 *
bh
, 
sz
)

44 
__u32
 
csum
;

45 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

47 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

50 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

51 
gdp
->
bg_šode_b™m­_csum_lo
 = 
	`ıu_to_Ë16
(
csum
 & 0xFFFF);

52 ià(
sbi
->
s_desc_size
 >ğ
EXT4_BG_INODE_BITMAP_CSUM_HI_END
)

53 
gdp
->
bg_šode_b™m­_csum_hi
 = 
	`ıu_to_Ë16
(
csum
 >> 16);

54 
	}
}

56 
	$ext4_block_b™m­_csum_v”ify
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

57 
ext4_group_desc
 *
gdp
,

58 
bufãr_h—d
 *
bh
)

60 
__u32
 
hi
;

61 
__u32
 
´ovided
, 
ÿlcuÏ‹d
;

62 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

63 
sz
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

65 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

68 
´ovided
 = 
	`Ë16_to_ıu
(
gdp
->
bg_block_b™m­_csum_lo
);

69 
ÿlcuÏ‹d
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

70 ià(
sbi
->
s_desc_size
 >ğ
EXT4_BG_BLOCK_BITMAP_CSUM_HI_END
) {

71 
hi
 = 
	`Ë16_to_ıu
(
gdp
->
bg_block_b™m­_csum_hi
);

72 
´ovided
 |ğ(
hi
 << 16);

74 
ÿlcuÏ‹d
 &= 0xFFFF;

76 ià(
´ovided
 =ğ
ÿlcuÏ‹d
)

80 
	}
}

82 
	$ext4_block_b™m­_csum_£t
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

83 
ext4_group_desc
 *
gdp
,

84 
bufãr_h—d
 *
bh
)

86 
sz
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

87 
__u32
 
csum
;

88 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

90 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

93 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

94 
gdp
->
bg_block_b™m­_csum_lo
 = 
	`ıu_to_Ë16
(
csum
 & 0xFFFF);

95 ià(
sbi
->
s_desc_size
 >ğ
EXT4_BG_BLOCK_BITMAP_CSUM_HI_END
)

96 
gdp
->
bg_block_b™m­_csum_hi
 = 
	`ıu_to_Ë16
(
csum
 >> 16);

97 
	}
}

	@block_validity.c

11 
	~<lšux/time.h
>

12 
	~<lšux/fs.h
>

13 
	~<lšux/Çmei.h
>

14 
	~<lšux/quÙaİs.h
>

15 
	~<lšux/bufãr_h—d.h
>

16 
	~<lšux/sw­.h
>

17 
	~<lšux/·gem­.h
>

18 
	~<lšux/blkdev.h
>

19 
	~<lšux/¦ab.h
>

20 
	~"ext4.h
"

22 
	sext4_sy¡em_zÚe
 {

23 
rb_node
 
	mnode
;

24 
ext4_fsblk_t
 
	m¡¬t_blk
;

25 
	mcouÁ
;

28 
kmem_ÿche
 *
	gext4_sy¡em_zÚe_ÿch•
;

30 
__š™
 
	$ext4_š™_sy¡em_zÚe
()

32 
ext4_sy¡em_zÚe_ÿch•
 = 
	`KMEM_CACHE
(
ext4_sy¡em_zÚe
, 0);

33 ià(
ext4_sy¡em_zÚe_ÿch•
 =ğ
NULL
)

34  -
ENOMEM
;

36 
	}
}

38 
	$ext4_ex™_sy¡em_zÚe
()

40 
	`kmem_ÿche_de¡roy
(
ext4_sy¡em_zÚe_ÿch•
);

41 
	}
}

43 
šlše
 
	$ÿn_m”ge
(
ext4_sy¡em_zÚe
 *
’Œy1
,

44 
ext4_sy¡em_zÚe
 *
’Œy2
)

46 ià((
’Œy1
->
¡¬t_blk
 +ƒÁry1->
couÁ
è=ğ
’Œy2
->start_blk)

49 
	}
}

56 
	$add_sy¡em_zÚe
(
ext4_sb_šfo
 *
sbi
,

57 
ext4_fsblk_t
 
¡¬t_blk
,

58 
couÁ
)

60 
ext4_sy¡em_zÚe
 *
Ãw_’Œy
 = 
NULL
, *
’Œy
;

61 
rb_node
 **
n
 = &
sbi
->
sy¡em_blks
.rb_node, *
node
;

62 
rb_node
 *
·»Á
 = 
NULL
, *
Ãw_node
 = NULL;

64 *
n
) {

65 
·»Á
 = *
n
;

66 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ext4_sy¡em_zÚe
, 
node
);

67 ià(
¡¬t_blk
 < 
’Œy
->start_blk)

68 
n
 = &(*n)->
rb_Ëá
;

69 ià(
¡¬t_blk
 >ğ(
’Œy
->¡¬t_blk +ƒÁry->
couÁ
))

70 
n
 = &(*n)->
rb_right
;

72 ià(
¡¬t_blk
 + 
couÁ
 > (
’Œy
->start_blk +

73 
’Œy
->
couÁ
))

74 
’Œy
->
couÁ
 = (
¡¬t_blk
 + count -

75 
’Œy
->
¡¬t_blk
);

76 
Ãw_node
 = *
n
;

77 
Ãw_’Œy
 = 
	`rb_’Œy
(
Ãw_node
, 
ext4_sy¡em_zÚe
,

78 
node
);

83 ià(!
Ãw_’Œy
) {

84 
Ãw_’Œy
 = 
	`kmem_ÿche_®loc
(
ext4_sy¡em_zÚe_ÿch•
,

85 
GFP_KERNEL
);

86 ià(!
Ãw_’Œy
)

87  -
ENOMEM
;

88 
Ãw_’Œy
->
¡¬t_blk
 = start_blk;

89 
Ãw_’Œy
->
couÁ
 = count;

90 
Ãw_node
 = &
Ãw_’Œy
->
node
;

92 
	`rb_lšk_node
(
Ãw_node
, 
·»Á
, 
n
);

93 
	`rb_š£¹_cŞÜ
(
Ãw_node
, &
sbi
->
sy¡em_blks
);

97 
node
 = 
	`rb_´ev
(
Ãw_node
);

98 ià(
node
) {

99 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_sy¡em_zÚe
,‚ode);

100 ià(
	`ÿn_m”ge
(
’Œy
, 
Ãw_’Œy
)) {

101 
Ãw_’Œy
->
¡¬t_blk
 = 
’Œy
->start_blk;

102 
Ãw_’Œy
->
couÁ
 +ğ
’Œy
->count;

103 
	`rb_”a£
(
node
, &
sbi
->
sy¡em_blks
);

104 
	`kmem_ÿche_ä“
(
ext4_sy¡em_zÚe_ÿch•
, 
’Œy
);

109 
node
 = 
	`rb_Ãxt
(
Ãw_node
);

110 ià(
node
) {

111 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_sy¡em_zÚe
,‚ode);

112 ià(
	`ÿn_m”ge
(
Ãw_’Œy
, 
’Œy
)) {

113 
Ãw_’Œy
->
couÁ
 +ğ
’Œy
->count;

114 
	`rb_”a£
(
node
, &
sbi
->
sy¡em_blks
);

115 
	`kmem_ÿche_ä“
(
ext4_sy¡em_zÚe_ÿch•
, 
’Œy
);

119 
	}
}

121 
	$debug_´št_Œ“
(
ext4_sb_šfo
 *
sbi
)

123 
rb_node
 *
node
;

124 
ext4_sy¡em_zÚe
 *
’Œy
;

125 
fœ¡
 = 1;

127 
	`´štk
(
KERN_INFO
 "System zones: ");

128 
node
 = 
	`rb_fœ¡
(&
sbi
->
sy¡em_blks
);

129 
node
) {

130 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_sy¡em_zÚe
,‚ode);

131 
	`´štk
(
KERN_CONT
 "%s%Îu-%Îu", 
fœ¡
 ? "" : ", ",

132 
’Œy
->
¡¬t_blk
,ƒÁry->¡¬t_blk +ƒÁry->
couÁ
 - 1);

133 
fœ¡
 = 0;

134 
node
 = 
	`rb_Ãxt
(node);

136 
	`´štk
(
KERN_CONT
 "\n");

137 
	}
}

139 
	$ext4_£tup_sy¡em_zÚe
(
su³r_block
 *
sb
)

141 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

142 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

143 
ext4_group_desc
 *
gdp
;

144 
ext4_group_t
 
i
;

145 
æex_size
 = 
	`ext4_æex_bg_size
(
sbi
);

146 
»t
;

148 ià(!
	`‹¡_İt
(
sb
, 
BLOCK_VALIDITY
)) {

149 ià(
	`EXT4_SB
(
sb
)->
sy¡em_blks
.
rb_node
)

150 
	`ext4_»Ëa£_sy¡em_zÚe
(
sb
);

153 ià(
	`EXT4_SB
(
sb
)->
sy¡em_blks
.
rb_node
)

156 
i
=0; i < 
ngroups
; i++) {

157 ià(
	`ext4_bg_has_su³r
(
sb
, 
i
) &&

158 ((
i
 < 5è|| ((˜% 
æex_size
) == 0)))

159 
	`add_sy¡em_zÚe
(
sbi
, 
	`ext4_group_fœ¡_block_no
(
sb
, 
i
),

160 
	`ext4_bg_num_gdb
(
sb
, 
i
) + 1);

161 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

162 
»t
 = 
	`add_sy¡em_zÚe
(
sbi
, 
	`ext4_block_b™m­
(
sb
, 
gdp
), 1);

163 ià(
»t
)

164  
»t
;

165 
»t
 = 
	`add_sy¡em_zÚe
(
sbi
, 
	`ext4_šode_b™m­
(
sb
, 
gdp
), 1);

166 ià(
»t
)

167  
»t
;

168 
»t
 = 
	`add_sy¡em_zÚe
(
sbi
, 
	`ext4_šode_bË
(
sb
, 
gdp
),

169 
sbi
->
s_™b_³r_group
);

170 ià(
»t
)

171  
»t
;

174 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

175 
	`debug_´št_Œ“
(
	`EXT4_SB
(
sb
));

177 
	}
}

180 
	$ext4_»Ëa£_sy¡em_zÚe
(
su³r_block
 *
sb
)

182 
ext4_sy¡em_zÚe
 *
’Œy
, *
n
;

184 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
’Œy
, 
n
,

185 &
	`EXT4_SB
(
sb
)->
sy¡em_blks
, 
node
)

186 
	`kmem_ÿche_ä“
(
ext4_sy¡em_zÚe_ÿch•
, 
’Œy
);

188 
	`EXT4_SB
(
sb
)->
sy¡em_blks
 = 
RB_ROOT
;

189 
	}
}

196 
	$ext4_d©a_block_v®id
(
ext4_sb_šfo
 *
sbi
, 
ext4_fsblk_t
 
¡¬t_blk
,

197 
couÁ
)

199 
ext4_sy¡em_zÚe
 *
’Œy
;

200 
rb_node
 *
n
 = 
sbi
->
sy¡em_blks
.rb_node;

202 ià((
¡¬t_blk
 <ğ
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
)) ||

203 (
¡¬t_blk
 + 
couÁ
 < start_blk) ||

204 (
¡¬t_blk
 + 
couÁ
 > 
	`ext4_blocks_couÁ
(
sbi
->
s_es
))) {

205 
sbi
->
s_es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
¡¬t_blk
);

208 
n
) {

209 
’Œy
 = 
	`rb_’Œy
(
n
, 
ext4_sy¡em_zÚe
, 
node
);

210 ià(
¡¬t_blk
 + 
couÁ
 - 1 < 
’Œy
->start_blk)

211 
n
 =‚->
rb_Ëá
;

212 ià(
¡¬t_blk
 >ğ(
’Œy
->¡¬t_blk +ƒÁry->
couÁ
))

213 
n
 =‚->
rb_right
;

215 
sbi
->
s_es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
¡¬t_blk
);

220 
	}
}

222 
	$ext4_check_block»f
(cÚ¡ *
funùiÚ
, 
lše
,

223 
šode
 *šode, 
__Ë32
 *
p
, 
max
)

225 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

226 
__Ë32
 *
b»f
 = 
p
;

227 
blk
;

229 
b»f
 < 
p
+
max
) {

230 
blk
 = 
	`Ë32_to_ıu
(*
b»f
++);

231 ià(
blk
 &&

232 
	`uÆik–y
(!
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
),

233 
blk
, 1))) {

234 
es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
blk
);

235 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 
blk
,

237  -
EFSCORRUPTED
;

241 
	}
}

	@dir.c

24 
	~<lšux/fs.h
>

25 
	~<lšux/bufãr_h—d.h
>

26 
	~<lšux/¦ab.h
>

27 
	~"ext4.h
"

28 
	~"x©Œ.h
"

30 
ext4_dx_»addœ
(
fe
 *, 
dœ_cÚ‹xt
 *);

39 
	$is_dx_dœ
(
šode
 *inode)

41 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

43 ià(
	`ext4_has_ã©u»_dœ_šdex
(
šode
->
i_sb
) &&

44 ((
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_INDEX
)) ||

45 ((
šode
->
i_size
 >> 
sb
->
s_blocksize_b™s
) == 1) ||

46 
	`ext4_has_šlše_d©a
(
šode
)))

50 
	}
}

60 
	$__ext4_check_dœ_’Œy
(cÚ¡ *
funùiÚ
, 
lše
,

61 
šode
 *
dœ
, 
fe
 *
fp
,

62 
ext4_dœ_’Œy_2
 *
de
,

63 
bufãr_h—d
 *
bh
, *
buf
, 
size
,

64 
off£t
)

66 cÚ¡ *
”rÜ_msg
 = 
NULL
;

67 cÚ¡ 
¾’
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

68 
dœ
->
i_sb
->
s_blocksize
);

70 ià(
	`uÆik–y
(
¾’
 < 
	`EXT4_DIR_REC_LEN
(1)))

71 
”rÜ_msg
 = "rec_len is smallerhan minimal";

72 ià(
	`uÆik–y
(
¾’
 % 4 != 0))

73 
”rÜ_msg
 = "rec_len % 4 != 0";

74 ià(
	`uÆik–y
(
¾’
 < 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
)))

75 
”rÜ_msg
 = "rec_len isoo small for‚ame_len";

76 ià(
	`uÆik–y
(((*è
de
 - 
buf
è+ 
¾’
 > 
size
))

77 
”rÜ_msg
 = "directoryƒntry‡cross„ange";

78 ià(
	`uÆik–y
(
	`Ë32_to_ıu
(
de
->
šode
) >

79 
	`Ë32_to_ıu
(
	`EXT4_SB
(
dœ
->
i_sb
)->
s_es
->
s_šodes_couÁ
)))

80 
”rÜ_msg
 = "inode out of bounds";

84 ià(
fp
)

85 
	`ext4_”rÜ_fe
(
fp
, 
funùiÚ
, 
lše
, 
bh
->
b_blockÄ
,

88 
”rÜ_msg
, (è(
off£t
 % 
size
),

89 
off£t
, 
	`Ë32_to_ıu
(
de
->
šode
),

90 
¾’
, 
de
->
Çme_Ën
);

92 
	`ext4_”rÜ_šode
(
dœ
, 
funùiÚ
, 
lše
, 
bh
->
b_blockÄ
,

95 
”rÜ_msg
, (è(
off£t
 % 
size
),

96 
off£t
, 
	`Ë32_to_ıu
(
de
->
šode
),

97 
¾’
, 
de
->
Çme_Ën
);

100 
	}
}

102 
	$ext4_»addœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
)

104 
off£t
;

105 
i
;

106 
ext4_dœ_’Œy_2
 *
de
;

107 
”r
;

108 
šode
 *šodğ
	`fe_šode
(
fe
);

109 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

110 
bufãr_h—d
 *
bh
 = 
NULL
;

111 
dœ_has_”rÜ
 = 0;

112 
fsüy±_¡r
 
f¡r
 = 
	`FSTR_INIT
(
NULL
, 0);

114 ià(
	`ext4_’üy±ed_šode
(
šode
)) {

115 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
);

116 ià(
”r
 &&ƒ¼ !ğ-
ENOKEY
)

117  
”r
;

120 ià(
	`is_dx_dœ
(
šode
)) {

121 
”r
 = 
	`ext4_dx_»addœ
(
fe
, 
ùx
);

122 ià(
”r
 !ğ
ERR_BAD_DX_DIR
) {

123  
”r
;

129 
	`ext4_ş—r_šode_æag
(
	`fe_šode
(
fe
),

130 
EXT4_INODE_INDEX
);

133 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

134 
has_šlše_d©a
 = 1;

135 
”r
 = 
	`ext4_»ad_šlše_dœ
(
fe
, 
ùx
,

136 &
has_šlše_d©a
);

137 ià(
has_šlše_d©a
)

138  
”r
;

141 ià(
	`ext4_’üy±ed_šode
(
šode
)) {

142 
”r
 = 
	`fsüy±_âame_®loc_bufãr
(
šode
, 
EXT4_NAME_LEN
, &
f¡r
);

143 ià(
”r
 < 0)

144  
”r
;

147 
off£t
 = 
ùx
->
pos
 & (
sb
->
s_blocksize
 - 1);

149 
ùx
->
pos
 < 
šode
->
i_size
) {

150 
ext4_m­_blocks
 
m­
;

152 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

153 
”r
 = -
ERESTARTSYS
;

154 
”rout
;

156 
	`cÚd_»sched
();

157 
m­
.
m_lblk
 = 
ùx
->
pos
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

158 
m­
.
m_Ën
 = 1;

159 
”r
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

160 ià(
”r
 > 0) {

161 
pgoff_t
 
šdex
 = 
m­
.
m_pblk
 >>

162 (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

163 ià(!
	`¿_has_šdex
(&
fe
->
f_¿
, 
šdex
))

164 
	`·ge_ÿche_sync_»adah—d
(

165 
sb
->
s_bdev
->
bd_šode
->
i_m­pšg
,

166 &
fe
->
f_¿
, file,

167 
šdex
, 1);

168 
fe
->
f_¿
.
´ev_pos
 = (
loff_t
)
šdex
 << 
PAGE_SHIFT
;

169 
bh
 = 
	`ext4_b»ad
(
NULL
, 
šode
, 
m­
.
m_lblk
, 0);

170 ià(
	`IS_ERR
(
bh
)) {

171 
”r
 = 
	`PTR_ERR
(
bh
);

172 
bh
 = 
NULL
;

173 
”rout
;

177 ià(!
bh
) {

178 ià(!
dœ_has_”rÜ
) {

179 
	`EXT4_ERROR_FILE
(
fe
, 0,

182 (è
ùx
->
pos
);

183 
dœ_has_”rÜ
 = 1;

186 ià(
ùx
->
pos
 > 
šode
->
i_blocks
 << 9)

188 
ùx
->
pos
 +ğ
sb
->
s_blocksize
 - 
off£t
;

193 ià(!
	`bufãr_v”if›d
(
bh
) &&

194 !
	`ext4_dœ’t_csum_v”ify
(
šode
,

195 (
ext4_dœ_’Œy
 *)
bh
->
b_d©a
)) {

196 
	`EXT4_ERROR_FILE
(
fe
, 0, "directory fails checksum "

198 ()
ùx
->
pos
);

199 
ùx
->
pos
 +ğ
sb
->
s_blocksize
 - 
off£t
;

200 
	`b»l£
(
bh
);

201 
bh
 = 
NULL
;

204 
	`£t_bufãr_v”if›d
(
bh
);

210 ià(
fe
->
f_v”siÚ
 !ğ
šode
->
i_v”siÚ
) {

211 
i
 = 0; i < 
sb
->
s_blocksize
 && i < 
off£t
; ) {

212 
de
 = (
ext4_dœ_’Œy_2
 *)

213 (
bh
->
b_d©a
 + 
i
);

220 ià(
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

221 
sb
->
s_blocksize
è< 
	`EXT4_DIR_REC_LEN
(1))

223 
i
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

224 
sb
->
s_blocksize
);

226 
off£t
 = 
i
;

227 
ùx
->
pos
 = (ùx->po & ~(
sb
->
s_blocksize
 - 1))

228 | 
off£t
;

229 
fe
->
f_v”siÚ
 = 
šode
->
i_v”siÚ
;

232 
ùx
->
pos
 < 
šode
->
i_size


233 && 
off£t
 < 
sb
->
s_blocksize
) {

234 
de
 = (
ext4_dœ_’Œy_2
 *è(
bh
->
b_d©a
 + 
off£t
);

235 ià(
	`ext4_check_dœ_’Œy
(
šode
, 
fe
, 
de
, 
bh
,

236 
bh
->
b_d©a
, bh->
b_size
,

237 
off£t
)) {

241 
ùx
->
pos
 = (ctx->pos |

242 (
sb
->
s_blocksize
 - 1)) + 1;

245 
off£t
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

246 
sb
->
s_blocksize
);

247 ià(
	`Ë32_to_ıu
(
de
->
šode
)) {

248 ià(!
	`ext4_’üy±ed_šode
(
šode
)) {

249 ià(!
	`dœ_em™
(
ùx
, 
de
->
Çme
,

250 
de
->
Çme_Ën
,

251 
	`Ë32_to_ıu
(
de
->
šode
),

252 
	`g‘_dty³
(
sb
, 
de
->
fe_ty³
)))

253 
dÚe
;

255 
§ve_Ën
 = 
f¡r
.
Ën
;

256 
fsüy±_¡r
 
de_Çme
 =

257 
	`FSTR_INIT
(
de
->
Çme
,

258 
de
->
Çme_Ën
);

261 
”r
 = 
	`fsüy±_âame_disk_to_u¤
(
šode
,

262 0, 0, &
de_Çme
, &
f¡r
);

263 
de_Çme
 = 
f¡r
;

264 
f¡r
.
Ën
 = 
§ve_Ën
;

265 ià(
”r
)

266 
”rout
;

267 ià(!
	`dœ_em™
(
ùx
,

268 
de_Çme
.
Çme
, de_Çme.
Ën
,

269 
	`Ë32_to_ıu
(
de
->
šode
),

270 
	`g‘_dty³
(
sb
, 
de
->
fe_ty³
)))

271 
dÚe
;

274 
ùx
->
pos
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

275 
sb
->
s_blocksize
);

277 ià((
ùx
->
pos
 < 
šode
->
i_size
è&& !
	`dœ_»Ïx_sh¬ed
(inode))

278 
dÚe
;

279 
	`b»l£
(
bh
);

280 
bh
 = 
NULL
;

281 
off£t
 = 0;

283 
dÚe
:

284 
”r
 = 0;

285 
”rout
:

286 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


287 
	`fsüy±_âame_ä“_bufãr
(&
f¡r
);

289 
	`b»l£
(
bh
);

290  
”r
;

291 
	}
}

293 
šlše
 
	$is_32b™_­i
()

295 #ifdeà
CONFIG_COMPAT


296  
	`š_com·t_sysÿÎ
();

298  (
BITS_PER_LONG
 == 32);

300 
	}
}

311 
šlše
 
loff_t
 
	$hash2pos
(
fe
 *
fp
, 
__u32
 
majÜ
, __u32 
mšÜ
)

313 ià((
fp
->
f_mode
 & 
FMODE_32BITHASH
) ||

314 (!(
fp
->
f_mode
 & 
FMODE_64BITHASH
è&& 
	`is_32b™_­i
()))

315  
majÜ
 >> 1;

317  ((
__u64
)(
majÜ
 >> 1è<< 32è| (__u64)
mšÜ
;

318 
	}
}

320 
šlše
 
__u32
 
	$pos2maj_hash
(
fe
 *
fp
, 
loff_t
 
pos
)

322 ià((
fp
->
f_mode
 & 
FMODE_32BITHASH
) ||

323 (!(
fp
->
f_mode
 & 
FMODE_64BITHASH
è&& 
	`is_32b™_­i
()))

324  (
pos
 << 1) & 0xffffffff;

326  ((
pos
 >> 32) << 1) & 0xffffffff;

327 
	}
}

329 
šlše
 
__u32
 
	$pos2mš_hash
(
fe
 *
fp
, 
loff_t
 
pos
)

331 ià((
fp
->
f_mode
 & 
FMODE_32BITHASH
) ||

332 (!(
fp
->
f_mode
 & 
FMODE_64BITHASH
è&& 
	`is_32b™_­i
()))

335  
pos
 & 0xffffffff;

336 
	}
}

341 
šlše
 
loff_t
 
	$ext4_g‘_hŒ“_eof
(
fe
 *
fp
)

343 ià((
fp
->
f_mode
 & 
FMODE_32BITHASH
) ||

344 (!(
fp
->
f_mode
 & 
FMODE_64BITHASH
è&& 
	`is_32b™_­i
()))

345  
EXT4_HTREE_EOF_32BIT
;

347  
EXT4_HTREE_EOF_64BIT
;

348 
	}
}

362 
loff_t
 
	$ext4_dœ_Î£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

364 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

365 
dx_dœ
 = 
	`is_dx_dœ
(
šode
);

366 
loff_t
 
hŒ“_max
 = 
	`ext4_g‘_hŒ“_eof
(
fe
);

368 ià(
	`lik–y
(
dx_dœ
))

369  
	`g’”ic_fe_Î£ek_size
(
fe
, 
off£t
, 
wh’û
,

370 
hŒ“_max
, htree_max);

372  
	`ext4_Î£ek
(
fe
, 
off£t
, 
wh’û
);

373 
	}
}

379 
	sâame
 {

380 
__u32
 
	mhash
;

381 
__u32
 
	mmšÜ_hash
;

382 
rb_node
 
	mrb_hash
;

383 
âame
 *
	mÃxt
;

384 
__u32
 
	mšode
;

385 
__u8
 
	mÇme_Ën
;

386 
__u8
 
	mfe_ty³
;

387 
	mÇme
[0];

394 
	$ä“_rb_Œ“_âame
(
rb_roÙ
 *
roÙ
)

396 
âame
 *âame, *
Ãxt
;

398 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
âame
, 
Ãxt
, 
roÙ
, 
rb_hash
)

399 
âame
) {

400 
âame
 *
Şd
 = fname;

401 
âame
 = fÇme->
Ãxt
;

402 
	`kä“
(
Şd
);

405 *
roÙ
 = 
RB_ROOT
;

406 
	}
}

409 
dœ_´iv©e_šfo
 *
	$ext4_hŒ“_ü—‹_dœ_šfo
(
fe
 *
fp
,

410 
loff_t
 
pos
)

412 
dœ_´iv©e_šfo
 *
p
;

414 
p
 = 
	`kz®loc
((
dœ_´iv©e_šfo
), 
GFP_KERNEL
);

415 ià(!
p
)

416  
NULL
;

417 
p
->
cu¼_hash
 = 
	`pos2maj_hash
(
fp
, 
pos
);

418 
p
->
cu¼_mšÜ_hash
 = 
	`pos2mš_hash
(
fp
, 
pos
);

419  
p
;

420 
	}
}

422 
	$ext4_hŒ“_ä“_dœ_šfo
(
dœ_´iv©e_šfo
 *
p
)

424 
	`ä“_rb_Œ“_âame
(&
p
->
roÙ
);

425 
	`kä“
(
p
);

426 
	}
}

435 
	$ext4_hŒ“_¡Üe_dœ’t
(
fe
 *
dœ_fe
, 
__u32
 
hash
,

436 
__u32
 
mšÜ_hash
,

437 
ext4_dœ_’Œy_2
 *
dœ’t
,

438 
fsüy±_¡r
 *
’t_Çme
)

440 
rb_node
 **
p
, *
·»Á
 = 
NULL
;

441 
âame
 *âame, *
Ãw_â
;

442 
dœ_´iv©e_šfo
 *
šfo
;

443 
Ën
;

445 
šfo
 = 
dœ_fe
->
´iv©e_d©a
;

446 
p
 = &
šfo
->
roÙ
.
rb_node
;

449 
Ën
 = (
âame
è+ 
’t_Çme
->len + 1;

450 
Ãw_â
 = 
	`kz®loc
(
Ën
, 
GFP_KERNEL
);

451 ià(!
Ãw_â
)

452  -
ENOMEM
;

453 
Ãw_â
->
hash
 = hash;

454 
Ãw_â
->
mšÜ_hash
 = minor_hash;

455 
Ãw_â
->
šode
 = 
	`Ë32_to_ıu
(
dœ’t
->inode);

456 
Ãw_â
->
Çme_Ën
 = 
’t_Çme
->
Ën
;

457 
Ãw_â
->
fe_ty³
 = 
dœ’t
->file_type;

458 
	`memıy
(
Ãw_â
->
Çme
, 
’t_Çme
->Çme,ƒÁ_Çme->
Ën
);

459 
Ãw_â
->
Çme
[
’t_Çme
->
Ën
] = 0;

461 *
p
) {

462 
·»Á
 = *
p
;

463 
âame
 = 
	`rb_’Œy
(
·»Á
, âame, 
rb_hash
);

469 ià((
Ãw_â
->
hash
 =ğ
âame
->hash) &&

470 (
Ãw_â
->
mšÜ_hash
 =ğ
âame
->minor_hash)) {

471 
Ãw_â
->
Ãxt
 = 
âame
->next;

472 
âame
->
Ãxt
 = 
Ãw_â
;

476 ià(
Ãw_â
->
hash
 < 
âame
->hash)

477 
p
 = &(*p)->
rb_Ëá
;

478 ià(
Ãw_â
->
hash
 > 
âame
->hash)

479 
p
 = &(*p)->
rb_right
;

480 ià(
Ãw_â
->
mšÜ_hash
 < 
âame
->minor_hash)

481 
p
 = &(*p)->
rb_Ëá
;

483 
p
 = &(*p)->
rb_right
;

486 
	`rb_lšk_node
(&
Ãw_â
->
rb_hash
, 
·»Á
, 
p
);

487 
	`rb_š£¹_cŞÜ
(&
Ãw_â
->
rb_hash
, &
šfo
->
roÙ
);

489 
	}
}

498 
	$ÿÎ_fldœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
,

499 
âame
 *fname)

501 
dœ_´iv©e_šfo
 *
šfo
 = 
fe
->
´iv©e_d©a
;

502 
šode
 *šodğ
	`fe_šode
(
fe
);

503 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

505 ià(!
âame
) {

506 
	`ext4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: comm %s: "

507 "ÿÎed w™h‚uÎ fÇme?!?", 
__func__
, 
__LINE__
,

508 
šode
->
i_šo
, 
cu¼’t
->
comm
);

511 
ùx
->
pos
 = 
	`hash2pos
(
fe
, 
âame
->
hash
, fÇme->
mšÜ_hash
);

512 
âame
) {

513 ià(!
	`dœ_em™
(
ùx
, 
âame
->
Çme
,

514 
âame
->
Çme_Ën
,

515 
âame
->
šode
,

516 
	`g‘_dty³
(
sb
, 
âame
->
fe_ty³
))) {

517 
šfo
->
exŒa_âame
 = 
âame
;

520 
âame
 = fÇme->
Ãxt
;

523 
	}
}

525 
	$ext4_dx_»addœ
(
fe
 *fe, 
dœ_cÚ‹xt
 *
ùx
)

527 
dœ_´iv©e_šfo
 *
šfo
 = 
fe
->
´iv©e_d©a
;

528 
šode
 *šodğ
	`fe_šode
(
fe
);

529 
âame
 *fname;

530 
»t
;

532 ià(!
šfo
) {

533 
šfo
 = 
	`ext4_hŒ“_ü—‹_dœ_šfo
(
fe
, 
ùx
->
pos
);

534 ià(!
šfo
)

535  -
ENOMEM
;

536 
fe
->
´iv©e_d©a
 = 
šfo
;

539 ià(
ùx
->
pos
 =ğ
	`ext4_g‘_hŒ“_eof
(
fe
))

543 ià(
šfo
->
Ï¡_pos
 !ğ
ùx
->
pos
) {

544 
	`ä“_rb_Œ“_âame
(&
šfo
->
roÙ
);

545 
šfo
->
cu¼_node
 = 
NULL
;

546 
šfo
->
exŒa_âame
 = 
NULL
;

547 
šfo
->
cu¼_hash
 = 
	`pos2maj_hash
(
fe
, 
ùx
->
pos
);

548 
šfo
->
cu¼_mšÜ_hash
 = 
	`pos2mš_hash
(
fe
, 
ùx
->
pos
);

555 ià(
šfo
->
exŒa_âame
) {

556 ià(
	`ÿÎ_fldœ
(
fe
, 
ùx
, 
šfo
->
exŒa_âame
))

557 
fšished
;

558 
šfo
->
exŒa_âame
 = 
NULL
;

559 
Ãxt_node
;

560 } ià(!
šfo
->
cu¼_node
)

561 
šfo
->
cu¼_node
 = 
	`rb_fœ¡
(&šfo->
roÙ
);

569 ià((!
šfo
->
cu¼_node
) ||

570 (
fe
->
f_v”siÚ
 !ğ
šode
->
i_v”siÚ
)) {

571 
šfo
->
cu¼_node
 = 
NULL
;

572 
	`ä“_rb_Œ“_âame
(&
šfo
->
roÙ
);

573 
fe
->
f_v”siÚ
 = 
šode
->
i_v”siÚ
;

574 
»t
 = 
	`ext4_hŒ“_fl_Œ“
(
fe
, 
šfo
->
cu¼_hash
,

575 
šfo
->
cu¼_mšÜ_hash
,

576 &
šfo
->
Ãxt_hash
);

577 ià(
»t
 < 0)

578  
»t
;

579 ià(
»t
 == 0) {

580 
ùx
->
pos
 = 
	`ext4_g‘_hŒ“_eof
(
fe
);

583 
šfo
->
cu¼_node
 = 
	`rb_fœ¡
(&šfo->
roÙ
);

586 
âame
 = 
	`rb_’Œy
(
šfo
->
cu¼_node
, âame, 
rb_hash
);

587 
šfo
->
cu¼_hash
 = 
âame
->
hash
;

588 
šfo
->
cu¼_mšÜ_hash
 = 
âame
->
mšÜ_hash
;

589 ià(
	`ÿÎ_fldœ
(
fe
, 
ùx
, 
âame
))

591 
Ãxt_node
:

592 
šfo
->
cu¼_node
 = 
	`rb_Ãxt
(info->curr_node);

593 ià(
šfo
->
cu¼_node
) {

594 
âame
 = 
	`rb_’Œy
(
šfo
->
cu¼_node
, fname,

595 
rb_hash
);

596 
šfo
->
cu¼_hash
 = 
âame
->
hash
;

597 
šfo
->
cu¼_mšÜ_hash
 = 
âame
->
mšÜ_hash
;

599 ià(
šfo
->
Ãxt_hash
 == ~0) {

600 
ùx
->
pos
 = 
	`ext4_g‘_hŒ“_eof
(
fe
);

603 
šfo
->
cu¼_hash
 = info->
Ãxt_hash
;

604 
šfo
->
cu¼_mšÜ_hash
 = 0;

607 
fšished
:

608 
šfo
->
Ï¡_pos
 = 
ùx
->
pos
;

610 
	}
}

612 
	$ext4_dœ_İ’
(
šode
 * inode, 
fe
 * 
fp
)

614 ià(
	`ext4_’üy±ed_šode
(
šode
))

615  
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
è? -
EACCES
 : 0;

617 
	}
}

619 
	$ext4_»Ëa£_dœ
(
šode
 *šode, 
fe
 *
fp
)

621 ià(
fp
->
´iv©e_d©a
)

622 
	`ext4_hŒ“_ä“_dœ_šfo
(
fp
->
´iv©e_d©a
);

625 
	}
}

627 
	$ext4_check_®l_de
(
šode
 *
dœ
, 
bufãr_h—d
 *
bh
, *
buf
,

628 
buf_size
)

630 
ext4_dœ_’Œy_2
 *
de
;

631 
¾’
;

632 
off£t
 = 0;

633 *
tİ
;

635 
de
 = (
ext4_dœ_’Œy_2
 *)
buf
;

636 
tİ
 = 
buf
 + 
buf_size
;

637 (*è
de
 < 
tİ
) {

638 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

639 
buf
, 
buf_size
, 
off£t
))

640  -
EFSCORRUPTED
;

641 
¾’
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
buf_size
);

642 
de
 = (
ext4_dœ_’Œy_2
 *)((*)d+ 
¾’
);

643 
off£t
 +ğ
¾’
;

645 ià((*è
de
 > 
tİ
)

646  -
EFSCORRUPTED
;

649 
	}
}

651 cÚ¡ 
fe_İ”©iÚs
 
	gext4_dœ_İ”©iÚs
 = {

652 .
Î£ek
 = 
ext4_dœ_Î£ek
,

653 .
	g»ad
 = 
g’”ic_»ad_dœ
,

654 .
	g™”©e_sh¬ed
 = 
ext4_»addœ
,

655 .
	guÆocked_ioùl
 = 
ext4_ioùl
,

656 #ifdeà
CONFIG_COMPAT


657 .
	gcom·t_ioùl
 = 
ext4_com·t_ioùl
,

659 .
	gfsync
 = 
ext4_sync_fe
,

660 .
	gfsync_İt
 = 
ext4_sync_fe_İt
,

661 .
	gİ’
 = 
ext4_dœ_İ’
,

662 .
	g»Ëa£
 = 
ext4_»Ëa£_dœ
,

	@ext4.h

16 #iâdeà
_EXT4_H


17 
	#_EXT4_H


	)

19 
	~<lšux/ty³s.h
>

20 
	~<lšux/blkdev.h
>

21 
	~<lšux/magic.h
>

22 
	~<lšux/jbd2.h
>

23 
	~<lšux/quÙa.h
>

24 
	~<lšux/rw£m.h
>

25 
	~<lšux/rbŒ“.h
>

26 
	~<lšux/£qlock.h
>

27 
	~<lšux/mu‹x.h
>

28 
	~<lšux/tim”.h
>

29 
	~<lšux/v”siÚ.h
>

30 
	~<lšux/wa™.h
>

31 
	~<lšux/sched/sigÇl.h
>

32 
	~<lšux/blockgroup_lock.h
>

33 
	~<lšux/³rıu_couÁ”.h
>

34 
	~<lšux/¿‹lim™.h
>

35 
	~<üy±o/hash.h
>

36 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


37 
	~<lšux/fsüy±_suµ.h
>

39 
	~<lšux/fsüy±_nÙsuµ.h
>

41 
	~<lšux/çÎoc.h
>

42 
	~<lšux/³rıu-rw£m.h
>

43 #ifdeà
__KERNEL__


44 
	~<lšux/com·t.h
>

55 
	#AGGRESSIVE_CHECK__


	)

61 
	#DOUBLE_CHECK__


	)

66 #undeà
EXT4FS_DEBUG


71 #ifdeà
EXT4FS_DEBUG


72 
	#ext4_debug
(
f
, 
a
...) \

74 
	`´štk
(
KERN_DEBUG
 "EXT4-fs DEBUG (%s, %d): %s:", \

75 
__FILE__
, 
__LINE__
, 
__func__
); \

76 
	`´štk
(
KERN_DEBUG
 
f
, ## 
a
); \

77 } 0)

	)

79 
	#ext4_debug
(
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

85 
	#EXT_DEBUG__


	)

86 #ifdeà
EXT_DEBUG


87 
	#ext_debug
(
fmt
, ...è
	`´štk
(fmt, ##
__VA_ARGS__
)

	)

89 
	#ext_debug
(
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

93 
	text4_g½blk_t
;

96 
	text4_fsblk_t
;

99 
__u32
 
	text4_lblk_t
;

102 
	text4_group_t
;

104 
	eSHIFT_DIRECTION
 {

105 
	mSHIFT_LEFT
 = 0,

106 
	mSHIFT_RIGHT
,

117 
	#EXT4_MB_HINT_MERGE
 0x0001

	)

119 
	#EXT4_MB_HINT_RESERVED
 0x0002

	)

121 
	#EXT4_MB_HINT_METADATA
 0x0004

	)

123 
	#EXT4_MB_HINT_FIRST
 0x0008

	)

125 
	#EXT4_MB_HINT_BEST
 0x0010

	)

127 
	#EXT4_MB_HINT_DATA
 0x0020

	)

129 
	#EXT4_MB_HINT_NOPREALLOC
 0x0040

	)

131 
	#EXT4_MB_HINT_GROUP_ALLOC
 0x0080

	)

133 
	#EXT4_MB_HINT_GOAL_ONLY
 0x0100

	)

135 
	#EXT4_MB_HINT_TRY_GOAL
 0x0200

	)

137 
	#EXT4_MB_DELALLOC_RESERVED
 0x0400

	)

139 
	#EXT4_MB_STREAM_ALLOC
 0x0800

	)

141 
	#EXT4_MB_USE_ROOT_BLOCKS
 0x1000

	)

143 
	#EXT4_MB_USE_RESERVED
 0x2000

	)

145 
	sext4_®loÿtiÚ_»que¡
 {

147 
šode
 *
	mšode
;

149 
	mËn
;

151 
ext4_lblk_t
 
	mlogiÿl
;

153 
ext4_lblk_t
 
	mÎeá
;

155 
ext4_lblk_t
 
	mÌight
;

157 
ext4_fsblk_t
 
	mgßl
;

159 
ext4_fsblk_t
 
	m¶eá
;

161 
ext4_fsblk_t
 
	m´ight
;

163 
	mæags
;

173 
	#EXT4_MAP_NEW
 (1 << 
BH_New
)

	)

174 
	#EXT4_MAP_MAPPED
 (1 << 
BH_M­³d
)

	)

175 
	#EXT4_MAP_UNWRITTEN
 (1 << 
BH_Unwr™‹n
)

	)

176 
	#EXT4_MAP_BOUNDARY
 (1 << 
BH_Bound¬y
)

	)

177 
	#EXT4_MAP_FLAGS
 (
EXT4_MAP_NEW
 | 
EXT4_MAP_MAPPED
 |\

178 
EXT4_MAP_UNWRITTEN
 | 
EXT4_MAP_BOUNDARY
)

	)

180 
	sext4_m­_blocks
 {

181 
ext4_fsblk_t
 
	mm_pblk
;

182 
ext4_lblk_t
 
	mm_lblk
;

183 
	mm_Ën
;

184 
	mm_æags
;

190 
	#EXT4_IO_END_UNWRITTEN
 0x0001

	)

196 
	sext4_io_’d
 {

197 
li¡_h—d
 
	mli¡
;

198 
hªdË_t
 *
	mhªdË
;

200 
šode
 *
	mšode
;

201 
bio
 *
	mbio
;

203 
	mæag
;

204 
©omic_t
 
	mcouÁ
;

205 
loff_t
 
	moff£t
;

206 
ssize_t
 
	msize
;

207 } 
	text4_io_’d_t
;

209 
	sext4_io_subm™
 {

210 
wr™eback_cÚŒŞ
 *
	mio_wbc
;

211 
bio
 *
	mio_bio
;

212 
ext4_io_’d_t
 *
	mio_’d
;

213 
£ùÜ_t
 
	mio_Ãxt_block
;

219 
	#EXT4_BAD_INO
 1

	)

220 
	#EXT4_ROOT_INO
 2

	)

221 
	#EXT4_USR_QUOTA_INO
 3

	)

222 
	#EXT4_GRP_QUOTA_INO
 4

	)

223 
	#EXT4_BOOT_LOADER_INO
 5

	)

224 
	#EXT4_UNDEL_DIR_INO
 6

	)

225 
	#EXT4_RESIZE_INO
 7

	)

226 
	#EXT4_JOURNAL_INO
 8

	)

229 
	#EXT4_GOOD_OLD_FIRST_INO
 11

	)

234 
	#EXT4_LINK_MAX
 65000

	)

239 
	#EXT4_MIN_BLOCK_SIZE
 1024

	)

240 
	#EXT4_MAX_BLOCK_SIZE
 65536

	)

241 
	#EXT4_MIN_BLOCK_LOG_SIZE
 10

	)

242 
	#EXT4_MAX_BLOCK_LOG_SIZE
 16

	)

243 
	#EXT4_MAX_CLUSTER_LOG_SIZE
 30

	)

244 #ifdeà
__KERNEL__


245 
	#EXT4_BLOCK_SIZE
(
s
è((s)->
s_blocksize
)

	)

247 
	#EXT4_BLOCK_SIZE
(
s
è(
EXT4_MIN_BLOCK_SIZE
 << (s)->
s_log_block_size
)

	)

249 
	#EXT4_ADDR_PER_BLOCK
(
s
è(
	`EXT4_BLOCK_SIZE
(sè/ (
__u32
))

	)

250 
	#EXT4_CLUSTER_SIZE
(
s
è(
	`EXT4_BLOCK_SIZE
(s) << \

251 
	`EXT4_SB
(
s
)->
s_şu¡”_b™s
)

	)

252 #ifdeà
__KERNEL__


253 
	#EXT4_BLOCK_SIZE_BITS
(
s
è((s)->
s_blocksize_b™s
)

	)

254 
	#EXT4_CLUSTER_BITS
(
s
è(
	`EXT4_SB
(s)->
s_şu¡”_b™s
)

	)

256 
	#EXT4_BLOCK_SIZE_BITS
(
s
è((s)->
s_log_block_size
 + 10)

	)

258 #ifdeà
__KERNEL__


259 
	#EXT4_ADDR_PER_BLOCK_BITS
(
s
è(
	`EXT4_SB
(s)->
s_addr_³r_block_b™s
)

	)

260 
	#EXT4_INODE_SIZE
(
s
è(
	`EXT4_SB
(s)->
s_šode_size
)

	)

261 
	#EXT4_FIRST_INO
(
s
è(
	`EXT4_SB
(s)->
s_fœ¡_šo
)

	)

263 
	#EXT4_INODE_SIZE
(
s
è(((s)->
s_»v_Ëv–
 =ğ
EXT4_GOOD_OLD_REV
) ? \

264 
EXT4_GOOD_OLD_INODE_SIZE
 : \

265 (
s
)->
s_šode_size
)

	)

266 
	#EXT4_FIRST_INO
(
s
è(((s)->
s_»v_Ëv–
 =ğ
EXT4_GOOD_OLD_REV
) ? \

267 
EXT4_GOOD_OLD_FIRST_INO
 : \

268 (
s
)->
s_fœ¡_šo
)

	)

270 
	#EXT4_BLOCK_ALIGN
(
size
, 
blkb™s
è
	`ALIGN
((size), (1 << (blkb™s)))

	)

271 
	#EXT4_MAX_BLOCKS
(
size
, 
off£t
, 
blkb™s
) \

272 ((
	`EXT4_BLOCK_ALIGN
(
size
 + 
off£t
, 
blkb™s
) >> blkbits) - (offset >> \

273 
blkb™s
))

	)

276 
	#EXT4_B2C
(
sbi
, 
blk
è((blkè>> (sbi)->
s_şu¡”_b™s
)

	)

278 
	#EXT4_C2B
(
sbi
, 
şu¡”
è((şu¡”è<< (sbi)->
s_şu¡”_b™s
)

	)

280 
	#EXT4_NUM_B2C
(
sbi
, 
blks
è(((blksè+ (sbi)->
s_şu¡”_¿tio
 - 1) >> \

281 (
sbi
)->
s_şu¡”_b™s
)

	)

283 
	#EXT4_PBLK_CMASK
(
s
, 
pblk
) ((pblk) & \

284 ~((
ext4_fsblk_t
è(
s
)->
s_şu¡”_¿tio
 - 1))

	)

285 
	#EXT4_LBLK_CMASK
(
s
, 
lblk
) ((lblk) & \

286 ~((
ext4_lblk_t
è(
s
)->
s_şu¡”_¿tio
 - 1))

	)

288 
	#EXT4_PBLK_COFF
(
s
, 
pblk
) ((pblk) & \

289 ((
ext4_fsblk_t
è(
s
)->
s_şu¡”_¿tio
 - 1))

	)

290 
	#EXT4_LBLK_COFF
(
s
, 
lblk
) ((lblk) & \

291 ((
ext4_lblk_t
è(
s
)->
s_şu¡”_¿tio
 - 1))

	)

296 
	sext4_group_desc


298 
__Ë32
 
	mbg_block_b™m­_lo
;

299 
__Ë32
 
	mbg_šode_b™m­_lo
;

300 
__Ë32
 
	mbg_šode_bË_lo
;

301 
__Ë16
 
	mbg_ä“_blocks_couÁ_lo
;

302 
__Ë16
 
	mbg_ä“_šodes_couÁ_lo
;

303 
__Ë16
 
	mbg_u£d_dœs_couÁ_lo
;

304 
__Ë16
 
	mbg_æags
;

305 
__Ë32
 
	mbg_exşude_b™m­_lo
;

306 
__Ë16
 
	mbg_block_b™m­_csum_lo
;

307 
__Ë16
 
	mbg_šode_b™m­_csum_lo
;

308 
__Ë16
 
	mbg_™abË_unu£d_lo
;

309 
__Ë16
 
	mbg_checksum
;

310 
__Ë32
 
	mbg_block_b™m­_hi
;

311 
__Ë32
 
	mbg_šode_b™m­_hi
;

312 
__Ë32
 
	mbg_šode_bË_hi
;

313 
__Ë16
 
	mbg_ä“_blocks_couÁ_hi
;

314 
__Ë16
 
	mbg_ä“_šodes_couÁ_hi
;

315 
__Ë16
 
	mbg_u£d_dœs_couÁ_hi
;

316 
__Ë16
 
	mbg_™abË_unu£d_hi
;

317 
__Ë32
 
	mbg_exşude_b™m­_hi
;

318 
__Ë16
 
	mbg_block_b™m­_csum_hi
;

319 
__Ë16
 
	mbg_šode_b™m­_csum_hi
;

320 
__u32
 
	mbg_»£rved
;

323 
	#EXT4_BG_INODE_BITMAP_CSUM_HI_END
 \

324 (
	`off£tof
(
ext4_group_desc
, 
bg_šode_b™m­_csum_hi
) + \

325 (
__Ë16
))

	)

326 
	#EXT4_BG_BLOCK_BITMAP_CSUM_HI_END
 \

327 (
	`off£tof
(
ext4_group_desc
, 
bg_block_b™m­_csum_hi
) + \

328 (
__Ë16
))

	)

334 
	sæex_groups
 {

335 
©omic64_t
 
	mä“_şu¡”s
;

336 
©omic_t
 
	mä“_šodes
;

337 
©omic_t
 
	mu£d_dœs
;

340 
	#EXT4_BG_INODE_UNINIT
 0x0001

	)

341 
	#EXT4_BG_BLOCK_UNINIT
 0x0002

	)

342 
	#EXT4_BG_INODE_ZEROED
 0x0004

	)

347 
	#EXT4_MIN_DESC_SIZE
 32

	)

348 
	#EXT4_MIN_DESC_SIZE_64BIT
 64

	)

349 
	#EXT4_MAX_DESC_SIZE
 
EXT4_MIN_BLOCK_SIZE


	)

350 
	#EXT4_DESC_SIZE
(
s
è(
	`EXT4_SB
(s)->
s_desc_size
)

	)

351 #ifdeà
__KERNEL__


352 
	#EXT4_BLOCKS_PER_GROUP
(
s
è(
	`EXT4_SB
(s)->
s_blocks_³r_group
)

	)

353 
	#EXT4_CLUSTERS_PER_GROUP
(
s
è(
	`EXT4_SB
(s)->
s_şu¡”s_³r_group
)

	)

354 
	#EXT4_DESC_PER_BLOCK
(
s
è(
	`EXT4_SB
(s)->
s_desc_³r_block
)

	)

355 
	#EXT4_INODES_PER_GROUP
(
s
è(
	`EXT4_SB
(s)->
s_šodes_³r_group
)

	)

356 
	#EXT4_DESC_PER_BLOCK_BITS
(
s
è(
	`EXT4_SB
(s)->
s_desc_³r_block_b™s
)

	)

358 
	#EXT4_BLOCKS_PER_GROUP
(
s
è((s)->
s_blocks_³r_group
)

	)

359 
	#EXT4_DESC_PER_BLOCK
(
s
è(
	`EXT4_BLOCK_SIZE
(sè/ 
	`EXT4_DESC_SIZE
(s))

	)

360 
	#EXT4_INODES_PER_GROUP
(
s
è((s)->
s_šodes_³r_group
)

	)

366 
	#EXT4_NDIR_BLOCKS
 12

	)

367 
	#EXT4_IND_BLOCK
 
EXT4_NDIR_BLOCKS


	)

368 
	#EXT4_DIND_BLOCK
 (
EXT4_IND_BLOCK
 + 1)

	)

369 
	#EXT4_TIND_BLOCK
 (
EXT4_DIND_BLOCK
 + 1)

	)

370 
	#EXT4_N_BLOCKS
 (
EXT4_TIND_BLOCK
 + 1)

	)

375 
	#EXT4_SECRM_FL
 0x00000001

	)

376 
	#EXT4_UNRM_FL
 0x00000002

	)

377 
	#EXT4_COMPR_FL
 0x00000004

	)

378 
	#EXT4_SYNC_FL
 0x00000008

	)

379 
	#EXT4_IMMUTABLE_FL
 0x00000010

	)

380 
	#EXT4_APPEND_FL
 0x00000020

	)

381 
	#EXT4_NODUMP_FL
 0x00000040

	)

382 
	#EXT4_NOATIME_FL
 0x00000080

	)

384 
	#EXT4_DIRTY_FL
 0x00000100

	)

385 
	#EXT4_COMPRBLK_FL
 0x00000200

	)

386 
	#EXT4_NOCOMPR_FL
 0x00000400

	)

388 
	#EXT4_ENCRYPT_FL
 0x00000800

	)

390 
	#EXT4_INDEX_FL
 0x00001000

	)

391 
	#EXT4_IMAGIC_FL
 0x00002000

	)

392 
	#EXT4_JOURNAL_DATA_FL
 0x00004000

	)

393 
	#EXT4_NOTAIL_FL
 0x00008000

	)

394 
	#EXT4_DIRSYNC_FL
 0x00010000

	)

395 
	#EXT4_TOPDIR_FL
 0x00020000

	)

396 
	#EXT4_HUGE_FILE_FL
 0x00040000

	)

397 
	#EXT4_EXTENTS_FL
 0x00080000

	)

398 
	#EXT4_EA_INODE_FL
 0x00200000

	)

399 
	#EXT4_EOFBLOCKS_FL
 0x00400000

	)

400 
	#EXT4_INLINE_DATA_FL
 0x10000000

	)

401 
	#EXT4_PROJINHERIT_FL
 0x20000000

	)

402 
	#EXT4_RESERVED_FL
 0x80000000

	)

404 
	#EXT4_FL_USER_VISIBLE
 0x304BDFFF

	)

405 
	#EXT4_FL_USER_MODIFIABLE
 0x204BC0FF

	)

408 
	#EXT4_FL_XFLAG_VISIBLE
 (
EXT4_SYNC_FL
 | \

409 
EXT4_IMMUTABLE_FL
 | \

410 
EXT4_APPEND_FL
 | \

411 
EXT4_NODUMP_FL
 | \

412 
EXT4_NOATIME_FL
 | \

413 
EXT4_PROJINHERIT_FL
)

	)

416 
	#EXT4_FL_INHERITED
 (
EXT4_SECRM_FL
 | 
EXT4_UNRM_FL
 | 
EXT4_COMPR_FL
 |\

417 
EXT4_SYNC_FL
 | 
EXT4_NODUMP_FL
 | 
EXT4_NOATIME_FL
 |\

418 
EXT4_NOCOMPR_FL
 | 
EXT4_JOURNAL_DATA_FL
 |\

419 
EXT4_NOTAIL_FL
 | 
EXT4_DIRSYNC_FL
 |\

420 
EXT4_PROJINHERIT_FL
)

	)

423 
	#EXT4_REG_FLMASK
 (~(
EXT4_DIRSYNC_FL
 | 
EXT4_TOPDIR_FL
))

	)

426 
	#EXT4_OTHER_FLMASK
 (
EXT4_NODUMP_FL
 | 
EXT4_NOATIME_FL
)

	)

429 
šlše
 
__u32
 
	$ext4_mask_æags
(
umode_t
 
mode
, 
__u32
 
æags
)

431 ià(
	`S_ISDIR
(
mode
))

432  
æags
;

433 ià(
	`S_ISREG
(
mode
))

434  
æags
 & 
EXT4_REG_FLMASK
;

436  
æags
 & 
EXT4_OTHER_FLMASK
;

437 
	}
}

443 
	mEXT4_INODE_SECRM
 = 0,

444 
	mEXT4_INODE_UNRM
 = 1,

445 
	mEXT4_INODE_COMPR
 = 2,

446 
	mEXT4_INODE_SYNC
 = 3,

447 
	mEXT4_INODE_IMMUTABLE
 = 4,

448 
	mEXT4_INODE_APPEND
 = 5,

449 
	mEXT4_INODE_NODUMP
 = 6,

450 
	mEXT4_INODE_NOATIME
 = 7,

452 
	mEXT4_INODE_DIRTY
 = 8,

453 
	mEXT4_INODE_COMPRBLK
 = 9,

454 
	mEXT4_INODE_NOCOMPR
 = 10,

455 
	mEXT4_INODE_ENCRYPT
 = 11,

457 
	mEXT4_INODE_INDEX
 = 12,

458 
	mEXT4_INODE_IMAGIC
 = 13,

459 
	mEXT4_INODE_JOURNAL_DATA
 = 14,

460 
	mEXT4_INODE_NOTAIL
 = 15,

461 
	mEXT4_INODE_DIRSYNC
 = 16,

462 
	mEXT4_INODE_TOPDIR
 = 17,

463 
	mEXT4_INODE_HUGE_FILE
 = 18,

464 
	mEXT4_INODE_EXTENTS
 = 19,

465 
	mEXT4_INODE_EA_INODE
 = 21,

466 
	mEXT4_INODE_EOFBLOCKS
 = 22,

467 
	mEXT4_INODE_INLINE_DATA
 = 28,

468 
	mEXT4_INODE_PROJINHERIT
 = 29,

469 
	mEXT4_INODE_RESERVED
 = 31,

485 
	#TEST_FLAG_VALUE
(
FLAG
è(
EXT4_
##FLAG##
_FL
 =ğ(1 << 
EXT4_INODE_
##FLAG))

	)

486 
	#CHECK_FLAG_VALUE
(
FLAG
è
	`BUILD_BUG_ON
(!
	`TEST_FLAG_VALUE
(FLAG))

	)

488 
šlše
 
	$ext4_check_æag_v®ues
()

490 
	`CHECK_FLAG_VALUE
(
SECRM
);

491 
	`CHECK_FLAG_VALUE
(
UNRM
);

492 
	`CHECK_FLAG_VALUE
(
COMPR
);

493 
	`CHECK_FLAG_VALUE
(
SYNC
);

494 
	`CHECK_FLAG_VALUE
(
IMMUTABLE
);

495 
	`CHECK_FLAG_VALUE
(
APPEND
);

496 
	`CHECK_FLAG_VALUE
(
NODUMP
);

497 
	`CHECK_FLAG_VALUE
(
NOATIME
);

498 
	`CHECK_FLAG_VALUE
(
DIRTY
);

499 
	`CHECK_FLAG_VALUE
(
COMPRBLK
);

500 
	`CHECK_FLAG_VALUE
(
NOCOMPR
);

501 
	`CHECK_FLAG_VALUE
(
ENCRYPT
);

502 
	`CHECK_FLAG_VALUE
(
INDEX
);

503 
	`CHECK_FLAG_VALUE
(
IMAGIC
);

504 
	`CHECK_FLAG_VALUE
(
JOURNAL_DATA
);

505 
	`CHECK_FLAG_VALUE
(
NOTAIL
);

506 
	`CHECK_FLAG_VALUE
(
DIRSYNC
);

507 
	`CHECK_FLAG_VALUE
(
TOPDIR
);

508 
	`CHECK_FLAG_VALUE
(
HUGE_FILE
);

509 
	`CHECK_FLAG_VALUE
(
EXTENTS
);

510 
	`CHECK_FLAG_VALUE
(
EA_INODE
);

511 
	`CHECK_FLAG_VALUE
(
EOFBLOCKS
);

512 
	`CHECK_FLAG_VALUE
(
INLINE_DATA
);

513 
	`CHECK_FLAG_VALUE
(
PROJINHERIT
);

514 
	`CHECK_FLAG_VALUE
(
RESERVED
);

515 
	}
}

518 
	sext4_Ãw_group_šput
 {

519 
__u32
 
	mgroup
;

520 
__u64
 
	mblock_b™m­
;

521 
__u64
 
	mšode_b™m­
;

522 
__u64
 
	mšode_bË
;

523 
__u32
 
	mblocks_couÁ
;

524 
__u16
 
	m»£rved_blocks
;

525 
__u16
 
	munu£d
;

528 #ià
defšed
(
__KERNEL__
è&& defšed(
CONFIG_COMPAT
)

529 
	scom·t_ext4_Ãw_group_šput
 {

530 
u32
 
	mgroup
;

531 
com·t_u64
 
	mblock_b™m­
;

532 
com·t_u64
 
	mšode_b™m­
;

533 
com·t_u64
 
	mšode_bË
;

534 
u32
 
	mblocks_couÁ
;

535 
u16
 
	m»£rved_blocks
;

536 
u16
 
	munu£d
;

541 
	sext4_Ãw_group_d©a
 {

542 
__u32
 
	mgroup
;

543 
__u64
 
	mblock_b™m­
;

544 
__u64
 
	mšode_b™m­
;

545 
__u64
 
	mšode_bË
;

546 
__u32
 
	mblocks_couÁ
;

547 
__u16
 
	m»£rved_blocks
;

548 
__u16
 
	munu£d
;

549 
__u32
 
	mä“_blocks_couÁ
;

554 
	mBLOCK_BITMAP
 = 0,

555 
	mINODE_BITMAP
,

556 
	mINODE_TABLE
,

557 
	mGROUP_TABLE_COUNT
,

565 
	#EXT4_GET_BLOCKS_CREATE
 0x0001

	)

567 
	#EXT4_GET_BLOCKS_UNWRIT_EXT
 0x0002

	)

568 
	#EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
 (
EXT4_GET_BLOCKS_UNWRIT_EXT
|\

569 
EXT4_GET_BLOCKS_CREATE
)

	)

572 
	#EXT4_GET_BLOCKS_DELALLOC_RESERVE
 0x0004

	)

576 
	#EXT4_GET_BLOCKS_PRE_IO
 0x0008

	)

577 
	#EXT4_GET_BLOCKS_CONVERT
 0x0010

	)

578 
	#EXT4_GET_BLOCKS_IO_CREATE_EXT
 (
EXT4_GET_BLOCKS_PRE_IO
|\

579 
EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

581 
	#EXT4_GET_BLOCKS_IO_CONVERT_EXT
 (
EXT4_GET_BLOCKS_CONVERT
|\

582 
EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

585 
	#EXT4_GET_BLOCKS_METADATA_NOFAIL
 0x0020

	)

587 
	#EXT4_GET_BLOCKS_NO_NORMALIZE
 0x0040

	)

589 
	#EXT4_GET_BLOCKS_KEEP_SIZE
 0x0080

	)

591 
	#EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 0x0100

	)

593 
	#EXT4_GET_BLOCKS_ZERO
 0x0200

	)

594 
	#EXT4_GET_BLOCKS_CREATE_ZERO
 (
EXT4_GET_BLOCKS_CREATE
 |\

595 
EXT4_GET_BLOCKS_ZERO
)

	)

598 
	#EXT4_GET_BLOCKS_IO_SUBMIT
 0x0400

	)

609 
	#EXT4_EX_NOCACHE
 0x40000000

	)

610 
	#EXT4_EX_FORCE_CACHE
 0x20000000

	)

615 
	#EXT4_FREE_BLOCKS_METADATA
 0x0001

	)

616 
	#EXT4_FREE_BLOCKS_FORGET
 0x0002

	)

617 
	#EXT4_FREE_BLOCKS_VALIDATED
 0x0004

	)

618 
	#EXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 0x0008

	)

619 
	#EXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
 0x0010

	)

620 
	#EXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
 0x0020

	)

625 
	#EXT4_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

626 
	#EXT4_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

627 
	#EXT4_IOC_GETVERSION
 
	`_IOR
('f', 3, )

	)

628 
	#EXT4_IOC_SETVERSION
 
	`_IOW
('f', 4, )

	)

629 
	#EXT4_IOC_GETVERSION_OLD
 
FS_IOC_GETVERSION


	)

630 
	#EXT4_IOC_SETVERSION_OLD
 
FS_IOC_SETVERSION


	)

631 
	#EXT4_IOC_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

632 
	#EXT4_IOC_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

633 
	#EXT4_IOC_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

634 
	#EXT4_IOC_GROUP_ADD
 
	`_IOW
('f', 8, 
ext4_Ãw_group_šput
)

	)

635 
	#EXT4_IOC_MIGRATE
 
	`_IO
('f', 9)

	)

638 
	#EXT4_IOC_ALLOC_DA_BLKS
 
	`_IO
('f', 12)

	)

639 
	#EXT4_IOC_MOVE_EXT
 
	`_IOWR
('f', 15, 
move_ex‹Á
)

	)

640 
	#EXT4_IOC_RESIZE_FS
 
	`_IOW
('f', 16, 
__u64
)

	)

641 
	#EXT4_IOC_SWAP_BOOT
 
	`_IO
('f', 17)

	)

642 
	#EXT4_IOC_PRECACHE_EXTENTS
 
	`_IO
('f', 18)

	)

643 
	#EXT4_IOC_SET_ENCRYPTION_POLICY
 
FS_IOC_SET_ENCRYPTION_POLICY


	)

644 
	#EXT4_IOC_GET_ENCRYPTION_PWSALT
 
FS_IOC_GET_ENCRYPTION_PWSALT


	)

645 
	#EXT4_IOC_GET_ENCRYPTION_POLICY
 
FS_IOC_GET_ENCRYPTION_POLICY


	)

647 #iâdeà
FS_IOC_FSGETXATTR


650 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©Œ
)

	)

651 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©Œ
)

	)

656 
	sfsx©Œ
 {

657 
__u32
 
	mfsx_xæags
;

658 
__u32
 
	mfsx_extsize
;

659 
__u32
 
	mfsx_Ãx‹Ás
;

660 
__u32
 
	mfsx_´ojid
;

661 
	mfsx_·d
[12];

667 
	#FS_XFLAG_REALTIME
 0x00000001

	)

668 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

669 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

670 
	#FS_XFLAG_APPEND
 0x00000010

	)

671 
	#FS_XFLAG_SYNC
 0x00000020

	)

672 
	#FS_XFLAG_NOATIME
 0x00000040

	)

673 
	#FS_XFLAG_NODUMP
 0x00000080

	)

674 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

675 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

676 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

677 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

678 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

679 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

680 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

681 
	#FS_XFLAG_HASATTR
 0x80000000

	)

684 
	#EXT4_IOC_FSGETXATTR
 
FS_IOC_FSGETXATTR


	)

685 
	#EXT4_IOC_FSSETXATTR
 
FS_IOC_FSSETXATTR


	)

687 
	#EXT4_IOC_SHUTDOWN
 
	`_IOR
 ('X', 125, 
__u32
)

	)

692 
	#EXT4_GOING_FLAGS_DEFAULT
 0x0

	)

693 
	#EXT4_GOING_FLAGS_LOGFLUSH
 0x1

	)

694 
	#EXT4_GOING_FLAGS_NOLOGFLUSH
 0x2

	)

697 #ià
defšed
(
__KERNEL__
è&& defšed(
CONFIG_COMPAT
)

701 
	#EXT4_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

702 
	#EXT4_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

703 
	#EXT4_IOC32_GETVERSION
 
	`_IOR
('f', 3, )

	)

704 
	#EXT4_IOC32_SETVERSION
 
	`_IOW
('f', 4, )

	)

705 
	#EXT4_IOC32_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

706 
	#EXT4_IOC32_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

707 
	#EXT4_IOC32_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

708 
	#EXT4_IOC32_GROUP_ADD
 
	`_IOW
('f', 8, 
com·t_ext4_Ãw_group_šput
)

	)

709 
	#EXT4_IOC32_GETVERSION_OLD
 
FS_IOC32_GETVERSION


	)

710 
	#EXT4_IOC32_SETVERSION_OLD
 
FS_IOC32_SETVERSION


	)

714 
	#EXT4_MAX_BLOCK_FILE_PHYS
 0xFFFFFFFF

	)

719 
	sext4_šode
 {

720 
__Ë16
 
	mi_mode
;

721 
__Ë16
 
	mi_uid
;

722 
__Ë32
 
	mi_size_lo
;

723 
__Ë32
 
	mi_©ime
;

724 
__Ë32
 
	mi_ùime
;

725 
__Ë32
 
	mi_mtime
;

726 
__Ë32
 
	mi_dtime
;

727 
__Ë16
 
	mi_gid
;

728 
__Ë16
 
	mi_lšks_couÁ
;

729 
__Ë32
 
	mi_blocks_lo
;

730 
__Ë32
 
	mi_æags
;

733 
__Ë32
 
	ml_i_v”siÚ
;

734 } 
	mlšux1
;

736 
__u32
 
	mh_i_Œª¦©Ü
;

737 } 
	mhurd1
;

739 
__u32
 
	mm_i_»£rved1
;

740 } 
	mmasix1
;

741 } 
	mosd1
;

742 
__Ë32
 
	mi_block
[
EXT4_N_BLOCKS
];

743 
__Ë32
 
	mi_g’”©iÚ
;

744 
__Ë32
 
	mi_fe_aş_lo
;

745 
__Ë32
 
	mi_size_high
;

746 
__Ë32
 
	mi_obso_çddr
;

749 
__Ë16
 
	ml_i_blocks_high
;

750 
__Ë16
 
	ml_i_fe_aş_high
;

751 
__Ë16
 
	ml_i_uid_high
;

752 
__Ë16
 
	ml_i_gid_high
;

753 
__Ë16
 
	ml_i_checksum_lo
;

754 
__Ë16
 
	ml_i_»£rved
;

755 } 
	mlšux2
;

757 
__Ë16
 
	mh_i_»£rved1
;

758 
__u16
 
	mh_i_mode_high
;

759 
__u16
 
	mh_i_uid_high
;

760 
__u16
 
	mh_i_gid_high
;

761 
__u32
 
	mh_i_authÜ
;

762 } 
	mhurd2
;

764 
__Ë16
 
	mh_i_»£rved1
;

765 
__Ë16
 
	mm_i_fe_aş_high
;

766 
__u32
 
	mm_i_»£rved2
[2];

767 } 
	mmasix2
;

768 } 
	mosd2
;

769 
__Ë16
 
	mi_exŒa_isize
;

770 
__Ë16
 
	mi_checksum_hi
;

771 
__Ë32
 
	mi_ùime_exŒa
;

772 
__Ë32
 
	mi_mtime_exŒa
;

773 
__Ë32
 
	mi_©ime_exŒa
;

774 
__Ë32
 
	mi_ütime
;

775 
__Ë32
 
	mi_ütime_exŒa
;

776 
__Ë32
 
	mi_v”siÚ_hi
;

777 
__Ë32
 
	mi_´ojid
;

780 
	smove_ex‹Á
 {

781 
__u32
 
	m»£rved
;

782 
__u32
 
	mdÚÜ_fd
;

783 
__u64
 
	mÜig_¡¬t
;

784 
__u64
 
	mdÚÜ_¡¬t
;

785 
__u64
 
	mËn
;

786 
__u64
 
	mmoved_Ën
;

789 
	#EXT4_EPOCH_BITS
 2

	)

790 
	#EXT4_EPOCH_MASK
 ((1 << 
EXT4_EPOCH_BITS
è- 1)

	)

791 
	#EXT4_NSEC_MASK
 (~0UL << 
EXT4_EPOCH_BITS
)

	)

803 
	#EXT4_FITS_IN_INODE
(
ext4_šode
, 
ešode
, 
f›ld
) \

804 ((
	`off£tof
(
	`ty³of
(*
ext4_šode
), 
f›ld
) + \

805 ((
ext4_šode
)->
f›ld
)) \

806 <ğ(
EXT4_GOOD_OLD_INODE_SIZE
 + \

807 (
ešode
)->
i_exŒa_isize
)) \

808 

	)

830 
šlše
 
__Ë32
 
	$ext4_’code_exŒa_time
(
time¥ec
 *
time
)

832 
u32
 
exŒa
 = (
time
->
tv_£c
) > 4 ?

833 ((
time
->
tv_£c
 - (
s32
éime->tv_£cè>> 32è& 
EXT4_EPOCH_MASK
 : 0;

834  
	`ıu_to_Ë32
(
exŒa
 | (
time
->
tv_n£c
 << 
EXT4_EPOCH_BITS
));

835 
	}
}

837 
šlše
 
	$ext4_decode_exŒa_time
(
time¥ec
 *
time
, 
__Ë32
 
exŒa
)

839 ià(
	`uÆik–y
((
time
->
tv_£c
) > 4 &&

840 (
exŒa
 & 
	`ıu_to_Ë32
(
EXT4_EPOCH_MASK
)))) {

841 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4,20,0)

849 
u64
 
exŒa_b™s
 = 
	`Ë32_to_ıu
(
exŒa
è& 
EXT4_EPOCH_MASK
;

850 ià(
exŒa_b™s
 =ğ3 && ((
time
->
tv_£c
) & 0x80000000) != 0)

851 
exŒa_b™s
 = 0;

852 
time
->
tv_£c
 +ğ
exŒa_b™s
 << 32;

854 
time
->
tv_£c
 +ğ(
u64
)(
	`Ë32_to_ıu
(
exŒa
è& 
EXT4_EPOCH_MASK
) << 32;

857 
time
->
tv_n£c
 = (
	`Ë32_to_ıu
(
exŒa
è& 
EXT4_NSEC_MASK
è>> 
EXT4_EPOCH_BITS
;

858 
	}
}

860 
	#EXT4_INODE_SET_XTIME
(
xtime
, 
šode
, 
¿w_šode
) \

862 (
¿w_šode
)->
xtime
 = 
	`ıu_to_Ë32
((
šode
)->xtime.
tv_£c
); \

863 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
	`EXT4_I
(
šode
), 
xtime
 ## 
_exŒa
)) \

864 (
¿w_šode
)->
xtime
 ## 
_exŒa
 = \

865 
	`ext4_’code_exŒa_time
(&(
šode
)->
xtime
); \

866 } 0)

	)

868 
	#EXT4_EINODE_SET_XTIME
(
xtime
, 
ešode
, 
¿w_šode
) \

870 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ešode
, 
xtime
)) \

871 (
¿w_šode
)->
xtime
 = 
	`ıu_to_Ë32
((
ešode
)->xtime.
tv_£c
); \

872 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ešode
, 
xtime
 ## 
_exŒa
)) \

873 (
¿w_šode
)->
xtime
 ## 
_exŒa
 = \

874 
	`ext4_’code_exŒa_time
(&(
ešode
)->
xtime
); \

875 } 0)

	)

877 
	#EXT4_INODE_GET_XTIME
(
xtime
, 
šode
, 
¿w_šode
) \

879 (
šode
)->
xtime
.
tv_£c
 = (sigÃd)
	`Ë32_to_ıu
((
¿w_šode
)->xtime); \

880 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
	`EXT4_I
(
šode
), 
xtime
 ## 
_exŒa
)) \

881 
	`ext4_decode_exŒa_time
(&(
šode
)->
xtime
, \

882 
¿w_šode
->
xtime
 ## 
_exŒa
); \

884 (
šode
)->
xtime
.
tv_n£c
 = 0; \

885 } 0)

	)

887 
	#EXT4_EINODE_GET_XTIME
(
xtime
, 
ešode
, 
¿w_šode
) \

889 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ešode
, 
xtime
)) \

890 (
ešode
)->
xtime
.
tv_£c
 = \

891 (sigÃd)
	`Ë32_to_ıu
((
¿w_šode
)->
xtime
); \

893 (
ešode
)->
xtime
.
tv_£c
 = 0; \

894 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ešode
, 
xtime
 ## 
_exŒa
)) \

895 
	`ext4_decode_exŒa_time
(&(
ešode
)->
xtime
, \

896 
¿w_šode
->
xtime
 ## 
_exŒa
); \

898 (
ešode
)->
xtime
.
tv_n£c
 = 0; \

899 } 0)

	)

901 
	#i_disk_v”siÚ
 
osd1
.
lšux1
.
l_i_v”siÚ


	)

903 #ià
defšed
(
__KERNEL__
è|| defšed(
__lšux__
)

904 
	#i_»£rved1
 
osd1
.
lšux1
.
l_i_»£rved1


	)

905 
	#i_fe_aş_high
 
osd2
.
lšux2
.
l_i_fe_aş_high


	)

906 
	#i_blocks_high
 
osd2
.
lšux2
.
l_i_blocks_high


	)

907 
	#i_uid_low
 
i_uid


	)

908 
	#i_gid_low
 
i_gid


	)

909 
	#i_uid_high
 
osd2
.
lšux2
.
l_i_uid_high


	)

910 
	#i_gid_high
 
osd2
.
lšux2
.
l_i_gid_high


	)

911 
	#i_checksum_lo
 
osd2
.
lšux2
.
l_i_checksum_lo


	)

913 #–ià
defšed
(
__GNU__
)

915 
	#i_Œª¦©Ü
 
osd1
.
hurd1
.
h_i_Œª¦©Ü


	)

916 
	#i_uid_high
 
osd2
.
hurd2
.
h_i_uid_high


	)

917 
	#i_gid_high
 
osd2
.
hurd2
.
h_i_gid_high


	)

918 
	#i_authÜ
 
osd2
.
hurd2
.
h_i_authÜ


	)

920 #–ià
defšed
(
__masix__
)

922 
	#i_»£rved1
 
osd1
.
masix1
.
m_i_»£rved1


	)

923 
	#i_fe_aş_high
 
osd2
.
masix2
.
m_i_fe_aş_high


	)

924 
	#i_»£rved2
 
osd2
.
masix2
.
m_i_»£rved2


	)

928 
	~"ex‹Ás_¡©us.h
"

947 
	mI_DATA_SEM_NORMAL
 = 0,

948 
	mI_DATA_SEM_OTHER
,

949 
	mI_DATA_SEM_QUOTA
,

954 
	#EXT4_FC_TAG_ADD_RANGE
 0x1

	)

955 
	#EXT4_FC_TAG_DEL_RANGE
 0x2

	)

956 
	#EXT4_FC_TAG_CREAT_DENTRY
 0x3

	)

957 
	#EXT4_FC_TAG_ADD_DENTRY
 0x4

	)

958 
	#EXT4_FC_TAG_DEL_DENTRY
 0x5

	)

964 
	sext4_fc_d’Œy_upd©e
 {

965 
	mfcd_İ
;

966 
	mfcd_·»Á
;

967 
	mfcd_šo
;

968 
q¡r
 
	mfcd_Çme
;

969 
	mfcd_šame
[
DNAME_INLINE_LEN
];

970 
li¡_h—d
 
	mfcd_li¡
;

976 
	sext4_šode_šfo
 {

977 
__Ë32
 
	mi_d©a
[15];

978 
__u32
 
	mi_dtime
;

979 
ext4_fsblk_t
 
	mi_fe_aş
;

988 
ext4_group_t
 
	mi_block_group
;

989 
ext4_lblk_t
 
	mi_dœ_¡¬t_lookup
;

990 #ià(
BITS_PER_LONG
 < 64)

991 
	mi_¡©e_æags
;

993 
	mi_æags
;

1002 
rw_£m­hÜe
 
	mx©Œ_£m
;

1004 
li¡_h—d
 
	mi_Üphª
;

1006 
li¡_h—d
 
	mi_fc_li¡
;

1016 
tid_t
 
	mi_fc_tid
;

1022 
ext4_lblk_t
 
	mi_fc_lblk_¡¬t
;

1028 
ext4_lblk_t
 
	mi_fc_lblk_’d
;

1030 
rwlock_t
 
	mi_fc_lock
;

1035 
ext4_fc_d’Œy_upd©e
 *
	mi_fc_md©a_upd©e
;

1052 
loff_t
 
	mi_disksize
;

1064 
rw_£m­hÜe
 
	mi_d©a_£m
;

1073 
rw_£m­hÜe
 
	mi_mm­_£m
;

1074 
šode
 
	mvfs_šode
;

1075 
jbd2_šode
 *
	mjšode
;

1077 
¥šlock_t
 
	mi_¿w_lock
;

1083 
time¥ec
 
	mi_ütime
;

1086 
li¡_h—d
 
	mi_´—Îoc_li¡
;

1087 
¥šlock_t
 
	mi_´—Îoc_lock
;

1090 
ext4_es_Œ“
 
	mi_es_Œ“
;

1091 
rwlock_t
 
	mi_es_lock
;

1092 
li¡_h—d
 
	mi_es_li¡
;

1093 
	mi_es_®l_Ä
;

1094 
	mi_es_shk_Ä
;

1095 
ext4_lblk_t
 
	mi_es_shršk_lblk
;

1100 
ext4_group_t
 
	mi_Ï¡_®loc_group
;

1104 
	mi_»£rved_d©a_blocks
;

1105 
ext4_lblk_t
 
	mi_da_m‘ad©a_ÿlc_Ï¡_lblock
;

1106 
	mi_da_m‘ad©a_ÿlc_Ën
;

1109 
__u16
 
	mi_exŒa_isize
;

1112 
u16
 
	mi_šlše_off
;

1113 
u16
 
	mi_šlše_size
;

1115 #ifdeà
CONFIG_QUOTA


1117 
qsize_t
 
	mi_»£rved_quÙa
;

1121 
¥šlock_t
 
	mi_com¶‘ed_io_lock
;

1126 
li¡_h—d
 
	mi_rsv_cÚv”siÚ_li¡
;

1127 
wÜk_¡ruù
 
	mi_rsv_cÚv”siÚ_wÜk
;

1128 
©omic_t
 
	mi_unwr™‹n
;

1130 
¥šlock_t
 
	mi_block_»£rv©iÚ_lock
;

1136 
tid_t
 
	mi_sync_tid
;

1137 
tid_t
 
	mi_d©async_tid
;

1139 #ifdeà
CONFIG_QUOTA


1140 
dquÙ
 *
	mi_dquÙ
[
MAXQUOTAS
];

1144 
__u32
 
	mi_csum_£ed
;

1146 
k´ojid_t
 
	mi_´ojid
;

1152 
	#EXT4_VALID_FS
 0x0001

	)

1153 
	#EXT4_ERROR_FS
 0x0002

	)

1154 
	#EXT4_ORPHAN_FS
 0x0004

	)

1155 
	#EXT4_FC_REPLAY
 0x0008

	)

1156 
	#EXT4_FC_INELIGIBLE
 0x0010

	)

1161 
	#EXT2_FLAGS_SIGNED_HASH
 0x0001

	)

1162 
	#EXT2_FLAGS_UNSIGNED_HASH
 0x0002

	)

1163 
	#EXT2_FLAGS_TEST_FILESYS
 0x0004

	)

1168 
	#EXT4_MOUNT_NO_MBCACHE
 0x00001

	)

1169 
	#EXT4_MOUNT_GRPID
 0x00004

	)

1170 
	#EXT4_MOUNT_DEBUG
 0x00008

	)

1171 
	#EXT4_MOUNT_ERRORS_CONT
 0x00010

	)

1172 
	#EXT4_MOUNT_ERRORS_RO
 0x00020

	)

1173 
	#EXT4_MOUNT_ERRORS_PANIC
 0x00040

	)

1174 
	#EXT4_MOUNT_ERRORS_MASK
 0x00070

	)

1175 
	#EXT4_MOUNT_MINIX_DF
 0x00080

	)

1176 
	#EXT4_MOUNT_NOLOAD
 0x00100

	)

1177 #ifdeà
CONFIG_FS_DAX


1178 
	#EXT4_MOUNT_DAX
 0x00200

	)

1180 
	#EXT4_MOUNT_DAX
 0

	)

1182 
	#EXT4_MOUNT_DATA_FLAGS
 0x00C00

	)

1183 
	#EXT4_MOUNT_JOURNAL_DATA
 0x00400

	)

1184 
	#EXT4_MOUNT_ORDERED_DATA
 0x00800

	)

1185 
	#EXT4_MOUNT_WRITEBACK_DATA
 0x00C00

	)

1186 
	#EXT4_MOUNT_UPDATE_JOURNAL
 0x01000

	)

1187 
	#EXT4_MOUNT_NO_UID32
 0x02000

	)

1188 
	#EXT4_MOUNT_XATTR_USER
 0x04000

	)

1189 
	#EXT4_MOUNT_POSIX_ACL
 0x08000

	)

1190 
	#EXT4_MOUNT_NO_AUTO_DA_ALLOC
 0x10000

	)

1191 
	#EXT4_MOUNT_BARRIER
 0x20000

	)

1192 
	#EXT4_MOUNT_QUOTA
 0x40000

	)

1193 
	#EXT4_MOUNT_USRQUOTA
 0x80000

	)

1196 
	#EXT4_MOUNT_GRPQUOTA
 0x100000

	)

1199 
	#EXT4_MOUNT_PRJQUOTA
 0x200000

	)

1201 
	#EXT4_MOUNT_DIOREAD_NOLOCK
 0x400000

	)

1202 
	#EXT4_MOUNT_JOURNAL_CHECKSUM
 0x800000

	)

1203 
	#EXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 0x1000000

	)

1204 
	#EXT4_MOUNT_DELALLOC
 0x8000000

	)

1205 
	#EXT4_MOUNT_DATA_ERR_ABORT
 0x10000000

	)

1206 
	#EXT4_MOUNT_BLOCK_VALIDITY
 0x20000000

	)

1207 
	#EXT4_MOUNT_DISCARD
 0x40000000

	)

1208 
	#EXT4_MOUNT_INIT_INODE_TABLE
 0x80000000

	)

1215 
	#EXT4_MOUNT2_EXPLICIT_DELALLOC
 0x00000001

	)

1217 
	#EXT4_MOUNT2_STD_GROUP_SIZE
 0x00000002

	)

1220 
	#EXT4_MOUNT2_HURD_COMPAT
 0x00000004

	)

1223 
	#EXT4_MOUNT2_EXPLICIT_JOURNAL_CHECKSUM
 0x00000008

	)

1226 
	#EXT4_MOUNT2_JOURNAL_FAST_COMMIT
 0x00000010

	)

1228 
	#EXT4_MOUNT2_JOURNAL_FC_SOFT_CONSISTENCY
 0x00000020

	)

1233 
	#ş—r_İt
(
sb
, 
İt
è
	`EXT4_SB
(sb)->
s_mouÁ_İt
 &= \

1234 ~
EXT4_MOUNT_
##
İt


	)

1235 
	#£t_İt
(
sb
, 
İt
è
	`EXT4_SB
(sb)->
s_mouÁ_İt
 |= \

1236 
EXT4_MOUNT_
##
İt


	)

1237 
	#‹¡_İt
(
sb
, 
İt
è(
	`EXT4_SB
(sb)->
s_mouÁ_İt
 & \

1238 
EXT4_MOUNT_
##
İt
)

	)

1240 
	#ş—r_İt2
(
sb
, 
İt
è
	`EXT4_SB
(sb)->
s_mouÁ_İt2
 &= \

1241 ~
EXT4_MOUNT2_
##
İt


	)

1242 
	#£t_İt2
(
sb
, 
İt
è
	`EXT4_SB
(sb)->
s_mouÁ_İt2
 |= \

1243 
EXT4_MOUNT2_
##
İt


	)

1244 
	#‹¡_İt2
(
sb
, 
İt
è(
	`EXT4_SB
(sb)->
s_mouÁ_İt2
 & \

1245 
EXT4_MOUNT2_
##
İt
)

	)

1247 
	#ext4_‹¡_ªd_£t_b™
 
__‹¡_ªd_£t_b™_Ë


	)

1248 
	#ext4_£t_b™
 
__£t_b™_Ë


	)

1249 
	#ext4_£t_b™_©omic
 
ext2_£t_b™_©omic


	)

1250 
	#ext4_‹¡_ªd_ş—r_b™
 
__‹¡_ªd_ş—r_b™_Ë


	)

1251 
	#ext4_ş—r_b™
 
__ş—r_b™_Ë


	)

1252 
	#ext4_ş—r_b™_©omic
 
ext2_ş—r_b™_©omic


	)

1253 
	#ext4_‹¡_b™
 
‹¡_b™_Ë


	)

1254 
	#ext4_fšd_Ãxt_z”o_b™
 
fšd_Ãxt_z”o_b™_Ë


	)

1255 
	#ext4_fšd_Ãxt_b™
 
fšd_Ãxt_b™_Ë


	)

1257 
ext4_£t_b™s
(*
bm
, 
cur
, 
Ën
);

1262 
	#EXT4_DFL_MAX_MNT_COUNT
 20

	)

1263 
	#EXT4_DFL_CHECKINTERVAL
 0

	)

1268 
	#EXT4_ERRORS_CONTINUE
 1

	)

1269 
	#EXT4_ERRORS_RO
 2

	)

1270 
	#EXT4_ERRORS_PANIC
 3

	)

1271 
	#EXT4_ERRORS_DEFAULT
 
EXT4_ERRORS_CONTINUE


	)

1274 
	#EXT4_CRC32C_CHKSUM
 1

	)

1279 
	sext4_su³r_block
 {

1280  
__Ë32
 
	ms_šodes_couÁ
;

1281 
__Ë32
 
	ms_blocks_couÁ_lo
;

1282 
__Ë32
 
	ms_r_blocks_couÁ_lo
;

1283 
__Ë32
 
	ms_ä“_blocks_couÁ_lo
;

1284  
__Ë32
 
	ms_ä“_šodes_couÁ
;

1285 
__Ë32
 
	ms_fœ¡_d©a_block
;

1286 
__Ë32
 
	ms_log_block_size
;

1287 
__Ë32
 
	ms_log_şu¡”_size
;

1288  
__Ë32
 
	ms_blocks_³r_group
;

1289 
__Ë32
 
	ms_şu¡”s_³r_group
;

1290 
__Ë32
 
	ms_šodes_³r_group
;

1291 
__Ë32
 
	ms_mtime
;

1292  
__Ë32
 
	ms_wtime
;

1293 
__Ë16
 
	ms_mÁ_couÁ
;

1294 
__Ë16
 
	ms_max_mÁ_couÁ
;

1295 
__Ë16
 
	ms_magic
;

1296 
__Ë16
 
	ms_¡©e
;

1297 
__Ë16
 
	ms_”rÜs
;

1298 
__Ë16
 
	ms_mšÜ_»v_Ëv–
;

1299  
__Ë32
 
	ms_Ï¡check
;

1300 
__Ë32
 
	ms_checkš‹rv®
;

1301 
__Ë32
 
	ms_ü—tÜ_os
;

1302 
__Ë32
 
	ms_»v_Ëv–
;

1303  
__Ë16
 
	ms_def_»suid
;

1304 
__Ë16
 
	ms_def_»sgid
;

1318 
__Ë32
 
	ms_fœ¡_šo
;

1319 
__Ë16
 
	ms_šode_size
;

1320 
__Ë16
 
	ms_block_group_Ä
;

1321 
__Ë32
 
	ms_ã©u»_com·t
;

1322  
__Ë32
 
	ms_ã©u»_šcom·t
;

1323 
__Ë32
 
	ms_ã©u»_ro_com·t
;

1324  
__u8
 
	ms_uuid
[16];

1325  
	ms_vŞume_Çme
[16];

1326  
	ms_Ï¡_mouÁed
[64];

1327  
__Ë32
 
	ms_®gÜ™hm_u§ge_b™m­
;

1332 
__u8
 
	ms_´—Îoc_blocks
;

1333 
__u8
 
	ms_´—Îoc_dœ_blocks
;

1334 
__Ë16
 
	ms_»£rved_gdt_blocks
;

1338  
__u8
 
	ms_jouº®_uuid
[16];

1339  
__Ë32
 
	ms_jouº®_šum
;

1340 
__Ë32
 
	ms_jouº®_dev
;

1341 
__Ë32
 
	ms_Ï¡_Üphª
;

1342 
__Ë32
 
	ms_hash_£ed
[4];

1343 
__u8
 
	ms_def_hash_v”siÚ
;

1344 
__u8
 
	ms_jÆ_backup_ty³
;

1345 
__Ë16
 
	ms_desc_size
;

1346  
__Ë32
 
	ms_deçuÉ_mouÁ_İts
;

1347 
__Ë32
 
	ms_fœ¡_m‘a_bg
;

1348 
__Ë32
 
	ms_mkfs_time
;

1349 
__Ë32
 
	ms_jÆ_blocks
[17];

1351  
__Ë32
 
	ms_blocks_couÁ_hi
;

1352 
__Ë32
 
	ms_r_blocks_couÁ_hi
;

1353 
__Ë32
 
	ms_ä“_blocks_couÁ_hi
;

1354 
__Ë16
 
	ms_mš_exŒa_isize
;

1355 
__Ë16
 
	ms_wªt_exŒa_isize
;

1356 
__Ë32
 
	ms_æags
;

1357 
__Ë16
 
	ms_¿id_¡ride
;

1358 
__Ë16
 
	ms_mmp_upd©e_š‹rv®
;

1359 
__Ë64
 
	ms_mmp_block
;

1360 
__Ë32
 
	ms_¿id_¡re_width
;

1361 
__u8
 
	ms_log_groups_³r_æex
;

1362 
__u8
 
	ms_checksum_ty³
;

1363 
__u8
 
	ms_’üy±iÚ_Ëv–
;

1364 
__u8
 
	ms_»£rved_·d
;

1365 
__Ë64
 
	ms_kby‹s_wr™‹n
;

1366 
__Ë32
 
	ms_¢­shÙ_šum
;

1367 
__Ë32
 
	ms_¢­shÙ_id
;

1368 
__Ë64
 
	ms_¢­shÙ_r_blocks_couÁ
;

1370 
__Ë32
 
	ms_¢­shÙ_li¡
;

1372 
	#EXT4_S_ERR_START
 
	`off£tof
(
ext4_su³r_block
, 
s_”rÜ_couÁ
)

	)

1373 
__Ë32
 
	ms_”rÜ_couÁ
;

1374 
__Ë32
 
	ms_fœ¡_”rÜ_time
;

1375 
__Ë32
 
	ms_fœ¡_”rÜ_šo
;

1376 
__Ë64
 
	ms_fœ¡_”rÜ_block
;

1377 
__u8
 
	ms_fœ¡_”rÜ_func
[32];

1378 
__Ë32
 
	ms_fœ¡_”rÜ_lše
;

1379 
__Ë32
 
	ms_Ï¡_”rÜ_time
;

1380 
__Ë32
 
	ms_Ï¡_”rÜ_šo
;

1381 
__Ë32
 
	ms_Ï¡_”rÜ_lše
;

1382 
__Ë64
 
	ms_Ï¡_”rÜ_block
;

1383 
__u8
 
	ms_Ï¡_”rÜ_func
[32];

1384 
	#EXT4_S_ERR_END
 
	`off£tof
(
ext4_su³r_block
, 
s_mouÁ_İts
)

	)

1385 
__u8
 
	ms_mouÁ_İts
[64];

1386 
__Ë32
 
	ms_u¤_quÙa_šum
;

1387 
__Ë32
 
	ms_g½_quÙa_šum
;

1388 
__Ë32
 
	ms_ov”h—d_şu¡”s
;

1389 
__Ë32
 
	ms_backup_bgs
[2];

1390 
__u8
 
	ms_’üy±_®gos
[4];

1391 
__u8
 
	ms_’üy±_pw_§É
[16];

1392 
__Ë32
 
	ms_Íf_šo
;

1393 
__Ë32
 
	ms_´j_quÙa_šum
;

1394 
__Ë32
 
	ms_checksum_£ed
;

1395 
__Ë32
 
	ms_»£rved
[98];

1396 
__Ë32
 
	ms_checksum
;

1399 
	#EXT4_S_ERR_LEN
 (
EXT4_S_ERR_END
 - 
EXT4_S_ERR_START
)

	)

1401 #ifdeà
__KERNEL__


1406 
	#EXT4_MF_MNTDIR_SAMPLED
 0x0001

	)

1407 
	#EXT4_MF_FS_ABORTED
 0x0002

	)

1408 
	#EXT4_MF_TEST_DUMMY_ENCRYPTION
 0x0004

	)

1410 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


1411 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
è(
	`uÆik–y
((sbi)->
s_mouÁ_æags
 & \

1412 
EXT4_MF_TEST_DUMMY_ENCRYPTION
))

	)

1414 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
è(0)

	)

1418 
	#EXT4_MAXQUOTAS
 3

	)

1424 
	mEXT4_FC_REASON_META_ALLOC
,

1425 
	mEXT4_FC_REASON_XATTR
,

1426 
	mEXT4_FC_REASON_CROSS_RENAME
,

1427 
	mEXT4_FC_REASON_FALLOC_RANGE_OP
,

1428 
	mEXT4_FC_REASON_JOURNAL_FLAG_CHANGE
,

1429 
	mEXT4_FC_REASON_DELETE
,

1430 
	mEXT4_FC_REASON_MEM
,

1431 
	mEXT4_FC_REASON_SWAP_BOOT
,

1432 
	mEXT4_FC_REASON_RESIZE
,

1433 
	mEXT4_FC_REASON_RENAME_DIR
,

1434 
	mEXT4_FC_REASON_MAX


1437 
	sext4_fc_¡©s
 {

1438 
	mfc_š–igibË_»asÚ_couÁ
[
EXT4_FC_REASON_MAX
];

1439 
	mfc_num_comm™s
;

1440 
	mfc_š–igibË_comm™s
;

1441 
	mfc_numblks
;

1447 
	sext4_sb_šfo
 {

1448 
	ms_desc_size
;

1449 
	ms_šodes_³r_block
;

1450 
	ms_blocks_³r_group
;

1451 
	ms_şu¡”s_³r_group
;

1452 
	ms_šodes_³r_group
;

1453 
	ms_™b_³r_group
;

1454 
	ms_gdb_couÁ
;

1455 
	ms_desc_³r_block
;

1456 
ext4_group_t
 
	ms_groups_couÁ
;

1457 
ext4_group_t
 
	ms_blockfe_groups
;

1458 
	ms_ov”h—d
;

1459 
	ms_şu¡”_¿tio
;

1460 
	ms_şu¡”_b™s
;

1461 
loff_t
 
	ms_b™m­_maxby‹s
;

1462 
bufãr_h—d
 * 
	ms_sbh
;

1463 
ext4_su³r_block
 *
	ms_es
;

1464 
bufãr_h—d
 **
	ms_group_desc
;

1465 
	ms_mouÁ_İt
;

1466 
	ms_mouÁ_İt2
;

1467 
	ms_mouÁ_æags
;

1468 
	ms_def_mouÁ_İt
;

1469 
ext4_fsblk_t
 
	ms_sb_block
;

1470 
©omic64_t
 
	ms_»sv_şu¡”s
;

1471 
kuid_t
 
	ms_»suid
;

1472 
kgid_t
 
	ms_»sgid
;

1473 
	ms_mouÁ_¡©e
;

1474 
	ms_·d
;

1475 
	ms_addr_³r_block_b™s
;

1476 
	ms_desc_³r_block_b™s
;

1477 
	ms_šode_size
;

1478 
	ms_fœ¡_šo
;

1479 
	ms_šode_»adah—d_blks
;

1480 
	ms_šode_gßl
;

1481 
¥šlock_t
 
	ms_Ãxt_g’_lock
;

1482 
u32
 
	ms_Ãxt_g’”©iÚ
;

1483 
u32
 
	ms_hash_£ed
[4];

1484 
	ms_def_hash_v”siÚ
;

1485 
	ms_hash_unsigÃd
;

1486 
³rıu_couÁ”
 
	ms_ä“şu¡”s_couÁ”
;

1487 
³rıu_couÁ”
 
	ms_ä“šodes_couÁ”
;

1488 
³rıu_couÁ”
 
	ms_dœs_couÁ”
;

1489 
³rıu_couÁ”
 
	ms_dœtyşu¡”s_couÁ”
;

1490 
blockgroup_lock
 *
	ms_blockgroup_lock
;

1491 
´oc_dœ_’Œy
 *
	ms_´oc
;

1492 
kobjeù
 
	ms_kobj
;

1493 
com¶‘iÚ
 
	ms_kobj_uÄegi¡”
;

1494 
su³r_block
 *
	ms_sb
;

1497 
jouº®_s
 *
	ms_jouº®
;

1498 
li¡_h—d
 
	ms_Üphª
;

1499 
mu‹x
 
	ms_Üphª_lock
;

1500 
	ms_ext4_æags
;

1501 
	ms_comm™_š‹rv®
;

1502 
u32
 
	ms_max_b©ch_time
;

1503 
u32
 
	ms_mš_b©ch_time
;

1504 
block_deviû
 *
	mjouº®_bdev
;

1505 #ifdeà
CONFIG_QUOTA


1506 *
	ms_qf_Çmes
[
EXT4_MAXQUOTAS
];

1507 
	ms_jquÙa_fmt
;

1509 
	ms_wªt_exŒa_isize
;

1510 
rb_roÙ
 
	msy¡em_blks
;

1512 #ifdeà
EXTENTS_STATS


1514 
	ms_ext_mš
;

1515 
	ms_ext_max
;

1516 
	ms_d•th_max
;

1517 
¥šlock_t
 
	ms_ext_¡©s_lock
;

1518 
	ms_ext_blocks
;

1519 
	ms_ext_ex‹Ás
;

1523 
ext4_group_šfo
 ***
	ms_group_šfo
;

1524 
šode
 *
	ms_buddy_ÿche
;

1525 
¥šlock_t
 
	ms_md_lock
;

1526 *
	ms_mb_off£ts
;

1527 *
	ms_mb_maxs
;

1528 
	ms_group_šfo_size
;

1529 
	ms_mb_ä“_³ndšg
;

1530 
li¡_h—d
 
	ms_ä“d_d©a_li¡
;

1534 
	ms_¡re
;

1535 
	ms_mb_¡»am_»que¡
;

1536 
	ms_mb_max_to_sÿn
;

1537 
	ms_mb_mš_to_sÿn
;

1538 
	ms_mb_¡©s
;

1539 
	ms_mb_Üd”2_»qs
;

1540 
	ms_mb_group_´—Îoc
;

1541 
	ms_max_dœ_size_kb
;

1543 
	ms_mb_Ï¡_group
;

1544 
	ms_mb_Ï¡_¡¬t
;

1547 
©omic_t
 
	ms_b®_»qs
;

1548 
©omic_t
 
	ms_b®_sucûss
;

1549 
©omic_t
 
	ms_b®_®loÿ‹d
;

1550 
©omic_t
 
	ms_b®_ex_sÿÂed
;

1551 
©omic_t
 
	ms_b®_gßls
;

1552 
©omic_t
 
	ms_b®_b»aks
;

1553 
©omic_t
 
	ms_b®_2Üd”s
;

1554 
¥šlock_t
 
	ms_b®_lock
;

1555 
	ms_mb_budd›s_g’”©ed
;

1556 
	ms_mb_g’”©iÚ_time
;

1557 
©omic_t
 
	ms_mb_lo¡_chunks
;

1558 
©omic_t
 
	ms_mb_´—Îoÿ‹d
;

1559 
©omic_t
 
	ms_mb_disÿrded
;

1560 
©omic_t
 
	ms_lock_busy
;

1563 
ext4_loÿl™y_group
 
__³rıu
 *
	ms_loÿl™y_groups
;

1566 
	ms_£ùÜs_wr™‹n_¡¬t
;

1567 
u64
 
	ms_kby‹s_wr™‹n
;

1570 
	ms_ex‹Á_max_z”oout_kb
;

1572 
	ms_log_groups_³r_æex
;

1573 
æex_groups
 *
	ms_æex_groups
;

1574 
ext4_group_t
 
	ms_æex_groups_®loÿ‹d
;

1577 
wÜkqueue_¡ruù
 *
	mrsv_cÚv”siÚ_wq
;

1580 
tim”_li¡
 
	ms_”r_»pÜt
;

1583 
ext4_li_»que¡
 *
	ms_li_»que¡
;

1585 
	ms_li_wa™_muÉ
;

1588 
sk_¡ruù
 *
	ms_mmp_tsk
;

1591 
©omic_t
 
	ms_Ï¡_Œim_mšblks
;

1594 
üy±o_shash
 *
	ms_chksum_driv”
;

1597 
__u32
 
	ms_csum_£ed
;

1600 
shršk”
 
	ms_es_shršk”
;

1601 
li¡_h—d
 
	ms_es_li¡
;

1602 
	ms_es_Ä_šode
;

1603 
ext4_es_¡©s
 
	ms_es_¡©s
;

1604 
mb_ÿche
 *
	ms_—_block_ÿche
;

1605 
mb_ÿche
 *
	ms_—_šode_ÿche
;

1606 
¥šlock_t
 
s_es_lock
 
	m____ÿch–še_®igÃd_š_smp
;

1609 
¿‹lim™_¡©e
 
	ms_”r_¿‹lim™_¡©e
;

1610 
¿‹lim™_¡©e
 
	ms_w¬nšg_¿‹lim™_¡©e
;

1611 
¿‹lim™_¡©e
 
	ms_msg_¿‹lim™_¡©e
;

1614 
³rıu_rw_£m­hÜe
 
	ms_jouº®_æag_rw£m
;

1617 
li¡_h—d
 
	ms_fc_q
;

1620 
li¡_h—d
 
	ms_fc_d’Œy_q
;

1621 
¥šlock_t
 
	ms_fc_lock
;

1622 
ext4_fc_¡©s
 
	ms_fc_¡©s
;

1625 
šlše
 
ext4_sb_šfo
 *
	$EXT4_SB
(
su³r_block
 *
sb
)

1627  
sb
->
s_fs_šfo
;

1628 
	}
}

1629 
šlše
 
ext4_šode_šfo
 *
	$EXT4_I
(
šode
 *inode)

1631  
	`cÚš”_of
(
šode
, 
ext4_šode_šfo
, 
vfs_šode
);

1632 
	}
}

1634 
šlše
 
	$ext4_v®id_šum
(
su³r_block
 *
sb
, 
šo
)

1636  
šo
 =ğ
EXT4_ROOT_INO
 ||

1637 
šo
 =ğ
EXT4_USR_QUOTA_INO
 ||

1638 
šo
 =ğ
EXT4_GRP_QUOTA_INO
 ||

1639 
šo
 =ğ
EXT4_BOOT_LOADER_INO
 ||

1640 
šo
 =ğ
EXT4_JOURNAL_INO
 ||

1641 
šo
 =ğ
EXT4_RESIZE_INO
 ||

1642 (
šo
 >ğ
	`EXT4_FIRST_INO
(
sb
) &&

1643 
šo
 <ğ
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_šodes_couÁ
));

1644 
	}
}

1650 
	mEXT4_STATE_JDATA
,

1651 
	mEXT4_STATE_NEW
,

1652 
	mEXT4_STATE_XATTR
,

1653 
	mEXT4_STATE_NO_EXPAND
,

1654 
	mEXT4_STATE_DA_ALLOC_CLOSE
,

1655 
	mEXT4_STATE_EXT_MIGRATE
,

1656 
	mEXT4_STATE_DIO_UNWRITTEN
,

1657 
	mEXT4_STATE_NEWENTRY
,

1658 
	mEXT4_STATE_DIOREAD_LOCK
,

1660 
	mEXT4_STATE_MAY_INLINE_DATA
,

1661 
	mEXT4_STATE_EXT_PRECACHED
,

1662 
	mEXT4_STATE_FC_ELIGIBLE
,

1663 
	mEXT4_STATE_FC_DATA_SUBMIT
,

1664 
	mEXT4_STATE_FC_MDATA_SUBMIT
,

1669 
	#EXT4_INODE_BIT_FNS
(
Çme
, 
f›ld
, 
off£t
) \

1670 
šlše
 
ext4_‹¡_šode_
##
	`Çme
(
šode
 *šode, 
b™
) \

1672  
	`‹¡_b™
(
b™
 + (
off£t
), &
	`EXT4_I
(
šode
)->
i_
##
f›ld
); \

1674 
šlše
 
ext4_£t_šode_
##
	`Çme
(
šode
 *šode, 
b™
) \

1676 
	`£t_b™
(
b™
 + (
off£t
), &
	`EXT4_I
(
šode
)->
i_
##
f›ld
); \

1678 
šlše
 
ext4_ş—r_šode_
##
	`Çme
(
šode
 *šode, 
b™
) \

1680 
	`ş—r_b™
(
b™
 + (
off£t
), &
	`EXT4_I
(
šode
)->
i_
##
f›ld
); \

1681 }

	)

1685 
šlše
 
ext4_‹¡_šode_æag
(
šode
 *šode, 
b™
);

1686 
šlše
 
ext4_£t_šode_æag
(
šode
 *šode, 
b™
);

1687 
šlše
 
ext4_ş—r_šode_æag
(
šode
 *šode, 
b™
);

1688 
	$EXT4_INODE_BIT_FNS
(
æag
, 
æags
, 0)

1692 
šlše
 
	`ext4_‹¡_šode_¡©e
(
šode
 *šode, 
b™
);

1693 
šlše
 
	`ext4_£t_šode_¡©e
(
šode
 *šode, 
b™
);

1694 
šlše
 
	`ext4_ş—r_šode_¡©e
(
šode
 *šode, 
b™
);

1695 #ià(
BITS_PER_LONG
 < 64)

1696 
	$EXT4_INODE_BIT_FNS
(
¡©e
, 
¡©e_æags
, 0)

1698 
šlše
 
	$ext4_ş—r_¡©e_æags
(
ext4_šode_šfo
 *
ei
)

1700 (
ei
)->
i_¡©e_æags
 = 0;

1701 
	}
}

1703 
	$EXT4_INODE_BIT_FNS
(
¡©e
, 
æags
, 32)

1705 
šlše
 
	$ext4_ş—r_¡©e_æags
(
ext4_šode_šfo
 *
ei
)

1708 
	}
}

1714 
	#EXT4_SB
(
sb
è(sb)

	)

1720 
	#NEXT_ORPHAN
(
šode
è
	`EXT4_I
(šode)->
i_dtime


	)

1725 
	#EXT4_OS_LINUX
 0

	)

1726 
	#EXT4_OS_HURD
 1

	)

1727 
	#EXT4_OS_MASIX
 2

	)

1728 
	#EXT4_OS_FREEBSD
 3

	)

1729 
	#EXT4_OS_LITES
 4

	)

1734 
	#EXT4_GOOD_OLD_REV
 0

	)

1735 
	#EXT4_DYNAMIC_REV
 1

	)

1737 
	#EXT4_CURRENT_REV
 
EXT4_GOOD_OLD_REV


	)

1738 
	#EXT4_MAX_SUPP_REV
 
EXT4_DYNAMIC_REV


	)

1740 
	#EXT4_GOOD_OLD_INODE_SIZE
 128

	)

1746 
	#EXT4_FEATURE_COMPAT_DIR_PREALLOC
 0x0001

	)

1747 
	#EXT4_FEATURE_COMPAT_IMAGIC_INODES
 0x0002

	)

1748 
	#EXT4_FEATURE_COMPAT_HAS_JOURNAL
 0x0004

	)

1749 
	#EXT4_FEATURE_COMPAT_EXT_ATTR
 0x0008

	)

1750 
	#EXT4_FEATURE_COMPAT_RESIZE_INODE
 0x0010

	)

1751 
	#EXT4_FEATURE_COMPAT_DIR_INDEX
 0x0020

	)

1752 
	#EXT4_FEATURE_COMPAT_SPARSE_SUPER2
 0x0200

	)

1753 
	#EXT4_FEATURE_COMPAT_FAST_COMMIT
 0x0400

	)

1755 
	#EXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
 0x0001

	)

1756 
	#EXT4_FEATURE_RO_COMPAT_LARGE_FILE
 0x0002

	)

1757 
	#EXT4_FEATURE_RO_COMPAT_BTREE_DIR
 0x0004

	)

1758 
	#EXT4_FEATURE_RO_COMPAT_HUGE_FILE
 0x0008

	)

1759 
	#EXT4_FEATURE_RO_COMPAT_GDT_CSUM
 0x0010

	)

1760 
	#EXT4_FEATURE_RO_COMPAT_DIR_NLINK
 0x0020

	)

1761 
	#EXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 0x0040

	)

1762 
	#EXT4_FEATURE_RO_COMPAT_QUOTA
 0x0100

	)

1763 
	#EXT4_FEATURE_RO_COMPAT_BIGALLOC
 0x0200

	)

1770 
	#EXT4_FEATURE_RO_COMPAT_METADATA_CSUM
 0x0400

	)

1771 
	#EXT4_FEATURE_RO_COMPAT_READONLY
 0x1000

	)

1772 
	#EXT4_FEATURE_RO_COMPAT_PROJECT
 0x2000

	)

1774 
	#EXT4_FEATURE_INCOMPAT_COMPRESSION
 0x0001

	)

1775 
	#EXT4_FEATURE_INCOMPAT_FILETYPE
 0x0002

	)

1776 
	#EXT4_FEATURE_INCOMPAT_RECOVER
 0x0004

	)

1777 
	#EXT4_FEATURE_INCOMPAT_JOURNAL_DEV
 0x0008

	)

1778 
	#EXT4_FEATURE_INCOMPAT_META_BG
 0x0010

	)

1779 
	#EXT4_FEATURE_INCOMPAT_EXTENTS
 0x0040

	)

1780 
	#EXT4_FEATURE_INCOMPAT_64BIT
 0x0080

	)

1781 
	#EXT4_FEATURE_INCOMPAT_MMP
 0x0100

	)

1782 
	#EXT4_FEATURE_INCOMPAT_FLEX_BG
 0x0200

	)

1783 
	#EXT4_FEATURE_INCOMPAT_EA_INODE
 0x0400

	)

1784 
	#EXT4_FEATURE_INCOMPAT_DIRDATA
 0x1000

	)

1785 
	#EXT4_FEATURE_INCOMPAT_CSUM_SEED
 0x2000

	)

1786 
	#EXT4_FEATURE_INCOMPAT_LARGEDIR
 0x4000

	)

1787 
	#EXT4_FEATURE_INCOMPAT_INLINE_DATA
 0x8000

	)

1788 
	#EXT4_FEATURE_INCOMPAT_ENCRYPT
 0x10000

	)

1790 
	#EXT4_FEATURE_COMPAT_FUNCS
(
Çme
, 
æagÇme
) \

1791 
šlše
 
boŞ
 
ext4_has_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1793  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 & \

1794 
	`ıu_to_Ë32
(
EXT4_FEATURE_COMPAT_
##
æagÇme
)) != 0); \

1796 
šlše
 
ext4_£t_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1798 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 |= \

1799 
	`ıu_to_Ë32
(
EXT4_FEATURE_COMPAT_
##
æagÇme
); \

1801 
šlše
 
ext4_ş—r_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1803 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 &= \

1804 ~
	`ıu_to_Ë32
(
EXT4_FEATURE_COMPAT_
##
æagÇme
); \

1805 }

	)

1807 
	#EXT4_FEATURE_RO_COMPAT_FUNCS
(
Çme
, 
æagÇme
) \

1808 
šlše
 
boŞ
 
ext4_has_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1810  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 & \

1811 
	`ıu_to_Ë32
(
EXT4_FEATURE_RO_COMPAT_
##
æagÇme
)) != 0); \

1813 
šlše
 
ext4_£t_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1815 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 |= \

1816 
	`ıu_to_Ë32
(
EXT4_FEATURE_RO_COMPAT_
##
æagÇme
); \

1818 
šlše
 
ext4_ş—r_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1820 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 &= \

1821 ~
	`ıu_to_Ë32
(
EXT4_FEATURE_RO_COMPAT_
##
æagÇme
); \

1822 }

	)

1824 
	#EXT4_FEATURE_INCOMPAT_FUNCS
(
Çme
, 
æagÇme
) \

1825 
šlše
 
boŞ
 
ext4_has_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1827  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 & \

1828 
	`ıu_to_Ë32
(
EXT4_FEATURE_INCOMPAT_
##
æagÇme
)) != 0); \

1830 
šlše
 
ext4_£t_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1832 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 |= \

1833 
	`ıu_to_Ë32
(
EXT4_FEATURE_INCOMPAT_
##
æagÇme
); \

1835 
šlše
 
ext4_ş—r_ã©u»_
##
	`Çme
(
su³r_block
 *
sb
) \

1837 
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 &= \

1838 ~
	`ıu_to_Ë32
(
EXT4_FEATURE_INCOMPAT_
##
æagÇme
); \

1839 }

	)

1841 
	$EXT4_FEATURE_COMPAT_FUNCS
(
dœ_´—Îoc
, 
DIR_PREALLOC
)

1842 
	$EXT4_FEATURE_COMPAT_FUNCS
(
imagic_šodes
, 
IMAGIC_INODES
)

1843 
	$EXT4_FEATURE_COMPAT_FUNCS
(
jouº®
, 
HAS_JOURNAL
)

1844 
	$EXT4_FEATURE_COMPAT_FUNCS
(
x©Œ
, 
EXT_ATTR
)

1845 
	$EXT4_FEATURE_COMPAT_FUNCS
(
»size_šode
, 
RESIZE_INODE
)

1846 
	$EXT4_FEATURE_COMPAT_FUNCS
(
dœ_šdex
, 
DIR_INDEX
)

1847 
	$EXT4_FEATURE_COMPAT_FUNCS
(
¥¬£_su³r2
, 
SPARSE_SUPER2
)

1848 
	$EXT4_FEATURE_COMPAT_FUNCS
(
ç¡_comm™
, 
FAST_COMMIT
)

1850 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
¥¬£_su³r
, 
SPARSE_SUPER
)

1851 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
Ïrge_fe
, 
LARGE_FILE
)

1852 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
bŒ“_dœ
, 
BTREE_DIR
)

1853 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
huge_fe
, 
HUGE_FILE
)

1854 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
gdt_csum
, 
GDT_CSUM
)

1855 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
dœ_Æšk
, 
DIR_NLINK
)

1856 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
exŒa_isize
, 
EXTRA_ISIZE
)

1857 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
quÙa
, 
QUOTA
)

1858 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
big®loc
, 
BIGALLOC
)

1859 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
m‘ad©a_csum
, 
METADATA_CSUM
)

1860 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
»adÚly
, 
READONLY
)

1861 
	$EXT4_FEATURE_RO_COMPAT_FUNCS
(
´ojeù
, 
PROJECT
)

1863 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
com´essiÚ
, 
COMPRESSION
)

1864 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
f‘y³
, 
FILETYPE
)

1865 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
jouº®_Ãeds_»cov”y
, 
RECOVER
)

1866 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
jouº®_dev
, 
JOURNAL_DEV
)

1867 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
m‘a_bg
, 
META_BG
)

1868 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
ex‹Ás
, 
EXTENTS
)

1869 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(64b
™
, 64B
IT
)

1870 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
mmp
, 
MMP
)

1871 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
æex_bg
, 
FLEX_BG
)

1872 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
—_šode
, 
EA_INODE
)

1873 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
dœd©a
, 
DIRDATA
)

1874 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
csum_£ed
, 
CSUM_SEED
)

1875 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
Ïrgedœ
, 
LARGEDIR
)

1876 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
šlše_d©a
, 
INLINE_DATA
)

1877 
	$EXT4_FEATURE_INCOMPAT_FUNCS
(
’üy±
, 
ENCRYPT
)

1879 
	#EXT2_FEATURE_COMPAT_SUPP
 
EXT4_FEATURE_COMPAT_EXT_ATTR


	)

1880 
	#EXT2_FEATURE_INCOMPAT_SUPP
 (
EXT4_FEATURE_INCOMPAT_FILETYPE
| \

1881 
EXT4_FEATURE_INCOMPAT_META_BG
)

	)

1882 
	#EXT2_FEATURE_RO_COMPAT_SUPP
 (
EXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1883 
EXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1884 
EXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1886 
	#EXT3_FEATURE_COMPAT_SUPP
 
EXT4_FEATURE_COMPAT_EXT_ATTR


	)

1887 
	#EXT3_FEATURE_INCOMPAT_SUPP
 (
EXT4_FEATURE_INCOMPAT_FILETYPE
| \

1888 
EXT4_FEATURE_INCOMPAT_RECOVER
| \

1889 
EXT4_FEATURE_INCOMPAT_META_BG
)

	)

1890 
	#EXT3_FEATURE_RO_COMPAT_SUPP
 (
EXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1891 
EXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1892 
EXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1894 
	#EXT4_FEATURE_COMPAT_SUPP
 
EXT4_FEATURE_COMPAT_EXT_ATTR


	)

1895 
	#EXT4_FEATURE_INCOMPAT_SUPP
 (
EXT4_FEATURE_INCOMPAT_FILETYPE
| \

1896 
EXT4_FEATURE_INCOMPAT_RECOVER
| \

1897 
EXT4_FEATURE_INCOMPAT_META_BG
| \

1898 
EXT4_FEATURE_INCOMPAT_EXTENTS
| \

1899 
EXT4_FEATURE_INCOMPAT_64BIT
| \

1900 
EXT4_FEATURE_INCOMPAT_FLEX_BG
| \

1901 
EXT4_FEATURE_INCOMPAT_EA_INODE
| \

1902 
EXT4_FEATURE_INCOMPAT_MMP
 | \

1903 
EXT4_FEATURE_INCOMPAT_INLINE_DATA
 | \

1904 
EXT4_FEATURE_INCOMPAT_ENCRYPT
 | \

1905 
EXT4_FEATURE_INCOMPAT_CSUM_SEED
 | \

1906 
EXT4_FEATURE_INCOMPAT_LARGEDIR
)

	)

1907 
	#EXT4_FEATURE_RO_COMPAT_SUPP
 (
EXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1908 
EXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1909 
EXT4_FEATURE_RO_COMPAT_GDT_CSUM
| \

1910 
EXT4_FEATURE_RO_COMPAT_DIR_NLINK
 | \

1911 
EXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 | \

1912 
EXT4_FEATURE_RO_COMPAT_BTREE_DIR
 |\

1913 
EXT4_FEATURE_RO_COMPAT_HUGE_FILE
 |\

1914 
EXT4_FEATURE_RO_COMPAT_BIGALLOC
 |\

1915 
EXT4_FEATURE_RO_COMPAT_METADATA_CSUM
|\

1916 
EXT4_FEATURE_RO_COMPAT_QUOTA
 |\

1917 
EXT4_FEATURE_RO_COMPAT_PROJECT
)

	)

1919 
	#EXTN_FEATURE_FUNCS
(
v”
) \

1920 
šlše
 
boŞ
 
ext4_has_unknown_ext
##
v”
##
	`_com·t_ã©u»s
(
su³r_block
 *
sb
) \

1922  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 & \

1923 
	`ıu_to_Ë32
(~
EXT
##
v”
##
_FEATURE_COMPAT_SUPP
)) != 0); \

1924 
	}
} \

1925 
šlše
 
boŞ
 
ext4_has_unknown_ext
##
v”
##
	`_ro_com·t_ã©u»s
(
su³r_block
 *
sb
) \

1927  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 & \

1928 
	`ıu_to_Ë32
(~
EXT
##
v”
##
_FEATURE_RO_COMPAT_SUPP
)) != 0); \

1930 
šlše
 
boŞ
 
ext4_has_unknown_ext
##
v”
##
	`_šcom·t_ã©u»s
(
su³r_block
 *
sb
) \

1932  ((
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 & \

1933 
	`ıu_to_Ë32
(~
EXT
##
v”
##
_FEATURE_INCOMPAT_SUPP
)) != 0); \

1934 }

	)

1936 
	$EXTN_FEATURE_FUNCS
(2)

1937 
	$EXTN_FEATURE_FUNCS
(3)

1938 
	$EXTN_FEATURE_FUNCS
(4)

1940 
šlše
 
boŞ
 
	$ext4_has_com·t_ã©u»s
(
su³r_block
 *
sb
)

1942  (
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_com·t
 != 0);

1943 
	}
}

1944 
šlše
 
boŞ
 
	$ext4_has_ro_com·t_ã©u»s
(
su³r_block
 *
sb
)

1946  (
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
 != 0);

1947 
	}
}

1948 
šlše
 
boŞ
 
	$ext4_has_šcom·t_ã©u»s
(
su³r_block
 *
sb
)

1950  (
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
 != 0);

1951 
	}
}

1956 
	#EXT4_FLAGS_RESIZING
 0

	)

1957 
	#EXT4_FLAGS_SHUTDOWN
 1

	)

1959 
šlše
 
	$ext4_fÜûd_shutdown
(
ext4_sb_šfo
 *
sbi
)

1961  
	`‹¡_b™
(
EXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_ext4_æags
);

1962 
	}
}

1968 
	#EXT4_DEF_RESUID
 0

	)

1969 
	#EXT4_DEF_RESGID
 0

	)

1974 
	#EXT4_DEF_PROJID
 0

	)

1976 
	#EXT4_DEF_INODE_READAHEAD_BLKS
 32

	)

1981 
	#EXT4_DEFM_DEBUG
 0x0001

	)

1982 
	#EXT4_DEFM_BSDGROUPS
 0x0002

	)

1983 
	#EXT4_DEFM_XATTR_USER
 0x0004

	)

1984 
	#EXT4_DEFM_ACL
 0x0008

	)

1985 
	#EXT4_DEFM_UID16
 0x0010

	)

1986 
	#EXT4_DEFM_JMODE
 0x0060

	)

1987 
	#EXT4_DEFM_JMODE_DATA
 0x0020

	)

1988 
	#EXT4_DEFM_JMODE_ORDERED
 0x0040

	)

1989 
	#EXT4_DEFM_JMODE_WBACK
 0x0060

	)

1990 
	#EXT4_DEFM_NOBARRIER
 0x0100

	)

1991 
	#EXT4_DEFM_BLOCK_VALIDITY
 0x0200

	)

1992 
	#EXT4_DEFM_DISCARD
 0x0400

	)

1993 
	#EXT4_DEFM_NODELALLOC
 0x0800

	)

1998 
	#EXT4_DEF_MIN_BATCH_TIME
 0

	)

1999 
	#EXT4_DEF_MAX_BATCH_TIME
 15000

	)

2005 
	#EXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
 4

	)

2010 
	#EXT4_NAME_LEN
 255

	)

2012 
	sext4_dœ_’Œy
 {

2013 
__Ë32
 
	mšode
;

2014 
__Ë16
 
	m»c_Ën
;

2015 
__Ë16
 
	mÇme_Ën
;

2016 
	mÇme
[
EXT4_NAME_LEN
];

2025 
	sext4_dœ_’Œy_2
 {

2026 
__Ë32
 
	mšode
;

2027 
__Ë16
 
	m»c_Ën
;

2028 
__u8
 
	mÇme_Ën
;

2029 
__u8
 
	mfe_ty³
;

2030 
	mÇme
[
EXT4_NAME_LEN
];

2037 
	sext4_dœ_’Œy_
 {

2038 
__Ë32
 
	md‘_»£rved_z”o1
;

2039 
__Ë16
 
	md‘_»c_Ën
;

2040 
__u8
 
	md‘_»£rved_z”o2
;

2041 
__u8
 
	md‘_»£rved_á
;

2042 
__Ë32
 
	md‘_checksum
;

2045 
	#EXT4_DIRENT_TAIL
(
block
, 
blocksize
) \

2046 ((
ext4_dœ_’Œy_
 *)(((*)(
block
)) + \

2047 ((
blocksize
) - \

2048 (
ext4_dœ_’Œy_
))))

	)

2054 
	#EXT4_FT_UNKNOWN
 0

	)

2055 
	#EXT4_FT_REG_FILE
 1

	)

2056 
	#EXT4_FT_DIR
 2

	)

2057 
	#EXT4_FT_CHRDEV
 3

	)

2058 
	#EXT4_FT_BLKDEV
 4

	)

2059 
	#EXT4_FT_FIFO
 5

	)

2060 
	#EXT4_FT_SOCK
 6

	)

2061 
	#EXT4_FT_SYMLINK
 7

	)

2063 
	#EXT4_FT_MAX
 8

	)

2065 
	#EXT4_FT_DIR_CSUM
 0xDE

	)

2072 
	#EXT4_DIR_PAD
 4

	)

2073 
	#EXT4_DIR_ROUND
 (
EXT4_DIR_PAD
 - 1)

	)

2074 
	#EXT4_DIR_REC_LEN
(
Çme_Ën
è((Òame_Ënè+ 8 + 
EXT4_DIR_ROUND
) & \

2075 ~
EXT4_DIR_ROUND
)

	)

2076 
	#EXT4_MAX_REC_LEN
 ((1<<16)-1)

	)

2082 
šlše
 

2083 
	$ext4_»c_Ën_äom_disk
(
__Ë16
 
dËn
, 
blocksize
)

2085 
Ën
 = 
	`Ë16_to_ıu
(
dËn
);

2087 #ià(
PAGE_SIZE
 >= 65536)

2088 ià(
Ën
 =ğ
EXT4_MAX_REC_LEN
 ||†en == 0)

2089  
blocksize
;

2090  (
Ën
 & 65532) | ((len & 3) << 16);

2092  
Ën
;

2094 
	}
}

2096 
šlše
 
__Ë16
 
	$ext4_»c_Ën_to_disk
(
Ën
, 
blocksize
)

2098 ià((
Ën
 > 
blocksize
) || (blocksize > (1 << 18)) || (len & 3))

2099 
	`BUG
();

2100 #ià(
PAGE_SIZE
 >= 65536)

2101 ià(
Ën
 < 65536)

2102  
	`ıu_to_Ë16
(
Ën
);

2103 ià(
Ën
 =ğ
blocksize
) {

2104 ià(
blocksize
 == 65536)

2105  
	`ıu_to_Ë16
(
EXT4_MAX_REC_LEN
);

2107  
	`ıu_to_Ë16
(0);

2109  
	`ıu_to_Ë16
((
Ën
 & 65532) | ((len >> 16) & 3));

2111  
	`ıu_to_Ë16
(
Ën
);

2113 
	}
}

2120 
	#is_dx
(
dœ
è(
	`ext4_has_ã©u»_dœ_šdex
((dœ)->
i_sb
) && \

2121 
	`ext4_‹¡_šode_æag
((
dœ
), 
EXT4_INODE_INDEX
))

	)

2122 
	#EXT4_DIR_LINK_MAX
(
dœ
è
	`uÆik–y
((dœ)->
i_Æšk
 >ğ
EXT4_LINK_MAX
 && \

2123 !(
	`ext4_has_ã©u»_dœ_Æšk
((
dœ
)->
i_sb
è&& 
	`is_dx
(dœ)))

	)

2124 
	#EXT4_DIR_LINK_EMPTY
(
dœ
è((dœ)->
i_Æšk
 =ğ2 || (dœ)->i_Æšk =ğ1)

	)

2128 
	#DX_HASH_LEGACY
 0

	)

2129 
	#DX_HASH_HALF_MD4
 1

	)

2130 
	#DX_HASH_TEA
 2

	)

2131 
	#DX_HASH_LEGACY_UNSIGNED
 3

	)

2132 
	#DX_HASH_HALF_MD4_UNSIGNED
 4

	)

2133 
	#DX_HASH_TEA_UNSIGNED
 5

	)

2135 
šlše
 
u32
 
	$ext4_chksum
(
ext4_sb_šfo
 *
sbi
, 
u32
 
üc
,

2136 cÚ¡ *
add»ss
, 
Ëngth
)

2139 
shash_desc
 
shash
;

2140 
ùx
[4];

2141 } 
desc
;

2142 
”r
;

2144 
	`BUG_ON
(
	`üy±o_shash_descsize
(
sbi
->
s_chksum_driv”
)!=(
desc
.
ùx
));

2146 
desc
.
shash
.
tfm
 = 
sbi
->
s_chksum_driv”
;

2147 
desc
.
shash
.
æags
 = 0;

2148 *(
u32
 *)
desc
.
ùx
 = 
üc
;

2150 
”r
 = 
	`üy±o_shash_upd©e
(&
desc
.
shash
, 
add»ss
, 
Ëngth
);

2151 
	`BUG_ON
(
”r
);

2153  *(
u32
 *)
desc
.
ùx
;

2154 
	}
}

2156 #ifdeà
__KERNEL__


2159 
	sdx_hash_šfo


2161 
u32
 
	mhash
;

2162 
u32
 
	mmšÜ_hash
;

2163 
	mhash_v”siÚ
;

2164 
u32
 *
	m£ed
;

2169 
	#EXT4_HTREE_EOF_32BIT
 ((1UL << (32 - 1)è- 1)

	)

2170 
	#EXT4_HTREE_EOF_64BIT
 ((1ULL << (64 - 1)è- 1)

	)

2176 
	#HASH_NB_ALWAYS
 1

	)

2178 
	sext4_f’ame
 {

2179 cÚ¡ 
q¡r
 *
	mu¤_âame
;

2180 
fsüy±_¡r
 
	mdisk_Çme
;

2181 
dx_hash_šfo
 
	mhšfo
;

2182 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


2183 
fsüy±_¡r
 
	müy±o_buf
;

2187 
	#âame_Çme
(
p
è(Õ)->
disk_Çme
.
Çme
)

	)

2188 
	#âame_Ën
(
p
è(Õ)->
disk_Çme
.
Ën
)

	)

2193 
	sext4_oc


2195 
bufãr_h—d
 *
	mbh
;

2196 
	moff£t
;

2197 
ext4_group_t
 
	mblock_group
;

2200 
šlše
 
ext4_šode
 *
	$ext4_¿w_šode
(
ext4_oc
 *
oc
)

2202  (
ext4_šode
 *è(
oc
->
bh
->
b_d©a
 + iloc->
off£t
);

2203 
	}
}

2205 
šlše
 
boŞ
 
	$ext4_is_quÙa_fe
(
šode
 *inode)

2207  
	`IS_NOQUOTA
(
šode
) &&

2208 !(
	`EXT4_I
(
šode
)->
i_æags
 & 
EXT4_EA_INODE_FL
);

2209 
	}
}

2216 
	sdœ_´iv©e_šfo
 {

2217 
rb_roÙ
 
	mroÙ
;

2218 
rb_node
 *
	mcu¼_node
;

2219 
âame
 *
	mexŒa_âame
;

2220 
loff_t
 
	mÏ¡_pos
;

2221 
__u32
 
	mcu¼_hash
;

2222 
__u32
 
	mcu¼_mšÜ_hash
;

2223 
__u32
 
	mÃxt_hash
;

2227 
šlše
 
ext4_fsblk_t


2228 
	$ext4_group_fœ¡_block_no
(
su³r_block
 *
sb
, 
ext4_group_t
 
group_no
)

2230  
group_no
 * (
ext4_fsblk_t
)
	`EXT4_BLOCKS_PER_GROUP
(
sb
) +

2231 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_d©a_block
);

2232 
	}
}

2237 
	#ERR_BAD_DX_DIR
 (-(
MAX_ERRNO
 - 1))

	)

2240 
	#EXT4_HTREE_LEVEL_COMPAT
 2

	)

2241 
	#EXT4_HTREE_LEVEL
 3

	)

2243 
šlše
 
	$ext4_dœ_hŒ“_Ëv–
(
su³r_block
 *
sb
)

2245  
	`ext4_has_ã©u»_Ïrgedœ
(
sb
) ?

2246 
EXT4_HTREE_LEVEL
 : 
EXT4_HTREE_LEVEL_COMPAT
;

2247 
	}
}

2252 
	#EXT4_DEF_LI_WAIT_MULT
 10

	)

2253 
	#EXT4_DEF_LI_MAX_START_DELAY
 5

	)

2254 
	#EXT4_LAZYINIT_QUIT
 0x0001

	)

2255 
	#EXT4_LAZYINIT_RUNNING
 0x0002

	)

2260 
	sext4_Ïzy_š™
 {

2261 
	mli_¡©e
;

2262 
li¡_h—d
 
	mli_»que¡_li¡
;

2263 
mu‹x
 
	mli_li¡_mtx
;

2266 
	sext4_li_»que¡
 {

2267 
su³r_block
 *
	mÌ_su³r
;

2268 
ext4_sb_šfo
 *
	mÌ_sbi
;

2269 
ext4_group_t
 
	mÌ_Ãxt_group
;

2270 
li¡_h—d
 
	mÌ_»que¡
;

2271 
	mÌ_Ãxt_sched
;

2272 
	mÌ_timeout
;

2275 
	sext4_ã©u»s
 {

2276 
kobjeù
 
	mf_kobj
;

2277 
com¶‘iÚ
 
	mf_kobj_uÄegi¡”
;

2287 
	#EXT4_MMP_MAGIC
 0x004D4D50U

	)

2288 
	#EXT4_MMP_SEQ_CLEAN
 0xFF4D4D50U

	)

2289 
	#EXT4_MMP_SEQ_FSCK
 0xE24D4D50U

	)

2290 
	#EXT4_MMP_SEQ_MAX
 0xE24D4D4FU

	)

2292 
	smmp_¡ruù
 {

2293 
__Ë32
 
	mmmp_magic
;

2294 
__Ë32
 
	mmmp_£q
;

2300 
__Ë64
 
	mmmp_time
;

2301 
	mmmp_nod’ame
[64];

2302 
	mmmp_bdevÇme
[32];

2309 
__Ë16
 
	mmmp_check_š‹rv®
;

2311 
__Ë16
 
	mmmp_·d1
;

2312 
__Ë32
 
	mmmp_·d2
[226];

2313 
__Ë32
 
	mmmp_checksum
;

2317 
	smmpd_d©a
 {

2318 
bufãr_h—d
 *
	mbh
;

2319 
su³r_block
 *
	msb
;

2330 
	#EXT4_MMP_CHECK_MULT
 2UL

	)

2335 
	#EXT4_MMP_MIN_CHECK_INTERVAL
 5UL

	)

2340 
	#EXT4_MMP_MAX_CHECK_INTERVAL
 300UL

	)

2350 
	#NORET_TYPE


	)

2351 
	#ATTRIB_NORET
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

2352 
	#NORET_AND
 
nÜ‘uº
,

	)

2355 
ext4_couÁ_ä“
(*
b™m­
, 
numch¬s
);

2356 
ext4_šode_b™m­_csum_£t
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2357 
ext4_group_desc
 *
gdp
,

2358 
bufãr_h—d
 *
bh
, 
sz
);

2359 
ext4_šode_b™m­_csum_v”ify
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2360 
ext4_group_desc
 *
gdp
,

2361 
bufãr_h—d
 *
bh
, 
sz
);

2362 
ext4_block_b™m­_csum_£t
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2363 
ext4_group_desc
 *
gdp
,

2364 
bufãr_h—d
 *
bh
);

2365 
ext4_block_b™m­_csum_v”ify
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2366 
ext4_group_desc
 *
gdp
,

2367 
bufãr_h—d
 *
bh
);

2370 
ext4_g‘_group_no_ªd_off£t
(
su³r_block
 *
sb
,

2371 
ext4_fsblk_t
 
blockÄ
,

2372 
ext4_group_t
 *
blockg½p
,

2373 
ext4_g½blk_t
 *
off£
);

2374 
ext4_group_t
 
ext4_g‘_group_numb”
(
su³r_block
 *
sb
,

2375 
ext4_fsblk_t
 
block
);

2377 
ext4_block_group
(
su³r_block
 *
sb
,

2378 
ext4_fsblk_t
 
blockÄ
);

2379 
ext4_g½blk_t
 
ext4_block_group_off£t
(
su³r_block
 *
sb
,

2380 
ext4_fsblk_t
 
blockÄ
);

2381 
ext4_bg_has_su³r
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
);

2382 
ext4_bg_num_gdb
(
su³r_block
 *
sb
,

2383 
ext4_group_t
 
group
);

2384 
ext4_fsblk_t
 
ext4_Ãw_m‘a_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2385 
ext4_fsblk_t
 
gßl
,

2386 
æags
,

2387 *
couÁ
,

2388 *
”½
);

2389 
ext4_şaim_ä“_şu¡”s
(
ext4_sb_šfo
 *
sbi
,

2390 
s64
 
nşu¡”s
, 
æags
);

2391 
ext4_fsblk_t
 
ext4_couÁ_ä“_şu¡”s
(
su³r_block
 *);

2392 
ext4_check_blocks_b™m­
(
su³r_block
 *);

2393 
ext4_group_desc
 * 
ext4_g‘_group_desc
(
su³r_block
 * 
sb
,

2394 
ext4_group_t
 
block_group
,

2395 
bufãr_h—d
 ** 
bh
);

2396 
ext4_should_»Œy_®loc
(
su³r_block
 *
sb
, *
»Œ›s
);

2398 
bufãr_h—d
 *
ext4_»ad_block_b™m­_nowa™
(
su³r_block
 *
sb
,

2399 
ext4_group_t
 
block_group
);

2400 
ext4_wa™_block_b™m­
(
su³r_block
 *
sb
,

2401 
ext4_group_t
 
block_group
,

2402 
bufãr_h—d
 *
bh
);

2403 
bufãr_h—d
 *
ext4_»ad_block_b™m­
(
su³r_block
 *
sb
,

2404 
ext4_group_t
 
block_group
);

2405 
ext4_ä“_şu¡”s_aá”_š™
(
su³r_block
 *
sb
,

2406 
ext4_group_t
 
block_group
,

2407 
ext4_group_desc
 *
gdp
);

2408 
ext4_fsblk_t
 
ext4_šode_to_gßl_block
(
šode
 *);

2410 
šlše
 
boŞ
 
	$ext4_’üy±ed_šode
(
šode
 *inode)

2412  
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_ENCRYPT
);

2413 
	}
}

2415 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


2416 
šlše
 
	$ext4_âame_£tup_f’ame
(
šode
 *
dœ
,

2417 cÚ¡ 
q¡r
 *
šame
,

2418 
lookup
, 
ext4_f’ame
 *
âame
)

2420 
fsüy±_Çme
 
Çme
;

2421 
”r
;

2423 
	`mem£t
(
âame
, 0, (
ext4_f’ame
));

2425 
”r
 = 
	`fsüy±_£tup_f’ame
(
dœ
, 
šame
, 
lookup
, &
Çme
);

2427 
âame
->
u¤_âame
 = 
Çme
.usr_fname;

2428 
âame
->
disk_Çme
 = 
Çme
.disk_name;

2429 
âame
->
hšfo
.
hash
 = 
Çme
.hash;

2430 
âame
->
hšfo
.
mšÜ_hash
 = 
Çme
.minor_hash;

2431 
âame
->
üy±o_buf
 = 
Çme
.crypto_buf;

2432  
”r
;

2433 
	}
}

2435 
šlše
 
	$ext4_âame_ä“_f’ame
(
ext4_f’ame
 *
âame
)

2437 
fsüy±_Çme
 
Çme
;

2439 
Çme
.
üy±o_buf
 = 
âame
->crypto_buf;

2440 
	`fsüy±_ä“_f’ame
(&
Çme
);

2442 
âame
->
üy±o_buf
.
Çme
 = 
NULL
;

2443 
âame
->
u¤_âame
 = 
NULL
;

2444 
âame
->
disk_Çme
.
Çme
 = 
NULL
;

2445 
	}
}

2447 
šlše
 
	$ext4_âame_£tup_f’ame
(
šode
 *
dœ
,

2448 cÚ¡ 
q¡r
 *
šame
,

2449 
lookup
, 
ext4_f’ame
 *
âame
)

2451 
âame
->
u¤_âame
 = 
šame
;

2452 
âame
->
disk_Çme
.
Çme
 = (*è
šame
->name;

2453 
âame
->
disk_Çme
.
Ën
 = 
šame
->len;

2455 
	}
}

2456 
šlše
 
	$ext4_âame_ä“_f’ame
(
ext4_f’ame
 *
âame
è{ 
	}
}

2461 
__ext4_check_dœ_’Œy
(cÚ¡ *, , 
šode
 *,

2462 
fe
 *,

2463 
ext4_dœ_’Œy_2
 *,

2464 
bufãr_h—d
 *, *, ,

2466 
	#ext4_check_dœ_’Œy
(
dœ
, 
fp
, 
de
, 
bh
, 
buf
, 
size
, 
off£t
) \

2467 
	`uÆik–y
(
	`__ext4_check_dœ_’Œy
(
__func__
, 
__LINE__
, (
dœ
), (
fp
), \

2468 (
de
), (
bh
), (
buf
), (
size
), (
off£t
)))

	)

2469 
ext4_hŒ“_¡Üe_dœ’t
(
fe
 *
dœ_fe
, 
__u32
 
hash
,

2470 
__u32
 
mšÜ_hash
,

2471 
ext4_dœ_’Œy_2
 *
dœ’t
,

2472 
fsüy±_¡r
 *
’t_Çme
);

2473 
ext4_hŒ“_ä“_dœ_šfo
(
dœ_´iv©e_šfo
 *
p
);

2474 
ext4_fšd_de¡_de
(
šode
 *
dœ
, inode *inode,

2475 
bufãr_h—d
 *
bh
,

2476 *
buf
, 
buf_size
,

2477 
ext4_f’ame
 *
âame
,

2478 
ext4_dœ_’Œy_2
 **
de¡_de
);

2479 
ext4_š£¹_d’Œy
(
šode
 *inode,

2480 
ext4_dœ_’Œy_2
 *
de
,

2481 
buf_size
,

2482 
ext4_f’ame
 *
âame
);

2483 
šlše
 
	$ext4_upd©e_dx_æag
(
šode
 *inode)

2485 ià(!
	`ext4_has_ã©u»_dœ_šdex
(
šode
->
i_sb
))

2486 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_INDEX
);

2487 
	}
}

2488 cÚ¡ 
	gext4_f‘y³_bË
[] = {

2489 
DT_UNKNOWN
, 
DT_REG
, 
DT_DIR
, 
DT_CHR
, 
DT_BLK
, 
DT_FIFO
, 
DT_SOCK
, 
DT_LNK


2492 
šlše
 
	$g‘_dty³
(
su³r_block
 *
sb
, 
f‘y³
)

2494 ià(!
	`ext4_has_ã©u»_f‘y³
(
sb
è|| 
f‘y³
 >ğ
EXT4_FT_MAX
)

2495  
DT_UNKNOWN
;

2497  
ext4_f‘y³_bË
[
f‘y³
];

2498 
	}
}

2499 
ext4_check_®l_de
(
šode
 *
dœ
, 
bufãr_h—d
 *
bh
,

2500 *
buf
, 
buf_size
);

2503 
ext4_sync_fe
(
fe
 *, 
loff_t
,†off_t, );

2504 
ext4_sync_fe_İt
(
fe
 *, 
loff_t
,†off_t, );

2507 
ext4fs_dœhash
(cÚ¡ *
Çme
, 
Ën
, 

2508 
dx_hash_šfo
 *
hšfo
);

2511 
ext4_m¬k_šode_u£d
(
su³r_block
 *
sb
, 
šo
);

2512 
šode
 *
__ext4_Ãw_šode
(
hªdË_t
 *, šod*, 
umode_t
,

2513 cÚ¡ 
q¡r
 *q¡r, 
__u32
 
gßl
,

2514 
uid_t
 *
owÃr
, 
__u32
 
i_æags
,

2515 
hªdË_ty³
, 
lše_no
,

2516 
nblocks
);

2518 
	#ext4_Ãw_šode
(
hªdË
, 
dœ
, 
mode
, 
q¡r
, 
gßl
, 
owÃr
, 
i_æags
) \

2519 
	`__ext4_Ãw_šode
((
hªdË
), (
dœ
), (
mode
), (
q¡r
), (
gßl
), (
owÃr
), \

2520 
i_æags
, 0, 0, 0)

	)

2521 
	#ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
mode
, 
q¡r
, 
gßl
, 
owÃr
, \

2522 
ty³
, 
nblocks
) \

2523 
	`__ext4_Ãw_šode
(
NULL
, (
dœ
), (
mode
), (
q¡r
), (
gßl
), (
owÃr
), \

2524 0, (
ty³
), 
__LINE__
, (
nblocks
))

	)

2527 
ext4_ä“_šode
(
hªdË_t
 *, 
šode
 *);

2528 
šode
 * 
ext4_Üphª_g‘
(
su³r_block
 *, );

2529 
ext4_couÁ_ä“_šodes
(
su³r_block
 *);

2530 
ext4_couÁ_dœs
(
su³r_block
 *);

2531 
ext4_check_šodes_b™m­
(
su³r_block
 *);

2532 
ext4_m¬k_b™m­_’d
(
¡¬t_b™
, 
’d_b™
, *
b™m­
);

2533 
ext4_š™_šode_bË
(
su³r_block
 *
sb
,

2534 
ext4_group_t
 
group
, 
b¬r›r
);

2535 
ext4_’d_b™m­_»ad
(
bufãr_h—d
 *
bh
, 
u±od©e
);

2538 cÚ¡ 
fe_İ”©iÚs
 
ext4_£q_mb_groups_fİs
;

2539 
ext4_mb_¡©s
;

2540 
ext4_mb_max_to_sÿn
;

2541 
ext4_mb_š™
(
su³r_block
 *);

2542 
ext4_mb_»Ëa£
(
su³r_block
 *);

2543 
ext4_fsblk_t
 
ext4_mb_Ãw_blocks
(
hªdË_t
 *,

2544 
ext4_®loÿtiÚ_»que¡
 *, *);

2545 
ext4_mb_»£rve_blocks
(
su³r_block
 *, );

2546 
ext4_disÿrd_´—ÎoÿtiÚs
(
šode
 *);

2547 
__š™
 
ext4_š™_mb®loc
();

2548 
ext4_ex™_mb®loc
();

2549 
ext4_ä“_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2550 
bufãr_h—d
 *
bh
, 
ext4_fsblk_t
 
block
,

2551 
couÁ
, 
æags
);

2552 
ext4_mb_®loc_groupšfo
(
su³r_block
 *
sb
,

2553 
ext4_group_t
 
ngroups
);

2554 
ext4_mb_add_groupšfo
(
su³r_block
 *
sb
,

2555 
ext4_group_t
 
i
, 
ext4_group_desc
 *
desc
);

2556 
ext4_group_add_blocks
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

2557 
ext4_fsblk_t
 
block
, 
couÁ
);

2558 
ext4_Œim_fs
(
su³r_block
 *, 
f¡rim_¿nge
 *);

2559 
ext4_´oûss_ä“d_d©a
(
su³r_block
 *
sb
, 
tid_t
 
comm™_tid
);

2562 
ext4_šode_csum_£t
(
šode
 *šode, 
ext4_šode
 *
¿w
,

2563 
ext4_šode_šfo
 *
ei
);

2564 
ext4_šode_is_ç¡_symlšk
(
šode
 *inode);

2565 
bufãr_h—d
 *
ext4_g‘blk
(
hªdË_t
 *, 
šode
 *, 
ext4_lblk_t
, );

2566 
bufãr_h—d
 *
ext4_b»ad
(
hªdË_t
 *, 
šode
 *, 
ext4_lblk_t
, );

2567 
ext4_b»ad_b©ch
(
šode
 *šode, 
ext4_lblk_t
 
block
, 
bh_couÁ
,

2568 
boŞ
 
wa™
, 
bufãr_h—d
 **
bhs
);

2569 
ext4_g‘_block_unwr™‹n
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

2570 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
);

2571 
ext4_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

2572 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
);

2573 
ext4_dio_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

2574 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
);

2575 
ext4_da_g‘_block_´•
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

2576 
bufãr_h—d
 *
bh
, 
ü—‹
);

2577 
ext4_w®k_·ge_bufãrs
(
hªdË_t
 *
hªdË
,

2578 
bufãr_h—d
 *
h—d
,

2579 
äom
,

2580 
to
,

2581 *
·¹Ÿl
,

2582 (*
â
)(
hªdË_t
 *
hªdË
,

2583 
bufãr_h—d
 *
bh
));

2584 
	`do_jouº®_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
,

2585 
bufãr_h—d
 *
bh
);

2586 
	#FALL_BACK_TO_NONDELALLOC
 1

	)

2587 
	#CONVERT_INLINE_DATA
 2

	)

2589 
šode
 *
	`ext4_ig‘
(
su³r_block
 *, );

2590 
šode
 *
	`ext4_ig‘_nÜm®
(
su³r_block
 *, );

2591 
	`ext4_wr™e_šode
(
šode
 *, 
wr™eback_cÚŒŞ
 *);

2592 
	`ext4_£‰r
(
d’Œy
 *, 
Ÿ‰r
 *);

2593 
	`ext4_g‘©Œ
(cÚ¡ 
·th
 *, 
k¡©
 *, 
u32
, );

2594 
	`ext4_eviù_šode
(
šode
 *);

2595 
	`ext4_ş—r_šode
(
šode
 *);

2596 
	`ext4_fe_g‘©Œ
(cÚ¡ 
·th
 *, 
k¡©
 *, 
u32
, );

2597 
	`ext4_sync_šode
(
hªdË_t
 *, 
šode
 *);

2598 
	`ext4_dœty_šode
(
šode
 *, );

2599 
	`ext4_chªge_šode_jouº®_æag
(
šode
 *, );

2600 
	`ext4_g‘_šode_loc
(
šode
 *, 
ext4_oc
 *);

2601 
	`ext4_g‘_fc_šode_loc
(
su³r_block
 *
sb
, 
šo
,

2602 
ext4_oc
 *
oc
);

2603 
	`ext4_šode_©ch_jšode
(
šode
 *inode);

2604 
	`ext4_ÿn_Œunÿ‹
(
šode
 *inode);

2605 
	`ext4_Œunÿ‹
(
šode
 *);

2606 
	`ext4_punch_hŞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
);

2607 
	`ext4_m‘a_punch_hŞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
, 
hªdË_t
 *
hªdË
);

2608 
	`ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË_t
 *, 
šode
 *, 
nblocks
);

2609 
	`ext4_£t_šode_æags
(
šode
 *);

2610 
	`ext4_®loc_da_blocks
(
šode
 *inode);

2611 
	`ext4_£t_aİs
(
šode
 *inode);

2612 
	`ext4_wr™•age_Œªs_blocks
(
šode
 *);

2613 
	`ext4_chunk_Œªs_blocks
(
šode
 *, 
Äblocks
);

2614 
	`ext4_z”o_·¹Ÿl_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2615 
loff_t
 
l¡¬t
,†off_ˆ
Ënd
);

2616 
	`ext4_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
);

2617 
	`ext4_fem­_çuÉ
(
vm_çuÉ
 *
vmf
);

2618 
qsize_t
 *
	`ext4_g‘_»£rved_¥aû
(
šode
 *inode);

2619 
	`ext4_g‘_´ojid
(
šode
 *šode, 
k´ojid_t
 *
´ojid
);

2620 
	`ext4_da_upd©e_»£rve_¥aû
(
šode
 *inode,

2621 
u£d
, 
quÙa_şaim
);

2622 
	`ext4_issue_z”oout
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

2623 
ext4_fsblk_t
 
pblk
, 
ext4_lblk_t
 
Ën
);

2624 
	`ext4_g‘_Ãxt_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

2625 
m­_Ën
,

2626 
ex‹Á_¡©us
 *
»suÉ
);

2629 
	`ext4_šd_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2630 
ext4_m­_blocks
 *
m­
, 
æags
);

2631 
	`ext4_šd_ÿlc_m‘ad©a_amouÁ
(
šode
 *šode, 
£ùÜ_t
 
lblock
);

2632 
	`ext4_šd_Œªs_blocks
(
šode
 *šode, 
Äblocks
);

2633 
	`ext4_šd_Œunÿ‹
(
hªdË_t
 *, 
šode
 *inode);

2634 
	`ext4_šd_»move_¥aû
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2635 
ext4_lblk_t
 
¡¬t
,ƒxt4_lblk_ˆ
’d
);

2638 
	`ext4_ioùl
(
fe
 *, , );

2639 
	`ext4_com·t_ioùl
(
fe
 *, , );

2640 
	`ext4_»£t_šode_£ed
(
šode
 *inode);

2643 
	`ext4_ext_mig¿‹
(
šode
 *);

2644 
	`ext4_šd_mig¿‹
(
šode
 *inode);

2647 
	`ext4_š™_Ãw_dœ
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

2648 
šode
 *inode);

2649 
	`ext4_dœ’t_csum_v”ify
(
šode
 *inode,

2650 
ext4_dœ_’Œy
 *
dœ’t
);

2651 
	`ext4_Üphª_add
(
hªdË_t
 *, 
šode
 *);

2652 
	`ext4_Üphª_d–
(
hªdË_t
 *, 
šode
 *);

2653 
	`ext4_hŒ“_fl_Œ“
(
fe
 *
dœ_fe
, 
__u32
 
¡¬t_hash
,

2654 
__u32
 
¡¬t_mšÜ_hash
, __u32 *
Ãxt_hash
);

2655 
	`ext4_£¬ch_dœ
(
bufãr_h—d
 *
bh
,

2656 *
£¬ch_buf
,

2657 
buf_size
,

2658 
šode
 *
dœ
,

2659 
ext4_f’ame
 *
âame
,

2660 
off£t
,

2661 
ext4_dœ_’Œy_2
 **
»s_dœ
);

2662 
	`ext4_g’”ic_d–‘e_’Œy
(
hªdË_t
 *
hªdË
,

2663 
šode
 *
dœ
,

2664 
ext4_dœ_’Œy_2
 *
de_d–
,

2665 
bufãr_h—d
 *
bh
,

2666 *
’Œy_buf
,

2667 
buf_size
,

2668 
csum_size
);

2669 
boŞ
 
	`ext4_em±y_dœ
(
šode
 *inode);

2672 
	`ext4_group_add
(
su³r_block
 *
sb
,

2673 
ext4_Ãw_group_d©a
 *
šput
);

2674 
	`ext4_group_ex‹nd
(
su³r_block
 *
sb
,

2675 
ext4_su³r_block
 *
es
,

2676 
ext4_fsblk_t
 
n_blocks_couÁ
);

2677 
	`ext4_»size_fs
(
su³r_block
 *
sb
, 
ext4_fsblk_t
 
n_blocks_couÁ
);

2680 
	`ext4_fc_async_comm™_šode
(
jouº®_t
 *
jouº®
, 
tid_t
 
comm™_tid
,

2681 
šode
 *inode);

2682 
	`ext4_£q_İtiÚs_show
(
£q_fe
 *
£q
, *
off£t
);

2683 
	`ext4_ÿlcuÏ‹_ov”h—d
(
su³r_block
 *
sb
);

2684 
	`ext4_su³rblock_csum_£t
(
su³r_block
 *
sb
);

2685 *
	`ext4_kvm®loc
(
size_t
 
size
, 
gå_t
 
æags
);

2686 *
	`ext4_kvz®loc
(
size_t
 
size
, 
gå_t
 
æags
);

2687 
	`ext4_®loc_æex_bg_¬¿y
(
su³r_block
 *
sb
,

2688 
ext4_group_t
 
ngroup
);

2689 cÚ¡ *
	`ext4_decode_”rÜ
(
su³r_block
 *
sb
, 
”ºo
,

2690 
nbuf
[16]);

2692 
	$__´štf
(4, 5)

2693 
	`__ext4_”rÜ
(
su³r_block
 *, const *, ,

2695 
	$__´štf
(5, 6)

2696 
	`__ext4_”rÜ_šode
(
šode
 *, cÚ¡ *, , 
ext4_fsblk_t
,

2698 
	$__´štf
(5, 6)

2699 
	`__ext4_”rÜ_fe
(
fe
 *, cÚ¡ *, , 
ext4_fsblk_t
,

2701 
	`__ext4_¡d_”rÜ
(
su³r_block
 *, const *,

2703 
	$__´štf
(4, 5)

2704 
	`__ext4_abÜt
(
su³r_block
 *, const *, ,

2706 
	$__´štf
(4, 5)

2707 
	`__ext4_w¬nšg
(
su³r_block
 *, const *, ,

2709 
	$__´štf
(4, 5)

2710 
	`__ext4_w¬nšg_šode
(cÚ¡ 
šode
 *šode, cÚ¡ *
funùiÚ
,

2711 
lše
, cÚ¡ *
fmt
, ...);

2712 
	$__´štf
(3, 4)

2713 
	`__ext4_msg
(
su³r_block
 *, const *, const *, ...);

2714 
	`__dump_mmp_msg
(
su³r_block
 *, 
mmp_¡ruù
 *
mmp
,

2716 
	$__´štf
(7, 8)

2717 
	`__ext4_g½_locked_”rÜ
(const *, ,

2718 
su³r_block
 *, 
ext4_group_t
,

2719 , 
ext4_fsblk_t
,

2722 
	#EXT4_ERROR_INODE
(
šode
, 
fmt
, 
a
...) \

2723 
	`ext4_”rÜ_šode
((
šode
), 
__func__
, 
__LINE__
, 0, (
fmt
), ## 
a
)

	)

2725 
	#EXT4_ERROR_INODE_BLOCK
(
šode
, 
block
, 
fmt
, 
a
...) \

2726 
	`ext4_”rÜ_šode
((
šode
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2728 
	#EXT4_ERROR_FILE
(
fe
, 
block
, 
fmt
, 
a
...) \

2729 
	`ext4_”rÜ_fe
((
fe
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2731 #ifdeà
CONFIG_PRINTK


2733 
	#ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
, 
fmt
, ...) \

2734 
	`__ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2735 
	#ext4_”rÜ_fe
(
fe
, 
func
, 
lše
, 
block
, 
fmt
, ...) \

2736 
	`__ext4_”rÜ_fe
(
fe
, 
func
, 
lše
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2737 
	#ext4_”rÜ
(
sb
, 
fmt
, ...) \

2738 
	`__ext4_”rÜ
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2739 
	#ext4_abÜt
(
sb
, 
fmt
, ...) \

2740 
	`__ext4_abÜt
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2741 
	#ext4_w¬nšg
(
sb
, 
fmt
, ...) \

2742 
	`__ext4_w¬nšg
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2743 
	#ext4_w¬nšg_šode
(
šode
, 
fmt
, ...) \

2744 
	`__ext4_w¬nšg_šode
(
šode
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2745 
	#ext4_msg
(
sb
, 
Ëv–
, 
fmt
, ...) \

2746 
	`__ext4_msg
(
sb
, 
Ëv–
, 
fmt
, ##
__VA_ARGS__
)

	)

2747 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2748 
	`__dump_mmp_msg
(
sb
, 
mmp
, 
__func__
, 
__LINE__
, 
msg
)

	)

2749 
	#ext4_g½_locked_”rÜ
(
sb
, 
g½
, 
šo
, 
block
, 
fmt
, ...) \

2750 
	`__ext4_g½_locked_”rÜ
(
__func__
, 
__LINE__
, 
sb
, 
g½
, 
šo
, 
block
, \

2751 
fmt
, ##
__VA_ARGS__
)

	)

2755 
	#ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
, 
fmt
, ...) \

2757 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2758 
	`__ext4_”rÜ_šode
(
šode
, "", 0, 
block
, " "); \

2759 
	}
} 0)

	)

2760 
	#ext4_”rÜ_fe
(
fe
, 
func
, 
lše
, 
block
, 
fmt
, ...) \

2762 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2763 
	`__ext4_”rÜ_fe
(
fe
, "", 0, 
block
, " "); \

2764 } 0)

	)

2765 
	#ext4_”rÜ
(
sb
, 
fmt
, ...) \

2767 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2768 
	`__ext4_”rÜ
(
sb
, "", 0, " "); \

2769 } 0)

	)

2770 
	#ext4_abÜt
(
sb
, 
fmt
, ...) \

2772 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2773 
	`__ext4_abÜt
(
sb
, "", 0, " "); \

2774 } 0)

	)

2775 
	#ext4_w¬nšg
(
sb
, 
fmt
, ...) \

2777 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2778 
	`__ext4_w¬nšg
(
sb
, "", 0, " "); \

2779 } 0)

	)

2780 
	#ext4_w¬nšg_šode
(
šode
, 
fmt
, ...) \

2782 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2783 
	`__ext4_w¬nšg_šode
(
šode
, "", 0, " "); \

2784 } 0)

	)

2785 
	#ext4_msg
(
sb
, 
Ëv–
, 
fmt
, ...) \

2787 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2788 
	`__ext4_msg
(
sb
, "", " "); \

2789 } 0)

	)

2790 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2791 
	`__dump_mmp_msg
(
sb
, 
mmp
, "", 0, "")

	)

2792 
	#ext4_g½_locked_”rÜ
(
sb
, 
g½
, 
šo
, 
block
, 
fmt
, ...) \

2794 
	`no_´štk
(
fmt
, ##
__VA_ARGS__
); \

2795 
	`__ext4_g½_locked_”rÜ
("", 0, 
sb
, 
g½
, 
šo
, 
block
, " "); \

2796 } 0)

	)

2800 
ext4_upd©e_dyÇmic_»v
(
su³r_block
 *
sb
);

2801 
ext4_upd©e_com·t_ã©u»
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

2802 
__u32
 
com·t
);

2803 
ext4_upd©e_rocom·t_ã©u»
(
hªdË_t
 *
hªdË
,

2804 
su³r_block
 *
sb
, 
__u32
 
rocom·t
);

2805 
ext4_upd©e_šcom·t_ã©u»
(
hªdË_t
 *
hªdË
,

2806 
su³r_block
 *
sb
, 
__u32
 
šcom·t
);

2807 
ext4_fsblk_t
 
ext4_block_b™m­
(
su³r_block
 *
sb
,

2808 
ext4_group_desc
 *
bg
);

2809 
ext4_fsblk_t
 
ext4_šode_b™m­
(
su³r_block
 *
sb
,

2810 
ext4_group_desc
 *
bg
);

2811 
ext4_fsblk_t
 
ext4_šode_bË
(
su³r_block
 *
sb
,

2812 
ext4_group_desc
 *
bg
);

2813 
__u32
 
ext4_ä“_group_şu¡”s
(
su³r_block
 *
sb
,

2814 
ext4_group_desc
 *
bg
);

2815 
__u32
 
ext4_ä“_šodes_couÁ
(
su³r_block
 *
sb
,

2816 
ext4_group_desc
 *
bg
);

2817 
__u32
 
ext4_u£d_dœs_couÁ
(
su³r_block
 *
sb
,

2818 
ext4_group_desc
 *
bg
);

2819 
__u32
 
ext4_™abË_unu£d_couÁ
(
su³r_block
 *
sb
,

2820 
ext4_group_desc
 *
bg
);

2821 
ext4_block_b™m­_£t
(
su³r_block
 *
sb
,

2822 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
);

2823 
ext4_šode_b™m­_£t
(
su³r_block
 *
sb
,

2824 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
);

2825 
ext4_šode_bË_£t
(
su³r_block
 *
sb
,

2826 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
);

2827 
ext4_ä“_group_şu¡”s_£t
(
su³r_block
 *
sb
,

2828 
ext4_group_desc
 *
bg
,

2829 
__u32
 
couÁ
);

2830 
ext4_ä“_šodes_£t
(
su³r_block
 *
sb
,

2831 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
);

2832 
ext4_u£d_dœs_£t
(
su³r_block
 *
sb
,

2833 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
);

2834 
ext4_™abË_unu£d_£t
(
su³r_block
 *
sb
,

2835 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
);

2836 
ext4_group_desc_csum_v”ify
(
su³r_block
 *
sb
, 
__u32
 
group
,

2837 
ext4_group_desc
 *
gdp
);

2838 
ext4_group_desc_csum_£t
(
su³r_block
 *
sb
, 
__u32
 
group
,

2839 
ext4_group_desc
 *
gdp
);

2840 
ext4_»gi¡”_li_»que¡
(
su³r_block
 *
sb
,

2841 
ext4_group_t
 
fœ¡_nÙ_z”Ûd
);

2843 
šlše
 
	$ext4_has_m‘ad©a_csum
(
su³r_block
 *
sb
)

2845 
	`WARN_ON_ONCE
(
	`ext4_has_ã©u»_m‘ad©a_csum
(
sb
) &&

2846 !
	`EXT4_SB
(
sb
)->
s_chksum_driv”
);

2848  
	`ext4_has_ã©u»_m‘ad©a_csum
(
sb
) &&

2849 (
	`EXT4_SB
(
sb
)->
s_chksum_driv”
 !ğ
NULL
);

2850 
	}
}

2852 
šlše
 
	$ext4_has_group_desc_csum
(
su³r_block
 *
sb
)

2854  
	`ext4_has_ã©u»_gdt_csum
(
sb
è|| 
	`ext4_has_m‘ad©a_csum
(sb);

2855 
	}
}

2857 
šlše
 
ext4_fsblk_t
 
	$ext4_blocks_couÁ
(
ext4_su³r_block
 *
es
)

2859  ((
ext4_fsblk_t
)
	`Ë32_to_ıu
(
es
->
s_blocks_couÁ_hi
) << 32) |

2860 
	`Ë32_to_ıu
(
es
->
s_blocks_couÁ_lo
);

2861 
	}
}

2863 
šlše
 
ext4_fsblk_t
 
	$ext4_r_blocks_couÁ
(
ext4_su³r_block
 *
es
)

2865  ((
ext4_fsblk_t
)
	`Ë32_to_ıu
(
es
->
s_r_blocks_couÁ_hi
) << 32) |

2866 
	`Ë32_to_ıu
(
es
->
s_r_blocks_couÁ_lo
);

2867 
	}
}

2869 
šlše
 
ext4_fsblk_t
 
	$ext4_ä“_blocks_couÁ
(
ext4_su³r_block
 *
es
)

2871  ((
ext4_fsblk_t
)
	`Ë32_to_ıu
(
es
->
s_ä“_blocks_couÁ_hi
) << 32) |

2872 
	`Ë32_to_ıu
(
es
->
s_ä“_blocks_couÁ_lo
);

2873 
	}
}

2875 
šlše
 
	$ext4_blocks_couÁ_£t
(
ext4_su³r_block
 *
es
,

2876 
ext4_fsblk_t
 
blk
)

2878 
es
->
s_blocks_couÁ_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

2879 
es
->
s_blocks_couÁ_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

2880 
	}
}

2882 
šlše
 
	$ext4_ä“_blocks_couÁ_£t
(
ext4_su³r_block
 *
es
,

2883 
ext4_fsblk_t
 
blk
)

2885 
es
->
s_ä“_blocks_couÁ_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

2886 
es
->
s_ä“_blocks_couÁ_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

2887 
	}
}

2889 
šlše
 
	$ext4_r_blocks_couÁ_£t
(
ext4_su³r_block
 *
es
,

2890 
ext4_fsblk_t
 
blk
)

2892 
es
->
s_r_blocks_couÁ_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

2893 
es
->
s_r_blocks_couÁ_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

2894 
	}
}

2896 
šlše
 
loff_t
 
	$ext4_isize
(
su³r_block
 *
sb
,

2897 
ext4_šode
 *
¿w_šode
)

2899 ià(
	`ext4_has_ã©u»_Ïrgedœ
(
sb
) ||

2900 
	`S_ISREG
(
	`Ë16_to_ıu
(
¿w_šode
->
i_mode
)))

2901  ((
loff_t
)
	`Ë32_to_ıu
(
¿w_šode
->
i_size_high
) << 32) |

2902 
	`Ë32_to_ıu
(
¿w_šode
->
i_size_lo
);

2904  (
loff_t
è
	`Ë32_to_ıu
(
¿w_šode
->
i_size_lo
);

2905 
	}
}

2907 
šlše
 
	$ext4_isize_£t
(
ext4_šode
 *
¿w_šode
, 
loff_t
 
i_size
)

2909 
¿w_šode
->
i_size_lo
 = 
	`ıu_to_Ë32
(
i_size
);

2910 
¿w_šode
->
i_size_high
 = 
	`ıu_to_Ë32
(
i_size
 >> 32);

2911 
	}
}

2913 
šlše


2914 
ext4_group_šfo
 *
	$ext4_g‘_group_šfo
(
su³r_block
 *
sb
,

2915 
ext4_group_t
 
group
)

2917 
ext4_group_šfo
 ***
g½_šfo
;

2918 
šdexv
, 
šdexh
;

2919 
	`BUG_ON
(
group
 >ğ
	`EXT4_SB
(
sb
)->
s_groups_couÁ
);

2920 
g½_šfo
 = 
	`EXT4_SB
(
sb
)->
s_group_šfo
;

2921 
šdexv
 = 
group
 >> (
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
));

2922 
šdexh
 = 
group
 & ((
	`EXT4_DESC_PER_BLOCK
(
sb
)) - 1);

2923  
g½_šfo
[
šdexv
][
šdexh
];

2924 
	}
}

2931 
šlše
 
ext4_group_t
 
	$ext4_g‘_groups_couÁ
(
su³r_block
 *
sb
)

2933 
ext4_group_t
 
ngroups
 = 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;

2935 
	`smp_rmb
();

2936  
ngroups
;

2937 
	}
}

2939 
šlše
 
ext4_group_t
 
	$ext4_æex_group
(
ext4_sb_šfo
 *
sbi
,

2940 
ext4_group_t
 
block_group
)

2942  
block_group
 >> 
sbi
->
s_log_groups_³r_æex
;

2943 
	}
}

2945 
šlše
 
	$ext4_æex_bg_size
(
ext4_sb_šfo
 *
sbi
)

2947  1 << 
sbi
->
s_log_groups_³r_æex
;

2948 
	}
}

2950 
	#ext4_¡d_”rÜ
(
sb
, 
”ºo
) \

2952 ià((
”ºo
)) \

2953 
	`__ext4_¡d_”rÜ
((
sb
), 
__func__
, 
__LINE__
, (
”ºo
)); \

2954 } 0)

	)

2956 #ifdeà
CONFIG_SMP


2961 
	#EXT4_FREECLUSTERS_WATERMARK
 (4 * (
³rıu_couÁ”_b©ch
 * 
Ä_ıu_ids
))

	)

2963 
	#EXT4_FREECLUSTERS_WATERMARK
 0

	)

2967 
šlše
 
	$ext4_upd©e_i_disksize
(
šode
 *šode, 
loff_t
 
Ãwsize
)

2969 
	`WARN_ON_ONCE
(
	`S_ISREG
(
šode
->
i_mode
) &&

2970 !
	`šode_is_locked
(
šode
));

2971 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2972 ià(
Ãwsize
 > 
	`EXT4_I
(
šode
)->
i_disksize
)

2973 
	`EXT4_I
(
šode
)->
i_disksize
 = 
Ãwsize
;

2974 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2975 
	}
}

2978 
šlše
 
	$ext4_upd©e_šode_size
(
šode
 *šode, 
loff_t
 
Ãwsize
)

2980 
chªged
 = 0;

2982 ià(
Ãwsize
 > 
šode
->
i_size
) {

2983 
	`i_size_wr™e
(
šode
, 
Ãwsize
);

2984 
chªged
 = 1;

2986 ià(
Ãwsize
 > 
	`EXT4_I
(
šode
)->
i_disksize
) {

2987 
	`ext4_upd©e_i_disksize
(
šode
, 
Ãwsize
);

2988 
chªged
 |= 2;

2990  
chªged
;

2991 
	}
}

2993 
ext4_upd©e_disksize_befÜe_punch
(
šode
 *šode, 
loff_t
 
off£t
,

2994 
loff_t
 
Ën
);

2996 
	sext4_group_šfo
 {

2997 
	mbb_¡©e
;

2998 
rb_roÙ
 
	mbb_ä“_roÙ
;

2999 
ext4_g½blk_t
 
	mbb_fœ¡_ä“
;

3000 
ext4_g½blk_t
 
	mbb_ä“
;

3001 
ext4_g½blk_t
 
	mbb_äagm’ts
;

3002 
ext4_g½blk_t
 
	mbb_Ïrge¡_ä“_Üd”
;

3003 
li¡_h—d
 
	mbb_´—Îoc_li¡
;

3004 #ifdeà
DOUBLE_CHECK


3005 *
	mbb_b™m­
;

3007 
rw_£m­hÜe
 
	m®loc_£m
;

3008 
ext4_g½blk_t
 
	mbb_couÁ”s
[];

3014 
	#EXT4_GROUP_INFO_NEED_INIT_BIT
 0

	)

3015 
	#EXT4_GROUP_INFO_WAS_TRIMMED_BIT
 1

	)

3016 
	#EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
 2

	)

3017 
	#EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
 3

	)

3019 
	#EXT4_MB_GRP_NEED_INIT
(
g½
) \

3020 (
	`‹¡_b™
(
EXT4_GROUP_INFO_NEED_INIT_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3021 
	#EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
) \

3022 (
	`‹¡_b™
(
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3023 
	#EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
) \

3024 (
	`‹¡_b™
(
EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3026 
	#EXT4_MB_GRP_WAS_TRIMMED
(
g½
) \

3027 (
	`‹¡_b™
(
EXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3028 
	#EXT4_MB_GRP_SET_TRIMMED
(
g½
) \

3029 (
	`£t_b™
(
EXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3030 
	#EXT4_MB_GRP_CLEAR_TRIMMED
(
g½
) \

3031 (
	`ş—r_b™
(
EXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
g½
)->
bb_¡©e
)))

	)

3033 
	#EXT4_MAX_CONTENTION
 8

	)

3034 
	#EXT4_CONTENTION_THRESHOLD
 2

	)

3036 
šlše
 
¥šlock_t
 *
	$ext4_group_lock_±r
(
su³r_block
 *
sb
,

3037 
ext4_group_t
 
group
)

3039  
	`bgl_lock_±r
(
	`EXT4_SB
(
sb
)->
s_blockgroup_lock
, 
group
);

3040 
	}
}

3046 
šlše
 
	$ext4_fs_is_busy
(
ext4_sb_šfo
 *
sbi
)

3048  (
	`©omic_»ad
(&
sbi
->
s_lock_busy
è> 
EXT4_CONTENTION_THRESHOLD
);

3049 
	}
}

3051 
šlše
 
	$ext4_lock_group
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
)

3053 
¥šlock_t
 *
lock
 = 
	`ext4_group_lock_±r
(
sb
, 
group
);

3054 ià(
	`¥š_Œylock
(
lock
))

3059 
	`©omic_add_uÆess
(&
	`EXT4_SB
(
sb
)->
s_lock_busy
, -1, 0);

3065 
	`©omic_add_uÆess
(&
	`EXT4_SB
(
sb
)->
s_lock_busy
, 1,

3066 
EXT4_MAX_CONTENTION
);

3067 
	`¥š_lock
(
lock
);

3069 
	}
}

3071 
šlše
 
	$ext4_uÆock_group
(
su³r_block
 *
sb
,

3072 
ext4_group_t
 
group
)

3074 
	`¥š_uÆock
(
	`ext4_group_lock_±r
(
sb
, 
group
));

3075 
	}
}

3080 
	#ext4_check_šdœeù_block»f
(
šode
, 
bh
) \

3081 
	`ext4_check_block»f
(
__func__
, 
__LINE__
, 
šode
, \

3082 (
__Ë32
 *)(
bh
)->
b_d©a
, \

3083 
	`EXT4_ADDR_PER_BLOCK
((
šode
)->
i_sb
))

	)

3085 
	#ext4_šd_check_šode
(
šode
) \

3086 
	`ext4_check_block»f
(
__func__
, 
__LINE__
, 
šode
, \

3087 
	`EXT4_I
(
šode
)->
i_d©a
, \

3088 
EXT4_NDIR_BLOCKS
)

	)

3095 cÚ¡ 
fe_İ”©iÚs
 
ext4_dœ_İ”©iÚs
;

3098 cÚ¡ 
šode_İ”©iÚs
 
ext4_fe_šode_İ”©iÚs
;

3099 cÚ¡ 
fe_İ”©iÚs
 
ext4_fe_İ”©iÚs
;

3100 
loff_t
 
ext4_Î£ek
(
fe
 *fe,†off_ˆ
off£t
, 
Üigš
);

3103 
ext4_g‘_max_šlše_size
(
šode
 *inode);

3104 
ext4_fšd_šlše_d©a_nŞock
(
šode
 *inode);

3105 
ext4_š™_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3106 
Ën
);

3107 
ext4_de¡roy_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode);

3109 
ext4_»ad·ge_šlše
(
šode
 *šode, 
·ge
 *page);

3110 
ext4_Œy_to_wr™e_šlše_d©a
(
add»ss_¥aû
 *
m­pšg
,

3111 
šode
 *inode,

3112 
loff_t
 
pos
, 
Ën
,

3113 
æags
,

3114 
·ge
 **
·g•
);

3115 
ext4_wr™e_šlše_d©a_’d
(
šode
 *inode,

3116 
loff_t
 
pos
, 
Ën
,

3117 
cİ›d
,

3118 
·ge
 *page);

3119 
bufãr_h—d
 *

3120 
ext4_jouº®Ëd_wr™e_šlše_d©a
(
šode
 *inode,

3121 
Ën
,

3122 
·ge
 *page);

3123 
ext4_da_wr™e_šlše_d©a_begš
(
add»ss_¥aû
 *
m­pšg
,

3124 
šode
 *inode,

3125 
loff_t
 
pos
, 
Ën
,

3126 
æags
,

3127 
·ge
 **
·g•
,

3128 **
fsd©a
);

3129 
ext4_da_wr™e_šlše_d©a_’d
(
šode
 *šode, 
loff_t
 
pos
,

3130 
Ën
, 
cİ›d
,

3131 
·ge
 *page);

3132 
ext4_Œy_add_šlše_’Œy
(
hªdË_t
 *
hªdË
,

3133 
ext4_f’ame
 *
âame
,

3134 
šode
 *
dœ
, inode *inode);

3135 
ext4_Œy_ü—‹_šlše_dœ
(
hªdË_t
 *
hªdË
,

3136 
šode
 *
·»Á
,

3137 
šode
 *inode);

3138 
ext4_»ad_šlše_dœ
(
fe
 *
fp
,

3139 
dœ_cÚ‹xt
 *
ùx
,

3140 *
has_šlše_d©a
);

3141 
hŒ“_šlšedœ_to_Œ“
(
fe
 *
dœ_fe
,

3142 
šode
 *
dœ
, 
ext4_lblk_t
 
block
,

3143 
dx_hash_šfo
 *
hšfo
,

3144 
__u32
 
¡¬t_hash
, __u32 
¡¬t_mšÜ_hash
,

3145 *
has_šlše_d©a
);

3146 
bufãr_h—d
 *
ext4_fšd_šlše_’Œy
(
šode
 *
dœ
,

3147 
ext4_f’ame
 *
âame
,

3148 
ext4_dœ_’Œy_2
 **
»s_dœ
,

3149 *
has_šlše_d©a
);

3150 
ext4_d–‘e_šlše_’Œy
(
hªdË_t
 *
hªdË
,

3151 
šode
 *
dœ
,

3152 
ext4_dœ_’Œy_2
 *
de_d–
,

3153 
bufãr_h—d
 *
bh
,

3154 *
has_šlše_d©a
);

3155 
boŞ
 
em±y_šlše_dœ
(
šode
 *
dœ
, *
has_šlše_d©a
);

3156 
bufãr_h—d
 *
ext4_g‘_fœ¡_šlše_block
(
šode
 *inode,

3157 
ext4_dœ_’Œy_2
 **
·»Á_de
,

3158 *
»tv®
);

3159 
ext4_šlše_d©a_f›m­
(
šode
 *inode,

3160 
f›m­_ex‹Á_šfo
 *
f›šfo
,

3161 *
has_šlše
, 
__u64
 
¡¬t
, __u64 
Ën
);

3162 
ext4_Œy_to_eviù_šlše_d©a
(
hªdË_t
 *
hªdË
,

3163 
šode
 *inode,

3164 
Ãeded
);

3165 
ext4_šlše_d©a_Œunÿ‹
(
šode
 *šode, *
has_šlše
);

3167 
ext4_cÚv”t_šlše_d©a
(
šode
 *inode);

3169 
šlše
 
	$ext4_has_šlše_d©a
(
šode
 *inode)

3171  
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_INLINE_DATA
) &&

3172 
	`EXT4_I
(
šode
)->
i_šlše_off
;

3173 
	}
}

3176 cÚ¡ 
šode_İ”©iÚs
 
ext4_dœ_šode_İ”©iÚs
;

3177 cÚ¡ 
šode_İ”©iÚs
 
ext4_¥ecŸl_šode_İ”©iÚs
;

3178 
d’Œy
 *
ext4_g‘_·»Á
(d’Œy *
chd
);

3179 
ext4_dœ_’Œy_2
 *
ext4_š™_dÙ_dÙdÙ
(
šode
 *inode,

3180 
ext4_dœ_’Œy_2
 *
de
,

3181 
blocksize
, 
csum_size
,

3182 
·»Á_šo
, 
dÙdÙ_»®_Ën
);

3183 
š™Ÿlize_dœ’t_
(
ext4_dœ_’Œy_
 *
t
,

3184 
blocksize
);

3185 
ext4_hªdË_dœty_dœ’t_node
(
hªdË_t
 *
hªdË
,

3186 
šode
 *inode,

3187 
bufãr_h—d
 *
bh
);

3189 
__ext4_uÆšk
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
d_Çme
,

3190 
šode
 *inode);

3191 
__ext4_lšk
(
šode
 *
dœ
, inode *inode,

3192 
d’Œy
 *dentry);

3194 
	#S_SHIFT
 12

	)

3195 cÚ¡ 
	gext4_ty³_by_mode
[(
S_IFMT
 >> 
S_SHIFT
) + 1] = {

3196 [
S_IFREG
 >> 
S_SHIFT
] = 
EXT4_FT_REG_FILE
,

3197 [
S_IFDIR
 >> 
S_SHIFT
] = 
EXT4_FT_DIR
,

3198 [
S_IFCHR
 >> 
S_SHIFT
] = 
EXT4_FT_CHRDEV
,

3199 [
S_IFBLK
 >> 
S_SHIFT
] = 
EXT4_FT_BLKDEV
,

3200 [
S_IFIFO
 >> 
S_SHIFT
] = 
EXT4_FT_FIFO
,

3201 [
S_IFSOCK
 >> 
S_SHIFT
] = 
EXT4_FT_SOCK
,

3202 [
S_IFLNK
 >> 
S_SHIFT
] = 
EXT4_FT_SYMLINK
,

3205 
šlše
 
	$ext4_£t_de_ty³
(
su³r_block
 *
sb
,

3206 
ext4_dœ_’Œy_2
 *
de
,

3207 
umode_t
 
mode
) {

3208 ià(
	`ext4_has_ã©u»_f‘y³
(
sb
))

3209 
de
->
fe_ty³
 = 
ext4_ty³_by_mode
[(
mode
 & 
S_IFMT
)>>
S_SHIFT
];

3210 
	}
}

3213 
ext4_m·ge_»ad·ges
(
add»ss_¥aû
 *
m­pšg
,

3214 
li¡_h—d
 *
·ges
, 
·ge
 *page,

3215 
Ä_·ges
);

3218 cÚ¡ 
šode_İ”©iÚs
 
ext4_’üy±ed_symlšk_šode_İ”©iÚs
;

3219 cÚ¡ 
šode_İ”©iÚs
 
ext4_symlšk_šode_İ”©iÚs
;

3220 cÚ¡ 
šode_İ”©iÚs
 
ext4_ç¡_symlšk_šode_İ”©iÚs
;

3223 
ext4_»gi¡”_sysfs
(
su³r_block
 *
sb
);

3224 
ext4_uÄegi¡”_sysfs
(
su³r_block
 *
sb
);

3225 
__š™
 
ext4_š™_sysfs
();

3226 
ext4_ex™_sysfs
();

3229 
ext4_»Ëa£_sy¡em_zÚe
(
su³r_block
 *
sb
);

3230 
ext4_£tup_sy¡em_zÚe
(
su³r_block
 *
sb
);

3231 
__š™
 
ext4_š™_sy¡em_zÚe
();

3232 
ext4_ex™_sy¡em_zÚe
();

3233 
ext4_d©a_block_v®id
(
ext4_sb_šfo
 *
sbi
,

3234 
ext4_fsblk_t
 
¡¬t_blk
,

3235 
couÁ
);

3236 
ext4_check_block»f
(const *, ,

3237 
šode
 *, 
__Ë32
 *, );

3240 
	gext4_ext_·th
;

3241 
	gext4_ex‹Á
;

3247 
	#EXT_MAX_BLOCKS
 0xffffffff

	)

3249 
ext4_ext_Œ“_š™
(
hªdË_t
 *
hªdË
, 
šode
 *);

3250 
ext4_ext_wr™•age_Œªs_blocks
(
šode
 *, );

3251 
ext4_ext_šdex_Œªs_blocks
(
šode
 *šode, 
ex‹Ás
);

3252 
ext4_ext_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3253 
ext4_m­_blocks
 *
m­
, 
æags
);

3254 
ext4_ext_Œunÿ‹
(
hªdË_t
 *, 
šode
 *);

3255 
ext4_ext_»move_¥aû
(
šode
 *šode, 
ext4_lblk_t
 
¡¬t
,

3256 
ext4_lblk_t
 
’d
);

3257 
ext4_m‘a_ext_»move_¥aû
(
šode
 *šode, 
ext4_lblk_t
 
¡¬t
,

3258 
ext4_lblk_t
 
’d
, 
hªdË_t
 *
hªdË
);

3259 
ext4_ext_š™
(
su³r_block
 *);

3260 
ext4_ext_»Ëa£
(
su³r_block
 *);

3261 
ext4_çÎoÿ‹
(
fe
 *fe, 
mode
, 
loff_t
 
off£t
,

3262 
loff_t
 
Ën
);

3263 
ext4_çÎoÿ‹_fÜ_dr
(
hªdË_t
 *
hªdË
, 
fe
 *fe, 
mode
, 
loff_t
 
off£t
,

3264 
loff_t
 
Ën
);

3265 
ext4_cÚv”t_unwr™‹n_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3266 
loff_t
 
off£t
, 
ssize_t
 
Ën
);

3267 
ext4_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

3268 
ext4_m­_blocks
 *
m­
, 
æags
);

3269 
ext4_ext_ÿlc_m‘ad©a_amouÁ
(
šode
 *inode,

3270 
ext4_lblk_t
 
lblocks
);

3271 
ext4_ext_ÿlc_üed™s_fÜ_sšgË_ex‹Á
(
šode
 *inode,

3272 
num
,

3273 
ext4_ext_·th
 *
·th
);

3274 
ext4_ÿn_ex‹Ás_be_m”ged
(
šode
 *inode,

3275 
ext4_ex‹Á
 *
ex1
,

3276 
ext4_ex‹Á
 *
ex2
);

3277 
ext4_ext_š£¹_ex‹Á
(
hªdË_t
 *, 
šode
 *,

3278 
ext4_ext_·th
 **,

3279 
ext4_ex‹Á
 *, );

3280 
ext4_ext_·th
 *
ext4_fšd_ex‹Á
(
šode
 *, 
ext4_lblk_t
,

3281 
ext4_ext_·th
 **,

3282 
æags
);

3283 
ext4_ext_drİ_»fs
(
ext4_ext_·th
 *);

3284 
ext4_ext_check_šode
(
šode
 *inode);

3285 
ext4_fšd_d–®loc_¿nge
(
šode
 *inode,

3286 
ext4_lblk_t
 
lblk_¡¬t
,

3287 
ext4_lblk_t
 
lblk_’d
);

3288 
ext4_fšd_d–®loc_şu¡”
(
šode
 *šode, 
ext4_lblk_t
 
lblk
);

3289 
ext4_lblk_t
 
ext4_ext_Ãxt_®loÿ‹d_block
(
ext4_ext_·th
 *
·th
);

3290 
ext4_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

3291 
__u64
 
¡¬t
, __u64 
Ën
);

3292 
ext4_ext_´eÿche
(
šode
 *inode);

3293 
ext4_cŞÏp£_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
);

3294 
ext4_m‘a_cŞÏp£_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
, 
hªdË_t
 *
hªdË
);

3295 
ext4_š£¹_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
);

3296 
ext4_sw­_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *
šode1
,

3297 
šode
 *
šode2
, 
ext4_lblk_t
 
lblk1
,

3298 
ext4_lblk_t
 
lblk2
,ƒxt4_lblk_ˆ
couÁ
,

3299 
m¬k_unwr™‹n
,*
”r
);

3300 
ext4_m‘a_sw­_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *
šode1
,

3301 
šode
 *
šode2
, 
ext4_lblk_t
 
lblk1
,

3302 
ext4_lblk_t
 
lblk2
,ƒxt4_lblk_ˆ
couÁ
,

3303 *
”r
);

3306 
ext4_doubË_down_wr™e_d©a_£m
(
šode
 *
fœ¡
,

3307 
šode
 *
£cÚd
);

3308 
ext4_doubË_up_wr™e_d©a_£m
(
šode
 *
Üig_šode
,

3309 
šode
 *
dÚÜ_šode
);

3310 
ext4_move_ex‹Ás
(
fe
 *
o_fp
, f*
d_fp
,

3311 
__u64
 
¡¬t_Üig
, __u64 
¡¬t_dÚÜ
,

3312 
__u64
 
Ën
, __u64 *
moved_Ën
);

3313 
ext4_dyÇmic_»m­
(
fe
 *
fe1
, f*
fe2
,

3314 
loff_t
 
off£t1
,†off_ˆ
off£t2
,

3315 
loff_t
 
couÁ
);

3318 
__š™
 
ext4_š™_·geio
();

3319 
ext4_ex™_·geio
();

3320 
ext4_io_’d_t
 *
ext4_š™_io_’d
(
šode
 *šode, 
gå_t
 
æags
);

3321 
ext4_io_’d_t
 *
ext4_g‘_io_’d
Óxt4_io_’d_ˆ*
io_’d
);

3322 
ext4_put_io_’d
(
ext4_io_’d_t
 *
io_’d
);

3323 
ext4_put_io_’d_deãr
(
ext4_io_’d_t
 *
io_’d
);

3324 
ext4_io_subm™_š™
(
ext4_io_subm™
 *
io
,

3325 
wr™eback_cÚŒŞ
 *
wbc
);

3326 
ext4_’d_io_rsv_wÜk
(
wÜk_¡ruù
 *
wÜk
);

3327 
ext4_io_subm™
(ext4_io_subm™ *
io
);

3328 
ext4_bio_wr™e_·ge
(
ext4_io_subm™
 *
io
,

3329 
·ge
 *page,

3330 
Ën
,

3331 
wr™eback_cÚŒŞ
 *
wbc
,

3332 
boŞ
 
k“p_towr™e
);

3335 
ext4_muÉi_mouÁ_´Ùeù
(
su³r_block
 *, 
ext4_fsblk_t
);

3342 
	#BH_BITMAP_UPTODATE
 
BH_JBDPriv©eS¹


	)

3344 
šlše
 
	$b™m­_u±od©e
(
bufãr_h—d
 *
bh
)

3346  (
	`bufãr_u±od©e
(
bh
) &&

3347 
	`‹¡_b™
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_¡©e
));

3348 
	}
}

3349 
šlše
 
	$£t_b™m­_u±od©e
(
bufãr_h—d
 *
bh
)

3351 
	`£t_b™
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_¡©e
);

3352 
	}
}

3358 
šlše
 
	$ext4_šode_block_uÆocked_dio
(
šode
 *inode)

3360 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_DIOREAD_LOCK
);

3361 
	`smp_mb
();

3362 
	}
}

3363 
šlše
 
	$ext4_šode_»sume_uÆocked_dio
(
šode
 *inode)

3365 
	`smp_mb
();

3366 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_DIOREAD_LOCK
);

3367 
	}
}

3369 
	#š_¿nge
(
b
, 
fœ¡
, 
Ën
è((bè>ğ(fœ¡è&& (bè<ğ(fœ¡è+ (Ënè- 1)

	)

3372 
	#EXT4_WQ_HASH_SZ
 37

	)

3373 
	#ext4_iÛnd_wq
(
v
è(&
ext4__iÛnd_wq
[(()(v)) %\

3374 
EXT4_WQ_HASH_SZ
])

	)

3375 
wa™_queue_h—d_t
 
ext4__iÛnd_wq
[
EXT4_WQ_HASH_SZ
];

3377 
ext4_»size_begš
(
su³r_block
 *
sb
);

3378 
ext4_»size_’d
(
su³r_block
 *
sb
);

3380 
šlše
 
	$ext4_£t_io_unwr™‹n_æag
(
šode
 *inode,

3381 
ext4_io_’d
 *
io_’d
)

3383 ià(!(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
)) {

3384 
io_’d
->
æag
 |ğ
EXT4_IO_END_UNWRITTEN
;

3385 
	`©omic_šc
(&
	`EXT4_I
(
šode
)->
i_unwr™‹n
);

3387 
	}
}

3389 
šlše
 
	$ext4_ş—r_io_unwr™‹n_æag
(
ext4_io_’d_t
 *
io_’d
)

3391 
šode
 *šodğ
io_’d
->inode;

3393 ià(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
) {

3394 
io_’d
->
æag
 &ğ~
EXT4_IO_END_UNWRITTEN
;

3396 ià(
	`©omic_dec_ªd_‹¡
(&
	`EXT4_I
(
šode
)->
i_unwr™‹n
))

3397 
	`wake_up_®l
(
	`ext4_iÛnd_wq
(
šode
));

3399 
	}
}

3401 cÚ¡ 
iom­_İs
 
ext4_iom­_İs
;

3405 
	#EFSBADCRC
 
EBADMSG


	)

3406 
	#EFSCORRUPTED
 
EUCLEAN


	)

	@ext4_extents.h

19 #iâdeà
_EXT4_EXTENTS


20 
	#_EXT4_EXTENTS


	)

22 
	~"ext4.h
"

30 
	#AGGRESSIVE_TEST_


	)

37 
	#EXTENTS_STATS__


	)

43 
	#CHECK_BINSEARCH__


	)

49 
	#EXT_STATS_


	)

67 
	sext4_ex‹Á_
 {

68 
__Ë32
 
	m‘_checksum
;

75 
	sext4_ex‹Á
 {

76 
__Ë32
 
	m“_block
;

77 
__Ë16
 
	m“_Ën
;

78 
__Ë16
 
	m“_¡¬t_hi
;

79 
__Ë32
 
	m“_¡¬t_lo
;

86 
	sext4_ex‹Á_idx
 {

87 
__Ë32
 
	mei_block
;

88 
__Ë32
 
	mei_Ëaf_lo
;

90 
__Ë16
 
	mei_Ëaf_hi
;

91 
__u16
 
	mei_unu£d
;

97 
	sext4_ex‹Á_h—d”
 {

98 
__Ë16
 
	meh_magic
;

99 
__Ë16
 
	meh_’Œ›s
;

100 
__Ë16
 
	meh_max
;

101 
__Ë16
 
	meh_d•th
;

102 
__Ë32
 
	meh_g’”©iÚ
;

105 
	#EXT4_EXT_MAGIC
 
	`ıu_to_Ë16
(0xf30a)

	)

107 
	#EXT4_EXTENT_TAIL_OFFSET
(
hdr
) \

108 ((
ext4_ex‹Á_h—d”
) + \

109 ((
ext4_ex‹Á
è* 
	`Ë16_to_ıu
((
hdr
)->
eh_max
)))

	)

111 
šlše
 
ext4_ex‹Á_
 *

112 
	$fšd_ext4_ex‹Á_
(
ext4_ex‹Á_h—d”
 *
eh
)

114  (
ext4_ex‹Á_
 *)(((*)
eh
) +

115 
	`EXT4_EXTENT_TAIL_OFFSET
(
eh
));

116 
	}
}

123 
	sext4_ext_·th
 {

124 
ext4_fsblk_t
 
	mp_block
;

125 
__u16
 
	mp_d•th
;

126 
__u16
 
	mp_maxd•th
;

127 
ext4_ex‹Á
 *
	mp_ext
;

128 
ext4_ex‹Á_idx
 *
	mp_idx
;

129 
ext4_ex‹Á_h—d”
 *
	mp_hdr
;

130 
bufãr_h—d
 *
	mp_bh
;

154 
	#EXT_INIT_MAX_LEN
 (1UL << 15)

	)

155 
	#EXT_UNWRITTEN_MAX_LEN
 (
EXT_INIT_MAX_LEN
 - 1)

	)

158 
	#EXT_FIRST_EXTENT
(
__hdr__
) \

159 ((
ext4_ex‹Á
 *è(((*è(
__hdr__
)) + \

160 (
ext4_ex‹Á_h—d”
)))

	)

161 
	#EXT_FIRST_INDEX
(
__hdr__
) \

162 ((
ext4_ex‹Á_idx
 *è(((*è(
__hdr__
)) + \

163 (
ext4_ex‹Á_h—d”
)))

	)

164 
	#EXT_HAS_FREE_INDEX
(
__·th__
) \

165 (
	`Ë16_to_ıu
((
__·th__
)->
p_hdr
->
eh_’Œ›s
) \

166 < 
	`Ë16_to_ıu
((
__·th__
)->
p_hdr
->
eh_max
))

	)

167 
	#EXT_LAST_EXTENT
(
__hdr__
) \

168 (
	`EXT_FIRST_EXTENT
((
__hdr__
)è+ 
	`Ë16_to_ıu
((__hdr__)->
eh_’Œ›s
è- 1)

	)

169 
	#EXT_LAST_INDEX
(
__hdr__
) \

170 (
	`EXT_FIRST_INDEX
((
__hdr__
)è+ 
	`Ë16_to_ıu
((__hdr__)->
eh_’Œ›s
è- 1)

	)

171 
	#EXT_MAX_EXTENT
(
__hdr__
) \

172 (
	`EXT_FIRST_EXTENT
((
__hdr__
)è+ 
	`Ë16_to_ıu
((__hdr__)->
eh_max
è- 1)

	)

173 
	#EXT_MAX_INDEX
(
__hdr__
) \

174 (
	`EXT_FIRST_INDEX
((
__hdr__
)è+ 
	`Ë16_to_ıu
((__hdr__)->
eh_max
è- 1)

	)

176 
šlše
 
ext4_ex‹Á_h—d”
 *
	$ext_šode_hdr
(
šode
 *inode)

178  (
ext4_ex‹Á_h—d”
 *è
	`EXT4_I
(
šode
)->
i_d©a
;

179 
	}
}

181 
šlše
 
ext4_ex‹Á_h—d”
 *
	$ext_block_hdr
(
bufãr_h—d
 *
bh
)

183  (
ext4_ex‹Á_h—d”
 *è
bh
->
b_d©a
;

184 
	}
}

186 
šlše
 
	$ext_d•th
(
šode
 *inode)

188  
	`Ë16_to_ıu
(
	`ext_šode_hdr
(
šode
)->
eh_d•th
);

189 
	}
}

191 
šlše
 
	$ext4_ext_m¬k_unwr™‹n
(
ext4_ex‹Á
 *
ext
)

194 
	`BUG_ON
((
	`Ë16_to_ıu
(
ext
->
“_Ën
è& ~
EXT_INIT_MAX_LEN
) == 0);

195 
ext
->
“_Ën
 |ğ
	`ıu_to_Ë16
(
EXT_INIT_MAX_LEN
);

196 
	}
}

198 
šlše
 
	$ext4_ext_is_unwr™‹n
(
ext4_ex‹Á
 *
ext
)

201  (
	`Ë16_to_ıu
(
ext
->
“_Ën
è> 
EXT_INIT_MAX_LEN
);

202 
	}
}

204 
šlše
 
	$ext4_ext_g‘_aùu®_Ën
(
ext4_ex‹Á
 *
ext
)

206  (
	`Ë16_to_ıu
(
ext
->
“_Ën
è<ğ
EXT_INIT_MAX_LEN
 ?

207 
	`Ë16_to_ıu
(
ext
->
“_Ën
) :

208 (
	`Ë16_to_ıu
(
ext
->
“_Ën
è- 
EXT_INIT_MAX_LEN
));

209 
	}
}

211 
šlše
 
	$ext4_ext_m¬k_š™Ÿlized
(
ext4_ex‹Á
 *
ext
)

213 
ext
->
“_Ën
 = 
	`ıu_to_Ë16
(
	`ext4_ext_g‘_aùu®_Ën
(ext));

214 
	}
}

220 
šlše
 
ext4_fsblk_t
 
	$ext4_ext_pblock
(
ext4_ex‹Á
 *
ex
)

222 
ext4_fsblk_t
 
block
;

224 
block
 = 
	`Ë32_to_ıu
(
ex
->
“_¡¬t_lo
);

225 
block
 |ğ((
ext4_fsblk_t
è
	`Ë16_to_ıu
(
ex
->
“_¡¬t_hi
) << 31) << 1;

226  
block
;

227 
	}
}

233 
šlše
 
ext4_fsblk_t
 
	$ext4_idx_pblock
(
ext4_ex‹Á_idx
 *
ix
)

235 
ext4_fsblk_t
 
block
;

237 
block
 = 
	`Ë32_to_ıu
(
ix
->
ei_Ëaf_lo
);

238 
block
 |ğ((
ext4_fsblk_t
è
	`Ë16_to_ıu
(
ix
->
ei_Ëaf_hi
) << 31) << 1;

239  
block
;

240 
	}
}

247 
šlše
 
	$ext4_ext_¡Üe_pblock
(
ext4_ex‹Á
 *
ex
,

248 
ext4_fsblk_t
 
pb
)

250 
ex
->
“_¡¬t_lo
 = 
	`ıu_to_Ë32
((è(
pb
 & 0xffffffff));

251 
ex
->
“_¡¬t_hi
 = 
	`ıu_to_Ë16
((è((
pb
 >> 31) >> 1) &

253 
	}
}

260 
šlše
 
	$ext4_idx_¡Üe_pblock
(
ext4_ex‹Á_idx
 *
ix
,

261 
ext4_fsblk_t
 
pb
)

263 
ix
->
ei_Ëaf_lo
 = 
	`ıu_to_Ë32
((è(
pb
 & 0xffffffff));

264 
ix
->
ei_Ëaf_hi
 = 
	`ıu_to_Ë16
((è((
pb
 >> 31) >> 1) &

266 
	}
}

268 
	#ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
) \

269 
	`__ext4_ext_dœty
(
__func__
, 
__LINE__
, (
hªdË
), (
šode
), (
·th
))

	)

270 
__ext4_ext_dœty
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
,

271 
šode
 *šode, 
ext4_ext_·th
 *
·th
);

	@ext4_jbd2.c

5 
	~"ext4_jbd2.h
"

6 
	~"ext4_ex‹Ás.h
"

8 
	~<Œaû/ev’ts/ext4.h
>

11 
hªdË_t
 *
	$ext4_g‘_nojouº®
()

13 
hªdË_t
 *
hªdË
 = 
cu¼’t
->
jouº®_šfo
;

14 
»f_út
 = ()
hªdË
;

16 
	`BUG_ON
(
»f_út
 >ğ
EXT4_NOJOURNAL_MAX_REF_COUNT
);

18 
»f_út
++;

19 
hªdË
 = (
hªdË_t
 *)
»f_út
;

21 
cu¼’t
->
jouº®_šfo
 = 
hªdË
;

22  
hªdË
;

23 
	}
}

27 
	$ext4_put_nojouº®
(
hªdË_t
 *
hªdË
)

29 
»f_út
 = ()
hªdË
;

31 
	`BUG_ON
(
»f_út
 == 0);

33 
»f_út
--;

34 
hªdË
 = (
hªdË_t
 *)
»f_út
;

36 
cu¼’t
->
jouº®_šfo
 = 
hªdË
;

37 
	}
}

42 
	$ext4_jouº®_check_¡¬t
(
su³r_block
 *
sb
)

44 
jouº®_t
 *
jouº®
;

46 
	`might_¦“p
();

48 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

49  -
EIO
;

51 ià(
sb
->
s_æags
 & 
MS_RDONLY
)

52  -
EROFS
;

53 
	`WARN_ON
(
sb
->
s_wr™”s
.
äoz’
 =ğ
SB_FREEZE_COMPLETE
);

54 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

60 ià(
jouº®
 && 
	`is_jouº®_abÜ‹d
(journal)) {

61 
	`ext4_abÜt
(
sb
, "Detected‡borted journal");

62  -
EROFS
;

65 
	}
}

67 
hªdË_t
 *
	$__ext4_jouº®_¡¬t_sb
(
su³r_block
 *
sb
, 
lše
,

68 
ty³
, 
blocks
, 
rsv_blocks
)

70 
jouº®_t
 *
jouº®
;

71 
”r
;

73 
	`Œaû_ext4_jouº®_¡¬t
(
sb
, 
blocks
, 
rsv_blocks
, 
_RET_IP_
);

74 
”r
 = 
	`ext4_jouº®_check_¡¬t
(
sb
);

75 ià(
”r
 < 0)

76  
	`ERR_PTR
(
”r
);

78 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

79 ià(!
jouº®
)

80  
	`ext4_g‘_nojouº®
();

81  
	`jbd2__jouº®_¡¬t
(
jouº®
, 
blocks
, 
rsv_blocks
, 
GFP_NOFS
,

82 
ty³
, 
lše
);

83 
	}
}

85 
	$__ext4_jouº®_¡İ
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
)

87 
su³r_block
 *
sb
;

88 
”r
;

89 
rc
;

91 ià(!
	`ext4_hªdË_v®id
(
hªdË
)) {

92 
	`ext4_put_nojouº®
(
hªdË
);

96 
”r
 = 
hªdË
->
h_”r
;

97 ià(!
hªdË
->
h_Œª§ùiÚ
) {

98 
rc
 = 
	`jbd2_jouº®_¡İ
(
hªdË
);

99  
”r
 ?ƒ¼ : 
rc
;

102 
sb
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
->
j_´iv©e
;

103 
rc
 = 
	`jbd2_jouº®_¡İ
(
hªdË
);

105 ià(!
”r
)

106 
”r
 = 
rc
;

107 ià(
”r
)

108 
	`__ext4_¡d_”rÜ
(
sb
, 
wh”e
, 
lše
, 
”r
);

109  
”r
;

110 
	}
}

112 
hªdË_t
 *
	$__ext4_jouº®_¡¬t_»£rved
(
hªdË_t
 *
hªdË
, 
lše
,

113 
ty³
)

115 
su³r_block
 *
sb
;

116 
”r
;

118 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

119  
	`ext4_g‘_nojouº®
();

121 
sb
 = 
hªdË
->
h_jouº®
->
j_´iv©e
;

122 
	`Œaû_ext4_jouº®_¡¬t_»£rved
(
sb
, 
hªdË
->
h_bufãr_üed™s
,

123 
_RET_IP_
);

124 
”r
 = 
	`ext4_jouº®_check_¡¬t
(
sb
);

125 ià(
”r
 < 0) {

126 
	`jbd2_jouº®_ä“_»£rved
(
hªdË
);

127  
	`ERR_PTR
(
”r
);

130 
”r
 = 
	`jbd2_jouº®_¡¬t_»£rved
(
hªdË
, 
ty³
, 
lše
);

131 ià(
”r
 < 0)

132  
	`ERR_PTR
(
”r
);

133  
hªdË
;

134 
	}
}

136 
	$ext4_jouº®_abÜt_hªdË
(cÚ¡ *
ÿÎ”
, 
lše
,

137 cÚ¡ *
”r_â
,

138 
bufãr_h—d
 *
bh
,

139 
hªdË_t
 *
hªdË
, 
”r
)

141 
nbuf
[16];

142 cÚ¡ *
”r¡r
 = 
	`ext4_decode_”rÜ
(
NULL
, 
”r
, 
nbuf
);

144 
	`BUG_ON
(!
	`ext4_hªdË_v®id
(
hªdË
));

146 ià(
bh
)

147 
	`BUFFER_TRACE
(
bh
, "abort");

149 ià(!
hªdË
->
h_”r
)

150 
hªdË
->
h_”r
 = 
”r
;

152 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

155 
	`´štk
(
KERN_ERR
 "EXT4-fs: %s:%d:‡bortingransaction: %s in %s\n",

156 
ÿÎ”
, 
lše
, 
”r¡r
, 
”r_â
);

158 
	`jbd2_jouº®_abÜt_hªdË
(
hªdË
);

159 
	}
}

161 
	$__ext4_jouº®_g‘_wr™e_acûss
(cÚ¡ *
wh”e
, 
lše
,

162 
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

164 
”r
 = 0;

166 
	`might_¦“p
();

168 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

169 
su³r_block
 *
sb
;

171 
sb
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
->
j_´iv©e
;

172 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
)))) {

173 
	`jbd2_jouº®_abÜt_hªdË
(
hªdË
);

174  -
EIO
;

176 
”r
 = 
	`jbd2_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

177 ià(
”r
)

178 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
, 
bh
,

179 
hªdË
, 
”r
);

181  
”r
;

182 
	}
}

196 
	$__ext4_fÜg‘
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
,

197 
is_m‘ad©a
, 
šode
 *inode,

198 
bufãr_h—d
 *
bh
, 
ext4_fsblk_t
 
blockÄ
)

200 
”r
;

202 
	`might_¦“p
();

204 
	`Œaû_ext4_fÜg‘
(
šode
, 
is_m‘ad©a
, 
blockÄ
);

205 
	`BUFFER_TRACE
(
bh
, "enter");

207 
	`jbd_debug
(4, "forgetting bh %p: is_metadata = %d, mode %o, "

209 
bh
, 
is_m‘ad©a
, 
šode
->
i_mode
,

210 
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
));

213 ià(!
	`ext4_hªdË_v®id
(
hªdË
)) {

214 
	`bfÜg‘
(
bh
);

223 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
 ||

224 (!
is_m‘ad©a
 && !
	`ext4_should_jouº®_d©a
(
šode
))) {

225 ià(
bh
) {

226 
	`BUFFER_TRACE
(
bh
, "call jbd2_journal_forget");

227 
”r
 = 
	`jbd2_jouº®_fÜg‘
(
hªdË
, 
bh
);

228 ià(
”r
)

229 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
,

230 
bh
, 
hªdË
, 
”r
);

231  
”r
;

239 
	`BUFFER_TRACE
(
bh
, "call jbd2_journal_revoke");

240 
”r
 = 
	`jbd2_jouº®_»voke
(
hªdË
, 
blockÄ
, 
bh
);

241 ià(
”r
) {

242 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
,

243 
bh
, 
hªdË
, 
”r
);

244 
	`__ext4_abÜt
(
šode
->
i_sb
, 
wh”e
, 
lše
,

245 "”rÜ %d wh’‡‰em±šg„evoke", 
”r
);

247 
	`BUFFER_TRACE
(
bh
, "exit");

248  
”r
;

249 
	}
}

251 
	$__ext4_jouº®_g‘_ü—‹_acûss
(cÚ¡ *
wh”e
, 
lše
,

252 
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

254 
”r
 = 0;

256 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

257 
”r
 = 
	`jbd2_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

258 ià(
”r
)

259 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
,

260 
bh
, 
hªdË
, 
”r
);

262  
”r
;

263 
	}
}

265 
	$__ext4_hªdË_dœty_m‘ad©a
(cÚ¡ *
wh”e
, 
lše
,

266 
hªdË_t
 *
hªdË
, 
šode
 *inode,

267 
bufãr_h—d
 *
bh
)

269 
”r
 = 0;

271 
	`might_¦“p
();

273 
	`£t_bufãr_m‘a
(
bh
);

274 
	`£t_bufãr_´io
(
bh
);

275 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

276 
”r
 = 
	`jbd2_jouº®_dœty_m‘ad©a
(
hªdË
, 
bh
);

278 ià(!
	`is_hªdË_abÜ‹d
(
hªdË
è&& 
	`WARN_ON_ONCE
(
”r
)) {

279 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
, 
bh
,

280 
hªdË
, 
”r
);

281 ià(
šode
 =ğ
NULL
) {

282 
	`´_”r
("EXT4: jbd2_journal_dirty_metadata "

285 
hªdË
->
h_ty³
,

286 
hªdË
->
h_lše_no
,

287 
hªdË
->
h_»que¡ed_üed™s
,

288 
hªdË
->
h_bufãr_üed™s
, 
”r
);

289  
”r
;

291 
	`ext4_”rÜ_šode
(
šode
, 
wh”e
, 
lše
,

292 
bh
->
b_blockÄ
,

296 
hªdË
->
h_ty³
,

297 
hªdË
->
h_lše_no
,

298 
hªdË
->
h_»que¡ed_üed™s
,

299 
hªdË
->
h_bufãr_üed™s
, 
”r
);

302 ià(
šode
)

303 
	`m¬k_bufãr_dœty_šode
(
bh
, 
šode
);

305 
	`m¬k_bufãr_dœty
(
bh
);

306 ià(
šode
 && 
	`šode_Ãeds_sync
(inode)) {

307 
	`sync_dœty_bufãr
(
bh
);

308 ià(
	`bufãr_»q
(
bh
è&& !
	`bufãr_u±od©e
(bh)) {

309 
ext4_su³r_block
 *
es
;

311 
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

312 
es
->
s_Ï¡_”rÜ_block
 =

313 
	`ıu_to_Ë64
(
bh
->
b_blockÄ
);

314 
	`ext4_”rÜ_šode
(
šode
, 
wh”e
, 
lše
,

315 
bh
->
b_blockÄ
,

317 
”r
 = -
EIO
;

321  
”r
;

322 
	}
}

324 
	$__ext4_hªdË_dœty_su³r
(cÚ¡ *
wh”e
, 
lše
,

325 
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
)

327 
bufãr_h—d
 *
bh
 = 
	`EXT4_SB
(
sb
)->
s_sbh
;

328 
”r
 = 0;

330 
	`ext4_su³rblock_csum_£t
(
sb
);

331 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

332 
”r
 = 
	`jbd2_jouº®_dœty_m‘ad©a
(
hªdË
, 
bh
);

333 ià(
”r
)

334 
	`ext4_jouº®_abÜt_hªdË
(
wh”e
, 
lše
, 
__func__
,

335 
bh
, 
hªdË
, 
”r
);

337 
	`m¬k_bufãr_dœty
(
bh
);

338  
”r
;

339 
	}
}

341 
kmem_ÿche
 *
	gext4_fc_d’Œy_ÿch•
;

343 
šlše


344 
	$ext4_»£t_šode_fc_šfo
(
šode
 *inode)

346 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

348 
ei
->
i_fc_tid
 = 0;

349 
ei
->
i_fc_lblk_¡¬t
 = 0;

350 
ei
->
i_fc_lblk_’d
 = 0;

351 
ei
->
i_fc_md©a_upd©e
 = 
NULL
;

352 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_FC_ELIGIBLE
);

353 
	}
}

355 
	$ext4_š™_šode_fc_šfo
(
šode
 *inode)

357 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

359 
	`ext4_»£t_šode_fc_šfo
(
šode
);

360 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_FC_DATA_SUBMIT
);

361 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_FC_MDATA_SUBMIT
);

362 
	`INIT_LIST_HEAD
(&
ei
->
i_fc_li¡
);

363 
	}
}

365 
	$ext4_fc_’queue_šode
(
šode
 *inode)

367 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

369 ià(!
	`‹¡_İt2
(
šode
->
i_sb
, 
JOURNAL_FAST_COMMIT
) ||

370 (
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_¡©e
 & 
EXT4_FC_REPLAY
))

373 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

374 ià(
	`li¡_em±y
(&
	`EXT4_I
(
šode
)->
i_fc_li¡
))

375 
	`li¡_add_
(&
	`EXT4_I
(
šode
)->
i_fc_li¡
, &
sbi
->
s_fc_q
);

376 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

377 
	}
}

379 
šlše
 
tid_t
 
	$g‘_ruÂšg_txn_tid
(
su³r_block
 *
sb
)

381 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
)

382  
	`EXT4_SB
(
sb
)->
s_jouº®
->
j_comm™_£qu’û
 + 1;

384 
	}
}

386 
	$ext4_fc_d–
(
šode
 *inode)

388 ià(!
	`‹¡_İt2
(
šode
->
i_sb
, 
JOURNAL_FAST_COMMIT
) ||

389 (
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_¡©e
 & 
EXT4_FC_REPLAY
))

392 ià(
	`li¡_em±y
(&
	`EXT4_I
(
šode
)->
i_fc_li¡
))

395 
»¡¬t
:

396 
	`¥š_lock
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_fc_lock
);

397 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_FC_DATA_SUBMIT
)) {

398 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

399 
wa™_queue_h—d_t
 *
wq
;

400 #ià(
BITS_PER_LONG
 < 64)

401 
	`DEFINE_WAIT_BIT
(
wa™
, &
ei
->
i_¡©e_æags
,

402 
EXT4_STATE_FC_DATA_SUBMIT
);

403 
wq
 = 
	`b™_wa™queue
(&
ei
->
i_¡©e_æags
,

404 
EXT4_STATE_FC_DATA_SUBMIT
);

406 
	`DEFINE_WAIT_BIT
(
wa™
, &
ei
->
i_æags
,

407 
EXT4_STATE_FC_DATA_SUBMIT
);

408 
wq
 = 
	`b™_wa™queue
(&
ei
->
i_æags
,

409 
EXT4_STATE_FC_DATA_SUBMIT
);

411 
	`´•¬e_to_wa™
(
wq
, &
wa™
.
wq_’Œy
, 
TASK_UNINTERRUPTIBLE
);

412 
	`¥š_uÆock
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_fc_lock
);

413 
	`scheduË
();

414 
	`fšish_wa™
(
wq
, &
wa™
.
wq_’Œy
);

415 
»¡¬t
;

417 
	`li¡_d–_š™
(&
	`EXT4_I
(
šode
)->
i_fc_li¡
);

418 
	`¥š_uÆock
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_fc_lock
);

419 
	}
}

421 
boŞ
 
	$ext4_is_šode_fc_š–igibË
(
šode
 *inode)

423 ià(
	`g‘_ruÂšg_txn_tid
(
šode
->
i_sb
è=ğ
	`EXT4_I
(šode)->
i_fc_tid
)

424  !
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_FC_ELIGIBLE
);

425  
çl£
;

426 
	}
}

428 
	$ext4_fc_m¬k_š–igibË
(
šode
 *šode, 
»asÚ
)

430 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

431 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

433 ià(!
	`‹¡_İt2
(
šode
->
i_sb
, 
JOURNAL_FAST_COMMIT
) ||

434 (
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_¡©e
 & 
EXT4_FC_REPLAY
))

437 
	`WARN_ON
(
»asÚ
 >ğ
EXT4_FC_REASON_MAX
);

438 
sbi
->
s_fc_¡©s
.
fc_š–igibË_»asÚ_couÁ
[
»asÚ
]++;

439 ià(
sbi
->
s_jouº®
)

440 
ei
->
i_fc_tid
 = 
	`g‘_ruÂšg_txn_tid
(
šode
->
i_sb
);

441 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_FC_ELIGIBLE
);

443 
	`ext4_fc_’queue_šode
(
šode
);

444 
	}
}

446 
	$ext4_fc_di§bË
(
su³r_block
 *
sb
, 
»asÚ
)

448 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

450 
sbi
->
s_mouÁ_¡©e
 |ğ
EXT4_FC_INELIGIBLE
;

451 
	`WARN_ON
(
»asÚ
 >ğ
EXT4_FC_REASON_MAX
);

452 
sbi
->
s_fc_¡©s
.
fc_š–igibË_»asÚ_couÁ
[
»asÚ
]++;

453 
	}
}

464 
__ext4_fc_Œack_‹m¶©e
(

465 
šode
 *inode,

466 (*
__fc_Œack_â
)(
šode
 *, *, 
boŞ
),

467 *
¬gs
)

469 
tid_t
 
ruÂšg_txn_tid
 = 
	`g‘_ruÂšg_txn_tid
(
šode
->
i_sb
);

470 
boŞ
 
upd©e
 = 
çl£
;

471 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

472 
»t
;

474 ià(!
	`‹¡_İt2
(
šode
->
i_sb
, 
JOURNAL_FAST_COMMIT
) ||

475 (
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_¡©e
 & 
EXT4_FC_REPLAY
))

476  -
EOPNOTSUPP
;

478 
	`wr™e_lock
(&
ei
->
i_fc_lock
);

479 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_FC_MDATA_SUBMIT
);

480 ià(
ruÂšg_txn_tid
 =ğ
ei
->
i_fc_tid
) {

481 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_FC_ELIGIBLE
)) {

482 
	`wr™e_uÆock
(&
ei
->
i_fc_lock
);

483  -
EINVAL
;

485 
upd©e
 = 
Œue
;

487 
	`ext4_»£t_šode_fc_šfo
(
šode
);

488 
ei
->
i_fc_tid
 = 
ruÂšg_txn_tid
;

489 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_FC_ELIGIBLE
);

491 
»t
 = 
	`__fc_Œack_â
(
šode
, 
¬gs
, 
upd©e
);

492 
	`wr™e_uÆock
(&
ei
->
i_fc_lock
);

494 
	`ext4_fc_’queue_šode
(
šode
);

496  
»t
;

497 
	}
}

499 
	s__ext4_d’Œy_upd©e_¬gs
 {

500 
d’Œy
 *
	md’Œy
;

501 
	mİ
;

504 
	$__ext4_d’Œy_upd©e
(
šode
 *šode, *
¬g
, 
boŞ
 
upd©e
)

506 
ext4_fc_d’Œy_upd©e
 *
node
;

507 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

508 
__ext4_d’Œy_upd©e_¬gs
 *
d’Œy_upd©e
 =

509 (
__ext4_d’Œy_upd©e_¬gs
 *)
¬g
;

510 
d’Œy
 *d’Œy = 
d’Œy_upd©e
->dentry;

512 
	`wr™e_uÆock
(&
ei
->
i_fc_lock
);

513 
node
 = 
	`kmem_ÿche_®loc
(
ext4_fc_d’Œy_ÿch•
, 
GFP_NOFS
);

514 ià(!
node
) {

515 
	`ext4_fc_di§bË
(
šode
->
i_sb
, 
EXT4_FC_REASON_MEM
);

516 
	`wr™e_lock
(&
ei
->
i_fc_lock
);

517  -
ENOMEM
;

520 
node
->
fcd_İ
 = 
d’Œy_upd©e
->
İ
;

521 
node
->
fcd_·»Á
 = 
d’Œy
->
d_·»Á
->
d_šode
->
i_šo
;

522 
node
->
fcd_šo
 = 
šode
->
i_šo
;

523 ià(
d’Œy
->
d_Çme
.
Ën
 > 
DNAME_INLINE_LEN
) {

524 
node
->
fcd_Çme
.
Çme
 = 
	`km®loc
(
d’Œy
->
d_Çme
.
Ën
 + 1,

525 
GFP_KERNEL
);

526 ià(!
node
->
fcd_šame
) {

527 
	`kmem_ÿche_ä“
(
ext4_fc_d’Œy_ÿch•
, 
node
);

528  -
ENOMEM
;

530 
	`memıy
((
u8
 *)
node
->
fcd_Çme
.
Çme
, 
d’Œy
->
d_Çme
.name,

531 
d’Œy
->
d_Çme
.
Ën
);

533 
	`memıy
(
node
->
fcd_šame
, 
d’Œy
->
d_Çme
.
Çme
,

534 
d’Œy
->
d_Çme
.
Ën
);

535 
node
->
fcd_Çme
.
Çme
 =‚ode->
fcd_šame
;

537 
node
->
fcd_Çme
.
Ën
 = 
d’Œy
->
d_Çme
.len;

539 
	`¥š_lock
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_fc_lock
);

540 
	`li¡_add_
(&
node
->
fcd_li¡
, &
	`EXT4_SB
(
šode
->
i_sb
)->
s_fc_d’Œy_q
);

541 
	`¥š_uÆock
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_fc_lock
);

542 
	`wr™e_lock
(&
ei
->
i_fc_lock
);

543 
	`EXT4_I
(
šode
)->
i_fc_md©a_upd©e
 = 
node
;

546 
	}
}

548 
	$ext4_fc_Œack_uÆšk
(
šode
 *šode, 
d’Œy
 *dentry)

550 
__ext4_d’Œy_upd©e_¬gs
 
¬gs
;

551 
»t
;

553 
¬gs
.
d’Œy
 = dentry;

554 
¬gs
.
İ
 = 
EXT4_FC_TAG_DEL_DENTRY
;

556 
»t
 = 
	`__ext4_fc_Œack_‹m¶©e
(
šode
, 
__ext4_d’Œy_upd©e
,

557 (*)&
¬gs
);

558 
	`Œaû_ext4_fc_Œack_uÆšk
(
šode
, 
d’Œy
, 
»t
);

559 
	}
}

561 
	$ext4_fc_Œack_lšk
(
šode
 *šode, 
d’Œy
 *dentry)

563 
__ext4_d’Œy_upd©e_¬gs
 
¬gs
;

564 
»t
;

566 
¬gs
.
d’Œy
 = dentry;

567 
¬gs
.
İ
 = 
EXT4_FC_TAG_ADD_DENTRY
;

569 
»t
 = 
	`__ext4_fc_Œack_‹m¶©e
(
šode
, 
__ext4_d’Œy_upd©e
,

570 (*)&
¬gs
);

571 
	`Œaû_ext4_fc_Œack_lšk
(
šode
, 
d’Œy
, 
»t
);

572 
	}
}

574 
	$ext4_fc_Œack_ü—‹
(
šode
 *šode, 
d’Œy
 *dentry)

576 
__ext4_d’Œy_upd©e_¬gs
 
¬gs
;

577 
»t
;

579 
¬gs
.
d’Œy
 = dentry;

580 
¬gs
.
İ
 = 
EXT4_FC_TAG_CREAT_DENTRY
;

582 
»t
 = 
	`__ext4_fc_Œack_‹m¶©e
(
šode
, 
__ext4_d’Œy_upd©e
,

583 (*)&
¬gs
);

584 
	`Œaû_ext4_fc_Œack_ü—‹
(
šode
, 
d’Œy
, 
»t
);

585 
	}
}

587 
	$__ext4_fc_add_šode
(
šode
 *šode, *
¬g
, 
boŞ
 
upd©e
)

589 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

591 ià(
upd©e
)

592  -
EEXIST
;

594 
ei
->
i_fc_lblk_¡¬t
 = (
	`i_size_»ad
(
šode
è- 1è>> inode->
i_blkb™s
;

595 
ei
->
i_fc_lblk_’d
 = (
	`i_size_»ad
(
šode
è- 1è>> inode->
i_blkb™s
;

598 
	}
}

600 
	$ext4_fc_Œack_šode
(
šode
 *inode)

602 
»t
;

604 
»t
 = 
	`__ext4_fc_Œack_‹m¶©e
(
šode
, 
__ext4_fc_add_šode
, 
NULL
);

605 
	`Œaû_ext4_fc_Œack_šode
(
šode
, 
»t
);

606 
	}
}

608 
	s__ext4_fc_Œack_¿nge_¬gs
 {

609 
ext4_lblk_t
 
	m¡¬t
, 
	m’d
;

612 
	#MIN
(
__a
, 
__b
è((__aè< (__bè? (__aè: (__b))

	)

613 
	#MAX
(
__a
, 
__b
è((__aè> (__bè? (__aè: (__b))

	)

615 
	$__ext4_fc_Œack_¿nge
(
šode
 *šode, *
¬g
, 
boŞ
 
upd©e
)

617 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

618 
__ext4_fc_Œack_¿nge_¬gs
 *
__¬g
 =

619 (
__ext4_fc_Œack_¿nge_¬gs
 *)
¬g
;

621 ià(
šode
->
i_šo
 < 
	`EXT4_FIRST_INO
(šode->
i_sb
)) {

622 
	`ext4_debug
("S³cŸÈšod%ld bešg modif›d\n", 
šode
->
i_šo
);

623  -
ECANCELED
;

626 ià(
upd©e
) {

627 
ei
->
i_fc_lblk_¡¬t
 = 
	`MIN
Ói->i_fc_lblk_¡¬t, 
__¬g
->
¡¬t
);

628 
ei
->
i_fc_lblk_’d
 = 
	`MAX
Ói->i_fc_lblk_’d, 
__¬g
->
’d
);

630 
ei
->
i_fc_lblk_¡¬t
 = 
__¬g
->
¡¬t
;

631 
ei
->
i_fc_lblk_’d
 = 
__¬g
->
’d
;

635 
	}
}

637 
	$ext4_fc_Œack_¿nge
(
šode
 *šode, 
ext4_lblk_t
 
¡¬t
,

638 
ext4_lblk_t
 
’d
)

640 
__ext4_fc_Œack_¿nge_¬gs
 
¬gs
;

641 
»t
;

643 
¬gs
.
¡¬t
 = start;

644 
¬gs
.
’d
 =ƒnd;

646 
»t
 = 
	`__ext4_fc_Œack_‹m¶©e
(
šode
,

647 
__ext4_fc_Œack_¿nge
, &
¬gs
);

649 
	`Œaû_ext4_fc_Œack_¿nge
(
šode
, 
¡¬t
, 
’d
, 
»t
);

650 
	}
}

652 
	$ext4_’d_bufãr_io_sync
(
bufãr_h—d
 *
bh
, 
u±od©e
)

654 
	`BUFFER_TRACE
(
bh
, "");

655 ià(
u±od©e
) {

656 
	`ext4_debug
("%s: Block %lld up-to-date",

657 
__func__
, 
bh
->
b_blockÄ
);

658 
	`£t_bufãr_u±od©e
(
bh
);

660 
	`ext4_debug
("%s: Block %lld‚ot up-to-date",

661 
__func__
, 
bh
->
b_blockÄ
);

662 
	`ş—r_bufãr_u±od©e
(
bh
);

665 
	`uÆock_bufãr
(
bh
);

666 
	}
}

668 
	$subm™_fc_bh
(
bufãr_h—d
 *
bh
)

670 
	`lock_bufãr
(
bh
);

671 
	`ş—r_bufãr_dœty
(
bh
);

672 
	`£t_bufãr_u±od©e
(
bh
);

673 
bh
->
b_’d_io
 = 
ext4_’d_bufãr_io_sync
;

674 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

675 
	}
}

683 
	$fc_wr™e_hdr
(
šode
 *šode, 
u8
 *
¡¬t
, u8 *
’d
,

684 
u8
 **
Ï¡
)

686 
ext4_fc_comm™_hdr
 *
fc_hdr
 = (ext4_fc_comm™_hd¸*)
¡¬t
;

687 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

688 
šode_Ën
 = 
EXT4_GOOD_OLD_INODE_SIZE
;

689 
ext4_oc
 
oc
;

690 
u8
 *
cur
 = 
¡¬t
;

691 
»t
;

693 ià(
	`ext4_is_šode_fc_š–igibË
(
šode
))

694  -
ECANCELED
;

696 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

697 ià(
»t
)

698  
»t
;

700 
fc_hdr
->
fc_magic
 = 
	`ıu_to_Ë32
(
EXT4_FC_MAGIC
);

701 
fc_hdr
->
fc_šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

702 
fc_hdr
->
fc_ã©u»s
 = 0;

703 
fc_hdr
->
fc_csum
 = 0;

705 
cur
 = (
u8
 *)(
fc_hdr
 + 1);

706 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
)

707 
šode_Ën
 +ğ
ei
->
i_exŒa_isize
;

708 ià(
cur
 + 
šode_Ën
 >ğ
’d
)

709  -
ECANCELED
;

711 
	`memıy
(
cur
, 
	`ext4_¿w_šode
(&
oc
), 
šode_Ën
);

712 
cur
 +ğ
šode_Ën
;

713 *
Ï¡
 = 
cur
;

716 
	}
}

723 
boŞ
 
	$fc_Œy_add_v
(
u8
 **
d¡
, u8 *
’d
, 
u16
 
g
, u16 
Ën
, u8 *
v®
)

725 
ext4_fc_
 

;

727 ià(*
d¡
 + (

è+ 
Ën
 >ğ
’d
)

728  
çl£
;

730 

.
fc_g
 = 
	`ıu_to_Ë16
(
g
);

731 

.
fc_Ën
 = 
	`ıu_to_Ë16
(
Ën
);

732 
	`memıy
(*
d¡
, &

, (tl));

733 
	`memıy
(*
d¡
 + (

), 
v®
, 
Ën
);

735 *
d¡
 = *d¡ + (

è+ 
Ën
;

736  
Œue
;

737 
	}
}

740 
boŞ
 
	$fc_Œy_add_d’Œy_šfo_v
(
u8
 **
d¡
, u8 *
’d
, 
u16
 
g
,

741 
·»Á_šo
, 
šo
, 
dËn
,

742 cÚ¡ *
dÇme
)

744 
ext4_fc_d’Œy_šfo
 
fcd
;

745 
ext4_fc_
 

;

748 ià(*
d¡
 + (

è+ (
fcd
è+ 
dËn
 >ğ
’d
)

749  
çl£
;

751 
fcd
.
fc_·»Á_šo
 = 
	`ıu_to_Ë32
(
·»Á_šo
);

752 
fcd
.
fc_šo
 = 
	`ıu_to_Ë32
(
šo
);

753 

.
fc_g
 = 
	`ıu_to_Ë16
(
g
);

754 

.
fc_Ën
 = 
	`ıu_to_Ë16
((
fcd
è+ 
dËn
);

755 
	`memıy
(*
d¡
, &

, (tl));

756 *
d¡
 +ğ(

);

757 
	`memıy
(*
d¡
, &
fcd
, (fcd));

758 *
d¡
 +ğ(
fcd
);

759 
	`memıy
(*
d¡
, 
dÇme
, 
dËn
);

760 *
d¡
 +ğ
dËn
;

762  
Œue
;

763 
	}
}

770 
	$fc_wr™e_d©a
(
šode
 *šode, 
u8
 *
¡¬t
, u8 *
’d
,

771 
u8
 **
Ï¡
)

773 
ext4_lblk_t
 
Şd_blk_size
, 
cur_lblk_off
, 
Ãw_blk_size
;

774 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

775 
ext4_m­_blocks
 
m­
;

776 
ext4_ex‹Á
 
ex‹Á
;

777 
ext4_fc_Ìªge
 
Ìªge
;

778 
u8
 *
cur
 = 
¡¬t
;

779 
num_vs
 = 0;

780 
»t
;

782 
	`wr™e_lock
(&
ei
->
i_fc_lock
);

783 
Şd_blk_size
 = 
ei
->
i_fc_lblk_¡¬t
;

784 
Ãw_blk_size
 = 
ei
->
i_fc_lblk_’d
;

785 
ei
->
i_fc_lblk_¡¬t
 =ƒi->
i_fc_lblk_’d
;

786 
	`wr™e_uÆock
(&
ei
->
i_fc_lock
);

788 
cur_lblk_off
 = 
Şd_blk_size
;

789 
	`jbd_debug
(1, "%s: willry writing %ldo %ld for inode %ld\n",

790 
__func__
, 
cur_lblk_off
, 
Ãw_blk_size
, 
šode
->
i_šo
);

791 
cur_lblk_off
 <ğ
Ãw_blk_size
) {

792 
m­
.
m_lblk
 = 
cur_lblk_off
;

793 
m­
.
m_Ën
 = 
Ãw_blk_size
 - 
cur_lblk_off
 + 1;

794 
»t
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

795 ià(
»t
 < 0)

796  
»t
;

797 ià(
m­
.
m_Ën
 == 0)

798  -
ECANCELED
;

799 ià(
m­
.
m_æags
 & 
EXT4_MAP_UNWRITTEN
)

800  -
ECANCELED
;

802 
cur_lblk_off
 +ğ
m­
.
m_Ën
;

803 ià(
»t
 == 0) {

804 
Ìªge
.
fc_lblk
 = 
	`ıu_to_Ë32
(
m­
.
m_lblk
);

805 
Ìªge
.
fc_Ën
 = 
	`ıu_to_Ë32
(
m­
.
m_Ën
);

806 ià(!
	`fc_Œy_add_v
(&
cur
, 
’d
, 
EXT4_FC_TAG_DEL_RANGE
,

807 (
Ìªge
), (
u8
 *)&lrange))

808  -
ENOSPC
;

811 
ex‹Á
.
“_block
 = 
	`ıu_to_Ë32
(
m­
.
m_lblk
);

812 
ex‹Á
.
“_Ën
 = 
	`ıu_to_Ë16
(
m­
.
m_Ën
);

813 
	`ext4_ext_¡Üe_pblock
(&
ex‹Á
, 
m­
.
m_pblk
);

814 
	`ext4_ext_m¬k_š™Ÿlized
(&
ex‹Á
);

815 ià(!
	`fc_Œy_add_v
(&
cur
, 
’d
, 
EXT4_FC_TAG_ADD_RANGE
,

816 (
ext4_ex‹Á
), (
u8
 *)&
ex‹Á
))

817  -
ENOSPC
;

819 
num_vs
++;

821 *
Ï¡
 = 
cur
;

823  
num_vs
;

824 
	}
}

826 
	$fc_comm™_d©a_šode
(
jouº®_t
 *
jouº®
, 
šode
 *inode)

828 
ext4_fc_comm™_hdr
 *
hdr
;

829 
bufãr_h—d
 *
bh
;

830 
u8
 *
¡¬t
, *
cur
, *
’d
;

831 
»t
;

832 
num_vs
 = 0;

834 
»t
 = 
	`jbd2_m­_fc_buf
(
jouº®
, &
bh
);

835 ià(
»t
)

836  -
ECANCELED
;

838 
¡¬t
 = 
cur
 = ((
__u8
 *)
bh
->
b_d©a
 + (
jouº®_h—d”_t
));

839 
’d
 = (
__u8
 *)
bh
->
b_d©a
 + 
jouº®
->
j_blocksize
;

840 
hdr
 = (
ext4_fc_comm™_hdr
 *)
¡¬t
;

842 
»t
 = 
	`fc_wr™e_hdr
(
šode
, 
¡¬t
, 
’d
, &
cur
);

843 ià(
»t
 < 0)

844  
»t
;

846 
»t
 = 
	`fc_wr™e_d©a
(
šode
, 
cur
, 
’d
, &cur);

847 ià(
»t
 < 0)

848  
»t
;

849 
	`mem£t
(
cur
, 0, 
’d
 - cur);

851 
hdr
->
fc_num_vs
 = 
	`ıu_to_Ë16
(
num_vs
 + 
»t
);

852 
hdr
->
fc_csum
 = 0;

853 
hdr
->
fc_csum
 = 
	`ıu_to_Ë32
(
	`ext4_chksum
(
	`EXT4_SB
(
šode
->
i_sb
),

854 0, 
¡¬t
, 
’d
 - start));

855 
	`subm™_fc_bh
(
bh
);

856 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_FC_MDATA_SUBMIT
);

859 
	}
}

861 
	$subm™_®l_šode_d©a
(
jouº®_t
 *
jouº®
)

863 
su³r_block
 *
sb
 = (su³r_block *)(
jouº®
->
j_´iv©e
);

864 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

865 
ext4_šode_šfo
 *
™”
;

866 
li¡_h—d
 *
pos
;

867 
»t
 = 0;

869 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

870 
	`li¡_fÜ_—ch
(
pos
, &
sbi
->
s_fc_q
) {

871 
™”
 = 
	`li¡_’Œy
(
pos
, 
ext4_šode_šfo
, 
i_fc_li¡
);

872 
	`ext4_£t_šode_¡©e
(&
™”
->
vfs_šode
,

873 
EXT4_STATE_FC_DATA_SUBMIT
);

874 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

875 
»t
 = 
	`jbd2_subm™_šode_d©a
(
jouº®
, 
™”
->
jšode
);

876 ià(
»t
)

877  
»t
;

878 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

880 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

882  
»t
;

883 
	}
}

885 
	$wa™_®l_šode_d©a
(
jouº®_t
 *
jouº®
)

887 
su³r_block
 *
sb
 = (su³r_block *)(
jouº®
->
j_´iv©e
);

888 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

889 
ext4_šode_šfo
 *
pos
, *
n
;

890 
»t
 = 0;

892 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

893 
	`li¡_fÜ_—ch_’Œy_§ã
(
pos
, 
n
, &
sbi
->
s_fc_q
, 
i_fc_li¡
) {

894 ià(!
	`ext4_‹¡_šode_¡©e
(&
pos
->
vfs_šode
,

895 
EXT4_STATE_FC_DATA_SUBMIT
))

897 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

898 
»t
 = 
	`jbd2_wa™_šode_d©a
(
jouº®
, 
pos
->
jšode
);

899 ià(
»t
)

901 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

902 
	`li¡_§ã_»£t_Ãxt
(
pos
, 
n
, 
i_fc_li¡
);

903 
	`li¡_d–_š™
(&
pos
->
i_fc_li¡
);

905 
	`ext4_ş—r_šode_¡©e
(&
pos
->
vfs_šode
,

906 
EXT4_STATE_FC_DATA_SUBMIT
);

908 
	`smp_mb
();

909 #ià(
BITS_PER_LONG
 < 64)

910 
	`wake_up_b™
(&
pos
->
i_¡©e_æags
, 
EXT4_STATE_FC_DATA_SUBMIT
);

912 
	`wake_up_b™
(&
pos
->
i_æags
, 
EXT4_STATE_FC_DATA_SUBMIT
);

915 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

918 
	}
}

920 
	$fc_šode_m©ch
(
šode
 *šode, *
d©a
)

922 ià(
šode
->
i_šo
 !ğ()
d©a
)

925 ià(
šode
->
i_Æšk
)

931 ià(
	`ext4_‹¡_šode_¡©e
(
šode
,

932 
EXT4_STATE_FC_DATA_SUBMIT
)) {

943 
	`ext4_ş—r_šode_¡©e
(

944 
šode
, 
EXT4_STATE_FC_DATA_SUBMIT
);

946 
	`smp_mb
();

947 #ià(
BITS_PER_LONG
 < 64)

948 
	`wake_up_b™
(&
	`EXT4_I
(
šode
)->
i_¡©e_æags
,

949 
EXT4_STATE_FC_DATA_SUBMIT
);

951 
	`wake_up_b™
(&
	`EXT4_I
(
šode
)->
i_æags
,

952 
EXT4_STATE_FC_DATA_SUBMIT
);

956 
	}
}

962 
	$fc_comm™_d’Œy_upd©es
(
jouº®_t
 *
jouº®
,

963 
ext4_fc_d’Œy_upd©e
 *
Ï¡
)

965 
su³r_block
 *
sb
 = (su³r_block *)(
jouº®
->
j_´iv©e
);

966 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

967 
ext4_fc_comm™_hdr
 *
hdr
;

968 
ext4_fc_d’Œy_upd©e
 *
fc_d’Œy
;

969 
šode
 *inode;

970 
bufãr_h—d
 *
bh
;

971 
u8
 *
¡¬t
, *
cur
, *
’d
;

972 
Ën
, 
»t
;

973 
nblks
 = 0;

974 
num_vs
 = 0;

975 
boŞ
 
is_Ï¡
;

977 
»t
 = 
	`jbd2_m­_fc_buf
(
jouº®
, &
bh
);

978 ià(
»t
)

979  -
ECANCELED
;

981 
¡¬t
 = 
cur
 = ((
__u8
 *)
bh
->
b_d©a
 + (
jouº®_h—d”_t
));

982 
’d
 = (
__u8
 *)
bh
->
b_d©a
 + 
jouº®
->
j_blocksize
;

983 
hdr
 = (
ext4_fc_comm™_hdr
 *)
¡¬t
;

985 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

986 !
	`li¡_em±y
(&
sbi
->
s_fc_d’Œy_q
)) {

987 
fc_d’Œy
 = 
	`li¡_fœ¡_’Œy
(

988 &
sbi
->
s_fc_d’Œy_q
, 
ext4_fc_d’Œy_upd©e
,

989 
fcd_li¡
);

990 
	`li¡_d–_š™
(&
fc_d’Œy
->
fcd_li¡
);

991 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

992 ià(!
	`fc_Œy_add_d’Œy_šfo_v
(

993 &
cur
, 
’d
, 
fc_d’Œy
->
fcd_İ
,

994 
fc_d’Œy
->
fcd_·»Á
, fc_d’Œy->
fcd_šo
,

995 
fc_d’Œy
->
fcd_Çme
.
Ën
,

996 
fc_d’Œy
->
fcd_Çme
.
Çme
)) {

997 
	`kmem_ÿche_ä“
(
ext4_fc_d’Œy_ÿch•
, 
fc_d’Œy
);

998  -
ENOSPC
;

1000 
num_vs
++;

1001 
šode
 = 
	`ookup5_nowa™
(
sb
, 
fc_d’Œy
->
fcd_šo
, 
fc_šode_m©ch
,

1002 (*)()
fc_d’Œy
->
fcd_šo
);

1007 ià(
šode
 && 
	`EXT4_I
(šode)->
i_fc_md©a_upd©e
 =ğ
fc_d’Œy
)

1008 
	`EXT4_I
(
šode
)->
i_fc_md©a_upd©e
 = 
NULL
;

1009 ià(
fc_d’Œy
 !ğ
Ï¡
 &&

1010 
fc_d’Œy
->
fcd_İ
 !ğ
EXT4_FC_TAG_CREAT_DENTRY
) {

1011 ià(
šode
)

1012 
	`ut
(
šode
);

1013 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

1014 
	`kmem_ÿche_ä“
(
ext4_fc_d’Œy_ÿch•
, 
fc_d’Œy
);

1017 
is_Ï¡
 = (
fc_d’Œy
 =ğ
Ï¡
);

1018 
	`kmem_ÿche_ä“
(
ext4_fc_d’Œy_ÿch•
, 
fc_d’Œy
);

1019 ià(
	`IS_ERR_OR_NULL
(
šode
))

1026  -
ECANCELED
;

1037 
Ën
 = 
cur
 - 
¡¬t
;

1038 
	`memmove
(
’d
 - 
Ën
, 
¡¬t
,†en);

1039 
»t
 = 
	`fc_wr™e_hdr
(
šode
, 
¡¬t
, 
’d
 - 
Ën
, &
cur
);

1040 ià(
»t
 < 0) {

1041 
	`ut
(
šode
);

1042  
»t
;

1049 
	`memmove
(
cur
, 
’d
 - 
Ën
,†en);

1050 
cur
 = cu¸+ 
Ën
;

1051 ià(
šode
->
i_Æšk
) {

1052 
»t
 = 
	`fc_wr™e_d©a
(
šode
, 
cur
, 
’d
, &cur);

1053 ià(
»t
 < 0) {

1054 
	`ut
(
šode
);

1055  
»t
;

1058 
	`mem£t
(
cur
, 0, 
’d
 - cur);

1059 
hdr
->
fc_num_vs
 = 
	`ıu_to_Ë16
(
num_vs
 + 
»t
);

1060 
hdr
->
fc_csum
 = 
	`ıu_to_Ë32
(

1061 
	`ext4_chksum
(
sbi
, 0, 
¡¬t
, 
’d
 - start));

1062 
	`subm™_fc_bh
(
bh
);

1063 
nblks
++;

1064 ià(!
šode
->
i_Æšk
) {

1065 
	`ext4_ş—r_šode_¡©e
(
šode
,

1066 
EXT4_STATE_FC_DATA_SUBMIT
);

1067 
	`smp_mb
();

1068 #ià(
BITS_PER_LONG
 < 64)

1069 
	`wake_up_b™
(&
	`EXT4_I
(
šode
)->
i_¡©e_æags
,

1070 
EXT4_STATE_FC_DATA_SUBMIT
);

1072 
	`wake_up_b™
(&
	`EXT4_I
(
šode
)->
i_æags
,

1073 
EXT4_STATE_FC_DATA_SUBMIT
);

1075 } ià(!
	`ext4_‹¡_šode_¡©e
(
šode
,

1076 
EXT4_STATE_FC_DATA_SUBMIT
)) {

1077 
»t
 = 
	`jbd2_subm™_šode_d©a
(

1078 
jouº®
, 
	`EXT4_I
(
šode
)->
jšode
);

1079 ià(
»t
 < 0)

1080  
»t
;

1081 
	`ext4_£t_šode_¡©e
(
šode
,

1082 
EXT4_STATE_FC_DATA_SUBMIT
);

1084 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_FC_MDATA_SUBMIT
);

1085 
	`ut
(
šode
);

1086 ià(
is_Ï¡
) {

1087 
bh
 = 
NULL
;

1088 
sk_uÆock
;

1090 
»t
 = 
	`jbd2_m­_fc_buf
(
jouº®
, &
bh
);

1091 ià(
»t
 < 0)

1092  
»t
;

1093 
¡¬t
 = 
cur
 = ((
__u8
 *)
bh
->
b_d©a
 + (
jouº®_h—d”_t
));

1094 
hdr
 = (
ext4_fc_comm™_hdr
 *)
¡¬t
;

1095 
’d
 = (
__u8
 *)
bh
->
b_d©a
 + 
jouº®
->
j_blocksize
;

1096 
	`mem£t
(
¡¬t
, 0, 
’d
 - start);

1097 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

1100 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

1101 
sk_uÆock
:

1102 
	`WARN_ON
(
bh
 !ğ
NULL
);

1103  
nblks
;

1104 
	}
}

1106 
	$ext4_jouº®_fc_ş—nup_cb
(
jouº®_t
 *
jouº®
)

1108 
su³r_block
 *
sb
 = 
jouº®
->
j_´iv©e
;

1109 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1110 
ext4_šode_šfo
 *
™”
;

1111 
ext4_fc_d’Œy_upd©e
 *
fc_d’Œy
;

1113 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

1114 !
	`li¡_em±y
(&
sbi
->
s_fc_q
)) {

1115 
™”
 = 
	`li¡_fœ¡_’Œy
(&
sbi
->
s_fc_q
,

1116 
ext4_šode_šfo
, 
i_fc_li¡
);

1117 
™”
->
i_fc_md©a_upd©e
 = 
NULL
;

1119 
	`li¡_d–_š™
(&
™”
->
i_fc_li¡
);

1120 
	`ext4_ş—r_šode_¡©e
(&
™”
->
vfs_šode
,

1121 
EXT4_STATE_FC_DATA_SUBMIT
);

1122 
	`ext4_ş—r_šode_¡©e
(&
™”
->
vfs_šode
,

1123 
EXT4_STATE_FC_MDATA_SUBMIT
);

1125 
	`smp_mb
();

1126 
	`wake_up_b™
(&
™”
->
i_æags
, 
EXT4_STATE_FC_DATA_SUBMIT
);

1128 
	`INIT_LIST_HEAD
(&
sbi
->
s_fc_q
);

1129 !
	`li¡_em±y
(&
sbi
->
s_fc_d’Œy_q
)) {

1130 
fc_d’Œy
 = 
	`li¡_fœ¡_’Œy
(&
sbi
->
s_fc_d’Œy_q
,

1131 
ext4_fc_d’Œy_upd©e
,

1132 
fcd_li¡
);

1133 
	`li¡_d–_š™
(&
fc_d’Œy
->
fcd_li¡
);

1134 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

1136 ià(
fc_d’Œy
->
fcd_Çme
.
Çme
 &&

1137 
fc_d’Œy
->
fcd_Çme
.
Ën
 > 
DNAME_INLINE_LEN
)

1138 
	`kä“
(
fc_d’Œy
->
fcd_Çme
.
Çme
);

1139 
	`kmem_ÿche_ä“
(
ext4_fc_d’Œy_ÿch•
, 
fc_d’Œy
);

1140 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

1142 
	`INIT_LIST_HEAD
(&
sbi
->
s_fc_d’Œy_q
);

1143 
sbi
->
s_mouÁ_¡©e
 &ğ~
EXT4_FC_INELIGIBLE
;

1144 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

1145 
	`Œaû_ext4_jouº®_fc_¡©s
(
sb
);

1146 
	}
}

1148 
	$ext4_fc_³rfÜm_h¬d_comm™
(
jouº®_t
 *
jouº®
)

1150 
su³r_block
 *
sb
 = (su³r_block *)(
jouº®
->
j_´iv©e
);

1151 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1152 
ext4_šode_šfo
 *
™”
;

1153 
li¡_h—d
 *
pos
;

1154 
šode
 *inode;

1155 
»t
 = 0, 
nblks
 = 0;

1157 
»t
 = 
	`subm™_®l_šode_d©a
(
jouº®
);

1158 ià(
»t
 < 0)

1159  
»t
;

1161 ià(!
	`li¡_em±y
(&
	`EXT4_SB
(
sb
)->
s_fc_d’Œy_q
)) {

1162 
»t
 = 
	`fc_comm™_d’Œy_upd©es
(

1163 
jouº®
, 
	`li¡_Ï¡_’Œy
(

1164 &
	`EXT4_SB
(
sb
)->
s_fc_d’Œy_q
,

1165 
ext4_fc_d’Œy_upd©e
,

1166 
fcd_li¡
));

1167 ià(
»t
 < 0)

1168  
»t
;

1169 
nblks
 = 
»t
;

1172 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

1173 
	`li¡_fÜ_—ch
(
pos
, &
sbi
->
s_fc_q
) {

1174 
™”
 = 
	`li¡_’Œy
(
pos
, 
ext4_šode_šfo
, 
i_fc_li¡
);

1175 
šode
 = &
™”
->
vfs_šode
;

1176 ià(
	`ext4_‹¡_šode_¡©e
(

1177 
šode
, 
EXT4_STATE_FC_MDATA_SUBMIT
) ||

1178 !
	`ext4_‹¡_šode_¡©e
(

1179 
šode
, 
EXT4_STATE_FC_DATA_SUBMIT
))

1182 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

1183 
»t
 = 
	`fc_comm™_d©a_šode
(
jouº®
, 
šode
);

1184 ià(
»t
 < 0)

1185  
»t
;

1186 
nblks
 +ğ
»t
;

1187 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

1189 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

1191 
»t
 = 
	`wa™_®l_šode_d©a
(
jouº®
);

1192 ià(
»t
 < 0)

1193  
»t
;

1195  
nblks
;

1196 
	}
}

1198 
	$ext4_fc_async_comm™_šode
(
jouº®_t
 *
jouº®
, 
tid_t
 
comm™_tid
,

1199 
šode
 *inode)

1201 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1202 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1203 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1204 
nblks
 = 0, 
»t
;

1205 
¡¬t_jiff›s
;

1207 
	`Œaû_ext4_jouº®_fc_comm™_cb_¡¬t
(
sb
);

1208 
¡¬t_jiff›s
 = 
jiff›s
;

1210 ià(!
	`‹¡_İt2
(
sb
, 
JOURNAL_FAST_COMMIT
) ||

1211 (
sbi
->
s_mouÁ_¡©e
 & 
EXT4_FC_INELIGIBLE
)) {

1212 
sbi
->
s_fc_¡©s
.
fc_š–igibË_comm™s
++;

1213 
	`Œaû_ext4_jouº®_fc_comm™_cb_¡İ
(
sb
, 0, "disabled");

1214 
	`Œaû_ext4_jouº®_fc_¡©s
(
sb
);

1215  
	`jbd2_com¶‘e_Œª§ùiÚ
(
jouº®
, 
comm™_tid
);

1218 ià(
	`ext4_is_šode_fc_š–igibË
(
šode
)) {

1219 
sbi
->
s_fc_¡©s
.
fc_š–igibË_comm™s
++;

1220 
	`Œaû_ext4_jouº®_fc_comm™_cb_¡İ
(
sb
, 0, "ineligible");

1221 
	`Œaû_ext4_jouº®_fc_¡©s
(
sb
);

1222  
	`jbd2_com¶‘e_Œª§ùiÚ
(
jouº®
, 
comm™_tid
);

1231 ià(!
	`‹¡_İt2
(
sb
, 
JOURNAL_FC_SOFT_CONSISTENCY
))

1232 
»t
 = 
	`jbd2_¡¬t_async_fc_nowa™
(
jouº®
, 
comm™_tid
);

1234 
»t
 = 
	`jbd2_¡¬t_async_fc_wa™
(
jouº®
, 
comm™_tid
);

1235 ià(
»t
 =ğ-
EALREADY
) {

1236 
	`Œaû_ext4_jouº®_fc_comm™_cb_¡İ
(
sb
, 0, "already");

1237 
	`Œaû_ext4_jouº®_fc_¡©s
(
sb
);

1241 ià(
»t
) {

1242 
sbi
->
s_fc_¡©s
.
fc_š–igibË_comm™s
++;

1243 
	`Œaû_ext4_jouº®_fc_comm™_cb_¡İ
(
sb
, 0, "start");

1244 
	`Œaû_ext4_jouº®_fc_¡©s
(
sb
);

1245  
	`jbd2_com¶‘e_Œª§ùiÚ
(
jouº®
, 
comm™_tid
);

1248 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_FC_MDATA_SUBMIT
)) {

1249 
	`jbd2_¡İ_async_fc
(
jouº®
, 
comm™_tid
);

1250 
	`Œaû_ext4_jouº®_fc_comm™_cb_¡İ
(
sb
, 0, "committed");

1251 
	`Œaû_ext4_jouº®_fc_¡©s
(
sb
);

1255 ià(
ei
->
i_fc_tid
 !ğ
comm™_tid
) {

1256 
	`jbd2_¡İ_async_fc
(
jouº®
, 
comm™_tid
);

1257 
	`Œaû_ext4_jouº®_fc_comm™_cb_¡İ
(
sb
, 0, "stale");

1258 
	`Œaû_ext4_jouº®_fc_¡©s
(
sb
);

1262 ià(!
	`‹¡_İt2
(
sb
, 
JOURNAL_FC_SOFT_CONSISTENCY
)) {

1263 
»t
 = 
	`ext4_fc_³rfÜm_h¬d_comm™
(
jouº®
);

1264 
nblks
 = 
»t
;

1265 } ià(
ei
->
i_fc_md©a_upd©e
) {

1266 
»t
 = 
	`subm™_®l_šode_d©a
(
jouº®
);

1267 ià(
»t
 < 0)

1268 
out
;

1269 
nblks
 = 
	`fc_comm™_d’Œy_upd©es
(
jouº®
,

1270 
ei
->
i_fc_md©a_upd©e
);

1271 ià(
nblks
 < 0) {

1272 
»t
 = 
nblks
;

1273 
out
;

1275 
»t
 = 
	`wa™_®l_šode_d©a
(
jouº®
);

1276 } ià(!
	`li¡_em±y
(&
	`EXT4_I
(
šode
)->
i_fc_li¡
)) {

1277 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_FC_DATA_SUBMIT
);

1278 
»t
 = 
	`jbd2_subm™_šode_d©a
(
jouº®
, 
	`EXT4_I
(
šode
)->
jšode
);

1279 ià(
»t
 < 0)

1280 
out
;

1281 
nblks
 = 
	`fc_comm™_d©a_šode
(
jouº®
, 
šode
);

1282 ià(
nblks
 < 0) {

1283 
»t
 = 
nblks
;

1284 
out
;

1286 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_FC_MDATA_SUBMIT
);

1287 
»t
 = 
	`jbd2_wa™_šode_d©a
(
jouº®
, 
	`EXT4_I
(
šode
)->
jšode
);

1288 
	`¥š_lock
(&
sbi
->
s_fc_lock
);

1290 
	`li¡_d–_š™
(&
	`EXT4_I
(
šode
)->
i_fc_li¡
);

1291 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_FC_DATA_SUBMIT
);

1292 
	`smp_mb
();

1293 #ià(
BITS_PER_LONG
 < 64)

1294 
	`wake_up_b™
(&
	`EXT4_I
(
šode
)->
i_¡©e_æags
,

1295 
EXT4_STATE_FC_DATA_SUBMIT
);

1297 
	`wake_up_b™
(&
	`EXT4_I
(
šode
)->
i_æags
,

1298 
EXT4_STATE_FC_DATA_SUBMIT
);

1300 
	`¥š_uÆock
(&
sbi
->
s_fc_lock
);

1303 
out
:

1304 ià(
»t
 < 0) {

1305 
sbi
->
s_fc_¡©s
.
fc_š–igibË_comm™s
++;

1306 
	`Œaû_ext4_jouº®_fc_comm™_cb_¡İ
(
sb
, 0, "fail1");

1307 
	`jbd2_¡İ_async_fc
(
jouº®
, 
comm™_tid
);

1308 
	`Œaû_ext4_jouº®_fc_¡©s
(
sb
);

1309 
sbi
->
s_mouÁ_¡©e
 &ğ~
EXT4_FC_REPLAY
;

1310  
	`jbd2_com¶‘e_Œª§ùiÚ
(
jouº®
, 
comm™_tid
);

1312 
	`jbd2_wa™_Ú_fc_bufs
(
jouº®
, 
nblks
);

1313 
	`jbd2_¡İ_async_fc
(
jouº®
, 
comm™_tid
);

1315 
	`EXT4_SB
(
sb
)->
s_fc_¡©s
.
fc_num_comm™s
++;

1316 
	`EXT4_SB
(
sb
)->
s_fc_¡©s
.
fc_numblks
 +ğ
nblks
;

1317 
	`Œaû_ext4_jouº®_fc_comm™_cb_¡İ
(
sb
,

1318 
nblks
 < 0 ? 0 :‚blks,

1319 
nblks
 >= 0 ? "success" : "fail2");

1320 
	`Œaû_ext4_jouº®_fc_¡©s
(
sb
);

1321 
sbi
->
s_mouÁ_¡©e
 &ğ~
EXT4_FC_REPLAY
;

1323 
	}
}

1325 
	$ext4_š™_ç¡_comm™
(
su³r_block
 *
sb
, 
jouº®_t
 *
jouº®
)

1333 ià(!
	`‹¡_İt2
(
sb
, 
JOURNAL_FAST_COMMIT
))

1335 
jouº®
->
j_fc_ş—nup_ÿÎback
 = 
ext4_jouº®_fc_ş—nup_cb
;

1336 ià(
	`jbd2_š™_ç¡_comm™
(
jouº®
, 
EXT4_NUM_FC_BLKS
)) {

1337 
	`´_w¬n
("Error whileƒnabling fast commits,urning off.");

1338 
	`ext4_ş—r_ã©u»_ç¡_comm™
(
sb
);

1340 
	}
}

1342 
__š™
 
	$ext4_š™_fc_d’Œy_ÿche
()

1344 
ext4_fc_d’Œy_ÿch•
 = 
	`KMEM_CACHE
(
ext4_fc_d’Œy_upd©e
,

1345 
SLAB_RECLAIM_ACCOUNT
);

1347 ià(
ext4_fc_d’Œy_ÿch•
 =ğ
NULL
)

1348  -
ENOMEM
;

1351 
	}
}

	@ext4_jbd2.h

15 #iâdeà
_EXT4_JBD2_H


16 
	#_EXT4_JBD2_H


	)

18 
	~<lšux/fs.h
>

19 
	~<lšux/jbd2.h
>

20 
	~"ext4.h
"

22 
	#EXT4_JOURNAL
(
šode
è(
	`EXT4_SB
((šode)->
i_sb
)->
s_jouº®
)

	)

36 
	#EXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
) \

37 (
	`ext4_has_ã©u»_ex‹Ás
(
sb
è? 20U : 8U)

	)

43 
	#EXT4_XATTR_TRANS_BLOCKS
 6U

	)

51 
	#EXT4_DATA_TRANS_BLOCKS
(
sb
è(
	`EXT4_SINGLEDATA_TRANS_BLOCKS
(sb) + \

52 
EXT4_XATTR_TRANS_BLOCKS
 - 2 + \

53 
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

60 
	#EXT4_META_TRANS_BLOCKS
(
sb
è(
EXT4_XATTR_TRANS_BLOCKS
 + \

61 
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

69 
	#EXT4_MAX_TRANS_DATA
 64U

	)

78 
	#EXT4_RESERVE_TRANS_BLOCKS
 12U

	)

87 
	#EXT4_INDEX_EXTRA_TRANS_BLOCKS
 12U

	)

89 #ifdeà
CONFIG_QUOTA


92 
	#EXT4_QUOTA_TRANS_BLOCKS
(
sb
è((
	`‹¡_İt
(sb, 
QUOTA
) ||\

93 
	`ext4_has_ã©u»_quÙa
(
sb
)è? 1 : 0)

	)

96 
	#EXT4_QUOTA_INIT_BLOCKS
(
sb
è((
	`‹¡_İt
(sb, 
QUOTA
) ||\

97 
	`ext4_has_ã©u»_quÙa
(
sb
)) ?\

98 (
DQUOT_INIT_ALLOC
*(
	`EXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

99 +3+
DQUOT_INIT_REWRITE
è: 0)

	)

101 
	#EXT4_QUOTA_DEL_BLOCKS
(
sb
è((
	`‹¡_İt
(sb, 
QUOTA
) ||\

102 
	`ext4_has_ã©u»_quÙa
(
sb
)) ?\

103 (
DQUOT_DEL_ALLOC
*(
	`EXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

104 +3+
DQUOT_DEL_REWRITE
è: 0)

	)

106 
	#EXT4_QUOTA_TRANS_BLOCKS
(
sb
è0

	)

107 
	#EXT4_QUOTA_INIT_BLOCKS
(
sb
è0

	)

108 
	#EXT4_QUOTA_DEL_BLOCKS
(
sb
è0

	)

110 
	#EXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
è(
EXT4_MAXQUOTAS
*
	`EXT4_QUOTA_TRANS_BLOCKS
(sb))

	)

111 
	#EXT4_MAXQUOTAS_INIT_BLOCKS
(
sb
è(
EXT4_MAXQUOTAS
*
	`EXT4_QUOTA_INIT_BLOCKS
(sb))

	)

112 
	#EXT4_MAXQUOTAS_DEL_BLOCKS
(
sb
è(
EXT4_MAXQUOTAS
*
	`EXT4_QUOTA_DEL_BLOCKS
(sb))

	)

117 
	#EXT4_HT_MISC
 0

	)

118 
	#EXT4_HT_INODE
 1

	)

119 
	#EXT4_HT_WRITE_PAGE
 2

	)

120 
	#EXT4_HT_MAP_BLOCKS
 3

	)

121 
	#EXT4_HT_DIR
 4

	)

122 
	#EXT4_HT_TRUNCATE
 5

	)

123 
	#EXT4_HT_QUOTA
 6

	)

124 
	#EXT4_HT_RESIZE
 7

	)

125 
	#EXT4_HT_MIGRATE
 8

	)

126 
	#EXT4_HT_MOVE_EXTENTS
 9

	)

127 
	#EXT4_HT_XATTR
 10

	)

128 
	#EXT4_HT_EXT_CONVERT
 11

	)

129 
	#EXT4_HT_MAX
 12

	)

139 
	sext4_jouº®_cb_’Œy
 {

141 
li¡_h—d
 
	mjû_li¡
;

144 (*
	mjû_func
)(
su³r_block
 *
	msb
,

145 
ext4_jouº®_cb_’Œy
 *
	mjû
, 
	m”rÜ
);

171 
šlše
 
	$_ext4_jouº®_ÿÎback_add
(
hªdË_t
 *
hªdË
,

172 
ext4_jouº®_cb_’Œy
 *
jû
)

175 
	`li¡_add_
(&
jû
->
jû_li¡
, &
hªdË
->
h_Œª§ùiÚ
->
t_´iv©e_li¡
);

176 
	}
}

178 
šlše
 
ext4_jouº®_ÿÎback_add
(
hªdË_t
 *
hªdË
,

179 (*
func
)(
su³r_block
 *
sb
,

180 
ext4_jouº®_cb_’Œy
 *
jû
,

181 
rc
),

182 
ext4_jouº®_cb_’Œy
 *
jû
)

184 
ext4_sb_šfo
 *
sbi
 =

185 
	`EXT4_SB
(
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
->
j_´iv©e
);

188 
jû
->
jû_func
 = 
func
;

189 
	`¥š_lock
(&
sbi
->
s_md_lock
);

190 
	`_ext4_jouº®_ÿÎback_add
(
hªdË
, 
jû
);

191 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

192 
	}
}

201 
šlše
 
boŞ
 
	$ext4_jouº®_ÿÎback_Œy_d–
(
hªdË_t
 *
hªdË
,

202 
ext4_jouº®_cb_’Œy
 *
jû
)

204 
boŞ
 
d–‘ed
;

205 
ext4_sb_šfo
 *
sbi
 =

206 
	`EXT4_SB
(
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
->
j_´iv©e
);

208 
	`¥š_lock
(&
sbi
->
s_md_lock
);

209 
d–‘ed
 = !
	`li¡_em±y
(&
jû
->
jû_li¡
);

210 
	`li¡_d–_š™
(&
jû
->
jû_li¡
);

211 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

212  
d–‘ed
;

213 
	}
}

216 
ext4_m¬k_oc_dœty
(
hªdË_t
 *
hªdË
,

217 
šode
 *inode,

218 
ext4_oc
 *
oc
);

225 
ext4_»£rve_šode_wr™e
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

226 
ext4_oc
 *
oc
);

228 
ext4_m¬k_šode_dœty
(
hªdË_t
 *
hªdË
, 
šode
 *inode);

230 
ext4_ex·nd_exŒa_isize
(
šode
 *inode,

231 
Ãw_exŒa_isize
,

232 
ext4_oc
 *
oc
);

236 
__ext4_jouº®_g‘_wr™e_acûss
(cÚ¡ *
wh”e
, 
lše
,

237 
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
);

239 
__ext4_fÜg‘
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
,

240 
is_m‘ad©a
, 
šode
 *inode,

241 
bufãr_h—d
 *
bh
, 
ext4_fsblk_t
 
blockÄ
);

243 
__ext4_jouº®_g‘_ü—‹_acûss
(cÚ¡ *
wh”e
, 
lše
,

244 
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
);

246 
__ext4_hªdË_dœty_m‘ad©a
(cÚ¡ *
wh”e
, 
lše
,

247 
hªdË_t
 *
hªdË
, 
šode
 *inode,

248 
bufãr_h—d
 *
bh
);

250 
__ext4_hªdË_dœty_su³r
(cÚ¡ *
wh”e
, 
lše
,

251 
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
);

253 
	#ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
) \

254 
	`__ext4_jouº®_g‘_wr™e_acûss
(
__func__
, 
__LINE__
, (
hªdË
), (
bh
))

	)

255 
	#ext4_fÜg‘
(
hªdË
, 
is_m‘ad©a
, 
šode
, 
bh
, 
block_Ä
) \

256 
	`__ext4_fÜg‘
(
__func__
, 
__LINE__
, (
hªdË
), (
is_m‘ad©a
), (
šode
), \

257 (
bh
), (
block_Ä
))

	)

258 
	#ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
) \

259 
	`__ext4_jouº®_g‘_ü—‹_acûss
(
__func__
, 
__LINE__
, (
hªdË
), (
bh
))

	)

260 
	#ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
) \

261 
	`__ext4_hªdË_dœty_m‘ad©a
(
__func__
, 
__LINE__
, (
hªdË
), (
šode
), \

262 (
bh
))

	)

263 
	#ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
) \

264 
	`__ext4_hªdË_dœty_su³r
(
__func__
, 
__LINE__
, (
hªdË
), (
sb
))

	)

266 
hªdË_t
 *
__ext4_jouº®_¡¬t_sb
(
su³r_block
 *
sb
, 
lše
,

267 
ty³
, 
blocks
, 
rsv_blocks
);

268 
__ext4_jouº®_¡İ
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
);

270 
	#EXT4_NOJOURNAL_MAX_REF_COUNT
 ((è4096)

	)

274 
šlše
 
	$ext4_hªdË_v®id
(
hªdË_t
 *
hªdË
)

276 ià(()
hªdË
 < 
EXT4_NOJOURNAL_MAX_REF_COUNT
)

279 
	}
}

281 
šlše
 
	$ext4_hªdË_sync
(
hªdË_t
 *
hªdË
)

283 ià(
	`ext4_hªdË_v®id
(
hªdË
))

284 
hªdË
->
h_sync
 = 1;

285 
	}
}

287 
šlše
 
	$ext4_hªdË_is_abÜ‹d
(
hªdË_t
 *
hªdË
)

289 ià(
	`ext4_hªdË_v®id
(
hªdË
))

290  
	`is_hªdË_abÜ‹d
(
hªdË
);

292 
	}
}

294 
šlše
 
	$ext4_hªdË_has_’ough_üed™s
(
hªdË_t
 *
hªdË
, 
Ãeded
)

296 ià(
	`ext4_hªdË_v®id
(
hªdË
è&& hªdË->
h_bufãr_üed™s
 < 
Ãeded
)

299 
	}
}

301 
	#ext4_jouº®_¡¬t_sb
(
sb
, 
ty³
, 
nblocks
) \

302 
	`__ext4_jouº®_¡¬t_sb
((
sb
), 
__LINE__
, (
ty³
), (
nblocks
), 0)

	)

304 
	#ext4_jouº®_¡¬t
(
šode
, 
ty³
, 
nblocks
) \

305 
	`__ext4_jouº®_¡¬t
((
šode
), 
__LINE__
, (
ty³
), (
nblocks
), 0)

	)

307 
	#ext4_jouº®_¡¬t_w™h_»£rve
(
šode
, 
ty³
, 
blocks
, 
rsv_blocks
) \

308 
	`__ext4_jouº®_¡¬t
((
šode
), 
__LINE__
, (
ty³
), (
blocks
), (
rsv_blocks
))

	)

310 
šlše
 
hªdË_t
 *
	$__ext4_jouº®_¡¬t
(
šode
 *inode,

311 
lše
, 
ty³
,

312 
blocks
, 
rsv_blocks
)

314  
	`__ext4_jouº®_¡¬t_sb
(
šode
->
i_sb
, 
lše
, 
ty³
, 
blocks
,

315 
rsv_blocks
);

316 
	}
}

318 
	#ext4_jouº®_¡İ
(
hªdË
) \

319 
	`__ext4_jouº®_¡İ
(
__func__
, 
__LINE__
, (
hªdË
))

	)

321 
	#ext4_jouº®_¡¬t_»£rved
(
hªdË
, 
ty³
) \

322 
	`__ext4_jouº®_¡¬t_»£rved
((
hªdË
), 
__LINE__
, (
ty³
))

	)

324 
hªdË_t
 *
__ext4_jouº®_¡¬t_»£rved
(hªdË_ˆ*
hªdË
, 
lše
,

325 
ty³
);

327 
šlše
 
	$ext4_jouº®_ä“_»£rved
(
hªdË_t
 *
hªdË
)

329 ià(
	`ext4_hªdË_v®id
(
hªdË
))

330 
	`jbd2_jouº®_ä“_»£rved
(
hªdË
);

331 
	}
}

333 
šlše
 
hªdË_t
 *
	$ext4_jouº®_cu¼’t_hªdË
()

335  
	`jouº®_cu¼’t_hªdË
();

336 
	}
}

338 
šlše
 
	$ext4_jouº®_ex‹nd
(
hªdË_t
 *
hªdË
, 
nblocks
)

340 ià(
	`ext4_hªdË_v®id
(
hªdË
))

341  
	`jbd2_jouº®_ex‹nd
(
hªdË
, 
nblocks
);

343 
	}
}

345 
šlše
 
	$ext4_jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
)

347 ià(
	`ext4_hªdË_v®id
(
hªdË
))

348  
	`jbd2_jouº®_»¡¬t
(
hªdË
, 
nblocks
);

350 
	}
}

352 
šlše
 
	$ext4_jouº®_blocks_³r_·ge
(
šode
 *inode)

354 ià(
	`EXT4_JOURNAL
(
šode
è!ğ
NULL
)

355  
	`jbd2_jouº®_blocks_³r_·ge
(
šode
);

357 
	}
}

359 
šlše
 
	$ext4_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

361 ià(
jouº®
)

362  
	`jbd2_jouº®_fÜû_comm™
(
jouº®
);

364 
	}
}

366 
šlše
 
	$ext4_jbd2_šode_add_wr™e
(
hªdË_t
 *
hªdË
,

367 
šode
 *inode)

369 ià(
	`ext4_hªdË_v®id
(
hªdË
))

370  
	`jbd2_jouº®_šode_add_wr™e
(
hªdË
,

371 
	`EXT4_I
(
šode
)->
jšode
);

373 
	}
}

375 
šlše
 
	$ext4_jbd2_šode_add_wa™
(
hªdË_t
 *
hªdË
,

376 
šode
 *inode)

378 ià(
	`ext4_hªdË_v®id
(
hªdË
))

379  
	`jbd2_jouº®_šode_add_wa™
(
hªdË
,

380 
	`EXT4_I
(
šode
)->
jšode
);

382 
	}
}

384 
šlše
 
	$ext4_upd©e_šode_fsync_Œªs
(
hªdË_t
 *
hªdË
,

385 
šode
 *inode,

386 
d©async
)

388 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

390 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

391 
ei
->
i_sync_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

392 ià(
d©async
)

393 
ei
->
i_d©async_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

395 
	}
}

398 
ext4_fÜû_comm™
(
su³r_block
 *
sb
);

403 
	#EXT4_INODE_JOURNAL_DATA_MODE
 0x01

	)

404 
	#EXT4_INODE_ORDERED_DATA_MODE
 0x02

	)

405 
	#EXT4_INODE_WRITEBACK_DATA_MODE
 0x04

	)

407 
šlše
 
	$ext4_šode_jouº®_mode
(
šode
 *inode)

409 ià(
	`EXT4_JOURNAL
(
šode
è=ğ
NULL
)

410  
EXT4_INODE_WRITEBACK_DATA_MODE
;

412 ià(!
	`S_ISREG
(
šode
->
i_mode
) ||

413 
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
 ||

414 (
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_JOURNAL_DATA
) &&

415 !
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
))) {

417 ià(
	`S_ISREG
(
šode
->
i_mode
è&& 
	`ext4_’üy±ed_šode
(inode))

418  
EXT4_INODE_ORDERED_DATA_MODE
;

419  
EXT4_INODE_JOURNAL_DATA_MODE
;

421 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
)

422  
EXT4_INODE_ORDERED_DATA_MODE
;

423 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_WRITEBACK_DATA
)

424  
EXT4_INODE_WRITEBACK_DATA_MODE
;

425 
	`BUG
();

426 
	}
}

428 
šlše
 
	$ext4_should_jouº®_d©a
(
šode
 *inode)

430  
	`ext4_šode_jouº®_mode
(
šode
è& 
EXT4_INODE_JOURNAL_DATA_MODE
;

431 
	}
}

433 
šlše
 
	$ext4_should_Üd”_d©a
(
šode
 *inode)

435  
	`ext4_šode_jouº®_mode
(
šode
è& 
EXT4_INODE_ORDERED_DATA_MODE
;

436 
	}
}

438 
šlše
 
	$ext4_should_wr™eback_d©a
(
šode
 *inode)

440  
	`ext4_šode_jouº®_mode
(
šode
è& 
EXT4_INODE_WRITEBACK_DATA_MODE
;

441 
	}
}

452 
šlše
 
	$ext4_should_diÜ—d_nŞock
(
šode
 *inode)

454 ià(!
	`‹¡_İt
(
šode
->
i_sb
, 
DIOREAD_NOLOCK
))

456 ià(!
	`S_ISREG
(
šode
->
i_mode
))

458 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

460 ià(
	`ext4_should_jouº®_d©a
(
šode
))

463 
	}
}

468 
	#EXT4_FC_MAGIC
 0xE2540090

	)

470 
	#EXT4_NUM_FC_BLKS
 128

	)

472 
	sext4_fc_comm™_hdr
 {

474 
__Ë32
 
	mfc_magic
;

476 
__u8
 
	mfc_ã©u»s
;

478 
__Ë16
 
	mfc_num_vs
;

480 
__Ë32
 
	mfc_šo
;

482 
__Ë32
 
	mfc_csum
;

486 
	sext4_fc_
 {

487 
__Ë16
 
	mfc_g
;

488 
__Ë16
 
	mfc_Ën
;

496 
	sext4_fc_d’Œy_šfo
 {

497 
__Ë32
 
	mfc_·»Á_šo
;

498 
__Ë32
 
	mfc_šo
;

499 
u8
 
	mfc_dÇme
[0];

506 
	sext4_fc_Ìªge
 {

507 
__Ë32
 
	mfc_lblk
;

508 
__Ë32
 
	mfc_Ën
;

511 
ext4_š™_ç¡_comm™
(
su³r_block
 *
sb
, 
jouº®_t
 *
jouº®
);

512 
ext4_š™_šode_fc_šfo
(
šode
 *inode);

513 
ext4_fc_Œack_¿nge
(
šode
 *šode, 
ext4_lblk_t
 
¡¬t
,

514 
ext4_lblk_t
 
’d
);

515 
ext4_fc_Œack_uÆšk
(
šode
 *šode, 
d’Œy
 *dentry);

516 
ext4_fc_Œack_lšk
(
šode
 *šode, 
d’Œy
 *dentry);

517 
ext4_fc_Œack_ü—‹
(
šode
 *šode, 
d’Œy
 *dentry);

518 
__š™
 
ext4_š™_fc_d’Œy_ÿche
();

519 
ext4_fc_Œack_šode
(
šode
 *inode);

520 
ext4_fc_m¬k_š–igibË
(
šode
 *šode, 
»asÚ
);

521 
ext4_fc_di§bË
(
su³r_block
 *
sb
, 
»asÚ
);

522 
ext4_fc_d–
(
šode
 *inode);

	@extents.c

32 
	~<lšux/fs.h
>

33 
	~<lšux/time.h
>

34 
	~<lšux/jbd2.h
>

35 
	~<lšux/highuid.h
>

36 
	~<lšux/·gem­.h
>

37 
	~<lšux/quÙaİs.h
>

38 
	~<lšux/¡ršg.h
>

39 
	~<lšux/¦ab.h
>

40 
	~<lšux/uacûss.h
>

41 
	~<lšux/f›m­.h
>

42 
	~<lšux/backšg-dev.h
>

43 
	~"ext4_jbd2.h
"

44 
	~"ext4_ex‹Ás.h
"

45 
	~"x©Œ.h
"

47 
	~<Œaû/ev’ts/ext4.h
>

52 
	#EXT4_EXT_MAY_ZEROOUT
 0x1

	)

54 
	#EXT4_EXT_MARK_UNWRIT1
 0x2

	)

55 
	#EXT4_EXT_MARK_UNWRIT2
 0x4

	)

57 
	#EXT4_EXT_DATA_VALID1
 0x8

	)

58 
	#EXT4_EXT_DATA_VALID2
 0x10

	)

60 
__Ë32
 
	$ext4_ex‹Á_block_csum
(
šode
 *inode,

61 
ext4_ex‹Á_h—d”
 *
eh
)

63 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

64 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

65 
__u32
 
csum
;

67 
csum
 = 
	`ext4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
eh
,

68 
	`EXT4_EXTENT_TAIL_OFFSET
(
eh
));

69  
	`ıu_to_Ë32
(
csum
);

70 
	}
}

72 
	$ext4_ex‹Á_block_csum_v”ify
(
šode
 *inode,

73 
ext4_ex‹Á_h—d”
 *
eh
)

75 
ext4_ex‹Á_
 *
‘
;

77 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

80 
‘
 = 
	`fšd_ext4_ex‹Á_
(
eh
);

81 ià(
‘
->
‘_checksum
 !ğ
	`ext4_ex‹Á_block_csum
(
šode
, 
eh
))

84 
	}
}

86 
	$ext4_ex‹Á_block_csum_£t
(
šode
 *inode,

87 
ext4_ex‹Á_h—d”
 *
eh
)

89 
ext4_ex‹Á_
 *
‘
;

91 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

94 
‘
 = 
	`fšd_ext4_ex‹Á_
(
eh
);

95 
‘
->
‘_checksum
 = 
	`ext4_ex‹Á_block_csum
(
šode
, 
eh
);

96 
	}
}

98 
ext4_¥l™_ex‹Á
(
hªdË_t
 *
hªdË
,

99 
šode
 *inode,

100 
ext4_ext_·th
 **
µ©h
,

101 
ext4_m­_blocks
 *
m­
,

102 
¥l™_æag
,

103 
æags
);

105 
ext4_¥l™_ex‹Á_©
(
hªdË_t
 *
hªdË
,

106 
šode
 *inode,

107 
ext4_ext_·th
 **
µ©h
,

108 
ext4_lblk_t
 
¥l™
,

109 
¥l™_æag
,

110 
æags
);

112 
ext4_fšd_d–ayed_ex‹Á
(
šode
 *inode,

113 
ex‹Á_¡©us
 *
Ãwes
);

115 
	$ext4_ext_Œunÿ‹_ex‹nd_»¡¬t
(
hªdË_t
 *
hªdË
,

116 
šode
 *inode,

117 
Ãeded
)

119 
”r
;

121 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

123 ià(
hªdË
->
h_bufãr_üed™s
 >ğ
Ãeded
)

129 
Ãeded
 += 3;

130 
”r
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
Ãeded
 - hªdË->
h_bufãr_üed™s
);

131 ià(
”r
 <= 0)

132  
”r
;

133 
”r
 = 
	`ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË
, 
šode
, 
Ãeded
);

134 ià(
”r
 == 0)

135 
”r
 = -
EAGAIN
;

137  
”r
;

138 
	}
}

145 
	$ext4_ext_g‘_acûss
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

146 
ext4_ext_·th
 *
·th
)

148 ià(
·th
->
p_bh
) {

150 
	`BUFFER_TRACE
(
·th
->
p_bh
, "get_write_access");

151  
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
·th
->
p_bh
);

156 
	}
}

164 
	$__ext4_ext_dœty
(cÚ¡ *
wh”e
, 
lše
, 
hªdË_t
 *
hªdË
,

165 
šode
 *šode, 
ext4_ext_·th
 *
·th
)

167 
”r
;

169 
	`WARN_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

170 ià(
·th
->
p_bh
) {

171 
	`ext4_ex‹Á_block_csum_£t
(
šode
, 
	`ext_block_hdr
(
·th
->
p_bh
));

173 
”r
 = 
	`__ext4_hªdË_dœty_m‘ad©a
(
wh”e
, 
lše
, 
hªdË
,

174 
šode
, 
·th
->
p_bh
);

177 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

179  
”r
;

180 
	}
}

182 
ext4_fsblk_t
 
	$ext4_ext_fšd_gßl
(
šode
 *inode,

183 
ext4_ext_·th
 *
·th
,

184 
ext4_lblk_t
 
block
)

186 ià(
·th
) {

187 
d•th
 = 
·th
->
p_d•th
;

188 
ext4_ex‹Á
 *
ex
;

207 
ex
 = 
·th
[
d•th
].
p_ext
;

208 ià(
ex
) {

209 
ext4_fsblk_t
 
ext_pblk
 = 
	`ext4_ext_pblock
(
ex
);

210 
ext4_lblk_t
 
ext_block
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

212 ià(
block
 > 
ext_block
)

213  
ext_pblk
 + (
block
 - 
ext_block
);

215  
ext_pblk
 - (
ext_block
 - 
block
);

220 ià(
·th
[
d•th
].
p_bh
)

221  
·th
[
d•th
].
p_bh
->
b_blockÄ
;

225  
	`ext4_šode_to_gßl_block
(
šode
);

226 
	}
}

231 
ext4_fsblk_t


232 
	$ext4_ext_Ãw_m‘a_block
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

233 
ext4_ext_·th
 *
·th
,

234 
ext4_ex‹Á
 *
ex
, *
”r
, 
æags
)

236 
ext4_fsblk_t
 
gßl
, 
Ãwblock
;

238 
gßl
 = 
	`ext4_ext_fšd_gßl
(
šode
, 
·th
, 
	`Ë32_to_ıu
(
ex
->
“_block
));

239 
Ãwblock
 = 
	`ext4_Ãw_m‘a_blocks
(
hªdË
, 
šode
, 
gßl
, 
æags
,

240 
NULL
, 
”r
);

241  
Ãwblock
;

242 
	}
}

244 
šlše
 
	$ext4_ext_¥aû_block
(
šode
 *šode, 
check
)

246 
size
;

248 
size
 = (
šode
->
i_sb
->
s_blocksize
 - (
ext4_ex‹Á_h—d”
))

249 / (
ext4_ex‹Á
);

250 #ifdeà
AGGRESSIVE_TEST


251 ià(!
check
 && 
size
 > 6)

252 
size
 = 6;

254  
size
;

255 
	}
}

257 
šlše
 
	$ext4_ext_¥aû_block_idx
(
šode
 *šode, 
check
)

259 
size
;

261 
size
 = (
šode
->
i_sb
->
s_blocksize
 - (
ext4_ex‹Á_h—d”
))

262 / (
ext4_ex‹Á_idx
);

263 #ifdeà
AGGRESSIVE_TEST


264 ià(!
check
 && 
size
 > 5)

265 
size
 = 5;

267  
size
;

268 
	}
}

270 
šlše
 
	$ext4_ext_¥aû_roÙ
(
šode
 *šode, 
check
)

272 
size
;

274 
size
 = (
	`EXT4_I
(
šode
)->
i_d©a
);

275 
size
 -ğ(
ext4_ex‹Á_h—d”
);

276 
size
 /ğ(
ext4_ex‹Á
);

277 #ifdeà
AGGRESSIVE_TEST


278 ià(!
check
 && 
size
 > 3)

279 
size
 = 3;

281  
size
;

282 
	}
}

284 
šlše
 
	$ext4_ext_¥aû_roÙ_idx
(
šode
 *šode, 
check
)

286 
size
;

288 
size
 = (
	`EXT4_I
(
šode
)->
i_d©a
);

289 
size
 -ğ(
ext4_ex‹Á_h—d”
);

290 
size
 /ğ(
ext4_ex‹Á_idx
);

291 #ifdeà
AGGRESSIVE_TEST


292 ià(!
check
 && 
size
 > 4)

293 
size
 = 4;

295  
size
;

296 
	}
}

298 
šlše
 

299 
	$ext4_fÜû_¥l™_ex‹Á_©
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

300 
ext4_ext_·th
 **
µ©h
, 
ext4_lblk_t
 
lblk
,

301 
noç
)

303 
ext4_ext_·th
 *
·th
 = *
µ©h
;

304 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
·th
[·th->
p_d•th
].
p_ext
);

306  
	`ext4_¥l™_ex‹Á_©
(
hªdË
, 
šode
, 
µ©h
, 
lblk
, 
unwr™‹n
 ?

307 
EXT4_EXT_MARK_UNWRIT1
|
EXT4_EXT_MARK_UNWRIT2
 : 0,

308 
EXT4_EX_NOCACHE
 | 
EXT4_GET_BLOCKS_PRE_IO
 |

309 (
noç
 ? 
EXT4_GET_BLOCKS_METADATA_NOFAIL
:0));

310 
	}
}

317 
	$ext4_ext_ÿlc_m‘ad©a_amouÁ
(
šode
 *šode, 
ext4_lblk_t
 
lblock
)

319 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

320 
idxs
;

322 
idxs
 = ((
šode
->
i_sb
->
s_blocksize
 - (
ext4_ex‹Á_h—d”
))

323 / (
ext4_ex‹Á_idx
));

333 ià(
ei
->
i_da_m‘ad©a_ÿlc_Ën
 &&

334 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
+1 =ğ
lblock
) {

335 
num
 = 0;

337 ià((
ei
->
i_da_m‘ad©a_ÿlc_Ën
 % 
idxs
) == 0)

338 
num
++;

339 ià((
ei
->
i_da_m‘ad©a_ÿlc_Ën
 % (
idxs
*idxs)) == 0)

340 
num
++;

341 ià((
ei
->
i_da_m‘ad©a_ÿlc_Ën
 % (
idxs
*idxs*idxs)) == 0) {

342 
num
++;

343 
ei
->
i_da_m‘ad©a_ÿlc_Ën
 = 0;

345 
ei
->
i_da_m‘ad©a_ÿlc_Ën
++;

346 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
++;

347  
num
;

354 
ei
->
i_da_m‘ad©a_ÿlc_Ën
 = 1;

355 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
 = 
lblock
;

356  
	`ext_d•th
(
šode
) + 1;

357 
	}
}

360 
	$ext4_ext_max_’Œ›s
(
šode
 *šode, 
d•th
)

362 
max
;

364 ià(
d•th
 =ğ
	`ext_d•th
(
šode
)) {

365 ià(
d•th
 == 0)

366 
max
 = 
	`ext4_ext_¥aû_roÙ
(
šode
, 1);

368 
max
 = 
	`ext4_ext_¥aû_roÙ_idx
(
šode
, 1);

370 ià(
d•th
 == 0)

371 
max
 = 
	`ext4_ext_¥aû_block
(
šode
, 1);

373 
max
 = 
	`ext4_ext_¥aû_block_idx
(
šode
, 1);

376  
max
;

377 
	}
}

379 
	$ext4_v®id_ex‹Á
(
šode
 *šode, 
ext4_ex‹Á
 *
ext
)

381 
ext4_fsblk_t
 
block
 = 
	`ext4_ext_pblock
(
ext
);

382 
Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ext
);

383 
ext4_lblk_t
 
lblock
 = 
	`Ë32_to_ıu
(
ext
->
“_block
);

390 ià(
lblock
 + 
Ën
 <=†block)

392  
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
), 
block
, 
Ën
);

393 
	}
}

395 
	$ext4_v®id_ex‹Á_idx
(
šode
 *inode,

396 
ext4_ex‹Á_idx
 *
ext_idx
)

398 
ext4_fsblk_t
 
block
 = 
	`ext4_idx_pblock
(
ext_idx
);

400  
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
), 
block
, 1);

401 
	}
}

403 
	$ext4_v®id_ex‹Á_’Œ›s
(
šode
 *inode,

404 
ext4_ex‹Á_h—d”
 *
eh
,

405 
d•th
)

407 
’Œ›s
;

408 ià(
eh
->
eh_’Œ›s
 == 0)

411 
’Œ›s
 = 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
);

413 ià(
d•th
 == 0) {

415 
ext4_ex‹Á
 *
ext
 = 
	`EXT_FIRST_EXTENT
(
eh
);

416 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

417 
ext4_fsblk_t
 
pblock
 = 0;

418 
ext4_lblk_t
 
lblock
 = 0;

419 
ext4_lblk_t
 
´ev
 = 0;

420 
Ën
 = 0;

421 
’Œ›s
) {

422 ià(!
	`ext4_v®id_ex‹Á
(
šode
, 
ext
))

426 
lblock
 = 
	`Ë32_to_ıu
(
ext
->
“_block
);

427 
Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ext
);

428 ià((
lblock
 <ğ
´ev
) &&…rev) {

429 
pblock
 = 
	`ext4_ext_pblock
(
ext
);

430 
es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
pblock
);

433 
ext
++;

434 
’Œ›s
--;

435 
´ev
 = 
lblock
 + 
Ën
 - 1;

438 
ext4_ex‹Á_idx
 *
ext_idx
 = 
	`EXT_FIRST_INDEX
(
eh
);

439 
’Œ›s
) {

440 ià(!
	`ext4_v®id_ex‹Á_idx
(
šode
, 
ext_idx
))

442 
ext_idx
++;

443 
’Œ›s
--;

447 
	}
}

449 
	$__ext4_ext_check
(cÚ¡ *
funùiÚ
, 
lše
,

450 
šode
 *šode, 
ext4_ex‹Á_h—d”
 *
eh
,

451 
d•th
, 
ext4_fsblk_t
 
pblk
)

453 cÚ¡ *
”rÜ_msg
;

454 
max
 = 0, 
”r
 = -
EFSCORRUPTED
;

456 ià(
	`uÆik–y
(
eh
->
eh_magic
 !ğ
EXT4_EXT_MAGIC
)) {

457 
”rÜ_msg
 = "invalid magic";

458 
cÜru±ed
;

460 ià(
	`uÆik–y
(
	`Ë16_to_ıu
(
eh
->
eh_d•th
è!ğ
d•th
)) {

461 
”rÜ_msg
 = "unexpectedƒh_depth";

462 
cÜru±ed
;

464 ià(
	`uÆik–y
(
eh
->
eh_max
 == 0)) {

465 
”rÜ_msg
 = "invalidƒh_max";

466 
cÜru±ed
;

468 
max
 = 
	`ext4_ext_max_’Œ›s
(
šode
, 
d•th
);

469 ià(
	`uÆik–y
(
	`Ë16_to_ıu
(
eh
->
eh_max
è> 
max
)) {

470 
”rÜ_msg
 = "too†argeƒh_max";

471 
cÜru±ed
;

473 ià(
	`uÆik–y
(
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
è>†e16_to_ıuÓh->
eh_max
))) {

474 
”rÜ_msg
 = "invalidƒh_entries";

475 
cÜru±ed
;

477 ià(!
	`ext4_v®id_ex‹Á_’Œ›s
(
šode
, 
eh
, 
d•th
)) {

478 
”rÜ_msg
 = "invalidƒxtentƒntries";

479 
cÜru±ed
;

481 ià(
	`uÆik–y
(
d•th
 > 32)) {

482 
”rÜ_msg
 = "too†argeƒh_depth";

483 
cÜru±ed
;

486 ià(
	`ext_d•th
(
šode
è!ğ
d•th
 &&

487 !
	`ext4_ex‹Á_block_csum_v”ify
(
šode
, 
eh
)) {

488 
”rÜ_msg
 = "extentree corrupted";

489 
”r
 = -
EFSBADCRC
;

490 
cÜru±ed
;

494 
cÜru±ed
:

495 
	`ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

498 (è
pblk
, 
”rÜ_msg
,

499 
	`Ë16_to_ıu
(
eh
->
eh_magic
),

500 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
),†e16_to_ıuÓh->
eh_max
),

501 
max
, 
	`Ë16_to_ıu
(
eh
->
eh_d•th
), 
d•th
);

502  
”r
;

503 
	}
}

505 
	#ext4_ext_check
(
šode
, 
eh
, 
d•th
, 
pblk
) \

506 
	`__ext4_ext_check
(
__func__
, 
__LINE__
, (
šode
), (
eh
), (
d•th
), (
pblk
))

	)

508 
	$ext4_ext_check_šode
(
šode
 *inode)

510  
	`ext4_ext_check
(
šode
, 
	`ext_šode_hdr
(šode), 
	`ext_d•th
(inode), 0);

511 
	}
}

513 
bufãr_h—d
 *

514 
	$__»ad_ex‹Á_Œ“_block
(cÚ¡ *
funùiÚ
, 
lše
,

515 
šode
 *šode, 
ext4_fsblk_t
 
pblk
, 
d•th
,

516 
æags
)

518 
bufãr_h—d
 *
bh
;

519 
”r
;

521 
bh
 = 
	`sb_g‘blk_gå
(
šode
->
i_sb
, 
pblk
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

522 ià(
	`uÆik–y
(!
bh
))

523  
	`ERR_PTR
(-
ENOMEM
);

525 ià(!
	`bh_u±od©e_Ü_lock
(
bh
)) {

526 
	`Œaû_ext4_ext_lßd_ex‹Á
(
šode
, 
pblk
, 
_RET_IP_
);

527 
”r
 = 
	`bh_subm™_»ad
(
bh
);

528 ià(
”r
 < 0)

529 
”rout
;

531 ià(
	`bufãr_v”if›d
(
bh
è&& !(
æags
 & 
EXT4_EX_FORCE_CACHE
))

532  
bh
;

533 
”r
 = 
	`__ext4_ext_check
(
funùiÚ
, 
lše
, 
šode
,

534 
	`ext_block_hdr
(
bh
), 
d•th
, 
pblk
);

535 ià(
”r
)

536 
”rout
;

537 
	`£t_bufãr_v”if›d
(
bh
);

541 ià(!(
æags
 & 
EXT4_EX_NOCACHE
è&& 
d•th
 == 0) {

542 
ext4_ex‹Á_h—d”
 *
eh
 = 
	`ext_block_hdr
(
bh
);

543 
ext4_ex‹Á
 *
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

544 
ext4_lblk_t
 
´ev
 = 0;

545 
i
;

547 
i
 = 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); i > 0; i--, 
ex
++) {

548 
¡©us
 = 
EXTENT_STATUS_WRITTEN
;

549 
ext4_lblk_t
 
lblk
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

550 
Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

552 ià(
´ev
 && (´ev !ğ
lblk
))

553 
	`ext4_es_ÿche_ex‹Á
(
šode
, 
´ev
,

554 
lblk
 - 
´ev
, ~0,

555 
EXTENT_STATUS_HOLE
);

557 ià(
	`ext4_ext_is_unwr™‹n
(
ex
))

558 
¡©us
 = 
EXTENT_STATUS_UNWRITTEN
;

559 
	`ext4_es_ÿche_ex‹Á
(
šode
, 
lblk
, 
Ën
,

560 
	`ext4_ext_pblock
(
ex
), 
¡©us
);

561 
´ev
 = 
lblk
 + 
Ën
;

564  
bh
;

565 
”rout
:

566 
	`put_bh
(
bh
);

567  
	`ERR_PTR
(
”r
);

569 
	}
}

571 
	#»ad_ex‹Á_Œ“_block
(
šode
, 
pblk
, 
d•th
, 
æags
) \

572 
	`__»ad_ex‹Á_Œ“_block
(
__func__
, 
__LINE__
, (
šode
), (
pblk
), \

573 (
d•th
), (
æags
))

	)

579 
	$ext4_ext_´eÿche
(
šode
 *inode)

581 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

582 
ext4_ext_·th
 *
·th
 = 
NULL
;

583 
bufãr_h—d
 *
bh
;

584 
i
 = 0, 
d•th
, 
»t
 = 0;

586 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

589 
	`down_»ad
(&
ei
->
i_d©a_£m
);

590 
d•th
 = 
	`ext_d•th
(
šode
);

592 
·th
 = 
	`kz®loc
((
ext4_ext_·th
è* (
d•th
 + 1),

593 
GFP_NOFS
);

594 ià(
·th
 =ğ
NULL
) {

595 
	`up_»ad
(&
ei
->
i_d©a_£m
);

596  -
ENOMEM
;

600 ià(
d•th
 == 0)

601 
out
;

602 
·th
[0].
p_hdr
 = 
	`ext_šode_hdr
(
šode
);

603 
»t
 = 
	`ext4_ext_check
(
šode
, 
·th
[0].
p_hdr
, 
d•th
, 0);

604 ià(
»t
)

605 
out
;

606 
·th
[0].
p_idx
 = 
	`EXT_FIRST_INDEX
Õ©h[0].
p_hdr
);

607 
i
 >= 0) {

612 ià((
i
 =ğ
d•th
) ||

613 
·th
[
i
].
p_idx
 > 
	`EXT_LAST_INDEX
Õ©h[i].
p_hdr
)) {

614 
	`b»l£
(
·th
[
i
].
p_bh
);

615 
·th
[
i
].
p_bh
 = 
NULL
;

616 
i
--;

619 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
,

620 
	`ext4_idx_pblock
(
·th
[
i
].
p_idx
++),

621 
d•th
 - 
i
 - 1,

622 
EXT4_EX_FORCE_CACHE
);

623 ià(
	`IS_ERR
(
bh
)) {

624 
»t
 = 
	`PTR_ERR
(
bh
);

627 
i
++;

628 
·th
[
i
].
p_bh
 = 
bh
;

629 
·th
[
i
].
p_hdr
 = 
	`ext_block_hdr
(
bh
);

630 
·th
[
i
].
p_idx
 = 
	`EXT_FIRST_INDEX
Õ©h[i].
p_hdr
);

632 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_PRECACHED
);

633 
out
:

634 
	`up_»ad
(&
ei
->
i_d©a_£m
);

635 
	`ext4_ext_drİ_»fs
(
·th
);

636 
	`kä“
(
·th
);

637  
»t
;

638 
	}
}

640 #ifdeà
EXT_DEBUG


641 
	$ext4_ext_show_·th
(
šode
 *šode, 
ext4_ext_·th
 *
·th
)

643 
k
, 
l
 = 
·th
->
p_d•th
;

645 
	`ext_debug
("path:");

646 
k
 = 0; k <ğ
l
; k++, 
·th
++) {

647 ià(
·th
->
p_idx
) {

648 
	`ext_debug
(" %d->%Îu", 
	`Ë32_to_ıu
(
·th
->
p_idx
->
ei_block
),

649 
	`ext4_idx_pblock
(
·th
->
p_idx
));

650 } ià(
·th
->
p_ext
) {

651 
	`ext_debug
(" %d:[%d]%d:%llu ",

652 
	`Ë32_to_ıu
(
·th
->
p_ext
->
“_block
),

653 
	`ext4_ext_is_unwr™‹n
(
·th
->
p_ext
),

654 
	`ext4_ext_g‘_aùu®_Ën
(
·th
->
p_ext
),

655 
	`ext4_ext_pblock
(
·th
->
p_ext
));

657 
	`ext_debug
(" []");

659 
	`ext_debug
("\n");

660 
	}
}

662 
	$ext4_ext_show_Ëaf
(
šode
 *šode, 
ext4_ext_·th
 *
·th
)

664 
d•th
 = 
	`ext_d•th
(
šode
);

665 
ext4_ex‹Á_h—d”
 *
eh
;

666 
ext4_ex‹Á
 *
ex
;

667 
i
;

669 ià(!
·th
)

672 
eh
 = 
·th
[
d•th
].
p_hdr
;

673 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

675 
	`ext_debug
("Di¥Ïyšg†—àex‹Á fÜ inod%lu\n", 
šode
->
i_šo
);

677 
i
 = 0; i < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); i++, 
ex
++) {

678 
	`ext_debug
("%d:[%d]%d:%Îu ", 
	`Ë32_to_ıu
(
ex
->
“_block
),

679 
	`ext4_ext_is_unwr™‹n
(
ex
),

680 
	`ext4_ext_g‘_aùu®_Ën
(
ex
), 
	`ext4_ext_pblock
(ex));

682 
	`ext_debug
("\n");

683 
	}
}

685 
	$ext4_ext_show_move
(
šode
 *šode, 
ext4_ext_·th
 *
·th
,

686 
ext4_fsblk_t
 
Ãwblock
, 
Ëv–
)

688 
d•th
 = 
	`ext_d•th
(
šode
);

689 
ext4_ex‹Á
 *
ex
;

691 ià(
d•th
 !ğ
Ëv–
) {

692 
ext4_ex‹Á_idx
 *
idx
;

693 
idx
 = 
·th
[
Ëv–
].
p_idx
;

694 
idx
 <ğ
	`EXT_MAX_INDEX
(
·th
[
Ëv–
].
p_hdr
)) {

695 
	`ext_debug
("%d: mov%d:%Îu iÀÃw index %Îu\n", 
Ëv–
,

696 
	`Ë32_to_ıu
(
idx
->
ei_block
),

697 
	`ext4_idx_pblock
(
idx
),

698 
Ãwblock
);

699 
idx
++;

705 
ex
 = 
·th
[
d•th
].
p_ext
;

706 
ex
 <ğ
	`EXT_MAX_EXTENT
(
·th
[
d•th
].
p_hdr
)) {

707 
	`ext_debug
("move %d:%llu:[%d]%d in‚ew†eaf %llu\n",

708 
	`Ë32_to_ıu
(
ex
->
“_block
),

709 
	`ext4_ext_pblock
(
ex
),

710 
	`ext4_ext_is_unwr™‹n
(
ex
),

711 
	`ext4_ext_g‘_aùu®_Ën
(
ex
),

712 
Ãwblock
);

713 
ex
++;

715 
	}
}

718 
	#ext4_ext_show_·th
(
šode
, 
·th
)

	)

719 
	#ext4_ext_show_Ëaf
(
šode
, 
·th
)

	)

720 
	#ext4_ext_show_move
(
šode
, 
·th
, 
Ãwblock
, 
Ëv–
)

	)

723 
	$ext4_ext_drİ_»fs
(
ext4_ext_·th
 *
·th
)

725 
d•th
, 
i
;

727 ià(!
·th
)

729 
d•th
 = 
·th
->
p_d•th
;

730 
i
 = 0; i <ğ
d•th
; i++, 
·th
++)

731 ià(
·th
->
p_bh
) {

732 
	`b»l£
(
·th
->
p_bh
);

733 
·th
->
p_bh
 = 
NULL
;

735 
	}
}

743 
	$ext4_ext_bš£¬ch_idx
(
šode
 *inode,

744 
ext4_ext_·th
 *
·th
, 
ext4_lblk_t
 
block
)

746 
ext4_ex‹Á_h—d”
 *
eh
 = 
·th
->
p_hdr
;

747 
ext4_ex‹Á_idx
 *
r
, *
l
, *
m
;

750 
	`ext_debug
("bš£¬ch fÜ %u(idx): ", 
block
);

752 
l
 = 
	`EXT_FIRST_INDEX
(
eh
) + 1;

753 
r
 = 
	`EXT_LAST_INDEX
(
eh
);

754 
l
 <ğ
r
) {

755 
m
 = 
l
 + (
r
 -†) / 2;

756 ià(
block
 < 
	`Ë32_to_ıu
(
m
->
ei_block
))

757 
r
 = 
m
 - 1;

759 
l
 = 
m
 + 1;

760 
	`ext_debug
("%p(%u):%p(%u):%p(%uè", 
l
, 
	`Ë32_to_ıu
Ö->
ei_block
),

761 
m
, 
	`Ë32_to_ıu
(m->
ei_block
),

762 
r
, 
	`Ë32_to_ıu
Ô->
ei_block
));

765 
·th
->
p_idx
 = 
l
 - 1;

766 
	`ext_debug
(" -> %u->%Îd ", 
	`Ë32_to_ıu
(
·th
->
p_idx
->
ei_block
),

767 
	`ext4_idx_pblock
(
·th
->
p_idx
));

769 #ifdeà
CHECK_BINSEARCH


771 
ext4_ex‹Á_idx
 *
chix
, *
ix
;

772 
k
;

774 
chix
 = 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

775 
k
 = 0; k < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); k++, 
ix
++) {

776 ià(
k
 != 0 &&

777 
	`Ë32_to_ıu
(
ix
->
ei_block
) <=†e32_to_cpu(ix[-1].ei_block)) {

778 
	`´štk
(
KERN_DEBUG
 "k=%d, ix=0x%p, "

779 "fœ¡=0x%p\n", 
k
,

780 
ix
, 
	`EXT_FIRST_INDEX
(
eh
));

781 
	`´štk
(
KERN_DEBUG
 "%u <= %u\n",

782 
	`Ë32_to_ıu
(
ix
->
ei_block
),

783 
	`Ë32_to_ıu
(
ix
[-1].
ei_block
));

785 
	`BUG_ON
(
k
 && 
	`Ë32_to_ıu
(
ix
->
ei_block
)

786 <ğ
	`Ë32_to_ıu
(
ix
[-1].
ei_block
));

787 ià(
block
 < 
	`Ë32_to_ıu
(
ix
->
ei_block
))

789 
chix
 = 
ix
;

791 
	`BUG_ON
(
chix
 !ğ
·th
->
p_idx
);

795 
	}
}

803 
	$ext4_ext_bš£¬ch
(
šode
 *inode,

804 
ext4_ext_·th
 *
·th
, 
ext4_lblk_t
 
block
)

806 
ext4_ex‹Á_h—d”
 *
eh
 = 
·th
->
p_hdr
;

807 
ext4_ex‹Á
 *
r
, *
l
, *
m
;

809 ià(
eh
->
eh_’Œ›s
 == 0) {

817 
	`ext_debug
("bš£¬ch fÜ %u: ", 
block
);

819 
l
 = 
	`EXT_FIRST_EXTENT
(
eh
) + 1;

820 
r
 = 
	`EXT_LAST_EXTENT
(
eh
);

822 
l
 <ğ
r
) {

823 
m
 = 
l
 + (
r
 -†) / 2;

824 ià(
block
 < 
	`Ë32_to_ıu
(
m
->
“_block
))

825 
r
 = 
m
 - 1;

827 
l
 = 
m
 + 1;

828 
	`ext_debug
("%p(%u):%p(%u):%p(%uè", 
l
, 
	`Ë32_to_ıu
Ö->
“_block
),

829 
m
, 
	`Ë32_to_ıu
(m->
“_block
),

830 
r
, 
	`Ë32_to_ıu
Ô->
“_block
));

833 
·th
->
p_ext
 = 
l
 - 1;

834 
	`ext_debug
(" -> %d:%llu:[%d]%d ",

835 
	`Ë32_to_ıu
(
·th
->
p_ext
->
“_block
),

836 
	`ext4_ext_pblock
(
·th
->
p_ext
),

837 
	`ext4_ext_is_unwr™‹n
(
·th
->
p_ext
),

838 
	`ext4_ext_g‘_aùu®_Ën
(
·th
->
p_ext
));

840 #ifdeà
CHECK_BINSEARCH


842 
ext4_ex‹Á
 *
chex
, *
ex
;

843 
k
;

845 
chex
 = 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

846 
k
 = 0; k < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); k++, 
ex
++) {

847 
	`BUG_ON
(
k
 && 
	`Ë32_to_ıu
(
ex
->
“_block
)

848 <ğ
	`Ë32_to_ıu
(
ex
[-1].
“_block
));

849 ià(
block
 < 
	`Ë32_to_ıu
(
ex
->
“_block
))

851 
chex
 = 
ex
;

853 
	`BUG_ON
(
chex
 !ğ
·th
->
p_ext
);

857 
	}
}

859 
	$ext4_ext_Œ“_š™
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

861 
ext4_ex‹Á_h—d”
 *
eh
;

863 
eh
 = 
	`ext_šode_hdr
(
šode
);

864 
eh
->
eh_d•th
 = 0;

865 
eh
->
eh_’Œ›s
 = 0;

866 
eh
->
eh_magic
 = 
EXT4_EXT_MAGIC
;

867 
eh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_roÙ
(
šode
, 0));

868 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

870 
	}
}

872 
ext4_ext_·th
 *

873 
	$ext4_fšd_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
block
,

874 
ext4_ext_·th
 **
Üig_·th
, 
æags
)

876 
ext4_ex‹Á_h—d”
 *
eh
;

877 
bufãr_h—d
 *
bh
;

878 
ext4_ext_·th
 *
·th
 = 
Üig_·th
 ? *Üig_·th : 
NULL
;

879 
d•th
, 
i
, 
µos
 = 0;

880 
»t
;

882 
eh
 = 
	`ext_šode_hdr
(
šode
);

883 
d•th
 = 
	`ext_d•th
(
šode
);

885 ià(
·th
) {

886 
	`ext4_ext_drİ_»fs
(
·th
);

887 ià(
d•th
 > 
·th
[0].
p_maxd•th
) {

888 
	`kä“
(
·th
);

889 *
Üig_·th
 = 
·th
 = 
NULL
;

892 ià(!
·th
) {

894 
·th
 = 
	`kz®loc
((
ext4_ext_·th
è* (
d•th
 + 2),

895 
GFP_NOFS
);

896 ià(
	`uÆik–y
(!
·th
))

897  
	`ERR_PTR
(-
ENOMEM
);

898 
·th
[0].
p_maxd•th
 = 
d•th
 + 1;

900 
·th
[0].
p_hdr
 = 
eh
;

901 
·th
[0].
p_bh
 = 
NULL
;

903 
i
 = 
d•th
;

905 
i
) {

906 
	`ext_debug
("depth %d:‚um %d, max %d\n",

907 
µos
, 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
),†e16_to_ıuÓh->
eh_max
));

909 
	`ext4_ext_bš£¬ch_idx
(
šode
, 
·th
 + 
µos
, 
block
);

910 
·th
[
µos
].
p_block
 = 
	`ext4_idx_pblock
Õ©h[µos].
p_idx
);

911 
·th
[
µos
].
p_d•th
 = 
i
;

912 
·th
[
µos
].
p_ext
 = 
NULL
;

914 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
, 
·th
[
µos
].
p_block
, --
i
,

915 
æags
);

916 ià(
	`IS_ERR
(
bh
)) {

917 
»t
 = 
	`PTR_ERR
(
bh
);

918 
”r
;

921 
eh
 = 
	`ext_block_hdr
(
bh
);

922 
µos
++;

923 
·th
[
µos
].
p_bh
 = 
bh
;

924 
·th
[
µos
].
p_hdr
 = 
eh
;

927 
·th
[
µos
].
p_d•th
 = 
i
;

928 
·th
[
µos
].
p_ext
 = 
NULL
;

929 
·th
[
µos
].
p_idx
 = 
NULL
;

932 
	`ext4_ext_bš£¬ch
(
šode
, 
·th
 + 
µos
, 
block
);

934 ià(
·th
[
µos
].
p_ext
)

935 
·th
[
µos
].
p_block
 = 
	`ext4_ext_pblock
Õ©h[µos].
p_ext
);

937 
	`ext4_ext_show_·th
(
šode
, 
·th
);

939  
·th
;

941 
”r
:

942 
	`ext4_ext_drİ_»fs
(
·th
);

943 
	`kä“
(
·th
);

944 ià(
Üig_·th
)

945 *
Üig_·th
 = 
NULL
;

946  
	`ERR_PTR
(
»t
);

947 
	}
}

954 
	$ext4_ext_š£¹_šdex
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

955 
ext4_ext_·th
 *
cu½
,

956 
logiÿl
, 
ext4_fsblk_t
 
±r
)

958 
ext4_ex‹Á_idx
 *
ix
;

959 
Ën
, 
”r
;

961 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
cu½
);

962 ià(
”r
)

963  
”r
;

965 ià(
	`uÆik–y
(
logiÿl
 =ğ
	`Ë32_to_ıu
(
cu½
->
p_idx
->
ei_block
))) {

966 
	`EXT4_ERROR_INODE
(
šode
,

968 
logiÿl
, 
	`Ë32_to_ıu
(
cu½
->
p_idx
->
ei_block
));

969  -
EFSCORRUPTED
;

972 ià(
	`uÆik–y
(
	`Ë16_to_ıu
(
cu½
->
p_hdr
->
eh_’Œ›s
)

973 >ğ
	`Ë16_to_ıu
(
cu½
->
p_hdr
->
eh_max
))) {

974 
	`EXT4_ERROR_INODE
(
šode
,

976 
	`Ë16_to_ıu
(
cu½
->
p_hdr
->
eh_’Œ›s
),

977 
	`Ë16_to_ıu
(
cu½
->
p_hdr
->
eh_max
));

978  -
EFSCORRUPTED
;

981 ià(
logiÿl
 > 
	`Ë32_to_ıu
(
cu½
->
p_idx
->
ei_block
)) {

983 
	`ext_debug
("š£¹‚ew index %d‡á”: %Îu\n", 
logiÿl
, 
±r
);

984 
ix
 = 
cu½
->
p_idx
 + 1;

987 
	`ext_debug
("š£¹‚ew index %d befÜe: %Îu\n", 
logiÿl
, 
±r
);

988 
ix
 = 
cu½
->
p_idx
;

991 
Ën
 = 
	`EXT_LAST_INDEX
(
cu½
->
p_hdr
è- 
ix
 + 1;

992 
	`BUG_ON
(
Ën
 < 0);

993 ià(
Ën
 > 0) {

994 
	`ext_debug
("insert‚ew index %d: "

996 
logiÿl
, 
Ën
, 
ix
, ix + 1);

997 
	`memmove
(
ix
 + 1, ix, 
Ën
 * (
ext4_ex‹Á_idx
));

1000 ià(
	`uÆik–y
(
ix
 > 
	`EXT_MAX_INDEX
(
cu½
->
p_hdr
))) {

1001 
	`EXT4_ERROR_INODE
(
šode
, "ix > EXT_MAX_INDEX!");

1002  -
EFSCORRUPTED
;

1005 
ix
->
ei_block
 = 
	`ıu_to_Ë32
(
logiÿl
);

1006 
	`ext4_idx_¡Üe_pblock
(
ix
, 
±r
);

1007 
	`Ë16_add_ıu
(&
cu½
->
p_hdr
->
eh_’Œ›s
, 1);

1009 ià(
	`uÆik–y
(
ix
 > 
	`EXT_LAST_INDEX
(
cu½
->
p_hdr
))) {

1010 
	`EXT4_ERROR_INODE
(
šode
, "ix > EXT_LAST_INDEX!");

1011  -
EFSCORRUPTED
;

1014 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
cu½
);

1015 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

1017  
”r
;

1018 
	}
}

1030 
	$ext4_ext_¥l™
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1031 
æags
,

1032 
ext4_ext_·th
 *
·th
,

1033 
ext4_ex‹Á
 *
Ãwext
, 
©
)

1035 
bufãr_h—d
 *
bh
 = 
NULL
;

1036 
d•th
 = 
	`ext_d•th
(
šode
);

1037 
ext4_ex‹Á_h—d”
 *
Ãh
;

1038 
ext4_ex‹Á_idx
 *
fidx
;

1039 
i
 = 
©
, 
k
, 
m
, 
a
;

1040 
ext4_fsblk_t
 
Ãwblock
, 
Şdblock
;

1041 
__Ë32
 
bÜd”
;

1042 
ext4_fsblk_t
 *
ablocks
 = 
NULL
;

1043 
”r
 = 0;

1050 ià(
	`uÆik–y
(
·th
[
d•th
].
p_ext
 > 
	`EXT_MAX_EXTENT
Õ©h[d•th].
p_hdr
))) {

1051 
	`EXT4_ERROR_INODE
(
šode
, "p_ext > EXT_MAX_EXTENT!");

1052  -
EFSCORRUPTED
;

1054 ià(
·th
[
d•th
].
p_ext
 !ğ
	`EXT_MAX_EXTENT
Õ©h[d•th].
p_hdr
)) {

1055 
bÜd”
 = 
·th
[
d•th
].
p_ext
[1].
“_block
;

1056 
	`ext_debug
("leaf will be split."

1058 
	`Ë32_to_ıu
(
bÜd”
));

1060 
bÜd”
 = 
Ãwext
->
“_block
;

1061 
	`ext_debug
("leaf will be‡dded."

1063 
	`Ë32_to_ıu
(
bÜd”
));

1078 
ablocks
 = 
	`kz®loc
((
ext4_fsblk_t
è* 
d•th
, 
GFP_NOFS
);

1079 ià(!
ablocks
)

1080  -
ENOMEM
;

1083 
	`ext_debug
("®loÿ‹ %d block fÜ indexes/Ëaf\n", 
d•th
 - 
©
);

1084 
a
 = 0;‡ < 
d•th
 - 
©
;‡++) {

1085 
Ãwblock
 = 
	`ext4_ext_Ãw_m‘a_block
(
hªdË
, 
šode
, 
·th
,

1086 
Ãwext
, &
”r
, 
æags
);

1087 ià(
Ãwblock
 == 0)

1088 
ş—nup
;

1089 
ablocks
[
a
] = 
Ãwblock
;

1093 
Ãwblock
 = 
ablocks
[--
a
];

1094 ià(
	`uÆik–y
(
Ãwblock
 == 0)) {

1095 
	`EXT4_ERROR_INODE
(
šode
, "newblock == 0!");

1096 
”r
 = -
EFSCORRUPTED
;

1097 
ş—nup
;

1099 
bh
 = 
	`sb_g‘blk_gå
(
šode
->
i_sb
, 
Ãwblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1100 ià(
	`uÆik–y
(!
bh
)) {

1101 
”r
 = -
ENOMEM
;

1102 
ş—nup
;

1104 
	`lock_bufãr
(
bh
);

1106 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

1107 ià(
”r
)

1108 
ş—nup
;

1110 
Ãh
 = 
	`ext_block_hdr
(
bh
);

1111 
Ãh
->
eh_’Œ›s
 = 0;

1112 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_block
(
šode
, 0));

1113 
Ãh
->
eh_magic
 = 
EXT4_EXT_MAGIC
;

1114 
Ãh
->
eh_d•th
 = 0;

1117 ià(
	`uÆik–y
(
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
 !=

1118 
·th
[
d•th
].
p_hdr
->
eh_max
)) {

1119 
	`EXT4_ERROR_INODE
(
šode
, "eh_entries %d !=ƒh_max %d!",

1120 
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
,

1121 
·th
[
d•th
].
p_hdr
->
eh_max
);

1122 
”r
 = -
EFSCORRUPTED
;

1123 
ş—nup
;

1126 
m
 = 
	`EXT_MAX_EXTENT
(
·th
[
d•th
].
p_hdr
è-…©h[d•th].
p_ext
++;

1127 
	`ext4_ext_show_move
(
šode
, 
·th
, 
Ãwblock
, 
d•th
);

1128 ià(
m
) {

1129 
ext4_ex‹Á
 *
ex
;

1130 
ex
 = 
	`EXT_FIRST_EXTENT
(
Ãh
);

1131 
	`memmove
(
ex
, 
·th
[
d•th
].
p_ext
, (
ext4_ex‹Á
è* 
m
);

1132 
	`Ë16_add_ıu
(&
Ãh
->
eh_’Œ›s
, 
m
);

1135 
	`ext4_ex‹Á_block_csum_£t
(
šode
, 
Ãh
);

1136 
	`£t_bufãr_u±od©e
(
bh
);

1137 
	`uÆock_bufãr
(
bh
);

1139 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1140 ià(
”r
)

1141 
ş—nup
;

1142 
	`b»l£
(
bh
);

1143 
bh
 = 
NULL
;

1146 ià(
m
) {

1147 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

1148 ià(
”r
)

1149 
ş—nup
;

1150 
	`Ë16_add_ıu
(&
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
, -
m
);

1151 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

1152 ià(
”r
)

1153 
ş—nup
;

1158 
k
 = 
d•th
 - 
©
 - 1;

1159 ià(
	`uÆik–y
(
k
 < 0)) {

1160 
	`EXT4_ERROR_INODE
(
šode
, "k %d < 0!", 
k
);

1161 
”r
 = -
EFSCORRUPTED
;

1162 
ş—nup
;

1164 ià(
k
)

1165 
	`ext_debug
("ü—‹ %d iÁ”medŸ‹ indiûs\n", 
k
);

1168 
i
 = 
d•th
 - 1;

1169 
k
--) {

1170 
Şdblock
 = 
Ãwblock
;

1171 
Ãwblock
 = 
ablocks
[--
a
];

1172 
bh
 = 
	`sb_g‘blk
(
šode
->
i_sb
, 
Ãwblock
);

1173 ià(
	`uÆik–y
(!
bh
)) {

1174 
”r
 = -
ENOMEM
;

1175 
ş—nup
;

1177 
	`lock_bufãr
(
bh
);

1179 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

1180 ià(
”r
)

1181 
ş—nup
;

1183 
Ãh
 = 
	`ext_block_hdr
(
bh
);

1184 
Ãh
->
eh_’Œ›s
 = 
	`ıu_to_Ë16
(1);

1185 
Ãh
->
eh_magic
 = 
EXT4_EXT_MAGIC
;

1186 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_block_idx
(
šode
, 0));

1187 
Ãh
->
eh_d•th
 = 
	`ıu_to_Ë16
(
d•th
 - 
i
);

1188 
fidx
 = 
	`EXT_FIRST_INDEX
(
Ãh
);

1189 
fidx
->
ei_block
 = 
bÜd”
;

1190 
	`ext4_idx_¡Üe_pblock
(
fidx
, 
Şdblock
);

1192 
	`ext_debug
("int.index‡t %d (block %llu): %u -> %llu\n",

1193 
i
, 
Ãwblock
, 
	`Ë32_to_ıu
(
bÜd”
), 
Şdblock
);

1196 ià(
	`uÆik–y
(
	`EXT_MAX_INDEX
(
·th
[
i
].
p_hdr
) !=

1197 
	`EXT_LAST_INDEX
(
·th
[
i
].
p_hdr
))) {

1198 
	`EXT4_ERROR_INODE
(
šode
,

1200 
	`Ë32_to_ıu
(
·th
[
i
].
p_ext
->
“_block
));

1201 
”r
 = -
EFSCORRUPTED
;

1202 
ş—nup
;

1205 
m
 = 
	`EXT_MAX_INDEX
(
·th
[
i
].
p_hdr
è-…©h[i].
p_idx
++;

1206 
	`ext_debug
("cu¸0x%p,†a¡ 0x%p\n", 
·th
[
i
].
p_idx
,

1207 
	`EXT_MAX_INDEX
(
·th
[
i
].
p_hdr
));

1208 
	`ext4_ext_show_move
(
šode
, 
·th
, 
Ãwblock
, 
i
);

1209 ià(
m
) {

1210 
	`memmove
(++
fidx
, 
·th
[
i
].
p_idx
,

1211 (
ext4_ex‹Á_idx
è* 
m
);

1212 
	`Ë16_add_ıu
(&
Ãh
->
eh_’Œ›s
, 
m
);

1214 
	`ext4_ex‹Á_block_csum_£t
(
šode
, 
Ãh
);

1215 
	`£t_bufãr_u±od©e
(
bh
);

1216 
	`uÆock_bufãr
(
bh
);

1218 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1219 ià(
”r
)

1220 
ş—nup
;

1221 
	`b»l£
(
bh
);

1222 
bh
 = 
NULL
;

1225 ià(
m
) {

1226 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
i
);

1227 ià(
”r
)

1228 
ş—nup
;

1229 
	`Ë16_add_ıu
(&
·th
[
i
].
p_hdr
->
eh_’Œ›s
, -
m
);

1230 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
i
);

1231 ià(
”r
)

1232 
ş—nup
;

1235 
i
--;

1239 
”r
 = 
	`ext4_ext_š£¹_šdex
(
hªdË
, 
šode
, 
·th
 + 
©
,

1240 
	`Ë32_to_ıu
(
bÜd”
), 
Ãwblock
);

1242 
ş—nup
:

1243 ià(
bh
) {

1244 ià(
	`bufãr_locked
(
bh
))

1245 
	`uÆock_bufãr
(
bh
);

1246 
	`b»l£
(
bh
);

1249 ià(
”r
) {

1251 
i
 = 0; i < 
d•th
; i++) {

1252 ià(!
ablocks
[
i
])

1254 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
ablocks
[
i
], 1,

1255 
EXT4_FREE_BLOCKS_METADATA
);

1258 
	`kä“
(
ablocks
);

1260  
”r
;

1261 
	}
}

1271 
	$ext4_ext_grow_šd•th
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1272 
æags
)

1274 
ext4_ex‹Á_h—d”
 *
Ãh
;

1275 
bufãr_h—d
 *
bh
;

1276 
ext4_fsblk_t
 
Ãwblock
, 
gßl
 = 0;

1277 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

1278 
”r
 = 0;

1281 ià(
	`ext_d•th
(
šode
))

1282 
gßl
 = 
	`ext4_idx_pblock
(
	`EXT_FIRST_INDEX
(
	`ext_šode_hdr
(
šode
)));

1283 ià(
gßl
 > 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
)) {

1284 
æags
 |ğ
EXT4_MB_HINT_TRY_GOAL
;

1285 
gßl
--;

1287 
gßl
 = 
	`ext4_šode_to_gßl_block
(
šode
);

1288 
Ãwblock
 = 
	`ext4_Ãw_m‘a_blocks
(
hªdË
, 
šode
, 
gßl
, 
æags
,

1289 
NULL
, &
”r
);

1290 ià(
Ãwblock
 == 0)

1291  
”r
;

1293 
bh
 = 
	`sb_g‘blk_gå
(
šode
->
i_sb
, 
Ãwblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1294 ià(
	`uÆik–y
(!
bh
))

1295  -
ENOMEM
;

1296 
	`lock_bufãr
(
bh
);

1298 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

1299 ià(
”r
) {

1300 
	`uÆock_bufãr
(
bh
);

1301 
out
;

1305 
	`memmove
(
bh
->
b_d©a
, 
	`EXT4_I
(
šode
)->
i_d©a
,

1306 (
	`EXT4_I
(
šode
)->
i_d©a
));

1309 
Ãh
 = 
	`ext_block_hdr
(
bh
);

1312 ià(
	`ext_d•th
(
šode
))

1313 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_block_idx
(
šode
, 0));

1315 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_block
(
šode
, 0));

1316 
Ãh
->
eh_magic
 = 
EXT4_EXT_MAGIC
;

1317 
	`ext4_ex‹Á_block_csum_£t
(
šode
, 
Ãh
);

1318 
	`£t_bufãr_u±od©e
(
bh
);

1319 
	`uÆock_bufãr
(
bh
);

1321 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1322 ià(
”r
)

1323 
out
;

1326 
Ãh
 = 
	`ext_šode_hdr
(
šode
);

1327 
Ãh
->
eh_’Œ›s
 = 
	`ıu_to_Ë16
(1);

1328 
	`ext4_idx_¡Üe_pblock
(
	`EXT_FIRST_INDEX
(
Ãh
), 
Ãwblock
);

1329 ià(
Ãh
->
eh_d•th
 == 0) {

1331 
Ãh
->
eh_max
 = 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_roÙ_idx
(
šode
, 0));

1332 
	`EXT_FIRST_INDEX
(
Ãh
)->
ei_block
 =

1333 
	`EXT_FIRST_EXTENT
(
Ãh
)->
“_block
;

1335 
	`ext_debug
("new„oot:‚um %d(%d),†block %d,…tr %llu\n",

1336 
	`Ë16_to_ıu
(
Ãh
->
eh_’Œ›s
),†e16_to_ıuÒeh->
eh_max
),

1337 
	`Ë32_to_ıu
(
	`EXT_FIRST_INDEX
(
Ãh
)->
ei_block
),

1338 
	`ext4_idx_pblock
(
	`EXT_FIRST_INDEX
(
Ãh
)));

1340 
	`Ë16_add_ıu
(&
Ãh
->
eh_d•th
, 1);

1341 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1342 
out
:

1343 
	`b»l£
(
bh
);

1345  
”r
;

1346 
	}
}

1353 
	$ext4_ext_ü—‹_Ãw_Ëaf
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1354 
mb_æags
,

1355 
gb_æags
,

1356 
ext4_ext_·th
 **
µ©h
,

1357 
ext4_ex‹Á
 *
Ãwext
)

1359 
ext4_ext_·th
 *
·th
 = *
µ©h
;

1360 
ext4_ext_·th
 *
cu½
;

1361 
d•th
, 
i
, 
”r
 = 0;

1363 
»³©
:

1364 
i
 = 
d•th
 = 
	`ext_d•th
(
šode
);

1367 
cu½
 = 
·th
 + 
d•th
;

1368 
i
 > 0 && !
	`EXT_HAS_FREE_INDEX
(
cu½
)) {

1369 
i
--;

1370 
cu½
--;

1375 ià(
	`EXT_HAS_FREE_INDEX
(
cu½
)) {

1378 
”r
 = 
	`ext4_ext_¥l™
(
hªdË
, 
šode
, 
mb_æags
, 
·th
, 
Ãwext
, 
i
);

1379 ià(
”r
)

1380 
out
;

1383 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
,

1384 (
ext4_lblk_t
)
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

1385 
µ©h
, 
gb_æags
);

1386 ià(
	`IS_ERR
(
·th
))

1387 
”r
 = 
	`PTR_ERR
(
·th
);

1390 
”r
 = 
	`ext4_ext_grow_šd•th
(
hªdË
, 
šode
, 
mb_æags
);

1391 ià(
”r
)

1392 
out
;

1395 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
,

1396 (
ext4_lblk_t
)
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

1397 
µ©h
, 
gb_æags
);

1398 ià(
	`IS_ERR
(
·th
)) {

1399 
”r
 = 
	`PTR_ERR
(
·th
);

1400 
out
;

1407 
d•th
 = 
	`ext_d•th
(
šode
);

1408 ià(
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
 =ğ·th[d•th].p_hdr->
eh_max
) {

1410 
»³©
;

1414 
out
:

1415  
”r
;

1416 
	}
}

1425 
	$ext4_ext_£¬ch_Ëá
(
šode
 *inode,

1426 
ext4_ext_·th
 *
·th
,

1427 
ext4_lblk_t
 *
logiÿl
, 
ext4_fsblk_t
 *
phys
)

1429 
ext4_ex‹Á_idx
 *
ix
;

1430 
ext4_ex‹Á
 *
ex
;

1431 
d•th
, 
“_Ën
;

1433 ià(
	`uÆik–y
(
·th
 =ğ
NULL
)) {

1434 
	`EXT4_ERROR_INODE
(
šode
, "·th =ğNULL *logiÿÈ%d!", *
logiÿl
);

1435  -
EFSCORRUPTED
;

1437 
d•th
 = 
·th
->
p_d•th
;

1438 *
phys
 = 0;

1440 ià(
d•th
 =ğ0 && 
·th
->
p_ext
 =ğ
NULL
)

1447 
ex
 = 
·th
[
d•th
].
p_ext
;

1448 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

1449 ià(*
logiÿl
 < 
	`Ë32_to_ıu
(
ex
->
“_block
)) {

1450 ià(
	`uÆik–y
(
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
è!ğ
ex
)) {

1451 
	`EXT4_ERROR_INODE
(
šode
,

1453 *
logiÿl
, 
	`Ë32_to_ıu
(
ex
->
“_block
));

1454  -
EFSCORRUPTED
;

1456 --
d•th
 >= 0) {

1457 
ix
 = 
·th
[
d•th
].
p_idx
;

1458 ià(
	`uÆik–y
(
ix
 !ğ
	`EXT_FIRST_INDEX
(
·th
[
d•th
].
p_hdr
))) {

1459 
	`EXT4_ERROR_INODE
(
šode
,

1461 
ix
 !ğ
NULL
 ? 
	`Ë32_to_ıu
(ix->
ei_block
) : 0,

1462 
	`EXT_FIRST_INDEX
(
·th
[
d•th
].
p_hdr
è!ğ
NULL
 ?

1463 
	`Ë32_to_ıu
(
	`EXT_FIRST_INDEX
(
·th
[
d•th
].
p_hdr
)->
ei_block
) : 0,

1464 
d•th
);

1465  -
EFSCORRUPTED
;

1471 ià(
	`uÆik–y
(*
logiÿl
 < (
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
))) {

1472 
	`EXT4_ERROR_INODE
(
šode
,

1474 *
logiÿl
, 
	`Ë32_to_ıu
(
ex
->
“_block
), 
“_Ën
);

1475  -
EFSCORRUPTED
;

1478 *
logiÿl
 = 
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
 - 1;

1479 *
phys
 = 
	`ext4_ext_pblock
(
ex
è+ 
“_Ën
 - 1;

1481 
	}
}

1490 
	$ext4_ext_£¬ch_right
(
šode
 *inode,

1491 
ext4_ext_·th
 *
·th
,

1492 
ext4_lblk_t
 *
logiÿl
, 
ext4_fsblk_t
 *
phys
,

1493 
ext4_ex‹Á
 **
»t_ex
)

1495 
bufãr_h—d
 *
bh
 = 
NULL
;

1496 
ext4_ex‹Á_h—d”
 *
eh
;

1497 
ext4_ex‹Á_idx
 *
ix
;

1498 
ext4_ex‹Á
 *
ex
;

1499 
ext4_fsblk_t
 
block
;

1500 
d•th
;

1501 
“_Ën
;

1503 ià(
	`uÆik–y
(
·th
 =ğ
NULL
)) {

1504 
	`EXT4_ERROR_INODE
(
šode
, "·th =ğNULL *logiÿÈ%d!", *
logiÿl
);

1505  -
EFSCORRUPTED
;

1507 
d•th
 = 
·th
->
p_d•th
;

1508 *
phys
 = 0;

1510 ià(
d•th
 =ğ0 && 
·th
->
p_ext
 =ğ
NULL
)

1517 
ex
 = 
·th
[
d•th
].
p_ext
;

1518 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

1519 ià(*
logiÿl
 < 
	`Ë32_to_ıu
(
ex
->
“_block
)) {

1520 ià(
	`uÆik–y
(
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
è!ğ
ex
)) {

1521 
	`EXT4_ERROR_INODE
(
šode
,

1523 
d•th
);

1524  -
EFSCORRUPTED
;

1526 --
d•th
 >= 0) {

1527 
ix
 = 
·th
[
d•th
].
p_idx
;

1528 ià(
	`uÆik–y
(
ix
 !ğ
	`EXT_FIRST_INDEX
(
·th
[
d•th
].
p_hdr
))) {

1529 
	`EXT4_ERROR_INODE
(
šode
,

1531 *
logiÿl
);

1532  -
EFSCORRUPTED
;

1535 
found_ex‹Á
;

1538 ià(
	`uÆik–y
(*
logiÿl
 < (
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
))) {

1539 
	`EXT4_ERROR_INODE
(
šode
,

1541 *
logiÿl
, 
	`Ë32_to_ıu
(
ex
->
“_block
), 
“_Ën
);

1542  -
EFSCORRUPTED
;

1545 ià(
ex
 !ğ
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
)) {

1547 
ex
++;

1548 
found_ex‹Á
;

1552 --
d•th
 >= 0) {

1553 
ix
 = 
·th
[
d•th
].
p_idx
;

1554 ià(
ix
 !ğ
	`EXT_LAST_INDEX
(
·th
[
d•th
].
p_hdr
))

1555 
gÙ_šdex
;

1561 
gÙ_šdex
:

1565 
ix
++;

1566 
block
 = 
	`ext4_idx_pblock
(
ix
);

1567 ++
d•th
 < 
·th
->
p_d•th
) {

1569 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
, 
block
,

1570 
·th
->
p_d•th
 - 
d•th
, 0);

1571 ià(
	`IS_ERR
(
bh
))

1572  
	`PTR_ERR
(
bh
);

1573 
eh
 = 
	`ext_block_hdr
(
bh
);

1574 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

1575 
block
 = 
	`ext4_idx_pblock
(
ix
);

1576 
	`put_bh
(
bh
);

1579 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
, 
block
, 
·th
->
p_d•th
 - 
d•th
, 0);

1580 ià(
	`IS_ERR
(
bh
))

1581  
	`PTR_ERR
(
bh
);

1582 
eh
 = 
	`ext_block_hdr
(
bh
);

1583 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

1584 
found_ex‹Á
:

1585 *
logiÿl
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

1586 *
phys
 = 
	`ext4_ext_pblock
(
ex
);

1587 *
»t_ex
 = 
ex
;

1588 ià(
bh
)

1589 
	`put_bh
(
bh
);

1591 
	}
}

1600 
ext4_lblk_t


1601 
	$ext4_ext_Ãxt_®loÿ‹d_block
(
ext4_ext_·th
 *
·th
)

1603 
d•th
;

1605 
	`BUG_ON
(
·th
 =ğ
NULL
);

1606 
d•th
 = 
·th
->
p_d•th
;

1608 ià(
d•th
 =ğ0 && 
·th
->
p_ext
 =ğ
NULL
)

1609  
EXT_MAX_BLOCKS
;

1611 
d•th
 >= 0) {

1612 ià(
d•th
 =ğ
·th
->
p_d•th
) {

1614 ià(
·th
[
d•th
].
p_ext
 &&

1615 
·th
[
d•th
].
p_ext
 !=

1616 
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
))

1617  
	`Ë32_to_ıu
(
·th
[
d•th
].
p_ext
[1].
“_block
);

1620 ià(
·th
[
d•th
].
p_idx
 !=

1621 
	`EXT_LAST_INDEX
(
·th
[
d•th
].
p_hdr
))

1622  
	`Ë32_to_ıu
(
·th
[
d•th
].
p_idx
[1].
ei_block
);

1624 
d•th
--;

1627  
EXT_MAX_BLOCKS
;

1628 
	}
}

1634 
ext4_lblk_t
 
	$ext4_ext_Ãxt_Ëaf_block
(
ext4_ext_·th
 *
·th
)

1636 
d•th
;

1638 
	`BUG_ON
(
·th
 =ğ
NULL
);

1639 
d•th
 = 
·th
->
p_d•th
;

1642 ià(
d•th
 == 0)

1643  
EXT_MAX_BLOCKS
;

1646 
d•th
--;

1648 
d•th
 >= 0) {

1649 ià(
·th
[
d•th
].
p_idx
 !=

1650 
	`EXT_LAST_INDEX
(
·th
[
d•th
].
p_hdr
))

1651  (
ext4_lblk_t
)

1652 
	`Ë32_to_ıu
(
·th
[
d•th
].
p_idx
[1].
ei_block
);

1653 
d•th
--;

1656  
EXT_MAX_BLOCKS
;

1657 
	}
}

1665 
	$ext4_ext_cÜ»ù_šdexes
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1666 
ext4_ext_·th
 *
·th
)

1668 
ext4_ex‹Á_h—d”
 *
eh
;

1669 
d•th
 = 
	`ext_d•th
(
šode
);

1670 
ext4_ex‹Á
 *
ex
;

1671 
__Ë32
 
bÜd”
;

1672 
k
, 
”r
 = 0;

1674 
eh
 = 
·th
[
d•th
].
p_hdr
;

1675 
ex
 = 
·th
[
d•th
].
p_ext
;

1677 ià(
	`uÆik–y
(
ex
 =ğ
NULL
 || 
eh
 == NULL)) {

1678 
	`EXT4_ERROR_INODE
(
šode
,

1679 "ex %°=ğNULL o¸eh %°=ğNULL", 
ex
, 
eh
);

1680  -
EFSCORRUPTED
;

1683 ià(
d•th
 == 0) {

1688 ià(
ex
 !ğ
	`EXT_FIRST_EXTENT
(
eh
)) {

1696 
k
 = 
d•th
 - 1;

1697 
bÜd”
 = 
·th
[
d•th
].
p_ext
->
“_block
;

1698 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
k
);

1699 ià(
”r
)

1700  
”r
;

1701 
·th
[
k
].
p_idx
->
ei_block
 = 
bÜd”
;

1702 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
k
);

1703 ià(
”r
)

1704  
”r
;

1706 
k
--) {

1708 ià(
·th
[
k
+1].
p_idx
 !ğ
	`EXT_FIRST_INDEX
Õ©h[k+1].
p_hdr
))

1710 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
k
);

1711 ià(
”r
)

1713 
·th
[
k
].
p_idx
->
ei_block
 = 
bÜd”
;

1714 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
k
);

1715 ià(
”r
)

1719  
”r
;

1720 
	}
}

1723 
	$ext4_ÿn_ex‹Ás_be_m”ged
(
šode
 *šode, 
ext4_ex‹Á
 *
ex1
,

1724 
ext4_ex‹Á
 *
ex2
)

1726 
ext1_“_Ën
, 
ext2_“_Ën
;

1728 ià(
	`ext4_ext_is_unwr™‹n
(
ex1
è!ğext4_ext_is_unwr™‹n(
ex2
))

1731 
ext1_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex1
);

1732 
ext2_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex2
);

1734 ià(
	`Ë32_to_ıu
(
ex1
->
“_block
è+ 
ext1_“_Ën
 !=

1735 
	`Ë32_to_ıu
(
ex2
->
“_block
))

1743 ià(
ext1_“_Ën
 + 
ext2_“_Ën
 > 
EXT_INIT_MAX_LEN
)

1751 ià(
	`ext4_ext_is_unwr™‹n
(
ex1
) &&

1752 (
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_DIO_UNWRITTEN
) ||

1753 
	`©omic_»ad
(&
	`EXT4_I
(
šode
)->
i_unwr™‹n
) ||

1754 (
ext1_“_Ën
 + 
ext2_“_Ën
 > 
EXT_UNWRITTEN_MAX_LEN
)))

1756 #ifdeà
AGGRESSIVE_TEST


1757 ià(
ext1_“_Ën
 >= 4)

1761 ià(
	`ext4_ext_pblock
(
ex1
è+ 
ext1_“_Ën
 =ğext4_ext_pblock(
ex2
))

1764 
	}
}

1773 
	$ext4_ext_Œy_to_m”ge_right
(
šode
 *inode,

1774 
ext4_ext_·th
 *
·th
,

1775 
ext4_ex‹Á
 *
ex
)

1777 
ext4_ex‹Á_h—d”
 *
eh
;

1778 
d•th
, 
Ën
;

1779 
m”ge_dÚe
 = 0, 
unwr™‹n
;

1781 
d•th
 = 
	`ext_d•th
(
šode
);

1782 
	`BUG_ON
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
);

1783 
eh
 = 
·th
[
d•th
].
p_hdr
;

1785 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1786 ià(!
	`ext4_ÿn_ex‹Ás_be_m”ged
(
šode
, 
ex
,ƒx + 1))

1789 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

1790 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
	`ext4_ext_g‘_aùu®_Ën
(ex)

1791 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
 + 1));

1792 ià(
unwr™‹n
)

1793 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

1795 ià(
ex
 + 1 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1796 
Ën
 = (
	`EXT_LAST_EXTENT
(
eh
è- 
ex
 - 1)

1797 * (
ext4_ex‹Á
);

1798 
	`memmove
(
ex
 + 1,ƒx + 2, 
Ën
);

1800 
	`Ë16_add_ıu
(&
eh
->
eh_’Œ›s
, -1);

1801 
m”ge_dÚe
 = 1;

1802 
	`WARN_ON
(
eh
->
eh_’Œ›s
 == 0);

1803 ià(!
eh
->
eh_’Œ›s
)

1804 
	`EXT4_ERROR_INODE
(
šode
, "eh->eh_entries = 0!");

1807  
m”ge_dÚe
;

1808 
	}
}

1814 
	$ext4_ext_Œy_to_m”ge_up
(
hªdË_t
 *
hªdË
,

1815 
šode
 *inode,

1816 
ext4_ext_·th
 *
·th
)

1818 
size_t
 
s
;

1819 
max_roÙ
 = 
	`ext4_ext_¥aû_roÙ
(
šode
, 0);

1820 
ext4_fsblk_t
 
blk
;

1822 ià((
·th
[0].
p_d•th
 != 1) ||

1823 (
	`Ë16_to_ıu
(
·th
[0].
p_hdr
->
eh_’Œ›s
) != 1) ||

1824 (
	`Ë16_to_ıu
(
·th
[1].
p_hdr
->
eh_’Œ›s
è> 
max_roÙ
))

1832 ià(
	`ext4_jouº®_ex‹nd
(
hªdË
, 2))

1838 
blk
 = 
	`ext4_idx_pblock
(
·th
[0].
p_idx
);

1839 
s
 = 
	`Ë16_to_ıu
(
·th
[1].
p_hdr
->
eh_’Œ›s
) *

1840 (
ext4_ex‹Á_idx
);

1841 
s
 +ğ(
ext4_ex‹Á_h—d”
);

1843 
·th
[1].
p_maxd•th
 =…ath[0].p_maxdepth;

1844 
	`memıy
(
·th
[0].
p_hdr
,…©h[1].p_hdr, 
s
);

1845 
·th
[0].
p_d•th
 = 0;

1846 
·th
[0].
p_ext
 = 
	`EXT_FIRST_EXTENT
Õ©h[0].
p_hdr
) +

1847 (
·th
[1].
p_ext
 - 
	`EXT_FIRST_EXTENT
Õ©h[1].
p_hdr
));

1848 
·th
[0].
p_hdr
->
eh_max
 = 
	`ıu_to_Ë16
(
max_roÙ
);

1850 
	`b»l£
(
·th
[1].
p_bh
);

1851 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
blk
, 1,

1852 
EXT4_FREE_BLOCKS_METADATA
 | 
EXT4_FREE_BLOCKS_FORGET
);

1853 
	}
}

1859 
	$ext4_ext_Œy_to_m”ge
(
hªdË_t
 *
hªdË
,

1860 
šode
 *inode,

1861 
ext4_ext_·th
 *
·th
,

1862 
ext4_ex‹Á
 *
ex
) {

1863 
ext4_ex‹Á_h—d”
 *
eh
;

1864 
d•th
;

1865 
m”ge_dÚe
 = 0;

1867 
d•th
 = 
	`ext_d•th
(
šode
);

1868 
	`BUG_ON
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
);

1869 
eh
 = 
·th
[
d•th
].
p_hdr
;

1871 ià(
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))

1872 
m”ge_dÚe
 = 
	`ext4_ext_Œy_to_m”ge_right
(
šode
, 
·th
, 
ex
 - 1);

1874 ià(!
m”ge_dÚe
)

1875 (è
	`ext4_ext_Œy_to_m”ge_right
(
šode
, 
·th
, 
ex
);

1877 
	`ext4_ext_Œy_to_m”ge_up
(
hªdË
, 
šode
, 
·th
);

1878 
	}
}

1888 
	$ext4_ext_check_ov”Ïp
(
ext4_sb_šfo
 *
sbi
,

1889 
šode
 *inode,

1890 
ext4_ex‹Á
 *
Ãwext
,

1891 
ext4_ext_·th
 *
·th
)

1893 
ext4_lblk_t
 
b1
, 
b2
;

1894 
d•th
, 
Ën1
;

1895 
»t
 = 0;

1897 
b1
 = 
	`Ë32_to_ıu
(
Ãwext
->
“_block
);

1898 
Ën1
 = 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
);

1899 
d•th
 = 
	`ext_d•th
(
šode
);

1900 ià(!
·th
[
d•th
].
p_ext
)

1901 
out
;

1902 
b2
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
	`Ë32_to_ıu
(
·th
[
d•th
].
p_ext
->
“_block
));

1908 ià(
b2
 < 
b1
) {

1909 
b2
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

1910 ià(
b2
 =ğ
EXT_MAX_BLOCKS
)

1911 
out
;

1912 
b2
 = 
	`EXT4_LBLK_CMASK
(
sbi
, b2);

1916 ià(
b1
 + 
Ën1
 < b1) {

1917 
Ën1
 = 
EXT_MAX_BLOCKS
 - 
b1
;

1918 
Ãwext
->
“_Ën
 = 
	`ıu_to_Ë16
(
Ën1
);

1919 
»t
 = 1;

1923 ià(
b1
 + 
Ën1
 > 
b2
) {

1924 
Ãwext
->
“_Ën
 = 
	`ıu_to_Ë16
(
b2
 - 
b1
);

1925 
»t
 = 1;

1927 
out
:

1928  
»t
;

1929 
	}
}

1937 
	$ext4_ext_š£¹_ex‹Á
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1938 
ext4_ext_·th
 **
µ©h
,

1939 
ext4_ex‹Á
 *
Ãwext
, 
gb_æags
)

1941 
ext4_ext_·th
 *
·th
 = *
µ©h
;

1942 
ext4_ex‹Á_h—d”
 *
eh
;

1943 
ext4_ex‹Á
 *
ex
, *
ãx
;

1944 
ext4_ex‹Á
 *
Ã¬ex
;

1945 
ext4_ext_·th
 *
Å©h
 = 
NULL
;

1946 
d•th
, 
Ën
, 
”r
;

1947 
ext4_lblk_t
 
Ãxt
;

1948 
mb_æags
 = 0, 
unwr™‹n
;

1950 ià(
gb_æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
)

1951 
mb_æags
 |ğ
EXT4_MB_DELALLOC_RESERVED
;

1952 ià(
	`uÆik–y
(
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
) == 0)) {

1953 
	`EXT4_ERROR_INODE
(
šode
, "ext4_ext_get_actual_len(newext) == 0");

1954  -
EFSCORRUPTED
;

1956 
d•th
 = 
	`ext_d•th
(
šode
);

1957 
ex
 = 
·th
[
d•th
].
p_ext
;

1958 
eh
 = 
·th
[
d•th
].
p_hdr
;

1959 ià(
	`uÆik–y
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
)) {

1960 
	`EXT4_ERROR_INODE
(
šode
, "·th[%d].p_hd¸=ğNULL", 
d•th
);

1961  -
EFSCORRUPTED
;

1965 ià(
ex
 && !(
gb_æags
 & 
EXT4_GET_BLOCKS_PRE_IO
)) {

1974 ià(
ex
 < 
	`EXT_LAST_EXTENT
(
eh
) &&

1975 (
	`Ë32_to_ıu
(
ex
->
“_block
) +

1976 
	`ext4_ext_g‘_aùu®_Ën
(
ex
) <

1977 
	`Ë32_to_ıu
(
Ãwext
->
“_block
))) {

1978 
ex
 += 1;

1979 
´•’d
;

1980 } ià((
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
)) &&

1981 (
	`Ë32_to_ıu
(
Ãwext
->
“_block
) +

1982 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
) <

1983 
	`Ë32_to_ıu
(
ex
->
“_block
)))

1984 
ex
 -= 1;

1987 ià(
	`ext4_ÿn_ex‹Ás_be_m”ged
(
šode
, 
ex
, 
Ãwext
)) {

1988 
	`ext_debug
("append [%d]%d blocko %u:[%d]%d"

1990 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

1991 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

1992 
	`Ë32_to_ıu
(
ex
->
“_block
),

1993 
	`ext4_ext_is_unwr™‹n
(
ex
),

1994 
	`ext4_ext_g‘_aùu®_Ën
(
ex
),

1995 
	`ext4_ext_pblock
(
ex
));

1996 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
,

1997 
·th
 + 
d•th
);

1998 ià(
”r
)

1999  
”r
;

2000 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

2001 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
	`ext4_ext_g‘_aùu®_Ën
(ex)

2002 + 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
));

2003 ià(
unwr™‹n
)

2004 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

2005 
eh
 = 
·th
[
d•th
].
p_hdr
;

2006 
Ã¬ex
 = 
ex
;

2007 
m”ge
;

2010 
´•’d
:

2012 ià(
	`ext4_ÿn_ex‹Ás_be_m”ged
(
šode
, 
Ãwext
, 
ex
)) {

2013 
	`ext_debug
("prepend %u[%d]%d blocko %u:[%d]%d"

2015 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2016 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2017 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

2018 
	`Ë32_to_ıu
(
ex
->
“_block
),

2019 
	`ext4_ext_is_unwr™‹n
(
ex
),

2020 
	`ext4_ext_g‘_aùu®_Ën
(
ex
),

2021 
	`ext4_ext_pblock
(
ex
));

2022 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
,

2023 
·th
 + 
d•th
);

2024 ià(
”r
)

2025  
”r
;

2027 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

2028 
ex
->
“_block
 = 
Ãwext
->ee_block;

2029 
	`ext4_ext_¡Üe_pblock
(
ex
, 
	`ext4_ext_pblock
(
Ãwext
));

2030 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
	`ext4_ext_g‘_aùu®_Ën
(ex)

2031 + 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
));

2032 ià(
unwr™‹n
)

2033 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

2034 
eh
 = 
·th
[
d•th
].
p_hdr
;

2035 
Ã¬ex
 = 
ex
;

2036 
m”ge
;

2040 
d•th
 = 
	`ext_d•th
(
šode
);

2041 
eh
 = 
·th
[
d•th
].
p_hdr
;

2042 ià(
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
è<†e16_to_ıuÓh->
eh_max
))

2043 
has_¥aû
;

2046 
ãx
 = 
	`EXT_LAST_EXTENT
(
eh
);

2047 
Ãxt
 = 
EXT_MAX_BLOCKS
;

2048 ià(
	`Ë32_to_ıu
(
Ãwext
->
“_block
è>†e32_to_ıu(
ãx
->ee_block))

2049 
Ãxt
 = 
	`ext4_ext_Ãxt_Ëaf_block
(
·th
);

2050 ià(
Ãxt
 !ğ
EXT_MAX_BLOCKS
) {

2051 
	`ext_debug
("ÃxˆËaàblock - %u\n", 
Ãxt
);

2052 
	`BUG_ON
(
Å©h
 !ğ
NULL
);

2053 
Å©h
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
Ãxt
, 
NULL
, 0);

2054 ià(
	`IS_ERR
(
Å©h
))

2055  
	`PTR_ERR
(
Å©h
);

2056 
	`BUG_ON
(
Å©h
->
p_d•th
 !ğ
·th
->p_depth);

2057 
eh
 = 
Å©h
[
d•th
].
p_hdr
;

2058 ià(
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
è<†e16_to_ıuÓh->
eh_max
)) {

2059 
	`ext_debug
("next†eaf isn't full(%d)\n",

2060 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
));

2061 
·th
 = 
Å©h
;

2062 
has_¥aû
;

2064 
	`ext_debug
("next†eaf has‚o free space(%d,%d)\n",

2065 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
),†e16_to_ıuÓh->
eh_max
));

2072 ià(
gb_æags
 & 
EXT4_GET_BLOCKS_METADATA_NOFAIL
)

2073 
mb_æags
 |ğ
EXT4_MB_USE_RESERVED
;

2074 
”r
 = 
	`ext4_ext_ü—‹_Ãw_Ëaf
(
hªdË
, 
šode
, 
mb_æags
, 
gb_æags
,

2075 
µ©h
, 
Ãwext
);

2076 ià(
”r
)

2077 
ş—nup
;

2078 
d•th
 = 
	`ext_d•th
(
šode
);

2079 
eh
 = 
·th
[
d•th
].
p_hdr
;

2081 
has_¥aû
:

2082 
Ã¬ex
 = 
·th
[
d•th
].
p_ext
;

2084 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

2085 ià(
”r
)

2086 
ş—nup
;

2088 ià(!
Ã¬ex
) {

2090 
	`ext_debug
("firstƒxtent inhe†eaf: %u:%llu:[%d]%d\n",

2091 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2092 
	`ext4_ext_pblock
(
Ãwext
),

2093 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2094 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
));

2095 
Ã¬ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

2097 ià(
	`Ë32_to_ıu
(
Ãwext
->
“_block
)

2098 > 
	`Ë32_to_ıu
(
Ã¬ex
->
“_block
)) {

2100 
	`ext_debug
("insert %u:%llu:[%d]%d before: "

2102 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2103 
	`ext4_ext_pblock
(
Ãwext
),

2104 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2105 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

2106 
Ã¬ex
);

2107 
Ã¬ex
++;

2110 
	`BUG_ON
(
Ãwext
->
“_block
 =ğ
Ã¬ex
->ee_block);

2111 
	`ext_debug
("insert %u:%llu:[%d]%d‡fter: "

2113 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2114 
	`ext4_ext_pblock
(
Ãwext
),

2115 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2116 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

2117 
Ã¬ex
);

2119 
Ën
 = 
	`EXT_LAST_EXTENT
(
eh
è- 
Ã¬ex
 + 1;

2120 ià(
Ën
 > 0) {

2121 
	`ext_debug
("insert %u:%llu:[%d]%d: "

2123 
	`Ë32_to_ıu
(
Ãwext
->
“_block
),

2124 
	`ext4_ext_pblock
(
Ãwext
),

2125 
	`ext4_ext_is_unwr™‹n
(
Ãwext
),

2126 
	`ext4_ext_g‘_aùu®_Ën
(
Ãwext
),

2127 
Ën
, 
Ã¬ex
,‚earex + 1);

2128 
	`memmove
(
Ã¬ex
 + 1,‚earex,

2129 
Ën
 * (
ext4_ex‹Á
));

2133 
	`Ë16_add_ıu
(&
eh
->
eh_’Œ›s
, 1);

2134 
·th
[
d•th
].
p_ext
 = 
Ã¬ex
;

2135 
Ã¬ex
->
“_block
 = 
Ãwext
->ee_block;

2136 
	`ext4_ext_¡Üe_pblock
(
Ã¬ex
, 
	`ext4_ext_pblock
(
Ãwext
));

2137 
Ã¬ex
->
“_Ën
 = 
Ãwext
->ee_len;

2139 
m”ge
:

2141 ià(!(
gb_æags
 & 
EXT4_GET_BLOCKS_PRE_IO
))

2142 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
Ã¬ex
);

2146 
”r
 = 
	`ext4_ext_cÜ»ù_šdexes
(
hªdË
, 
šode
, 
·th
);

2147 ià(
”r
)

2148 
ş—nup
;

2150 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

2152 
ş—nup
:

2153 
	`ext4_ext_drİ_»fs
(
Å©h
);

2154 
	`kä“
(
Å©h
);

2155  
”r
;

2156 
	}
}

2158 
	$ext4_fl_f›m­_ex‹Ás
(
šode
 *inode,

2159 
ext4_lblk_t
 
block
,ƒxt4_lblk_ˆ
num
,

2160 
f›m­_ex‹Á_šfo
 *
f›šfo
)

2162 
ext4_ext_·th
 *
·th
 = 
NULL
;

2163 
ext4_ex‹Á
 *
ex
;

2164 
ex‹Á_¡©us
 
es
;

2165 
ext4_lblk_t
 
Ãxt
, 
Ãxt_d–
, 
¡¬t
 = 0, 
’d
 = 0;

2166 
ext4_lblk_t
 
Ï¡
 = 
block
 + 
num
;

2167 
exi¡s
, 
d•th
 = 0, 
”r
 = 0;

2168 
æags
 = 0;

2169 
blksize_b™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

2171 
block
 < 
Ï¡
 && block !ğ
EXT_MAX_BLOCKS
) {

2172 
num
 = 
Ï¡
 - 
block
;

2174 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2176 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
block
, &path, 0);

2177 ià(
	`IS_ERR
(
·th
)) {

2178 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2179 
”r
 = 
	`PTR_ERR
(
·th
);

2180 
·th
 = 
NULL
;

2184 
d•th
 = 
	`ext_d•th
(
šode
);

2185 ià(
	`uÆik–y
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
)) {

2186 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2187 
	`EXT4_ERROR_INODE
(
šode
, "·th[%d].p_hd¸=ğNULL", 
d•th
);

2188 
”r
 = -
EFSCORRUPTED
;

2191 
ex
 = 
·th
[
d•th
].
p_ext
;

2192 
Ãxt
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

2194 
æags
 = 0;

2195 
exi¡s
 = 0;

2196 ià(!
ex
) {

2199 
¡¬t
 = 
block
;

2200 
’d
 = 
block
 + 
num
;

2201 } ià(
	`Ë32_to_ıu
(
ex
->
“_block
è> 
block
) {

2203 
¡¬t
 = 
block
;

2204 
’d
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2205 ià(
block
 + 
num
 < 
’d
)

2206 
’d
 = 
block
 + 
num
;

2207 } ià(
block
 >ğ
	`Ë32_to_ıu
(
ex
->
“_block
)

2208 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
)) {

2210 
¡¬t
 = 
block
;

2211 
’d
 = 
block
 + 
num
;

2212 ià(
’d
 >ğ
Ãxt
)

2213 
’d
 = 
Ãxt
;

2214 } ià(
block
 >ğ
	`Ë32_to_ıu
(
ex
->
“_block
)) {

2219 
¡¬t
 = 
block
;

2220 
’d
 = 
	`Ë32_to_ıu
(
ex
->
“_block
)

2221 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2222 ià(
block
 + 
num
 < 
’d
)

2223 
’d
 = 
block
 + 
num
;

2224 
exi¡s
 = 1;

2226 
	`BUG
();

2228 
	`BUG_ON
(
’d
 <ğ
¡¬t
);

2230 ià(!
exi¡s
) {

2231 
es
.
es_lblk
 = 
¡¬t
;

2232 
es
.
es_Ën
 = 
’d
 - 
¡¬t
;

2233 
es
.
es_pblk
 = 0;

2235 
es
.
es_lblk
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2236 
es
.
es_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2237 
es
.
es_pblk
 = 
	`ext4_ext_pblock
(
ex
);

2238 ià(
	`ext4_ext_is_unwr™‹n
(
ex
))

2239 
æags
 |ğ
FIEMAP_EXTENT_UNWRITTEN
;

2247 
Ãxt_d–
 = 
	`ext4_fšd_d–ayed_ex‹Á
(
šode
, &
es
);

2248 ià(!
exi¡s
 && 
Ãxt_d–
) {

2249 
exi¡s
 = 1;

2250 
æags
 |ğ(
FIEMAP_EXTENT_DELALLOC
 |

2251 
FIEMAP_EXTENT_UNKNOWN
);

2253 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2255 ià(
	`uÆik–y
(
es
.
es_Ën
 == 0)) {

2256 
	`EXT4_ERROR_INODE
(
šode
, "es.es_len == 0");

2257 
”r
 = -
EFSCORRUPTED
;

2272 ià(
Ãxt
 =ğ
Ãxt_d–
 &&‚exˆ=ğ
EXT_MAX_BLOCKS
) {

2273 
æags
 |ğ
FIEMAP_EXTENT_LAST
;

2274 ià(
	`uÆik–y
(
Ãxt_d–
 !ğ
EXT_MAX_BLOCKS
 ||

2275 
Ãxt
 !ğ
EXT_MAX_BLOCKS
)) {

2276 
	`EXT4_ERROR_INODE
(
šode
,

2279 
Ãxt
, 
Ãxt_d–
);

2280 
”r
 = -
EFSCORRUPTED
;

2285 ià(
exi¡s
) {

2286 
”r
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
,

2287 (
__u64
)
es
.
es_lblk
 << 
blksize_b™s
,

2288 (
__u64
)
es
.
es_pblk
 << 
blksize_b™s
,

2289 (
__u64
)
es
.
es_Ën
 << 
blksize_b™s
,

2290 
æags
);

2291 ià(
”r
 < 0)

2293 ià(
”r
 == 1) {

2294 
”r
 = 0;

2299 
block
 = 
es
.
es_lblk
 +ƒs.
es_Ën
;

2302 
	`ext4_ext_drİ_»fs
(
·th
);

2303 
	`kä“
(
·th
);

2304  
”r
;

2305 
	}
}

2320 
ext4_lblk_t
 
	$ext4_ext_d‘”mše_hŞe
(
šode
 *inode,

2321 
ext4_ext_·th
 *
·th
,

2322 
ext4_lblk_t
 *
lblk
)

2324 
d•th
 = 
	`ext_d•th
(
šode
);

2325 
ext4_ex‹Á
 *
ex
;

2326 
ext4_lblk_t
 
Ën
;

2328 
ex
 = 
·th
[
d•th
].
p_ext
;

2329 ià(
ex
 =ğ
NULL
) {

2331 *
lblk
 = 0;

2332 
Ën
 = 
EXT_MAX_BLOCKS
;

2333 } ià(*
lblk
 < 
	`Ë32_to_ıu
(
ex
->
“_block
)) {

2334 
Ën
 = 
	`Ë32_to_ıu
(
ex
->
“_block
è- *
lblk
;

2335 } ià(*
lblk
 >ğ
	`Ë32_to_ıu
(
ex
->
“_block
)

2336 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
)) {

2337 
ext4_lblk_t
 
Ãxt
;

2339 *
lblk
 = 
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
	`ext4_ext_g‘_aùu®_Ën
(ex);

2340 
Ãxt
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

2341 
	`BUG_ON
(
Ãxt
 =ğ*
lblk
);

2342 
Ën
 = 
Ãxt
 - *
lblk
;

2344 
	`BUG
();

2346  
Ën
;

2347 
	}
}

2355 
	$ext4_ext_put_g­_š_ÿche
(
šode
 *šode, 
ext4_lblk_t
 
hŞe_¡¬t
,

2356 
ext4_lblk_t
 
hŞe_Ën
)

2358 
ex‹Á_¡©us
 
es
;

2360 
	`ext4_es_fšd_d–ayed_ex‹Á_¿nge
(
šode
, 
hŞe_¡¬t
,

2361 
hŞe_¡¬t
 + 
hŞe_Ën
 - 1, &
es
);

2362 ià(
es
.
es_Ën
) {

2364 ià(
es
.
es_lblk
 <ğ
hŞe_¡¬t
)

2366 
hŞe_Ën
 = 
	`mš
(
es
.
es_lblk
 - 
hŞe_¡¬t
, hole_len);

2368 
	`ext_debug
(" -> %u:%u\n", 
hŞe_¡¬t
, 
hŞe_Ën
);

2369 
	`ext4_es_š£¹_ex‹Á
(
šode
, 
hŞe_¡¬t
, 
hŞe_Ën
, ~0,

2370 
EXTENT_STATUS_HOLE
);

2371 
	}
}

2377 
	$ext4_ext_rm_idx
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2378 
ext4_ext_·th
 *
·th
, 
d•th
)

2380 
”r
;

2381 
ext4_fsblk_t
 
Ëaf
;

2384 
d•th
--;

2385 
·th
 =…©h + 
d•th
;

2386 
Ëaf
 = 
	`ext4_idx_pblock
(
·th
->
p_idx
);

2387 ià(
	`uÆik–y
(
·th
->
p_hdr
->
eh_’Œ›s
 == 0)) {

2388 
	`EXT4_ERROR_INODE
(
šode
, "path->p_hdr->eh_entries == 0");

2389  -
EFSCORRUPTED
;

2391 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
);

2392 ià(
”r
)

2393  
”r
;

2395 ià(
·th
->
p_idx
 !ğ
	`EXT_LAST_INDEX
Õ©h->
p_hdr
)) {

2396 
Ën
 = 
	`EXT_LAST_INDEX
(
·th
->
p_hdr
è-…©h->
p_idx
;

2397 
Ën
 *ğ(
ext4_ex‹Á_idx
);

2398 
	`memmove
(
·th
->
p_idx
,…©h->p_idx + 1, 
Ën
);

2401 
	`Ë16_add_ıu
(&
·th
->
p_hdr
->
eh_’Œ›s
, -1);

2402 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
);

2403 ià(
”r
)

2404  
”r
;

2405 
	`ext_debug
("šdex i em±y,„emov™, f»block %Îu\n", 
Ëaf
);

2406 
	`Œaû_ext4_ext_rm_idx
(
šode
, 
Ëaf
);

2408 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
Ëaf
, 1,

2409 
EXT4_FREE_BLOCKS_METADATA
 | 
EXT4_FREE_BLOCKS_FORGET
);

2411 --
d•th
 >= 0) {

2412 ià(
·th
->
p_idx
 !ğ
	`EXT_FIRST_INDEX
Õ©h->
p_hdr
))

2414 
·th
--;

2415 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
);

2416 ià(
”r
)

2418 
·th
->
p_idx
->
ei_block
 = (path+1)->p_idx->ei_block;

2419 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
);

2420 ià(
”r
)

2423  
”r
;

2424 
	}
}

2433 
	$ext4_ext_ÿlc_üed™s_fÜ_sšgË_ex‹Á
(
šode
 *šode, 
Äblocks
,

2434 
ext4_ext_·th
 *
·th
)

2436 ià(
·th
) {

2437 
d•th
 = 
	`ext_d•th
(
šode
);

2438 
»t
 = 0;

2441 ià(
	`Ë16_to_ıu
(
·th
[
d•th
].
p_hdr
->
eh_’Œ›s
)

2442 < 
	`Ë16_to_ıu
(
·th
[
d•th
].
p_hdr
->
eh_max
)) {

2453 
»t
 = 2 + 
	`EXT4_META_TRANS_BLOCKS
(
šode
->
i_sb
);

2454  
»t
;

2458  
	`ext4_chunk_Œªs_blocks
(
šode
, 
Äblocks
);

2459 
	}
}

2470 
	$ext4_ext_šdex_Œªs_blocks
(
šode
 *šode, 
ex‹Ás
)

2472 
šdex
;

2473 
d•th
;

2476 ià(
	`ext4_has_šlše_d©a
(
šode
))

2479 
d•th
 = 
	`ext_d•th
(
šode
);

2481 ià(
ex‹Ás
 <= 1)

2482 
šdex
 = 
d•th
 * 2;

2484 
šdex
 = 
d•th
 * 3;

2486  
šdex
;

2487 
	}
}

2489 
šlše
 
	$g‘_deçuÉ_ä“_blocks_æags
(
šode
 *inode)

2491 ià(
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode) ||

2492 
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EA_INODE
))

2493  
EXT4_FREE_BLOCKS_METADATA
 | 
EXT4_FREE_BLOCKS_FORGET
;

2494 ià(
	`ext4_should_jouº®_d©a
(
šode
))

2495  
EXT4_FREE_BLOCKS_FORGET
;

2497 
	}
}

2499 
	$ext4_»move_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2500 
ext4_ex‹Á
 *
ex
,

2501 *
·¹Ÿl_şu¡”
,

2502 
ext4_lblk_t
 
äom
,ƒxt4_lblk_ˆ
to
)

2504 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2505 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2506 
ext4_fsblk_t
 
pblk
;

2507 
æags
 = 
	`g‘_deçuÉ_ä“_blocks_æags
(
šode
);

2516 
æags
 |ğ
EXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
;

2518 
	`Œaû_ext4_»move_blocks
(
šode
, 
ex
, 
äom
, 
to
, *
·¹Ÿl_şu¡”
);

2524 
pblk
 = 
	`ext4_ext_pblock
(
ex
è+ 
“_Ën
 - 1;

2525 ià(*
·¹Ÿl_şu¡”
 > 0 &&

2526 *
·¹Ÿl_şu¡”
 !ğ(è
	`EXT4_B2C
(
sbi
, 
pblk
)) {

2527 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

2528 
	`EXT4_C2B
(
sbi
, *
·¹Ÿl_şu¡”
),

2529 
sbi
->
s_şu¡”_¿tio
, 
æags
);

2530 *
·¹Ÿl_şu¡”
 = 0;

2533 #ifdeà
EXTENTS_STATS


2535 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2536 
	`¥š_lock
(&
sbi
->
s_ext_¡©s_lock
);

2537 
sbi
->
s_ext_blocks
 +ğ
“_Ën
;

2538 
sbi
->
s_ext_ex‹Ás
++;

2539 ià(
“_Ën
 < 
sbi
->
s_ext_mš
)

2540 
sbi
->
s_ext_mš
 = 
“_Ën
;

2541 ià(
“_Ën
 > 
sbi
->
s_ext_max
)

2542 
sbi
->
s_ext_max
 = 
“_Ën
;

2543 ià(
	`ext_d•th
(
šode
è> 
sbi
->
s_d•th_max
)

2544 
sbi
->
s_d•th_max
 = 
	`ext_d•th
(
šode
);

2545 
	`¥š_uÆock
(&
sbi
->
s_ext_¡©s_lock
);

2548 ià(
äom
 >ğ
	`Ë32_to_ıu
(
ex
->
“_block
)

2549 && 
to
 =ğ
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
 - 1) {

2551 
ext4_lblk_t
 
num
;

2552 
fœ¡_şu¡”
;

2554 
num
 = 
	`Ë32_to_ıu
(
ex
->
“_block
è+ 
“_Ën
 - 
äom
;

2555 
pblk
 = 
	`ext4_ext_pblock
(
ex
è+ 
“_Ën
 - 
num
;

2561 ià(*
·¹Ÿl_şu¡”
 < 0 &&

2562 *
·¹Ÿl_şu¡”
 =ğ-(è
	`EXT4_B2C
(
sbi
, 
pblk
+
num
-1))

2563 
æags
 |ğ
EXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
;

2565 
	`ext_debug
("free†ast %u blocks starting %llu…artial %lld\n",

2566 
num
, 
pblk
, *
·¹Ÿl_şu¡”
);

2567 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
pblk
, 
num
, 
æags
);

2584 ià(
	`EXT4_PBLK_COFF
(
sbi
, 
pblk
è&& 
“_Ën
 =ğ
num
) {

2585 
fœ¡_şu¡”
 = (è
	`EXT4_B2C
(
sbi
, 
pblk
);

2586 ià(
fœ¡_şu¡”
 !ğ-*
·¹Ÿl_şu¡”
)

2587 *
·¹Ÿl_şu¡”
 = 
fœ¡_şu¡”
;

2589 *
·¹Ÿl_şu¡”
 = 0;

2592 
	`ext4_”rÜ
(
sbi
->
s_sb
, "strange„equest:„emoval(2) "

2594 
äom
, 
to
, 
	`Ë32_to_ıu
(
ex
->
“_block
), 
“_Ën
);

2596 
	}
}

2615 
	$ext4_ext_rm_Ëaf
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2616 
ext4_ext_·th
 *
·th
,

2617 *
·¹Ÿl_şu¡”
,

2618 
ext4_lblk_t
 
¡¬t
,ƒxt4_lblk_ˆ
’d
)

2620 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2621 
”r
 = 0, 
cÜ»ù_šdex
 = 0;

2622 
d•th
 = 
	`ext_d•th
(
šode
), 
üed™s
;

2623 
ext4_ex‹Á_h—d”
 *
eh
;

2624 
ext4_lblk_t
 
a
, 
b
;

2625 
num
;

2626 
ext4_lblk_t
 
ex_“_block
;

2627 
ex_“_Ën
;

2628 
unwr™‹n
 = 0;

2629 
ext4_ex‹Á
 *
ex
;

2630 
ext4_fsblk_t
 
pblk
;

2633 
	`ext_debug
("Œunÿ‹ sšû %u iÀËaàtØ%u\n", 
¡¬t
, 
’d
);

2634 ià(!
·th
[
d•th
].
p_hdr
)

2635 
·th
[
d•th
].
p_hdr
 = 
	`ext_block_hdr
Õ©h[d•th].
p_bh
);

2636 
eh
 = 
·th
[
d•th
].
p_hdr
;

2637 ià(
	`uÆik–y
(
·th
[
d•th
].
p_hdr
 =ğ
NULL
)) {

2638 
	`EXT4_ERROR_INODE
(
šode
, "·th[%d].p_hd¸=ğNULL", 
d•th
);

2639  -
EFSCORRUPTED
;

2642 
ex
 = 
·th
[
d•th
].
p_ext
;

2643 ià(!
ex
)

2644 
ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

2646 
ex_“_block
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2647 
ex_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2649 
	`Œaû_ext4_ext_rm_Ëaf
(
šode
, 
¡¬t
, 
ex
, *
·¹Ÿl_şu¡”
);

2651 
ex
 >ğ
	`EXT_FIRST_EXTENT
(
eh
) &&

2652 
ex_“_block
 + 
ex_“_Ën
 > 
¡¬t
) {

2654 ià(
	`ext4_ext_is_unwr™‹n
(
ex
))

2655 
unwr™‹n
 = 1;

2657 
unwr™‹n
 = 0;

2659 
	`ext_debug
("»movexˆ%u:[%d]%d\n", 
ex_“_block
,

2660 
unwr™‹n
, 
ex_“_Ën
);

2661 
·th
[
d•th
].
p_ext
 = 
ex
;

2663 
a
 = 
ex_“_block
 > 
¡¬t
 ?ƒx_ee_block : start;

2664 
b
 = 
ex_“_block
+
ex_“_Ën
 - 1 < 
’d
 ?

2665 
ex_“_block
+
ex_“_Ën
 - 1 : 
’d
;

2667 
	`ext_debug
(" bÜd” %u:%u\n", 
a
, 
b
);

2670 ià(
’d
 < 
ex_“_block
) {

2678 ià(
sbi
->
s_şu¡”_¿tio
 > 1) {

2679 
pblk
 = 
	`ext4_ext_pblock
(
ex
);

2680 *
·¹Ÿl_şu¡”
 =

2681 -(è
	`EXT4_B2C
(
sbi
, 
pblk
);

2683 
ex
--;

2684 
ex_“_block
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2685 
ex_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2687 } ià(
b
 !ğ
ex_“_block
 + 
ex_“_Ën
 - 1) {

2688 
	`EXT4_ERROR_INODE
(
šode
,

2691 
¡¬t
, 
’d
, 
ex_“_block
,

2692 
ex_“_block
 + 
ex_“_Ën
 - 1);

2693 
”r
 = -
EFSCORRUPTED
;

2694 
out
;

2695 } ià(
a
 !ğ
ex_“_block
) {

2697 
num
 = 
a
 - 
ex_“_block
;

2700 
num
 = 0;

2708 
üed™s
 = 7 + 2*(
ex_“_Ën
/
	`EXT4_BLOCKS_PER_GROUP
(
šode
->
i_sb
));

2709 ià(
ex
 =ğ
	`EXT_FIRST_EXTENT
(
eh
)) {

2710 
cÜ»ù_šdex
 = 1;

2711 
üed™s
 +ğ(
	`ext_d•th
(
šode
)) + 1;

2713 
üed™s
 +ğ
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
šode
->
i_sb
);

2715 
”r
 = 
	`ext4_ext_Œunÿ‹_ex‹nd_»¡¬t
(
hªdË
, 
šode
, 
üed™s
);

2716 ià(
”r
)

2717 
out
;

2719 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

2720 ià(
”r
)

2721 
out
;

2723 
”r
 = 
	`ext4_»move_blocks
(
hªdË
, 
šode
, 
ex
, 
·¹Ÿl_şu¡”
,

2724 
a
, 
b
);

2725 ià(
”r
)

2726 
out
;

2728 ià(
num
 == 0)

2730 
	`ext4_ext_¡Üe_pblock
(
ex
, 0);

2732 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
num
);

2737 ià(
unwr™‹n
 && 
num
)

2738 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

2743 ià(
num
 == 0) {

2744 ià(
’d
 !ğ
EXT_MAX_BLOCKS
 - 1) {

2750 
	`memmove
(
ex
,ƒx+1, (
	`EXT_LAST_EXTENT
(
eh
) -ƒx) *

2751 (
ext4_ex‹Á
));

2754 
	`mem£t
(
	`EXT_LAST_EXTENT
(
eh
), 0,

2755 (
ext4_ex‹Á
));

2757 
	`Ë16_add_ıu
(&
eh
->
eh_’Œ›s
, -1);

2760 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

2761 ià(
”r
)

2762 
out
;

2764 
	`ext_debug
("Ãwƒx‹Á: %u:%u:%Îu\n", 
ex_“_block
, 
num
,

2765 
	`ext4_ext_pblock
(
ex
));

2766 
ex
--;

2767 
ex_“_block
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

2768 
ex_“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

2771 ià(
cÜ»ù_šdex
 && 
eh
->
eh_’Œ›s
)

2772 
”r
 = 
	`ext4_ext_cÜ»ù_šdexes
(
hªdË
, 
šode
, 
·th
);

2781 ià(*
·¹Ÿl_şu¡”
 > 0 && 
ex
 >ğ
	`EXT_FIRST_EXTENT
(
eh
)) {

2782 
pblk
 = 
	`ext4_ext_pblock
(
ex
è+ 
ex_“_Ën
 - 1;

2783 ià(*
·¹Ÿl_şu¡”
 !ğ(è
	`EXT4_B2C
(
sbi
, 
pblk
)) {

2784 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

2785 
	`EXT4_C2B
(
sbi
, *
·¹Ÿl_şu¡”
),

2786 
sbi
->
s_şu¡”_¿tio
,

2787 
	`g‘_deçuÉ_ä“_blocks_æags
(
šode
));

2789 *
·¹Ÿl_şu¡”
 = 0;

2794 ià(
”r
 =ğ0 && 
eh
->
eh_’Œ›s
 =ğ0 && 
·th
[
d•th
].
p_bh
 !ğ
NULL
)

2795 
”r
 = 
	`ext4_ext_rm_idx
(
hªdË
, 
šode
, 
·th
, 
d•th
);

2797 
out
:

2798  
”r
;

2799 
	}
}

2806 
	$ext4_ext_mÜe_to_rm
(
ext4_ext_·th
 *
·th
)

2808 
	`BUG_ON
(
·th
->
p_idx
 =ğ
NULL
);

2810 ià(
·th
->
p_idx
 < 
	`EXT_FIRST_INDEX
Õ©h->
p_hdr
))

2817 ià(
	`Ë16_to_ıu
(
·th
->
p_hdr
->
eh_’Œ›s
è=ğ·th->
p_block
)

2820 
	}
}

2823 
	$ext4_m‘a_ext_»move_¥aû
(
šode
 *šode, 
ext4_lblk_t
 
¡¬t
,

2824 
ext4_lblk_t
 
’d
, 
hªdË_t
 *
hªdË
)

2826 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2827 
d•th
 = 
	`ext_d•th
(
šode
);

2828 
ext4_ext_·th
 *
·th
 = 
NULL
;

2829 
·¹Ÿl_şu¡”
 = 0;

2830 
i
 = 0, 
”r
 = 0;

2832 
	`ext_debug
("Œunÿ‹ sšû %uØ%u\n", 
¡¬t
, 
’d
);

2840 
agaš
:

2841 
	`Œaû_ext4_ext_»move_¥aû
(
šode
, 
¡¬t
, 
’d
, 
d•th
);

2850 ià(
’d
 < 
EXT_MAX_BLOCKS
 - 1) {

2851 
ext4_ex‹Á
 *
ex
;

2852 
ext4_lblk_t
 
“_block
, 
ex_’d
, 
lblk
;

2853 
ext4_fsblk_t
 
pblk
;

2856 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
’d
, 
NULL
, 
EXT4_EX_NOCACHE
);

2857 ià(
	`IS_ERR
(
·th
)) {

2858 
	`ext4_jouº®_¡İ
(
hªdË
);

2859  
	`PTR_ERR
(
·th
);

2861 
d•th
 = 
	`ext_d•th
(
šode
);

2863 
ex
 = 
·th
[
d•th
].
p_ext
;

2864 ià(!
ex
) {

2865 ià(
d•th
) {

2866 
	`EXT4_ERROR_INODE
(
šode
,

2868 
d•th
);

2869 
”r
 = -
EFSCORRUPTED
;

2871 
out
;

2874 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

2875 
ex_’d
 = 
“_block
 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
) - 1;

2883 ià(
’d
 >ğ
“_block
 &&ƒnd < 
ex_’d
) {

2890 ià(
sbi
->
s_şu¡”_¿tio
 > 1) {

2891 
pblk
 = 
	`ext4_ext_pblock
(
ex
è+ 
’d
 - 
“_block
 + 2;

2892 
·¹Ÿl_şu¡”
 =

2893 -(è
	`EXT4_B2C
(
sbi
, 
pblk
);

2902 
”r
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode
, &
·th
,

2903 
’d
 + 1, 1);

2904 ià(
”r
 < 0)

2905 
out
;

2907 } ià(
sbi
->
s_şu¡”_¿tio
 > 1 && 
’d
 >ğ
ex_’d
) {

2916 
lblk
 = 
ex_’d
 + 1;

2917 
”r
 = 
	`ext4_ext_£¬ch_right
(
šode
, 
·th
, &
lblk
, &
pblk
,

2918 &
ex
);

2919 ià(
”r
)

2920 
out
;

2921 ià(
pblk
)

2922 
·¹Ÿl_şu¡”
 =

2923 -(è
	`EXT4_B2C
(
sbi
, 
pblk
);

2930 
d•th
 = 
	`ext_d•th
(
šode
);

2931 ià(
·th
) {

2932 
k
 = 
i
 = 
d•th
;

2933 --
k
 > 0)

2934 
·th
[
k
].
p_block
 =

2935 
	`Ë16_to_ıu
(
·th
[
k
].
p_hdr
->
eh_’Œ›s
)+1;

2937 
·th
 = 
	`kz®loc
((
ext4_ext_·th
è* (
d•th
 + 1),

2938 
GFP_NOFS
);

2939 ià(
·th
 =ğ
NULL
) {

2940 
	`ext4_jouº®_¡İ
(
hªdË
);

2941  -
ENOMEM
;

2943 
·th
[0].
p_maxd•th
 =…©h[0].
p_d•th
 = 
d•th
;

2944 
·th
[0].
p_hdr
 = 
	`ext_šode_hdr
(
šode
);

2945 
i
 = 0;

2947 ià(
	`ext4_ext_check
(
šode
, 
·th
[0].
p_hdr
, 
d•th
, 0)) {

2948 
”r
 = -
EFSCORRUPTED
;

2949 
out
;

2952 
”r
 = 0;

2954 
i
 >ğ0 && 
”r
 == 0) {

2955 ià(
i
 =ğ
d•th
) {

2957 
”r
 = 
	`ext4_ext_rm_Ëaf
(
hªdË
, 
šode
, 
·th
,

2958 &
·¹Ÿl_şu¡”
, 
¡¬t
,

2959 
’d
);

2961 
	`b»l£
(
·th
[
i
].
p_bh
);

2962 
·th
[
i
].
p_bh
 = 
NULL
;

2963 
i
--;

2968 ià(!
·th
[
i
].
p_hdr
) {

2969 
	`ext_debug
("initialize header\n");

2970 
·th
[
i
].
p_hdr
 = 
	`ext_block_hdr
Õ©h[i].
p_bh
);

2973 ià(!
·th
[
i
].
p_idx
) {

2975 
·th
[
i
].
p_idx
 = 
	`EXT_LAST_INDEX
Õ©h[i].
p_hdr
);

2976 
·th
[
i
].
p_block
 = 
	`Ë16_to_ıu
Õ©h[i].
p_hdr
->
eh_’Œ›s
)+1;

2977 
	`ext_debug
("init index…tr: hdr 0x%p,‚um %d\n",

2978 
·th
[
i
].
p_hdr
,

2979 
	`Ë16_to_ıu
(
·th
[
i
].
p_hdr
->
eh_’Œ›s
));

2982 
·th
[
i
].
p_idx
--;

2985 
	`ext_debug
("level %d - index, first 0x%p, cur 0x%p\n",

2986 
i
, 
	`EXT_FIRST_INDEX
(
·th
[i].
p_hdr
),

2987 
·th
[
i
].
p_idx
);

2988 ià(
	`ext4_ext_mÜe_to_rm
(
·th
 + 
i
)) {

2989 
bufãr_h—d
 *
bh
;

2991 
	`ext_debug
("moveo†evel %d (block %llu)\n",

2992 
i
 + 1, 
	`ext4_idx_pblock
(
·th
[i].
p_idx
));

2993 
	`mem£t
(
·th
 + 
i
 + 1, 0, (*path));

2994 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
,

2995 
	`ext4_idx_pblock
(
·th
[
i
].
p_idx
), 
d•th
 - i - 1,

2996 
EXT4_EX_NOCACHE
);

2997 ià(
	`IS_ERR
(
bh
)) {

2999 
”r
 = 
	`PTR_ERR
(
bh
);

3004 
	`cÚd_»sched
();

3005 ià(
	`WARN_ON
(
i
 + 1 > 
d•th
)) {

3006 
”r
 = -
EFSCORRUPTED
;

3009 
·th
[
i
 + 1].
p_bh
 = 
bh
;

3013 
·th
[
i
].
p_block
 = 
	`Ë16_to_ıu
Õ©h[i].
p_hdr
->
eh_’Œ›s
);

3014 
i
++;

3017 ià(
·th
[
i
].
p_hdr
->
eh_’Œ›s
 == 0 && i > 0) {

3021 
”r
 = 
	`ext4_ext_rm_idx
(
hªdË
, 
šode
, 
·th
, 
i
);

3024 
	`b»l£
(
·th
[
i
].
p_bh
);

3025 
·th
[
i
].
p_bh
 = 
NULL
;

3026 
i
--;

3027 
	`ext_debug
("»tuºØËv– %d\n", 
i
);

3031 
	`Œaû_ext4_ext_»move_¥aû_dÚe
(
šode
, 
¡¬t
, 
’d
, 
d•th
,

3032 
·¹Ÿl_şu¡”
, 
·th
->
p_hdr
->
eh_’Œ›s
);

3040 ià(
·¹Ÿl_şu¡”
 > 0 && 
”r
 == 0) {

3042 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

3043 
	`EXT4_C2B
(
sbi
, 
·¹Ÿl_şu¡”
),

3044 
sbi
->
s_şu¡”_¿tio
,

3045 
	`g‘_deçuÉ_ä“_blocks_æags
(
šode
));

3049 ià(
·th
->
p_hdr
->
eh_’Œ›s
 == 0) {

3054 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
);

3055 ià(
”r
 == 0) {

3056 
	`ext_šode_hdr
(
šode
)->
eh_d•th
 = 0;

3057 
	`ext_šode_hdr
(
šode
)->
eh_max
 =

3058 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_roÙ
(
šode
, 0));

3059 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
);

3062 
out
:

3063 
	`ext4_ext_drİ_»fs
(
·th
);

3064 
	`kä“
(
·th
);

3065 
·th
 = 
NULL
;

3066 ià(
”r
 =ğ-
EAGAIN
)

3067 
agaš
;

3070  
”r
;

3071 
	}
}

3075 
	$ext4_ext_»move_¥aû
(
šode
 *šode, 
ext4_lblk_t
 
¡¬t
,

3076 
ext4_lblk_t
 
’d
)

3078 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

3079 
d•th
 = 
	`ext_d•th
(
šode
);

3080 
ext4_ext_·th
 *
·th
 = 
NULL
;

3081 
·¹Ÿl_şu¡”
 = 0;

3082 
hªdË_t
 *
hªdË
;

3083 
i
 = 0, 
”r
 = 0;

3085 
	`ext_debug
("Œunÿ‹ sšû %uØ%u\n", 
¡¬t
, 
’d
);

3088 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
d•th
 + 1);

3089 ià(
	`IS_ERR
(
hªdË
))

3090  
	`PTR_ERR
(
hªdË
);

3092 
agaš
:

3093 
	`Œaû_ext4_ext_»move_¥aû
(
šode
, 
¡¬t
, 
’d
, 
d•th
);

3102 ià(
’d
 < 
EXT_MAX_BLOCKS
 - 1) {

3103 
ext4_ex‹Á
 *
ex
;

3104 
ext4_lblk_t
 
“_block
, 
ex_’d
, 
lblk
;

3105 
ext4_fsblk_t
 
pblk
;

3108 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
’d
, 
NULL
, 
EXT4_EX_NOCACHE
);

3109 ià(
	`IS_ERR
(
·th
)) {

3110 
	`ext4_jouº®_¡İ
(
hªdË
);

3111  
	`PTR_ERR
(
·th
);

3113 
d•th
 = 
	`ext_d•th
(
šode
);

3115 
ex
 = 
·th
[
d•th
].
p_ext
;

3116 ià(!
ex
) {

3117 ià(
d•th
) {

3118 
	`EXT4_ERROR_INODE
(
šode
,

3120 
d•th
);

3121 
”r
 = -
EFSCORRUPTED
;

3123 
out
;

3126 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3127 
ex_’d
 = 
“_block
 + 
	`ext4_ext_g‘_aùu®_Ën
(
ex
) - 1;

3135 ià(
’d
 >ğ
“_block
 &&ƒnd < 
ex_’d
) {

3142 ià(
sbi
->
s_şu¡”_¿tio
 > 1) {

3143 
pblk
 = 
	`ext4_ext_pblock
(
ex
è+ 
’d
 - 
“_block
 + 2;

3144 
·¹Ÿl_şu¡”
 =

3145 -(è
	`EXT4_B2C
(
sbi
, 
pblk
);

3154 
”r
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode
, &
·th
,

3155 
’d
 + 1, 1);

3156 ià(
”r
 < 0)

3157 
out
;

3159 } ià(
sbi
->
s_şu¡”_¿tio
 > 1 && 
’d
 >ğ
ex_’d
) {

3168 
lblk
 = 
ex_’d
 + 1;

3169 
”r
 = 
	`ext4_ext_£¬ch_right
(
šode
, 
·th
, &
lblk
, &
pblk
,

3170 &
ex
);

3171 ià(
”r
)

3172 
out
;

3173 ià(
pblk
)

3174 
·¹Ÿl_şu¡”
 =

3175 -(è
	`EXT4_B2C
(
sbi
, 
pblk
);

3182 
d•th
 = 
	`ext_d•th
(
šode
);

3183 ià(
·th
) {

3184 
k
 = 
i
 = 
d•th
;

3185 --
k
 > 0)

3186 
·th
[
k
].
p_block
 =

3187 
	`Ë16_to_ıu
(
·th
[
k
].
p_hdr
->
eh_’Œ›s
)+1;

3189 
·th
 = 
	`kz®loc
((
ext4_ext_·th
è* (
d•th
 + 1),

3190 
GFP_NOFS
);

3191 ià(
·th
 =ğ
NULL
) {

3192 
	`ext4_jouº®_¡İ
(
hªdË
);

3193  -
ENOMEM
;

3195 
·th
[0].
p_maxd•th
 =…©h[0].
p_d•th
 = 
d•th
;

3196 
·th
[0].
p_hdr
 = 
	`ext_šode_hdr
(
šode
);

3197 
i
 = 0;

3199 ià(
	`ext4_ext_check
(
šode
, 
·th
[0].
p_hdr
, 
d•th
, 0)) {

3200 
”r
 = -
EFSCORRUPTED
;

3201 
out
;

3204 
”r
 = 0;

3206 
i
 >ğ0 && 
”r
 == 0) {

3207 ià(
i
 =ğ
d•th
) {

3209 
”r
 = 
	`ext4_ext_rm_Ëaf
(
hªdË
, 
šode
, 
·th
,

3210 &
·¹Ÿl_şu¡”
, 
¡¬t
,

3211 
’d
);

3213 
	`b»l£
(
·th
[
i
].
p_bh
);

3214 
·th
[
i
].
p_bh
 = 
NULL
;

3215 
i
--;

3220 ià(!
·th
[
i
].
p_hdr
) {

3221 
	`ext_debug
("initialize header\n");

3222 
·th
[
i
].
p_hdr
 = 
	`ext_block_hdr
Õ©h[i].
p_bh
);

3225 ià(!
·th
[
i
].
p_idx
) {

3227 
·th
[
i
].
p_idx
 = 
	`EXT_LAST_INDEX
Õ©h[i].
p_hdr
);

3228 
·th
[
i
].
p_block
 = 
	`Ë16_to_ıu
Õ©h[i].
p_hdr
->
eh_’Œ›s
)+1;

3229 
	`ext_debug
("init index…tr: hdr 0x%p,‚um %d\n",

3230 
·th
[
i
].
p_hdr
,

3231 
	`Ë16_to_ıu
(
·th
[
i
].
p_hdr
->
eh_’Œ›s
));

3234 
·th
[
i
].
p_idx
--;

3237 
	`ext_debug
("level %d - index, first 0x%p, cur 0x%p\n",

3238 
i
, 
	`EXT_FIRST_INDEX
(
·th
[i].
p_hdr
),

3239 
·th
[
i
].
p_idx
);

3240 ià(
	`ext4_ext_mÜe_to_rm
(
·th
 + 
i
)) {

3241 
bufãr_h—d
 *
bh
;

3243 
	`ext_debug
("moveo†evel %d (block %llu)\n",

3244 
i
 + 1, 
	`ext4_idx_pblock
(
·th
[i].
p_idx
));

3245 
	`mem£t
(
·th
 + 
i
 + 1, 0, (*path));

3246 
bh
 = 
	`»ad_ex‹Á_Œ“_block
(
šode
,

3247 
	`ext4_idx_pblock
(
·th
[
i
].
p_idx
), 
d•th
 - i - 1,

3248 
EXT4_EX_NOCACHE
);

3249 ià(
	`IS_ERR
(
bh
)) {

3251 
”r
 = 
	`PTR_ERR
(
bh
);

3256 
	`cÚd_»sched
();

3257 ià(
	`WARN_ON
(
i
 + 1 > 
d•th
)) {

3258 
”r
 = -
EFSCORRUPTED
;

3261 
·th
[
i
 + 1].
p_bh
 = 
bh
;

3265 
·th
[
i
].
p_block
 = 
	`Ë16_to_ıu
Õ©h[i].
p_hdr
->
eh_’Œ›s
);

3266 
i
++;

3269 ià(
·th
[
i
].
p_hdr
->
eh_’Œ›s
 == 0 && i > 0) {

3273 
”r
 = 
	`ext4_ext_rm_idx
(
hªdË
, 
šode
, 
·th
, 
i
);

3276 
	`b»l£
(
·th
[
i
].
p_bh
);

3277 
·th
[
i
].
p_bh
 = 
NULL
;

3278 
i
--;

3279 
	`ext_debug
("»tuºØËv– %d\n", 
i
);

3283 
	`Œaû_ext4_ext_»move_¥aû_dÚe
(
šode
, 
¡¬t
, 
’d
, 
d•th
,

3284 
·¹Ÿl_şu¡”
, 
·th
->
p_hdr
->
eh_’Œ›s
);

3292 ià(
·¹Ÿl_şu¡”
 > 0 && 
”r
 == 0) {

3294 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

3295 
	`EXT4_C2B
(
sbi
, 
·¹Ÿl_şu¡”
),

3296 
sbi
->
s_şu¡”_¿tio
,

3297 
	`g‘_deçuÉ_ä“_blocks_æags
(
šode
));

3301 ià(
·th
->
p_hdr
->
eh_’Œ›s
 == 0) {

3306 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
);

3307 ià(
”r
 == 0) {

3308 
	`ext_šode_hdr
(
šode
)->
eh_d•th
 = 0;

3309 
	`ext_šode_hdr
(
šode
)->
eh_max
 =

3310 
	`ıu_to_Ë16
(
	`ext4_ext_¥aû_roÙ
(
šode
, 0));

3311 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
);

3314 
out
:

3315 
	`ext4_ext_drİ_»fs
(
·th
);

3316 
	`kä“
(
·th
);

3317 
·th
 = 
NULL
;

3318 ià(
”r
 =ğ-
EAGAIN
)

3319 
agaš
;

3320 
	`ext4_jouº®_¡İ
(
hªdË
);

3322  
”r
;

3323 
	}
}

3328 
	$ext4_ext_š™
(
su³r_block
 *
sb
)

3334 ià(
	`ext4_has_ã©u»_ex‹Ás
(
sb
)) {

3335 #ià
	`defšed
(
AGGRESSIVE_TEST
è|| defšed(
CHECK_BINSEARCH
è|| defšed(
EXTENTS_STATS
)

3336 
	`´štk
(
KERN_INFO
 "EXT4-fs: fileƒxtentsƒnabled"

3337 #ifdeà
AGGRESSIVE_TEST


3340 #ifdeà
CHECK_BINSEARCH


3343 #ifdeà
EXTENTS_STATS


3348 #ifdeà
EXTENTS_STATS


3349 
	`¥š_lock_š™
(&
	`EXT4_SB
(
sb
)->
s_ext_¡©s_lock
);

3350 
	`EXT4_SB
(
sb
)->
s_ext_mš
 = 1 << 30;

3351 
	`EXT4_SB
(
sb
)->
s_ext_max
 = 0;

3354 
	}
}

3359 
	$ext4_ext_»Ëa£
(
su³r_block
 *
sb
)

3361 ià(!
	`ext4_has_ã©u»_ex‹Ás
(
sb
))

3364 #ifdeà
EXTENTS_STATS


3365 ià(
	`EXT4_SB
(
sb
)->
s_ext_blocks
 && EXT4_SB(sb)->
s_ext_ex‹Ás
) {

3366 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3367 
	`´štk
(
KERN_ERR
 "EXT4-fs: %lu blocks in %luƒxtents (%lu‡ve)\n",

3368 
sbi
->
s_ext_blocks
, sbi->
s_ext_ex‹Ás
,

3369 
sbi
->
s_ext_blocks
 / sbi->
s_ext_ex‹Ás
);

3370 
	`´štk
(
KERN_ERR
 "EXT4-fs:ƒxtents: %lu min, %lu max, max depth %lu\n",

3371 
sbi
->
s_ext_mš
, sbi->
s_ext_max
, sbi->
s_d•th_max
);

3374 
	}
}

3376 
	$ext4_z”oout_es
(
šode
 *šode, 
ext4_ex‹Á
 *
ex
)

3378 
ext4_lblk_t
 
“_block
;

3379 
ext4_fsblk_t
 
“_pblock
;

3380 
“_Ën
;

3382 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3383 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3384 
“_pblock
 = 
	`ext4_ext_pblock
(
ex
);

3386 ià(
“_Ën
 == 0)

3389  
	`ext4_es_š£¹_ex‹Á
(
šode
, 
“_block
, 
“_Ën
, 
“_pblock
,

3390 
EXTENT_STATUS_WRITTEN
);

3391 
	}
}

3394 
	$ext4_ext_z”oout
(
šode
 *šode, 
ext4_ex‹Á
 *
ex
)

3396 
ext4_fsblk_t
 
“_pblock
;

3397 
“_Ën
;

3399 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3400 
“_pblock
 = 
	`ext4_ext_pblock
(
ex
);

3401  
	`ext4_issue_z”oout
(
šode
, 
	`Ë32_to_ıu
(
ex
->
“_block
), 
“_pblock
,

3402 
“_Ën
);

3403 
	}
}

3426 
	$ext4_¥l™_ex‹Á_©
(
hªdË_t
 *
hªdË
,

3427 
šode
 *inode,

3428 
ext4_ext_·th
 **
µ©h
,

3429 
ext4_lblk_t
 
¥l™
,

3430 
¥l™_æag
,

3431 
æags
)

3433 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3434 
ext4_fsblk_t
 
Ãwblock
;

3435 
ext4_lblk_t
 
“_block
;

3436 
ext4_ex‹Á
 *
ex
, 
Ãwex
, 
Üig_ex
, 
z”o_ex
;

3437 
ext4_ex‹Á
 *
ex2
 = 
NULL
;

3438 
“_Ën
, 
d•th
;

3439 
”r
 = 0;

3441 
	`BUG_ON
((
¥l™_æag
 & (
EXT4_EXT_DATA_VALID1
 | 
EXT4_EXT_DATA_VALID2
)) ==

3442 (
EXT4_EXT_DATA_VALID1
 | 
EXT4_EXT_DATA_VALID2
));

3444 
	`ext_debug
("ext4_split_extents_at: inode %lu,†ogical"

3445 "block %Îu\n", 
šode
->
i_šo
, ()
¥l™
);

3447 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

3449 
d•th
 = 
	`ext_d•th
(
šode
);

3450 
ex
 = 
·th
[
d•th
].
p_ext
;

3451 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3452 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3453 
Ãwblock
 = 
¥l™
 - 
“_block
 + 
	`ext4_ext_pblock
(
ex
);

3455 
	`BUG_ON
(
¥l™
 < 
“_block
 || s¶™ >ğÓe_block + 
“_Ën
));

3456 
	`BUG_ON
(!
	`ext4_ext_is_unwr™‹n
(
ex
) &&

3457 
¥l™_æag
 & (
EXT4_EXT_MAY_ZEROOUT
 |

3458 
EXT4_EXT_MARK_UNWRIT1
 |

3459 
EXT4_EXT_MARK_UNWRIT2
));

3461 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3462 ià(
”r
)

3463 
out
;

3465 ià(
¥l™
 =ğ
“_block
) {

3471 ià(
¥l™_æag
 & 
EXT4_EXT_MARK_UNWRIT2
)

3472 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

3474 
	`ext4_ext_m¬k_š™Ÿlized
(
ex
);

3476 ià(!(
æags
 & 
EXT4_GET_BLOCKS_PRE_IO
))

3477 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
ex
);

3479 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

3480 
out
;

3484 
	`memıy
(&
Üig_ex
, 
ex
, (orig_ex));

3485 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
¥l™
 - 
“_block
);

3486 ià(
¥l™_æag
 & 
EXT4_EXT_MARK_UNWRIT1
)

3487 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

3493 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3494 ià(
”r
)

3495 
fix_ex‹Á_Ën
;

3497 
ex2
 = &
Ãwex
;

3498 
ex2
->
“_block
 = 
	`ıu_to_Ë32
(
¥l™
);

3499 
ex2
->
“_Ën
 = 
	`ıu_to_Ë16
Óe_ËÀ- (
¥l™
 - 
“_block
));

3500 
	`ext4_ext_¡Üe_pblock
(
ex2
, 
Ãwblock
);

3501 ià(
¥l™_æag
 & 
EXT4_EXT_MARK_UNWRIT2
)

3502 
	`ext4_ext_m¬k_unwr™‹n
(
ex2
);

3504 
”r
 = 
	`ext4_ext_š£¹_ex‹Á
(
hªdË
, 
šode
, 
µ©h
, &
Ãwex
, 
æags
);

3505 ià(
”r
 =ğ-
ENOSPC
 && (
EXT4_EXT_MAY_ZEROOUT
 & 
¥l™_æag
)) {

3506 ià(
¥l™_æag
 & (
EXT4_EXT_DATA_VALID1
|
EXT4_EXT_DATA_VALID2
)) {

3507 ià(
¥l™_æag
 & 
EXT4_EXT_DATA_VALID1
) {

3508 
”r
 = 
	`ext4_ext_z”oout
(
šode
, 
ex2
);

3509 
z”o_ex
.
“_block
 = 
ex2
->ee_block;

3510 
z”o_ex
.
“_Ën
 = 
	`ıu_to_Ë16
(

3511 
	`ext4_ext_g‘_aùu®_Ën
(
ex2
));

3512 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex
,

3513 
	`ext4_ext_pblock
(
ex2
));

3515 
”r
 = 
	`ext4_ext_z”oout
(
šode
, 
ex
);

3516 
z”o_ex
.
“_block
 = 
ex
->ee_block;

3517 
z”o_ex
.
“_Ën
 = 
	`ıu_to_Ë16
(

3518 
	`ext4_ext_g‘_aùu®_Ën
(
ex
));

3519 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex
,

3520 
	`ext4_ext_pblock
(
ex
));

3523 
”r
 = 
	`ext4_ext_z”oout
(
šode
, &
Üig_ex
);

3524 
z”o_ex
.
“_block
 = 
Üig_ex
.ee_block;

3525 
z”o_ex
.
“_Ën
 = 
	`ıu_to_Ë16
(

3526 
	`ext4_ext_g‘_aùu®_Ën
(&
Üig_ex
));

3527 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex
,

3528 
	`ext4_ext_pblock
(&
Üig_ex
));

3531 ià(
”r
)

3532 
fix_ex‹Á_Ën
;

3534 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
(ee_len);

3535 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
ex
);

3536 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

3537 ià(
”r
)

3538 
fix_ex‹Á_Ën
;

3541 
”r
 = 
	`ext4_z”oout_es
(
šode
, &
z”o_ex
);

3543 
out
;

3544 } ià(
”r
)

3545 
fix_ex‹Á_Ën
;

3547 
out
:

3548 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

3549  
”r
;

3551 
fix_ex‹Á_Ën
:

3552 
ex
->
“_Ën
 = 
Üig_ex
.ee_len;

3553 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

3554  
”r
;

3555 
	}
}

3568 
	$ext4_¥l™_ex‹Á
(
hªdË_t
 *
hªdË
,

3569 
šode
 *inode,

3570 
ext4_ext_·th
 **
µ©h
,

3571 
ext4_m­_blocks
 *
m­
,

3572 
¥l™_æag
,

3573 
æags
)

3575 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3576 
ext4_lblk_t
 
“_block
;

3577 
ext4_ex‹Á
 *
ex
;

3578 
“_Ën
, 
d•th
;

3579 
”r
 = 0;

3580 
unwr™‹n
;

3581 
¥l™_æag1
, 
æags1
;

3582 
®loÿ‹d
 = 
m­
->
m_Ën
;

3584 
d•th
 = 
	`ext_d•th
(
šode
);

3585 
ex
 = 
·th
[
d•th
].
p_ext
;

3586 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3587 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3588 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

3590 ià(
m­
->
m_lblk
 + m­->
m_Ën
 < 
“_block
 + 
“_Ën
) {

3591 
¥l™_æag1
 = 
¥l™_æag
 & 
EXT4_EXT_MAY_ZEROOUT
;

3592 
æags1
 = 
æags
 | 
EXT4_GET_BLOCKS_PRE_IO
;

3593 ià(
unwr™‹n
)

3594 
¥l™_æag1
 |ğ
EXT4_EXT_MARK_UNWRIT1
 |

3595 
EXT4_EXT_MARK_UNWRIT2
;

3596 ià(
¥l™_æag
 & 
EXT4_EXT_DATA_VALID2
)

3597 
¥l™_æag1
 |ğ
EXT4_EXT_DATA_VALID1
;

3598 
”r
 = 
	`ext4_¥l™_ex‹Á_©
(
hªdË
, 
šode
, 
µ©h
,

3599 
m­
->
m_lblk
 + m­->
m_Ën
, 
¥l™_æag1
, 
æags1
);

3600 ià(
”r
)

3601 
out
;

3603 
®loÿ‹d
 = 
“_Ën
 - (
m­
->
m_lblk
 - 
“_block
);

3609 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
µ©h
, 0);

3610 ià(
	`IS_ERR
(
·th
))

3611  
	`PTR_ERR
(
·th
);

3612 
d•th
 = 
	`ext_d•th
(
šode
);

3613 
ex
 = 
·th
[
d•th
].
p_ext
;

3614 ià(!
ex
) {

3615 
	`EXT4_ERROR_INODE
(
šode
, "unexpected hole‡t %lu",

3616 (è
m­
->
m_lblk
);

3617  -
EFSCORRUPTED
;

3619 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

3620 
¥l™_æag1
 = 0;

3622 ià(
m­
->
m_lblk
 >ğ
“_block
) {

3623 
¥l™_æag1
 = 
¥l™_æag
 & 
EXT4_EXT_DATA_VALID2
;

3624 ià(
unwr™‹n
) {

3625 
¥l™_æag1
 |ğ
EXT4_EXT_MARK_UNWRIT1
;

3626 
¥l™_æag1
 |ğ
¥l™_æag
 & (
EXT4_EXT_MAY_ZEROOUT
 |

3627 
EXT4_EXT_MARK_UNWRIT2
);

3629 
”r
 = 
	`ext4_¥l™_ex‹Á_©
(
hªdË
, 
šode
, 
µ©h
,

3630 
m­
->
m_lblk
, 
¥l™_æag1
, 
æags
);

3631 ià(
”r
)

3632 
out
;

3635 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

3636 
out
:

3637  
”r
 ?ƒ¼ : 
®loÿ‹d
;

3638 
	}
}

3660 
	$ext4_ext_cÚv”t_to_š™Ÿlized
(
hªdË_t
 *
hªdË
,

3661 
šode
 *inode,

3662 
ext4_m­_blocks
 *
m­
,

3663 
ext4_ext_·th
 **
µ©h
,

3664 
æags
)

3666 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3667 
ext4_sb_šfo
 *
sbi
;

3668 
ext4_ex‹Á_h—d”
 *
eh
;

3669 
ext4_m­_blocks
 
¥l™_m­
;

3670 
ext4_ex‹Á
 
z”o_ex1
, 
z”o_ex2
;

3671 
ext4_ex‹Á
 *
ex
, *
abut_ex
;

3672 
ext4_lblk_t
 
“_block
, 
eof_block
;

3673 
“_Ën
, 
d•th
, 
m­_Ën
 = 
m­
->
m_Ën
;

3674 
®loÿ‹d
 = 0, 
max_z”oout
 = 0;

3675 
”r
 = 0;

3676 
¥l™_æag
 = 
EXT4_EXT_DATA_VALID2
;

3678 
	`ext_debug
("ext4_ext_convert_to_initialized: inode %lu,†ogical"

3679 "block %Îu, max_block %u\n", 
šode
->
i_šo
,

3680 ()
m­
->
m_lblk
, 
m­_Ën
);

3682 
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

3683 
eof_block
 = (
šode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3684 
šode
->
i_sb
->
s_blocksize_b™s
;

3685 ià(
eof_block
 < 
m­
->
m_lblk
 + 
m­_Ën
)

3686 
eof_block
 = 
m­
->
m_lblk
 + 
m­_Ën
;

3688 
d•th
 = 
	`ext_d•th
(
šode
);

3689 
eh
 = 
·th
[
d•th
].
p_hdr
;

3690 
ex
 = 
·th
[
d•th
].
p_ext
;

3691 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3692 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3693 
z”o_ex1
.
“_Ën
 = 0;

3694 
z”o_ex2
.
“_Ën
 = 0;

3696 
	`Œaû_ext4_ext_cÚv”t_to_š™Ÿlized_’‹r
(
šode
, 
m­
, 
ex
);

3699 
	`BUG_ON
(!
	`ext4_ext_is_unwr™‹n
(
ex
));

3700 
	`BUG_ON
(!
	`š_¿nge
(
m­
->
m_lblk
, 
“_block
, 
“_Ën
));

3717 ià((
m­
->
m_lblk
 =ğ
“_block
) &&

3719 (
m­_Ën
 < 
“_Ën
) &&

3720 (
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))) {

3721 
ext4_lblk_t
 
´ev_lblk
;

3722 
ext4_fsblk_t
 
´ev_pblk
, 
“_pblk
;

3723 
´ev_Ën
;

3725 
abut_ex
 = 
ex
 - 1;

3726 
´ev_lblk
 = 
	`Ë32_to_ıu
(
abut_ex
->
“_block
);

3727 
´ev_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
abut_ex
);

3728 
´ev_pblk
 = 
	`ext4_ext_pblock
(
abut_ex
);

3729 
“_pblk
 = 
	`ext4_ext_pblock
(
ex
);

3740 ià((!
	`ext4_ext_is_unwr™‹n
(
abut_ex
)) &&

3741 ((
´ev_lblk
 + 
´ev_Ën
è=ğ
“_block
) &&

3742 ((
´ev_pblk
 + 
´ev_Ën
è=ğ
“_pblk
) &&

3743 (
´ev_Ën
 < (
EXT_INIT_MAX_LEN
 - 
m­_Ën
))) {

3744 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3745 ià(
”r
)

3746 
out
;

3748 
	`Œaû_ext4_ext_cÚv”t_to_š™Ÿlized_ç¡·th
(
šode
,

3749 
m­
, 
ex
, 
abut_ex
);

3752 
ex
->
“_block
 = 
	`ıu_to_Ë32
Óe_block + 
m­_Ën
);

3753 
	`ext4_ext_¡Üe_pblock
(
ex
, 
“_pblk
 + 
m­_Ën
);

3754 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
Óe_ËÀ- 
m­_Ën
);

3755 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

3758 
abut_ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
´ev_Ën
 + 
m­_Ën
);

3761 
®loÿ‹d
 = 
m­_Ën
;

3763 } ià(((
m­
->
m_lblk
 + 
m­_Ën
è=ğ(
“_block
 + 
“_Ën
)) &&

3764 (
m­_Ën
 < 
“_Ën
) &&

3765 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

3767 
ext4_lblk_t
 
Ãxt_lblk
;

3768 
ext4_fsblk_t
 
Ãxt_pblk
, 
“_pblk
;

3769 
Ãxt_Ën
;

3771 
abut_ex
 = 
ex
 + 1;

3772 
Ãxt_lblk
 = 
	`Ë32_to_ıu
(
abut_ex
->
“_block
);

3773 
Ãxt_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
abut_ex
);

3774 
Ãxt_pblk
 = 
	`ext4_ext_pblock
(
abut_ex
);

3775 
“_pblk
 = 
	`ext4_ext_pblock
(
ex
);

3786 ià((!
	`ext4_ext_is_unwr™‹n
(
abut_ex
)) &&

3787 ((
m­
->
m_lblk
 + 
m­_Ën
è=ğ
Ãxt_lblk
) &&

3788 ((
“_pblk
 + 
“_Ën
è=ğ
Ãxt_pblk
) &&

3789 (
Ãxt_Ën
 < (
EXT_INIT_MAX_LEN
 - 
m­_Ën
))) {

3790 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3791 ià(
”r
)

3792 
out
;

3794 
	`Œaû_ext4_ext_cÚv”t_to_š™Ÿlized_ç¡·th
(
šode
,

3795 
m­
, 
ex
, 
abut_ex
);

3798 
abut_ex
->
“_block
 = 
	`ıu_to_Ë32
(
Ãxt_lblk
 - 
m­_Ën
);

3799 
	`ext4_ext_¡Üe_pblock
(
abut_ex
, 
Ãxt_pblk
 - 
m­_Ën
);

3800 
ex
->
“_Ën
 = 
	`ıu_to_Ë16
Óe_ËÀ- 
m­_Ën
);

3801 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

3804 
abut_ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
Ãxt_Ën
 + 
m­_Ën
);

3807 
®loÿ‹d
 = 
m­_Ën
;

3810 ià(
®loÿ‹d
) {

3812 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

3815 
·th
[
d•th
].
p_ext
 = 
abut_ex
;

3816 
out
;

3818 
®loÿ‹d
 = 
“_Ën
 - (
m­
->
m_lblk
 - 
“_block
);

3820 
	`WARN_ON
(
m­
->
m_lblk
 < 
“_block
);

3825 
¥l™_æag
 |ğ
“_block
 + 
“_Ën
 <ğ
eof_block
 ? 
EXT4_EXT_MAY_ZEROOUT
 : 0;

3827 ià(
EXT4_EXT_MAY_ZEROOUT
 & 
¥l™_æag
)

3828 
max_z”oout
 = 
sbi
->
s_ex‹Á_max_z”oout_kb
 >>

3829 (
šode
->
i_sb
->
s_blocksize_b™s
 - 10);

3831 ià(
	`ext4_’üy±ed_šode
(
šode
))

3832 
max_z”oout
 = 0;

3845 
¥l™_m­
.
m_lblk
 = 
m­
->m_lblk;

3846 
¥l™_m­
.
m_Ën
 = 
m­
->m_len;

3848 ià(
max_z”oout
 && (
®loÿ‹d
 > 
¥l™_m­
.
m_Ën
)) {

3849 ià(
®loÿ‹d
 <ğ
max_z”oout
) {

3851 
z”o_ex1
.
“_block
 =

3852 
	`ıu_to_Ë32
(
¥l™_m­
.
m_lblk
 +

3853 
¥l™_m­
.
m_Ën
);

3854 
z”o_ex1
.
“_Ën
 =

3855 
	`ıu_to_Ë16
(
®loÿ‹d
 - 
¥l™_m­
.
m_Ën
);

3856 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex1
,

3857 
	`ext4_ext_pblock
(
ex
è+ 
¥l™_m­
.
m_lblk
 +

3858 
¥l™_m­
.
m_Ën
 - 
“_block
);

3859 
”r
 = 
	`ext4_ext_z”oout
(
šode
, &
z”o_ex1
);

3860 ià(
”r
)

3861 
out
;

3862 
¥l™_m­
.
m_Ën
 = 
®loÿ‹d
;

3864 ià(
¥l™_m­
.
m_lblk
 - 
“_block
 + s¶™_m­.
m_Ën
 <

3865 
max_z”oout
) {

3867 ià(
¥l™_m­
.
m_lblk
 !ğ
“_block
) {

3868 
z”o_ex2
.
“_block
 = 
ex
->ee_block;

3869 
z”o_ex2
.
“_Ën
 = 
	`ıu_to_Ë16
(
¥l™_m­
.
m_lblk
 -

3870 
“_block
);

3871 
	`ext4_ext_¡Üe_pblock
(&
z”o_ex2
,

3872 
	`ext4_ext_pblock
(
ex
));

3873 
”r
 = 
	`ext4_ext_z”oout
(
šode
, &
z”o_ex2
);

3874 ià(
”r
)

3875 
out
;

3878 
¥l™_m­
.
m_Ën
 +ğ¥l™_m­.
m_lblk
 - 
“_block
;

3879 
¥l™_m­
.
m_lblk
 = 
“_block
;

3880 
®loÿ‹d
 = 
m­
->
m_Ën
;

3884 
”r
 = 
	`ext4_¥l™_ex‹Á
(
hªdË
, 
šode
, 
µ©h
, &
¥l™_m­
, 
¥l™_æag
,

3885 
æags
);

3886 ià(
”r
 > 0)

3887 
”r
 = 0;

3888 
out
:

3890 ià(!
”r
) {

3891 
”r
 = 
	`ext4_z”oout_es
(
šode
, &
z”o_ex1
);

3892 ià(!
”r
)

3893 
”r
 = 
	`ext4_z”oout_es
(
šode
, &
z”o_ex2
);

3895  
”r
 ?ƒ¼ : 
®loÿ‹d
;

3896 
	}
}

3922 
	$ext4_¥l™_cÚv”t_ex‹Ás
(
hªdË_t
 *
hªdË
,

3923 
šode
 *inode,

3924 
ext4_m­_blocks
 *
m­
,

3925 
ext4_ext_·th
 **
µ©h
,

3926 
æags
)

3928 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3929 
ext4_lblk_t
 
eof_block
;

3930 
ext4_lblk_t
 
“_block
;

3931 
ext4_ex‹Á
 *
ex
;

3932 
“_Ën
;

3933 
¥l™_æag
 = 0, 
d•th
;

3935 
	`ext_debug
("%s: inode %lu,†ogical block %llu, max_blocks %u\n",

3936 
__func__
, 
šode
->
i_šo
,

3937 ()
m­
->
m_lblk
, m­->
m_Ën
);

3939 
eof_block
 = (
šode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3940 
šode
->
i_sb
->
s_blocksize_b™s
;

3941 ià(
eof_block
 < 
m­
->
m_lblk
 + m­->
m_Ën
)

3942 
eof_block
 = 
m­
->
m_lblk
 + m­->
m_Ën
;

3947 
d•th
 = 
	`ext_d•th
(
šode
);

3948 
ex
 = 
·th
[
d•th
].
p_ext
;

3949 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3950 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3953 ià(
æags
 & 
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
) {

3954 
¥l™_æag
 |ğ
EXT4_EXT_DATA_VALID1
;

3956 } ià(
æags
 & 
EXT4_GET_BLOCKS_CONVERT
) {

3957 
¥l™_æag
 |ğ
“_block
 + 
“_Ën
 <ğ
eof_block
 ?

3958 
EXT4_EXT_MAY_ZEROOUT
 : 0;

3959 
¥l™_æag
 |ğ(
EXT4_EXT_MARK_UNWRIT2
 | 
EXT4_EXT_DATA_VALID2
);

3961 
æags
 |ğ
EXT4_GET_BLOCKS_PRE_IO
;

3962  
	`ext4_¥l™_ex‹Á
(
hªdË
, 
šode
, 
µ©h
, 
m­
, 
¥l™_æag
, 
æags
);

3963 
	}
}

3965 
	$ext4_cÚv”t_unwr™‹n_ex‹Ás_’dio
(
hªdË_t
 *
hªdË
,

3966 
šode
 *inode,

3967 
ext4_m­_blocks
 *
m­
,

3968 
ext4_ext_·th
 **
µ©h
)

3970 
ext4_ext_·th
 *
·th
 = *
µ©h
;

3971 
ext4_ex‹Á
 *
ex
;

3972 
ext4_lblk_t
 
“_block
;

3973 
“_Ën
;

3974 
d•th
;

3975 
”r
 = 0;

3977 
d•th
 = 
	`ext_d•th
(
šode
);

3978 
ex
 = 
·th
[
d•th
].
p_ext
;

3979 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

3980 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

3982 
	`ext_debug
("ext4_convert_unwritten_extents_endio: inode %lu,†ogical"

3983 "block %Îu, max_block %u\n", 
šode
->
i_šo
,

3984 ()
“_block
, 
“_Ën
);

3992 ià(
“_block
 !ğ
m­
->
m_lblk
 || 
“_Ën
 > m­->
m_Ën
) {

3993 #ifdeà
EXT4_DEBUG


3994 
	`ext4_w¬nšg
("Inode (%ld) finished:ƒxtent†ogical block %llu,"

3996 
šode
->
i_šo
, ()
“_block
, 
“_Ën
,

3997 ()
m­
->
m_lblk
, m­->
m_Ën
);

3999 
”r
 = 
	`ext4_¥l™_cÚv”t_ex‹Ás
(
hªdË
, 
šode
, 
m­
, 
µ©h
,

4000 
EXT4_GET_BLOCKS_CONVERT
);

4001 ià(
”r
 < 0)

4002  
”r
;

4003 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
µ©h
, 0);

4004 ià(
	`IS_ERR
(
·th
))

4005  
	`PTR_ERR
(
·th
);

4006 
d•th
 = 
	`ext_d•th
(
šode
);

4007 
ex
 = 
·th
[
d•th
].
p_ext
;

4010 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

4011 ià(
”r
)

4012 
out
;

4014 
	`ext4_ext_m¬k_š™Ÿlized
(
ex
);

4019 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
ex
);

4022 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

4023 
out
:

4024 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

4025  
”r
;

4026 
	}
}

4031 
	$check_eofblocks_æ
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4032 
ext4_lblk_t
 
lblk
,

4033 
ext4_ext_·th
 *
·th
,

4034 
Ën
)

4036 
i
, 
d•th
;

4037 
ext4_ex‹Á_h—d”
 *
eh
;

4038 
ext4_ex‹Á
 *
Ï¡_ex
;

4040 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EOFBLOCKS
))

4043 
d•th
 = 
	`ext_d•th
(
šode
);

4044 
eh
 = 
·th
[
d•th
].
p_hdr
;

4051 ià(
	`uÆik–y
(!
eh
->
eh_’Œ›s
))

4052 
out
;

4053 
Ï¡_ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

4063 ià(
lblk
 + 
Ën
 < 
	`Ë32_to_ıu
(
Ï¡_ex
->
“_block
) +

4064 
	`ext4_ext_g‘_aùu®_Ën
(
Ï¡_ex
))

4073 
i
 = 
d•th
-1; i >= 0; i--)

4074 ià(
·th
[
i
].
p_idx
 !ğ
	`EXT_LAST_INDEX
Õ©h[i].
p_hdr
))

4076 
out
:

4077 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EOFBLOCKS
);

4078  
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4079 
	}
}

4086 
	$ext4_fšd_d–®loc_¿nge
(
šode
 *inode,

4087 
ext4_lblk_t
 
lblk_¡¬t
,

4088 
ext4_lblk_t
 
lblk_’d
)

4090 
ex‹Á_¡©us
 
es
;

4092 
	`ext4_es_fšd_d–ayed_ex‹Á_¿nge
(
šode
, 
lblk_¡¬t
, 
lblk_’d
, &
es
);

4093 ià(
es
.
es_Ën
 == 0)

4095 ià(
es
.
es_lblk
 <ğ
lblk_¡¬t
 &&

4096 
lblk_¡¬t
 < 
es
.
es_lblk
 +ƒs.
es_Ën
)

4098 ià(
lblk_¡¬t
 <ğ
es
.
es_lblk
 &&ƒs.es_lblk <ğ
lblk_’d
)

4102 
	}
}

4104 
	$ext4_fšd_d–®loc_şu¡”
(
šode
 *šode, 
ext4_lblk_t
 
lblk
)

4106 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

4107 
ext4_lblk_t
 
lblk_¡¬t
, 
lblk_’d
;

4108 
lblk_¡¬t
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
lblk
);

4109 
lblk_’d
 = 
lblk_¡¬t
 + 
sbi
->
s_şu¡”_¿tio
 - 1;

4111  
	`ext4_fšd_d–®loc_¿nge
(
šode
, 
lblk_¡¬t
, 
lblk_’d
);

4112 
	}
}

4150 
	$g‘_»£rved_şu¡”_®loc
(
šode
 *šode, 
ext4_lblk_t
 
lblk_¡¬t
,

4151 
num_blks
)

4153 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

4154 
ext4_lblk_t
 
®loc_şu¡”_¡¬t
, 
®loc_şu¡”_’d
;

4155 
ext4_lblk_t
 
lblk_äom
, 
lblk_to
, 
c_off£t
;

4156 
®loÿ‹d_şu¡”s
 = 0;

4158 
®loc_şu¡”_¡¬t
 = 
	`EXT4_B2C
(
sbi
, 
lblk_¡¬t
);

4159 
®loc_şu¡”_’d
 = 
	`EXT4_B2C
(
sbi
, 
lblk_¡¬t
 + 
num_blks
 - 1);

4162 
®loÿ‹d_şu¡”s
 = 
®loc_şu¡”_’d
 - 
®loc_şu¡”_¡¬t
 + 1;

4164 
	`Œaû_ext4_g‘_»£rved_şu¡”_®loc
(
šode
, 
lblk_¡¬t
, 
num_blks
);

4167 
c_off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
lblk_¡¬t
);

4168 ià(
c_off£t
) {

4169 
lblk_äom
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
lblk_¡¬t
);

4170 
lblk_to
 = 
lblk_äom
 + 
c_off£t
 - 1;

4172 ià(
	`ext4_fšd_d–®loc_¿nge
(
šode
, 
lblk_äom
, 
lblk_to
))

4173 
®loÿ‹d_şu¡”s
--;

4177 
c_off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
lblk_¡¬t
 + 
num_blks
);

4178 ià(
®loÿ‹d_şu¡”s
 && 
c_off£t
) {

4179 
lblk_äom
 = 
lblk_¡¬t
 + 
num_blks
;

4180 
lblk_to
 = 
lblk_äom
 + (
sbi
->
s_şu¡”_¿tio
 - 
c_off£t
) - 1;

4182 ià(
	`ext4_fšd_d–®loc_¿nge
(
šode
, 
lblk_äom
, 
lblk_to
))

4183 
®loÿ‹d_şu¡”s
--;

4186  
®loÿ‹d_şu¡”s
;

4187 
	}
}

4190 
	$cÚv”t_š™Ÿlized_ex‹Á
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4191 
ext4_m­_blocks
 *
m­
,

4192 
ext4_ext_·th
 **
µ©h
,

4193 
®loÿ‹d
)

4195 
ext4_ext_·th
 *
·th
 = *
µ©h
;

4196 
ext4_ex‹Á
 *
ex
;

4197 
ext4_lblk_t
 
“_block
;

4198 
“_Ën
;

4199 
d•th
;

4200 
”r
 = 0;

4206 ià(
m­
->
m_Ën
 > 
EXT_UNWRITTEN_MAX_LEN
)

4207 
m­
->
m_Ën
 = 
EXT_UNWRITTEN_MAX_LEN
 / 2;

4209 
d•th
 = 
	`ext_d•th
(
šode
);

4210 
ex
 = 
·th
[
d•th
].
p_ext
;

4211 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

4212 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

4214 
	`ext_debug
("%s: inode %lu,†ogical"

4215 "block %Îu, max_block %u\n", 
__func__
, 
šode
->
i_šo
,

4216 ()
“_block
, 
“_Ën
);

4218 ià(
“_block
 !ğ
m­
->
m_lblk
 || 
“_Ën
 > m­->
m_Ën
) {

4219 
”r
 = 
	`ext4_¥l™_cÚv”t_ex‹Ás
(
hªdË
, 
šode
, 
m­
, 
µ©h
,

4220 
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
);

4221 ià(
”r
 < 0)

4222  
”r
;

4223 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
µ©h
, 0);

4224 ià(
	`IS_ERR
(
·th
))

4225  
	`PTR_ERR
(
·th
);

4226 
d•th
 = 
	`ext_d•th
(
šode
);

4227 
ex
 = 
·th
[
d•th
].
p_ext
;

4228 ià(!
ex
) {

4229 
	`EXT4_ERROR_INODE
(
šode
, "unexpected hole‡t %lu",

4230 (è
m­
->
m_lblk
);

4231  -
EFSCORRUPTED
;

4235 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

4236 ià(
”r
)

4237  
”r
;

4239 
	`ext4_ext_m¬k_unwr™‹n
(
ex
);

4244 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode
, 
·th
, 
ex
);

4247 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 +…©h->
p_d•th
);

4248 ià(
”r
)

4249  
”r
;

4250 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

4252 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4253 
”r
 = 
	`check_eofblocks_æ
(
hªdË
, 
šode
, 
m­
->
m_lblk
, 
·th
, m­->
m_Ën
);

4254 ià(
”r
)

4255  
”r
;

4256 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4257 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4258 
®loÿ‹d
 = 
m­
->
m_Ën
;

4259 
m­
->
m_Ën
 = 
®loÿ‹d
;

4260  
®loÿ‹d
;

4261 
	}
}

4264 
	$ext4_ext_hªdË_unwr™‹n_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4265 
ext4_m­_blocks
 *
m­
,

4266 
ext4_ext_·th
 **
µ©h
, 
æags
,

4267 
®loÿ‹d
, 
ext4_fsblk_t
 
Ãwblock
)

4269 
ext4_ext_·th
 *
·th
 = *
µ©h
;

4270 
»t
 = 0;

4271 
”r
 = 0;

4273 
	`ext_debug
("ext4_ext_handle_unwritten_extents: inode %lu,†ogical "

4275 
šode
->
i_šo
, ()
m­
->
m_lblk
, m­->
m_Ën
,

4276 
æags
, 
®loÿ‹d
);

4277 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

4283 
æags
 |ğ
EXT4_GET_BLOCKS_METADATA_NOFAIL
;

4285 
	`Œaû_ext4_ext_hªdË_unwr™‹n_ex‹Ás
(
šode
, 
m­
, 
æags
,

4286 
®loÿ‹d
, 
Ãwblock
);

4289 ià(
æags
 & 
EXT4_GET_BLOCKS_PRE_IO
) {

4290 
»t
 = 
	`ext4_¥l™_cÚv”t_ex‹Ás
(
hªdË
, 
šode
, 
m­
, 
µ©h
,

4291 
æags
 | 
EXT4_GET_BLOCKS_CONVERT
);

4292 ià(
»t
 <= 0)

4293 
out
;

4294 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4295 
out
;

4298 ià(
æags
 & 
EXT4_GET_BLOCKS_CONVERT
) {

4299 ià(
æags
 & 
EXT4_GET_BLOCKS_ZERO
) {

4300 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4301 
®loÿ‹d
 = 
m­
->
m_Ën
;

4302 
”r
 = 
	`ext4_issue_z”oout
(
šode
, 
m­
->
m_lblk
, 
Ãwblock
,

4303 
®loÿ‹d
);

4304 ià(
”r
 < 0)

4305 
out2
;

4307 
»t
 = 
	`ext4_cÚv”t_unwr™‹n_ex‹Ás_’dio
(
hªdË
, 
šode
, 
m­
,

4308 
µ©h
);

4309 ià(
»t
 >= 0) {

4310 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4311 
”r
 = 
	`check_eofblocks_æ
(
hªdË
, 
šode
, 
m­
->
m_lblk
,

4312 
·th
, 
m­
->
m_Ën
);

4314 
”r
 = 
»t
;

4315 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

4316 
m­
->
m_pblk
 = 
Ãwblock
;

4317 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4318 
®loÿ‹d
 = 
m­
->
m_Ën
;

4319 
m­
->
m_Ën
 = 
®loÿ‹d
;

4320 
out2
;

4327 ià(
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
) {

4328 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4329 
m­_out
;

4333 ià((
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0) {

4341 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4342 
out1
;

4346 
»t
 = 
	`ext4_ext_cÚv”t_to_š™Ÿlized
(
hªdË
, 
šode
, 
m­
, 
µ©h
, 
æags
);

4347 ià(
»t
 >= 0)

4348 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4349 
out
:

4350 ià(
»t
 <= 0) {

4351 
”r
 = 
»t
;

4352 
out2
;

4354 
®loÿ‹d
 = 
»t
;

4355 
m­
->
m_æags
 |ğ
EXT4_MAP_NEW
;

4363 ià(
®loÿ‹d
 > 
m­
->
m_Ën
) {

4364 
	`ş—n_bdev_®Ÿ£s
(
šode
->
i_sb
->
s_bdev
, 
Ãwblock
 + 
m­
->
m_Ën
,

4365 
®loÿ‹d
 - 
m­
->
m_Ën
);

4366 
®loÿ‹d
 = 
m­
->
m_Ën
;

4368 
m­
->
m_Ën
 = 
®loÿ‹d
;

4377 ià(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
) {

4378 
»£rved_şu¡”s
;

4379 
»£rved_şu¡”s
 = 
	`g‘_»£rved_şu¡”_®loc
(
šode
,

4380 
m­
->
m_lblk
, m­->
m_Ën
);

4381 ià(
»£rved_şu¡”s
)

4382 
	`ext4_da_upd©e_»£rve_¥aû
(
šode
,

4383 
»£rved_şu¡”s
,

4387 
m­_out
:

4388 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

4389 ià((
æags
 & 
EXT4_GET_BLOCKS_KEEP_SIZE
) == 0) {

4390 
”r
 = 
	`check_eofblocks_æ
(
hªdË
, 
šode
, 
m­
->
m_lblk
, 
·th
,

4391 
m­
->
m_Ën
);

4392 ià(
”r
 < 0)

4393 
out2
;

4395 
out1
:

4396 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4397 
®loÿ‹d
 = 
m­
->
m_Ën
;

4398 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

4399 
m­
->
m_pblk
 = 
Ãwblock
;

4400 
m­
->
m_Ën
 = 
®loÿ‹d
;

4401 
out2
:

4402  
”r
 ?ƒ¼ : 
®loÿ‹d
;

4403 
	}
}

4446 
	$g‘_im¶›d_şu¡”_®loc
(
su³r_block
 *
sb
,

4447 
ext4_m­_blocks
 *
m­
,

4448 
ext4_ex‹Á
 *
ex
,

4449 
ext4_ext_·th
 *
·th
)

4451 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4452 
ext4_lblk_t
 
c_off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
m­
->
m_lblk
);

4453 
ext4_lblk_t
 
ex_şu¡”_¡¬t
, 
ex_şu¡”_’d
;

4454 
ext4_lblk_t
 
¼_şu¡”_¡¬t
;

4455 
ext4_lblk_t
 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

4456 
ext4_fsblk_t
 
“_¡¬t
 = 
	`ext4_ext_pblock
(
ex
);

4457 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

4460 
ex_şu¡”_¡¬t
 = 
	`EXT4_B2C
(
sbi
, 
“_block
);

4461 
ex_şu¡”_’d
 = 
	`EXT4_B2C
(
sbi
, 
“_block
 + 
“_Ën
 - 1);

4464 
¼_şu¡”_¡¬t
 = 
	`EXT4_B2C
(
sbi
, 
m­
->
m_lblk
);

4466 ià((
¼_şu¡”_¡¬t
 =ğ
ex_şu¡”_’d
) ||

4467 (
¼_şu¡”_¡¬t
 =ğ
ex_şu¡”_¡¬t
)) {

4468 ià(
¼_şu¡”_¡¬t
 =ğ
ex_şu¡”_’d
)

4469 
“_¡¬t
 +ğ
“_Ën
 - 1;

4470 
m­
->
m_pblk
 = 
	`EXT4_PBLK_CMASK
(
sbi
, 
“_¡¬t
è+ 
c_off£t
;

4471 
m­
->
m_Ën
 = 
	`mš
(map->m_len,

4472 (è
sbi
->
s_şu¡”_¿tio
 - 
c_off£t
);

4482 ià(
m­
->
m_lblk
 < 
“_block
)

4483 
m­
->
m_Ën
 = 
	`mš
(m­->m_Ën, 
“_block
 - m­->
m_lblk
);

4494 ià(
m­
->
m_lblk
 > 
“_block
) {

4495 
ext4_lblk_t
 
Ãxt
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

4496 
m­
->
m_Ën
 = 
	`mš
(m­->m_Ën, 
Ãxt
 - m­->
m_lblk
);

4499 
	`Œaû_ext4_g‘_im¶›d_şu¡”_®loc_ex™
(
sb
, 
m­
, 1);

4503 
	`Œaû_ext4_g‘_im¶›d_şu¡”_®loc_ex™
(
sb
, 
m­
, 0);

4505 
	}
}

4526 
	$ext4_ext_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4527 
ext4_m­_blocks
 *
m­
, 
æags
)

4529 
ext4_ext_·th
 *
·th
 = 
NULL
;

4530 
ext4_ex‹Á
 
Ãwex
, *
ex
, *
ex2
;

4531 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

4532 
ext4_fsblk_t
 
Ãwblock
 = 0;

4533 
ä“_Ú_”r
 = 0, 
”r
 = 0, 
d•th
, 
»t
;

4534 
®loÿ‹d
 = 0, 
off£t
 = 0;

4535 
®loÿ‹d_şu¡”s
 = 0;

4536 
ext4_®loÿtiÚ_»que¡
 
¬
;

4537 
ext4_lblk_t
 
şu¡”_off£t
;

4538 
boŞ
 
m­_äom_şu¡”
 = 
çl£
;

4540 
	`ext_debug
("blocks %u/%u„equested for inode %lu\n",

4541 
m­
->
m_lblk
, m­->
m_Ën
, 
šode
->
i_šo
);

4542 
	`Œaû_ext4_ext_m­_blocks_’‹r
(
šode
, 
m­
->
m_lblk
, m­->
m_Ën
, 
æags
);

4545 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
m­
->
m_lblk
, 
NULL
, 0);

4546 ià(
	`IS_ERR
(
·th
)) {

4547 
”r
 = 
	`PTR_ERR
(
·th
);

4548 
·th
 = 
NULL
;

4549 
out2
;

4552 
d•th
 = 
	`ext_d•th
(
šode
);

4559 ià(
	`uÆik–y
(
·th
[
d•th
].
p_ext
 =ğ
NULL
 && depth != 0)) {

4560 
	`EXT4_ERROR_INODE
(
šode
, "badƒxtent‡ddress "

4562 (è
m­
->
m_lblk
, 
d•th
,

4563 
·th
[
d•th
].
p_block
);

4564 
”r
 = -
EFSCORRUPTED
;

4565 
out2
;

4568 
ex
 = 
·th
[
d•th
].
p_ext
;

4569 ià(
ex
) {

4570 
ext4_lblk_t
 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

4571 
ext4_fsblk_t
 
“_¡¬t
 = 
	`ext4_ext_pblock
(
ex
);

4572 
“_Ën
;

4579 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

4581 
	`Œaû_ext4_ext_show_ex‹Á
(
šode
, 
“_block
, 
“_¡¬t
, 
“_Ën
);

4584 ià(
	`š_¿nge
(
m­
->
m_lblk
, 
“_block
, 
“_Ën
)) {

4585 
Ãwblock
 = 
m­
->
m_lblk
 - 
“_block
 + 
“_¡¬t
;

4587 
®loÿ‹d
 = 
“_Ën
 - (
m­
->
m_lblk
 - 
“_block
);

4588 
	`ext_debug
("%u f™ iÁØ%u:%d -> %Îu\n", 
m­
->
m_lblk
,

4589 
“_block
, 
“_Ën
, 
Ãwblock
);

4595 ià((!
	`ext4_ext_is_unwr™‹n
(
ex
)) &&

4596 (
æags
 & 
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
)) {

4597 
®loÿ‹d
 = 
	`cÚv”t_š™Ÿlized_ex‹Á
(

4598 
hªdË
, 
šode
, 
m­
, &
·th
,

4599 
®loÿ‹d
);

4600 
out2
;

4601 } ià(!
	`ext4_ext_is_unwr™‹n
(
ex
))

4602 
out
;

4604 
»t
 = 
	`ext4_ext_hªdË_unwr™‹n_ex‹Ás
(

4605 
hªdË
, 
šode
, 
m­
, &
·th
, 
æags
,

4606 
®loÿ‹d
, 
Ãwblock
);

4607 ià(
»t
 < 0)

4608 
”r
 = 
»t
;

4610 
®loÿ‹d
 = 
»t
;

4611 
out2
;

4619 ià((
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0) {

4620 
ext4_lblk_t
 
hŞe_¡¬t
, 
hŞe_Ën
;

4622 
hŞe_¡¬t
 = 
m­
->
m_lblk
;

4623 
hŞe_Ën
 = 
	`ext4_ext_d‘”mše_hŞe
(
šode
, 
·th
, &
hŞe_¡¬t
);

4628 
	`ext4_ext_put_g­_š_ÿche
(
šode
, 
hŞe_¡¬t
, 
hŞe_Ën
);

4631 ià(
hŞe_¡¬t
 !ğ
m­
->
m_lblk
)

4632 
hŞe_Ën
 -ğ
m­
->
m_lblk
 - 
hŞe_¡¬t
;

4633 
m­
->
m_pblk
 = 0;

4634 
m­
->
m_Ën
 = 
	`mš_t
(, m­->m_Ën, 
hŞe_Ën
);

4636 
out2
;

4642 
Ãwex
.
“_block
 = 
	`ıu_to_Ë32
(
m­
->
m_lblk
);

4643 
şu¡”_off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
m­
->
m_lblk
);

4649 ià(
şu¡”_off£t
 && 
ex
 &&

4650 
	`g‘_im¶›d_şu¡”_®loc
(
šode
->
i_sb
, 
m­
, 
ex
, 
·th
)) {

4651 
¬
.
Ën
 = 
®loÿ‹d
 = 
m­
->
m_Ën
;

4652 
Ãwblock
 = 
m­
->
m_pblk
;

4653 
m­_äom_şu¡”
 = 
Œue
;

4654 
gÙ_®loÿ‹d_blocks
;

4658 
¬
.
Îeá
 = 
m­
->
m_lblk
;

4659 
”r
 = 
	`ext4_ext_£¬ch_Ëá
(
šode
, 
·th
, &
¬
.
Îeá
, &¬.
¶eá
);

4660 ià(
”r
)

4661 
out2
;

4662 
¬
.
Ìight
 = 
m­
->
m_lblk
;

4663 
ex2
 = 
NULL
;

4664 
”r
 = 
	`ext4_ext_£¬ch_right
(
šode
, 
·th
, &
¬
.
Ìight
, &¬.
´ight
, &
ex2
);

4665 ià(
”r
)

4666 
out2
;

4670 ià((
sbi
->
s_şu¡”_¿tio
 > 1è&& 
ex2
 &&

4671 
	`g‘_im¶›d_şu¡”_®loc
(
šode
->
i_sb
, 
m­
, 
ex2
, 
·th
)) {

4672 
¬
.
Ën
 = 
®loÿ‹d
 = 
m­
->
m_Ën
;

4673 
Ãwblock
 = 
m­
->
m_pblk
;

4674 
m­_äom_şu¡”
 = 
Œue
;

4675 
gÙ_®loÿ‹d_blocks
;

4684 ià(
m­
->
m_Ën
 > 
EXT_INIT_MAX_LEN
 &&

4685 !(
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
))

4686 
m­
->
m_Ën
 = 
EXT_INIT_MAX_LEN
;

4687 ià(
m­
->
m_Ën
 > 
EXT_UNWRITTEN_MAX_LEN
 &&

4688 (
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
))

4689 
m­
->
m_Ën
 = 
EXT_UNWRITTEN_MAX_LEN
;

4692 
Ãwex
.
“_Ën
 = 
	`ıu_to_Ë16
(
m­
->
m_Ën
);

4693 
”r
 = 
	`ext4_ext_check_ov”Ïp
(
sbi
, 
šode
, &
Ãwex
, 
·th
);

4694 ià(
”r
)

4695 
®loÿ‹d
 = 
	`ext4_ext_g‘_aùu®_Ën
(&
Ãwex
);

4697 
®loÿ‹d
 = 
m­
->
m_Ën
;

4700 
¬
.
šode
 = inode;

4701 
¬
.
gßl
 = 
	`ext4_ext_fšd_gßl
(
šode
, 
·th
, 
m­
->
m_lblk
);

4702 
¬
.
logiÿl
 = 
m­
->
m_lblk
;

4711 
off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
m­
->
m_lblk
);

4712 
¬
.
Ën
 = 
	`EXT4_NUM_B2C
(
sbi
, 
off£t
+
®loÿ‹d
);

4713 
¬
.
gßl
 -ğ
off£t
;

4714 
¬
.
logiÿl
 -ğ
off£t
;

4715 ià(
	`S_ISREG
(
šode
->
i_mode
))

4716 
¬
.
æags
 = 
EXT4_MB_HINT_DATA
;

4719 
¬
.
æags
 = 0;

4720 ià(
æags
 & 
EXT4_GET_BLOCKS_NO_NORMALIZE
)

4721 
¬
.
æags
 |ğ
EXT4_MB_HINT_NOPREALLOC
;

4722 ià(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
)

4723 
¬
.
æags
 |ğ
EXT4_MB_DELALLOC_RESERVED
;

4724 ià(
æags
 & 
EXT4_GET_BLOCKS_METADATA_NOFAIL
)

4725 
¬
.
æags
 |ğ
EXT4_MB_USE_RESERVED
;

4726 
Ãwblock
 = 
	`ext4_mb_Ãw_blocks
(
hªdË
, &
¬
, &
”r
);

4727 ià(!
Ãwblock
)

4728 
out2
;

4729 
	`ext_debug
("allocate‚ew block: goal %llu, found %llu/%u\n",

4730 
¬
.
gßl
, 
Ãwblock
, 
®loÿ‹d
);

4731 
ä“_Ú_”r
 = 1;

4732 
®loÿ‹d_şu¡”s
 = 
¬
.
Ën
;

4733 
¬
.
Ën
 = 
	`EXT4_C2B
(
sbi
,‡r.Ënè- 
off£t
;

4734 ià(
¬
.
Ën
 > 
®loÿ‹d
)

4735 
¬
.
Ën
 = 
®loÿ‹d
;

4737 
gÙ_®loÿ‹d_blocks
:

4739 
	`ext4_ext_¡Üe_pblock
(&
Ãwex
, 
Ãwblock
 + 
off£t
);

4740 
Ãwex
.
“_Ën
 = 
	`ıu_to_Ë16
(
¬
.
Ën
);

4742 ià(
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
){

4743 
	`ext4_ext_m¬k_unwr™‹n
(&
Ãwex
);

4744 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

4747 
”r
 = 0;

4748 ià((
æags
 & 
EXT4_GET_BLOCKS_KEEP_SIZE
) == 0)

4749 
”r
 = 
	`check_eofblocks_æ
(
hªdË
, 
šode
, 
m­
->
m_lblk
,

4750 
·th
, 
¬
.
Ën
);

4751 ià(!
”r
)

4752 
”r
 = 
	`ext4_ext_š£¹_ex‹Á
(
hªdË
, 
šode
, &
·th
,

4753 &
Ãwex
, 
æags
);

4755 ià(
”r
 && 
ä“_Ú_”r
) {

4756 
fb_æags
 = 
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
 ?

4757 
EXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 : 0;

4761 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

4762 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
Ãwblock
,

4763 
	`EXT4_C2B
(
sbi
, 
®loÿ‹d_şu¡”s
), 
fb_æags
);

4764 
out2
;

4768 
Ãwblock
 = 
	`ext4_ext_pblock
(&
Ãwex
);

4769 
®loÿ‹d
 = 
	`ext4_ext_g‘_aùu®_Ën
(&
Ãwex
);

4770 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4771 
®loÿ‹d
 = 
m­
->
m_Ën
;

4772 
m­
->
m_æags
 |ğ
EXT4_MAP_NEW
;

4778 ià(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
) {

4779 
»£rved_şu¡”s
;

4783 
»£rved_şu¡”s
 = 
	`g‘_»£rved_şu¡”_®loc
(
šode
,

4784 
m­
->
m_lblk
, 
®loÿ‹d
);

4785 ià(!
m­_äom_şu¡”
) {

4786 
	`BUG_ON
(
®loÿ‹d_şu¡”s
 < 
»£rved_şu¡”s
);

4787 ià(
»£rved_şu¡”s
 < 
®loÿ‹d_şu¡”s
) {

4788 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

4789 
»£rv©iÚ
 = 
®loÿ‹d_şu¡”s
 -

4790 
»£rved_şu¡”s
;

4831 
	`dquÙ_»£rve_block
(
šode
,

4832 
	`EXT4_C2B
(
sbi
, 
»£rv©iÚ
));

4833 
	`¥š_lock
(&
ei
->
i_block_»£rv©iÚ_lock
);

4834 
ei
->
i_»£rved_d©a_blocks
 +ğ
»£rv©iÚ
;

4835 
	`¥š_uÆock
(&
ei
->
i_block_»£rv©iÚ_lock
);

4844 
	`ext4_da_upd©e_»£rve_¥aû
(
šode
, 
®loÿ‹d_şu¡”s
,

4853 ià((
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
) == 0)

4854 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4856 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 0);

4857 
out
:

4858 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

4859 
®loÿ‹d
 = 
m­
->
m_Ën
;

4860 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

4861 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

4862 
m­
->
m_pblk
 = 
Ãwblock
;

4863 
m­
->
m_Ën
 = 
®loÿ‹d
;

4864 
out2
:

4865 
	`ext4_ext_drİ_»fs
(
·th
);

4866 
	`kä“
(
·th
);

4868 
	`Œaû_ext4_ext_m­_blocks_ex™
(
šode
, 
æags
, 
m­
,

4869 
”r
 ?ƒ¼ : 
®loÿ‹d
);

4870  
”r
 ?ƒ¼ : 
®loÿ‹d
;

4871 
	}
}

4873 
	$ext4_ext_Œunÿ‹
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

4875 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4876 
ext4_lblk_t
 
Ï¡_block
;

4877 
”r
 = 0;

4886 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_size
;

4887 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4888 ià(
”r
)

4889  
”r
;

4891 
Ï¡_block
 = (
šode
->
i_size
 + 
sb
->
s_blocksize
 - 1)

4892 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

4893 
»Œy
:

4894 
”r
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
Ï¡_block
,

4895 
EXT_MAX_BLOCKS
 - 
Ï¡_block
);

4896 ià(
”r
 =ğ-
ENOMEM
) {

4897 
	`cÚd_»sched
();

4898 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

4899 
»Œy
;

4901 ià(
”r
)

4902  
”r
;

4903  
	`ext4_ext_»move_¥aû
(
šode
, 
Ï¡_block
, 
EXT_MAX_BLOCKS
 - 1);

4904 
	}
}

4906 
	$ext4_®loc_fe_blocks
(
fe
 *fe, 
ext4_lblk_t
 
off£t
,

4907 
ext4_lblk_t
 
Ën
, 
loff_t
 
Ãw_size
,

4908 
æags
)

4910 
šode
 *šodğ
	`fe_šode
(
fe
);

4911 
hªdË_t
 *
hªdË
;

4912 
»t
 = 0;

4913 
»t2
 = 0;

4914 
»Œ›s
 = 0;

4915 
d•th
 = 0;

4916 
ext4_m­_blocks
 
m­
;

4917 
üed™s
;

4918 
loff_t
 
•os
;

4920 
	`BUG_ON
(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
));

4921 
m­
.
m_lblk
 = 
off£t
;

4922 
m­
.
m_Ën
 = 
Ën
;

4928 ià(
Ën
 <ğ
EXT_UNWRITTEN_MAX_LEN
)

4929 
æags
 |ğ
EXT4_GET_BLOCKS_NO_NORMALIZE
;

4934 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
Ën
);

4935 
d•th
 = 
	`ext_d•th
(
šode
);

4937 
»Œy
:

4938 
»t
 >ğ0 && 
Ën
) {

4942 ià(
d•th
 !ğ
	`ext_d•th
(
šode
)) {

4943 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
Ën
);

4944 
d•th
 = 
	`ext_d•th
(
šode
);

4947 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MAP_BLOCKS
,

4948 
üed™s
);

4949 ià(
	`IS_ERR
(
hªdË
)) {

4950 
»t
 = 
	`PTR_ERR
(
hªdË
);

4953 
»t
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
, 
æags
);

4954 ià(
»t
 <= 0) {

4955 
	`ext4_debug
("inode #%lu: block %u:†en %u: "

4957 
šode
->
i_šo
, 
m­
.
m_lblk
,

4958 
m­
.
m_Ën
, 
»t
);

4959 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4960 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

4963 
m­
.
m_lblk
 +ğ
»t
;

4964 
m­
.
m_Ën
 = 
Ën
 =†’ - 
»t
;

4969 
•os
 = (
loff_t
)
m­
.
m_lblk
 << 
šode
->
i_blkb™s
;

4970 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

4971 ià(
Ãw_size
) {

4972 ià(
•os
 > 
Ãw_size
)

4973 
•os
 = 
Ãw_size
;

4974 ià(
	`ext4_upd©e_šode_size
(
šode
, 
•os
) & 0x1)

4975 
šode
->
i_mtime
 = inode->
i_ùime
;

4977 ià(
•os
 > 
šode
->
i_size
)

4978 
	`ext4_£t_šode_æag
(
šode
,

4979 
EXT4_INODE_EOFBLOCKS
);

4981 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4982 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

4983 ià(
»t2
)

4986 ià(
»t
 =ğ-
ENOSPC
 &&

4987 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
)) {

4988 
»t
 = 0;

4989 
»Œy
;

4992  
»t
 > 0 ? 
»t2
 :„et;

4993 
	}
}

4996 
	$ext4_®loc_fe_blocks_fÜ_dr
(
hªdË_t
 *
hªdË
, 
fe
 *fe, 
ext4_lblk_t
 
off£t
,

4997 
ext4_lblk_t
 
Ën
, 
loff_t
 
Ãw_size
,

4998 
æags
)

5000 
šode
 *šodğ
	`fe_šode
(
fe
);

5001 
»t
 = 0;

5002 
»t2
 = 0;

5003 
»Œ›s
 = 0;

5004 
d•th
 = 0;

5005 
ext4_m­_blocks
 
m­
;

5006 
üed™s
;

5007 
loff_t
 
•os
;

5009 
	`BUG_ON
(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
));

5010 
m­
.
m_lblk
 = 
off£t
;

5011 
m­
.
m_Ën
 = 
Ën
;

5017 ià(
Ën
 <ğ
EXT_UNWRITTEN_MAX_LEN
)

5018 
æags
 |ğ
EXT4_GET_BLOCKS_NO_NORMALIZE
;

5023 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
Ën
);

5024 
d•th
 = 
	`ext_d•th
(
šode
);

5026 
»Œy
:

5027 
»t
 >ğ0 && 
Ën
) {

5031 ià(
d•th
 !ğ
	`ext_d•th
(
šode
)) {

5032 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
Ën
);

5033 
d•th
 = 
	`ext_d•th
(
šode
);

5036 
»t
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
, 
æags
);

5037 ià(
»t
 <= 0) {

5038 
	`ext4_debug
("inode #%lu: block %u:†en %u: "

5040 
šode
->
i_šo
, 
m­
.
m_lblk
,

5041 
m­
.
m_Ën
, 
»t
);

5042 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5043 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5046 
m­
.
m_lblk
 +ğ
»t
;

5047 
m­
.
m_Ën
 = 
Ën
 =†’ - 
»t
;

5048 
•os
 = (
loff_t
)
m­
.
m_lblk
 << 
šode
->
i_blkb™s
;

5049 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

5050 ià(
Ãw_size
) {

5051 ià(
•os
 > 
Ãw_size
)

5052 
•os
 = 
Ãw_size
;

5053 ià(
	`ext4_upd©e_šode_size
(
šode
, 
•os
) & 0x1)

5054 
šode
->
i_mtime
 = inode->
i_ùime
;

5056 ià(
•os
 > 
šode
->
i_size
)

5057 
	`ext4_£t_šode_æag
(
šode
,

5058 
EXT4_INODE_EOFBLOCKS
);

5060 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5061 ià(
»t2
)

5064 ià(
»t
 =ğ-
ENOSPC
 &&

5065 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
)) {

5066 
»t
 = 0;

5067 
»Œy
;

5070  
»t
 > 0 ? 
»t2
 :„et;

5071 
	}
}

5075 
	$ext4_z”o_¿nge
(
fe
 *fe, 
loff_t
 
off£t
,

5076 
loff_t
 
Ën
, 
mode
)

5078 
šode
 *šodğ
	`fe_šode
(
fe
);

5079 
hªdË_t
 *
hªdË
 = 
NULL
;

5080 
max_blocks
;

5081 
loff_t
 
Ãw_size
 = 0;

5082 
»t
 = 0;

5083 
æags
;

5084 
üed™s
;

5085 
·¹Ÿl_begš
, 
·¹Ÿl_’d
;

5086 
loff_t
 
¡¬t
, 
’d
;

5087 
ext4_lblk_t
 
lblk
;

5088 
blkb™s
 = 
šode
->
i_blkb™s
;

5090 
	`Œaû_ext4_z”o_¿nge
(
šode
, 
off£t
, 
Ën
, 
mode
);

5092 ià(!
	`S_ISREG
(
šode
->
i_mode
))

5093  -
EINVAL
;

5096 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

5097 
»t
 = 
	`ext4_fÜû_comm™
(
šode
->
i_sb
);

5098 ià(
»t
)

5099  
»t
;

5108 
¡¬t
 = 
	`round_up
(
off£t
, 1 << 
blkb™s
);

5109 
’d
 = 
	`round_down
((
off£t
 + 
Ën
), 1 << 
blkb™s
);

5111 ià(
¡¬t
 < 
off£t
 || 
’d
 > off£ˆ+ 
Ën
)

5112  -
EINVAL
;

5113 
·¹Ÿl_begš
 = 
off£t
 & ((1 << 
blkb™s
) - 1);

5114 
·¹Ÿl_’d
 = (
off£t
 + 
Ën
è& ((1 << 
blkb™s
) - 1);

5116 
lblk
 = 
¡¬t
 >> 
blkb™s
;

5117 
max_blocks
 = (
’d
 >> 
blkb™s
);

5118 ià(
max_blocks
 < 
lblk
)

5119 
max_blocks
 = 0;

5121 
max_blocks
 -ğ
lblk
;

5123 
	`šode_lock
(
šode
);

5128 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))) {

5129 
»t
 = -
EOPNOTSUPP
;

5130 
out_mu‹x
;

5133 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

5134 
off£t
 + 
Ën
 > 
	`i_size_»ad
(
šode
)) {

5135 
Ãw_size
 = 
off£t
 + 
Ën
;

5136 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
Ãw_size
);

5137 ià(
»t
)

5138 
out_mu‹x
;

5141 
æags
 = 
EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

5142 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

5143 
æags
 |ğ
EXT4_GET_BLOCKS_KEEP_SIZE
;

5146 
	`ext4_šode_block_uÆocked_dio
(
šode
);

5147 
	`šode_dio_wa™
(
šode
);

5150 ià(
·¹Ÿl_begš
 || 
·¹Ÿl_’d
) {

5151 
»t
 = 
	`ext4_®loc_fe_blocks
(
fe
,

5152 
	`round_down
(
off£t
, 1 << 
blkb™s
) >> blkbits,

5153 (
	`round_up
((
off£t
 + 
Ën
), 1 << 
blkb™s
) -

5154 
	`round_down
(
off£t
, 1 << 
blkb™s
)) >> blkbits,

5155 
Ãw_size
, 
æags
);

5156 ià(
»t
)

5157 
out_dio
;

5162 ià(
max_blocks
 > 0) {

5163 
æags
 |ğ(
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 |

5164 
EXT4_EX_NOCACHE
);

5170 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5171 
»t
 = 
	`ext4_upd©e_disksize_befÜe_punch
(
šode
, 
off£t
, 
Ën
);

5172 ià(
»t
) {

5173 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5174 
out_dio
;

5177 
	`Œunÿ‹_·geÿche_¿nge
(
šode
, 
¡¬t
, 
’d
 - 1);

5178 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

5180 
»t
 = 
	`ext4_®loc_fe_blocks
(
fe
, 
lblk
, 
max_blocks
, 
Ãw_size
,

5181 
æags
);

5182 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5183 ià(
»t
)

5184 
out_dio
;

5186 ià(!
·¹Ÿl_begš
 && !
·¹Ÿl_’d
)

5187 
out_dio
;

5193 
üed™s
 = (2 * 
	`ext4_ext_šdex_Œªs_blocks
(
šode
, 2)) + 1;

5194 ià(
	`ext4_should_jouº®_d©a
(
šode
))

5195 
üed™s
 += 2;

5196 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MISC
, 
üed™s
);

5197 ià(
	`IS_ERR
(
hªdË
)) {

5198 
»t
 = 
	`PTR_ERR
(
hªdË
);

5199 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
»t
);

5200 
out_dio
;

5203 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

5204 ià(
Ãw_size
) {

5205 
	`ext4_upd©e_šode_size
(
šode
, 
Ãw_size
);

5211 ià((
off£t
 + 
Ën
è> 
	`i_size_»ad
(
šode
))

5212 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_EOFBLOCKS
);

5214 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5215 
	`ext4_fc_Œack_šode
(
šode
);

5218 
»t
 = 
	`ext4_z”o_·¹Ÿl_blocks
(
hªdË
, 
šode
, 
off£t
, 
Ën
);

5219 ià(
»t
 >= 0)

5220 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

5222 ià(
fe
->
f_æags
 & 
O_SYNC
)

5223 
	`ext4_hªdË_sync
(
hªdË
);

5225 
	`ext4_jouº®_¡İ
(
hªdË
);

5226 
out_dio
:

5227 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

5228 
out_mu‹x
:

5229 
	`šode_uÆock
(
šode
);

5230  
»t
;

5231 
	}
}

5240 
	$ext4_çÎoÿ‹
(
fe
 *fe, 
mode
, 
loff_t
 
off£t
,†off_ˆ
Ën
)

5242 
šode
 *šodğ
	`fe_šode
(
fe
);

5243 
loff_t
 
Ãw_size
 = 0;

5244 
max_blocks
;

5245 
»t
 = 0;

5246 
æags
;

5247 
ext4_lblk_t
 
lblk
;

5248 
blkb™s
 = 
šode
->
i_blkb™s
;

5260 ià(
	`ext4_’üy±ed_šode
(
šode
) &&

5261 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
 |

5262 
FALLOC_FL_ZERO_RANGE
)))

5263  -
EOPNOTSUPP
;

5266 ià(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

5267 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

5268 
FALLOC_FL_INSERT_RANGE
))

5269  -
EOPNOTSUPP
;

5271 ià(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

5272  
	`ext4_punch_hŞe
(
šode
, 
off£t
, 
Ën
);

5274 
»t
 = 
	`ext4_cÚv”t_šlše_d©a
(
šode
);

5275 ià(
»t
)

5276  
»t
;

5278 ià(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
)

5279  
	`ext4_cŞÏp£_¿nge
(
šode
, 
off£t
, 
Ën
);

5281 ià(
mode
 & 
FALLOC_FL_INSERT_RANGE
)

5282  
	`ext4_š£¹_¿nge
(
šode
, 
off£t
, 
Ën
);

5284 ià(
mode
 & 
FALLOC_FL_ZERO_RANGE
)

5285  
	`ext4_z”o_¿nge
(
fe
, 
off£t
, 
Ën
, 
mode
);

5287 
	`Œaû_ext4_çÎoÿ‹_’‹r
(
šode
, 
off£t
, 
Ën
, 
mode
);

5288 
lblk
 = 
off£t
 >> 
blkb™s
;

5290 
max_blocks
 = 
	`EXT4_MAX_BLOCKS
(
Ën
, 
off£t
, 
blkb™s
);

5291 
æags
 = 
EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

5292 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

5293 
æags
 |ğ
EXT4_GET_BLOCKS_KEEP_SIZE
;

5295 
	`šode_lock
(
šode
);

5300 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))) {

5301 
»t
 = -
EOPNOTSUPP
;

5302 
out
;

5305 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

5306 
off£t
 + 
Ën
 > 
	`i_size_»ad
(
šode
)) {

5307 
Ãw_size
 = 
off£t
 + 
Ën
;

5308 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
Ãw_size
);

5309 ià(
»t
)

5310 
out
;

5314 
	`ext4_šode_block_uÆocked_dio
(
šode
);

5315 
	`šode_dio_wa™
(
šode
);

5317 
»t
 = 
	`ext4_®loc_fe_blocks
(
fe
, 
lblk
, 
max_blocks
, 
Ãw_size
, 
æags
);

5318 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

5319 ià(
»t
)

5320 
out
;

5322 ià(
fe
->
f_æags
 & 
O_SYNC
 && 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
) {

5323 
»t
 = 
	`jbd2_com¶‘e_Œª§ùiÚ
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
,

5324 
	`EXT4_I
(
šode
)->
i_sync_tid
);

5326 
out
:

5327 
	`šode_uÆock
(
šode
);

5328 
	`Œaû_ext4_çÎoÿ‹_ex™
(
šode
, 
off£t
, 
max_blocks
, 
»t
);

5329  
»t
;

5330 
	}
}

5340 
	$ext4_çÎoÿ‹_fÜ_dr
(
hªdË_t
 *
hªdË
, 
fe
 *fe, 
mode
, 
loff_t
 
off£t
,†off_ˆ
Ën
)

5342 
šode
 *šodğ
	`fe_šode
(
fe
);

5343 
loff_t
 
Ãw_size
 = 0;

5344 
max_blocks
;

5345 
»t
 = 0;

5346 
æags
;

5347 
ext4_lblk_t
 
lblk
;

5348 
blkb™s
 = 
šode
->
i_blkb™s
;

5361 ià(
	`ext4_’üy±ed_šode
(
šode
) &&

5362 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
 |

5363 
FALLOC_FL_ZERO_RANGE
)))

5364  -
EOPNOTSUPP
;

5367 ià(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

5368 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

5369 
FALLOC_FL_INSERT_RANGE
))

5370  -
EOPNOTSUPP
;

5372 ià(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

5373  
	`ext4_m‘a_punch_hŞe
(
šode
, 
off£t
, 
Ën
, 
hªdË
);

5375 
»t
 = 
	`ext4_cÚv”t_šlše_d©a
(
šode
);

5376 ià(
»t
)

5377  
»t
;

5379 ià(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
)

5380  
	`ext4_m‘a_cŞÏp£_¿nge
(
šode
, 
off£t
, 
Ën
, 
hªdË
);

5382 ià(
mode
 & 
FALLOC_FL_INSERT_RANGE
)

5383  
	`ext4_š£¹_¿nge
(
šode
, 
off£t
, 
Ën
);

5385 ià(
mode
 & 
FALLOC_FL_ZERO_RANGE
)

5386  
	`ext4_z”o_¿nge
(
fe
, 
off£t
, 
Ën
, 
mode
);

5388 
	`Œaû_ext4_çÎoÿ‹_’‹r
(
šode
, 
off£t
, 
Ën
, 
mode
);

5389 
lblk
 = 
off£t
 >> 
blkb™s
;

5391 
max_blocks
 = 
	`EXT4_MAX_BLOCKS
(
Ën
, 
off£t
, 
blkb™s
);

5392 
æags
 = 
EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

5393 ià(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

5394 
æags
 |ğ
EXT4_GET_BLOCKS_KEEP_SIZE
;

5399 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))) {

5400 
»t
 = -
EOPNOTSUPP
;

5401 
out
;

5404 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

5405 
off£t
 + 
Ën
 > 
	`i_size_»ad
(
šode
)) {

5406 
Ãw_size
 = 
off£t
 + 
Ën
;

5407 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
Ãw_size
);

5408 ià(
»t
)

5409 
out
;

5413 
	`ext4_šode_block_uÆocked_dio
(
šode
);

5414 
	`šode_dio_wa™
(
šode
);

5416 
»t
 = 
	`ext4_®loc_fe_blocks_fÜ_dr
(
hªdË
, 
fe
, 
lblk
, 
max_blocks
, 
Ãw_size
, 
æags
);

5417 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

5418 ià(
»t
)

5419 
out
;

5421 ià(
fe
->
f_æags
 & 
O_SYNC
 && 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
) {

5422 
»t
 = 
	`jbd2_com¶‘e_Œª§ùiÚ
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
,

5423 
	`EXT4_I
(
šode
)->
i_sync_tid
);

5425 
out
:

5426 
	`Œaû_ext4_çÎoÿ‹_ex™
(
šode
, 
off£t
, 
max_blocks
, 
»t
);

5427  
»t
;

5428 
	}
}

5441 
	$ext4_cÚv”t_unwr™‹n_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

5442 
loff_t
 
off£t
, 
ssize_t
 
Ën
)

5444 
max_blocks
;

5445 
»t
 = 0;

5446 
»t2
 = 0;

5447 
ext4_m­_blocks
 
m­
;

5448 
üed™s
, 
blkb™s
 = 
šode
->
i_blkb™s
;

5450 
m­
.
m_lblk
 = 
off£t
 >> 
blkb™s
;

5451 
max_blocks
 = 
	`EXT4_MAX_BLOCKS
(
Ën
, 
off£t
, 
blkb™s
);

5458 ià(
hªdË
) {

5459 
hªdË
 = 
	`ext4_jouº®_¡¬t_»£rved
(handle,

5460 
EXT4_HT_EXT_CONVERT
);

5461 ià(
	`IS_ERR
(
hªdË
))

5462  
	`PTR_ERR
(
hªdË
);

5463 
üed™s
 = 0;

5468 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
max_blocks
);

5470 
»t
 >ğ0 &&„‘ < 
max_blocks
) {

5471 
m­
.
m_lblk
 +ğ
»t
;

5472 
m­
.
m_Ën
 = (
max_blocks
 -ğ
»t
);

5473 ià(
üed™s
) {

5474 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MAP_BLOCKS
,

5475 
üed™s
);

5476 ià(
	`IS_ERR
(
hªdË
)) {

5477 
»t
 = 
	`PTR_ERR
(
hªdË
);

5481 
»t
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
,

5482 
EXT4_GET_BLOCKS_IO_CONVERT_EXT
);

5483 ià(
»t
 <= 0)

5484 
	`ext4_w¬nšg
(
šode
->
i_sb
,

5487 
šode
->
i_šo
, 
m­
.
m_lblk
,

5488 
m­
.
m_Ën
, 
»t
);

5489 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5490 ià(
üed™s
)

5491 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5492 ià(
»t
 <ğ0 || 
»t2
)

5495 ià(!
üed™s
)

5496 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5497  
»t
 > 0 ? 
»t2
 :„et;

5498 
	}
}

5509 
	$ext4_fšd_d–ayed_ex‹Á
(
šode
 *inode,

5510 
ex‹Á_¡©us
 *
Ãwes
)

5512 
ex‹Á_¡©us
 
es
;

5513 
ext4_lblk_t
 
block
, 
Ãxt_d–
;

5515 ià(
Ãwes
->
es_pblk
 == 0) {

5516 
	`ext4_es_fšd_d–ayed_ex‹Á_¿nge
(
šode
, 
Ãwes
->
es_lblk
,

5517 
Ãwes
->
es_lblk
 +‚ewes->
es_Ën
 - 1, &
es
);

5523 ià(
es
.
es_Ën
 == 0)

5527 ià(
es
.
es_lblk
 > 
Ãwes
->es_lblk) {

5529 
Ãwes
->
es_Ën
 = 
	`mš
(
es
.
es_lblk
 -‚ewes->es_lblk,

5530 
Ãwes
->
es_Ën
);

5534 
Ãwes
->
es_Ën
 = 
es
.
es_lblk
 +ƒs.es_len -‚ewes->es_lblk;

5537 
block
 = 
Ãwes
->
es_lblk
 +‚ewes->
es_Ën
;

5538 
	`ext4_es_fšd_d–ayed_ex‹Á_¿nge
(
šode
, 
block
, 
EXT_MAX_BLOCKS
, &
es
);

5539 ià(
es
.
es_Ën
 == 0)

5540 
Ãxt_d–
 = 
EXT_MAX_BLOCKS
;

5542 
Ãxt_d–
 = 
es
.
es_lblk
;

5544  
Ãxt_d–
;

5545 
	}
}

5547 
	#EXT4_FIEMAP_FLAGS
 (
FIEMAP_FLAG_SYNC
|
FIEMAP_FLAG_XATTR
)

	)

5549 
	$ext4_x©Œ_f›m­
(
šode
 *inode,

5550 
f›m­_ex‹Á_šfo
 *
f›šfo
)

5552 
__u64
 
physiÿl
 = 0;

5553 
__u64
 
Ëngth
;

5554 
__u32
 
æags
 = 
FIEMAP_EXTENT_LAST
;

5555 
blockb™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

5556 
”rÜ
 = 0;

5559 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
)) {

5560 
ext4_oc
 
oc
;

5561 
off£t
;

5563 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

5564 ià(
”rÜ
)

5565  
”rÜ
;

5566 
physiÿl
 = (
__u64
)
oc
.
bh
->
b_blockÄ
 << 
blockb™s
;

5567 
off£t
 = 
EXT4_GOOD_OLD_INODE_SIZE
 +

5568 
	`EXT4_I
(
šode
)->
i_exŒa_isize
;

5569 
physiÿl
 +ğ
off£t
;

5570 
Ëngth
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
 - 
off£t
;

5571 
æags
 |ğ
FIEMAP_EXTENT_DATA_INLINE
;

5572 
	`b»l£
(
oc
.
bh
);

5574 
physiÿl
 = (
__u64
)
	`EXT4_I
(
šode
)->
i_fe_aş
 << 
blockb™s
;

5575 
Ëngth
 = 
šode
->
i_sb
->
s_blocksize
;

5578 ià(
physiÿl
)

5579 
”rÜ
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 0, 
physiÿl
,

5580 
Ëngth
, 
æags
);

5581  (
”rÜ
 < 0 ?ƒrror : 0);

5582 
	}
}

5584 
	$ext4_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

5585 
__u64
 
¡¬t
, __u64 
Ën
)

5587 
ext4_lblk_t
 
¡¬t_blk
;

5588 
”rÜ
 = 0;

5590 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

5591 
has_šlše
 = 1;

5593 
”rÜ
 = 
	`ext4_šlše_d©a_f›m­
(
šode
, 
f›šfo
, &
has_šlše
,

5594 
¡¬t
, 
Ën
);

5596 ià(
has_šlše
)

5597  
”rÜ
;

5600 ià(
f›šfo
->
fi_æags
 & 
FIEMAP_FLAG_CACHE
) {

5601 
”rÜ
 = 
	`ext4_ext_´eÿche
(
šode
);

5602 ià(
”rÜ
)

5603  
”rÜ
;

5607 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

5608  
	`g’”ic_block_f›m­
(
šode
, 
f›šfo
, 
¡¬t
, 
Ën
,

5609 
ext4_g‘_block
);

5611 ià(
	`f›m­_check_æags
(
f›šfo
, 
EXT4_FIEMAP_FLAGS
))

5612  -
EBADR
;

5614 ià(
f›šfo
->
fi_æags
 & 
FIEMAP_FLAG_XATTR
) {

5615 
”rÜ
 = 
	`ext4_x©Œ_f›m­
(
šode
, 
f›šfo
);

5617 
ext4_lblk_t
 
Ën_blks
;

5618 
__u64
 
Ï¡_blk
;

5620 
¡¬t_blk
 = 
¡¬t
 >> 
šode
->
i_sb
->
s_blocksize_b™s
;

5621 
Ï¡_blk
 = (
¡¬t
 + 
Ën
 - 1è>> 
šode
->
i_sb
->
s_blocksize_b™s
;

5622 ià(
Ï¡_blk
 >ğ
EXT_MAX_BLOCKS
)

5623 
Ï¡_blk
 = 
EXT_MAX_BLOCKS
-1;

5624 
Ën_blks
 = ((
ext4_lblk_t
è
Ï¡_blk
è- 
¡¬t_blk
 + 1;

5630 
”rÜ
 = 
	`ext4_fl_f›m­_ex‹Ás
(
šode
, 
¡¬t_blk
,

5631 
Ën_blks
, 
f›šfo
);

5633  
”rÜ
;

5634 
	}
}

5643 
	$ext4_acûss_·th
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

5644 
ext4_ext_·th
 *
·th
)

5646 
üed™s
, 
”r
;

5648 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

5657 ià(
hªdË
->
h_bufãr_üed™s
 < 7) {

5658 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

5659 
”r
 = 
	`ext4_ext_Œunÿ‹_ex‹nd_»¡¬t
(
hªdË
, 
šode
, 
üed™s
);

5661 ià(
”r
 &&ƒ¼ !ğ-
EAGAIN
)

5662  
”r
;

5665 
”r
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode
, 
·th
);

5666  
”r
;

5667 
	}
}

5676 
	$ext4_ext_shiá_·th_ex‹Ás
(
ext4_ext_·th
 *
·th
, 
ext4_lblk_t
 
shiá
,

5677 
šode
 *šode, 
hªdË_t
 *
hªdË
,

5678 
SHIFT_DIRECTION
 
SHIFT
)

5680 
d•th
, 
”r
 = 0;

5681 
ext4_ex‹Á
 *
ex_¡¬t
, *
ex_Ï¡
;

5682 
boŞ
 
upd©e
 = 0;

5683 
d•th
 = 
·th
->
p_d•th
;

5685 
d•th
 >= 0) {

5686 ià(
d•th
 =ğ
·th
->
p_d•th
) {

5687 
ex_¡¬t
 = 
·th
[
d•th
].
p_ext
;

5688 ià(!
ex_¡¬t
)

5689  -
EFSCORRUPTED
;

5691 
ex_Ï¡
 = 
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
);

5693 
”r
 = 
	`ext4_acûss_·th
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

5694 ià(
”r
)

5695 
out
;

5697 ià(
ex_¡¬t
 =ğ
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
))

5698 
upd©e
 = 1;

5700 
ex_¡¬t
 <ğ
ex_Ï¡
) {

5701 ià(
SHIFT
 =ğ
SHIFT_LEFT
) {

5702 
	`Ë32_add_ıu
(&
ex_¡¬t
->
“_block
,

5703 -
shiá
);

5705 ià((
ex_¡¬t
 >

5706 
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
))

5708 
	`ext4_ext_Œy_to_m”ge_right
(
šode
,

5709 
·th
, 
ex_¡¬t
 - 1))

5710 
ex_Ï¡
--;

5712 
ex_¡¬t
++;

5714 
	`Ë32_add_ıu
(&
ex_Ï¡
->
“_block
, 
shiá
);

5715 
	`ext4_ext_Œy_to_m”ge_right
(
šode
, 
·th
,

5716 
ex_Ï¡
);

5717 
ex_Ï¡
--;

5720 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

5721 ià(
”r
)

5722 
out
;

5724 ià(--
d•th
 < 0 || !
upd©e
)

5729 
”r
 = 
	`ext4_acûss_·th
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

5730 ià(
”r
)

5731 
out
;

5733 ià(
SHIFT
 =ğ
SHIFT_LEFT
)

5734 
	`Ë32_add_ıu
(&
·th
[
d•th
].
p_idx
->
ei_block
, -
shiá
);

5736 
	`Ë32_add_ıu
(&
·th
[
d•th
].
p_idx
->
ei_block
, 
shiá
);

5737 
”r
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode
, 
·th
 + 
d•th
);

5738 ià(
”r
)

5739 
out
;

5742 ià(
·th
[
d•th
].
p_idx
 !ğ
	`EXT_FIRST_INDEX
Õ©h[d•th].
p_hdr
))

5745 
d•th
--;

5748 
out
:

5749  
”r
;

5750 
	}
}

5760 
	$ext4_ext_shiá_ex‹Ás
(
šode
 *šode, 
hªdË_t
 *
hªdË
,

5761 
ext4_lblk_t
 
¡¬t
,ƒxt4_lblk_ˆ
shiá
,

5762 
SHIFT_DIRECTION
 
SHIFT
)

5764 
ext4_ext_·th
 *
·th
;

5765 
»t
 = 0, 
d•th
;

5766 
ext4_ex‹Á
 *
ex‹Á
;

5767 
ext4_lblk_t
 
¡İ
, *
™”©Ü
, 
ex_¡¬t
, 
ex_’d
;

5770 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
,

5771 
EXT4_EX_NOCACHE
);

5772 ià(
	`IS_ERR
(
·th
))

5773  
	`PTR_ERR
(
·th
);

5775 
d•th
 = 
·th
->
p_d•th
;

5776 
ex‹Á
 = 
·th
[
d•th
].
p_ext
;

5777 ià(!
ex‹Á
)

5778 
out
;

5780 
¡İ
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
);

5786 ià(
SHIFT
 =ğ
SHIFT_LEFT
) {

5787 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
¡¬t
 - 1, &path,

5788 
EXT4_EX_NOCACHE
);

5789 ià(
	`IS_ERR
(
·th
))

5790  
	`PTR_ERR
(
·th
);

5791 
d•th
 = 
·th
->
p_d•th
;

5792 
ex‹Á
 = 
·th
[
d•th
].
p_ext
;

5793 ià(
ex‹Á
) {

5794 
ex_¡¬t
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
);

5795 
ex_’d
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
) +

5796 
	`ext4_ext_g‘_aùu®_Ën
(
ex‹Á
);

5798 
ex_¡¬t
 = 0;

5799 
ex_’d
 = 0;

5802 ià((
¡¬t
 =ğ
ex_¡¬t
 && 
shiá
 >ƒx_start) ||

5803 (
shiá
 > 
¡¬t
 - 
ex_’d
)) {

5804 
	`ext4_ext_drİ_»fs
(
·th
);

5805 
	`kä“
(
·th
);

5806  -
EINVAL
;

5815 ià(
SHIFT
 =ğ
SHIFT_LEFT
)

5816 
™”©Ü
 = &
¡¬t
;

5818 
™”©Ü
 = &
¡İ
;

5825 
™”©Ü
 && 
¡¬t
 <ğ
¡İ
) {

5826 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, *
™”©Ü
, &path,

5827 
EXT4_EX_NOCACHE
);

5828 ià(
	`IS_ERR
(
·th
))

5829  
	`PTR_ERR
(
·th
);

5830 
d•th
 = 
·th
->
p_d•th
;

5831 
ex‹Á
 = 
·th
[
d•th
].
p_ext
;

5832 ià(!
ex‹Á
) {

5833 
	`EXT4_ERROR_INODE
(
šode
, "unexpected hole‡t %lu",

5834 (è*
™”©Ü
);

5835  -
EFSCORRUPTED
;

5837 ià(
SHIFT
 =ğ
SHIFT_LEFT
 && *
™”©Ü
 >

5838 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
)) {

5840 ià(
ex‹Á
 < 
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
)) {

5841 
·th
[
d•th
].
p_ext
++;

5843 *
™”©Ü
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

5848 ià(
SHIFT
 =ğ
SHIFT_LEFT
) {

5849 
ex‹Á
 = 
	`EXT_LAST_EXTENT
(
·th
[
d•th
].
p_hdr
);

5850 *
™”©Ü
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
) +

5851 
	`ext4_ext_g‘_aùu®_Ën
(
ex‹Á
);

5853 
ex‹Á
 = 
	`EXT_FIRST_EXTENT
(
·th
[
d•th
].
p_hdr
);

5854 ià(
	`Ë32_to_ıu
(
ex‹Á
->
“_block
) > 0)

5855 *
™”©Ü
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
) - 1;

5858 
™”©Ü
 = 
NULL
;

5860 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
è< 
¡¬t
)

5861 
ex‹Á
++;

5862 
·th
[
d•th
].
p_ext
 = 
ex‹Á
;

5864 
»t
 = 
	`ext4_ext_shiá_·th_ex‹Ás
(
·th
, 
shiá
, 
šode
,

5865 
hªdË
, 
SHIFT
);

5866 ià(
»t
)

5869 
out
:

5870 
	`ext4_ext_drİ_»fs
(
·th
);

5871 
	`kä“
(
·th
);

5872  
»t
;

5873 
	}
}

5880 
	$ext4_m‘a_cŞÏp£_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
, 
hªdË_t
 *
hªdË
)

5882 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

5883 
ext4_lblk_t
 
punch_¡¬t
, 
punch_¡İ
;

5884 
loff_t
 
Ãw_size
, 
ioff£t
;

5885 
»t
;

5892 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

5894  -
EOPNOTSUPP
;

5898 ià(
off£t
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5899 
Ën
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1)) {

5901  -
EINVAL
;

5904 ià(!
	`S_ISREG
(
šode
->
i_mode
))

5905  -
EINVAL
;

5907 
	`Œaû_ext4_cŞÏp£_¿nge
(
šode
, 
off£t
, 
Ën
);

5909 
punch_¡¬t
 = 
off£t
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5910 
punch_¡İ
 = (
off£t
 + 
Ën
è>> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5916 ià(
off£t
 + 
Ën
 >ğ
	`i_size_»ad
(
šode
)) {

5917 
»t
 = -
EINVAL
;

5919 
out_mu‹x
;

5923 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

5925 
»t
 = -
EOPNOTSUPP
;

5926 
out_mu‹x
;

5931 
	`ext4_šode_block_uÆocked_dio
(
šode
);

5932 
	`šode_dio_wa™
(
šode
);

5942 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5947 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
ioff£t
, 
off£t
);

5948 ià(
»t
) {

5950 
out_mm­
;

5957 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
 + 
Ën
,

5958 
LLONG_MAX
);

5959 ià(
»t
) {

5961 
out_mm­
;

5963 
	`Œunÿ‹_·geÿche
(
šode
, 
ioff£t
);

5965 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

5967 
»t
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
punch_¡¬t
,

5968 
EXT_MAX_BLOCKS
 - 
punch_¡¬t
);

5969 ià(
»t
) {

5971 
out_¡İ
;

5975 
»t
 = 
	`ext4_ext_»move_¥aû
(
šode
, 
punch_¡¬t
, 
punch_¡İ
 - 1);

5976 ià(
»t
) {

5978 
out_¡İ
;

5980 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

5982 
»t
 = 
	`ext4_ext_shiá_ex‹Ás
(
šode
, 
hªdË
, 
punch_¡İ
,

5983 
punch_¡İ
 - 
punch_¡¬t
, 
SHIFT_LEFT
);

5984 ià(
»t
) {

5986 
out_¡İ
;

5989 
Ãw_size
 = 
	`i_size_»ad
(
šode
è- 
Ën
;

5990 
	`i_size_wr™e
(
šode
, 
Ãw_size
);

5991 
	`EXT4_I
(
šode
)->
i_disksize
 = 
Ãw_size
;

5994 ià(
	`IS_SYNC
(
šode
))

5995 
	`ext4_hªdË_sync
(
hªdË
);

5996 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

5997 
	`ext4_fc_m¬k_š–igibË
(
šode
,

5998 
EXT4_FC_REASON_FALLOC_RANGE_OP
);

5999 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6000 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

6002 
out_¡İ
:

6004 
out_mm­
:

6005 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

6006 
out_mu‹x
:

6007  
»t
;

6008 
	}
}

6017 
	$ext4_cŞÏp£_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

6019 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

6020 
ext4_lblk_t
 
punch_¡¬t
, 
punch_¡İ
;

6021 
hªdË_t
 *
hªdË
;

6022 
üed™s
;

6023 
loff_t
 
Ãw_size
, 
ioff£t
;

6024 
»t
;

6031 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

6032  -
EOPNOTSUPP
;

6035 ià(
off£t
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1) ||

6036 
Ën
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1))

6037  -
EINVAL
;

6039 ià(!
	`S_ISREG
(
šode
->
i_mode
))

6040  -
EINVAL
;

6042 
	`Œaû_ext4_cŞÏp£_¿nge
(
šode
, 
off£t
, 
Ën
);

6044 
punch_¡¬t
 = 
off£t
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

6045 
punch_¡İ
 = (
off£t
 + 
Ën
è>> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

6048 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

6049 
»t
 = 
	`ext4_fÜû_comm™
(
šode
->
i_sb
);

6050 ià(
»t
)

6051  
»t
;

6054 
	`šode_lock
(
šode
);

6059 ià(
off£t
 + 
Ën
 >ğ
	`i_size_»ad
(
šode
)) {

6060 
»t
 = -
EINVAL
;

6061 
out_mu‹x
;

6065 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

6066 
»t
 = -
EOPNOTSUPP
;

6067 
out_mu‹x
;

6071 
	`ext4_šode_block_uÆocked_dio
(
šode
);

6072 
	`šode_dio_wa™
(
šode
);

6078 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6083 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

6088 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
ioff£t
, 
off£t
);

6089 ià(
»t
)

6090 
out_mm­
;

6096 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
off£t
 + 
Ën
,

6097 
LLONG_MAX
);

6098 ià(
»t
)

6099 
out_mm­
;

6100 
	`Œunÿ‹_·geÿche
(
šode
, 
ioff£t
);

6102 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

6103 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
üed™s
);

6104 ià(
	`IS_ERR
(
hªdË
)) {

6105 
»t
 = 
	`PTR_ERR
(
hªdË
);

6106 
out_mm­
;

6109 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6110 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

6112 
»t
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
punch_¡¬t
,

6113 
EXT_MAX_BLOCKS
 - 
punch_¡¬t
);

6114 ià(
»t
) {

6115 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6116 
out_¡İ
;

6119 
»t
 = 
	`ext4_ext_»move_¥aû
(
šode
, 
punch_¡¬t
, 
punch_¡İ
 - 1);

6120 ià(
»t
) {

6121 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6122 
out_¡İ
;

6124 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

6126 
»t
 = 
	`ext4_ext_shiá_ex‹Ás
(
šode
, 
hªdË
, 
punch_¡İ
,

6127 
punch_¡İ
 - 
punch_¡¬t
, 
SHIFT_LEFT
);

6128 ià(
»t
) {

6129 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6130 
out_¡İ
;

6133 
Ãw_size
 = 
	`i_size_»ad
(
šode
è- 
Ën
;

6134 
	`i_size_wr™e
(
šode
, 
Ãw_size
);

6135 
	`EXT4_I
(
šode
)->
i_disksize
 = 
Ãw_size
;

6137 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6138 ià(
	`IS_SYNC
(
šode
))

6139 
	`ext4_hªdË_sync
(
hªdË
);

6140 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

6141 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6142 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

6144 
out_¡İ
:

6145 
	`ext4_jouº®_¡İ
(
hªdË
);

6146 
out_mm­
:

6147 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6148 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

6149 
out_mu‹x
:

6150 
	`šode_uÆock
(
šode
);

6151  
»t
;

6152 
	}
}

6162 
	$ext4_š£¹_¿nge
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

6164 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

6165 
hªdË_t
 *
hªdË
;

6166 
ext4_ext_·th
 *
·th
;

6167 
ext4_ex‹Á
 *
ex‹Á
;

6168 
ext4_lblk_t
 
off£t_lblk
, 
Ën_lblk
, 
“_¡¬t_lblk
 = 0;

6169 
üed™s
, 
“_Ën
;

6170 
»t
 = 0, 
d•th
, 
¥l™_æag
 = 0;

6171 
loff_t
 
ioff£t
;

6178 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

6179  -
EOPNOTSUPP
;

6182 ià(
off£t
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1) ||

6183 
Ën
 & (
	`EXT4_CLUSTER_SIZE
(
sb
) - 1))

6184  -
EINVAL
;

6186 ià(!
	`S_ISREG
(
šode
->
i_mode
))

6187  -
EOPNOTSUPP
;

6189 
	`Œaû_ext4_š£¹_¿nge
(
šode
, 
off£t
, 
Ën
);

6191 
off£t_lblk
 = 
off£t
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

6192 
Ën_lblk
 = 
Ën
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

6195 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

6196 
»t
 = 
	`ext4_fÜû_comm™
(
šode
->
i_sb
);

6197 ià(
»t
)

6198  
»t
;

6201 
	`šode_lock
(
šode
);

6203 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

6204 
»t
 = -
EOPNOTSUPP
;

6205 
out_mu‹x
;

6209 ià(
šode
->
i_size
 + 
Ën
 > inode->
i_sb
->
s_maxby‹s
) {

6210 
»t
 = -
EFBIG
;

6211 
out_mu‹x
;

6215 ià(
off£t
 >ğ
	`i_size_»ad
(
šode
)) {

6216 
»t
 = -
EINVAL
;

6217 
out_mu‹x
;

6221 
	`ext4_šode_block_uÆocked_dio
(
šode
);

6222 
	`šode_dio_wa™
(
šode
);

6228 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6233 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

6235 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
šode
->
i_m­pšg
, 
ioff£t
,

6236 
LLONG_MAX
);

6237 ià(
»t
)

6238 
out_mm­
;

6239 
	`Œunÿ‹_·geÿche
(
šode
, 
ioff£t
);

6241 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

6242 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
üed™s
);

6243 ià(
	`IS_ERR
(
hªdË
)) {

6244 
»t
 = 
	`PTR_ERR
(
hªdË
);

6245 
out_mm­
;

6249 
šode
->
i_size
 +ğ
Ën
;

6250 
	`EXT4_I
(
šode
)->
i_disksize
 +ğ
Ën
;

6251 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

6252 
	`ext4_fc_m¬k_š–igibË
(
šode
,

6253 
EXT4_FC_REASON_FALLOC_RANGE_OP
);

6254 
»t
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6255 ià(
»t
)

6256 
out_¡İ
;

6258 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6259 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

6261 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
off£t_lblk
, 
NULL
, 0);

6262 ià(
	`IS_ERR
(
·th
)) {

6263 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6264 
out_¡İ
;

6267 
d•th
 = 
	`ext_d•th
(
šode
);

6268 
ex‹Á
 = 
·th
[
d•th
].
p_ext
;

6269 ià(
ex‹Á
) {

6270 
“_¡¬t_lblk
 = 
	`Ë32_to_ıu
(
ex‹Á
->
“_block
);

6271 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex‹Á
);

6277 ià((
off£t_lblk
 > 
“_¡¬t_lblk
) &&

6278 (
off£t_lblk
 < (
“_¡¬t_lblk
 + 
“_Ën
))) {

6279 ià(
	`ext4_ext_is_unwr™‹n
(
ex‹Á
))

6280 
¥l™_æag
 = 
EXT4_EXT_MARK_UNWRIT1
 |

6281 
EXT4_EXT_MARK_UNWRIT2
;

6282 
»t
 = 
	`ext4_¥l™_ex‹Á_©
(
hªdË
, 
šode
, &
·th
,

6283 
off£t_lblk
, 
¥l™_æag
,

6284 
EXT4_EX_NOCACHE
 |

6285 
EXT4_GET_BLOCKS_PRE_IO
 |

6286 
EXT4_GET_BLOCKS_METADATA_NOFAIL
);

6289 
	`ext4_ext_drİ_»fs
(
·th
);

6290 
	`kä“
(
·th
);

6291 ià(
»t
 < 0) {

6292 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6293 
out_¡İ
;

6296 
	`ext4_ext_drİ_»fs
(
·th
);

6297 
	`kä“
(
·th
);

6300 
»t
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
off£t_lblk
,

6301 
EXT_MAX_BLOCKS
 - 
off£t_lblk
);

6302 ià(
»t
) {

6303 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6304 
out_¡İ
;

6311 
»t
 = 
	`ext4_ext_shiá_ex‹Ás
(
šode
, 
hªdË
,

6312 
“_¡¬t_lblk
 > 
off£t_lblk
 ?ƒe_start_lblk : offset_lblk,

6313 
Ën_lblk
, 
SHIFT_RIGHT
);

6315 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6316 ià(
	`IS_SYNC
(
šode
))

6317 
	`ext4_hªdË_sync
(
hªdË
);

6318 ià(
»t
 >= 0)

6319 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

6321 
out_¡İ
:

6322 
	`ext4_jouº®_¡İ
(
hªdË
);

6323 
out_mm­
:

6324 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6325 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

6326 
out_mu‹x
:

6327 
	`šode_uÆock
(
šode
);

6328  
»t
;

6329 
	}
}

6333 
	$ext4_ext_m‘a_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

6334 
ext4_m­_blocks
 *
m­
, 
æags
)

6336 
ext4_ext_·th
 *
·th
 = 
NULL
;

6337 
ext4_ex‹Á
 
Ãwex
, *
ex
, *
ex2
;

6338 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

6339 
ext4_fsblk_t
 
Ãwblock
 = 0;

6340 
ä“_Ú_”r
 = 0, 
”r
 = 0, 
d•th
, 
»t
;

6341 
®loÿ‹d
 = 0, 
off£t
 = 0;

6342 
®loÿ‹d_şu¡”s
 = 0;

6343 
ext4_®loÿtiÚ_»que¡
 
¬
;

6344 
ext4_lblk_t
 
şu¡”_off£t
;

6345 
boŞ
 
m­_äom_şu¡”
 = 
çl£
;

6347 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
m­
->
lblk
, 
NULL
, 0);

6348 ià(
	`IS_ERR
(
·th
)) {

6349 
”r
 = 
	`PTR_ERR
(
·th
);

6350 
·th
 = 
NULL
;

6351 
out2
;

6354 
d•th
 = 
	`ext_d•th
(
šode
);

6361 ià(
	`uÆik–y
(
·th
[
d•th
].
p_ext
 =ğ
NULL
 && depth != 0)) {

6362 
	`EXT4_ERROR_INODE
(
šode
, "badƒxtent‡ddress "

6364 (è
m­
->
m_lblk
, 
d•th
,

6365 
·th
[
d•th
].
p_block
);

6366 
”r
 = -
EFSCORRUPTED
;

6367 
out2
;

6370 
ex
 = 
·th
[
d•th
].
p_ext
;

6371 ià(
ex
) {

6372 
ext4_lblk_t
 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

6373 
ext4_fsblk_t
 
“_¡¬t
 = 
	`ext4_ext_pblock
(
ex
);

6374 
“_Ën
;

6381 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

6383 
	`Œaû_ext4_ext_show_ex‹Á
(
šode
, 
“_block
, 
“_¡¬t
, 
“_Ën
);

6386 ià(
	`š_¿nge
(
m­
->
m_lblk
, 
“_block
, 
“_Ën
)) {

6387 
Ãwblock
 = 
m­
->
m_lblk
 - 
“_block
 + 
“_¡¬t
;

6389 
®loÿ‹d
 = 
“_Ën
 - (
m­
->
m_lblk
 - 
“_block
);

6390 
	`ext_debug
("%u f™ iÁØ%u:%d -> %Îu\n", 
m­
->
m_lblk
,

6391 
“_block
, 
“_Ën
, 
Ãwblock
);

6393 
out2
;

6400 
Ãwex
.
“_block
 = 
	`ıu_to_Ë32
(
m­
->
m_lblk
);

6401 
şu¡”_off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
m­
->
m_lblk
);

6407 ià(
şu¡”_off£t
 && 
ex
 &&

6408 
	`g‘_im¶›d_şu¡”_®loc
(
šode
->
i_sb
, 
m­
, 
ex
, 
·th
)) {

6409 
¬
.
Ën
 = 
®loÿ‹d
 = 
m­
->
m_Ën
;

6410 
Ãwblock
 = 
m­
->
m_pblk
;

6411 
m­_äom_şu¡”
 = 
Œue
;

6412 
gÙ_®loÿ‹d_blocks
;

6416 
¬
.
Îeá
 = 
m­
->
m_lblk
;

6417 
”r
 = 
	`ext4_ext_£¬ch_Ëá
(
šode
, 
·th
, &
¬
.
Îeá
, &¬.
¶eá
);

6418 ià(
”r
)

6419 
out2
;

6420 
¬
.
Ìight
 = 
m­
->
m_lblk
;

6421 
ex2
 = 
NULL
;

6422 
”r
 = 
	`ext4_ext_£¬ch_right
(
šode
, 
·th
, &
¬
.
Ìight
, &¬.
´ight
, &
ex2
);

6423 ià(
”r
)

6424 
out2
;

6428 ià((
sbi
->
s_şu¡”_¿tio
 > 1è&& 
ex2
 &&

6429 
	`g‘_im¶›d_şu¡”_®loc
(
šode
->
i_sb
, 
m­
, 
ex2
, 
·th
)) {

6430 
¬
.
Ën
 = 
®loÿ‹d
 = 
m­
->
m_Ën
;

6431 
Ãwblock
 = 
m­
->
m_pblk
;

6432 
m­_äom_şu¡”
 = 
Œue
;

6433 
gÙ_®loÿ‹d_blocks
;

6442 ià(
m­
->
m_Ën
 > 
EXT_INIT_MAX_LEN
 &&

6443 !(
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
))

6444 
m­
->
m_Ën
 = 
EXT_INIT_MAX_LEN
;

6445 ià(
m­
->
m_Ën
 > 
EXT_UNWRITTEN_MAX_LEN
 &&

6446 (
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
))

6447 
m­
->
m_Ën
 = 
EXT_UNWRITTEN_MAX_LEN
;

6450 
Ãwex
.
“_Ën
 = 
	`ıu_to_Ë16
(
m­
->
m_Ën
);

6451 
”r
 = 
	`ext4_ext_check_ov”Ïp
(
sbi
, 
šode
, &
Ãwex
, 
·th
);

6452 ià(
”r
)

6453 
®loÿ‹d
 = 
	`ext4_ext_g‘_aùu®_Ën
(&
Ãwex
);

6455 
®loÿ‹d
 = 
m­
->
m_Ën
;

6458 
¬
.
šode
 = inode;

6459 
¬
.
gßl
 = 
	`ext4_ext_fšd_gßl
(
šode
, 
·th
, 
m­
->
m_lblk
);

6460 
¬
.
logiÿl
 = 
m­
->
m_lblk
;

6469 
off£t
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
m­
->
m_lblk
);

6470 
¬
.
Ën
 = 
	`EXT4_NUM_B2C
(
sbi
, 
off£t
+
®loÿ‹d
);

6471 
¬
.
gßl
 -ğ
off£t
;

6472 
¬
.
logiÿl
 -ğ
off£t
;

6474 ià(
	`S_ISREG
(
šode
->
i_mode
))

6475 
¬
.
æags
 = 
EXT4_MB_HINT_DATA
;

6478 
¬
.
æags
 = 0;

6479 ià(
æags
 & 
EXT4_GET_BLOCKS_NO_NORMALIZE
)

6480 
¬
.
æags
 |ğ
EXT4_MB_HINT_NOPREALLOC
;

6481 ià(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
)

6482 
¬
.
æags
 |ğ
EXT4_MB_DELALLOC_RESERVED
;

6483 ià(
æags
 & 
EXT4_GET_BLOCKS_METADATA_NOFAIL
)

6484 
¬
.
æags
 |ğ
EXT4_MB_USE_RESERVED
;

6485 
	`ext_debug
("allocate‚ew block: goal %llu, found %llu/%u\n",

6486 
¬
.
gßl
, 
Ãwblock
, 
®loÿ‹d
);

6487 
ä“_Ú_”r
 = 1;

6488 
®loÿ‹d_şu¡”s
 = 
¬
.
Ën
;

6489 
¬
.
Ën
 = 
	`EXT4_C2B
(
sbi
,‡r.Ënè- 
off£t
;

6490 ià(
¬
.
Ën
 > 
®loÿ‹d
)

6491 
¬
.
Ën
 = 
®loÿ‹d
;

6493 
gÙ_®loÿ‹d_blocks
:

6495 
	`ext4_ext_¡Üe_pblock
(&
Ãwex
, 
Ãwblock
 + 
off£t
);

6496 
Ãwex
.
“_Ën
 = 
	`ıu_to_Ë16
(
¬
.
Ën
);

6498 
”r
 = 0;

6499 
”r
 = 
	`ext4_ext_š£¹_ex‹Á
(
hªdË
, 
šode
, &
·th
,

6500 &
Ãwex
, 
æags
);

6502 ià(
”r
 && 
ä“_Ú_”r
) {

6503 
fb_æags
 = 
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
 ?

6504 
EXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 : 0;

6508 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

6509 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
Ãwblock
,

6510 
	`EXT4_C2B
(
sbi
, 
®loÿ‹d_şu¡”s
), 
fb_æags
);

6511 
out2
;

6515 
Ãwblock
 = 
	`ext4_ext_pblock
(&
Ãwex
);

6516 
®loÿ‹d
 = 
	`ext4_ext_g‘_aùu®_Ën
(&
Ãwex
);

6517 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

6518 
®loÿ‹d
 = 
m­
->
m_Ën
;

6519 
m­
->
m_æags
 |ğ
EXT4_MAP_NEW
;

6521 ià((
æags
 & 
EXT4_GET_BLOCKS_UNWRIT_EXT
) == 0)

6522 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

6524 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 0);

6525 
out
:

6526 ià(
®loÿ‹d
 > 
m­
->
m_Ën
)

6527 
®loÿ‹d
 = 
m­
->
m_Ën
;

6528 
	`ext4_ext_show_Ëaf
(
šode
, 
·th
);

6529 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

6530 
m­
->
m_pblk
 = 
Ãwblock
;

6531 
m­
->
m_Ën
 = 
®loÿ‹d
;

6532 
out2
:

6533 
	`ext4_ext_drİ_»fs
(
·th
);

6534 
	`kä“
(
·th
);

6536 
	`Œaû_ext4_ext_m­_blocks_ex™
(
šode
, 
æags
, 
m­
,

6537 
”r
 ?ƒ¼ : 
®loÿ‹d
);

6538  
”r
 ?ƒ¼ : 
®loÿ‹d
;

6539 
	}
}

6545 
	$ext4_m‘a_®loc_fe_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

6546 
ext4_lblk_t
 
off£t
,ƒxt4_lblk_ˆ
Ën
,

6547 
æags
)

6549 
ext4_m­_blocks
 
m­
;

6550 
»t
 = 0;

6551 
»t2
 = 0;

6552 
»Ár›s
 = 0;

6553 
d•th
 = 0;

6554 
üed™s
;

6555 
loff_t
 
•os
;

6556 
loff_t
 
Ãw_size
 = 0;

6558 
	`BUG_ON
(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
));

6559 
m­
.
m_Ën
 = 
off£t
;

6560 
m­
.
m_Ën
 = 
Ën
;

6562 ià(
off£t
 + 
Ën
 > 
	`i_size_»ad
(
šode
)) {

6563 
Ãw_size
 = 
off£t
 + 
Ën
;

6564 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
Ãw_size
);

6572 ià(
Ën
 <ğ
EXT_UNWRITTEN_MAX_LEN
)

6573 
æags
 |ğ
EXT4_GET_BLOCKS_NO_NORMALIZE
;

6578 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
Ën
);

6579 
d•th
 = 
	`ext_d•th
(
šode
);

6581 
»Œy
:

6582 
»t
 >ğ0 && 
Ën
) {

6586 ià(
d•th
 !ğ
	`ext_d•th
(
šode
)) {

6587 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
Ën
);

6588 
d•th
 = 
	`ext_d•th
(
šode
);

6591 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6592 
»tv®
 = 
	`ext4_ext_m‘a_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
 &

6593 
EXT4_GET_BLOCKS_KEEP_SIZE
);

6595 ià(
»tv®
 <= 0) {

6596 
	`ext4_debug
("inode #%lu: block %u:†en %u: "

6598 
šode
->
i_šo
, 
m­
.
m_lblk
,

6599 
m­
.
m_Ën
, 
»t
);

6600 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6602 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

6605 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

6607 
m­
.
m_lblk
 +ğ
»t
;

6608 
m­
.
m_Ën
 = 
Ën
 =†’ - 
»t
;

6609 
•os
 = (
loff_t
)
m­
.
m_lblk
 << 
šode
->
i_blkb™s
;

6610 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

6611 ià(
Ãw_size
) {

6612 ià(
•os
 > 
Ãw_size
)

6613 
•os
 = 
Ãw_size
;

6614 ià(
	`ext4_upd©e_šode_size
(
šode
, 
•os
) & 0x1)

6615 
šode
->
i_mtime
 = inode->
i_ùime
;

6617 ià(
•os
 > 
šode
->
i_size
)

6618 
	`ext4_£t_šode_æag
(
šode
,

6619 
EXT4_INODE_EOFBLOCKS
);

6621 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6623 ià(
»t
 =ğ-
ENOSPC
 &&

6624 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
)) {

6625 
»t
 = 0;

6626 
»Œy
;

6629  
»t
 > 0 ? 
»t2
 :„et;

6630 
	}
}

6655 
	$ext4_dyÇmic_»m­
(
hªdË_t
 *
hªdË
, 
šode
 *
»ûiv”_šode
,

6656 
šode
 *
dÚÜ_šode
, 
ext4_lblk_t
 
»c_lblk
,ƒxt4_lblk_ˆ
dÚÜ_lblk
,

6657 
ext4_lblk_t
 
couÁ
, *
”p
)

6659 
ext4_ext_·th
 *
dÚÜ_·th
 = 
NULL
;

6660 
ext4_ext_·th
 *
»ûiv”_·th
 = 
NULL
;

6662 
»¶aûd_couÁ
 = 0;

6664 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
»ûiv”_šode
)->
i_d©a_£m
));

6665 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
dÚÜ_šode
)->
i_d©a_£m
));

6666 
	`BUG_ON
(!
	`šode_is_locked
(
»ûiv”_šode
));

6667 
	`BUG_ON
(!
	`šode_is_locked
(
dÚÜ_šode
));

6670 
	`ext4_m‘a_®loc_fe_blocks
(
hªdË
, 
»ûiv”_šode
, 
»c_lblk
, 
couÁ
, 
æags
);

6672 *
”p
 = 
	`ext4_es_»move_ex‹Á
(
dÚÜ_šode
, 
dÚÜ_lblk
, 
couÁ
);

6673 ià(
	`uÆik–y
(*
”p
))

6676 
couÁ
) {

6677 
ext4_ex‹Á
 *
dÚÜ_ex
, *
»c_ex
;

6678 
ext4_lblk_t
 
”_blk
, 
ed_blk
;

6679 
ed_Ën
, 
Ën
;

6680 
¥l™
 = 0;

6682 
dÚÜ_·th
 = 
	`ext4_fšd_ex‹Á
(
dÚÜ_šode
, 
dÚÜ_lblk
, 
NULL
, 
EXT4_EX_NOCACHE
);

6683 ià(
	`IS_ERR
(
·th1
)) {

6684 *
”p
 = 
	`PTR_ERR
(
dÚÜ_·th
);

6685 
·th1
 = 
NULL
;

6686 
fšish
:

6687 
couÁ
 = 0;

6688 
»³©
;

6691 
»ûiv”_·th
 = 
	`ext4_fšd_ex‹Á
(
»ûiv”_šode
, 
»c_lblk
, 
NULL
, 
EXT4_EX_NOCACHE
);

6693 
»c_ex
 = 
»ûiv”_·th
[»ûiv”_·th->
p_d•th
].
p_ext
;

6694 
dÚÜ_ex
 = 
dÚÜ_·th
[dÚÜ_·th->
p_d•th
].
p_ext
;

6696 ià(
	`uÆik–y
(!
ex2
 || !
ex1
))

6697 
fšish
;

6699 
”_blk
 = 
	`Ë32_to_ıu
(
»c_ex
->
“_block
);

6700 
ed_blk
 = 
	`Ë32_to_ıu
(
dÚÜ_ex2
->
“_block
);

6701 
ed_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
dÚÜ_ex
);

6704 ià(!
	`š_¿nge
(
»c_lblk
, 
”_blk
, 
ed_Ën
) ||

6705 !
	`š_¿nge
(
dÚÜ_lblk
, 
ed_blk
, 
ed_Ën
)) {

6706 
ext4_lblk_t
 
Ãxt1
, 
Ãxt2
;

6709 
Ãxt1
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
»ûiv”_·th
);

6710 
Ãxt2
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
dÚÜ_·th
);

6712 ià(
”_blk
 > 
»c_lblk
)

6713 
Ãxt1
 = 
”_blk
;

6714 ià(
ed_blk
 > 
dÚÜ_lblk
)

6715 
Ãxt2
 = 
ed_blk
;

6717 ià(
Ãxt1
 =ğ
EXT_MAX_BLOCKS
 || 
Ãxt2
 == EXT_MAX_BLOCKS)

6718 
fšish
;

6720 
Ën
 = 
Ãxt1
 - 
»c_lblk
;

6721 ià(
Ën
 < 
Ãxt2
 - 
dÚÜ_lblk
)

6722 
Ën
 = 
Ãxt2
 - 
dÚÜ_lblk
;

6723 ià(
Ën
 > 
couÁ
)

6724 
Ën
 = 
couÁ
;

6725 
»c_lblk
 +ğ
Ën
;

6726 
dÚÜ_lblk
 +ğ
Ën
;

6727 
couÁ
 -ğ
Ën
;

6728 
»³©
;

6732 ià(
”_blk
 < 
»c_lblk
) {

6733 
¥l™
 = 1;

6734 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
»ûiv”_šode
,

6735 &
»ûiv”_·th
, 
»c_lblk
, 0);

6736 ià(
	`uÆik–y
(*
”p
))

6737 
fšish
;

6739 ià(
ed_blk
 < 
dÚÜ_lblk
) {

6740 
¥l™
 = 1;

6741 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
dÚÜ_šode
,

6742 &
dÚÜ_·th
, 
dÚÜ_lblk
, 0);

6743 ià(
	`uÆik–y
(*
”p
))

6744 
fšish
;

6748 ià(
¥l™
)

6749 
»³©
;

6752 
Ën
 = 
couÁ
;

6753 ià(
Ën
 > 
”_blk
 + 
ed_Ën
 - 
»c_lblk
)

6754 
Ën
 = 
”_blk
 + 
ed_Ën
 - 
»c_lblk
;

6755 ià(
Ën
 > 
ed_blk
 + 
ed_Ën
 - 
dÚÜ_lblk
)

6756 
Ën
 = 
ed_blk
 + 
ed_Ën
 - 
dÚÜ_lblk
;

6758 ià(
Ën
 !ğ
ed_Ën
) {

6759 
¥l™
 = 1;

6760 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
»ûiv”_šode
,

6761 &
»ûiv”_·th
, 
»c_lblk
 + 
Ën
, 0);

6762 ià(
	`uÆik–y
(*
”p
))

6763 
fšish
;

6765 ià(
Ën
 !ğ
e2_Ën
) {

6766 
¥l™
 = 1;

6767 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
dÚÜ_šode
,

6768 &
dÚÜ_·th
, 
dÚÜ_lblk
 + 
Ën
, 0);

6769 ià(*
”p
)

6770 
fšish
;

6774 ià(
¥l™
)

6775 
»³©
;

6777 *
”p
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
»ûiv”_šode
, 
»ûiv”_·th
 +„eûiv”_·th->
p_d•th
);

6778 ià(
	`uÆik–y
(*
”p
))

6779 
fšish
;

6780 *
”p
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
dÚÜ_šode
, 
dÚÜ_·th
 + dÚÜ_·th->
p_d•th
);

6781 ià(
	`uÆik–y
(*
”p
))

6782 
fšish
;

6785 
	`ext4_ext_¡Üe_pblock
(
»c_ex
, 
	`ext4_ext_pblock
(
dÚÜ_ex
));

6786 
»c_ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
ed_Ën
);

6788 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
»ûiv”_šode
, 
»ûiv”_·th
, 
»c_ex
);

6791 
	`šode_lock
(
dÚÜ_šode
);

6792 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

6794 
	`ext4_m‘a_ext_»move_¥aû
(
dÚÜ_šode
, 
dÚÜ_lblk
, dÚÜ_lblk + 
couÁ
 - 1);

6795 ià(
»t
) {

6796 
	`up_wr™e
(&
	`EXT4_I
(
dÚÜ_šode
)->
i_d©a_£m
);

6797 
out_¡İ
;

6800 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
dÚÜ_šode
);

6802 
»t
 = 
	`ext4_m‘a_ext_shiá_ex‹Ás
(
dÚÜ_šode
, 
hªdË
, 
dÚÜ_lblk
 + 
couÁ
,

6803 
couÁ
, 
SHIFT_LEFT
);

6804 ià(
»t
) {

6805 
	`up_wr™e
(&
	`EXT4_I
(
dÚÜ_šode
)->
i_d©a_£m
);

6806 
out_¡İ
;

6809 
Ãw_size
 = 
	`i_size_»ad
(
dÚÜ_šode
è- 
Ën
;

6810 
	`i_size_wr™e
(
dÚÜ_šode
, 
Ãw_size
);

6811 
	`EXT4_I
(
dÚÜ_šode
)->
i_disksize
 = 
Ãw_size
;

6813 
	`up_wr™e
(&
	`EXT4_I
(
dÚÜ_šode
)->
i_d©a_£m
);

6814 ià(
	`IS_SYNC
(
dÚÜ_šode
))

6815 
	`ext4_hªdË_sync
(
hªdË
);

6816 
dÚÜ_šode
->
i_mtime
 = dÚÜ_šode->
i_ùime
 = 
	`cu¼’t_time
(donor_inode);

6817 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dÚÜ_šode
);

6818 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
dÚÜ_šode
, 1);

6823 *
”p
 = 
	`ext4_ext_dœty
(
hªdË
, 
dÚÜ_šode
, 
dÚÜ_·th
 +

6824 
dÚÜ_·th
->
p_d•th
);

6825 ià(
	`uÆik–y
(*
”p
))

6826 
fšish
;

6827 *
”p
 = 
	`ext4_ext_dœty
(
hªdË
, 
»ûiv”_šode
, 
»ûiv”_·th
 +

6828 
»ûiv”_·th
->
p_d•th
);

6835 ià(
	`uÆik–y
(*
”p
))

6836 
fšish
;

6837 
»c_lblk
 +ğ
Ën
;

6838 
dÚÜ_lblk
 +ğ
Ën
;

6839 
»¶aûd_couÁ
 +ğ
Ën
;

6840 
couÁ
 -ğ
Ën
;

6842 
»³©
:

6843 
	`ext4_ext_drİ_»fs
(
»ûiv”_·th
);

6844 
	`kä“
(
»ûiv”_·th
);

6845 
	`ext4_ext_drİ_»fs
(
dÚÜ_·th
);

6846 
	`kä“
(
dÚÜ_·th
);

6847 
·th1
 = 
·th2
 = 
NULL
;

6849  
»¶aûd_couÁ
;

6850 
	}
}

6875 
	$ext4_sw­_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *
šode1
,

6876 
šode
 *
šode2
, 
ext4_lblk_t
 
lblk1
,ƒxt4_lblk_ˆ
lblk2
,

6877 
ext4_lblk_t
 
couÁ
, 
unwr™‹n
, *
”p
)

6879 
ext4_ext_·th
 *
·th1
 = 
NULL
;

6880 
ext4_ext_·th
 *
·th2
 = 
NULL
;

6881 
»¶aûd_couÁ
 = 0;

6883 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
šode1
)->
i_d©a_£m
));

6884 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
šode2
)->
i_d©a_£m
));

6885 
	`BUG_ON
(!
	`šode_is_locked
(
šode1
));

6886 
	`BUG_ON
(!
	`šode_is_locked
(
šode2
));

6888 *
”p
 = 
	`ext4_es_»move_ex‹Á
(
šode1
, 
lblk1
, 
couÁ
);

6889 ià(
	`uÆik–y
(*
”p
))

6891 *
”p
 = 
	`ext4_es_»move_ex‹Á
(
šode2
, 
lblk2
, 
couÁ
);

6892 ià(
	`uÆik–y
(*
”p
))

6895 
couÁ
) {

6896 
ext4_ex‹Á
 *
ex1
, *
ex2
, 
tmp_ex
;

6897 
ext4_lblk_t
 
e1_blk
, 
e2_blk
;

6898 
e1_Ën
, 
e2_Ën
, 
Ën
;

6899 
¥l™
 = 0;

6901 
·th1
 = 
	`ext4_fšd_ex‹Á
(
šode1
, 
lblk1
, 
NULL
, 
EXT4_EX_NOCACHE
);

6902 ià(
	`IS_ERR
(
·th1
)) {

6903 *
”p
 = 
	`PTR_ERR
(
·th1
);

6904 
·th1
 = 
NULL
;

6905 
fšish
:

6906 
couÁ
 = 0;

6907 
»³©
;

6909 
·th2
 = 
	`ext4_fšd_ex‹Á
(
šode2
, 
lblk2
, 
NULL
, 
EXT4_EX_NOCACHE
);

6910 ià(
	`IS_ERR
(
·th2
)) {

6911 *
”p
 = 
	`PTR_ERR
(
·th2
);

6912 
·th2
 = 
NULL
;

6913 
fšish
;

6915 
ex1
 = 
·th1
[·th1->
p_d•th
].
p_ext
;

6916 
ex2
 = 
·th2
[·th2->
p_d•th
].
p_ext
;

6918 ià(
	`uÆik–y
(!
ex2
 || !
ex1
))

6919 
fšish
;

6921 
e1_blk
 = 
	`Ë32_to_ıu
(
ex1
->
“_block
);

6922 
e2_blk
 = 
	`Ë32_to_ıu
(
ex2
->
“_block
);

6923 
e1_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex1
);

6924 
e2_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex2
);

6927 ià(!
	`š_¿nge
(
lblk1
, 
e1_blk
, 
e1_Ën
) ||

6928 !
	`š_¿nge
(
lblk2
, 
e2_blk
, 
e2_Ën
)) {

6929 
ext4_lblk_t
 
Ãxt1
, 
Ãxt2
;

6932 
Ãxt1
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th1
);

6933 
Ãxt2
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th2
);

6935 ià(
e1_blk
 > 
lblk1
)

6936 
Ãxt1
 = 
e1_blk
;

6937 ià(
e2_blk
 > 
lblk2
)

6938 
Ãxt2
 = 
e2_blk
;

6940 ià(
Ãxt1
 =ğ
EXT_MAX_BLOCKS
 || 
Ãxt2
 == EXT_MAX_BLOCKS)

6941 
fšish
;

6943 
Ën
 = 
Ãxt1
 - 
lblk1
;

6944 ià(
Ën
 < 
Ãxt2
 - 
lblk2
)

6945 
Ën
 = 
Ãxt2
 - 
lblk2
;

6946 ià(
Ën
 > 
couÁ
)

6947 
Ën
 = 
couÁ
;

6948 
lblk1
 +ğ
Ën
;

6949 
lblk2
 +ğ
Ën
;

6950 
couÁ
 -ğ
Ën
;

6951 
»³©
;

6955 ià(
e1_blk
 < 
lblk1
) {

6956 
¥l™
 = 1;

6957 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode1
,

6958 &
·th1
, 
lblk1
, 0);

6959 ià(
	`uÆik–y
(*
”p
))

6960 
fšish
;

6962 ià(
e2_blk
 < 
lblk2
) {

6963 
¥l™
 = 1;

6964 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode2
,

6965 &
·th2
, 
lblk2
, 0);

6966 ià(
	`uÆik–y
(*
”p
))

6967 
fšish
;

6971 ià(
¥l™
)

6972 
»³©
;

6975 
Ën
 = 
couÁ
;

6976 ià(
Ën
 > 
e1_blk
 + 
e1_Ën
 - 
lblk1
)

6977 
Ën
 = 
e1_blk
 + 
e1_Ën
 - 
lblk1
;

6978 ià(
Ën
 > 
e2_blk
 + 
e2_Ën
 - 
lblk2
)

6979 
Ën
 = 
e2_blk
 + 
e2_Ën
 - 
lblk2
;

6981 ià(
Ën
 !ğ
e1_Ën
) {

6982 
¥l™
 = 1;

6983 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode1
,

6984 &
·th1
, 
lblk1
 + 
Ën
, 0);

6985 ià(
	`uÆik–y
(*
”p
))

6986 
fšish
;

6988 ià(
Ën
 !ğ
e2_Ën
) {

6989 
¥l™
 = 1;

6990 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
šode2
,

6991 &
·th2
, 
lblk2
 + 
Ën
, 0);

6992 ià(*
”p
)

6993 
fšish
;

6997 ià(
¥l™
)

6998 
»³©
;

7000 
	`BUG_ON
(
e2_Ën
 !ğ
e1_Ën
);

7001 *
”p
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode1
, 
·th1
 +…©h1->
p_d•th
);

7002 ià(
	`uÆik–y
(*
”p
))

7003 
fšish
;

7004 *
”p
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
šode2
, 
·th2
 +…©h2->
p_d•th
);

7005 ià(
	`uÆik–y
(*
”p
))

7006 
fšish
;

7009 
tmp_ex
 = *
ex1
;

7010 
	`ext4_ext_¡Üe_pblock
(
ex1
, 
	`ext4_ext_pblock
(
ex2
));

7011 
	`ext4_ext_¡Üe_pblock
(
ex2
, 
	`ext4_ext_pblock
(&
tmp_ex
));

7012 
ex1
->
“_Ën
 = 
	`ıu_to_Ë16
(
e2_Ën
);

7013 
ex2
->
“_Ën
 = 
	`ıu_to_Ë16
(
e1_Ën
);

7014 ià(
unwr™‹n
)

7015 
	`ext4_ext_m¬k_unwr™‹n
(
ex2
);

7016 ià(
	`ext4_ext_is_unwr™‹n
(&
tmp_ex
))

7017 
	`ext4_ext_m¬k_unwr™‹n
(
ex1
);

7019 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode2
, 
·th2
, 
ex2
);

7020 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
šode1
, 
·th1
, 
ex1
);

7021 *
”p
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode2
, 
·th2
 +

7022 
·th2
->
p_d•th
);

7023 ià(
	`uÆik–y
(*
”p
))

7024 
fšish
;

7025 *
”p
 = 
	`ext4_ext_dœty
(
hªdË
, 
šode1
, 
·th1
 +

7026 
·th1
->
p_d•th
);

7033 ià(
	`uÆik–y
(*
”p
))

7034 
fšish
;

7035 
lblk1
 +ğ
Ën
;

7036 
lblk2
 +ğ
Ën
;

7037 
»¶aûd_couÁ
 +ğ
Ën
;

7038 
couÁ
 -ğ
Ën
;

7040 
»³©
:

7041 
	`ext4_ext_drİ_»fs
(
·th1
);

7042 
	`kä“
(
·th1
);

7043 
	`ext4_ext_drİ_»fs
(
·th2
);

7044 
	`kä“
(
·th2
);

7045 
·th1
 = 
·th2
 = 
NULL
;

7047  
»¶aûd_couÁ
;

7048 
	}
}

7069 
	$ext4_m‘a_sw­_ex‹Ás
(
hªdË_t
 *
hªdË
, 
šode
 *
»ûiv”_šode
,

7070 
šode
 *
dÚÜ_šode
, 
ext4_lblk_t
 
»c_lblk
,

7071 
ext4_lblk_t
 
dÚÜ_lblk
,

7072 
ext4_lblk_t
 
couÁ
, *
”p
)

7074 
ext4_ext_·th
 *
dÚÜ_·th
 = 
NULL
;

7075 
ext4_ext_·th
 *
»ûiv”_·th
 = 
NULL
;

7078 
»¶aûd_couÁ
 = 0;

7082 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
»ûiv”_šode
)->
i_d©a_£m
));

7083 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
dÚÜ_šode
)->
i_d©a_£m
));

7084 
	`BUG_ON
(!
	`šode_is_locked
(
»ûiv”_šode
));

7085 
	`BUG_ON
(!
	`šode_is_locked
(
dÚÜ_šode
));

7089 *
”p
 = 
	`ext4_es_»move_ex‹Á
(
»ûiv”_šode
, 
»c_lblk
, 
couÁ
);

7090 ià(
	`uÆik–y
(*
”p
)) {

7096 *
”p
 = 
	`ext4_es_»move_ex‹Á
(
dÚÜ_šode
, 
dÚÜ_lblk
, 
couÁ
);

7097 ià(
	`uÆik–y
(*
”p
)) {

7105 
couÁ
) {

7106 
ext4_ex‹Á
 *
dÚÜ_ex
, *
»c_ex
, 
tmp_ex
;

7107 
ext4_lblk_t
 
”_blk
, 
ed_blk
;

7108 
ed_Ën
, 
”_Ën
, 
Ën
;

7109 
¥l™
 = 0;

7113 
»ûiv”_·th
 = 
	`ext4_fšd_ex‹Á
(
»ûiv”_šode
, 
»c_lblk
, 
NULL
, 
EXT4_EX_NOCACHE
);

7114 ià(
	`IS_ERR
(
»ûiv”_·th
)) {

7115 *
”p
 = 
	`PTR_ERR
(
»ûiv”_·th
);

7116 
»ûiv”_·th
 = 
NULL
;

7118 
fšish
:

7119 
couÁ
 = 0;

7120 
»³©
;

7122 
dÚÜ_·th
 = 
	`ext4_fšd_ex‹Á
(
dÚÜ_šode
, 
dÚÜ_lblk
, 
NULL
, 
EXT4_EX_NOCACHE
);

7123 ià(
	`IS_ERR
(
dÚÜ_·th
)) {

7124 *
”p
 = 
	`PTR_ERR
(
dÚÜ_·th
);

7125 
dÚÜ_·th
 = 
NULL
;

7127 
fšish
;

7130 
»c_ex
 = 
»ûiv”_·th
[»ûiv”_·th->
p_d•th
].
p_ext
;

7131 
dÚÜ_ex
 = 
dÚÜ_·th
[dÚÜ_·th->
p_d•th
].
p_ext
;

7133 ià(
	`uÆik–y
(!
dÚÜ_ex
 || !
»c_ex
)) {

7135 
fšish
;

7138 
”_blk
 = 
	`Ë32_to_ıu
(
»c_ex
->
“_block
);

7139 
ed_blk
 = 
	`Ë32_to_ıu
(
dÚÜ_ex
->
“_block
);

7140 
”_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
»c_ex
);

7141 
ed_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
dÚÜ_ex
);

7148 ià(!
	`š_¿nge
(
»c_lblk
, 
”_blk
, 
”_Ën
) ||

7149 !
	`š_¿nge
(
dÚÜ_lblk
, 
ed_blk
, 
ed_Ën
)) {

7150 
ext4_lblk_t
 
Ãxt1
, 
Ãxt2
;

7153 
Ãxt1
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
»ûiv”_·th
);

7154 
Ãxt2
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
dÚÜ_·th
);

7156 ià(
”_blk
 > 
»c_lblk
)

7157 
Ãxt1
 = 
”_blk
;

7158 ià(
ed_blk
 > 
dÚÜ_lblk
)

7159 
Ãxt2
 = 
ed_blk
;

7161 ià(
Ãxt1
 =ğ
EXT_MAX_BLOCKS
 || 
Ãxt2
 == EXT_MAX_BLOCKS) {

7163 
fšish
;

7166 
Ën
 = 
Ãxt1
 - 
»c_lblk
;

7167 ià(
Ën
 < 
Ãxt2
 - 
dÚÜ_lblk
)

7168 
Ën
 = 
Ãxt2
 - 
dÚÜ_lblk
;

7169 ià(
Ën
 > 
couÁ
)

7170 
Ën
 = 
couÁ
;

7171 
»c_lblk
 +ğ
Ën
;

7172 
dÚÜ_lblk
 +ğ
Ën
;

7173 
couÁ
 -ğ
Ën
;

7175 
»³©
;

7179 ià(
”_blk
 < 
»c_lblk
) {

7180 
¥l™
 = 1;

7181 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
»ûiv”_šode
,

7182 &
»ûiv”_·th
, 
»c_lblk
, 0);

7183 ià(
	`uÆik–y
(*
”p
)) {

7185 
fšish
;

7188 ià(
ed_blk
 < 
dÚÜ_lblk
) {

7189 
¥l™
 = 1;

7190 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
dÚÜ_šode
,

7191 &
dÚÜ_·th
, 
dÚÜ_lblk
, 0);

7192 ià(
	`uÆik–y
(*
”p
)) {

7194 
fšish
;

7199 ià(
¥l™
) {

7201 
»³©
;

7211 
Ën
 = 
couÁ
;

7212 ià(
Ën
 > 
”_blk
 + 
”_Ën
 - 
»c_lblk
)

7213 
Ën
 = 
”_blk
 + 
”_Ën
 - 
»c_lblk
;

7214 ià(
Ën
 > 
ed_blk
 + 
ed_Ën
 - 
dÚÜ_lblk
)

7215 
Ën
 = 
ed_blk
 + 
ed_Ën
 - 
dÚÜ_lblk
;

7217 ià(
Ën
 !ğ
”_Ën
) {

7218 
¥l™
 = 1;

7219 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
»ûiv”_šode
, &
»ûiv”_·th
, 
»c_lblk
 + 
Ën
, 0);

7220 ià(
	`uÆik–y
(*
”p
)) {

7223 
fšish
;

7226 ià(
Ën
 !ğ
ed_Ën
) {

7227 
¥l™
 = 1;

7228 *
”p
 = 
	`ext4_fÜû_¥l™_ex‹Á_©
(
hªdË
, 
dÚÜ_šode
, &
dÚÜ_·th
, 
dÚÜ_lblk
 + 
Ën
, 0);

7229 ià(*
”p
) {

7232 
fšish
;

7237 ià(
¥l™
) {

7240 
»³©
;

7247 *
”p
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
»ûiv”_šode
, 
»ûiv”_·th
 +„eûiv”_·th->
p_d•th
);

7248 ià(
	`uÆik–y
(*
”p
)) {

7251 
fšish
;

7253 *
”p
 = 
	`ext4_ext_g‘_acûss
(
hªdË
, 
dÚÜ_šode
, 
dÚÜ_·th
 + dÚÜ_·th->
p_d•th
);

7254 ià(
	`uÆik–y
(*
”p
)) {

7257 
fšish
;

7261 
tmp_ex
 = *
»c_ex
;

7262 
	`ext4_ext_¡Üe_pblock
(
»c_ex
, 
	`ext4_ext_pblock
(
dÚÜ_ex
));

7263 
	`ext4_ext_¡Üe_pblock
(
dÚÜ_ex
, 
	`ext4_ext_pblock
(&
tmp_ex
));

7264 
»c_ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
ed_Ën
);

7265 
dÚÜ_ex
->
“_Ën
 = 
	`ıu_to_Ë16
(
”_Ën
);

7274 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
dÚÜ_šode
, 
dÚÜ_·th
, 
dÚÜ_ex
);

7275 
	`ext4_ext_Œy_to_m”ge
(
hªdË
, 
»ûiv”_šode
, 
»ûiv”_·th
, 
»c_ex
);

7276 *
”p
 = 
	`ext4_ext_dœty
(
hªdË
, 
dÚÜ_šode
, 
dÚÜ_·th
 +

7277 
dÚÜ_·th
->
p_d•th
);

7278 ià(
	`uÆik–y
(*
”p
)) {

7281 
fšish
;

7284 *
”p
 = 
	`ext4_ext_dœty
(
hªdË
, 
»ûiv”_šode
,

7285 
»ûiv”_·th
 +

7286 
»ûiv”_·th
->
p_d•th
);

7287 ià(
	`uÆik–y
(*
”p
)) {

7290 
fšish
;

7293 
dÚÜ_lblk
 +ğ
Ën
;

7294 
»c_lblk
 +ğ
Ën
;

7295 
»¶aûd_couÁ
 +ğ
Ën
;

7296 
couÁ
 -ğ
Ën
;

7303 
»³©
:

7304 
	`ext4_ext_drİ_»fs
(
»ûiv”_·th
);

7305 
	`kä“
(
»ûiv”_·th
);

7306 
	`ext4_ext_drİ_»fs
(
dÚÜ_·th
);

7307 
	`kä“
(
dÚÜ_·th
);

7308 
»ûiv”_·th
 = 
dÚÜ_·th
 = 
NULL
;

7312  
»¶aûd_couÁ
;

7313 
	}
}

	@extents_status.c

12 
	~<lšux/li¡_sÜt.h
>

13 
	~<lšux/´oc_fs.h
>

14 
	~<lšux/£q_fe.h
>

15 
	~"ext4.h
"

17 
	~<Œaû/ev’ts/ext4.h
>

143 
kmem_ÿche
 *
	gext4_es_ÿch•
;

145 
__es_š£¹_ex‹Á
(
šode
 *šode, 
ex‹Á_¡©us
 *
Ãwes
);

146 
__es_»move_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

147 
ext4_lblk_t
 
’d
);

148 
es_»şaim_ex‹Ás
(
ext4_šode_šfo
 *
ei
, *
Ä_to_sÿn
);

149 
__es_shršk
(
ext4_sb_šfo
 *
sbi
, 
Ä_to_sÿn
,

150 
ext4_šode_šfo
 *
locked_ei
);

152 
__š™
 
	$ext4_š™_es
()

154 
ext4_es_ÿch•
 = 
	`kmem_ÿche_ü—‹
("ext4_extent_status",

155 (
ex‹Á_¡©us
),

156 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

157 ià(
ext4_es_ÿch•
 =ğ
NULL
)

158  -
ENOMEM
;

160 
	}
}

162 
	$ext4_ex™_es
()

164 ià(
ext4_es_ÿch•
)

165 
	`kmem_ÿche_de¡roy
(
ext4_es_ÿch•
);

166 
	}
}

168 
	$ext4_es_š™_Œ“
(
ext4_es_Œ“
 *
Œ“
)

170 
Œ“
->
roÙ
 = 
RB_ROOT
;

171 
Œ“
->
ÿche_es
 = 
NULL
;

172 
	}
}

174 #ifdeà
ES_DEBUG__


175 
	$ext4_es_´št_Œ“
(
šode
 *inode)

177 
ext4_es_Œ“
 *
Œ“
;

178 
rb_node
 *
node
;

180 
	`´štk
(
KERN_DEBUG
 "¡©u ex‹Á fÜ inod%lu:", 
šode
->
i_šo
);

181 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

182 
node
 = 
	`rb_fœ¡
(&
Œ“
->
roÙ
);

183 
node
) {

184 
ex‹Á_¡©us
 *
es
;

185 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

186 
	`´štk
(
KERN_DEBUG
 " [%u/%u) %llu %x",

187 
es
->
es_lblk
,ƒs->
es_Ën
,

188 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

189 
node
 = 
	`rb_Ãxt
(node);

191 
	`´štk
(
KERN_DEBUG
 "\n");

192 
	}
}

194 
	#ext4_es_´št_Œ“
(
šode
)

	)

197 
šlše
 
ext4_lblk_t
 
	$ext4_es_’d
(
ex‹Á_¡©us
 *
es
)

199 
	`BUG_ON
(
es
->
es_lblk
 +ƒs->
es_Ën
 <ƒs->es_lblk);

200  
es
->
es_lblk
 +ƒs->
es_Ën
 - 1;

201 
	}
}

207 
ex‹Á_¡©us
 *
	$__es_Œ“_£¬ch
(
rb_roÙ
 *
roÙ
,

208 
ext4_lblk_t
 
lblk
)

210 
rb_node
 *
node
 = 
roÙ
->rb_node;

211 
ex‹Á_¡©us
 *
es
 = 
NULL
;

213 
node
) {

214 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

215 ià(
lblk
 < 
es
->
es_lblk
)

216 
node
 =‚ode->
rb_Ëá
;

217 ià(
lblk
 > 
	`ext4_es_’d
(
es
))

218 
node
 =‚ode->
rb_right
;

220  
es
;

223 ià(
es
 && 
lblk
 <ƒs->
es_lblk
)

224  
es
;

226 ià(
es
 && 
lblk
 > 
	`ext4_es_’d
(es)) {

227 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

228  
node
 ? 
	`rb_’Œy
Òode, 
ex‹Á_¡©us
, 
rb_node
) :

229 
NULL
;

232  
NULL
;

233 
	}
}

244 
	$ext4_es_fšd_d–ayed_ex‹Á_¿nge
(
šode
 *inode,

245 
ext4_lblk_t
 
lblk
,ƒxt4_lblk_ˆ
’d
,

246 
ex‹Á_¡©us
 *
es
)

248 
ext4_es_Œ“
 *
Œ“
 = 
NULL
;

249 
ex‹Á_¡©us
 *
es1
 = 
NULL
;

250 
rb_node
 *
node
;

252 
	`BUG_ON
(
es
 =ğ
NULL
);

253 
	`BUG_ON
(
’d
 < 
lblk
);

254 
	`Œaû_ext4_es_fšd_d–ayed_ex‹Á_¿nge_’‹r
(
šode
, 
lblk
);

256 
	`»ad_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

257 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

260 
es
->
es_lblk
 =ƒs->
es_Ën
 =ƒs->
es_pblk
 = 0;

261 ià(
Œ“
->
ÿche_es
) {

262 
es1
 = 
Œ“
->
ÿche_es
;

263 ià(
	`š_¿nge
(
lblk
, 
es1
->
es_lblk
,ƒs1->
es_Ën
)) {

264 
	`es_debug
("%u cached by [%u/%u) %llu %x\n",

265 
lblk
, 
es1
->
es_lblk
,ƒs1->
es_Ën
,

266 
	`ext4_es_pblock
(
es1
), 
	`ext4_es_¡©us
(es1));

267 
out
;

271 
es1
 = 
	`__es_Œ“_£¬ch
(&
Œ“
->
roÙ
, 
lblk
);

273 
out
:

274 ià(
es1
 && !
	`ext4_es_is_d–ayed
(es1)) {

275 (
node
 = 
	`rb_Ãxt
(&
es1
->
rb_node
)è!ğ
NULL
) {

276 
es1
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

277 ià(
es1
->
es_lblk
 > 
’d
) {

278 
es1
 = 
NULL
;

281 ià(
	`ext4_es_is_d–ayed
(
es1
))

286 ià(
es1
 && 
	`ext4_es_is_d–ayed
(es1)) {

287 
Œ“
->
ÿche_es
 = 
es1
;

288 
es
->
es_lblk
 = 
es1
->es_lblk;

289 
es
->
es_Ën
 = 
es1
->es_len;

290 
es
->
es_pblk
 = 
es1
->es_pblk;

293 
	`»ad_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

295 
	`Œaû_ext4_es_fšd_d–ayed_ex‹Á_¿nge_ex™
(
šode
, 
es
);

296 
	}
}

298 
	$ext4_es_li¡_add
(
šode
 *inode)

300 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

301 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

303 ià(!
	`li¡_em±y
(&
ei
->
i_es_li¡
))

306 
	`¥š_lock
(&
sbi
->
s_es_lock
);

307 ià(
	`li¡_em±y
(&
ei
->
i_es_li¡
)) {

308 
	`li¡_add_
(&
ei
->
i_es_li¡
, &
sbi
->
s_es_li¡
);

309 
sbi
->
s_es_Ä_šode
++;

311 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

312 
	}
}

314 
	$ext4_es_li¡_d–
(
šode
 *inode)

316 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

317 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

319 
	`¥š_lock
(&
sbi
->
s_es_lock
);

320 ià(!
	`li¡_em±y
(&
ei
->
i_es_li¡
)) {

321 
	`li¡_d–_š™
(&
ei
->
i_es_li¡
);

322 
sbi
->
s_es_Ä_šode
--;

323 
	`WARN_ON_ONCE
(
sbi
->
s_es_Ä_šode
 < 0);

325 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

326 
	}
}

328 
ex‹Á_¡©us
 *

329 
	$ext4_es_®loc_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,ƒxt4_lblk_ˆ
Ën
,

330 
ext4_fsblk_t
 
pblk
)

332 
ex‹Á_¡©us
 *
es
;

333 
es
 = 
	`kmem_ÿche_®loc
(
ext4_es_ÿch•
, 
GFP_ATOMIC
);

334 ià(
es
 =ğ
NULL
)

335  
NULL
;

336 
es
->
es_lblk
 = 
lblk
;

337 
es
->
es_Ën
 = 
Ën
;

338 
es
->
es_pblk
 = 
pblk
;

343 ià(!
	`ext4_es_is_d–ayed
(
es
)) {

344 ià(!
	`EXT4_I
(
šode
)->
i_es_shk_Ä
++)

345 
	`ext4_es_li¡_add
(
šode
);

346 
	`³rıu_couÁ”_šc
(&
	`EXT4_SB
(
šode
->
i_sb
)->

347 
s_es_¡©s
.
es_¡©s_shk_út
);

350 
	`EXT4_I
(
šode
)->
i_es_®l_Ä
++;

351 
	`³rıu_couÁ”_šc
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_es_¡©s
.
es_¡©s_®l_út
);

353  
es
;

354 
	}
}

356 
	$ext4_es_ä“_ex‹Á
(
šode
 *šode, 
ex‹Á_¡©us
 *
es
)

358 
	`EXT4_I
(
šode
)->
i_es_®l_Ä
--;

359 
	`³rıu_couÁ”_dec
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_es_¡©s
.
es_¡©s_®l_út
);

362 ià(!
	`ext4_es_is_d–ayed
(
es
)) {

363 
	`BUG_ON
(
	`EXT4_I
(
šode
)->
i_es_shk_Ä
 == 0);

364 ià(!--
	`EXT4_I
(
šode
)->
i_es_shk_Ä
)

365 
	`ext4_es_li¡_d–
(
šode
);

366 
	`³rıu_couÁ”_dec
(&
	`EXT4_SB
(
šode
->
i_sb
)->

367 
s_es_¡©s
.
es_¡©s_shk_út
);

370 
	`kmem_ÿche_ä“
(
ext4_es_ÿch•
, 
es
);

371 
	}
}

380 
	$ext4_es_ÿn_be_m”ged
(
ex‹Á_¡©us
 *
es1
,

381 
ex‹Á_¡©us
 *
es2
)

383 ià(
	`ext4_es_ty³
(
es1
è!ğext4_es_ty³(
es2
))

386 ià(((
__u64
è
es1
->
es_Ën
è+ 
es2
->es_ËÀ> 
EXT_MAX_BLOCKS
) {

387 
	`´_w¬n
("ES‡ssertion failed when mergingƒxtents. "

390 
es1
->
es_Ën
, 
es2
->es_Ën, 
EXT_MAX_BLOCKS
);

391 
	`WARN_ON
(1);

395 ià(((
__u64
è
es1
->
es_lblk
è+ƒs1->
es_Ën
 !ğ
es2
->es_lblk)

398 ià((
	`ext4_es_is_wr™‹n
(
es1
è|| 
	`ext4_es_is_unwr™‹n
(es1)) &&

399 (
	`ext4_es_pblock
(
es1
è+ƒs1->
es_Ën
 =ğext4_es_pblock(
es2
)))

402 ià(
	`ext4_es_is_hŞe
(
es1
))

406 ià(
	`ext4_es_is_d–ayed
(
es1
è&& !
	`ext4_es_is_unwr™‹n
(es1))

410 
	}
}

412 
ex‹Á_¡©us
 *

413 
	$ext4_es_Œy_to_m”ge_Ëá
(
šode
 *šode, 
ex‹Á_¡©us
 *
es
)

415 
ext4_es_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

416 
ex‹Á_¡©us
 *
es1
;

417 
rb_node
 *
node
;

419 
node
 = 
	`rb_´ev
(&
es
->
rb_node
);

420 ià(!
node
)

421  
es
;

423 
es1
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

424 ià(
	`ext4_es_ÿn_be_m”ged
(
es1
, 
es
)) {

425 
es1
->
es_Ën
 +ğ
es
->es_len;

426 ià(
	`ext4_es_is_»ã»nûd
(
es
))

427 
	`ext4_es_£t_»ã»nûd
(
es1
);

428 
	`rb_”a£
(&
es
->
rb_node
, &
Œ“
->
roÙ
);

429 
	`ext4_es_ä“_ex‹Á
(
šode
, 
es
);

430 
es
 = 
es1
;

433  
es
;

434 
	}
}

436 
ex‹Á_¡©us
 *

437 
	$ext4_es_Œy_to_m”ge_right
(
šode
 *šode, 
ex‹Á_¡©us
 *
es
)

439 
ext4_es_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

440 
ex‹Á_¡©us
 *
es1
;

441 
rb_node
 *
node
;

443 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

444 ià(!
node
)

445  
es
;

447 
es1
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

448 ià(
	`ext4_es_ÿn_be_m”ged
(
es
, 
es1
)) {

449 
es
->
es_Ën
 +ğ
es1
->es_len;

450 ià(
	`ext4_es_is_»ã»nûd
(
es1
))

451 
	`ext4_es_£t_»ã»nûd
(
es
);

452 
	`rb_”a£
(
node
, &
Œ“
->
roÙ
);

453 
	`ext4_es_ä“_ex‹Á
(
šode
, 
es1
);

456  
es
;

457 
	}
}

459 #ifdeà
ES_AGGRESSIVE_TEST


460 
	~"ext4_ex‹Ás.h
"

462 
	$ext4_es_š£¹_ex‹Á_ext_check
(
šode
 *inode,

463 
ex‹Á_¡©us
 *
es
)

465 
ext4_ext_·th
 *
·th
 = 
NULL
;

466 
ext4_ex‹Á
 *
ex
;

467 
ext4_lblk_t
 
“_block
;

468 
ext4_fsblk_t
 
“_¡¬t
;

469 
“_Ën
;

470 
d•th
, 
“_¡©us
, 
es_¡©us
;

472 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
es
->
es_lblk
, 
NULL
, 
EXT4_EX_NOCACHE
);

473 ià(
	`IS_ERR
(
·th
))

476 
d•th
 = 
	`ext_d•th
(
šode
);

477 
ex
 = 
·th
[
d•th
].
p_ext
;

479 ià(
ex
) {

481 
“_block
 = 
	`Ë32_to_ıu
(
ex
->ee_block);

482 
“_¡¬t
 = 
	`ext4_ext_pblock
(
ex
);

483 
“_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

485 
“_¡©us
 = 
	`ext4_ext_is_unwr™‹n
(
ex
) ? 1 : 0;

486 
es_¡©us
 = 
	`ext4_es_is_unwr™‹n
(
es
) ? 1 : 0;

492 ià(!
	`ext4_es_is_wr™‹n
(
es
è&& !
	`ext4_es_is_unwr™‹n
(es)) {

493 ià(
	`š_¿nge
(
es
->
es_lblk
, 
“_block
, 
“_Ën
)) {

494 
	`´_w¬n
("ES insert‡ssertion failed for "

499 
šode
->
i_šo
, 
“_block
, 
“_Ën
,

500 
“_¡¬t
, 
“_¡©us
 ? 'u' : 'w',

501 
es
->
es_lblk
,ƒs->
es_Ën
,

502 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

504 
out
;

511 ià(
es
->
es_lblk
 < 
“_block
 ||

512 
	`ext4_es_pblock
(
es
è!ğ
“_¡¬t
 +ƒs->
es_lblk
 - 
“_block
) {

513 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

515 "es_¡©u [%d/%d/%Îu/%c]\n", 
šode
->
i_šo
,

516 
“_block
, 
“_Ën
, 
“_¡¬t
,

517 
“_¡©us
 ? 'u' : 'w', 
es
->
es_lblk
,ƒs->
es_Ën
,

518 
	`ext4_es_pblock
(
es
), 
es_¡©us
 ? 'u' : 'w');

519 
out
;

522 ià(
“_¡©us
 ^ 
es_¡©us
) {

523 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

525 "es_¡©u [%d/%d/%Îu/%c]\n", 
šode
->
i_šo
,

526 
“_block
, 
“_Ën
, 
“_¡¬t
,

527 
“_¡©us
 ? 'u' : 'w', 
es
->
es_lblk
,ƒs->
es_Ën
,

528 
	`ext4_es_pblock
(
es
), 
es_¡©us
 ? 'u' : 'w');

535 ià(!
	`ext4_es_is_d–ayed
(
es
è&& !
	`ext4_es_is_hŞe
(es)) {

536 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

539 "[%d/%d/%Îu/%x]\n", 
šode
->
i_šo
,

540 
es
->
es_lblk
,ƒs->es_lblk,ƒs->
es_Ën
,

541 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

544 
out
:

545 
	`ext4_ext_drİ_»fs
(
·th
);

546 
	`kä“
(
·th
);

547 
	}
}

549 
	$ext4_es_š£¹_ex‹Á_šd_check
(
šode
 *inode,

550 
ex‹Á_¡©us
 *
es
)

552 
ext4_m­_blocks
 
m­
;

553 
»tv®
;

562 
m­
.
m_lblk
 = 
es
->
es_lblk
;

563 
m­
.
m_Ën
 = 
es
->
es_Ën
;

565 
»tv®
 = 
	`ext4_šd_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

566 ià(
»tv®
 > 0) {

567 ià(
	`ext4_es_is_d–ayed
(
es
è|| 
	`ext4_es_is_hŞe
(es)) {

572 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

575 
šode
->
i_šo
, 
es
->
es_lblk
,ƒs->
es_Ën
,

576 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

578 } ià(
	`ext4_es_is_wr™‹n
(
es
)) {

579 ià(
»tv®
 !ğ
es
->
es_Ën
) {

580 
	`´_w¬n
("ES insert‡ssertion failed for "

582 
šode
->
i_šo
, 
»tv®
, 
es
->
es_Ën
);

585 ià(
m­
.
m_pblk
 !ğ
	`ext4_es_pblock
(
es
)) {

586 
	`´_w¬n
("ES insert‡ssertion failed for "

589 
šode
->
i_šo
, 
m­
.
m_pblk
,

590 
	`ext4_es_pblock
(
es
));

598 
	`BUG_ON
(1);

600 } ià(
»tv®
 == 0) {

601 ià(
	`ext4_es_is_wr™‹n
(
es
)) {

602 
	`´_w¬n
("ES insert‡ssertion failed for inode: %lu "

605 
šode
->
i_šo
, 
es
->
es_lblk
,ƒs->
es_Ën
,

606 
	`ext4_es_pblock
(
es
), 
	`ext4_es_¡©us
(es));

610 
	}
}

612 
šlše
 
	$ext4_es_š£¹_ex‹Á_check
(
šode
 *inode,

613 
ex‹Á_¡©us
 *
es
)

619 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

620 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

621 
	`ext4_es_š£¹_ex‹Á_ext_check
(
šode
, 
es
);

623 
	`ext4_es_š£¹_ex‹Á_šd_check
(
šode
, 
es
);

624 
	}
}

626 
šlše
 
	$ext4_es_š£¹_ex‹Á_check
(
šode
 *inode,

627 
ex‹Á_¡©us
 *
es
)

629 
	}
}

632 
	$__es_š£¹_ex‹Á
(
šode
 *šode, 
ex‹Á_¡©us
 *
Ãwes
)

634 
ext4_es_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

635 
rb_node
 **
p
 = &
Œ“
->
roÙ
.rb_node;

636 
rb_node
 *
·»Á
 = 
NULL
;

637 
ex‹Á_¡©us
 *
es
;

639 *
p
) {

640 
·»Á
 = *
p
;

641 
es
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_¡©us
, 
rb_node
);

643 ià(
Ãwes
->
es_lblk
 < 
es
->es_lblk) {

644 ià(
	`ext4_es_ÿn_be_m”ged
(
Ãwes
, 
es
)) {

649 
es
->
es_lblk
 = 
Ãwes
->es_lblk;

650 
es
->
es_Ën
 +ğ
Ãwes
->es_len;

651 ià(
	`ext4_es_is_wr™‹n
(
es
) ||

652 
	`ext4_es_is_unwr™‹n
(
es
))

653 
	`ext4_es_¡Üe_pblock
(
es
,

654 
Ãwes
->
es_pblk
);

655 
es
 = 
	`ext4_es_Œy_to_m”ge_Ëá
(
šode
,ƒs);

656 
out
;

658 
p
 = &(*p)->
rb_Ëá
;

659 } ià(
Ãwes
->
es_lblk
 > 
	`ext4_es_’d
(
es
)) {

660 ià(
	`ext4_es_ÿn_be_m”ged
(
es
, 
Ãwes
)) {

661 
es
->
es_Ën
 +ğ
Ãwes
->es_len;

662 
es
 = 
	`ext4_es_Œy_to_m”ge_right
(
šode
,ƒs);

663 
out
;

665 
p
 = &(*p)->
rb_right
;

667 
	`BUG_ON
(1);

668  -
EINVAL
;

672 
es
 = 
	`ext4_es_®loc_ex‹Á
(
šode
, 
Ãwes
->
es_lblk
,‚ewes->
es_Ën
,

673 
Ãwes
->
es_pblk
);

674 ià(!
es
)

675  -
ENOMEM
;

676 
	`rb_lšk_node
(&
es
->
rb_node
, 
·»Á
, 
p
);

677 
	`rb_š£¹_cŞÜ
(&
es
->
rb_node
, &
Œ“
->
roÙ
);

679 
out
:

680 
Œ“
->
ÿche_es
 = 
es
;

682 
	}
}

690 
	$ext4_es_š£¹_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

691 
ext4_lblk_t
 
Ën
, 
ext4_fsblk_t
 
pblk
,

692 
¡©us
)

694 
ex‹Á_¡©us
 
Ãwes
;

695 
ext4_lblk_t
 
’d
 = 
lblk
 + 
Ën
 - 1;

696 
”r
 = 0;

698 
	`es_debug
("add [%u/%u) %llu %xoƒxtent statusree of inode %lu\n",

699 
lblk
, 
Ën
, 
pblk
, 
¡©us
, 
šode
->
i_šo
);

701 ià(!
Ën
)

704 
	`BUG_ON
(
’d
 < 
lblk
);

706 ià((
¡©us
 & 
EXTENT_STATUS_DELAYED
) &&

707 (
¡©us
 & 
EXTENT_STATUS_WRITTEN
)) {

708 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Insertingƒxtent [%u/%u]‡s "

710 " cau£ d©¨loss.", 
lblk
, 
Ën
);

711 
	`WARN_ON
(1);

714 
Ãwes
.
es_lblk
 = 
lblk
;

715 
Ãwes
.
es_Ën
 = 
Ën
;

716 
	`ext4_es_¡Üe_pblock_¡©us
(&
Ãwes
, 
pblk
, 
¡©us
);

717 
	`Œaû_ext4_es_š£¹_ex‹Á
(
šode
, &
Ãwes
);

719 
	`ext4_es_š£¹_ex‹Á_check
(
šode
, &
Ãwes
);

721 
	`wr™e_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

722 
”r
 = 
	`__es_»move_ex‹Á
(
šode
, 
lblk
, 
’d
);

723 ià(
”r
 != 0)

724 
”rÜ
;

725 
»Œy
:

726 
”r
 = 
	`__es_š£¹_ex‹Á
(
šode
, &
Ãwes
);

727 ià(
”r
 =ğ-
ENOMEM
 && 
	`__es_shršk
(
	`EXT4_SB
(
šode
->
i_sb
),

728 128, 
	`EXT4_I
(
šode
)))

729 
»Œy
;

730 ià(
”r
 =ğ-
ENOMEM
 && !
	`ext4_es_is_d–ayed
(&
Ãwes
))

731 
”r
 = 0;

733 
”rÜ
:

734 
	`wr™e_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

736 
	`ext4_es_´št_Œ“
(
šode
);

738  
”r
;

739 
	}
}

746 
	$ext4_es_ÿche_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

747 
ext4_lblk_t
 
Ën
, 
ext4_fsblk_t
 
pblk
,

748 
¡©us
)

750 
ex‹Á_¡©us
 *
es
;

751 
ex‹Á_¡©us
 
Ãwes
;

752 
ext4_lblk_t
 
’d
 = 
lblk
 + 
Ën
 - 1;

754 
Ãwes
.
es_lblk
 = 
lblk
;

755 
Ãwes
.
es_Ën
 = 
Ën
;

756 
	`ext4_es_¡Üe_pblock_¡©us
(&
Ãwes
, 
pblk
, 
¡©us
);

757 
	`Œaû_ext4_es_ÿche_ex‹Á
(
šode
, &
Ãwes
);

759 ià(!
Ën
)

762 
	`BUG_ON
(
’d
 < 
lblk
);

764 
	`wr™e_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

766 
es
 = 
	`__es_Œ“_£¬ch
(&
	`EXT4_I
(
šode
)->
i_es_Œ“
.
roÙ
, 
lblk
);

767 ià(!
es
 ||ƒs->
es_lblk
 > 
’d
)

768 
	`__es_š£¹_ex‹Á
(
šode
, &
Ãwes
);

769 
	`wr™e_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

770 
	}
}

779 
	$ext4_es_lookup_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

780 
ex‹Á_¡©us
 *
es
)

782 
ext4_es_Œ“
 *
Œ“
;

783 
ext4_es_¡©s
 *
¡©s
;

784 
ex‹Á_¡©us
 *
es1
 = 
NULL
;

785 
rb_node
 *
node
;

786 
found
 = 0;

788 
	`Œaû_ext4_es_lookup_ex‹Á_’‹r
(
šode
, 
lblk
);

789 
	`es_debug
("looku°ex‹Á iÀblock %u\n", 
lblk
);

791 
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

792 
	`»ad_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

795 
es
->
es_lblk
 =ƒs->
es_Ën
 =ƒs->
es_pblk
 = 0;

796 ià(
Œ“
->
ÿche_es
) {

797 
es1
 = 
Œ“
->
ÿche_es
;

798 ià(
	`š_¿nge
(
lblk
, 
es1
->
es_lblk
,ƒs1->
es_Ën
)) {

799 
	`es_debug
("%u cached by [%u/%u)\n",

800 
lblk
, 
es1
->
es_lblk
,ƒs1->
es_Ën
);

801 
found
 = 1;

802 
out
;

806 
node
 = 
Œ“
->
roÙ
.
rb_node
;

807 
node
) {

808 
es1
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

809 ià(
lblk
 < 
es1
->
es_lblk
)

810 
node
 =‚ode->
rb_Ëá
;

811 ià(
lblk
 > 
	`ext4_es_’d
(
es1
))

812 
node
 =‚ode->
rb_right
;

814 
found
 = 1;

819 
out
:

820 
¡©s
 = &
	`EXT4_SB
(
šode
->
i_sb
)->
s_es_¡©s
;

821 ià(
found
) {

822 
	`BUG_ON
(!
es1
);

823 
es
->
es_lblk
 = 
es1
->es_lblk;

824 
es
->
es_Ën
 = 
es1
->es_len;

825 
es
->
es_pblk
 = 
es1
->es_pblk;

826 ià(!
	`ext4_es_is_»ã»nûd
(
es1
))

827 
	`ext4_es_£t_»ã»nûd
(
es1
);

828 
¡©s
->
es_¡©s_ÿche_h™s
++;

830 
¡©s
->
es_¡©s_ÿche_mis£s
++;

833 
	`»ad_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

835 
	`Œaû_ext4_es_lookup_ex‹Á_ex™
(
šode
, 
es
, 
found
);

837  
found
;

838 
	}
}

840 
	$__es_»move_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

841 
ext4_lblk_t
 
’d
)

843 
ext4_es_Œ“
 *
Œ“
 = &
	`EXT4_I
(
šode
)->
i_es_Œ“
;

844 
rb_node
 *
node
;

845 
ex‹Á_¡©us
 *
es
;

846 
ex‹Á_¡©us
 
Üig_es
;

847 
ext4_lblk_t
 
Ën1
, 
Ën2
;

848 
ext4_fsblk_t
 
block
;

849 
”r
;

851 
»Œy
:

852 
”r
 = 0;

853 
es
 = 
	`__es_Œ“_£¬ch
(&
Œ“
->
roÙ
, 
lblk
);

854 ià(!
es
)

855 
out
;

856 ià(
es
->
es_lblk
 > 
’d
)

857 
out
;

860 
Œ“
->
ÿche_es
 = 
NULL
;

862 
Üig_es
.
es_lblk
 = 
es
->es_lblk;

863 
Üig_es
.
es_Ën
 = 
es
->es_len;

864 
Üig_es
.
es_pblk
 = 
es
->es_pblk;

866 
Ën1
 = 
lblk
 > 
es
->
es_lblk
 ?†blk -ƒs->es_lblk : 0;

867 
Ën2
 = 
	`ext4_es_’d
(
es
è> 
’d
 ?ƒxt4_es_end(es) -ƒnd : 0;

868 ià(
Ën1
 > 0)

869 
es
->
es_Ën
 = 
Ën1
;

870 ià(
Ën2
 > 0) {

871 ià(
Ën1
 > 0) {

872 
ex‹Á_¡©us
 
Ãwes
;

874 
Ãwes
.
es_lblk
 = 
’d
 + 1;

875 
Ãwes
.
es_Ën
 = 
Ën2
;

876 
block
 = 0x7FDEADBEEFULL;

877 ià(
	`ext4_es_is_wr™‹n
(&
Üig_es
) ||

878 
	`ext4_es_is_unwr™‹n
(&
Üig_es
))

879 
block
 = 
	`ext4_es_pblock
(&
Üig_es
) +

880 
Üig_es
.
es_Ën
 - 
Ën2
;

881 
	`ext4_es_¡Üe_pblock_¡©us
(&
Ãwes
, 
block
,

882 
	`ext4_es_¡©us
(&
Üig_es
));

883 
”r
 = 
	`__es_š£¹_ex‹Á
(
šode
, &
Ãwes
);

884 ià(
”r
) {

885 
es
->
es_lblk
 = 
Üig_es
.es_lblk;

886 
es
->
es_Ën
 = 
Üig_es
.es_len;

887 ià((
”r
 =ğ-
ENOMEM
) &&

888 
	`__es_shršk
(
	`EXT4_SB
(
šode
->
i_sb
),

889 128, 
	`EXT4_I
(
šode
)))

890 
»Œy
;

891 
out
;

894 
es
->
es_lblk
 = 
’d
 + 1;

895 
es
->
es_Ën
 = 
Ën2
;

896 ià(
	`ext4_es_is_wr™‹n
(
es
) ||

897 
	`ext4_es_is_unwr™‹n
(
es
)) {

898 
block
 = 
Üig_es
.
es_pblk
 + orig_es.
es_Ën
 - 
Ën2
;

899 
	`ext4_es_¡Üe_pblock
(
es
, 
block
);

902 
out
;

905 ià(
Ën1
 > 0) {

906 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

907 ià(
node
)

908 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

910 
es
 = 
NULL
;

913 
es
 && 
	`ext4_es_’d
Ósè<ğ
’d
) {

914 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

915 
	`rb_”a£
(&
es
->
rb_node
, &
Œ“
->
roÙ
);

916 
	`ext4_es_ä“_ex‹Á
(
šode
, 
es
);

917 ià(!
node
) {

918 
es
 = 
NULL
;

921 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

924 ià(
es
 &&ƒs->
es_lblk
 < 
’d
 + 1) {

925 
ext4_lblk_t
 
Üig_Ën
 = 
es
->
es_Ën
;

927 
Ën1
 = 
	`ext4_es_’d
(
es
è- 
’d
;

928 
es
->
es_lblk
 = 
’d
 + 1;

929 
es
->
es_Ën
 = 
Ën1
;

930 ià(
	`ext4_es_is_wr™‹n
(
es
è|| 
	`ext4_es_is_unwr™‹n
(es)) {

931 
block
 = 
es
->
es_pblk
 + 
Üig_Ën
 - 
Ën1
;

932 
	`ext4_es_¡Üe_pblock
(
es
, 
block
);

936 
out
:

937  
”r
;

938 
	}
}

945 
	$ext4_es_»move_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

946 
ext4_lblk_t
 
Ën
)

948 
ext4_lblk_t
 
’d
;

949 
”r
 = 0;

951 
	`Œaû_ext4_es_»move_ex‹Á
(
šode
, 
lblk
, 
Ën
);

952 
	`es_debug
("remove [%u/%u) fromƒxtent statusree of inode %lu\n",

953 
lblk
, 
Ën
, 
šode
->
i_šo
);

955 ià(!
Ën
)

956  
”r
;

958 
’d
 = 
lblk
 + 
Ën
 - 1;

959 
	`BUG_ON
(
’d
 < 
lblk
);

966 
	`wr™e_lock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

967 
”r
 = 
	`__es_»move_ex‹Á
(
šode
, 
lblk
, 
’d
);

968 
	`wr™e_uÆock
(&
	`EXT4_I
(
šode
)->
i_es_lock
);

969 
	`ext4_es_´št_Œ“
(
šode
);

970  
”r
;

971 
	}
}

973 
	$__es_shršk
(
ext4_sb_šfo
 *
sbi
, 
Ä_to_sÿn
,

974 
ext4_šode_šfo
 *
locked_ei
)

976 
ext4_šode_šfo
 *
ei
;

977 
ext4_es_¡©s
 *
es_¡©s
;

978 
ktime_t
 
¡¬t_time
;

979 
u64
 
sÿn_time
;

980 
Ä_to_w®k
;

981 
Ä_shrunk
 = 0;

982 
»Œ›d
 = 0, 
Ä_sk³d
 = 0;

984 
es_¡©s
 = &
sbi
->
s_es_¡©s
;

985 
¡¬t_time
 = 
	`ktime_g‘
();

987 
»Œy
:

988 
	`¥š_lock
(&
sbi
->
s_es_lock
);

989 
Ä_to_w®k
 = 
sbi
->
s_es_Ä_šode
;

990 
Ä_to_w®k
-- > 0) {

991 ià(
	`li¡_em±y
(&
sbi
->
s_es_li¡
)) {

992 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

993 
out
;

995 
ei
 = 
	`li¡_fœ¡_’Œy
(&
sbi
->
s_es_li¡
, 
ext4_šode_šfo
,

996 
i_es_li¡
);

998 
	`li¡_move_
(&
ei
->
i_es_li¡
, &
sbi
->
s_es_li¡
);

1004 ià(!
»Œ›d
 && 
	`ext4_‹¡_šode_¡©e
(&
ei
->
vfs_šode
,

1005 
EXT4_STATE_EXT_PRECACHED
)) {

1006 
Ä_sk³d
++;

1010 ià(
ei
 =ğ
locked_ei
 || !
	`wr™e_Œylock
(&ei->
i_es_lock
)) {

1011 
Ä_sk³d
++;

1018 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

1020 
Ä_shrunk
 +ğ
	`es_»şaim_ex‹Ás
(
ei
, &
Ä_to_sÿn
);

1021 
	`wr™e_uÆock
(&
ei
->
i_es_lock
);

1023 ià(
Ä_to_sÿn
 <= 0)

1024 
out
;

1025 
	`¥š_lock
(&
sbi
->
s_es_lock
);

1027 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

1033 ià((
Ä_shrunk
 =ğ0è&& 
Ä_sk³d
 && !
»Œ›d
) {

1034 
»Œ›d
++;

1035 
»Œy
;

1038 ià(
locked_ei
 && 
Ä_shrunk
 == 0)

1039 
Ä_shrunk
 = 
	`es_»şaim_ex‹Ás
(
locked_ei
, &
Ä_to_sÿn
);

1041 
out
:

1042 
sÿn_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(), 
¡¬t_time
));

1043 ià(
	`lik–y
(
es_¡©s
->
es_¡©s_sÿn_time
))

1044 
es_¡©s
->
es_¡©s_sÿn_time
 = (
sÿn_time
 +

1045 
es_¡©s
->
es_¡©s_sÿn_time
*3) / 4;

1047 
es_¡©s
->
es_¡©s_sÿn_time
 = 
sÿn_time
;

1048 ià(
sÿn_time
 > 
es_¡©s
->
es_¡©s_max_sÿn_time
)

1049 
es_¡©s
->
es_¡©s_max_sÿn_time
 = 
sÿn_time
;

1050 ià(
	`lik–y
(
es_¡©s
->
es_¡©s_shrunk
))

1051 
es_¡©s
->
es_¡©s_shrunk
 = (
Ä_shrunk
 +

1052 
es_¡©s
->
es_¡©s_shrunk
*3) / 4;

1054 
es_¡©s
->
es_¡©s_shrunk
 = 
Ä_shrunk
;

1056 
	`Œaû_ext4_es_shršk
(
sbi
->
s_sb
, 
Ä_shrunk
, 
sÿn_time
,

1057 
Ä_sk³d
, 
»Œ›d
);

1058  
Ä_shrunk
;

1059 
	}
}

1061 
	$ext4_es_couÁ
(
shršk”
 *
shršk
,

1062 
shršk_cÚŒŞ
 *
sc
)

1064 
Ä
;

1065 
ext4_sb_šfo
 *
sbi
;

1067 
sbi
 = 
	`cÚš”_of
(
shršk
, 
ext4_sb_šfo
, 
s_es_shršk”
);

1068 
Ä
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
);

1069 
	`Œaû_ext4_es_shršk_couÁ
(
sbi
->
s_sb
, 
sc
->
Ä_to_sÿn
, 
Ä
);

1070  
Ä
;

1071 
	}
}

1073 
	$ext4_es_sÿn
(
shršk”
 *
shršk
,

1074 
shršk_cÚŒŞ
 *
sc
)

1076 
ext4_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
shršk
,

1077 
ext4_sb_šfo
, 
s_es_shršk”
);

1078 
Ä_to_sÿn
 = 
sc
->nr_to_scan;

1079 
»t
, 
Ä_shrunk
;

1081 
»t
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
);

1082 
	`Œaû_ext4_es_shršk_sÿn_’‹r
(
sbi
->
s_sb
, 
Ä_to_sÿn
, 
»t
);

1084 ià(!
Ä_to_sÿn
)

1085  
»t
;

1087 
Ä_shrunk
 = 
	`__es_shršk
(
sbi
, 
Ä_to_sÿn
, 
NULL
);

1089 
	`Œaû_ext4_es_shršk_sÿn_ex™
(
sbi
->
s_sb
, 
Ä_shrunk
, 
»t
);

1090  
Ä_shrunk
;

1091 
	}
}

1093 
	$ext4_£q_es_shršk”_šfo_show
(
£q_fe
 *
£q
, *
v
)

1095 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
((
su³r_block
 *è
£q
->
´iv©e
);

1096 
ext4_es_¡©s
 *
es_¡©s
 = &
sbi
->
s_es_¡©s
;

1097 
ext4_šode_šfo
 *
ei
, *
max
 = 
NULL
;

1098 
šode_út
 = 0;

1100 ià(
v
 !ğ
SEQ_START_TOKEN
)

1104 
	`¥š_lock
(&
sbi
->
s_es_lock
);

1105 
	`li¡_fÜ_—ch_’Œy
(
ei
, &
sbi
->
s_es_li¡
, 
i_es_li¡
) {

1106 
šode_út
++;

1107 ià(
max
 && max->
i_es_®l_Ä
 < 
ei
->i_es_all_nr)

1108 
max
 = 
ei
;

1109 ià(!
max
)

1110 
max
 = 
ei
;

1112 
	`¥š_uÆock
(&
sbi
->
s_es_lock
);

1114 
	`£q_´štf
(
£q
, "stats:\n %lld objects\n %lld„eclaimable objects\n",

1115 
	`³rıu_couÁ”_sum_pos™ive
(&
es_¡©s
->
es_¡©s_®l_út
),

1116 
	`³rıu_couÁ”_sum_pos™ive
(&
es_¡©s
->
es_¡©s_shk_út
));

1117 
	`£q_´štf
(
£q
, " %lu/%lu cache hits/misses\n",

1118 
es_¡©s
->
es_¡©s_ÿche_h™s
,

1119 
es_¡©s
->
es_¡©s_ÿche_mis£s
);

1120 ià(
šode_út
)

1121 
	`£q_´štf
(
£q
, " %d inode Ú†i¡\n", 
šode_út
);

1123 
	`£q_´štf
(
£q
, "average:\n %llu us scanime\n",

1124 
	`div_u64
(
es_¡©s
->
es_¡©s_sÿn_time
, 1000));

1125 
	`£q_´štf
(
£q
, " %lu shrunk objeùs\n", 
es_¡©s
->
es_¡©s_shrunk
);

1126 ià(
šode_út
)

1127 
	`£q_´štf
(
£q
,

1130 
max
->
vfs_šode
.
i_šo
, max->
i_es_®l_Ä
, max->
i_es_shk_Ä
,

1131 
	`div_u64
(
es_¡©s
->
es_¡©s_max_sÿn_time
, 1000));

1134 
	}
}

1136 
	$ext4_es_»gi¡”_shršk”
(
ext4_sb_šfo
 *
sbi
)

1138 
”r
;

1141 
	`BUILD_BUG_ON
(
ES_SHIFT
 < 48);

1142 
	`INIT_LIST_HEAD
(&
sbi
->
s_es_li¡
);

1143 
sbi
->
s_es_Ä_šode
 = 0;

1144 
	`¥š_lock_š™
(&
sbi
->
s_es_lock
);

1145 
sbi
->
s_es_¡©s
.
es_¡©s_shrunk
 = 0;

1146 
sbi
->
s_es_¡©s
.
es_¡©s_ÿche_h™s
 = 0;

1147 
sbi
->
s_es_¡©s
.
es_¡©s_ÿche_mis£s
 = 0;

1148 
sbi
->
s_es_¡©s
.
es_¡©s_sÿn_time
 = 0;

1149 
sbi
->
s_es_¡©s
.
es_¡©s_max_sÿn_time
 = 0;

1150 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_es_¡©s
.
es_¡©s_®l_út
, 0, 
GFP_KERNEL
);

1151 ià(
”r
)

1152  
”r
;

1153 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
, 0, 
GFP_KERNEL
);

1154 ià(
”r
)

1155 
”r1
;

1157 
sbi
->
s_es_shršk”
.
sÿn_objeùs
 = 
ext4_es_sÿn
;

1158 
sbi
->
s_es_shršk”
.
couÁ_objeùs
 = 
ext4_es_couÁ
;

1159 
sbi
->
s_es_shršk”
.
£eks
 = 
DEFAULT_SEEKS
;

1160 
”r
 = 
	`»gi¡”_shršk”
(&
sbi
->
s_es_shršk”
);

1161 ià(
”r
)

1162 
”r2
;

1166 
”r2
:

1167 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
);

1168 
”r1
:

1169 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_®l_út
);

1170  
”r
;

1171 
	}
}

1173 
	$ext4_es_uÄegi¡”_shršk”
(
ext4_sb_šfo
 *
sbi
)

1175 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_®l_út
);

1176 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_es_¡©s
.
es_¡©s_shk_út
);

1177 
	`uÄegi¡”_shršk”
(&
sbi
->
s_es_shršk”
);

1178 
	}
}

1188 
	$es_do_»şaim_ex‹Ás
(
ext4_šode_šfo
 *
ei
, 
ext4_lblk_t
 
’d
,

1189 *
Ä_to_sÿn
, *
Ä_shrunk
)

1191 
šode
 *šodğ&
ei
->
vfs_šode
;

1192 
ext4_es_Œ“
 *
Œ“
 = &
ei
->
i_es_Œ“
;

1193 
ex‹Á_¡©us
 *
es
;

1194 
rb_node
 *
node
;

1196 
es
 = 
	`__es_Œ“_£¬ch
(&
Œ“
->
roÙ
, 
ei
->
i_es_shršk_lblk
);

1197 ià(!
es
)

1198 
out_w¿p
;

1199 
node
 = &
es
->
rb_node
;

1200 *
Ä_to_sÿn
 > 0) {

1201 ià(
es
->
es_lblk
 > 
’d
) {

1202 
ei
->
i_es_shršk_lblk
 = 
’d
 + 1;

1206 (*
Ä_to_sÿn
)--;

1207 
node
 = 
	`rb_Ãxt
(&
es
->
rb_node
);

1212 ià(
	`ext4_es_is_d–ayed
(
es
))

1213 
Ãxt
;

1214 ià(
	`ext4_es_is_»ã»nûd
(
es
)) {

1215 
	`ext4_es_ş—r_»ã»nûd
(
es
);

1216 
Ãxt
;

1219 
	`rb_”a£
(&
es
->
rb_node
, &
Œ“
->
roÙ
);

1220 
	`ext4_es_ä“_ex‹Á
(
šode
, 
es
);

1221 (*
Ä_shrunk
)++;

1222 
Ãxt
:

1223 ià(!
node
)

1224 
out_w¿p
;

1225 
es
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©us
, 
rb_node
);

1227 
ei
->
i_es_shršk_lblk
 = 
es
->
es_lblk
;

1229 
out_w¿p
:

1230 
ei
->
i_es_shršk_lblk
 = 0;

1232 
	}
}

1234 
	$es_»şaim_ex‹Ás
(
ext4_šode_šfo
 *
ei
, *
Ä_to_sÿn
)

1236 
šode
 *šodğ&
ei
->
vfs_šode
;

1237 
Ä_shrunk
 = 0;

1238 
ext4_lblk_t
 
¡¬t
 = 
ei
->
i_es_shršk_lblk
;

1239 
	`DEFINE_RATELIMIT_STATE
(
_rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

1240 
DEFAULT_RATELIMIT_BURST
);

1242 ià(
ei
->
i_es_shk_Ä
 == 0)

1245 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_PRECACHED
) &&

1246 
	`__¿‹lim™
(&
_rs
))

1247 
	`ext4_w¬nšg
(
šode
->
i_sb
, "forced shrink of…recachedƒxtents");

1249 ià(!
	`es_do_»şaim_ex‹Ás
(
ei
, 
EXT_MAX_BLOCKS
, 
Ä_to_sÿn
, &
Ä_shrunk
) &&

1250 
¡¬t
 != 0)

1251 
	`es_do_»şaim_ex‹Ás
(
ei
, 
¡¬t
 - 1, 
Ä_to_sÿn
, &
Ä_shrunk
);

1253 
ei
->
i_es_Œ“
.
ÿche_es
 = 
NULL
;

1254  
Ä_shrunk
;

1255 
	}
}

	@extents_status.h

11 #iâdeà
_EXT4_EXTENTS_STATUS_H


12 
	#_EXT4_EXTENTS_STATUS_H


	)

17 #ifdeà
ES_DEBUG__


18 
	#es_debug
(
fmt
, ...è
	`´štk
(fmt, ##
__VA_ARGS__
)

	)

20 
	#es_debug
(
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

27 
	#ES_AGGRESSIVE_TEST__


	)

33 
	mES_WRITTEN_B
,

34 
	mES_UNWRITTEN_B
,

35 
	mES_DELAYED_B
,

36 
	mES_HOLE_B
,

37 
	mES_REFERENCED_B
,

38 
	mES_FLAGS


41 
	#ES_SHIFT
 ((
ext4_fsblk_t
)*8 - 
ES_FLAGS
)

	)

42 
	#ES_MASK
 (~((
ext4_fsblk_t
)0è<< 
ES_SHIFT
)

	)

44 
	#EXTENT_STATUS_WRITTEN
 (1 << 
ES_WRITTEN_B
)

	)

45 
	#EXTENT_STATUS_UNWRITTEN
 (1 << 
ES_UNWRITTEN_B
)

	)

46 
	#EXTENT_STATUS_DELAYED
 (1 << 
ES_DELAYED_B
)

	)

47 
	#EXTENT_STATUS_HOLE
 (1 << 
ES_HOLE_B
)

	)

48 
	#EXTENT_STATUS_REFERENCED
 (1 << 
ES_REFERENCED_B
)

	)

50 
	#ES_TYPE_MASK
 ((
ext4_fsblk_t
)(
EXTENT_STATUS_WRITTEN
 | \

51 
EXTENT_STATUS_UNWRITTEN
 | \

52 
EXTENT_STATUS_DELAYED
 | \

53 
EXTENT_STATUS_HOLE
è<< 
ES_SHIFT
)

	)

55 
	gext4_sb_šfo
;

56 
	gext4_ex‹Á
;

58 
	sex‹Á_¡©us
 {

59 
rb_node
 
	mrb_node
;

60 
ext4_lblk_t
 
	mes_lblk
;

61 
ext4_lblk_t
 
	mes_Ën
;

62 
ext4_fsblk_t
 
	mes_pblk
;

65 
	sext4_es_Œ“
 {

66 
rb_roÙ
 
	mroÙ
;

67 
ex‹Á_¡©us
 *
	mÿche_es
;

70 
	sext4_es_¡©s
 {

71 
	mes_¡©s_shrunk
;

72 
	mes_¡©s_ÿche_h™s
;

73 
	mes_¡©s_ÿche_mis£s
;

74 
u64
 
	mes_¡©s_sÿn_time
;

75 
u64
 
	mes_¡©s_max_sÿn_time
;

76 
³rıu_couÁ”
 
	mes_¡©s_®l_út
;

77 
³rıu_couÁ”
 
	mes_¡©s_shk_út
;

80 
__š™
 
ext4_š™_es
();

81 
ext4_ex™_es
();

82 
ext4_es_š™_Œ“
(
ext4_es_Œ“
 *
Œ“
);

84 
ext4_es_š£¹_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

85 
ext4_lblk_t
 
Ën
, 
ext4_fsblk_t
 
pblk
,

86 
¡©us
);

87 
ext4_es_ÿche_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

88 
ext4_lblk_t
 
Ën
, 
ext4_fsblk_t
 
pblk
,

89 
¡©us
);

90 
ext4_es_»move_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

91 
ext4_lblk_t
 
Ën
);

92 
ext4_es_fšd_d–ayed_ex‹Á_¿nge
(
šode
 *inode,

93 
ext4_lblk_t
 
lblk
,ƒxt4_lblk_ˆ
’d
,

94 
ex‹Á_¡©us
 *
es
);

95 
ext4_es_lookup_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

96 
ex‹Á_¡©us
 *
es
);

98 
šlše
 
	$ext4_es_¡©us
(
ex‹Á_¡©us
 *
es
)

100  
es
->
es_pblk
 >> 
ES_SHIFT
;

101 
	}
}

103 
šlše
 
	$ext4_es_ty³
(
ex‹Á_¡©us
 *
es
)

105  (
es
->
es_pblk
 & 
ES_TYPE_MASK
è>> 
ES_SHIFT
;

106 
	}
}

108 
šlše
 
	$ext4_es_is_wr™‹n
(
ex‹Á_¡©us
 *
es
)

110  (
	`ext4_es_ty³
(
es
è& 
EXTENT_STATUS_WRITTEN
) != 0;

111 
	}
}

113 
šlše
 
	$ext4_es_is_unwr™‹n
(
ex‹Á_¡©us
 *
es
)

115  (
	`ext4_es_ty³
(
es
è& 
EXTENT_STATUS_UNWRITTEN
) != 0;

116 
	}
}

118 
šlše
 
	$ext4_es_is_d–ayed
(
ex‹Á_¡©us
 *
es
)

120  (
	`ext4_es_ty³
(
es
è& 
EXTENT_STATUS_DELAYED
) != 0;

121 
	}
}

123 
šlše
 
	$ext4_es_is_hŞe
(
ex‹Á_¡©us
 *
es
)

125  (
	`ext4_es_ty³
(
es
è& 
EXTENT_STATUS_HOLE
) != 0;

126 
	}
}

128 
šlše
 
	$ext4_es_£t_»ã»nûd
(
ex‹Á_¡©us
 *
es
)

130 
es
->
es_pblk
 |ğ((
ext4_fsblk_t
)
EXTENT_STATUS_REFERENCED
è<< 
ES_SHIFT
;

131 
	}
}

133 
šlše
 
	$ext4_es_ş—r_»ã»nûd
(
ex‹Á_¡©us
 *
es
)

135 
es
->
es_pblk
 &ğ~(((
ext4_fsblk_t
)
EXTENT_STATUS_REFERENCED
è<< 
ES_SHIFT
);

136 
	}
}

138 
šlše
 
	$ext4_es_is_»ã»nûd
(
ex‹Á_¡©us
 *
es
)

140  (
	`ext4_es_¡©us
(
es
è& 
EXTENT_STATUS_REFERENCED
) != 0;

141 
	}
}

143 
šlše
 
ext4_fsblk_t
 
	$ext4_es_pblock
(
ex‹Á_¡©us
 *
es
)

145  
es
->
es_pblk
 & ~
ES_MASK
;

146 
	}
}

148 
šlše
 
	$ext4_es_¡Üe_pblock
(
ex‹Á_¡©us
 *
es
,

149 
ext4_fsblk_t
 
pb
)

151 
ext4_fsblk_t
 
block
;

153 
block
 = (
pb
 & ~
ES_MASK
è| (
es
->
es_pblk
 & ES_MASK);

154 
es
->
es_pblk
 = 
block
;

155 
	}
}

157 
šlše
 
	$ext4_es_¡Üe_¡©us
(
ex‹Á_¡©us
 *
es
,

158 
¡©us
)

160 
es
->
es_pblk
 = (((
ext4_fsblk_t
)
¡©us
 << 
ES_SHIFT
è& 
ES_MASK
) |

161 (
es
->
es_pblk
 & ~
ES_MASK
);

162 
	}
}

164 
šlše
 
	$ext4_es_¡Üe_pblock_¡©us
(
ex‹Á_¡©us
 *
es
,

165 
ext4_fsblk_t
 
pb
,

166 
¡©us
)

168 
es
->
es_pblk
 = (((
ext4_fsblk_t
)
¡©us
 << 
ES_SHIFT
è& 
ES_MASK
) |

169 (
pb
 & ~
ES_MASK
);

170 
	}
}

172 
ext4_es_»gi¡”_shršk”
(
ext4_sb_šfo
 *
sbi
);

173 
ext4_es_uÄegi¡”_shršk”
(
ext4_sb_šfo
 *
sbi
);

175 
ext4_£q_es_shršk”_šfo_show
(
£q_fe
 *
£q
, *
v
);

	@file.c

21 
	~<lšux/time.h
>

22 
	~<lšux/fs.h
>

23 
	~<lšux/mouÁ.h
>

24 
	~<lšux/·th.h
>

25 
	~<lšux/dax.h
>

26 
	~<lšux/quÙaİs.h
>

27 
	~<lšux/·gevec.h
>

28 
	~<lšux/uio.h
>

29 
	~"ext4.h
"

30 
	~"ext4_jbd2.h
"

31 
	~"x©Œ.h
"

32 
	~"aş.h
"

34 #ifdeà
CONFIG_FS_DAX


35 
ssize_t
 
	$ext4_dax_»ad_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
to
)

37 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

38 
ssize_t
 
»t
;

40 ià(!
	`šode_Œylock_sh¬ed
(
šode
)) {

41 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

42  -
EAGAIN
;

43 
	`šode_lock_sh¬ed
(
šode
);

49 ià(!
	`IS_DAX
(
šode
)) {

50 
	`šode_uÆock_sh¬ed
(
šode
);

52  
	`g’”ic_fe_»ad_™”
(
iocb
, 
to
);

54 
»t
 = 
	`dax_iom­_rw
(
iocb
, 
to
, &
ext4_iom­_İs
);

55 
	`šode_uÆock_sh¬ed
(
šode
);

57 
	`fe_acûs£d
(
iocb
->
ki_fp
);

58  
»t
;

59 
	}
}

62 
ssize_t
 
	$ext4_fe_»ad_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
to
)

64 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
	`fe_šode
(
iocb
->
ki_fp
)->
i_sb
))))

65  -
EIO
;

67 ià(!
	`iov_™”_couÁ
(
to
))

70 #ifdeà
CONFIG_FS_DAX


71 ià(
	`IS_DAX
(
	`fe_šode
(
iocb
->
ki_fp
)))

72  
	`ext4_dax_»ad_™”
(
iocb
, 
to
);

74  
	`g’”ic_fe_»ad_™”
(
iocb
, 
to
);

75 
	}
}

82 
	$ext4_»Ëa£_fe
(
šode
 *šode, 
fe
 *
fp
)

84 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_DA_ALLOC_CLOSE
)) {

85 
	`ext4_®loc_da_blocks
(
šode
);

86 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_DA_ALLOC_CLOSE
);

89 ià((
fp
->
f_mode
 & 
FMODE_WRITE
) &&

90 (
	`©omic_»ad
(&
šode
->
i_wr™ecouÁ
) == 1) &&

91 !
	`EXT4_I
(
šode
)->
i_»£rved_d©a_blocks
)

93 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

94 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

95 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

97 ià(
	`is_dx
(
šode
è&& 
fp
->
´iv©e_d©a
)

98 
	`ext4_hŒ“_ä“_dœ_šfo
(
fp
->
´iv©e_d©a
);

101 
	}
}

103 
	$ext4_unwr™‹n_wa™
(
šode
 *inode)

105 
wa™_queue_h—d_t
 *
wq
 = 
	`ext4_iÛnd_wq
(
šode
);

107 
	`wa™_ev’t
(*
wq
, (
	`©omic_»ad
(&
	`EXT4_I
(
šode
)->
i_unwr™‹n
) == 0));

108 
	}
}

120 
	$ext4_uÇligÃd_aio
(
šode
 *šode, 
iov_™”
 *
äom
, 
loff_t
 
pos
)

122 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

123 
blockmask
 = 
sb
->
s_blocksize
 - 1;

125 ià(
pos
 >ğ
	`i_size_»ad
(
šode
))

128 ià((
pos
 | 
	`iov_™”_®ignm’t
(
äom
)è& 
blockmask
)

132 
	}
}

135 
boŞ
 
	$ext4_ov”wr™e_io
(
šode
 *šode, 
loff_t
 
pos
,†off_ˆ
Ën
)

137 
ext4_m­_blocks
 
m­
;

138 
blkb™s
 = 
šode
->
i_blkb™s
;

139 
”r
, 
blkËn
;

141 ià(
pos
 + 
Ën
 > 
	`i_size_»ad
(
šode
))

142  
çl£
;

144 
m­
.
m_lblk
 = 
pos
 >> 
blkb™s
;

145 
m­
.
m_Ën
 = 
	`EXT4_MAX_BLOCKS
(
Ën
, 
pos
, 
blkb™s
);

146 
blkËn
 = 
m­
.
m_Ën
;

148 
”r
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

154  
”r
 =ğ
blkËn
 && (
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
);

155 
	}
}

157 
ssize_t
 
	$ext4_wr™e_checks
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

159 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

160 
ssize_t
 
»t
;

162 
»t
 = 
	`g’”ic_wr™e_checks
(
iocb
, 
äom
);

163 ià(
»t
 <= 0)

164  
»t
;

169 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))) {

170 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

172 ià(
iocb
->
ki_pos
 >ğ
sbi
->
s_b™m­_maxby‹s
)

173  -
EFBIG
;

174 
	`iov_™”_Œunÿ‹
(
äom
, 
sbi
->
s_b™m­_maxby‹s
 - 
iocb
->
ki_pos
);

176  
	`iov_™”_couÁ
(
äom
);

177 
	}
}

179 #ifdeà
CONFIG_FS_DAX


180 
ssize_t


181 
	$ext4_dax_wr™e_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

183 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

184 
ssize_t
 
»t
;

186 ià(!
	`šode_Œylock
(
šode
)) {

187 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

188  -
EAGAIN
;

189 
	`šode_lock
(
šode
);

191 
»t
 = 
	`ext4_wr™e_checks
(
iocb
, 
äom
);

192 ià(
»t
 <= 0)

193 
out
;

194 
»t
 = 
	`fe_»move_´ivs
(
iocb
->
ki_fp
);

195 ià(
»t
)

196 
out
;

197 
»t
 = 
	`fe_upd©e_time
(
iocb
->
ki_fp
);

198 ià(
»t
)

199 
out
;

201 
»t
 = 
	`dax_iom­_rw
(
iocb
, 
äom
, &
ext4_iom­_İs
);

202 
out
:

203 
	`šode_uÆock
(
šode
);

204 ià(
»t
 > 0)

205 
»t
 = 
	`g’”ic_wr™e_sync
(
iocb
,„et);

206  
»t
;

207 
	}
}

209 
ssize_t


210 
	$ext4_dax_wr™e_™”_‹mpÜ®
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

212 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

213 
ssize_t
 
»t
;

215 ià(!
	`šode_Œylock
(
šode
)) {

216 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

217  -
EAGAIN
;

218 
	`šode_lock
(
šode
);

220 
»t
 = 
	`ext4_wr™e_checks
(
iocb
, 
äom
);

221 ià(
»t
 <= 0)

222 
out
;

223 
»t
 = 
	`fe_»move_´ivs
(
iocb
->
ki_fp
);

224 ià(
»t
)

225 
out
;

226 
»t
 = 
	`fe_upd©e_time
(
iocb
->
ki_fp
);

227 ià(
»t
)

228 
out
;

230 
»t
 = 
	`dax_iom­_rw_‹mpÜ®
(
iocb
, 
äom
, &
ext4_iom­_İs
);

231 
out
:

232 
	`šode_uÆock
(
šode
);

233 ià(
»t
 > 0)

234 
»t
 = 
	`g’”ic_wr™e_sync
(
iocb
,„et);

235  
»t
;

236 
	}
}

240 
ssize_t


241 
	$ext4_fe_wr™e_™”
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

243 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

244 
o_dœeù
 = 
iocb
->
ki_æags
 & 
IOCB_DIRECT
;

245 
uÇligÃd_aio
 = 0;

246 
ov”wr™e
 = 0;

247 
ssize_t
 
»t
;

249 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

250  -
EIO
;

252 #ifdeà
CONFIG_FS_DAX


253 ià(
	`IS_DAX
(
šode
))

254  
	`ext4_dax_wr™e_™”
(
iocb
, 
äom
);

257 ià(!
	`šode_Œylock
(
šode
)) {

258 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

259  -
EAGAIN
;

260 
	`šode_lock
(
šode
);

263 
»t
 = 
	`ext4_wr™e_checks
(
iocb
, 
äom
);

264 ià(
»t
 <= 0)

265 
out
;

272 ià(
o_dœeù
 && 
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
) &&

273 !
	`is_sync_kiocb
(
iocb
) &&

274 
	`ext4_uÇligÃd_aio
(
šode
, 
äom
, 
iocb
->
ki_pos
)) {

275 
uÇligÃd_aio
 = 1;

276 
	`ext4_unwr™‹n_wa™
(
šode
);

279 
iocb
->
´iv©e
 = &
ov”wr™e
;

281 ià(
o_dœeù
 && !
uÇligÃd_aio
) {

282 ià(
	`ext4_ov”wr™e_io
(
šode
, 
iocb
->
ki_pos
, 
	`iov_™”_couÁ
(
äom
))) {

283 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
))

284 
ov”wr™e
 = 1;

285 } ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) {

286 
»t
 = -
EAGAIN
;

287 
out
;

291 
»t
 = 
	`__g’”ic_fe_wr™e_™”
(
iocb
, 
äom
);

292 
	`šode_uÆock
(
šode
);

294 ià(
»t
 > 0)

295 
»t
 = 
	`g’”ic_wr™e_sync
(
iocb
,„et);

297  
»t
;

299 
out
:

300 
	`šode_uÆock
(
šode
);

301  
»t
;

302 
	}
}

304 
ssize_t


305 
	$ext4_fe_wr™e_™”_‹mpÜ®
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

307 
šode
 *šodğ
	`fe_šode
(
iocb
->
ki_fp
);

308 
o_dœeù
 = 
iocb
->
ki_æags
 & 
IOCB_DIRECT
;

309 
uÇligÃd_aio
 = 0;

310 
ov”wr™e
 = 0;

311 
ssize_t
 
»t
;

313 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

314  -
EIO
;

316 #ifdeà
CONFIG_FS_DAX


317 ià(
	`IS_DAX
(
šode
))

318  
	`ext4_dax_wr™e_™”_‹mpÜ®
(
iocb
, 
äom
);

321 ià(!
	`šode_Œylock
(
šode
)) {

322 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

323  -
EAGAIN
;

324 
	`šode_lock
(
šode
);

327 
»t
 = 
	`ext4_wr™e_checks
(
iocb
, 
äom
);

328 ià(
»t
 <= 0)

329 
out
;

336 ià(
o_dœeù
 && 
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
) &&

337 !
	`is_sync_kiocb
(
iocb
) &&

338 
	`ext4_uÇligÃd_aio
(
šode
, 
äom
, 
iocb
->
ki_pos
)) {

339 
uÇligÃd_aio
 = 1;

340 
	`ext4_unwr™‹n_wa™
(
šode
);

343 
iocb
->
´iv©e
 = &
ov”wr™e
;

345 ià(
o_dœeù
 && !
uÇligÃd_aio
) {

346 ià(
	`ext4_ov”wr™e_io
(
šode
, 
iocb
->
ki_pos
, 
	`iov_™”_couÁ
(
äom
))) {

347 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
))

348 
ov”wr™e
 = 1;

349 } ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) {

350 
»t
 = -
EAGAIN
;

351 
out
;

355 
»t
 = 
	`__g’”ic_fe_wr™e_™”
(
iocb
, 
äom
);

356 
	`šode_uÆock
(
šode
);

358 ià(
»t
 > 0)

359 
»t
 = 
	`g’”ic_wr™e_sync
(
iocb
,„et);

361  
»t
;

363 
out
:

364 
	`šode_uÆock
(
šode
);

365  
»t
;

366 
	}
}

369 #ifdeà
CONFIG_FS_DAX


370 
	$ext4_dax_huge_çuÉ
(
vm_çuÉ
 *
vmf
,

371 
·ge_’Œy_size
 
³_size
)

373 
»suÉ
;

374 
hªdË_t
 *
hªdË
 = 
NULL
;

375 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

376 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

377 
boŞ
 
wr™e
 = 
vmf
->
æags
 & 
FAULT_FLAG_WRITE
;

379 ià(
wr™e
) {

380 
	`sb_¡¬t_·geçuÉ
(
sb
);

381 
	`fe_upd©e_time
(
vmf
->
vma
->
vm_fe
);

382 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

383 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_WRITE_PAGE
,

384 
	`EXT4_DATA_TRANS_BLOCKS
(
sb
));

386 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

388 ià(!
	`IS_ERR
(
hªdË
))

389 
»suÉ
 = 
	`dax_iom­_çuÉ
(
vmf
, 
³_size
, &
ext4_iom­_İs
);

391 
»suÉ
 = 
VM_FAULT_SIGBUS
;

392 ià(
wr™e
) {

393 ià(!
	`IS_ERR
(
hªdË
))

394 
	`ext4_jouº®_¡İ
(
hªdË
);

395 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

396 
	`sb_’d_·geçuÉ
(
sb
);

398 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

401  
»suÉ
;

402 
	}
}

404 
	$ext4_dax_çuÉ
(
vm_çuÉ
 *
vmf
)

406  
	`ext4_dax_huge_çuÉ
(
vmf
, 
PE_SIZE_PTE
);

407 
	}
}

418 
	$ext4_dax_pâ_mkwr™e
(
vm_çuÉ
 *
vmf
)

420 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

421 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

422 
loff_t
 
size
;

423 
»t
;

425 
	`sb_¡¬t_·geçuÉ
(
sb
);

426 
	`fe_upd©e_time
(
vmf
->
vma
->
vm_fe
);

427 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

428 
size
 = (
	`i_size_»ad
(
šode
è+ 
PAGE_SIZE
 - 1è>> 
PAGE_SHIFT
;

429 ià(
vmf
->
pgoff
 >ğ
size
)

430 
»t
 = 
VM_FAULT_SIGBUS
;

432 
»t
 = 
	`dax_pâ_mkwr™e
(
vmf
);

433 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

434 
	`sb_’d_·geçuÉ
(
sb
);

436  
»t
;

437 
	}
}

439 cÚ¡ 
vm_İ”©iÚs_¡ruù
 
	gext4_dax_vm_İs
 = {

440 .
çuÉ
 = 
ext4_dax_çuÉ
,

441 .
	ghuge_çuÉ
 = 
ext4_dax_huge_çuÉ
,

442 .
	g·ge_mkwr™e
 = 
ext4_dax_çuÉ
,

443 .
	gpâ_mkwr™e
 = 
ext4_dax_pâ_mkwr™e
,

446 
	#ext4_dax_vm_İs
 
ext4_fe_vm_İs


	)

449 cÚ¡ 
vm_İ”©iÚs_¡ruù
 
	gext4_fe_vm_İs
 = {

450 .
çuÉ
 = 
ext4_fem­_çuÉ
,

451 .
	gm­_·ges
 = 
fem­_m­_·ges
,

452 .
	g·ge_mkwr™e
 = 
ext4_·ge_mkwr™e
,

455 
	$ext4_fe_mm­
(
fe
 *fe, 
vm_¬—_¡ruù
 *
vma
)

457 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

459 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

460  -
EIO
;

462 
	`fe_acûs£d
(
fe
);

463 ià(
	`IS_DAX
(
	`fe_šode
(
fe
))) {

464 
vma
->
vm_İs
 = &
ext4_dax_vm_İs
;

465 
vma
->
vm_æags
 |ğ
VM_MIXEDMAP
 | 
VM_HUGEPAGE
;

467 
vma
->
vm_İs
 = &
ext4_fe_vm_İs
;

470 
	}
}

472 
	$ext4_fe_İ’
(
šode
 * inode, 
fe
 * 
fp
)

474 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

475 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

476 
vfsmouÁ
 *
mÁ
 = 
fp
->
f_·th
.mnt;

477 
d’Œy
 *
dœ
;

478 
·th
…ath;

479 
buf
[64], *
ı
;

480 
»t
;

482 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

483  -
EIO
;

485 ià(
	`uÆik–y
(!(
sbi
->
s_mouÁ_æags
 & 
EXT4_MF_MNTDIR_SAMPLED
) &&

486 !(
sb
->
s_æags
 & 
MS_RDONLY
))) {

487 
sbi
->
s_mouÁ_æags
 |ğ
EXT4_MF_MNTDIR_SAMPLED
;

494 
	`mem£t
(
buf
, 0, (buf));

495 
·th
.
mÁ
 = mnt;

496 
·th
.
d’Œy
 = 
mÁ
->
mÁ_roÙ
;

497 
ı
 = 
	`d_·th
(&
·th
, 
buf
, (buf));

498 ià(!
	`IS_ERR
(
ı
)) {

499 
hªdË_t
 *
hªdË
;

500 
”r
;

502 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_MISC
, 1);

503 ià(
	`IS_ERR
(
hªdË
))

504  
	`PTR_ERR
(
hªdË
);

505 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

506 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

507 ià(
”r
) {

508 
	`ext4_jouº®_¡İ
(
hªdË
);

509  
”r
;

511 
	`¡¾ıy
(
sbi
->
s_es
->
s_Ï¡_mouÁed
, 
ı
,

512 (
sbi
->
s_es
->
s_Ï¡_mouÁed
));

513 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

514 
	`ext4_jouº®_¡İ
(
hªdË
);

517 ià(
	`ext4_’üy±ed_šode
(
šode
)) {

518 
»t
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
);

519 ià(
»t
)

520  -
EACCES
;

521 ià(!
	`fsüy±_has_’üy±iÚ_key
(
šode
))

522  -
ENOKEY
;

525 
dœ
 = 
	`dg‘_·»Á
(
	`fe_d’Œy
(
fp
));

526 ià(
	`ext4_’üy±ed_šode
(
	`d_šode
(
dœ
)) &&

527 !
	`fsüy±_has_³rm™‹d_cÚ‹xt
(
	`d_šode
(
dœ
), 
šode
)) {

528 
	`ext4_w¬nšg
(
šode
->
i_sb
,

530 (è
	`d_šode
(
dœ
)->
i_šo
,

531 (è
šode
->
i_šo
);

532 
	`dput
(
dœ
);

533  -
EPERM
;

535 
	`dput
(
dœ
);

540 ià(
fp
->
f_mode
 & 
FMODE_WRITE
) {

541 
»t
 = 
	`ext4_šode_©ch_jšode
(
šode
);

542 ià(
»t
 < 0)

543  
»t
;

547 
fp
->
f_mode
 |ğ
FMODE_AIO_NOWAIT
;

549  
	`dquÙ_fe_İ’
(
šode
, 
fp
);

550 
	}
}

568 
	$ext4_fšd_unwr™‹n_pgoff
(
šode
 *inode,

569 
wh’û
,

570 
ext4_lblk_t
 
’d_blk
,

571 
loff_t
 *
off£t
)

573 
·gevec
 
pvec
;

574 
blkb™s
;

575 
pgoff_t
 
šdex
;

576 
pgoff_t
 
’d
;

577 
loff_t
 
’doff
;

578 
loff_t
 
¡¬toff
;

579 
loff_t
 
Ï¡off
;

580 
found
 = 0;

582 
blkb™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

583 
¡¬toff
 = *
off£t
;

584 
Ï¡off
 = 
¡¬toff
;

585 
’doff
 = (
loff_t
)
’d_blk
 << 
blkb™s
;

587 
šdex
 = 
¡¬toff
 >> 
PAGE_SHIFT
;

588 
’d
 = (
’doff
 - 1è>> 
PAGE_SHIFT
;

590 
	`·gevec_š™
(&
pvec
, 0);

592 
i
, 
num
;

593 
Ä_·ges
;

595 
num
 = 
	`mš_t
(
pgoff_t
, 
’d
 - 
šdex
, 
PAGEVEC_SIZE
 - 1) + 1;

596 
Ä_·ges
 = 
	`·gevec_lookup
(&
pvec
, 
šode
->
i_m­pšg
, 
šdex
,

597 (
pgoff_t
)
num
);

598 ià(
Ä_·ges
 == 0)

601 
i
 = 0; i < 
Ä_·ges
; i++) {

602 
·ge
 *·gğ
pvec
.
·ges
[
i
];

603 
bufãr_h—d
 *
bh
, *
h—d
;

609 ià(
wh’û
 =ğ
SEEK_HOLE
 && 
Ï¡off
 < 
’doff
 &&

610 
Ï¡off
 < 
	`·ge_off£t
(
pvec
.
·ges
[
i
])) {

611 
found
 = 1;

612 *
off£t
 = 
Ï¡off
;

613 
out
;

616 ià(
·ge
->
šdex
 > 
’d
)

617 
out
;

619 
	`lock_·ge
(
·ge
);

621 ià(
	`uÆik–y
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
)) {

622 
	`uÆock_·ge
(
·ge
);

626 ià(!
	`·ge_has_bufãrs
(
·ge
)) {

627 
	`uÆock_·ge
(
·ge
);

631 ià(
	`·ge_has_bufãrs
(
·ge
)) {

632 
Ï¡off
 = 
	`·ge_off£t
(
·ge
);

633 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

635 ià(
Ï¡off
 + 
bh
->
b_size
 <ğ
¡¬toff
)

636 
Ãxt
;

637 ià(
	`bufãr_u±od©e
(
bh
) ||

638 
	`bufãr_unwr™‹n
(
bh
)) {

639 ià(
wh’û
 =ğ
SEEK_DATA
)

640 
found
 = 1;

642 ià(
wh’û
 =ğ
SEEK_HOLE
)

643 
found
 = 1;

645 ià(
found
) {

646 *
off£t
 = 
	`max_t
(
loff_t
,

647 
¡¬toff
, 
Ï¡off
);

648 
	`uÆock_·ge
(
·ge
);

649 
out
;

651 
Ãxt
:

652 
Ï¡off
 +ğ
bh
->
b_size
;

653 
bh
 = bh->
b_this_·ge
;

654 } 
bh
 !ğ
h—d
);

657 
Ï¡off
 = 
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
;

658 
	`uÆock_·ge
(
·ge
);

662 ià(
Ä_·ges
 < 
num
)

665 
šdex
 = 
pvec
.
·ges
[
i
 - 1]->index + 1;

666 
	`·gevec_»Ëa£
(&
pvec
);

667 } 
šdex
 <ğ
’d
);

669 ià(
wh’û
 =ğ
SEEK_HOLE
 && 
Ï¡off
 < 
’doff
) {

670 
found
 = 1;

671 *
off£t
 = 
Ï¡off
;

673 
out
:

674 
	`·gevec_»Ëa£
(&
pvec
);

675  
found
;

676 
	}
}

681 
loff_t
 
	$ext4_£ek_d©a
(
fe
 *fe, 
loff_t
 
off£t
,†off_ˆ
maxsize
)

683 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

684 
ex‹Á_¡©us
 
es
;

685 
ext4_lblk_t
 
¡¬t
, 
Ï¡
, 
’d
;

686 
loff_t
 
d©aoff
, 
isize
;

687 
blkb™s
;

688 
»t
;

690 
	`šode_lock
(
šode
);

692 
isize
 = 
	`i_size_»ad
(
šode
);

693 ià(
off£t
 >ğ
isize
) {

694 
	`šode_uÆock
(
šode
);

695  -
ENXIO
;

698 
blkb™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

699 
¡¬t
 = 
off£t
 >> 
blkb™s
;

700 
Ï¡
 = 
¡¬t
;

701 
’d
 = 
isize
 >> 
blkb™s
;

702 
d©aoff
 = 
off£t
;

705 
»t
 = 
	`ext4_g‘_Ãxt_ex‹Á
(
šode
, 
Ï¡
, 
’d
 -†a¡ + 1, &
es
);

706 ià(
»t
 <= 0) {

708 ià(
»t
 == 0)

709 
»t
 = -
ENXIO
;

710 
	`šode_uÆock
(
šode
);

711  
»t
;

714 
Ï¡
 = 
es
.
es_lblk
;

715 ià(
Ï¡
 !ğ
¡¬t
)

716 
d©aoff
 = (
loff_t
)
Ï¡
 << 
blkb™s
;

717 ià(!
	`ext4_es_is_unwr™‹n
(&
es
))

725 ià(
	`ext4_fšd_unwr™‹n_pgoff
(
šode
, 
SEEK_DATA
,

726 
es
.
es_lblk
 +ƒs.
es_Ën
, &
d©aoff
))

728 
Ï¡
 +ğ
es
.
es_Ën
;

729 
d©aoff
 = (
loff_t
)
Ï¡
 << 
blkb™s
;

730 
	`cÚd_»sched
();

731 } 
Ï¡
 <ğ
’d
);

733 
	`šode_uÆock
(
šode
);

735 ià(
d©aoff
 > 
isize
)

736  -
ENXIO
;

738  
	`vfs_£os
(
fe
, 
d©aoff
, 
maxsize
);

739 
	}
}

744 
loff_t
 
	$ext4_£ek_hŞe
(
fe
 *fe, 
loff_t
 
off£t
,†off_ˆ
maxsize
)

746 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

747 
ex‹Á_¡©us
 
es
;

748 
ext4_lblk_t
 
¡¬t
, 
Ï¡
, 
’d
;

749 
loff_t
 
hŞeoff
, 
isize
;

750 
blkb™s
;

751 
»t
;

753 
	`šode_lock
(
šode
);

755 
isize
 = 
	`i_size_»ad
(
šode
);

756 ià(
off£t
 >ğ
isize
) {

757 
	`šode_uÆock
(
šode
);

758  -
ENXIO
;

761 
blkb™s
 = 
šode
->
i_sb
->
s_blocksize_b™s
;

762 
¡¬t
 = 
off£t
 >> 
blkb™s
;

763 
Ï¡
 = 
¡¬t
;

764 
’d
 = 
isize
 >> 
blkb™s
;

765 
hŞeoff
 = 
off£t
;

768 
»t
 = 
	`ext4_g‘_Ãxt_ex‹Á
(
šode
, 
Ï¡
, 
’d
 -†a¡ + 1, &
es
);

769 ià(
»t
 < 0) {

770 
	`šode_uÆock
(
šode
);

771  
»t
;

774 ià(
»t
 =ğ0 || 
es
.
es_lblk
 > 
Ï¡
) {

775 ià(
Ï¡
 !ğ
¡¬t
)

776 
hŞeoff
 = (
loff_t
)
Ï¡
 << 
blkb™s
;

784 ià(
	`ext4_es_is_unwr™‹n
(&
es
) &&

785 
	`ext4_fšd_unwr™‹n_pgoff
(
šode
, 
SEEK_HOLE
,

786 
Ï¡
 + 
es
.
es_Ën
, &
hŞeoff
))

789 
Ï¡
 +ğ
es
.
es_Ën
;

790 
hŞeoff
 = (
loff_t
)
Ï¡
 << 
blkb™s
;

791 
	`cÚd_»sched
();

792 } 
Ï¡
 <ğ
’d
);

794 
	`šode_uÆock
(
šode
);

796 ià(
hŞeoff
 > 
isize
)

797 
hŞeoff
 = 
isize
;

799  
	`vfs_£os
(
fe
, 
hŞeoff
, 
maxsize
);

800 
	}
}

807 
loff_t
 
	$ext4_Î£ek
(
fe
 *fe, 
loff_t
 
off£t
, 
wh’û
)

809 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

810 
loff_t
 
maxby‹s
;

812 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

813 
maxby‹s
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_b™m­_maxby‹s
;

815 
maxby‹s
 = 
šode
->
i_sb
->
s_maxby‹s
;

817 
wh’û
) {

818 
SEEK_SET
:

819 
SEEK_CUR
:

820 
SEEK_END
:

821  
	`g’”ic_fe_Î£ek_size
(
fe
, 
off£t
, 
wh’û
,

822 
maxby‹s
, 
	`i_size_»ad
(
šode
));

823 
SEEK_DATA
:

824  
	`ext4_£ek_d©a
(
fe
, 
off£t
, 
maxby‹s
);

825 
SEEK_HOLE
:

826  
	`ext4_£ek_hŞe
(
fe
, 
off£t
, 
maxby‹s
);

829  -
EINVAL
;

830 
	}
}

832 cÚ¡ 
fe_İ”©iÚs
 
	gext4_fe_İ”©iÚs
 = {

833 .
Î£ek
 = 
ext4_Î£ek
,

834 .
	g»ad_™”
 = 
ext4_fe_»ad_™”
,

835 .
	gwr™e_™”
 = 
ext4_fe_wr™e_™”
,

836 .
	gwr™e_™”_‹mpÜ®
 = 
ext4_fe_wr™e_™”_‹mpÜ®
,

837 .
	guÆocked_ioùl
 = 
ext4_ioùl
,

838 #ifdeà
CONFIG_COMPAT


839 .
	gcom·t_ioùl
 = 
ext4_com·t_ioùl
,

841 .
	gmm­
 = 
ext4_fe_mm­
,

842 .
	gİ’
 = 
ext4_fe_İ’
,

843 .
	g»Ëa£
 = 
ext4_»Ëa£_fe
,

844 .
	gfsync
 = 
ext4_sync_fe
,

845 .
	gfsync_İt
 = 
ext4_sync_fe_İt
,

846 .
	gg‘_unm­³d_¬—
 = 
thp_g‘_unm­³d_¬—
,

847 .
	g¥liû_»ad
 = 
g’”ic_fe_¥liû_»ad
,

848 .
	g¥liû_wr™e
 = 
™”_fe_¥liû_wr™e
,

849 .
	gçÎoÿ‹
 = 
ext4_çÎoÿ‹
,

850 .
	gdyÇmic_»m­
 = 
ext4_dyÇmic_»m­
,

853 cÚ¡ 
šode_İ”©iÚs
 
	gext4_fe_šode_İ”©iÚs
 = {

854 .
£‰r
 = 
ext4_£‰r
,

855 .
	gg‘©Œ
 = 
ext4_fe_g‘©Œ
,

856 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

857 .
	gg‘_aş
 = 
ext4_g‘_aş
,

858 .
	g£t_aş
 = 
ext4_£t_aş
,

859 .
	gf›m­
 = 
ext4_f›m­
,

	@fsmap.c

20 
	~"ext4.h
"

21 
	~<lšux/fsm­.h
>

22 
	~"fsm­.h
"

23 
	~"mb®loc.h
"

24 
	~<lšux/sÜt.h
>

25 
	~<lšux/li¡_sÜt.h
>

26 
	~<Œaû/ev’ts/ext4.h
>

29 
	$ext4_fsm­_äom_š‹º®
(
su³r_block
 *
sb
, 
fsm­
 *
de¡
,

30 
ext4_fsm­
 *
¤c
)

32 
de¡
->
fmr_deviû
 = 
¤c
->fmr_device;

33 
de¡
->
fmr_æags
 = 
¤c
->fmr_flags;

34 
de¡
->
fmr_physiÿl
 = 
¤c
->fmr_physiÿÈ<< 
sb
->
s_blocksize_b™s
;

35 
de¡
->
fmr_owÃr
 = 
¤c
->fmr_owner;

36 
de¡
->
fmr_off£t
 = 0;

37 
de¡
->
fmr_Ëngth
 = 
¤c
->fmr_Ëngth << 
sb
->
s_blocksize_b™s
;

38 
de¡
->
fmr_»£rved
[0] = 0;

39 
de¡
->
fmr_»£rved
[1] = 0;

40 
de¡
->
fmr_»£rved
[2] = 0;

41 
	}
}

44 
	$ext4_fsm­_to_š‹º®
(
su³r_block
 *
sb
, 
ext4_fsm­
 *
de¡
,

45 
fsm­
 *
¤c
)

47 
de¡
->
fmr_deviû
 = 
¤c
->fmr_device;

48 
de¡
->
fmr_æags
 = 
¤c
->fmr_flags;

49 
de¡
->
fmr_physiÿl
 = 
¤c
->fmr_physiÿÈ>> 
sb
->
s_blocksize_b™s
;

50 
de¡
->
fmr_owÃr
 = 
¤c
->fmr_owner;

51 
de¡
->
fmr_Ëngth
 = 
¤c
->fmr_Ëngth >> 
sb
->
s_blocksize_b™s
;

52 
	}
}

55 
	sext4_g‘fsm­_šfo
 {

56 
ext4_fsm­_h—d
 *
	mgfi_h—d
;

57 
ext4_fsm­_fÜm©_t
 
	mgfi_fÜm©‹r
;

58 *
	mgfi_fÜm©_¬g
;

59 
ext4_fsblk_t
 
	mgfi_Ãxt_fsblk
;

60 
u32
 
	mgfi_dev
;

61 
ext4_group_t
 
	mgfi_agno
;

62 
ext4_fsm­
 
	mgfi_low
;

63 
ext4_fsm­
 
	mgfi_high
;

64 
ext4_fsm­
 
	mgfi_Ï¡ä“
;

65 
li¡_h—d
 
	mgfi_m‘a_li¡
;

66 
boŞ
 
	mgfi_Ï¡
;

70 
	sext4_g‘fsm­_dev
 {

71 (*
	mgfd_â
)(
su³r_block
 *
	msb
,

72 
ext4_fsm­
 *
	mkeys
,

73 
ext4_g‘fsm­_šfo
 *
	mšfo
);

74 
u32
 
	mgfd_dev
;

78 
	$ext4_g‘fsm­_dev_com·»
(cÚ¡ *
p1
, cÚ¡ *
p2
)

80 cÚ¡ 
ext4_g‘fsm­_dev
 *
d1
 = 
p1
;

81 cÚ¡ 
ext4_g‘fsm­_dev
 *
d2
 = 
p2
;

83  
d1
->
gfd_dev
 - 
d2
->gfd_dev;

84 
	}
}

87 
boŞ
 
	$ext4_g‘fsm­_»c_befÜe_low_key
(
ext4_g‘fsm­_šfo
 *
šfo
,

88 
ext4_fsm­
 *
»c
)

90  
»c
->
fmr_physiÿl
 < 
šfo
->
gfi_low
.fmr_physical;

91 
	}
}

97 
	$ext4_g‘fsm­_h–³r
(
su³r_block
 *
sb
,

98 
ext4_g‘fsm­_šfo
 *
šfo
,

99 
ext4_fsm­
 *
»c
)

101 
ext4_fsm­
 
fmr
;

102 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

103 
ext4_fsblk_t
 
»c_fsblk
 = 
»c
->
fmr_physiÿl
;

104 
ext4_group_t
 
agno
;

105 
ext4_g½blk_t
 
úo
;

106 
”rÜ
;

108 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
))

109  -
EINTR
;

115 ià(
	`ext4_g‘fsm­_»c_befÜe_low_key
(
šfo
, 
»c
)) {

116 
»c_fsblk
 +ğ
»c
->
fmr_Ëngth
;

117 ià(
šfo
->
gfi_Ãxt_fsblk
 < 
»c_fsblk
)

118 
šfo
->
gfi_Ãxt_fsblk
 = 
»c_fsblk
;

119  
EXT4_QUERY_RANGE_CONTINUE
;

123 ià(
šfo
->
gfi_h—d
->
fmh_couÁ
 == 0) {

124 ià(
»c_fsblk
 > 
šfo
->
gfi_Ãxt_fsblk
)

125 
šfo
->
gfi_h—d
->
fmh_’Œ›s
++;

127 ià(
šfo
->
gfi_Ï¡
)

128  
EXT4_QUERY_RANGE_CONTINUE
;

130 
šfo
->
gfi_h—d
->
fmh_’Œ›s
++;

132 
»c_fsblk
 +ğ
»c
->
fmr_Ëngth
;

133 ià(
šfo
->
gfi_Ãxt_fsblk
 < 
»c_fsblk
)

134 
šfo
->
gfi_Ãxt_fsblk
 = 
»c_fsblk
;

135  
EXT4_QUERY_RANGE_CONTINUE
;

143 ià(
»c_fsblk
 > 
šfo
->
gfi_Ãxt_fsblk
) {

144 ià(
šfo
->
gfi_h—d
->
fmh_’Œ›s
 >ğšfo->gfi_h—d->
fmh_couÁ
)

145  
EXT4_QUERY_RANGE_ABORT
;

147 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
šfo
->
gfi_Ãxt_fsblk
,

148 &
agno
, &
úo
);

149 
	`Œaû_ext4_fsm­_m­pšg
(
sb
, 
šfo
->
gfi_dev
, 
agno
,

150 
	`EXT4_C2B
(
sbi
, 
úo
),

151 
»c_fsblk
 - 
šfo
->
gfi_Ãxt_fsblk
,

152 
EXT4_FMR_OWN_UNKNOWN
);

154 
fmr
.
fmr_deviû
 = 
šfo
->
gfi_dev
;

155 
fmr
.
fmr_physiÿl
 = 
šfo
->
gfi_Ãxt_fsblk
;

156 
fmr
.
fmr_owÃr
 = 
EXT4_FMR_OWN_UNKNOWN
;

157 
fmr
.
fmr_Ëngth
 = 
»c_fsblk
 - 
šfo
->
gfi_Ãxt_fsblk
;

158 
fmr
.
fmr_æags
 = 
FMR_OF_SPECIAL_OWNER
;

159 
”rÜ
 = 
šfo
->
	`gfi_fÜm©‹r
(&
fmr
, info->
gfi_fÜm©_¬g
);

160 ià(
”rÜ
)

161  
”rÜ
;

162 
šfo
->
gfi_h—d
->
fmh_’Œ›s
++;

165 ià(
šfo
->
gfi_Ï¡
)

166 
out
;

169 ià(
šfo
->
gfi_h—d
->
fmh_’Œ›s
 >ğšfo->gfi_h—d->
fmh_couÁ
)

170  
EXT4_QUERY_RANGE_ABORT
;

172 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
»c_fsblk
, &
agno
, &
úo
);

173 
	`Œaû_ext4_fsm­_m­pšg
(
sb
, 
šfo
->
gfi_dev
, 
agno
, 
	`EXT4_C2B
(
sbi
, 
úo
),

174 
»c
->
fmr_Ëngth
,„ec->
fmr_owÃr
);

176 
fmr
.
fmr_deviû
 = 
šfo
->
gfi_dev
;

177 
fmr
.
fmr_physiÿl
 = 
»c_fsblk
;

178 
fmr
.
fmr_owÃr
 = 
»c
->fmr_owner;

179 
fmr
.
fmr_æags
 = 
FMR_OF_SPECIAL_OWNER
;

180 
fmr
.
fmr_Ëngth
 = 
»c
->fmr_length;

181 
”rÜ
 = 
šfo
->
	`gfi_fÜm©‹r
(&
fmr
, info->
gfi_fÜm©_¬g
);

182 ià(
”rÜ
)

183  
”rÜ
;

184 
šfo
->
gfi_h—d
->
fmh_’Œ›s
++;

186 
out
:

187 
»c_fsblk
 +ğ
»c
->
fmr_Ëngth
;

188 ià(
šfo
->
gfi_Ãxt_fsblk
 < 
»c_fsblk
)

189 
šfo
->
gfi_Ãxt_fsblk
 = 
»c_fsblk
;

190  
EXT4_QUERY_RANGE_CONTINUE
;

191 
	}
}

193 
šlše
 
ext4_fsblk_t
 
	$ext4_fsm­_Ãxt_pblk
(
ext4_fsm­
 *
fmr
)

195  
fmr
->
fmr_physiÿl
 + fmr->
fmr_Ëngth
;

196 
	}
}

199 
	$ext4_g‘fsm­_d©adev_h–³r
(
su³r_block
 *
sb
,

200 
ext4_group_t
 
agno
, 
ext4_g½blk_t
 
¡¬t
,

201 
ext4_g½blk_t
 
Ën
, *
´iv
)

203 
ext4_fsm­
 
œec
;

204 
ext4_g‘fsm­_šfo
 *
šfo
 = 
´iv
;

205 
ext4_fsm­
 *
p
;

206 
ext4_fsm­
 *
tmp
;

207 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

208 
ext4_fsblk_t
 
fsb
;

209 
ext4_fsblk_t
 
f¦’
;

210 
”rÜ
;

212 
fsb
 = (
	`EXT4_C2B
(
sbi
, 
¡¬t
è+ 
	`ext4_group_fœ¡_block_no
(
sb
, 
agno
));

213 
f¦’
 = 
	`EXT4_C2B
(
sbi
, 
Ën
);

216 ià(
šfo
->
gfi_Ï¡ä“
.
fmr_owÃr
) {

218 ià(
	`ext4_fsm­_Ãxt_pblk
(&
šfo
->
gfi_Ï¡ä“
è=ğ
fsb
) {

219 
šfo
->
gfi_Ï¡ä“
.
fmr_Ëngth
 +ğ
f¦’
;

227 
”rÜ
 = 
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, &šfo->
gfi_Ï¡ä“
);

228 ià(
”rÜ
)

229  
”rÜ
;

230 
šfo
->
gfi_Ï¡ä“
.
fmr_owÃr
 = 0;

234 
	`li¡_fÜ_—ch_’Œy_§ã
(
p
, 
tmp
, &
šfo
->
gfi_m‘a_li¡
, 
fmr_li¡
) {

235 ià(
p
->
fmr_physiÿl
 +…->
fmr_Ëngth
 <ğ
šfo
->
gfi_Ãxt_fsblk
) {

236 
	`li¡_d–
(&
p
->
fmr_li¡
);

237 
	`kä“
(
p
);

238 } ià(
p
->
fmr_physiÿl
 < 
fsb
) {

239 
”rÜ
 = 
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, 
p
);

240 ià(
”rÜ
)

241  
”rÜ
;

243 
	`li¡_d–
(&
p
->
fmr_li¡
);

244 
	`kä“
(
p
);

248 
œec
.
fmr_deviû
 = 0;

249 
œec
.
fmr_physiÿl
 = 
fsb
;

250 
œec
.
fmr_Ëngth
 = 
f¦’
;

251 
œec
.
fmr_owÃr
 = 
EXT4_FMR_OWN_FREE
;

252 
œec
.
fmr_æags
 = 0;

255 ià(
	`ext4_fsm­_Ãxt_pblk
(&
œec
) ==

256 
	`ext4_group_fœ¡_block_no
(
sb
, 
agno
 + 1)) {

257 
šfo
->
gfi_Ï¡ä“
 = 
œec
;

262  
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, &
œec
);

263 
	}
}

266 
	$ext4_g‘fsm­_logdev
(
su³r_block
 *
sb
, 
ext4_fsm­
 *
keys
,

267 
ext4_g‘fsm­_šfo
 *
šfo
)

269 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

270 
ext4_fsm­
 
œec
;

273 
šfo
->
gfi_low
 = 
keys
[0];

274 
šfo
->
gfi_low
.
fmr_Ëngth
 = 0;

276 
	`mem£t
(&
šfo
->
gfi_high
, 0xFF, (info->gfi_high));

278 
	`Œaû_ext4_fsm­_low_key
(
sb
, 
šfo
->
gfi_dev
, 0,

279 
šfo
->
gfi_low
.
fmr_physiÿl
,

280 
šfo
->
gfi_low
.
fmr_Ëngth
,

281 
šfo
->
gfi_low
.
fmr_owÃr
);

283 
	`Œaû_ext4_fsm­_high_key
(
sb
, 
šfo
->
gfi_dev
, 0,

284 
šfo
->
gfi_high
.
fmr_physiÿl
,

285 
šfo
->
gfi_high
.
fmr_Ëngth
,

286 
šfo
->
gfi_high
.
fmr_owÃr
);

288 ià(
keys
[0].
fmr_physiÿl
 > 0)

292 
œec
.
fmr_physiÿl
 = 
jouº®
->
j_blk_off£t
;

293 
œec
.
fmr_Ëngth
 = 
jouº®
->
j_maxËn
;

294 
œec
.
fmr_owÃr
 = 
EXT4_FMR_OWN_LOG
;

295 
œec
.
fmr_æags
 = 0;

297  
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, &
œec
);

298 
	}
}

301 
šlše
 
	$ext4_g‘fsm­_fl
(
li¡_h—d
 *
m‘a_li¡
,

302 
ext4_fsblk_t
 
fsb
,ƒxt4_fsblk_ˆ
Ën
,

303 
ušt64_t
 
owÃr
)

305 
ext4_fsm­
 *
fsm
;

307 
fsm
 = 
	`km®loc
((*fsm), 
GFP_NOFS
);

308 ià(!
fsm
)

309  -
ENOMEM
;

310 
fsm
->
fmr_deviû
 = 0;

311 
fsm
->
fmr_æags
 = 0;

312 
fsm
->
fmr_physiÿl
 = 
fsb
;

313 
fsm
->
fmr_owÃr
 = 
owÃr
;

314 
fsm
->
fmr_Ëngth
 = 
Ën
;

315 
	`li¡_add_
(&
fsm
->
fmr_li¡
, 
m‘a_li¡
);

318 
	}
}

324 
	$ext4_g‘fsm­_fšd_sb
(
su³r_block
 *
sb
,

325 
ext4_group_t
 
agno
,

326 
li¡_h—d
 *
m‘a_li¡
)

328 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

329 
ext4_fsblk_t
 
fsb
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
agno
);

330 
ext4_fsblk_t
 
Ën
;

331 
fœ¡_m‘a_bg
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_m‘a_bg
);

332 
m‘agroup
 = 
agno
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

333 
”rÜ
;

336 ià(
	`ext4_bg_has_su³r
(
sb
, 
agno
)) {

337 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
, 
fsb
, 1, 
EXT4_FMR_OWN_FS
);

338 ià(
”rÜ
)

339  
”rÜ
;

340 
fsb
++;

344 
Ën
 = 
	`ext4_bg_num_gdb
(
sb
, 
agno
);

345 ià(!
Ën
)

347 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
, 
fsb
, 
Ën
,

348 
EXT4_FMR_OWN_GDT
);

349 ià(
”rÜ
)

350  
”rÜ
;

351 
fsb
 +ğ
Ën
;

354 ià(!
	`ext4_has_ã©u»_m‘a_bg
(
sb
è|| 
m‘agroup
 < 
fœ¡_m‘a_bg
) {

355 
Ën
 = 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_»£rved_gdt_blocks
);

356 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
, 
fsb
, 
Ën
,

357 
EXT4_FMR_OWN_RESV_GDT
);

358 ià(
”rÜ
)

359  
”rÜ
;

363 
	}
}

366 
	$ext4_g‘fsm­_com·»
(*
´iv
,

367 
li¡_h—d
 *
a
,

368 
li¡_h—d
 *
b
)

370 
ext4_fsm­
 *
ç
;

371 
ext4_fsm­
 *
fb
;

373 
ç
 = 
	`cÚš”_of
(
a
, 
ext4_fsm­
, 
fmr_li¡
);

374 
fb
 = 
	`cÚš”_of
(
b
, 
ext4_fsm­
, 
fmr_li¡
);

375 ià(
ç
->
fmr_physiÿl
 < 
fb
->fmr_physical)

377 ià(
ç
->
fmr_physiÿl
 > 
fb
->fmr_physical)

380 
	}
}

383 
	$ext4_g‘fsm­_m”ge_fixed_m‘ad©a
(
li¡_h—d
 *
m‘a_li¡
)

385 
ext4_fsm­
 *
p
;

386 
ext4_fsm­
 *
´ev
 = 
NULL
;

387 
ext4_fsm­
 *
tmp
;

389 
	`li¡_fÜ_—ch_’Œy_§ã
(
p
, 
tmp
, 
m‘a_li¡
, 
fmr_li¡
) {

390 ià(!
´ev
) {

391 
´ev
 = 
p
;

395 ià(
´ev
->
fmr_owÃr
 =ğ
p
->fmr_owner &&

396 
´ev
->
fmr_physiÿl
 +…»v->
fmr_Ëngth
 =ğ
p
->fmr_physical) {

397 
´ev
->
fmr_Ëngth
 +ğ
p
->fmr_length;

398 
	`li¡_d–
(&
p
->
fmr_li¡
);

399 
	`kä“
(
p
);

401 
´ev
 = 
p
;

403 
	}
}

406 
	$ext4_g‘fsm­_ä“_fixed_m‘ad©a
(
li¡_h—d
 *
m‘a_li¡
)

408 
ext4_fsm­
 *
p
;

409 
ext4_fsm­
 *
tmp
;

411 
	`li¡_fÜ_—ch_’Œy_§ã
(
p
, 
tmp
, 
m‘a_li¡
, 
fmr_li¡
) {

412 
	`li¡_d–
(&
p
->
fmr_li¡
);

413 
	`kä“
(
p
);

415 
	}
}

418 
	$ext4_g‘fsm­_fšd_fixed_m‘ad©a
(
su³r_block
 *
sb
,

419 
li¡_h—d
 *
m‘a_li¡
)

421 
ext4_group_desc
 *
gdp
;

422 
ext4_group_t
 
agno
;

423 
”rÜ
;

425 
	`INIT_LIST_HEAD
(
m‘a_li¡
);

428 
agno
 = 0;‡gnØ< 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;‡gno++) {

429 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
agno
, 
NULL
);

430 ià(!
gdp
) {

431 
”rÜ
 = -
EFSCORRUPTED
;

432 
”r
;

436 
”rÜ
 = 
	`ext4_g‘fsm­_fšd_sb
(
sb
, 
agno
, 
m‘a_li¡
);

437 ià(
”rÜ
)

438 
”r
;

441 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
,

442 
	`ext4_block_b™m­
(
sb
, 
gdp
), 1,

443 
EXT4_FMR_OWN_BLKBM
);

444 ià(
”rÜ
)

445 
”r
;

448 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
,

449 
	`ext4_šode_b™m­
(
sb
, 
gdp
), 1,

450 
EXT4_FMR_OWN_INOBM
);

451 ià(
”rÜ
)

452 
”r
;

455 
”rÜ
 = 
	`ext4_g‘fsm­_fl
(
m‘a_li¡
,

456 
	`ext4_šode_bË
(
sb
, 
gdp
),

457 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
,

458 
EXT4_FMR_OWN_INODES
);

459 ià(
”rÜ
)

460 
”r
;

464 
	`li¡_sÜt
(
NULL
, 
m‘a_li¡
, 
ext4_g‘fsm­_com·»
);

467 
	`ext4_g‘fsm­_m”ge_fixed_m‘ad©a
(
m‘a_li¡
);

470 
”r
:

471 
	`ext4_g‘fsm­_ä“_fixed_m‘ad©a
(
m‘a_li¡
);

472  
”rÜ
;

473 
	}
}

476 
	$ext4_g‘fsm­_d©adev
(
su³r_block
 *
sb
,

477 
ext4_fsm­
 *
keys
,

478 
ext4_g‘fsm­_šfo
 *
šfo
)

480 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

481 
ext4_fsblk_t
 
¡¬t_fsb
;

482 
ext4_fsblk_t
 
’d_fsb
;

483 
ext4_fsblk_t
 
bofs
;

484 
ext4_fsblk_t
 
eofs
;

485 
ext4_group_t
 
¡¬t_ag
;

486 
ext4_group_t
 
’d_ag
;

487 
ext4_g½blk_t
 
fœ¡_şu¡”
;

488 
ext4_g½blk_t
 
Ï¡_şu¡”
;

489 
”rÜ
 = 0;

491 
bofs
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
);

492 
eofs
 = 
	`ext4_blocks_couÁ
(
sbi
->
s_es
);

493 ià(
keys
[0].
fmr_physiÿl
 >ğ
eofs
)

495 ià(
keys
[0].
fmr_physiÿl
 < 
bofs
)

496 
keys
[0].
fmr_physiÿl
 = 
bofs
;

497 ià(
keys
[1].
fmr_physiÿl
 >ğ
eofs
)

498 
keys
[1].
fmr_physiÿl
 = 
eofs
 - 1;

499 
¡¬t_fsb
 = 
keys
[0].
fmr_physiÿl
;

500 
’d_fsb
 = 
keys
[1].
fmr_physiÿl
;

503 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
¡¬t_fsb
, &
¡¬t_ag
, &
fœ¡_şu¡”
);

504 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
’d_fsb
, &
’d_ag
, &
Ï¡_şu¡”
);

511 
šfo
->
gfi_low
 = 
keys
[0];

512 
šfo
->
gfi_low
.
fmr_physiÿl
 = 
	`EXT4_C2B
(
sbi
, 
fœ¡_şu¡”
);

513 
šfo
->
gfi_low
.
fmr_Ëngth
 = 0;

515 
	`mem£t
(&
šfo
->
gfi_high
, 0xFF, (info->gfi_high));

518 
”rÜ
 = 
	`ext4_g‘fsm­_fšd_fixed_m‘ad©a
(
sb
, &
šfo
->
gfi_m‘a_li¡
);

519 ià(
”rÜ
)

520 
”r
;

523 
šfo
->
gfi_agno
 = 
¡¬t_ag
;

524 
šfo
->
gfi_agno
 <ğ
’d_ag
;

525 
šfo
->
gfi_agno
++) {

530 ià(
šfo
->
gfi_agno
 =ğ
’d_ag
) {

531 
šfo
->
gfi_high
 = 
keys
[1];

532 
šfo
->
gfi_high
.
fmr_physiÿl
 = 
	`EXT4_C2B
(
sbi
,

533 
Ï¡_şu¡”
);

534 
šfo
->
gfi_high
.
fmr_Ëngth
 = 0;

537 
	`Œaû_ext4_fsm­_low_key
(
sb
, 
šfo
->
gfi_dev
, info->
gfi_agno
,

538 
šfo
->
gfi_low
.
fmr_physiÿl
,

539 
šfo
->
gfi_low
.
fmr_Ëngth
,

540 
šfo
->
gfi_low
.
fmr_owÃr
);

542 
	`Œaû_ext4_fsm­_high_key
(
sb
, 
šfo
->
gfi_dev
, info->
gfi_agno
,

543 
šfo
->
gfi_high
.
fmr_physiÿl
,

544 
šfo
->
gfi_high
.
fmr_Ëngth
,

545 
šfo
->
gfi_high
.
fmr_owÃr
);

547 
”rÜ
 = 
	`ext4_mb®loc_qu”y_¿nge
(
sb
, 
šfo
->
gfi_agno
,

548 
	`EXT4_B2C
(
sbi
, 
šfo
->
gfi_low
.
fmr_physiÿl
),

549 
	`EXT4_B2C
(
sbi
, 
šfo
->
gfi_high
.
fmr_physiÿl
),

550 
ext4_g‘fsm­_d©adev_h–³r
, 
šfo
);

551 ià(
”rÜ
)

552 
”r
;

558 ià(
šfo
->
gfi_agno
 =ğ
¡¬t_ag
)

559 
	`mem£t
(&
šfo
->
gfi_low
, 0, (info->gfi_low));

563 ià(
šfo
->
gfi_Ï¡ä“
.
fmr_owÃr
) {

564 
”rÜ
 = 
	`ext4_g‘fsm­_h–³r
(
sb
, 
šfo
, &šfo->
gfi_Ï¡ä“
);

565 ià(
”rÜ
)

566 
”r
;

570 
šfo
->
gfi_Ï¡
 = 
Œue
;

571 
”rÜ
 = 
	`ext4_g‘fsm­_d©adev_h–³r
(
sb
, 
’d_ag
, 
Ï¡_şu¡”
, 0, 
šfo
);

572 ià(
”rÜ
)

573 
”r
;

575 
”r
:

576 
	`ext4_g‘fsm­_ä“_fixed_m‘ad©a
(&
šfo
->
gfi_m‘a_li¡
);

577  
”rÜ
;

578 
	}
}

581 
boŞ
 
	$ext4_g‘fsm­_is_v®id_deviû
(
su³r_block
 *
sb
,

582 
ext4_fsm­
 *
fm
)

584 ià(
fm
->
fmr_deviû
 =ğ0 || fm->fmr_deviû =ğ
UINT_MAX
 ||

585 
fm
->
fmr_deviû
 =ğ
	`Ãw_’code_dev
(
sb
->
s_bdev
->
bd_dev
))

586  
Œue
;

587 ià(
	`EXT4_SB
(
sb
)->
jouº®_bdev
 &&

588 
fm
->
fmr_deviû
 =ğ
	`Ãw_’code_dev
(
	`EXT4_SB
(
sb
)->
jouº®_bdev
->
bd_dev
))

589  
Œue
;

590  
çl£
;

591 
	}
}

594 
boŞ
 
	$ext4_g‘fsm­_check_keys
(
ext4_fsm­
 *
low_key
,

595 
ext4_fsm­
 *
high_key
)

597 ià(
low_key
->
fmr_deviû
 > 
high_key
->fmr_device)

598  
çl£
;

599 ià(
low_key
->
fmr_deviû
 < 
high_key
->fmr_device)

600  
Œue
;

602 ià(
low_key
->
fmr_physiÿl
 > 
high_key
->fmr_physical)

603  
çl£
;

604 ià(
low_key
->
fmr_physiÿl
 < 
high_key
->fmr_physical)

605  
Œue
;

607 ià(
low_key
->
fmr_owÃr
 > 
high_key
->fmr_owner)

608  
çl£
;

609 ià(
low_key
->
fmr_owÃr
 < 
high_key
->fmr_owner)

610  
Œue
;

612  
çl£
;

613 
	}
}

615 
	#EXT4_GETFSMAP_DEVS
 2

	)

637 
	$ext4_g‘fsm­
(
su³r_block
 *
sb
, 
ext4_fsm­_h—d
 *
h—d
,

638 
ext4_fsm­_fÜm©_t
 
fÜm©‹r
, *
¬g
)

640 
ext4_fsm­
 
dkeys
[2];

641 
ext4_g‘fsm­_dev
 
hªdËrs
[
EXT4_GETFSMAP_DEVS
];

642 
ext4_g‘fsm­_šfo
 
šfo
 = {0};

643 
i
;

644 
”rÜ
 = 0;

646 ià(
h—d
->
fmh_iæags
 & ~
FMH_IF_VALID
)

647  -
EINVAL
;

648 ià(!
	`ext4_g‘fsm­_is_v®id_deviû
(
sb
, &
h—d
->
fmh_keys
[0]) ||

649 !
	`ext4_g‘fsm­_is_v®id_deviû
(
sb
, &
h—d
->
fmh_keys
[1]))

650  -
EINVAL
;

652 
h—d
->
fmh_’Œ›s
 = 0;

655 
	`mem£t
(
hªdËrs
, 0, (handlers));

656 
hªdËrs
[0].
gfd_dev
 = 
	`Ãw_’code_dev
(
sb
->
s_bdev
->
bd_dev
);

657 
hªdËrs
[0].
gfd_â
 = 
ext4_g‘fsm­_d©adev
;

658 ià(
	`EXT4_SB
(
sb
)->
jouº®_bdev
) {

659 
hªdËrs
[1].
gfd_dev
 = 
	`Ãw_’code_dev
(

660 
	`EXT4_SB
(
sb
)->
jouº®_bdev
->
bd_dev
);

661 
hªdËrs
[1].
gfd_â
 = 
ext4_g‘fsm­_logdev
;

664 
	`sÜt
(
hªdËrs
, 
EXT4_GETFSMAP_DEVS
, (
ext4_g‘fsm­_dev
),

665 
ext4_g‘fsm­_dev_com·»
, 
NULL
);

678 
dkeys
[0] = 
h—d
->
fmh_keys
[0];

679 
dkeys
[0].
fmr_physiÿl
 +ğdkeys[0].
fmr_Ëngth
;

680 
dkeys
[0].
fmr_owÃr
 = 0;

681 
dkeys
[0].
fmr_Ëngth
 = 0;

682 
	`mem£t
(&
dkeys
[1], 0xFF, (
ext4_fsm­
));

684 ià(!
	`ext4_g‘fsm­_check_keys
(
dkeys
, &
h—d
->
fmh_keys
[1]))

685  -
EINVAL
;

687 
šfo
.
gfi_Ãxt_fsblk
 = 
h—d
->
fmh_keys
[0].
fmr_physiÿl
 +

688 
h—d
->
fmh_keys
[0].
fmr_Ëngth
;

689 
šfo
.
gfi_fÜm©‹r
 = 
fÜm©‹r
;

690 
šfo
.
gfi_fÜm©_¬g
 = 
¬g
;

691 
šfo
.
gfi_h—d
 = 
h—d
;

694 
i
 = 0; i < 
EXT4_GETFSMAP_DEVS
; i++) {

696 ià(!
hªdËrs
[
i
].
gfd_â
)

698 ià(
h—d
->
fmh_keys
[0].
fmr_deviû
 > 
hªdËrs
[
i
].
gfd_dev
)

700 ià(
h—d
->
fmh_keys
[1].
fmr_deviû
 < 
hªdËrs
[
i
].
gfd_dev
)

710 ià(
hªdËrs
[
i
].
gfd_dev
 =ğ
h—d
->
fmh_keys
[1].
fmr_deviû
)

711 
dkeys
[1] = 
h—d
->
fmh_keys
[1];

712 ià(
hªdËrs
[
i
].
gfd_dev
 > 
h—d
->
fmh_keys
[0].
fmr_deviû
)

713 
	`mem£t
(&
dkeys
[0], 0, (
ext4_fsm­
));

715 
šfo
.
gfi_dev
 = 
hªdËrs
[
i
].
gfd_dev
;

716 
šfo
.
gfi_Ï¡
 = 
çl£
;

717 
šfo
.
gfi_agno
 = -1;

718 
”rÜ
 = 
hªdËrs
[
i
].
	`gfd_â
(
sb
, 
dkeys
, &
šfo
);

719 ià(
”rÜ
)

721 
šfo
.
gfi_Ãxt_fsblk
 = 0;

724 
h—d
->
fmh_oæags
 = 
FMH_OF_DEV_T
;

725  
”rÜ
;

726 
	}
}

	@fsmap.h

20 #iâdeà
__EXT4_FSMAP_H__


21 
	#__EXT4_FSMAP_H__


	)

23 
	gfsm­
;

26 
	sext4_fsm­
 {

27 
li¡_h—d
 
	mfmr_li¡
;

28 
dev_t
 
	mfmr_deviû
;

29 
ušt32_t
 
	mfmr_æags
;

30 
ušt64_t
 
	mfmr_physiÿl
;

31 
ušt64_t
 
	mfmr_owÃr
;

32 
ušt64_t
 
	mfmr_Ëngth
;

35 
	sext4_fsm­_h—d
 {

36 
ušt32_t
 
	mfmh_iæags
;

37 
ušt32_t
 
	mfmh_oæags
;

38 
	mfmh_couÁ
;

39 
	mfmh_’Œ›s
;

41 
ext4_fsm­
 
	mfmh_keys
[2];

44 
ext4_fsm­_äom_š‹º®
(
su³r_block
 *
sb
, 
fsm­
 *
de¡
,

45 
ext4_fsm­
 *
¤c
);

46 
ext4_fsm­_to_š‹º®
(
su³r_block
 *
sb
, 
ext4_fsm­
 *
de¡
,

47 
fsm­
 *
¤c
);

50 (*
	text4_fsm­_fÜm©_t
)(
	text4_fsm­
 *, *);

52 
	`ext4_g‘fsm­
(
su³r_block
 *
sb
, 
ext4_fsm­_h—d
 *
h—d
,

53 
ext4_fsm­_fÜm©_t
 
fÜm©‹r
, *
¬g
);

55 
	#EXT4_QUERY_RANGE_ABORT
 1

	)

56 
	#EXT4_QUERY_RANGE_CONTINUE
 0

	)

59 
	#EXT4_FMR_OWN_FREE
 
FMR_OWN_FREE


	)

60 
	#EXT4_FMR_OWN_UNKNOWN
 
FMR_OWN_UNKNOWN


	)

61 
	#EXT4_FMR_OWN_FS
 
	`FMR_OWNER
('X', 1è

	)

62 
	#EXT4_FMR_OWN_LOG
 
	`FMR_OWNER
('X', 2è

	)

63 
	#EXT4_FMR_OWN_INODES
 
	`FMR_OWNER
('X', 5è

	)

64 
	#EXT4_FMR_OWN_GDT
 
	`FMR_OWNER
('f', 1è

	)

65 
	#EXT4_FMR_OWN_RESV_GDT
 
	`FMR_OWNER
('f', 2è

	)

66 
	#EXT4_FMR_OWN_BLKBM
 
	`FMR_OWNER
('f', 3è

	)

67 
	#EXT4_FMR_OWN_INOBM
 
	`FMR_OWNER
('f', 4è

	)

	@fsync.c

25 
	~<lšux/time.h
>

26 
	~<lšux/fs.h
>

27 
	~<lšux/sched.h
>

28 
	~<lšux/wr™eback.h
>

29 
	~<lšux/blkdev.h
>

31 
	~"ext4.h
"

32 
	~"ext4_jbd2.h
"

34 
	~<Œaû/ev’ts/ext4.h
>

44 
	$ext4_sync_·»Á
(
šode
 *inode)

46 
d’Œy
 *d’Œy = 
NULL
;

47 
šode
 *
Ãxt
;

48 
»t
 = 0;

50 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEWENTRY
))

52 
šode
 = 
	`ig¿b
(inode);

53 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEWENTRY
)) {

54 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_NEWENTRY
);

55 
d’Œy
 = 
	`d_fšd_ªy_®Ÿs
(
šode
);

56 ià(!
d’Œy
)

58 
Ãxt
 = 
	`ig¿b
(
	`d_šode
(
d’Œy
->
d_·»Á
));

59 
	`dput
(
d’Œy
);

60 ià(!
Ãxt
)

62 
	`ut
(
šode
);

63 
šode
 = 
Ãxt
;

71 
»t
 = 
	`sync_m­pšg_bufãrs
(
šode
->
i_m­pšg
);

72 ià(
»t
)

74 
»t
 = 
	`sync_šode_m‘ad©a
(
šode
, 1);

75 ià(
»t
)

78 
	`ut
(
šode
);

79  
»t
;

80 
	}
}

94 
	$ext4_sync_fe
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
)

96 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

97 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

98 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
;

99 
»t
 = 0, 
”r
;

100 
tid_t
 
comm™_tid
;

101 
boŞ
 
Ãeds_b¬r›r
 = 
çl£
;

103 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

104  -
EIO
;

106 
	`J_ASSERT
(
	`ext4_jouº®_cu¼’t_hªdË
(è=ğ
NULL
);

108 
	`Œaû_ext4_sync_fe_’‹r
(
fe
, 
d©async
);

110 ià(
šode
->
i_sb
->
s_æags
 & 
MS_RDONLY
) {

112 
	`smp_rmb
();

113 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
)

114 
»t
 = -
EROFS
;

115 
out
;

118 ià(!
jouº®
) {

119 
»t
 = 
	`__g’”ic_fe_fsync
(
fe
, 
¡¬t
, 
’d
, 
d©async
);

120 ià(!
»t
)

121 
»t
 = 
	`ext4_sync_·»Á
(
šode
);

122 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
BARRIER
))

123 
issue_æush
;

124 
out
;

127 
»t
 = 
	`fe_wr™e_ªd_wa™_¿nge
(
fe
, 
¡¬t
, 
’d
);

128 ià(
»t
)

129  
»t
;

144 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

145 
»t
 = 
	`ext4_fÜû_comm™
(
šode
->
i_sb
);

146 
out
;

149 
comm™_tid
 = 
d©async
 ? 
ei
->
i_d©async_tid
 :ƒi->
i_sync_tid
;

150 ià(
jouº®
->
j_æags
 & 
JBD2_BARRIER
 &&

151 !
	`jbd2_Œªs_wl_£nd_d©a_b¬r›r
(
jouº®
, 
comm™_tid
))

152 
Ãeds_b¬r›r
 = 
Œue
;

153 
»t
 = 
	`ext4_fc_async_comm™_šode
(
jouº®
, 
comm™_tid
, 
šode
);

154 ià(
Ãeds_b¬r›r
) {

155 
issue_æush
:

156 
”r
 = 
	`blkdev_issue_æush
(
šode
->
i_sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

157 ià(!
»t
)

158 
»t
 = 
”r
;

160 
out
:

161 
	`Œaû_ext4_sync_fe_ex™
(
šode
, 
»t
);

162  
»t
;

163 
	}
}

165 
	$ext4_sync_fe_İt
(
fe
 *fe, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
)

167 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

168 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

169 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
;

170 
»t
 = 0, 
”r
;

171 
tid_t
 
comm™_tid
;

172 
boŞ
 
Ãeds_b¬r›r
 = 
çl£
;

174 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

175  -
EIO
;

177 
	`J_ASSERT
(
	`ext4_jouº®_cu¼’t_hªdË
(è=ğ
NULL
);

179 
	`Œaû_ext4_sync_fe_’‹r
(
fe
, 
d©async
);

181 ià(
šode
->
i_sb
->
s_æags
 & 
MS_RDONLY
) {

183 
	`smp_rmb
();

184 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
)

185 
»t
 = -
EROFS
;

186 
out
;

189 ià(!
jouº®
) {

190 
»t
 = 
	`__g’”ic_fe_fsync_İt
(
fe
, 
¡¬t
, 
’d
, 
d©async
);

191 ià(!
»t
)

192 
»t
 = 
	`ext4_sync_·»Á
(
šode
);

193 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
BARRIER
))

194 
issue_æush
;

195 
out
;

198 
»t
 = 
	`fe_wr™e_ªd_wa™_¿nge_İt
(
fe
, 
¡¬t
, 
’d
);

199 ià(
»t
)

200  
»t
;

215 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

216 
»t
 = 
	`ext4_fÜû_comm™
(
šode
->
i_sb
);

217 
out
;

220 
comm™_tid
 = 
d©async
 ? 
ei
->
i_d©async_tid
 :ƒi->
i_sync_tid
;

221 ià(
jouº®
->
j_æags
 & 
JBD2_BARRIER
 &&

222 !
	`jbd2_Œªs_wl_£nd_d©a_b¬r›r
(
jouº®
, 
comm™_tid
))

223 
Ãeds_b¬r›r
 = 
Œue
;

224 
»t
 = 
	`jbd2_com¶‘e_Œª§ùiÚ
(
jouº®
, 
comm™_tid
);

225 ià(
Ãeds_b¬r›r
) {

226 
issue_æush
:

227 
”r
 = 
	`blkdev_issue_æush
(
šode
->
i_sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

228 ià(!
»t
)

229 
»t
 = 
”r
;

231 
out
:

232 
	`Œaû_ext4_sync_fe_ex™
(
šode
, 
»t
);

233  
»t
;

234 
	}
}

	@hash.c

12 
	~<lšux/fs.h
>

13 
	~<lšux/comp”.h
>

14 
	~<lšux/b™İs.h
>

15 
	~"ext4.h
"

17 
	#DELTA
 0x9E3779B9

	)

19 
	$TEA_ŒªsfÜm
(
__u32
 
buf
[4], __u32 cÚ¡ 
š
[])

21 
__u32
 
sum
 = 0;

22 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

23 
__u32
 
a
 = 
š
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

24 
n
 = 16;

27 
sum
 +ğ
DELTA
;

28 
b0
 +ğ((
b1
 << 4)+
a
è^ (b1+
sum
è^ ((b1 >> 5)+
b
);

29 
b1
 +ğ((
b0
 << 4)+
c
è^ (b0+
sum
è^ ((b0 >> 5)+
d
);

30 } --
n
);

32 
buf
[0] +ğ
b0
;

33 
buf
[1] +ğ
b1
;

34 
	}
}

37 
	#F
(
x
, 
y
, 
z
è((zè^ ((xè& ((yè^ (z))))

	)

38 
	#G
(
x
, 
y
, 
z
è(((xè& (y)è+ (((xè^ (y)è& (z)))

	)

39 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

47 
	#ROUND
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
s
) \

48 (
a
 +ğ
	`f
(
b
, 
c
, 
d
è+ 
x
,‡ = 
	`rŞ32
×, 
s
))

	)

49 
	#K1
 0

	)

50 
	#K2
 013240474631UL

	)

51 
	#K3
 015666365641UL

	)

56 
__u32
 
	$h®f_md4_ŒªsfÜm
(
__u32
 
buf
[4], __u32 cÚ¡ 
š
[8])

58 
__u32
 
a
 = 
buf
[0], 
b
 = buf[1], 
c
 = buf[2], 
d
 = buf[3];

61 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 
K1
, 3);

62 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
š
[1] + 
K1
, 7);

63 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 
K1
, 11);

64 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
š
[3] + 
K1
, 19);

65 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
š
[4] + 
K1
, 3);

66 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
š
[5] + 
K1
, 7);

67 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
š
[6] + 
K1
, 11);

68 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
š
[7] + 
K1
, 19);

71 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 
K2
, 3);

72 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
š
[3] + 
K2
, 5);

73 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
š
[5] + 
K2
, 9);

74 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
š
[7] + 
K2
, 13);

75 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 
K2
, 3);

76 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
š
[2] + 
K2
, 5);

77 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
š
[4] + 
K2
, 9);

78 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
š
[6] + 
K2
, 13);

81 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
š
[3] + 
K3
, 3);

82 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
š
[7] + 
K3
, 9);

83 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 
K3
, 11);

84 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
š
[6] + 
K3
, 15);

85 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 
K3
, 3);

86 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
š
[5] + 
K3
, 9);

87 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
š
[0] + 
K3
, 11);

88 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
š
[4] + 
K3
, 15);

90 
buf
[0] +ğ
a
;

91 
buf
[1] +ğ
b
;

92 
buf
[2] +ğ
c
;

93 
buf
[3] +ğ
d
;

95  
buf
[1];

96 
	}
}

97 #undeà
ROUND


98 #undeà
K1


99 #undeà
K2


100 #undeà
K3


101 #undeà
F


102 #undeà
G


103 #undeà
H


106 
__u32
 
	$dx_hack_hash_unsigÃd
(cÚ¡ *
Çme
, 
Ën
)

108 
__u32
 
hash
, 
hash0
 = 0x12a3ã2d, 
hash1
 = 0x37abe8f9;

109 cÚ¡ *
uı
 = (cÚ¡ *è
Çme
;

111 
Ën
--) {

112 
hash
 = 
hash1
 + (
hash0
 ^ (((è*
uı
++) * 7152373));

114 ià(
hash
 & 0x80000000)

115 
hash
 -= 0x7fffffff;

116 
hash1
 = 
hash0
;

117 
hash0
 = 
hash
;

119  
hash0
 << 1;

120 
	}
}

122 
__u32
 
	$dx_hack_hash_sigÃd
(cÚ¡ *
Çme
, 
Ën
)

124 
__u32
 
hash
, 
hash0
 = 0x12a3ã2d, 
hash1
 = 0x37abe8f9;

125 cÚ¡ sigÃd *
sı
 = (cÚ¡ sigÃd *è
Çme
;

127 
Ën
--) {

128 
hash
 = 
hash1
 + (
hash0
 ^ (((è*
sı
++) * 7152373));

130 ià(
hash
 & 0x80000000)

131 
hash
 -= 0x7fffffff;

132 
hash1
 = 
hash0
;

133 
hash0
 = 
hash
;

135  
hash0
 << 1;

136 
	}
}

138 
	$¡r2hashbuf_sigÃd
(cÚ¡ *
msg
, 
Ën
, 
__u32
 *
buf
, 
num
)

140 
__u32
 
·d
, 
v®
;

141 
i
;

142 cÚ¡ sigÃd *
sı
 = (cÚ¡ sigÃd *è
msg
;

144 
·d
 = (
__u32
)
Ën
 | ((__u32)len << 8);

145 
·d
 |=…ad << 16;

147 
v®
 = 
·d
;

148 ià(
Ën
 > 
num
*4)

149 
Ën
 = 
num
 * 4;

150 
i
 = 0; i < 
Ën
; i++) {

151 ià((
i
 % 4) == 0)

152 
v®
 = 
·d
;

153 
v®
 = ((è
sı
[
i
]) + (val << 8);

154 ià((
i
 % 4) == 3) {

155 *
buf
++ = 
v®
;

156 
v®
 = 
·d
;

157 
num
--;

160 ià(--
num
 >= 0)

161 *
buf
++ = 
v®
;

162 --
num
 >= 0)

163 *
buf
++ = 
·d
;

164 
	}
}

166 
	$¡r2hashbuf_unsigÃd
(cÚ¡ *
msg
, 
Ën
, 
__u32
 *
buf
, 
num
)

168 
__u32
 
·d
, 
v®
;

169 
i
;

170 cÚ¡ *
uı
 = (cÚ¡ *è
msg
;

172 
·d
 = (
__u32
)
Ën
 | ((__u32)len << 8);

173 
·d
 |=…ad << 16;

175 
v®
 = 
·d
;

176 ià(
Ën
 > 
num
*4)

177 
Ën
 = 
num
 * 4;

178 
i
 = 0; i < 
Ën
; i++) {

179 ià((
i
 % 4) == 0)

180 
v®
 = 
·d
;

181 
v®
 = ((è
uı
[
i
]) + (val << 8);

182 ià((
i
 % 4) == 3) {

183 *
buf
++ = 
v®
;

184 
v®
 = 
·d
;

185 
num
--;

188 ià(--
num
 >= 0)

189 *
buf
++ = 
v®
;

190 --
num
 >= 0)

191 *
buf
++ = 
·d
;

192 
	}
}

207 
	$ext4fs_dœhash
(cÚ¡ *
Çme
, 
Ën
, 
dx_hash_šfo
 *
hšfo
)

209 
__u32
 
hash
;

210 
__u32
 
mšÜ_hash
 = 0;

211 cÚ¡ *
p
;

212 
i
;

213 
__u32
 
š
[8], 
buf
[4];

214 (*
¡r2hashbuf
)(cÚ¡ *, , 
__u32
 *, ) =

215 
¡r2hashbuf_sigÃd
;

218 
buf
[0] = 0x67452301;

219 
buf
[1] = 0xefcdab89;

220 
buf
[2] = 0x98badcfe;

221 
buf
[3] = 0x10325476;

224 ià(
hšfo
->
£ed
) {

225 
i
 = 0; i < 4; i++) {

226 ià(
hšfo
->
£ed
[
i
]) {

227 
	`memıy
(
buf
, 
hšfo
->
£ed
, (buf));

233 
hšfo
->
hash_v”siÚ
) {

234 
DX_HASH_LEGACY_UNSIGNED
:

235 
hash
 = 
	`dx_hack_hash_unsigÃd
(
Çme
, 
Ën
);

237 
DX_HASH_LEGACY
:

238 
hash
 = 
	`dx_hack_hash_sigÃd
(
Çme
, 
Ën
);

240 
DX_HASH_HALF_MD4_UNSIGNED
:

241 
¡r2hashbuf
 = 
¡r2hashbuf_unsigÃd
;

242 
DX_HASH_HALF_MD4
:

243 
p
 = 
Çme
;

244 
Ën
 > 0) {

245 (*
¡r2hashbuf
)(
p
, 
Ën
, 
š
, 8);

246 
	`h®f_md4_ŒªsfÜm
(
buf
, 
š
);

247 
Ën
 -= 32;

248 
p
 += 32;

250 
mšÜ_hash
 = 
buf
[2];

251 
hash
 = 
buf
[1];

253 
DX_HASH_TEA_UNSIGNED
:

254 
¡r2hashbuf
 = 
¡r2hashbuf_unsigÃd
;

255 
DX_HASH_TEA
:

256 
p
 = 
Çme
;

257 
Ën
 > 0) {

258 (*
¡r2hashbuf
)(
p
, 
Ën
, 
š
, 4);

259 
	`TEA_ŒªsfÜm
(
buf
, 
š
);

260 
Ën
 -= 16;

261 
p
 += 16;

263 
hash
 = 
buf
[0];

264 
mšÜ_hash
 = 
buf
[1];

267 
hšfo
->
hash
 = 0;

270 
hash
 = hash & ~1;

271 ià(
hash
 =ğ(
EXT4_HTREE_EOF_32BIT
 << 1))

272 
hash
 = (
EXT4_HTREE_EOF_32BIT
 - 1) << 1;

273 
hšfo
->
hash
 = hash;

274 
hšfo
->
mšÜ_hash
 = minor_hash;

276 
	}
}

	@ialloc.c

15 
	~<lšux/time.h
>

16 
	~<lšux/fs.h
>

17 
	~<lšux/¡©.h
>

18 
	~<lšux/¡ršg.h
>

19 
	~<lšux/quÙaİs.h
>

20 
	~<lšux/bufãr_h—d.h
>

21 
	~<lšux/¿ndom.h
>

22 
	~<lšux/b™İs.h
>

23 
	~<lšux/blkdev.h
>

24 
	~<lšux/üed.h
>

26 
	~<asm/by‹Üd”.h
>

28 
	~"ext4.h
"

29 
	~"ext4_jbd2.h
"

30 
	~"x©Œ.h
"

31 
	~"aş.h
"

33 
	~<Œaû/ev’ts/ext4.h
>

54 
	$ext4_m¬k_b™m­_’d
(
¡¬t_b™
, 
’d_b™
, *
b™m­
)

56 
i
;

58 ià(
¡¬t_b™
 >ğ
’d_b™
)

61 
	`ext4_debug
("m¬kƒnd b™ +%dhrough +%d u£d\n", 
¡¬t_b™
, 
’d_b™
);

62 
i
 = 
¡¬t_b™
; i < ((start_bit + 7) & ~7UL); i++)

63 
	`ext4_£t_b™
(
i
, 
b™m­
);

64 ià(
i
 < 
’d_b™
)

65 
	`mem£t
(
b™m­
 + (
i
 >> 3), 0xff, (
’d_b™
 - i) >> 3);

66 
	}
}

69 
	$ext4_š™_šode_b™m­
(
su³r_block
 *
sb
,

70 
bufãr_h—d
 *
bh
,

71 
ext4_group_t
 
block_group
,

72 
ext4_group_desc
 *
gdp
)

74 
ext4_group_šfo
 *
g½
;

75 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

76 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_locked
(bh));

80 ià(!
	`ext4_group_desc_csum_v”ify
(
sb
, 
block_group
, 
gdp
)) {

81 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
);

82 ià(!
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
))

83 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

84 
g½
->
bb_ä“
);

85 
	`£t_b™
(
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &
g½
->
bb_¡©e
);

86 ià(!
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
)) {

87 
couÁ
;

88 
couÁ
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
);

89 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“šodes_couÁ”
,

90 
couÁ
);

92 
	`£t_b™
(
EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &
g½
->
bb_¡©e
);

93  -
EFSBADCRC
;

96 
	`mem£t
(
bh
->
b_d©a
, 0, (
	`EXT4_INODES_PER_GROUP
(
sb
) + 7) / 8);

97 
	`ext4_m¬k_b™m­_’d
(
	`EXT4_INODES_PER_GROUP
(
sb
), sb->
s_blocksize
 * 8,

98 
bh
->
b_d©a
);

99 
	`ext4_šode_b™m­_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bh
,

100 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

101 
	`ext4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

104 
	}
}

106 
	$ext4_’d_b™m­_»ad
(
bufãr_h—d
 *
bh
, 
u±od©e
)

108 ià(
u±od©e
) {

109 
	`£t_bufãr_u±od©e
(
bh
);

110 
	`£t_b™m­_u±od©e
(
bh
);

112 
	`uÆock_bufãr
(
bh
);

113 
	`put_bh
(
bh
);

114 
	}
}

116 
	$ext4_v®id©e_šode_b™m­
(
su³r_block
 *
sb
,

117 
ext4_group_desc
 *
desc
,

118 
ext4_group_t
 
block_group
,

119 
bufãr_h—d
 *
bh
)

121 
ext4_fsblk_t
 
blk
;

122 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
);

123 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

125 ià(
	`bufãr_v”if›d
(
bh
))

127 ià(
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
))

128  -
EFSCORRUPTED
;

130 
	`ext4_lock_group
(
sb
, 
block_group
);

131 
blk
 = 
	`ext4_šode_b™m­
(
sb
, 
desc
);

132 ià(!
	`ext4_šode_b™m­_csum_v”ify
(
sb
, 
block_group
, 
desc
, 
bh
,

133 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8)) {

134 
	`ext4_uÆock_group
(
sb
, 
block_group
);

135 
	`ext4_”rÜ
(
sb
, "Corrupt inode bitmap - block_group = %u, "

136 "šode_b™m­ = %Îu", 
block_group
, 
blk
);

137 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
);

138 ià(!
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
)) {

139 
couÁ
;

140 
couÁ
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
desc
);

141 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“šodes_couÁ”
,

142 
couÁ
);

144 
	`£t_b™
(
EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &
g½
->
bb_¡©e
);

145  -
EFSBADCRC
;

147 
	`£t_bufãr_v”if›d
(
bh
);

148 
	`ext4_uÆock_group
(
sb
, 
block_group
);

150 
	}
}

158 
bufãr_h—d
 *

159 
	$ext4_»ad_šode_b™m­
(
su³r_block
 *
sb
, 
ext4_group_t
 
block_group
)

161 
ext4_group_desc
 *
desc
;

162 
bufãr_h—d
 *
bh
 = 
NULL
;

163 
ext4_fsblk_t
 
b™m­_blk
;

164 
”r
;

166 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, 
NULL
);

167 ià(!
desc
)

168  
	`ERR_PTR
(-
EFSCORRUPTED
);

170 
b™m­_blk
 = 
	`ext4_šode_b™m­
(
sb
, 
desc
);

171 
bh
 = 
	`sb_g‘blk
(
sb
, 
b™m­_blk
);

172 ià(
	`uÆik–y
(!
bh
)) {

173 
	`ext4_”rÜ
(
sb
, "Cannot„ead inode bitmap - "

175 
block_group
, 
b™m­_blk
);

176  
	`ERR_PTR
(-
EIO
);

178 ià(
	`b™m­_u±od©e
(
bh
))

179 
v”ify
;

181 
	`lock_bufãr
(
bh
);

182 ià(
	`b™m­_u±od©e
(
bh
)) {

183 
	`uÆock_bufãr
(
bh
);

184 
v”ify
;

187 
	`ext4_lock_group
(
sb
, 
block_group
);

188 ià(
desc
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_UNINIT
)) {

189 
”r
 = 
	`ext4_š™_šode_b™m­
(
sb
, 
bh
, 
block_group
, 
desc
);

190 
	`£t_b™m­_u±od©e
(
bh
);

191 
	`£t_bufãr_u±od©e
(
bh
);

192 
	`£t_bufãr_v”if›d
(
bh
);

193 
	`ext4_uÆock_group
(
sb
, 
block_group
);

194 
	`uÆock_bufãr
(
bh
);

195 ià(
”r
) {

196 
	`ext4_”rÜ
(
sb
, "Failedo init inode bitmap for group "

197 "%u: %d", 
block_group
, 
”r
);

198 
out
;

200  
bh
;

202 
	`ext4_uÆock_group
(
sb
, 
block_group
);

204 ià(
	`bufãr_u±od©e
(
bh
)) {

209 
	`£t_b™m­_u±od©e
(
bh
);

210 
	`uÆock_bufãr
(
bh
);

211 
v”ify
;

216 
	`Œaû_ext4_lßd_šode_b™m­
(
sb
, 
block_group
);

217 
bh
->
b_’d_io
 = 
ext4_’d_b™m­_»ad
;

218 
	`g‘_bh
(
bh
);

219 
	`subm™_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

220 
	`wa™_Ú_bufãr
(
bh
);

221 ià(!
	`bufãr_u±od©e
(
bh
)) {

222 
	`put_bh
(
bh
);

223 
	`ext4_”rÜ
(
sb
, "Cannot„ead inode bitmap - "

225 
block_group
, 
b™m­_blk
);

226  
	`ERR_PTR
(-
EIO
);

229 
v”ify
:

230 
”r
 = 
	`ext4_v®id©e_šode_b™m­
(
sb
, 
desc
, 
block_group
, 
bh
);

231 ià(
”r
)

232 
out
;

233  
bh
;

234 
out
:

235 
	`put_bh
(
bh
);

236  
	`ERR_PTR
(
”r
);

237 
	}
}

255 
	$ext4_ä“_šode
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

257 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

258 
is_dœeùÜy
;

259 
šo
;

260 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

261 
bufãr_h—d
 *
bh2
;

262 
ext4_group_t
 
block_group
;

263 
b™
;

264 
ext4_group_desc
 *
gdp
;

265 
ext4_su³r_block
 *
es
;

266 
ext4_sb_šfo
 *
sbi
;

267 
çl
 = 0, 
”r
, 
couÁ
, 
ş—»d
;

268 
ext4_group_šfo
 *
g½
;

270 ià(!
sb
) {

271 
	`´štk
(
KERN_ERR
 "EXT4-fs: %s:%d: inode on "

272 "nÚexi¡’ˆdeviû\n", 
__func__
, 
__LINE__
);

275 ià(
	`©omic_»ad
(&
šode
->
i_couÁ
) > 1) {

276 
	`ext4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: count=%d",

277 
__func__
, 
__LINE__
, 
šode
->
i_šo
,

278 
	`©omic_»ad
(&
šode
->
i_couÁ
));

281 ià(
šode
->
i_Æšk
) {

282 
	`ext4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu:‚link=%d\n",

283 
__func__
, 
__LINE__
, 
šode
->
i_šo
, inode->
i_Æšk
);

286 
sbi
 = 
	`EXT4_SB
(
sb
);

288 
šo
 = 
šode
->
i_šo
;

289 
	`ext4_debug
("ä“šg inod%lu\n", 
šo
);

290 
	`Œaû_ext4_ä“_šode
(
šode
);

296 
	`dquÙ_š™Ÿlize
(
šode
);

297 
	`dquÙ_ä“_šode
(
šode
);

298 
	`dquÙ_drİ
(
šode
);

300 
is_dœeùÜy
 = 
	`S_ISDIR
(
šode
->
i_mode
);

303 
	`ext4_ş—r_šode
(
šode
);

305 
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

306 ià(
šo
 < 
	`EXT4_FIRST_INO
(
sb
è|| inØ> 
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
)) {

307 
	`ext4_”rÜ
(
sb
, "»£rved o¸nÚexi¡’ˆšod%lu", 
šo
);

308 
”rÜ_»tuº
;

310 
block_group
 = (
šo
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(
sb
);

311 
b™
 = (
šo
 - 1è% 
	`EXT4_INODES_PER_GROUP
(
sb
);

312 
b™m­_bh
 = 
	`ext4_»ad_šode_b™m­
(
sb
, 
block_group
);

314 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
);

315 ià(
	`IS_ERR
(
b™m­_bh
)) {

316 
çl
 = 
	`PTR_ERR
(
b™m­_bh
);

317 
b™m­_bh
 = 
NULL
;

318 
”rÜ_»tuº
;

320 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
))) {

321 
çl
 = -
EFSCORRUPTED
;

322 
”rÜ_»tuº
;

325 
	`BUFFER_TRACE
(
b™m­_bh
, "get_write_access");

326 
çl
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
b™m­_bh
);

327 ià(
çl
)

328 
”rÜ_»tuº
;

330 
çl
 = -
ESRCH
;

331 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, &
bh2
);

332 ià(
gdp
) {

333 
	`BUFFER_TRACE
(
bh2
, "get_write_access");

334 
çl
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh2
);

336 
	`ext4_lock_group
(
sb
, 
block_group
);

337 
ş—»d
 = 
	`ext4_‹¡_ªd_ş—r_b™
(
b™
, 
b™m­_bh
->
b_d©a
);

338 ià(
çl
 || !
ş—»d
) {

339 
	`ext4_uÆock_group
(
sb
, 
block_group
);

340 
out
;

343 
couÁ
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
) + 1;

344 
	`ext4_ä“_šodes_£t
(
sb
, 
gdp
, 
couÁ
);

345 ià(
is_dœeùÜy
) {

346 
couÁ
 = 
	`ext4_u£d_dœs_couÁ
(
sb
, 
gdp
) - 1;

347 
	`ext4_u£d_dœs_£t
(
sb
, 
gdp
, 
couÁ
);

348 
	`³rıu_couÁ”_dec
(&
sbi
->
s_dœs_couÁ”
);

350 
	`ext4_šode_b™m­_csum_£t
(
sb
, 
block_group
, 
gdp
, 
b™m­_bh
,

351 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

352 
	`ext4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

353 
	`ext4_uÆock_group
(
sb
, 
block_group
);

355 
	`³rıu_couÁ”_šc
(&
sbi
->
s_ä“šodes_couÁ”
);

356 ià(
sbi
->
s_log_groups_³r_æex
) {

357 
ext4_group_t
 
f
 = 
	`ext4_æex_group
(
sbi
, 
block_group
);

359 
	`©omic_šc
(&
sbi
->
s_æex_groups
[
f
].
ä“_šodes
);

360 ià(
is_dœeùÜy
)

361 
	`©omic_dec
(&
sbi
->
s_æex_groups
[
f
].
u£d_dœs
);

363 
	`BUFFER_TRACE
(
bh2
, "callƒxt4_handle_dirty_metadata");

364 
çl
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh2
);

365 
out
:

366 ià(
ş—»d
) {

367 
	`BUFFER_TRACE
(
b™m­_bh
, "callƒxt4_handle_dirty_metadata");

368 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

369 ià(!
çl
)

370 
çl
 = 
”r
;

372 
	`ext4_”rÜ
(
sb
, "b™‡Ì—dy cË¬ed fÜ inod%lu", 
šo
);

373 ià(
gdp
 && !
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
)) {

374 
couÁ
;

375 
couÁ
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
);

376 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“šodes_couÁ”
,

377 
couÁ
);

379 
	`£t_b™
(
EXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &
g½
->
bb_¡©e
);

382 
”rÜ_»tuº
:

383 
	`b»l£
(
b™m­_bh
);

384 
	`ext4_¡d_”rÜ
(
sb
, 
çl
);

385 
	}
}

387 
	sÜlov_¡©s
 {

388 
__u64
 
	mä“_şu¡”s
;

389 
__u32
 
	mä“_šodes
;

390 
__u32
 
	mu£d_dœs
;

398 
	$g‘_Ülov_¡©s
(
su³r_block
 *
sb
, 
ext4_group_t
 
g
,

399 
æex_size
, 
Ülov_¡©s
 *
¡©s
)

401 
ext4_group_desc
 *
desc
;

402 
æex_groups
 *
æex_group
 = 
	`EXT4_SB
(
sb
)->
s_æex_groups
;

404 ià(
æex_size
 > 1) {

405 
¡©s
->
ä“_šodes
 = 
	`©omic_»ad
(&
æex_group
[
g
].free_inodes);

406 
¡©s
->
ä“_şu¡”s
 = 
	`©omic64_»ad
(&
æex_group
[
g
].free_clusters);

407 
¡©s
->
u£d_dœs
 = 
	`©omic_»ad
(&
æex_group
[
g
].used_dirs);

411 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
g
, 
NULL
);

412 ià(
desc
) {

413 
¡©s
->
ä“_šodes
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
desc
);

414 
¡©s
->
ä“_şu¡”s
 = 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
);

415 
¡©s
->
u£d_dœs
 = 
	`ext4_u£d_dœs_couÁ
(
sb
, 
desc
);

417 
¡©s
->
ä“_šodes
 = 0;

418 
¡©s
->
ä“_şu¡”s
 = 0;

419 
¡©s
->
u£d_dœs
 = 0;

421 
	}
}

444 
	$fšd_group_Ülov
(
su³r_block
 *
sb
, 
šode
 *
·»Á
,

445 
ext4_group_t
 *
group
, 
umode_t
 
mode
,

446 cÚ¡ 
q¡r
 *qstr)

448 
ext4_group_t
 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_block_group
;

449 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

450 
ext4_group_t
 
»®_ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

451 
šodes_³r_group
 = 
	`EXT4_INODES_PER_GROUP
(
sb
);

452 
ä“i
, 
aveä“i
, 
g½_ä“
;

453 
ext4_fsblk_t
 
ä“b
, 
aveä“c
;

454 
ndœs
;

455 
max_dœs
, 
mš_šodes
;

456 
ext4_g½blk_t
 
mš_şu¡”s
;

457 
ext4_group_t
 
i
, 
g½
, 
g
, 
ngroups
;

458 
ext4_group_desc
 *
desc
;

459 
Ülov_¡©s
 
¡©s
;

460 
æex_size
 = 
	`ext4_æex_bg_size
(
sbi
);

461 
dx_hash_šfo
 
hšfo
;

463 
ngroups
 = 
»®_ngroups
;

464 ià(
æex_size
 > 1) {

465 
ngroups
 = (
»®_ngroups
 + 
æex_size
 - 1) >>

466 
sbi
->
s_log_groups_³r_æex
;

467 
·»Á_group
 >>ğ
sbi
->
s_log_groups_³r_æex
;

470 
ä“i
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_ä“šodes_couÁ”
);

471 
aveä“i
 = 
ä“i
 / 
ngroups
;

472 
ä“b
 = 
	`EXT4_C2B
(
sbi
,

473 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_ä“şu¡”s_couÁ”
));

474 
aveä“c
 = 
ä“b
;

475 
	`do_div
(
aveä“c
, 
ngroups
);

476 
ndœs
 = 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_dœs_couÁ”
);

478 ià(
	`S_ISDIR
(
mode
) &&

479 ((
·»Á
 =ğ
	`d_šode
(
sb
->
s_roÙ
)) ||

480 (
	`ext4_‹¡_šode_æag
(
·»Á
, 
EXT4_INODE_TOPDIR
)))) {

481 
be¡_ndœ
 = 
šodes_³r_group
;

482 
»t
 = -1;

484 ià(
q¡r
) {

485 
hšfo
.
hash_v”siÚ
 = 
DX_HASH_HALF_MD4
;

486 
hšfo
.
£ed
 = 
sbi
->
s_hash_£ed
;

487 
	`ext4fs_dœhash
(
q¡r
->
Çme
, q¡r->
Ën
, &
hšfo
);

488 
g½
 = 
hšfo
.
hash
;

490 
g½
 = 
	`´ªdom_u32
();

491 
·»Á_group
 = ()
g½
 % 
ngroups
;

492 
i
 = 0; i < 
ngroups
; i++) {

493 
g
 = (
·»Á_group
 + 
i
è% 
ngroups
;

494 
	`g‘_Ülov_¡©s
(
sb
, 
g
, 
æex_size
, &
¡©s
);

495 ià(!
¡©s
.
ä“_šodes
)

497 ià(
¡©s
.
u£d_dœs
 >ğ
be¡_ndœ
)

499 ià(
¡©s
.
ä“_šodes
 < 
aveä“i
)

501 ià(
¡©s
.
ä“_şu¡”s
 < 
aveä“c
)

503 
g½
 = 
g
;

504 
»t
 = 0;

505 
be¡_ndœ
 = 
¡©s
.
u£d_dœs
;

507 ià(
»t
)

508 
çÎback
;

509 
found_æex_bg
:

510 ià(
æex_size
 == 1) {

511 *
group
 = 
g½
;

522 
g½
 *ğ
æex_size
;

523 
i
 = 0; i < 
æex_size
; i++) {

524 ià(
g½
+
i
 >ğ
»®_ngroups
)

526 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
g½
+
i
, 
NULL
);

527 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc)) {

528 *
group
 = 
g½
+
i
;

532 
çÎback
;

535 
max_dœs
 = 
ndœs
 / 
ngroups
 + 
šodes_³r_group
 / 16;

536 
mš_šodes
 = 
aveä“i
 - 
šodes_³r_group
*
æex_size
 / 4;

537 ià(
mš_šodes
 < 1)

538 
mš_šodes
 = 1;

539 
mš_şu¡”s
 = 
aveä“c
 - 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
)*
æex_size
 / 4;

545 ià(
	`EXT4_I
(
·»Á
)->
i_Ï¡_®loc_group
 != ~0) {

546 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_Ï¡_®loc_group
;

547 ià(
æex_size
 > 1)

548 
·»Á_group
 >>ğ
sbi
->
s_log_groups_³r_æex
;

551 
i
 = 0; i < 
ngroups
; i++) {

552 
g½
 = (
·»Á_group
 + 
i
è% 
ngroups
;

553 
	`g‘_Ülov_¡©s
(
sb
, 
g½
, 
æex_size
, &
¡©s
);

554 ià(
¡©s
.
u£d_dœs
 >ğ
max_dœs
)

556 ià(
¡©s
.
ä“_šodes
 < 
mš_šodes
)

558 ià(
¡©s
.
ä“_şu¡”s
 < 
mš_şu¡”s
)

560 
found_æex_bg
;

563 
çÎback
:

564 
ngroups
 = 
»®_ngroups
;

565 
aveä“i
 = 
ä“i
 / 
ngroups
;

566 
çÎback_»Œy
:

567 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_block_group
;

568 
i
 = 0; i < 
ngroups
; i++) {

569 
g½
 = (
·»Á_group
 + 
i
è% 
ngroups
;

570 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
g½
, 
NULL
);

571 ià(
desc
) {

572 
g½_ä“
 = 
	`ext4_ä“_šodes_couÁ
(
sb
, 
desc
);

573 ià(
g½_ä“
 && g½_ä“ >ğ
aveä“i
) {

574 *
group
 = 
g½
;

580 ià(
aveä“i
) {

585 
aveä“i
 = 0;

586 
çÎback_»Œy
;

590 
	}
}

592 
	$fšd_group_Ùh”
(
su³r_block
 *
sb
, 
šode
 *
·»Á
,

593 
ext4_group_t
 *
group
, 
umode_t
 
mode
)

595 
ext4_group_t
 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_block_group
;

596 
ext4_group_t
 
i
, 
Ï¡
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

597 
ext4_group_desc
 *
desc
;

598 
æex_size
 = 
	`ext4_æex_bg_size
(
	`EXT4_SB
(
sb
));

607 ià(
æex_size
 > 1) {

608 
»Œy
 = 0;

610 
Œy_agaš
:

611 
·»Á_group
 &ğ~(
æex_size
-1);

612 
Ï¡
 = 
·»Á_group
 + 
æex_size
;

613 ià(
Ï¡
 > 
ngroups
)

614 
Ï¡
 = 
ngroups
;

615 
i
 = 
·»Á_group
; i < 
Ï¡
; i++) {

616 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

617 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc)) {

618 *
group
 = 
i
;

622 ià(!
»Œy
 && 
	`EXT4_I
(
·»Á
)->
i_Ï¡_®loc_group
 != ~0) {

623 
»Œy
 = 1;

624 
·»Á_group
 = 
	`EXT4_I
(
·»Á
)->
i_Ï¡_®loc_group
;

625 
Œy_agaš
;

632 *
group
 = 
·»Á_group
 + 
æex_size
;

633 ià(*
group
 > 
ngroups
)

634 *
group
 = 0;

635  
	`fšd_group_Ülov
(
sb
, 
·»Á
, 
group
, 
mode
, 
NULL
);

641 *
group
 = 
·»Á_group
;

642 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, *
group
, 
NULL
);

643 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc) &&

644 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
))

656 *
group
 = (*grou°+ 
·»Á
->
i_šo
è% 
ngroups
;

662 
i
 = 1; i < 
ngroups
; i <<= 1) {

663 *
group
 +ğ
i
;

664 ià(*
group
 >ğ
ngroups
)

665 *
group
 -ğ
ngroups
;

666 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, *
group
, 
NULL
);

667 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc) &&

668 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
))

676 *
group
 = 
·»Á_group
;

677 
i
 = 0; i < 
ngroups
; i++) {

678 ià(++*
group
 >ğ
ngroups
)

679 *
group
 = 0;

680 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, *
group
, 
NULL
);

681 ià(
desc
 && 
	`ext4_ä“_šodes_couÁ
(
sb
, desc))

686 
	}
}

694 
	#RECENTCY_MIN
 5

	)

695 
	#RECENTCY_DIRTY
 30

	)

697 
	$»ûÁly_d–‘ed
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
, 
šo
)

699 
ext4_group_desc
 *
gdp
;

700 
ext4_šode
 *
¿w_šode
;

701 
bufãr_h—d
 *
bh
;

702 
dtime
, 
now
;

703 
šodes_³r_block
 = 
	`EXT4_SB
(
sb
)->
s_šodes_³r_block
;

704 
off£t
, 
»t
 = 0, 
»ûÁcy
 = 
RECENTCY_MIN
;

706 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, 
NULL
);

707 ià(
	`uÆik–y
(!
gdp
))

710 
bh
 = 
	`sb_g‘blk
(
sb
, 
	`ext4_šode_bË
(sb, 
gdp
) +

711 (
šo
 / 
šodes_³r_block
));

712 ià(
	`uÆik–y
(!
bh
è|| !
	`bufãr_u±od©e
(bh))

717 
out
;

719 
off£t
 = (
šo
 % 
šodes_³r_block
è* 
	`EXT4_INODE_SIZE
(
sb
);

720 
¿w_šode
 = (
ext4_šode
 *è(
bh
->
b_d©a
 + 
off£t
);

721 
dtime
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_dtime
);

722 
now
 = 
	`g‘_£cÚds
();

723 ià(
	`bufãr_dœty
(
bh
))

724 
»ûÁcy
 +ğ
RECENTCY_DIRTY
;

726 ià(
dtime
 && (dtim< 
now
è&& (now < dtim+ 
»ûÁcy
))

727 
»t
 = 1;

728 
out
:

729 
	`b»l£
(
bh
);

730  
»t
;

731 
	}
}

733 
	$ext4_m¬k_šode_u£d
(
su³r_block
 *
sb
, 
šo
)

735 
max_šo
 = 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_šodes_couÁ
);

736 
bufãr_h—d
 *
šode_b™m­_bh
 = 
NULL
, *
group_desc_bh
 = NULL;

737 
ext4_group_desc
 *
gdp
;

738 
ext4_group_t
 
group
;

739 
b™
;

740 
”r
 = -
EFSCORRUPTED
;

742 ià(
šo
 < 
	`EXT4_FIRST_INO
(
sb
è|| inØ> 
max_šo
)

743 
out
;

745 
group
 = (
šo
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(
sb
);

746 
b™
 = (
šo
 - 1è% 
	`EXT4_INODES_PER_GROUP
(
sb
);

747 
šode_b™m­_bh
 = 
	`ext4_»ad_šode_b™m­
(
sb
, 
group
);

748 ià(
	`IS_ERR
(
šode_b™m­_bh
))

749  
	`PTR_ERR
(
šode_b™m­_bh
);

751 ià(
	`ext4_‹¡_b™
(
b™
, 
šode_b™m­_bh
->
b_d©a
)) {

752 
”r
 = -
EEXIST
;

753 
out
;

756 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, &
group_desc_bh
);

757 ià(!
gdp
 || !
group_desc_bh
) {

758 
”r
 = -
EINVAL
;

759 
out
;

762 
	`ext4_£t_b™
(
b™
, 
šode_b™m­_bh
->
b_d©a
);

764 
	`BUFFER_TRACE
(
šode_b™m­_bh
, "callƒxt4_handle_dirty_metadata");

765 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
NULL
, NULL, 
šode_b™m­_bh
);

766 ià(
”r
) {

767 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

768 
out
;

770 
	`sync_dœty_bufãr
(
šode_b™m­_bh
);

771 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

774 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

775 
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
)) {

776 
bufãr_h—d
 *
block_b™m­_bh
;

778 
block_b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

779 ià(
	`IS_ERR
(
block_b™m­_bh
)) {

780 
”r
 = 
	`PTR_ERR
(
block_b™m­_bh
);

781 
out
;

784 
	`BUFFER_TRACE
(
block_b™m­_bh
, "dirty block bitmap");

785 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
NULL
, NULL, 
block_b™m­_bh
);

786 
	`sync_dœty_bufãr
(
block_b™m­_bh
);

789 
	`ext4_lock_group
(
sb
, 
group
);

790 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

791 (
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
))) {

792 
gdp
->
bg_æags
 &ğ
	`ıu_to_Ë16
(~
EXT4_BG_BLOCK_UNINIT
);

793 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
,

794 
	`ext4_ä“_şu¡”s_aá”_š™
(
sb
, 
group
, 
gdp
));

795 
	`ext4_block_b™m­_csum_£t
(
sb
, 
group
, 
gdp
,

796 
block_b™m­_bh
);

797 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

799 
	`ext4_uÆock_group
(
sb
, 
group
);

800 
	`b»l£
(
block_b™m­_bh
);

802 ià(
”r
) {

803 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

804 
out
;

809 ià(
	`ext4_has_group_desc_csum
(
sb
)) {

810 
ä“
;

812 
	`ext4_lock_group
(
sb
, 
group
);

813 
ä“
 = 
	`EXT4_INODES_PER_GROUP
(
sb
) -

814 
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
);

815 ià(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_UNINIT
)) {

816 
gdp
->
bg_æags
 &ğ
	`ıu_to_Ë16
(~
EXT4_BG_INODE_UNINIT
);

817 
ä“
 = 0;

825 ià(
b™
 >ğ
ä“
)

826 
	`ext4_™abË_unu£d_£t
(
sb
, 
gdp
,

827 (
	`EXT4_INODES_PER_GROUP
(
sb
è- 
b™
 - 1));

829 
	`ext4_lock_group
(
sb
, 
group
);

832 
	`ext4_ä“_šodes_£t
(
sb
, 
gdp
, 
	`ext4_ä“_šodes_couÁ
(sb, gdp) - 1);

833 ià(
	`ext4_has_group_desc_csum
(
sb
)) {

834 
	`ext4_šode_b™m­_csum_£t
(
sb
, 
group
, 
gdp
, 
šode_b™m­_bh
,

835 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

836 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

839 
	`ext4_uÆock_group
(
sb
, 
group
);

840 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
NULL
, NULL, 
group_desc_bh
);

841 
	`sync_dœty_bufãr
(
group_desc_bh
);

842 
out
:

843  
”r
;

844 
	}
}

856 
šode
 *
	$__ext4_Ãw_šode
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

857 
umode_t
 
mode
, cÚ¡ 
q¡r
 *qstr,

858 
__u32
 
gßl
, 
uid_t
 *
owÃr
, __u32 
i_æags
,

859 
hªdË_ty³
, 
lše_no
,

860 
nblocks
)

862 
su³r_block
 *
sb
;

863 
bufãr_h—d
 *
šode_b™m­_bh
 = 
NULL
;

864 
bufãr_h—d
 *
group_desc_bh
;

865 
ext4_group_t
 
ngroups
, 
group
 = 0;

866 
šo
 = 0;

867 
šode
 *inode;

868 
ext4_group_desc
 *
gdp
 = 
NULL
;

869 
ext4_šode_šfo
 *
ei
;

870 
ext4_sb_šfo
 *
sbi
;

871 
»t2
, 
”r
;

872 
šode
 *
»t
;

873 
ext4_group_t
 
i
;

874 
ext4_group_t
 
æex_group
;

875 
ext4_group_šfo
 *
g½
;

876 
’üy±
 = 0;

879 ià(!
dœ
 || !dœ->
i_Æšk
)

880  
	`ERR_PTR
(-
EPERM
);

882 
sb
 = 
dœ
->
i_sb
;

883 
sbi
 = 
	`EXT4_SB
(
sb
);

885 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
sbi
)))

886  
	`ERR_PTR
(-
EIO
);

888 ià((
	`ext4_’üy±ed_šode
(
dœ
è|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) &&

889 (
	`S_ISREG
(
mode
è|| 
	`S_ISDIR
(modeè|| 
	`S_ISLNK
(mode)) &&

890 !(
i_æags
 & 
EXT4_EA_INODE_FL
)) {

891 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

892 ià(
”r
)

893  
	`ERR_PTR
(
”r
);

894 ià(!
	`fsüy±_has_’üy±iÚ_key
(
dœ
))

895  
	`ERR_PTR
(-
ENOKEY
);

896 
’üy±
 = 1;

899 ià(!
hªdË
 && 
sbi
->
s_jouº®
 && !(
i_æags
 & 
EXT4_EA_INODE_FL
)) {

900 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


901 
posix_aş
 *
p
 = 
	`g‘_aş
(
dœ
, 
ACL_TYPE_DEFAULT
);

903 ià(
p
) {

904 
aş_size
 = 
p
->
a_couÁ
 * (
ext4_aş_’Œy
);

906 
nblocks
 +ğ(
	`S_ISDIR
(
mode
) ? 2 : 1) *

907 
	`__ext4_x©Œ_£t_üed™s
(
sb
, 
NULL
 ,

908 
NULL
 , 
aş_size
,

909 
Œue
 );

910 
	`posix_aş_»Ëa£
(
p
);

914 #ifdeà
CONFIG_SECURITY


916 
num_£cur™y_x©Œs
 = 1;

918 #ifdeà
CONFIG_INTEGRITY


919 
num_£cur™y_x©Œs
++;

926 
nblocks
 +ğ
num_£cur™y_x©Œs
 *

927 
	`__ext4_x©Œ_£t_üed™s
(
sb
, 
NULL
 ,

928 
NULL
 , 1024,

929 
Œue
 );

932 ià(
’üy±
)

933 
nblocks
 +ğ
	`__ext4_x©Œ_£t_üed™s
(
sb
,

934 
NULL
 , NULL ,

935 
FSCRYPT_SET_CONTEXT_MAX_SIZE
,

936 
Œue
 );

939 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

940 
	`Œaû_ext4_»que¡_šode
(
dœ
, 
mode
);

941 
šode
 = 
	`Ãw_šode
(
sb
);

942 ià(!
šode
)

943  
	`ERR_PTR
(-
ENOMEM
);

944 
ei
 = 
	`EXT4_I
(
šode
);

951 ià(
owÃr
) {

952 
šode
->
i_mode
 = 
mode
;

953 
	`i_uid_wr™e
(
šode
, 
owÃr
[0]);

954 
	`i_gid_wr™e
(
šode
, 
owÃr
[1]);

955 } ià(
	`‹¡_İt
(
sb
, 
GRPID
)) {

956 
šode
->
i_mode
 = 
mode
;

957 
šode
->
i_uid
 = 
	`cu¼’t_fsuid
();

958 
šode
->
i_gid
 = 
dœ
->i_gid;

960 
	`šode_š™_owÃr
(
šode
, 
dœ
, 
mode
);

962 ià(
	`ext4_has_ã©u»_´ojeù
(
sb
) &&

963 
	`ext4_‹¡_šode_æag
(
dœ
, 
EXT4_INODE_PROJINHERIT
))

964 
ei
->
i_´ojid
 = 
	`EXT4_I
(
dœ
)->i_projid;

966 
ei
->
i_´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, 
EXT4_DEF_PROJID
);

968 
”r
 = 
	`dquÙ_š™Ÿlize
(
šode
);

969 ià(
”r
)

970 
out
;

972 ià(!
gßl
)

973 
gßl
 = 
sbi
->
s_šode_gßl
;

975 ià(
gßl
 && gßÈ<ğ
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_šodes_couÁ
)) {

976 
group
 = (
gßl
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(
sb
);

977 
šo
 = (
gßl
 - 1è% 
	`EXT4_INODES_PER_GROUP
(
sb
);

978 
»t2
 = 0;

979 
gÙ_group
;

982 ià(
	`S_ISDIR
(
mode
))

983 
»t2
 = 
	`fšd_group_Ülov
(
sb
, 
dœ
, &
group
, 
mode
, 
q¡r
);

985 
»t2
 = 
	`fšd_group_Ùh”
(
sb
, 
dœ
, &
group
, 
mode
);

987 
gÙ_group
:

988 
	`EXT4_I
(
dœ
)->
i_Ï¡_®loc_group
 = 
group
;

989 
”r
 = -
ENOSPC
;

990 ià(
»t2
 == -1)

991 
out
;

998 
i
 = 0; i < 
ngroups
; i++, 
šo
 = 0) {

999 
”r
 = -
EIO
;

1001 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, &
group_desc_bh
);

1002 ià(!
gdp
)

1003 
out
;

1008 ià(
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
) == 0) {

1009 ià(++
group
 =ğ
ngroups
)

1010 
group
 = 0;

1014 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

1016 ià(
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
)) {

1017 ià(++
group
 =ğ
ngroups
)

1018 
group
 = 0;

1022 
	`b»l£
(
šode_b™m­_bh
);

1023 
šode_b™m­_bh
 = 
	`ext4_»ad_šode_b™m­
(
sb
, 
group
);

1025 ià(
	`EXT4_MB_GRP_IBITMAP_CORRUPT
(
g½
) ||

1026 
	`IS_ERR
(
šode_b™m­_bh
)) {

1027 
šode_b™m­_bh
 = 
NULL
;

1028 ià(++
group
 =ğ
ngroups
)

1029 
group
 = 0;

1033 
»³©_š_this_group
:

1034 
šo
 = 
	`ext4_fšd_Ãxt_z”o_b™
((*)

1035 
šode_b™m­_bh
->
b_d©a
,

1036 
	`EXT4_INODES_PER_GROUP
(
sb
), 
šo
);

1037 ià(
šo
 >ğ
	`EXT4_INODES_PER_GROUP
(
sb
))

1038 
Ãxt_group
;

1039 ià(
group
 =ğ0 && (
šo
+1è< 
	`EXT4_FIRST_INO
(
sb
)) {

1040 
	`ext4_”rÜ
(
sb
, "reserved inode found cleared - "

1041 "šode=%lu", 
šo
 + 1);

1044 ià((
	`EXT4_SB
(
sb
)->
s_jouº®
 =ğ
NULL
) &&

1045 
	`»ûÁly_d–‘ed
(
sb
, 
group
, 
šo
)) {

1046 
šo
++;

1047 
Ãxt_šode
;

1049 ià(!
hªdË
) {

1050 
	`BUG_ON
(
nblocks
 <= 0);

1051 
hªdË
 = 
	`__ext4_jouº®_¡¬t_sb
(
dœ
->
i_sb
, 
lše_no
,

1052 
hªdË_ty³
, 
nblocks
,

1054 ià(
	`IS_ERR
(
hªdË
)) {

1055 
”r
 = 
	`PTR_ERR
(
hªdË
);

1056 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1057 
out
;

1060 
	`BUFFER_TRACE
(
šode_b™m­_bh
, "get_write_access");

1061 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
šode_b™m­_bh
);

1062 ià(
”r
) {

1063 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1064 
out
;

1066 
	`ext4_lock_group
(
sb
, 
group
);

1067 
»t2
 = 
	`ext4_‹¡_ªd_£t_b™
(
šo
, 
šode_b™m­_bh
->
b_d©a
);

1068 
	`ext4_uÆock_group
(
sb
, 
group
);

1069 
šo
++;

1070 ià(!
»t2
)

1071 
gÙ
;

1072 
Ãxt_šode
:

1073 ià(
šo
 < 
	`EXT4_INODES_PER_GROUP
(
sb
))

1074 
»³©_š_this_group
;

1075 
Ãxt_group
:

1076 ià(++
group
 =ğ
ngroups
)

1077 
group
 = 0;

1079 
”r
 = -
ENOSPC
;

1080 
out
;

1082 
gÙ
:

1083 
	`BUFFER_TRACE
(
šode_b™m­_bh
, "callƒxt4_handle_dirty_metadata");

1084 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
šode_b™m­_bh
);

1085 ià(
”r
) {

1086 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1087 
out
;

1090 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

1091 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
group_desc_bh
);

1092 ià(
”r
) {

1093 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1094 
out
;

1098 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

1099 
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
)) {

1100 
bufãr_h—d
 *
block_b™m­_bh
;

1102 
block_b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

1103 ià(
	`IS_ERR
(
block_b™m­_bh
)) {

1104 
”r
 = 
	`PTR_ERR
(
block_b™m­_bh
);

1105 
out
;

1107 
	`BUFFER_TRACE
(
block_b™m­_bh
, "get block bitmap‡ccess");

1108 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
block_b™m­_bh
);

1109 ià(
”r
) {

1110 
	`b»l£
(
block_b™m­_bh
);

1111 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1112 
out
;

1115 
	`BUFFER_TRACE
(
block_b™m­_bh
, "dirty block bitmap");

1116 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
block_b™m­_bh
);

1119 
	`ext4_lock_group
(
sb
, 
group
);

1120 ià(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
)) {

1121 
gdp
->
bg_æags
 &ğ
	`ıu_to_Ë16
(~
EXT4_BG_BLOCK_UNINIT
);

1122 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
,

1123 
	`ext4_ä“_şu¡”s_aá”_š™
(
sb
, 
group
, 
gdp
));

1124 
	`ext4_block_b™m­_csum_£t
(
sb
, 
group
, 
gdp
,

1125 
block_b™m­_bh
);

1126 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1128 
	`ext4_uÆock_group
(
sb
, 
group
);

1129 
	`b»l£
(
block_b™m­_bh
);

1131 ià(
”r
) {

1132 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1133 
out
;

1138 ià(
	`ext4_has_group_desc_csum
(
sb
)) {

1139 
ä“
;

1140 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

1142 
	`down_»ad
(&
g½
->
®loc_£m
);

1143 
	`ext4_lock_group
(
sb
, 
group
);

1144 
ä“
 = 
	`EXT4_INODES_PER_GROUP
(
sb
) -

1145 
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
);

1146 ià(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_UNINIT
)) {

1147 
gdp
->
bg_æags
 &ğ
	`ıu_to_Ë16
(~
EXT4_BG_INODE_UNINIT
);

1148 
ä“
 = 0;

1155 ià(
šo
 > 
ä“
)

1156 
	`ext4_™abË_unu£d_£t
(
sb
, 
gdp
,

1157 (
	`EXT4_INODES_PER_GROUP
(
sb
è- 
šo
));

1158 
	`up_»ad
(&
g½
->
®loc_£m
);

1160 
	`ext4_lock_group
(
sb
, 
group
);

1163 
	`ext4_ä“_šodes_£t
(
sb
, 
gdp
, 
	`ext4_ä“_šodes_couÁ
(sb, gdp) - 1);

1164 ià(
	`S_ISDIR
(
mode
)) {

1165 
	`ext4_u£d_dœs_£t
(
sb
, 
gdp
, 
	`ext4_u£d_dœs_couÁ
(sb, gdp) + 1);

1166 ià(
sbi
->
s_log_groups_³r_æex
) {

1167 
ext4_group_t
 
f
 = 
	`ext4_æex_group
(
sbi
, 
group
);

1169 
	`©omic_šc
(&
sbi
->
s_æex_groups
[
f
].
u£d_dœs
);

1172 ià(
	`ext4_has_group_desc_csum
(
sb
)) {

1173 
	`ext4_šode_b™m­_csum_£t
(
sb
, 
group
, 
gdp
, 
šode_b™m­_bh
,

1174 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

1175 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1177 
	`ext4_uÆock_group
(
sb
, 
group
);

1179 
	`BUFFER_TRACE
(
group_desc_bh
, "callƒxt4_handle_dirty_metadata");

1180 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
group_desc_bh
);

1181 ià(
”r
) {

1182 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1183 
out
;

1186 
	`³rıu_couÁ”_dec
(&
sbi
->
s_ä“šodes_couÁ”
);

1187 ià(
	`S_ISDIR
(
mode
))

1188 
	`³rıu_couÁ”_šc
(&
sbi
->
s_dœs_couÁ”
);

1190 ià(
sbi
->
s_log_groups_³r_æex
) {

1191 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
group
);

1192 
	`©omic_dec
(&
sbi
->
s_æex_groups
[
æex_group
].
ä“_šodes
);

1195 
šode
->
i_šo
 = 
šo
 + 
group
 * 
	`EXT4_INODES_PER_GROUP
(
sb
);

1197 
šode
->
i_blocks
 = 0;

1198 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
ei
->
i_ütime
 =

1199 
	`cu¼’t_time
(
šode
);

1201 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

1202 
ei
->
i_dœ_¡¬t_lookup
 = 0;

1203 
ei
->
i_disksize
 = 0;

1206 
ei
->
i_æags
 =

1207 
	`ext4_mask_æags
(
mode
, 
	`EXT4_I
(
dœ
)->
i_æags
 & 
EXT4_FL_INHERITED
);

1208 
ei
->
i_æags
 |= i_flags;

1209 
ei
->
i_fe_aş
 = 0;

1210 
ei
->
i_dtime
 = 0;

1211 
ei
->
i_block_group
 = 
group
;

1212 
ei
->
i_Ï¡_®loc_group
 = ~0;

1214 
	`ext4_£t_šode_æags
(
šode
);

1215 ià(
	`IS_DIRSYNC
(
šode
))

1216 
	`ext4_hªdË_sync
(
hªdË
);

1217 ià(
	`š£¹_šode_locked
(
šode
) < 0) {

1222 
”r
 = -
EIO
;

1223 
	`ext4_”rÜ
(
sb
, "failedo insert inode %lu: doubly‡llocated?",

1224 
šode
->
i_šo
);

1225 
out
;

1227 
	`¥š_lock
(&
sbi
->
s_Ãxt_g’_lock
);

1228 
šode
->
i_g’”©iÚ
 = 
sbi
->
s_Ãxt_g’”©iÚ
++;

1229 
	`¥š_uÆock
(&
sbi
->
s_Ãxt_g’_lock
);

1232 ià(
	`ext4_has_m‘ad©a_csum
(
sb
)) {

1233 
__u32
 
csum
;

1234 
__Ë32
 
šum
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

1235 
__Ë32
 
g’
 = 
	`ıu_to_Ë32
(
šode
->
i_g’”©iÚ
);

1236 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
šum
,

1237 (
šum
));

1238 
ei
->
i_csum_£ed
 = 
	`ext4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
g’
,

1239 (
g’
));

1242 
	`ext4_ş—r_¡©e_æags
(
ei
);

1243 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
);

1245 
ei
->
i_exŒa_isize
 = 
	`EXT4_SB
(
sb
)->
s_wªt_exŒa_isize
;

1246 
ei
->
i_šlše_off
 = 0;

1247 ià(
	`ext4_has_ã©u»_šlše_d©a
(
sb
))

1248 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

1249 
»t
 = 
šode
;

1250 
”r
 = 
	`dquÙ_®loc_šode
(
šode
);

1251 ià(
”r
)

1252 
ç_drİ
;

1259 ià(
’üy±
) {

1260 
”r
 = 
	`fsüy±_šh”™_cÚ‹xt
(
dœ
, 
šode
, 
hªdË
, 
Œue
);

1261 ià(
”r
)

1262 
ç_ä“_drİ
;

1265 ià(!(
ei
->
i_æags
 & 
EXT4_EA_INODE_FL
)) {

1266 
”r
 = 
	`ext4_š™_aş
(
hªdË
, 
šode
, 
dœ
);

1267 ià(
”r
)

1268 
ç_ä“_drİ
;

1270 
”r
 = 
	`ext4_š™_£cur™y
(
hªdË
, 
šode
, 
dœ
, 
q¡r
);

1271 ià(
”r
)

1272 
ç_ä“_drİ
;

1275 ià(
	`ext4_has_ã©u»_ex‹Ás
(
sb
)) {

1277 ià(
	`S_ISDIR
(
mode
è|| 
	`S_ISREG
(modeè|| 
	`S_ISLNK
(mode)) {

1278 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

1279 
	`ext4_ext_Œ“_š™
(
hªdË
, 
šode
);

1283 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

1284 
ei
->
i_sync_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

1285 
ei
->
i_d©async_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

1288 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1289 ià(
”r
) {

1290 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1291 
ç_ä“_drİ
;

1294 
	`ext4_debug
("®loÿtšg inod%lu\n", 
šode
->
i_šo
);

1295 
	`Œaû_ext4_®loÿ‹_šode
(
šode
, 
dœ
, 
mode
);

1296 
	`b»l£
(
šode_b™m­_bh
);

1297  
»t
;

1299 
ç_ä“_drİ
:

1300 
	`dquÙ_ä“_šode
(
šode
);

1301 
ç_drİ
:

1302 
	`ş—r_Æšk
(
šode
);

1303 
	`uÆock_Ãw_šode
(
šode
);

1304 
out
:

1305 
	`dquÙ_drİ
(
šode
);

1306 
šode
->
i_æags
 |ğ
S_NOQUOTA
;

1307 
	`ut
(
šode
);

1308 
	`b»l£
(
šode_b™m­_bh
);

1309  
	`ERR_PTR
(
”r
);

1310 
	}
}

1313 
šode
 *
	$ext4_Üphª_g‘
(
su³r_block
 *
sb
, 
šo
)

1315 
max_šo
 = 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_šodes_couÁ
);

1316 
ext4_group_t
 
block_group
;

1317 
b™
;

1318 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

1319 
šode
 *šodğ
NULL
;

1320 
”r
 = -
EFSCORRUPTED
;

1322 ià(
šo
 < 
	`EXT4_FIRST_INO
(
sb
è|| inØ> 
max_šo
)

1323 
bad_Üphª
;

1325 
block_group
 = (
šo
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(
sb
);

1326 
b™
 = (
šo
 - 1è% 
	`EXT4_INODES_PER_GROUP
(
sb
);

1327 
b™m­_bh
 = 
	`ext4_»ad_šode_b™m­
(
sb
, 
block_group
);

1328 ià(
	`IS_ERR
(
b™m­_bh
)) {

1329 
	`ext4_”rÜ
(
sb
, "inode bitmapƒrror %ld for orphan %lu",

1330 
šo
, 
	`PTR_ERR
(
b™m­_bh
));

1331  (
šode
 *è
b™m­_bh
;

1338 ià(!
	`ext4_‹¡_b™
(
b™
, 
b™m­_bh
->
b_d©a
))

1339 
bad_Üphª
;

1341 
šode
 = 
	`ext4_ig‘
(
sb
, 
šo
);

1342 ià(
	`IS_ERR
(
šode
)) {

1343 
”r
 = 
	`PTR_ERR
(
šode
);

1344 
	`ext4_”rÜ
(
sb
, "couldn't„ead orphan inode %lu (err %d)",

1345 
šo
, 
”r
);

1346  
šode
;

1355 ià((
šode
->
i_Æšk
 && !
	`ext4_ÿn_Œunÿ‹
(inode)) ||

1356 
	`is_bad_šode
(
šode
))

1357 
bad_Üphª
;

1359 ià(
	`NEXT_ORPHAN
(
šode
è> 
max_šo
)

1360 
bad_Üphª
;

1361 
	`b»l£
(
b™m­_bh
);

1362  
šode
;

1364 
bad_Üphª
:

1365 
	`ext4_”rÜ
(
sb
, "bad o½hª inod%lu", 
šo
);

1366 ià(
b™m­_bh
)

1367 
	`´štk
(
KERN_ERR
 "ext4_test_bit(bit=%d, block=%llu) = %d\n",

1368 
b™
, ()
b™m­_bh
->
b_blockÄ
,

1369 
	`ext4_‹¡_b™
(
b™
, 
b™m­_bh
->
b_d©a
));

1370 ià(
šode
) {

1371 
	`´štk
(
KERN_ERR
 "is_bad_inode(inode)=%d\n",

1372 
	`is_bad_šode
(
šode
));

1373 
	`´štk
(
KERN_ERR
 "NEXT_ORPHAN(inode)=%u\n",

1374 
	`NEXT_ORPHAN
(
šode
));

1375 
	`´štk
(
KERN_ERR
 "max_šo=%lu\n", 
max_šo
);

1376 
	`´štk
(
KERN_ERR
 "i_Æšk=%u\n", 
šode
->
i_Æšk
);

1378 ià(
šode
->
i_Æšk
 == 0)

1379 
šode
->
i_blocks
 = 0;

1380 
	`ut
(
šode
);

1382 
	`b»l£
(
b™m­_bh
);

1383  
	`ERR_PTR
(
”r
);

1384 
	}
}

1386 
	$ext4_couÁ_ä“_šodes
(
su³r_block
 *
sb
)

1388 
desc_couÁ
;

1389 
ext4_group_desc
 *
gdp
;

1390 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

1391 #ifdeà
EXT4FS_DEBUG


1392 
ext4_su³r_block
 *
es
;

1393 
b™m­_couÁ
, 
x
;

1394 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

1396 
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

1397 
desc_couÁ
 = 0;

1398 
b™m­_couÁ
 = 0;

1399 
gdp
 = 
NULL
;

1400 
i
 = 0; i < 
ngroups
; i++) {

1401 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

1402 ià(!
gdp
)

1404 
desc_couÁ
 +ğ
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
);

1405 
	`b»l£
(
b™m­_bh
);

1406 
b™m­_bh
 = 
	`ext4_»ad_šode_b™m­
(
sb
, 
i
);

1407 ià(
	`IS_ERR
(
b™m­_bh
)) {

1408 
b™m­_bh
 = 
NULL
;

1412 
x
 = 
	`ext4_couÁ_ä“
(
b™m­_bh
->
b_d©a
,

1413 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

1414 
	`´štk
(
KERN_DEBUG
 "group %lu: stored = %d, counted = %lu\n",

1415 (è
i
, 
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
), 
x
);

1416 
b™m­_couÁ
 +ğ
x
;

1418 
	`b»l£
(
b™m­_bh
);

1419 
	`´štk
(
KERN_DEBUG
 "ext4_count_free_inodes: "

1421 
	`Ë32_to_ıu
(
es
->
s_ä“_šodes_couÁ
), 
desc_couÁ
, 
b™m­_couÁ
);

1422  
desc_couÁ
;

1424 
desc_couÁ
 = 0;

1425 
i
 = 0; i < 
ngroups
; i++) {

1426 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

1427 ià(!
gdp
)

1429 
desc_couÁ
 +ğ
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
);

1430 
	`cÚd_»sched
();

1432  
desc_couÁ
;

1434 
	}
}

1437 
	$ext4_couÁ_dœs
(
su³r_block
 * 
sb
)

1439 
couÁ
 = 0;

1440 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

1442 
i
 = 0; i < 
ngroups
; i++) {

1443 
ext4_group_desc
 *
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

1444 ià(!
gdp
)

1446 
couÁ
 +ğ
	`ext4_u£d_dœs_couÁ
(
sb
, 
gdp
);

1448  
couÁ
;

1449 
	}
}

1459 
	$ext4_š™_šode_bË
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

1460 
b¬r›r
)

1462 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

1463 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1464 
ext4_group_desc
 *
gdp
 = 
NULL
;

1465 
bufãr_h—d
 *
group_desc_bh
;

1466 
hªdË_t
 *
hªdË
;

1467 
ext4_fsblk_t
 
blk
;

1468 
num
, 
»t
 = 0, 
u£d_blks
 = 0;

1471 ià(
sb
->
s_æags
 & 
MS_RDONLY
) {

1472 
»t
 = 1;

1473 
out
;

1476 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, &
group_desc_bh
);

1477 ià(!
gdp
)

1478 
out
;

1484 ià(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
))

1485 
out
;

1487 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_MISC
, 1);

1488 ià(
	`IS_ERR
(
hªdË
)) {

1489 
»t
 = 
	`PTR_ERR
(
hªdË
);

1490 
out
;

1493 
	`down_wr™e
(&
g½
->
®loc_£m
);

1499 ià(!(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_UNINIT
)))

1500 
u£d_blks
 = 
	`DIV_ROUND_UP
((
	`EXT4_INODES_PER_GROUP
(
sb
) -

1501 
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
)),

1502 
sbi
->
s_šodes_³r_block
);

1504 ià((
u£d_blks
 < 0è|| (u£d_blk > 
sbi
->
s_™b_³r_group
)) {

1505 
	`ext4_”rÜ
(
sb
, "Something is wrong with group %u: "

1508 
group
, 
u£d_blks
,

1509 
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
));

1510 
»t
 = 1;

1511 
”r_out
;

1514 
blk
 = 
	`ext4_šode_bË
(
sb
, 
gdp
è+ 
u£d_blks
;

1515 
num
 = 
sbi
->
s_™b_³r_group
 - 
u£d_blks
;

1517 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

1518 
»t
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
,

1519 
group_desc_bh
);

1520 ià(
»t
)

1521 
”r_out
;

1528 ià(
	`uÆik–y
(
num
 == 0))

1529 
sk_z”oout
;

1531 
	`ext4_debug
("goingo zero out inodeable in group %d\n",

1532 
group
);

1533 
»t
 = 
	`sb_issue_z”oout
(
sb
, 
blk
, 
num
, 
GFP_NOFS
);

1534 ià(
»t
 < 0)

1535 
”r_out
;

1536 ià(
b¬r›r
)

1537 
	`blkdev_issue_æush
(
sb
->
s_bdev
, 
GFP_NOFS
, 
NULL
);

1539 
sk_z”oout
:

1540 
	`ext4_lock_group
(
sb
, 
group
);

1541 
gdp
->
bg_æags
 |ğ
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
);

1542 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1543 
	`ext4_uÆock_group
(
sb
, 
group
);

1545 
	`BUFFER_TRACE
(
group_desc_bh
,

1547 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
,

1548 
group_desc_bh
);

1550 
”r_out
:

1551 
	`up_wr™e
(&
g½
->
®loc_£m
);

1552 
	`ext4_jouº®_¡İ
(
hªdË
);

1553 
out
:

1554  
»t
;

1555 
	}
}

	@indirect.c

23 
	~"ext4_jbd2.h
"

24 
	~"Œunÿ‹.h
"

25 
	~<lšux/dax.h
>

26 
	~<lšux/uio.h
>

28 
	~<Œaû/ev’ts/ext4.h
>

31 
__Ë32
 *
	mp
;

32 
__Ë32
 
	mkey
;

33 
bufãr_h—d
 *
	mbh
;

34 } 
	tIndœeù
;

36 
šlše
 
	$add_chaš
(
Indœeù
 *
p
, 
bufãr_h—d
 *
bh
, 
__Ë32
 *
v
)

38 
p
->
key
 = *Õ->°ğ
v
);

39 
p
->
bh
 = bh;

40 
	}
}

73 
	$ext4_block_to_·th
(
šode
 *inode,

74 
ext4_lblk_t
 
i_block
,

75 
ext4_lblk_t
 
off£ts
[4], *
bound¬y
)

77 
±rs
 = 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
);

78 
±rs_b™s
 = 
	`EXT4_ADDR_PER_BLOCK_BITS
(
šode
->
i_sb
);

79 cÚ¡ 
dœeù_blocks
 = 
EXT4_NDIR_BLOCKS
,

80 
šdœeù_blocks
 = 
±rs
,

81 
doubË_blocks
 = (1 << (
±rs_b™s
 * 2));

82 
n
 = 0;

83 
fš®
 = 0;

85 ià(
i_block
 < 
dœeù_blocks
) {

86 
off£ts
[
n
++] = 
i_block
;

87 
fš®
 = 
dœeù_blocks
;

88 } ià((
i_block
 -ğ
dœeù_blocks
è< 
šdœeù_blocks
) {

89 
off£ts
[
n
++] = 
EXT4_IND_BLOCK
;

90 
off£ts
[
n
++] = 
i_block
;

91 
fš®
 = 
±rs
;

92 } ià((
i_block
 -ğ
šdœeù_blocks
è< 
doubË_blocks
) {

93 
off£ts
[
n
++] = 
EXT4_DIND_BLOCK
;

94 
off£ts
[
n
++] = 
i_block
 >> 
±rs_b™s
;

95 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

96 
fš®
 = 
±rs
;

97 } ià(((
i_block
 -ğ
doubË_blocks
è>> (
±rs_b™s
 * 2)è< 
±rs
) {

98 
off£ts
[
n
++] = 
EXT4_TIND_BLOCK
;

99 
off£ts
[
n
++] = 
i_block
 >> (
±rs_b™s
 * 2);

100 
off£ts
[
n
++] = (
i_block
 >> 
±rs_b™s
è& (
±rs
 - 1);

101 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

102 
fš®
 = 
±rs
;

104 
	`ext4_w¬nšg
(
šode
->
i_sb
, "block %lu > max in inode %lu",

105 
i_block
 + 
dœeù_blocks
 +

106 
šdœeù_blocks
 + 
doubË_blocks
, 
šode
->
i_šo
);

108 ià(
bound¬y
)

109 *
bound¬y
 = 
fš®
 - 1 - (
i_block
 & (
±rs
 - 1));

110  
n
;

111 
	}
}

143 
Indœeù
 *
	$ext4_g‘_b¿nch
(
šode
 *šode, 
d•th
,

144 
ext4_lblk_t
 *
off£ts
,

145 
Indœeù
 
chaš
[4], *
”r
)

147 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

148 
Indœeù
 *
p
 = 
chaš
;

149 
bufãr_h—d
 *
bh
;

150 
»t
 = -
EIO
;

152 *
”r
 = 0;

154 
	`add_chaš
(
chaš
, 
NULL
, 
	`EXT4_I
(
šode
)->
i_d©a
 + *
off£ts
);

155 ià(!
p
->
key
)

156 
no_block
;

157 --
d•th
) {

158 
bh
 = 
	`sb_g‘blk
(
sb
, 
	`Ë32_to_ıu
(
p
->
key
));

159 ià(
	`uÆik–y
(!
bh
)) {

160 
»t
 = -
ENOMEM
;

161 
çu»
;

164 ià(!
	`bh_u±od©e_Ü_lock
(
bh
)) {

165 ià(
	`bh_subm™_»ad
(
bh
) < 0) {

166 
	`put_bh
(
bh
);

167 
çu»
;

170 ià(
	`ext4_check_šdœeù_block»f
(
šode
, 
bh
)) {

171 
	`put_bh
(
bh
);

172 
çu»
;

176 
	`add_chaš
(++
p
, 
bh
, (
__Ë32
 *)bh->
b_d©a
 + *++
off£ts
);

178 ià(!
p
->
key
)

179 
no_block
;

181  
NULL
;

183 
çu»
:

184 *
”r
 = 
»t
;

185 
no_block
:

186  
p
;

187 
	}
}

209 
ext4_fsblk_t
 
	$ext4_fšd_Ã¬
(
šode
 *šode, 
Indœeù
 *
šd
)

211 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

212 
__Ë32
 *
¡¬t
 = 
šd
->
bh
 ? (__Ë32 *èšd->bh->
b_d©a
 : 
ei
->
i_d©a
;

213 
__Ë32
 *
p
;

216 
p
 = 
šd
->°- 1;… >ğ
¡¬t
;…--) {

217 ià(*
p
)

218  
	`Ë32_to_ıu
(*
p
);

222 ià(
šd
->
bh
)

223  
šd
->
bh
->
b_blockÄ
;

229  
	`ext4_šode_to_gßl_block
(
šode
);

230 
	}
}

243 
ext4_fsblk_t
 
	$ext4_fšd_gßl
(
šode
 *šode, 
ext4_lblk_t
 
block
,

244 
Indœeù
 *
·¹Ÿl
)

246 
ext4_fsblk_t
 
gßl
;

252 
gßl
 = 
	`ext4_fšd_Ã¬
(
šode
, 
·¹Ÿl
);

253 
gßl
 = gßÈ& 
EXT4_MAX_BLOCK_FILE_PHYS
;

254  
gßl
;

255 
	}
}

269 
	$ext4_blks_to_®loÿ‹
(
Indœeù
 *
b¿nch
, 
k
, 
blks
,

270 
blocks_to_bound¬y
)

272 
couÁ
 = 0;

278 ià(
k
 > 0) {

280 ià(
blks
 < 
blocks_to_bound¬y
 + 1)

281 
couÁ
 +ğ
blks
;

283 
couÁ
 +ğ
blocks_to_bound¬y
 + 1;

284  
couÁ
;

287 
couÁ
++;

288 
couÁ
 < 
blks
 && couÁ <ğ
blocks_to_bound¬y
 &&

289 
	`Ë32_to_ıu
(*(
b¿nch
[0].
p
 + 
couÁ
)) == 0) {

290 
couÁ
++;

292  
couÁ
;

293 
	}
}

322 
	$ext4_®loc_b¿nch
(
hªdË_t
 *
hªdË
,

323 
ext4_®loÿtiÚ_»que¡
 *
¬
,

324 
šdœeù_blks
, 
ext4_lblk_t
 *
off£ts
,

325 
Indœeù
 *
b¿nch
)

327 
bufãr_h—d
 * 
bh
;

328 
ext4_fsblk_t
 
b
, 
Ãw_blocks
[4];

329 
__Ë32
 *
p
;

330 
i
, 
j
, 
”r
, 
Ën
 = 1;

332 
i
 = 0; i <ğ
šdœeù_blks
; i++) {

333 ià(
i
 =ğ
šdœeù_blks
) {

334 
Ãw_blocks
[
i
] = 
	`ext4_mb_Ãw_blocks
(
hªdË
, 
¬
, &
”r
);

336 
¬
->
gßl
 = 
Ãw_blocks
[
i
] = 
	`ext4_Ãw_m‘a_blocks
(
hªdË
,

337 
¬
->
šode
,‡r->
gßl
,

338 
¬
->
æags
 & 
EXT4_MB_DELALLOC_RESERVED
,

339 
NULL
, &
”r
);

340 ià(
”r
) {

341 
i
--;

342 
çed
;

344 
b¿nch
[
i
].
key
 = 
	`ıu_to_Ë32
(
Ãw_blocks
[i]);

345 ià(
i
 == 0)

348 
bh
 = 
b¿nch
[
i
].bh = 
	`sb_g‘blk
(
¬
->
šode
->
i_sb
, 
Ãw_blocks
[i-1]);

349 ià(
	`uÆik–y
(!
bh
)) {

350 
”r
 = -
ENOMEM
;

351 
çed
;

353 
	`lock_bufãr
(
bh
);

354 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

355 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

356 ià(
”r
) {

357 
	`uÆock_bufãr
(
bh
);

358 
çed
;

361 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

362 
p
 = 
b¿nch
[
i
].°ğ(
__Ë32
 *è
bh
->
b_d©a
 + 
off£ts
[i];

363 
b
 = 
Ãw_blocks
[
i
];

365 ià(
i
 =ğ
šdœeù_blks
)

366 
Ën
 = 
¬
->len;

367 
j
 = 0; j < 
Ën
; j++)

368 *
p
++ = 
	`ıu_to_Ë32
(
b
++);

370 
	`BUFFER_TRACE
(
bh
, "marking uptodate");

371 
	`£t_bufãr_u±od©e
(
bh
);

372 
	`uÆock_bufãr
(
bh
);

374 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

375 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
¬
->
šode
, 
bh
);

376 ià(
”r
)

377 
çed
;

380 
çed
:

381 ; 
i
 >= 0; i--) {

388 ià(
i
 > 0 && i !ğ
šdœeù_blks
 && 
b¿nch
[i].
bh
)

389 
	`ext4_fÜg‘
(
hªdË
, 1, 
¬
->
šode
, 
b¿nch
[
i
].
bh
,

390 
b¿nch
[
i
].
bh
->
b_blockÄ
);

391 
	`ext4_ä“_blocks
(
hªdË
, 
¬
->
šode
, 
NULL
, 
Ãw_blocks
[
i
],

392 (
i
 =ğ
šdœeù_blks
è? 
¬
->
Ën
 : 1, 0);

394  
”r
;

395 
	}
}

412 
	$ext4_¥liû_b¿nch
(
hªdË_t
 *
hªdË
,

413 
ext4_®loÿtiÚ_»que¡
 *
¬
,

414 
Indœeù
 *
wh”e
, 
num
)

416 
i
;

417 
”r
 = 0;

418 
ext4_fsblk_t
 
cu¼’t_block
;

425 ià(
wh”e
->
bh
) {

426 
	`BUFFER_TRACE
(
wh”e
->
bh
, "get_write_access");

427 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
wh”e
->
bh
);

428 ià(
”r
)

429 
”r_out
;

433 *
wh”e
->
p
 = wh”e->
key
;

439 ià(
num
 =ğ0 && 
¬
->
Ën
 > 1) {

440 
cu¼’t_block
 = 
	`Ë32_to_ıu
(
wh”e
->
key
) + 1;

441 
i
 = 1; i < 
¬
->
Ën
; i++)

442 *(
wh”e
->
p
 + 
i
èğ
	`ıu_to_Ë32
(
cu¼’t_block
++);

447 ià(
wh”e
->
bh
) {

456 
	`jbd_debug
(5, "splicing indirect only\n");

457 
	`BUFFER_TRACE
(
wh”e
->
bh
, "callƒxt4_handle_dirty_metadata");

458 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
¬
->
šode
, 
wh”e
->
bh
);

459 ià(
”r
)

460 
”r_out
;

465 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
¬
->
šode
);

466 
	`jbd_debug
(5, "splicing direct\n");

468  
”r
;

470 
”r_out
:

471 
i
 = 1; i <ğ
num
; i++) {

477 
	`ext4_ä“_blocks
(
hªdË
, 
¬
->
šode
, 
wh”e
[
i
].
bh
, 0, 1,

478 
EXT4_FREE_BLOCKS_FORGET
);

480 
	`ext4_ä“_blocks
(
hªdË
, 
¬
->
šode
, 
NULL
, 
	`Ë32_to_ıu
(
wh”e
[
num
].
key
),

481 
¬
->
Ën
, 0);

483  
”r
;

484 
	}
}

514 
	$ext4_šd_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

515 
ext4_m­_blocks
 *
m­
,

516 
æags
)

518 
ext4_®loÿtiÚ_»que¡
 
¬
;

519 
”r
 = -
EIO
;

520 
ext4_lblk_t
 
off£ts
[4];

521 
Indœeù
 
chaš
[4];

522 
Indœeù
 *
·¹Ÿl
;

523 
šdœeù_blks
;

524 
blocks_to_bound¬y
 = 0;

525 
d•th
;

526 
couÁ
 = 0;

527 
ext4_fsblk_t
 
fœ¡_block
 = 0;

529 
	`Œaû_ext4_šd_m­_blocks_’‹r
(
šode
, 
m­
->
m_lblk
, m­->
m_Ën
, 
æags
);

530 
	`J_ASSERT
(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)));

531 
	`J_ASSERT
(
hªdË
 !ğ
NULL
 || (
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0);

532 
d•th
 = 
	`ext4_block_to_·th
(
šode
, 
m­
->
m_lblk
, 
off£ts
,

533 &
blocks_to_bound¬y
);

535 ià(
d•th
 == 0)

536 
out
;

538 
·¹Ÿl
 = 
	`ext4_g‘_b¿nch
(
šode
, 
d•th
, 
off£ts
, 
chaš
, &
”r
);

541 ià(!
·¹Ÿl
) {

542 
fœ¡_block
 = 
	`Ë32_to_ıu
(
chaš
[
d•th
 - 1].
key
);

543 
couÁ
++;

545 
couÁ
 < 
m­
->
m_Ën
 && couÁ <ğ
blocks_to_bound¬y
) {

546 
ext4_fsblk_t
 
blk
;

548 
blk
 = 
	`Ë32_to_ıu
(*(
chaš
[
d•th
-1].
p
 + 
couÁ
));

550 ià(
blk
 =ğ
fœ¡_block
 + 
couÁ
)

551 
couÁ
++;

555 
gÙ_™
;

559 ià((
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0) {

560 
•b
 = 
šode
->
i_sb
->
s_blocksize
 / (
u32
);

561 
i
;

564 
couÁ
 = 1;

565 
i
 = 0; 
·¹Ÿl
 + i !ğ
chaš
 + 
d•th
 - 1; i++)

566 
couÁ
 *ğ
•b
;

568 
m­
->
m_pblk
 = 0;

569 
m­
->
m_Ën
 = 
	`mš_t
(, m­->m_Ën, 
couÁ
);

570 
ş—nup
;

574 ià(
”r
 =ğ-
EIO
)

575 
ş—nup
;

580 ià(
	`ext4_has_ã©u»_big®loc
(
šode
->
i_sb
)) {

581 
	`EXT4_ERROR_INODE
(
šode
, "Can't‡llocate blocks for "

583  -
EFSCORRUPTED
;

587 
	`mem£t
(&
¬
, 0, (ar));

588 
¬
.
šode
 = inode;

589 
¬
.
logiÿl
 = 
m­
->
m_lblk
;

590 ià(
	`S_ISREG
(
šode
->
i_mode
))

591 
¬
.
æags
 = 
EXT4_MB_HINT_DATA
;

592 ià(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
)

593 
¬
.
æags
 |ğ
EXT4_MB_DELALLOC_RESERVED
;

594 ià(
æags
 & 
EXT4_GET_BLOCKS_METADATA_NOFAIL
)

595 
¬
.
æags
 |ğ
EXT4_MB_USE_RESERVED
;

597 
¬
.
gßl
 = 
	`ext4_fšd_gßl
(
šode
, 
m­
->
m_lblk
, 
·¹Ÿl
);

600 
šdœeù_blks
 = (
chaš
 + 
d•th
è- 
·¹Ÿl
 - 1;

606 
¬
.
Ën
 = 
	`ext4_blks_to_®loÿ‹
(
·¹Ÿl
, 
šdœeù_blks
,

607 
m­
->
m_Ën
, 
blocks_to_bound¬y
);

612 
”r
 = 
	`ext4_®loc_b¿nch
(
hªdË
, &
¬
, 
šdœeù_blks
,

613 
off£ts
 + (
·¹Ÿl
 - 
chaš
),…artial);

622 ià(!
”r
)

623 
”r
 = 
	`ext4_¥liû_b¿nch
(
hªdË
, &
¬
, 
·¹Ÿl
, 
šdœeù_blks
);

624 ià(
”r
)

625 
ş—nup
;

627 
m­
->
m_æags
 |ğ
EXT4_MAP_NEW
;

629 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

630 
couÁ
 = 
¬
.
Ën
;

631 
gÙ_™
:

632 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

633 
m­
->
m_pblk
 = 
	`Ë32_to_ıu
(
chaš
[
d•th
-1].
key
);

634 
m­
->
m_Ën
 = 
couÁ
;

635 ià(
couÁ
 > 
blocks_to_bound¬y
)

636 
m­
->
m_æags
 |ğ
EXT4_MAP_BOUNDARY
;

637 
”r
 = 
couÁ
;

639 
·¹Ÿl
 = 
chaš
 + 
d•th
 - 1;

640 
ş—nup
:

641 
·¹Ÿl
 > 
chaš
) {

642 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "call brelse");

643 
	`b»l£
(
·¹Ÿl
->
bh
);

644 
·¹Ÿl
--;

646 
out
:

647 
	`Œaû_ext4_šd_m­_blocks_ex™
(
šode
, 
æags
, 
m­
, 
”r
);

648  
”r
;

649 
	}
}

655 
	$ext4_šd_ÿlc_m‘ad©a_amouÁ
(
šode
 *šode, 
£ùÜ_t
 
lblock
)

657 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

658 
£ùÜ_t
 
dšd_mask
 = ~((£ùÜ_t)
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
) - 1);

659 
blk_b™s
;

661 ià(
lblock
 < 
EXT4_NDIR_BLOCKS
)

664 
lblock
 -ğ
EXT4_NDIR_BLOCKS
;

666 ià(
ei
->
i_da_m‘ad©a_ÿlc_Ën
 &&

667 (
lblock
 & 
dšd_mask
è=ğ
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
) {

668 
ei
->
i_da_m‘ad©a_ÿlc_Ën
++;

671 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
 = 
lblock
 & 
dšd_mask
;

672 
ei
->
i_da_m‘ad©a_ÿlc_Ën
 = 1;

673 
blk_b™s
 = 
	`Üd”_ba£_2
(
lblock
);

674  (
blk_b™s
 / 
	`EXT4_ADDR_PER_BLOCK_BITS
(
šode
->
i_sb
)) + 1;

675 
	}
}

681 
	$ext4_šd_Œªs_blocks
(
šode
 *šode, 
Äblocks
)

688  
	`DIV_ROUND_UP
(
Äblocks
, 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
)) + 4;

689 
	}
}

703 
	$Œy_to_ex‹nd_Œª§ùiÚ
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

705 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

707 ià(
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
, 
EXT4_RESERVE_TRANS_BLOCKS
+1))

709 ià(!
	`ext4_jouº®_ex‹nd
(
hªdË
, 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
)))

712 
	}
}

719 
šlše
 
	$®l_z”Ûs
(
__Ë32
 *
p
, __Ë32 *
q
)

721 
p
 < 
q
)

722 ià(*
p
++)

725 
	}
}

762 
Indœeù
 *
	$ext4_fšd_sh¬ed
(
šode
 *šode, 
d•th
,

763 
ext4_lblk_t
 
off£ts
[4], 
Indœeù
 
chaš
[4],

764 
__Ë32
 *
tİ
)

766 
Indœeù
 *
·¹Ÿl
, *
p
;

767 
k
, 
”r
;

769 *
tİ
 = 0;

771 
k
 = 
d•th
; k > 1 && !
off£ts
[k-1]; k--)

773 
·¹Ÿl
 = 
	`ext4_g‘_b¿nch
(
šode
, 
k
, 
off£ts
, 
chaš
, &
”r
);

775 ià(!
·¹Ÿl
)

776 
·¹Ÿl
 = 
chaš
 + 
k
-1;

781 ià(!
·¹Ÿl
->
key
 && *·¹Ÿl->
p
)

783 
no_tİ
;

784 
p
 = 
·¹Ÿl
; (°> 
chaš
è&& 
	`®l_z”Ûs
((
__Ë32
 *èp->
bh
->
b_d©a
,…->p);…--)

792 ià(
p
 =ğ
chaš
 + 
k
 - 1 &&… > chain) {

793 
p
->p--;

795 *
tİ
 = *
p
->p;

798 *
p
->p = 0;

803 
·¹Ÿl
 > 
p
) {

804 
	`b»l£
(
·¹Ÿl
->
bh
);

805 
·¹Ÿl
--;

807 
no_tİ
:

808  
·¹Ÿl
;

809 
	}
}

822 
	$ext4_ş—r_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

823 
bufãr_h—d
 *
bh
,

824 
ext4_fsblk_t
 
block_to_ä“
,

825 
couÁ
, 
__Ë32
 *
fœ¡
,

826 
__Ë32
 *
Ï¡
)

828 
__Ë32
 *
p
;

829 
æags
 = 
EXT4_FREE_BLOCKS_VALIDATED
;

830 
”r
;

832 ià(
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode) ||

833 
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EA_INODE
))

834 
æags
 |ğ
EXT4_FREE_BLOCKS_FORGET
 | 
EXT4_FREE_BLOCKS_METADATA
;

835 ià(
	`ext4_should_jouº®_d©a
(
šode
))

836 
æags
 |ğ
EXT4_FREE_BLOCKS_FORGET
;

838 ià(!
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
), 
block_to_ä“
,

839 
couÁ
)) {

840 
	`EXT4_ERROR_INODE
(
šode
, "attempto clear invalid "

842 (è
block_to_ä“
, 
couÁ
);

846 ià(
	`Œy_to_ex‹nd_Œª§ùiÚ
(
hªdË
, 
šode
)) {

847 ià(
bh
) {

848 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

849 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

850 ià(
	`uÆik–y
(
”r
))

851 
out_”r
;

853 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

854 ià(
	`uÆik–y
(
”r
))

855 
out_”r
;

856 
”r
 = 
	`ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË
, 
šode
,

857 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
));

858 ià(
	`uÆik–y
(
”r
))

859 
out_”r
;

860 ià(
bh
) {

861 
	`BUFFER_TRACE
(
bh
, "retaking write‡ccess");

862 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

863 ià(
	`uÆik–y
(
”r
))

864 
out_”r
;

868 
p
 = 
fœ¡
;… < 
Ï¡
;…++)

869 *
p
 = 0;

871 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
block_to_ä“
, 
couÁ
, 
æags
);

873 
out_”r
:

874 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

875  
”r
;

876 
	}
}

897 
	$ext4_ä“_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

898 
bufãr_h—d
 *
this_bh
,

899 
__Ë32
 *
fœ¡
, __Ë32 *
Ï¡
)

901 
ext4_fsblk_t
 
block_to_ä“
 = 0;

902 
couÁ
 = 0;

903 
__Ë32
 *
block_to_ä“_p
 = 
NULL
;

906 
ext4_fsblk_t
 
Ä
;

907 
__Ë32
 *
p
;

909 
”r
 = 0;

911 ià(
this_bh
) {

912 
	`BUFFER_TRACE
(
this_bh
, "get_write_access");

913 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
this_bh
);

916 ià(
”r
)

920 
p
 = 
fœ¡
;… < 
Ï¡
;…++) {

921 
Ä
 = 
	`Ë32_to_ıu
(*
p
);

922 ià(
Ä
) {

924 ià(
couÁ
 == 0) {

925 
block_to_ä“
 = 
Ä
;

926 
block_to_ä“_p
 = 
p
;

927 
couÁ
 = 1;

928 } ià(
Ä
 =ğ
block_to_ä“
 + 
couÁ
) {

929 
couÁ
++;

931 
”r
 = 
	`ext4_ş—r_blocks
(
hªdË
, 
šode
, 
this_bh
,

932 
block_to_ä“
, 
couÁ
,

933 
block_to_ä“_p
, 
p
);

934 ià(
”r
)

936 
block_to_ä“
 = 
Ä
;

937 
block_to_ä“_p
 = 
p
;

938 
couÁ
 = 1;

943 ià(!
”r
 && 
couÁ
 > 0)

944 
”r
 = 
	`ext4_ş—r_blocks
(
hªdË
, 
šode
, 
this_bh
, 
block_to_ä“
,

945 
couÁ
, 
block_to_ä“_p
, 
p
);

946 ià(
”r
 < 0)

950 ià(
this_bh
) {

951 
	`BUFFER_TRACE
(
this_bh
, "callƒxt4_handle_dirty_metadata");

959 ià((
	`EXT4_JOURNAL
(
šode
è=ğ
NULL
è|| 
	`bh2jh
(
this_bh
))

960 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
this_bh
);

962 
	`EXT4_ERROR_INODE
(
šode
,

965 (è
this_bh
->
b_blockÄ
);

967 
	}
}

982 
	$ext4_ä“_b¿nches
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

983 
bufãr_h—d
 *
·»Á_bh
,

984 
__Ë32
 *
fœ¡
, __Ë32 *
Ï¡
, 
d•th
)

986 
ext4_fsblk_t
 
Ä
;

987 
__Ë32
 *
p
;

989 ià(
	`ext4_hªdË_is_abÜ‹d
(
hªdË
))

992 ià(
d•th
--) {

993 
bufãr_h—d
 *
bh
;

994 
addr_³r_block
 = 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
);

995 
p
 = 
Ï¡
;

996 --
p
 >ğ
fœ¡
) {

997 
Ä
 = 
	`Ë32_to_ıu
(*
p
);

998 ià(!
Ä
)

1001 ià(!
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
),

1002 
Ä
, 1)) {

1003 
	`EXT4_ERROR_INODE
(
šode
,

1006 (è
Ä
, 
d•th
);

1011 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
Ä
);

1017 ià(!
bh
) {

1018 
	`EXT4_ERROR_INODE_BLOCK
(
šode
, 
Ä
,

1024 
	`BUFFER_TRACE
(
bh
, "free child branches");

1025 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
bh
,

1026 (
__Ë32
 *è
bh
->
b_d©a
,

1027 (
__Ë32
 *è
bh
->
b_d©a
 + 
addr_³r_block
,

1028 
d•th
);

1029 
	`b»l£
(
bh
);

1047 ià(
	`ext4_hªdË_is_abÜ‹d
(
hªdË
))

1049 ià(
	`Œy_to_ex‹nd_Œª§ùiÚ
(
hªdË
, 
šode
)) {

1050 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1051 
	`ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË
, 
šode
,

1052 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
));

1066 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
Ä
, 1,

1067 
EXT4_FREE_BLOCKS_METADATA
|

1068 
EXT4_FREE_BLOCKS_FORGET
);

1070 ià(
·»Á_bh
) {

1075 
	`BUFFER_TRACE
(
·»Á_bh
, "get_write_access");

1076 ià(!
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
,

1077 
·»Á_bh
)){

1078 *
p
 = 0;

1079 
	`BUFFER_TRACE
(
·»Á_bh
,

1081 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
,

1082 
šode
,

1083 
·»Á_bh
);

1089 
	`BUFFER_TRACE
(
·»Á_bh
, "free data blocks");

1090 
	`ext4_ä“_d©a
(
hªdË
, 
šode
, 
·»Á_bh
, 
fœ¡
, 
Ï¡
);

1092 
	}
}

1094 
	$ext4_šd_Œunÿ‹
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

1096 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1097 
__Ë32
 *
i_d©a
 = 
ei
->i_data;

1098 
addr_³r_block
 = 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
);

1099 
ext4_lblk_t
 
off£ts
[4];

1100 
Indœeù
 
chaš
[4];

1101 
Indœeù
 *
·¹Ÿl
;

1102 
__Ë32
 
Ä
 = 0;

1103 
n
 = 0;

1104 
ext4_lblk_t
 
Ï¡_block
, 
max_block
;

1105 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

1107 
Ï¡_block
 = (
šode
->
i_size
 + 
blocksize
-1)

1108 >> 
	`EXT4_BLOCK_SIZE_BITS
(
šode
->
i_sb
);

1109 
max_block
 = (
	`EXT4_SB
(
šode
->
i_sb
)->
s_b™m­_maxby‹s
 + 
blocksize
-1)

1110 >> 
	`EXT4_BLOCK_SIZE_BITS
(
šode
->
i_sb
);

1112 ià(
Ï¡_block
 !ğ
max_block
) {

1113 
n
 = 
	`ext4_block_to_·th
(
šode
, 
Ï¡_block
, 
off£ts
, 
NULL
);

1114 ià(
n
 == 0)

1118 
	`ext4_es_»move_ex‹Á
(
šode
, 
Ï¡_block
, 
EXT_MAX_BLOCKS
 -†ast_block);

1127 
ei
->
i_disksize
 = 
šode
->
i_size
;

1129 ià(
Ï¡_block
 =ğ
max_block
) {

1135 } ià(
n
 == 1) {

1136 
	`ext4_ä“_d©a
(
hªdË
, 
šode
, 
NULL
, 
i_d©a
+
off£ts
[0],

1137 
i_d©a
 + 
EXT4_NDIR_BLOCKS
);

1138 
do_šdœeùs
;

1141 
·¹Ÿl
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n
, 
off£ts
, 
chaš
, &
Ä
);

1143 ià(
Ä
) {

1144 ià(
·¹Ÿl
 =ğ
chaš
) {

1146 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
,

1147 &
Ä
, &Ä+1, (
chaš
+
n
-1è- 
·¹Ÿl
);

1148 *
·¹Ÿl
->
p
 = 0;

1155 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "get_write_access");

1156 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1157 
·¹Ÿl
->
p
,

1158 
·¹Ÿl
->
p
+1, (
chaš
+
n
-1) -…artial);

1162 
·¹Ÿl
 > 
chaš
) {

1163 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,…¬tŸl->
p
 + 1,

1164 (
__Ë32
*)
·¹Ÿl
->
bh
->
b_d©a
+
addr_³r_block
,

1165 (
chaš
+
n
-1è- 
·¹Ÿl
);

1166 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "call brelse");

1167 
	`b»l£
(
·¹Ÿl
->
bh
);

1168 
·¹Ÿl
--;

1170 
do_šdœeùs
:

1172 
off£ts
[0]) {

1174 
Ä
 = 
i_d©a
[
EXT4_IND_BLOCK
];

1175 ià(
Ä
) {

1176 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 1);

1177 
i_d©a
[
EXT4_IND_BLOCK
] = 0;

1179 
EXT4_IND_BLOCK
:

1180 
Ä
 = 
i_d©a
[
EXT4_DIND_BLOCK
];

1181 ià(
Ä
) {

1182 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 2);

1183 
i_d©a
[
EXT4_DIND_BLOCK
] = 0;

1185 
EXT4_DIND_BLOCK
:

1186 
Ä
 = 
i_d©a
[
EXT4_TIND_BLOCK
];

1187 ià(
Ä
) {

1188 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 3);

1189 
i_d©a
[
EXT4_TIND_BLOCK
] = 0;

1191 
EXT4_TIND_BLOCK
:

1194 
	}
}

1206 
	$ext4_šd_»move_¥aû
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1207 
ext4_lblk_t
 
¡¬t
,ƒxt4_lblk_ˆ
’d
)

1209 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1210 
__Ë32
 *
i_d©a
 = 
ei
->i_data;

1211 
addr_³r_block
 = 
	`EXT4_ADDR_PER_BLOCK
(
šode
->
i_sb
);

1212 
ext4_lblk_t
 
off£ts
[4], 
off£ts2
[4];

1213 
Indœeù
 
chaš
[4], 
chaš2
[4];

1214 
Indœeù
 *
·¹Ÿl
, *
·¹Ÿl2
;

1215 
ext4_lblk_t
 
max_block
;

1216 
__Ë32
 
Ä
 = 0, 
Ä2
 = 0;

1217 
n
 = 0, 
n2
 = 0;

1218 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

1220 
max_block
 = (
	`EXT4_SB
(
šode
->
i_sb
)->
s_b™m­_maxby‹s
 + 
blocksize
-1)

1221 >> 
	`EXT4_BLOCK_SIZE_BITS
(
šode
->
i_sb
);

1222 ià(
’d
 >ğ
max_block
)

1223 
’d
 = 
max_block
;

1224 ià((
¡¬t
 >ğ
’d
è|| (¡¬ˆ> 
max_block
))

1227 
n
 = 
	`ext4_block_to_·th
(
šode
, 
¡¬t
, 
off£ts
, 
NULL
);

1228 
n2
 = 
	`ext4_block_to_·th
(
šode
, 
’d
, 
off£ts2
, 
NULL
);

1230 
	`BUG_ON
(
n
 > 
n2
);

1232 ià((
n
 =ğ1è&& (À=ğ
n2
)) {

1234 
	`ext4_ä“_d©a
(
hªdË
, 
šode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1235 
i_d©a
 + 
off£ts2
[0]);

1237 } ià(
n2
 > 
n
) {

1245 ià(
n
 == 1) {

1250 
	`ext4_ä“_d©a
(
hªdË
, 
šode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1251 
i_d©a
 + 
EXT4_NDIR_BLOCKS
);

1252 
’d_¿nge
;

1256 
·¹Ÿl
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n
, 
off£ts
, 
chaš
, &
Ä
);

1257 ià(
Ä
) {

1258 ià(
·¹Ÿl
 =ğ
chaš
) {

1260 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
,

1261 &
Ä
, &Ä+1, (
chaš
+
n
-1è- 
·¹Ÿl
);

1262 *
·¹Ÿl
->
p
 = 0;

1265 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "get_write_access");

1266 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1267 
·¹Ÿl
->
p
,

1268 
·¹Ÿl
->
p
+1, (
chaš
+
n
-1) -…artial);

1276 
·¹Ÿl
 > 
chaš
) {

1277 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1278 
·¹Ÿl
->
p
 + 1,

1279 (
__Ë32
 *)
·¹Ÿl
->
bh
->
b_d©a
+
addr_³r_block
,

1280 (
chaš
+
n
-1è- 
·¹Ÿl
);

1281 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "call brelse");

1282 
	`b»l£
(
·¹Ÿl
->
bh
);

1283 
·¹Ÿl
--;

1286 
’d_¿nge
:

1287 
·¹Ÿl2
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n2
, 
off£ts2
, 
chaš2
, &
Ä2
);

1288 ià(
Ä2
) {

1289 ià(
·¹Ÿl2
 =ğ
chaš2
) {

1296 
do_šdœeùs
;

1305 
·¹Ÿl2
->
p
++;

1312 
·¹Ÿl2
 > 
chaš2
) {

1313 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl2
->
bh
,

1314 (
__Ë32
 *)
·¹Ÿl2
->
bh
->
b_d©a
,

1315 
·¹Ÿl2
->
p
,

1316 (
chaš2
+
n2
-1è- 
·¹Ÿl2
);

1317 
	`BUFFER_TRACE
(
·¹Ÿl2
->
bh
, "call brelse");

1318 
	`b»l£
(
·¹Ÿl2
->
bh
);

1319 
·¹Ÿl2
--;

1321 
do_šdœeùs
;

1325 
·¹Ÿl
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n
, 
off£ts
, 
chaš
, &
Ä
);

1326 
·¹Ÿl2
 = 
	`ext4_fšd_sh¬ed
(
šode
, 
n2
, 
off£ts2
, 
chaš2
, &
Ä2
);

1329 ià(
Ä
) {

1330 
Ëv–
 = 
	`mš
(
·¹Ÿl
 - 
chaš
, 
·¹Ÿl2
 - 
chaš2
);

1331 
i
;

1332 
subŒ“
 = 1;

1334 
i
 = 0; i <ğ
Ëv–
; i++) {

1335 ià(
off£ts
[
i
] !ğ
off£ts2
[i]) {

1336 
subŒ“
 = 0;

1341 ià(!
subŒ“
) {

1342 ià(
·¹Ÿl
 =ğ
chaš
) {

1344 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
,

1345 &
Ä
, &nr+1,

1346 (
chaš
+
n
-1è- 
·¹Ÿl
);

1347 *
·¹Ÿl
->
p
 = 0;

1350 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "get_write_access");

1351 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1352 
·¹Ÿl
->
p
,

1353 
·¹Ÿl
->
p
+1,

1354 (
chaš
+
n
-1è- 
·¹Ÿl
);

1359 ià(!
Ä2
) {

1366 
·¹Ÿl2
->
p
++;

1369 
·¹Ÿl
 > 
chaš
 || 
·¹Ÿl2
 > 
chaš2
) {

1370 
d•th
 = (
chaš
+
n
-1è- 
·¹Ÿl
;

1371 
d•th2
 = (
chaš2
+
n2
-1è- 
·¹Ÿl2
;

1373 ià(
·¹Ÿl
 > 
chaš
 && 
·¹Ÿl2
 > 
chaš2
 &&

1374 
·¹Ÿl
->
bh
->
b_blockÄ
 =ğ
·¹Ÿl2
->bh->b_blocknr) {

1379 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1380 
·¹Ÿl
->
p
 + 1,

1381 
·¹Ÿl2
->
p
,

1382 (
chaš
+
n
-1è- 
·¹Ÿl
);

1383 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "call brelse");

1384 
	`b»l£
(
·¹Ÿl
->
bh
);

1385 
	`BUFFER_TRACE
(
·¹Ÿl2
->
bh
, "call brelse");

1386 
	`b»l£
(
·¹Ÿl2
->
bh
);

1397 ià(
·¹Ÿl
 > 
chaš
 && 
d•th
 <ğ
d•th2
) {

1398 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl
->
bh
,

1399 
·¹Ÿl
->
p
 + 1,

1400 (
__Ë32
 *)
·¹Ÿl
->
bh
->
b_d©a
+
addr_³r_block
,

1401 (
chaš
+
n
-1è- 
·¹Ÿl
);

1402 
	`BUFFER_TRACE
(
·¹Ÿl
->
bh
, "call brelse");

1403 
	`b»l£
(
·¹Ÿl
->
bh
);

1404 
·¹Ÿl
--;

1406 ià(
·¹Ÿl2
 > 
chaš2
 && 
d•th2
 <ğ
d•th
) {

1407 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
·¹Ÿl2
->
bh
,

1408 (
__Ë32
 *)
·¹Ÿl2
->
bh
->
b_d©a
,

1409 
·¹Ÿl2
->
p
,

1410 (
chaš2
+
n2
-1è- 
·¹Ÿl2
);

1411 
	`BUFFER_TRACE
(
·¹Ÿl2
->
bh
, "call brelse");

1412 
	`b»l£
(
·¹Ÿl2
->
bh
);

1413 
·¹Ÿl2
--;

1418 
do_šdœeùs
:

1420 
off£ts
[0]) {

1422 ià(++
n
 >ğ
n2
)

1424 
Ä
 = 
i_d©a
[
EXT4_IND_BLOCK
];

1425 ià(
Ä
) {

1426 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 1);

1427 
i_d©a
[
EXT4_IND_BLOCK
] = 0;

1429 
EXT4_IND_BLOCK
:

1430 ià(++
n
 >ğ
n2
)

1432 
Ä
 = 
i_d©a
[
EXT4_DIND_BLOCK
];

1433 ià(
Ä
) {

1434 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 2);

1435 
i_d©a
[
EXT4_DIND_BLOCK
] = 0;

1437 
EXT4_DIND_BLOCK
:

1438 ià(++
n
 >ğ
n2
)

1440 
Ä
 = 
i_d©a
[
EXT4_TIND_BLOCK
];

1441 ià(
Ä
) {

1442 
	`ext4_ä“_b¿nches
(
hªdË
, 
šode
, 
NULL
, &
Ä
, &nr+1, 3);

1443 
i_d©a
[
EXT4_TIND_BLOCK
] = 0;

1445 
EXT4_TIND_BLOCK
:

1449 
	}
}

	@inline.c

15 
	~<lšux/f›m­.h
>

17 
	~"ext4_jbd2.h
"

18 
	~"ext4.h
"

19 
	~"x©Œ.h
"

20 
	~"Œunÿ‹.h
"

22 
	#EXT4_XATTR_SYSTEM_DATA
 "d©a"

	)

23 
	#EXT4_MIN_INLINE_DATA_SIZE
 (((
__Ë32
è* 
EXT4_N_BLOCKS
))

	)

24 
	#EXT4_INLINE_DOTDOT_OFFSET
 2

	)

25 
	#EXT4_INLINE_DOTDOT_SIZE
 4

	)

27 
	$ext4_g‘_šlše_size
(
šode
 *inode)

29 ià(
	`EXT4_I
(
šode
)->
i_šlše_off
)

30  
	`EXT4_I
(
šode
)->
i_šlše_size
;

33 
	}
}

35 
	$g‘_max_šlše_x©Œ_v®ue_size
(
šode
 *inode,

36 
ext4_oc
 *
oc
)

38 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

39 
ext4_x©Œ_’Œy
 *
’Œy
;

40 
ext4_šode
 *
¿w_šode
;

41 
ä“
, 
mš_offs
;

43 
mš_offs
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
 -

44 
EXT4_GOOD_OLD_INODE_SIZE
 -

45 
	`EXT4_I
(
šode
)->
i_exŒa_isize
 -

46 (
ext4_x©Œ_ibody_h—d”
);

53 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
))

54  
	`EXT4_XATTR_SIZE
(
mš_offs
 -

55 
	`EXT4_XATTR_LEN
(
	`¡¾’
(
EXT4_XATTR_SYSTEM_DATA
)) -

56 
EXT4_XATTR_ROUND
 - (
__u32
));

58 
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

59 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

60 
’Œy
 = 
	`IFIRST
(
h—d”
);

63 ; !
	`IS_LAST_ENTRY
(
’Œy
);ƒÁry = 
	`EXT4_XATTR_NEXT
(entry)) {

64 ià(!
’Œy
->
e_v®ue_šum
 &&ƒÁry->
e_v®ue_size
) {

65 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

66 ià(
offs
 < 
mš_offs
)

67 
mš_offs
 = 
offs
;

70 
ä“
 = 
mš_offs
 -

71 ((*)
’Œy
 - (*)
	`IFIRST
(
h—d”
)è- (
__u32
);

73 ià(
	`EXT4_I
(
šode
)->
i_šlše_off
) {

74 
’Œy
 = (
ext4_x©Œ_’Œy
 *)

75 ((*)
¿w_šode
 + 
	`EXT4_I
(
šode
)->
i_šlše_off
);

77 
ä“
 +ğ
	`EXT4_XATTR_SIZE
(
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

78 
out
;

81 
ä“
 -ğ
	`EXT4_XATTR_LEN
(
	`¡¾’
(
EXT4_XATTR_SYSTEM_DATA
));

83 ià(
ä“
 > 
EXT4_XATTR_ROUND
)

84 
ä“
 = 
	`EXT4_XATTR_SIZE
(ä“ - 
EXT4_XATTR_ROUND
);

86 
ä“
 = 0;

88 
out
:

89  
ä“
;

90 
	}
}

97 
	$ext4_g‘_max_šlše_size
(
šode
 *inode)

99 
”rÜ
, 
max_šlše_size
;

100 
ext4_oc
 
oc
;

102 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

105 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

106 ià(
”rÜ
) {

107 
	`ext4_”rÜ_šode
(
šode
, 
__func__
, 
__LINE__
, 0,

109 
šode
->
i_šo
);

113 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

114 
max_šlše_size
 = 
	`g‘_max_šlše_x©Œ_v®ue_size
(
šode
, &
oc
);

115 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

117 
	`b»l£
(
oc
.
bh
);

119 ià(!
max_šlše_size
)

122  
max_šlše_size
 + 
EXT4_MIN_INLINE_DATA_SIZE
;

123 
	}
}

130 
	$ext4_fšd_šlše_d©a_nŞock
(
šode
 *inode)

132 
ext4_x©Œ_ibody_fšd
 
is
 = {

133 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

135 
ext4_x©Œ_šfo
 
i
 = {

136 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

137 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

139 
”rÜ
;

141 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

144 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
);

145 ià(
”rÜ
)

146  
”rÜ
;

148 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

149 ià(
”rÜ
)

150 
out
;

152 ià(!
is
.
s
.
nÙ_found
) {

153 
	`EXT4_I
(
šode
)->
i_šlše_off
 = (
u16
)((*)
is
.
s
.
h”e
 -

154 (*)
	`ext4_¿w_šode
(&
is
.
oc
));

155 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 +

156 
	`Ë32_to_ıu
(
is
.
s
.
h”e
->
e_v®ue_size
);

157 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

159 
out
:

160 
	`b»l£
(
is
.
oc
.
bh
);

161  
”rÜ
;

162 
	}
}

164 
	$ext4_»ad_šlše_d©a
(
šode
 *šode, *
bufãr
,

165 
Ën
,

166 
ext4_oc
 *
oc
)

168 
ext4_x©Œ_’Œy
 *
’Œy
;

169 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

170 
ı_Ën
 = 0;

171 
ext4_šode
 *
¿w_šode
;

173 ià(!
Ën
)

176 
	`BUG_ON
(
Ën
 > 
	`EXT4_I
(
šode
)->
i_šlše_size
);

178 
ı_Ën
 = 
Ën
 < 
EXT4_MIN_INLINE_DATA_SIZE
 ?

179 
Ën
 : 
EXT4_MIN_INLINE_DATA_SIZE
;

181 
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

182 
	`memıy
(
bufãr
, (*)(
¿w_šode
->
i_block
), 
ı_Ën
);

184 
Ën
 -ğ
ı_Ën
;

185 
bufãr
 +ğ
ı_Ën
;

187 ià(!
Ën
)

188 
out
;

190 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

191 
’Œy
 = (
ext4_x©Œ_’Œy
 *)((*)
¿w_šode
 +

192 
	`EXT4_I
(
šode
)->
i_šlše_off
);

193 
Ën
 = 
	`mš_t
(,†en,

194 ()
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

196 
	`memıy
(
bufãr
,

197 (*)
	`IFIRST
(
h—d”
è+ 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
), 
Ën
);

198 
ı_Ën
 +ğ
Ën
;

200 
out
:

201  
ı_Ën
;

202 
	}
}

210 
	$ext4_wr™e_šlše_d©a
(
šode
 *šode, 
ext4_oc
 *
oc
,

211 *
bufãr
, 
loff_t
 
pos
, 
Ën
)

213 
ext4_x©Œ_’Œy
 *
’Œy
;

214 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

215 
ext4_šode
 *
¿w_šode
;

216 
ı_Ën
 = 0;

218 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

221 
	`BUG_ON
(!
	`EXT4_I
(
šode
)->
i_šlše_off
);

222 
	`BUG_ON
(
pos
 + 
Ën
 > 
	`EXT4_I
(
šode
)->
i_šlše_size
);

224 
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

225 
bufãr
 +ğ
pos
;

227 ià(
pos
 < 
EXT4_MIN_INLINE_DATA_SIZE
) {

228 
ı_Ën
 = 
pos
 + 
Ën
 > 
EXT4_MIN_INLINE_DATA_SIZE
 ?

229 
EXT4_MIN_INLINE_DATA_SIZE
 - 
pos
 : 
Ën
;

230 
	`memıy
((*)
¿w_šode
->
i_block
 + 
pos
, 
bufãr
, 
ı_Ën
);

232 
Ën
 -ğ
ı_Ën
;

233 
bufãr
 +ğ
ı_Ën
;

234 
pos
 +ğ
ı_Ën
;

237 ià(!
Ën
)

240 
pos
 -ğ
EXT4_MIN_INLINE_DATA_SIZE
;

241 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

242 
’Œy
 = (
ext4_x©Œ_’Œy
 *)((*)
¿w_šode
 +

243 
	`EXT4_I
(
šode
)->
i_šlše_off
);

245 
	`memıy
((*)
	`IFIRST
(
h—d”
è+ 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
è+ 
pos
,

246 
bufãr
, 
Ën
);

247 
	}
}

249 
	$ext4_ü—‹_šlše_d©a
(
hªdË_t
 *
hªdË
,

250 
šode
 *šode, 
Ën
)

252 
”rÜ
;

253 *
v®ue
 = 
NULL
;

254 
ext4_x©Œ_ibody_fšd
 
is
 = {

255 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

257 
ext4_x©Œ_šfo
 
i
 = {

258 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

259 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

262 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
);

263 ià(
”rÜ
)

264  
”rÜ
;

266 
	`BUFFER_TRACE
(
is
.
oc
.
bh
, "get_write_access");

267 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
is
.
oc
.
bh
);

268 ià(
”rÜ
)

269 
out
;

271 ià(
Ën
 > 
EXT4_MIN_INLINE_DATA_SIZE
) {

272 
v®ue
 = 
EXT4_ZERO_XATTR_VALUE
;

273 
Ën
 -ğ
EXT4_MIN_INLINE_DATA_SIZE
;

275 
v®ue
 = "";

276 
Ën
 = 0;

280 
i
.
v®ue
 = value;

281 
i
.
v®ue_Ën
 = 
Ën
;

283 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

284 ià(
”rÜ
)

285 
out
;

287 
	`BUG_ON
(!
is
.
s
.
nÙ_found
);

289 
”rÜ
 = 
	`ext4_x©Œ_ibody_šlše_£t
(
hªdË
, 
šode
, &
i
, &
is
);

290 ià(
”rÜ
) {

291 ià(
”rÜ
 =ğ-
ENOSPC
)

292 
	`ext4_ş—r_šode_¡©e
(
šode
,

293 
EXT4_STATE_MAY_INLINE_DATA
);

294 
out
;

297 
	`mem£t
((*)
	`ext4_¿w_šode
(&
is
.
oc
)->
i_block
,

298 0, 
EXT4_MIN_INLINE_DATA_SIZE
);

300 
	`EXT4_I
(
šode
)->
i_šlše_off
 = (
u16
)((*)
is
.
s
.
h”e
 -

301 (*)
	`ext4_¿w_šode
(&
is
.
oc
));

302 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 
Ën
 + 
EXT4_MIN_INLINE_DATA_SIZE
;

303 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

304 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_INLINE_DATA
);

309 
	`ext4_£t_šode_æags
(
šode
);

310 
	`g‘_bh
(
is
.
oc
.
bh
);

311 
”rÜ
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
is
.
oc
);

313 
out
:

314 
	`b»l£
(
is
.
oc
.
bh
);

315  
”rÜ
;

316 
	}
}

318 
	$ext4_upd©e_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

319 
Ën
)

321 
”rÜ
;

322 *
v®ue
 = 
NULL
;

323 
ext4_x©Œ_ibody_fšd
 
is
 = {

324 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

326 
ext4_x©Œ_šfo
 
i
 = {

327 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

328 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

332 ià(
Ën
 <ğ
	`EXT4_I
(
šode
)->
i_šlše_size
)

335 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
);

336 ià(
”rÜ
)

337  
”rÜ
;

339 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

340 ià(
”rÜ
)

341 
out
;

343 
	`BUG_ON
(
is
.
s
.
nÙ_found
);

345 
Ën
 -ğ
EXT4_MIN_INLINE_DATA_SIZE
;

346 
v®ue
 = 
	`kz®loc
(
Ën
, 
GFP_NOFS
);

347 ià(!
v®ue
) {

348 
”rÜ
 = -
ENOMEM
;

349 
out
;

352 
”rÜ
 = 
	`ext4_x©Œ_ibody_g‘
(
šode
, 
i
.
Çme_šdex
, i.
Çme
,

353 
v®ue
, 
Ën
);

354 ià(
”rÜ
 =ğ-
ENODATA
)

355 
out
;

357 
	`BUFFER_TRACE
(
is
.
oc
.
bh
, "get_write_access");

358 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
is
.
oc
.
bh
);

359 ià(
”rÜ
)

360 
out
;

363 
i
.
v®ue
 = value;

364 
i
.
v®ue_Ën
 = 
Ën
;

366 
”rÜ
 = 
	`ext4_x©Œ_ibody_šlše_£t
(
hªdË
, 
šode
, &
i
, &
is
);

367 ià(
”rÜ
)

368 
out
;

370 
	`EXT4_I
(
šode
)->
i_šlše_off
 = (
u16
)((*)
is
.
s
.
h”e
 -

371 (*)
	`ext4_¿w_šode
(&
is
.
oc
));

372 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 +

373 
	`Ë32_to_ıu
(
is
.
s
.
h”e
->
e_v®ue_size
);

374 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

375 
	`g‘_bh
(
is
.
oc
.
bh
);

376 
”rÜ
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
is
.
oc
);

378 
out
:

379 
	`kä“
(
v®ue
);

380 
	`b»l£
(
is
.
oc
.
bh
);

381  
”rÜ
;

382 
	}
}

384 
	$ext4_´•¬e_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

385 
Ën
)

387 
»t
, 
size
, 
no_ex·nd
;

388 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

390 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
))

391  -
ENOSPC
;

393 
size
 = 
	`ext4_g‘_max_šlše_size
(
šode
);

394 ià(
size
 < 
Ën
)

395  -
ENOSPC
;

397 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

399 ià(
ei
->
i_šlše_off
)

400 
»t
 = 
	`ext4_upd©e_šlše_d©a
(
hªdË
, 
šode
, 
Ën
);

402 
»t
 = 
	`ext4_ü—‹_šlše_d©a
(
hªdË
, 
šode
, 
Ën
);

404 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

405  
»t
;

406 
	}
}

408 
	$ext4_de¡roy_šlše_d©a_nŞock
(
hªdË_t
 *
hªdË
,

409 
šode
 *inode)

411 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

412 
ext4_x©Œ_ibody_fšd
 
is
 = {

413 .
s
 = { .
nÙ_found
 = 0, },

415 
ext4_x©Œ_šfo
 
i
 = {

416 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

417 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

418 .
v®ue
 = 
NULL
,

419 .
v®ue_Ën
 = 0,

421 
”rÜ
;

423 ià(!
ei
->
i_šlše_off
)

426 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
);

427 ià(
”rÜ
)

428  
”rÜ
;

430 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

431 ià(
”rÜ
)

432 
out
;

434 
	`BUFFER_TRACE
(
is
.
oc
.
bh
, "get_write_access");

435 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
is
.
oc
.
bh
);

436 ià(
”rÜ
)

437 
out
;

439 
”rÜ
 = 
	`ext4_x©Œ_ibody_šlše_£t
(
hªdË
, 
šode
, &
i
, &
is
);

440 ià(
”rÜ
)

441 
out
;

443 
	`mem£t
((*)
	`ext4_¿w_šode
(&
is
.
oc
)->
i_block
,

444 0, 
EXT4_MIN_INLINE_DATA_SIZE
);

446 ià(
	`ext4_has_ã©u»_ex‹Ás
(
šode
->
i_sb
)) {

447 ià(
	`S_ISDIR
(
šode
->
i_mode
) ||

448 
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode)) {

449 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

450 
	`ext4_ext_Œ“_š™
(
hªdË
, 
šode
);

453 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_INLINE_DATA
);

458 
	`ext4_£t_šode_æags
(
šode
);

460 
	`g‘_bh
(
is
.
oc
.
bh
);

461 
”rÜ
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
is
.
oc
);

463 
	`EXT4_I
(
šode
)->
i_šlše_off
 = 0;

464 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 0;

465 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

466 
out
:

467 
	`b»l£
(
is
.
oc
.
bh
);

468 ià(
”rÜ
 =ğ-
ENODATA
)

469 
”rÜ
 = 0;

470  
”rÜ
;

471 
	}
}

473 
	$ext4_»ad_šlše_·ge
(
šode
 *šode, 
·ge
 *page)

475 *
kaddr
;

476 
»t
 = 0;

477 
size_t
 
Ën
;

478 
ext4_oc
 
oc
;

480 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

481 
	`BUG_ON
(!
	`ext4_has_šlše_d©a
(
šode
));

482 
	`BUG_ON
(
·ge
->
šdex
);

484 ià(!
	`EXT4_I
(
šode
)->
i_šlše_off
) {

485 
	`ext4_w¬nšg
(
šode
->
i_sb
, "inode %lu doesn't have inline data.",

486 
šode
->
i_šo
);

487 
out
;

490 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

491 ià(
»t
)

492 
out
;

494 
Ën
 = 
	`mš_t
(
size_t
, 
	`ext4_g‘_šlše_size
(
šode
), 
	`i_size_»ad
(inode));

495 
kaddr
 = 
	`km­_©omic
(
·ge
);

496 
»t
 = 
	`ext4_»ad_šlše_d©a
(
šode
, 
kaddr
, 
Ën
, &
oc
);

497 
	`æush_dÿche_·ge
(
·ge
);

498 
	`kunm­_©omic
(
kaddr
);

499 
	`z”o_u£r_£gm’t
(
·ge
, 
Ën
, 
PAGE_SIZE
);

500 
	`S‘PageU±od©e
(
·ge
);

501 
	`b»l£
(
oc
.
bh
);

503 
out
:

504  
»t
;

505 
	}
}

507 
	$ext4_»ad·ge_šlše
(
šode
 *šode, 
·ge
 *page)

509 
»t
 = 0;

511 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

512 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

513 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

514  -
EAGAIN
;

521 ià(!
·ge
->
šdex
)

522 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

523 ià(!
	`PageU±od©e
(
·ge
)) {

524 
	`z”o_u£r_£gm’t
(
·ge
, 0, 
PAGE_SIZE
);

525 
	`S‘PageU±od©e
(
·ge
);

528 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

530 
	`uÆock_·ge
(
·ge
);

531  
»t
 >= 0 ? 0 :„et;

532 
	}
}

534 
	$ext4_cÚv”t_šlše_d©a_to_ex‹Á
(
add»ss_¥aû
 *
m­pšg
,

535 
šode
 *inode,

536 
æags
)

538 
»t
, 
Ãeded_blocks
, 
no_ex·nd
;

539 
hªdË_t
 *
hªdË
 = 
NULL
;

540 
»Œ›s
 = 0, 
£m_h–d
 = 0;

541 
·ge
 *·gğ
NULL
;

542 
äom
, 
to
;

543 
ext4_oc
 
oc
;

545 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

550 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

554 
Ãeded_blocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

556 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

557 ià(
»t
)

558  
»t
;

560 
»Œy
:

561 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
, 
Ãeded_blocks
);

562 ià(
	`IS_ERR
(
hªdË
)) {

563 
»t
 = 
	`PTR_ERR
(
hªdË
);

564 
hªdË
 = 
NULL
;

565 
out
;

570 
æags
 |ğ
AOP_FLAG_NOFS
;

572 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 0, 
æags
);

573 ià(!
·ge
) {

574 
»t
 = -
ENOMEM
;

575 
out
;

578 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

579 
£m_h–d
 = 1;

581 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

582 
»t
 = 0;

583 
out
;

586 
äom
 = 0;

587 
to
 = 
	`ext4_g‘_šlše_size
(
šode
);

588 ià(!
	`PageU±od©e
(
·ge
)) {

589 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

590 ià(
»t
 < 0)

591 
out
;

594 
»t
 = 
	`ext4_de¡roy_šlše_d©a_nŞock
(
hªdË
, 
šode
);

595 ià(
»t
)

596 
out
;

598 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
)) {

599 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
äom
, 
to
,

600 
ext4_g‘_block_unwr™‹n
);

602 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
äom
, 
to
, 
ext4_g‘_block
);

604 ià(!
»t
 && 
	`ext4_should_jouº®_d©a
(
šode
)) {

605 
»t
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
	`·ge_bufãrs
(
·ge
),

606 
äom
, 
to
, 
NULL
,

607 
do_jouº®_g‘_wr™e_acûss
);

610 ià(
»t
) {

611 
	`uÆock_·ge
(
·ge
);

612 
	`put_·ge
(
·ge
);

613 
·ge
 = 
NULL
;

614 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

615 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

616 
£m_h–d
 = 0;

617 
	`ext4_jouº®_¡İ
(
hªdË
);

618 
hªdË
 = 
NULL
;

619 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

626 ià(
šode
->
i_Æšk
)

627 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

630 ià(
»t
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

631 
»Œy
;

633 ià(
·ge
)

634 
	`block_comm™_wr™e
(
·ge
, 
äom
, 
to
);

635 
out
:

636 ià(
·ge
) {

637 
	`uÆock_·ge
(
·ge
);

638 
	`put_·ge
(
·ge
);

640 ià(
£m_h–d
)

641 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

642 ià(
hªdË
)

643 
	`ext4_jouº®_¡İ
(
hªdË
);

644 
	`b»l£
(
oc
.
bh
);

645  
»t
;

646 
	}
}

654 
	$ext4_Œy_to_wr™e_šlše_d©a
(
add»ss_¥aû
 *
m­pšg
,

655 
šode
 *inode,

656 
loff_t
 
pos
, 
Ën
,

657 
æags
,

658 
·ge
 **
·g•
)

660 
»t
;

661 
hªdË_t
 *
hªdË
;

662 
·ge
 *page;

663 
ext4_oc
 
oc
;

665 ià(
pos
 + 
Ën
 > 
	`ext4_g‘_max_šlše_size
(
šode
))

666 
cÚv”t
;

668 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

669 ià(
»t
)

670  
»t
;

676 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

677 ià(
	`IS_ERR
(
hªdË
)) {

678 
»t
 = 
	`PTR_ERR
(
hªdË
);

679 
hªdË
 = 
NULL
;

680 
out
;

683 
»t
 = 
	`ext4_´•¬e_šlše_d©a
(
hªdË
, 
šode
, 
pos
 + 
Ën
);

684 ià(
»t
 &&„‘ !ğ-
ENOSPC
)

685 
out
;

688 ià(
»t
 =ğ-
ENOSPC
) {

689 
	`ext4_jouº®_¡İ
(
hªdË
);

690 
	`b»l£
(
oc
.
bh
);

691 
cÚv”t
;

694 
æags
 |ğ
AOP_FLAG_NOFS
;

696 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 0, 
æags
);

697 ià(!
·ge
) {

698 
»t
 = -
ENOMEM
;

699 
out
;

702 *
·g•
 = 
·ge
;

703 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

704 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

705 
»t
 = 0;

706 
	`uÆock_·ge
(
·ge
);

707 
	`put_·ge
(
·ge
);

708 
out_up_»ad
;

711 ià(!
	`PageU±od©e
(
·ge
)) {

712 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

713 ià(
»t
 < 0)

714 
out_up_»ad
;

717 
»t
 = 1;

718 
hªdË
 = 
NULL
;

719 
out_up_»ad
:

720 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

721 
out
:

722 ià(
hªdË
)

723 
	`ext4_jouº®_¡İ
(
hªdË
);

724 
	`b»l£
(
oc
.
bh
);

725  
»t
;

726 
cÚv”t
:

727  
	`ext4_cÚv”t_šlše_d©a_to_ex‹Á
(
m­pšg
,

728 
šode
, 
æags
);

729 
	}
}

731 
	$ext4_wr™e_šlše_d©a_’d
(
šode
 *šode, 
loff_t
 
pos
, 
Ën
,

732 
cİ›d
, 
·ge
 *page)

734 
»t
, 
no_ex·nd
;

735 *
kaddr
;

736 
ext4_oc
 
oc
;

738 ià(
	`uÆik–y
(
cİ›d
 < 
Ën
)) {

739 ià(!
	`PageU±od©e
(
·ge
)) {

740 
cİ›d
 = 0;

741 
out
;

745 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

746 ià(
»t
) {

747 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
»t
);

748 
cİ›d
 = 0;

749 
out
;

752 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

753 
	`BUG_ON
(!
	`ext4_has_šlše_d©a
(
šode
));

755 
kaddr
 = 
	`km­_©omic
(
·ge
);

756 
	`ext4_wr™e_šlše_d©a
(
šode
, &
oc
, 
kaddr
, 
pos
, 
Ën
);

757 
	`kunm­_©omic
(
kaddr
);

758 
	`S‘PageU±od©e
(
·ge
);

760 
	`CË¬PageDœty
(
·ge
);

762 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

763 
	`b»l£
(
oc
.
bh
);

764 
	`ext4_fc_Œack_šode
(
šode
);

765 
	`m¬k_šode_dœty
(
šode
);

766 
out
:

767  
cİ›d
;

768 
	}
}

770 
bufãr_h—d
 *

771 
	$ext4_jouº®Ëd_wr™e_šlše_d©a
(
šode
 *inode,

772 
Ën
,

773 
·ge
 *page)

775 
»t
, 
no_ex·nd
;

776 *
kaddr
;

777 
ext4_oc
 
oc
;

779 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

780 ià(
»t
) {

781 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
»t
);

782  
NULL
;

785 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

786 
kaddr
 = 
	`km­_©omic
(
·ge
);

787 
	`ext4_wr™e_šlše_d©a
(
šode
, &
oc
, 
kaddr
, 0, 
Ën
);

788 
	`kunm­_©omic
(
kaddr
);

789 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

791  
oc
.
bh
;

792 
	}
}

803 
	$ext4_da_cÚv”t_šlše_d©a_to_ex‹Á
(
add»ss_¥aû
 *
m­pšg
,

804 
šode
 *inode,

805 
æags
,

806 **
fsd©a
)

808 
»t
 = 0, 
šlše_size
;

809 
·ge
 *page;

811 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 0, 
æags
);

812 ià(!
·ge
)

813  -
ENOMEM
;

815 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

816 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

817 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

818 
out
;

821 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

823 ià(!
	`PageU±od©e
(
·ge
)) {

824 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

825 ià(
»t
 < 0)

826 
out
;

829 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 0, 
šlše_size
,

830 
ext4_da_g‘_block_´•
);

831 ià(
»t
) {

832 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

833 
	`uÆock_·ge
(
·ge
);

834 
	`put_·ge
(
·ge
);

835 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

836  
»t
;

839 
	`S‘PageDœty
(
·ge
);

840 
	`S‘PageU±od©e
(
·ge
);

841 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

842 *
fsd©a
 = (*)
CONVERT_INLINE_DATA
;

844 
out
:

845 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

846 ià(
·ge
) {

847 
	`uÆock_·ge
(
·ge
);

848 
	`put_·ge
(
·ge
);

850  
»t
;

851 
	}
}

861 
	$ext4_da_wr™e_šlše_d©a_begš
(
add»ss_¥aû
 *
m­pšg
,

862 
šode
 *inode,

863 
loff_t
 
pos
, 
Ën
,

864 
æags
,

865 
·ge
 **
·g•
,

866 **
fsd©a
)

868 
»t
, 
šlše_size
;

869 
hªdË_t
 *
hªdË
;

870 
·ge
 *page;

871 
ext4_oc
 
oc
;

872 
»Œ›s
;

874 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

875 ià(
»t
)

876  
»t
;

878 
»Œy_jouº®
:

879 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

880 ià(
	`IS_ERR
(
hªdË
)) {

881 
»t
 = 
	`PTR_ERR
(
hªdË
);

882 
out
;

885 
šlše_size
 = 
	`ext4_g‘_max_šlše_size
(
šode
);

887 
»t
 = -
ENOSPC
;

888 ià(
šlše_size
 >ğ
pos
 + 
Ën
) {

889 
»t
 = 
	`ext4_´•¬e_šlše_d©a
(
hªdË
, 
šode
, 
pos
 + 
Ën
);

890 ià(
»t
 &&„‘ !ğ-
ENOSPC
)

891 
out_jouº®
;

898 
æags
 |ğ
AOP_FLAG_NOFS
;

900 ià(
»t
 =ğ-
ENOSPC
) {

901 
»t
 = 
	`ext4_da_cÚv”t_šlše_d©a_to_ex‹Á
(
m­pšg
,

902 
šode
,

903 
æags
,

904 
fsd©a
);

905 
	`ext4_jouº®_¡İ
(
hªdË
);

906 ià(
»t
 =ğ-
ENOSPC
 &&

907 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

908 
»Œy_jouº®
;

909 
out
;

913 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 0, 
æags
);

914 ià(!
·ge
) {

915 
»t
 = -
ENOMEM
;

916 
out_jouº®
;

919 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

920 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

921 
»t
 = 0;

922 
out_»Ëa£_·ge
;

925 ià(!
	`PageU±od©e
(
·ge
)) {

926 
»t
 = 
	`ext4_»ad_šlše_·ge
(
šode
, 
·ge
);

927 ià(
»t
 < 0)

928 
out_»Ëa£_·ge
;

931 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

932 *
·g•
 = 
·ge
;

933 
	`b»l£
(
oc
.
bh
);

935 
out_»Ëa£_·ge
:

936 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

937 
	`uÆock_·ge
(
·ge
);

938 
	`put_·ge
(
·ge
);

939 
out_jouº®
:

940 
	`ext4_jouº®_¡İ
(
hªdË
);

941 
out
:

942 
	`b»l£
(
oc
.
bh
);

943  
»t
;

944 
	}
}

946 
	$ext4_da_wr™e_šlše_d©a_’d
(
šode
 *šode, 
loff_t
 
pos
,

947 
Ën
, 
cİ›d
,

948 
·ge
 *page)

950 
i_size_chªged
 = 0;

951 
»t
;

953 
»t
 = 
	`ext4_wr™e_šlše_d©a_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
, 
·ge
);

954 ià(
»t
 < 0) {

955 
	`uÆock_·ge
(
·ge
);

956 
	`put_·ge
(
·ge
);

957  
»t
;

959 
cİ›d
 = 
»t
;

968 ià(
pos
+
cİ›d
 > 
šode
->
i_size
) {

969 
	`i_size_wr™e
(
šode
, 
pos
+
cİ›d
);

970 
i_size_chªged
 = 1;

972 
	`uÆock_·ge
(
·ge
);

973 
	`put_·ge
(
·ge
);

981 ià(
i_size_chªged
) {

982 
	`ext4_fc_Œack_šode
(
šode
);

983 
	`m¬k_šode_dœty
(
šode
);

986  
cİ›d
;

987 
	}
}

989 #ifdeà
INLINE_DIR_DEBUG


990 
	$ext4_show_šlše_dœ
(
šode
 *
dœ
, 
bufãr_h—d
 *
bh
,

991 *
šlše_¡¬t
, 
šlše_size
)

993 
off£t
;

994 
de_Ën
;

995 
ext4_dœ_’Œy_2
 *
de
 = 
šlše_¡¬t
;

996 *
dlim™
 = 
šlše_¡¬t
 + 
šlše_size
;

998 
	`Œaû_´štk
("šod%lu\n", 
dœ
->
i_šo
);

999 
off£t
 = 0;

1000 (*)
de
 < 
dlim™
) {

1001 
de_Ën
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
šlše_size
);

1002 
	`Œaû_´štk
("de: off %u„len %u‚ame %.*s‚len %u ino %u\n",

1003 
off£t
, 
de_Ën
, 
de
->
Çme_Ën
, de->
Çme
,

1004 
de
->
Çme_Ën
, 
	`Ë32_to_ıu
(de->
šode
));

1005 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

1006 
šlše_¡¬t
, 
šlše_size
, 
off£t
))

1007 
	`BUG
();

1009 
off£t
 +ğ
de_Ën
;

1010 
de
 = (
ext4_dœ_’Œy_2
 *è((*èd+ 
de_Ën
);

1012 
	}
}

1014 
	#ext4_show_šlše_dœ
(
dœ
, 
bh
, 
šlše_¡¬t
, 
šlše_size
)

	)

1022 
	$ext4_add_dœ’t_to_šlše
(
hªdË_t
 *
hªdË
,

1023 
ext4_f’ame
 *
âame
,

1024 
šode
 *
dœ
,

1025 
šode
 *inode,

1026 
ext4_oc
 *
oc
,

1027 *
šlše_¡¬t
, 
šlše_size
)

1029 
”r
;

1030 
ext4_dœ_’Œy_2
 *
de
;

1032 
”r
 = 
	`ext4_fšd_de¡_de
(
dœ
, 
šode
, 
oc
->
bh
, 
šlše_¡¬t
,

1033 
šlše_size
, 
âame
, &
de
);

1034 ià(
”r
)

1035  
”r
;

1037 
	`BUFFER_TRACE
(
oc
->
bh
, "get_write_access");

1038 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
->
bh
);

1039 ià(
”r
)

1040  
”r
;

1041 
	`ext4_š£¹_d’Œy
(
šode
, 
de
, 
šlše_size
, 
âame
);

1043 
	`ext4_show_šlše_dœ
(
dœ
, 
oc
->
bh
, 
šlše_¡¬t
, 
šlše_size
);

1056 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
	`cu¼’t_time
(dir);

1057 
	`ext4_upd©e_dx_æag
(
dœ
);

1058 
dœ
->
i_v”siÚ
++;

1060 
	}
}

1062 *
	$ext4_g‘_šlše_x©Œ_pos
(
šode
 *inode,

1063 
ext4_oc
 *
oc
)

1065 
ext4_x©Œ_’Œy
 *
’Œy
;

1066 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

1068 
	`BUG_ON
(!
	`EXT4_I
(
šode
)->
i_šlše_off
);

1070 
h—d”
 = 
	`IHDR
(
šode
, 
	`ext4_¿w_šode
(
oc
));

1071 
’Œy
 = (
ext4_x©Œ_’Œy
 *)((*)
	`ext4_¿w_šode
(
oc
) +

1072 
	`EXT4_I
(
šode
)->
i_šlše_off
);

1074  (*)
	`IFIRST
(
h—d”
è+ 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

1075 
	}
}

1078 
	$ext4_upd©e_fš®_de
(*
de_buf
, 
Şd_size
, 
Ãw_size
)

1080 
ext4_dœ_’Œy_2
 *
de
, *
´ev_de
;

1081 *
lim™
;

1082 
de_Ën
;

1084 
de
 = (
ext4_dœ_’Œy_2
 *)
de_buf
;

1085 ià(
Şd_size
) {

1086 
lim™
 = 
de_buf
 + 
Şd_size
;

1088 
´ev_de
 = 
de
;

1089 
de_Ën
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
Şd_size
);

1090 
de_buf
 +ğ
de_Ën
;

1091 
de
 = (
ext4_dœ_’Œy_2
 *)
de_buf
;

1092 } 
de_buf
 < 
lim™
);

1094 
´ev_de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
de_Ën
 + 
Ãw_size
 -

1095 
Şd_size
, 
Ãw_size
);

1098 
de
->
šode
 = 0;

1099 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
Ãw_size
,‚ew_size);

1101 
	}
}

1103 
	$ext4_upd©e_šlše_dœ
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

1104 
ext4_oc
 *
oc
)

1106 
»t
;

1107 
Şd_size
 = 
	`EXT4_I
(
dœ
)->
i_šlše_size
 - 
EXT4_MIN_INLINE_DATA_SIZE
;

1108 
Ãw_size
 = 
	`g‘_max_šlše_x©Œ_v®ue_size
(
dœ
, 
oc
);

1110 ià(
Ãw_size
 - 
Şd_size
 <ğ
	`EXT4_DIR_REC_LEN
(1))

1111  -
ENOSPC
;

1113 
»t
 = 
	`ext4_upd©e_šlše_d©a
(
hªdË
, 
dœ
,

1114 
Ãw_size
 + 
EXT4_MIN_INLINE_DATA_SIZE
);

1115 ià(
»t
)

1116  
»t
;

1118 
	`ext4_upd©e_fš®_de
(
	`ext4_g‘_šlše_x©Œ_pos
(
dœ
, 
oc
), 
Şd_size
,

1119 
	`EXT4_I
(
dœ
)->
i_šlše_size
 -

1120 
EXT4_MIN_INLINE_DATA_SIZE
);

1121 
dœ
->
i_size
 = 
	`EXT4_I
(dœ)->
i_disksize
 = EXT4_I(dœ)->
i_šlše_size
;

1123 
	}
}

1125 
	$ext4_»¡Üe_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1126 
ext4_oc
 *
oc
,

1127 *
buf
, 
šlše_size
)

1129 
	`ext4_ü—‹_šlše_d©a
(
hªdË
, 
šode
, 
šlše_size
);

1130 
	`ext4_wr™e_šlše_d©a
(
šode
, 
oc
, 
buf
, 0, 
šlše_size
);

1131 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

1132 
	}
}

1134 
	$ext4_fšish_cÚv”t_šlše_dœ
(
hªdË_t
 *
hªdË
,

1135 
šode
 *inode,

1136 
bufãr_h—d
 *
dœ_block
,

1137 *
buf
,

1138 
šlše_size
)

1140 
”r
, 
csum_size
 = 0, 
h—d”_size
 = 0;

1141 
ext4_dœ_’Œy_2
 *
de
;

1142 
ext4_dœ_’Œy_
 *
t
;

1143 *
rg‘
 = 
dœ_block
->
b_d©a
;

1149 
de
 = (
ext4_dœ_’Œy_2
 *)
rg‘
;

1150 
de
 = 
	`ext4_š™_dÙ_dÙdÙ
(
šode
, de,

1151 
šode
->
i_sb
->
s_blocksize
, 
csum_size
,

1152 
	`Ë32_to_ıu
(((
ext4_dœ_’Œy_2
 *)
buf
)->
šode
), 1);

1153 
h—d”_size
 = (*)
de
 - 
rg‘
;

1155 
	`memıy
((*)
de
, 
buf
 + 
EXT4_INLINE_DOTDOT_SIZE
,

1156 
šlše_size
 - 
EXT4_INLINE_DOTDOT_SIZE
);

1158 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

1159 
csum_size
 = (
ext4_dœ_’Œy_
);

1161 
šode
->
i_size
 = inode->
i_sb
->
s_blocksize
;

1162 
	`i_size_wr™e
(
šode
, inode->
i_sb
->
s_blocksize
);

1163 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_sb
->
s_blocksize
;

1164 
	`ext4_upd©e_fš®_de
(
dœ_block
->
b_d©a
,

1165 
šlše_size
 - 
EXT4_INLINE_DOTDOT_SIZE
 + 
h—d”_size
,

1166 
šode
->
i_sb
->
s_blocksize
 - 
csum_size
);

1168 ià(
csum_size
) {

1169 
t
 = 
	`EXT4_DIRENT_TAIL
(
dœ_block
->
b_d©a
,

1170 
šode
->
i_sb
->
s_blocksize
);

1171 
	`š™Ÿlize_dœ’t_
(
t
, 
šode
->
i_sb
->
s_blocksize
);

1173 
	`£t_bufãr_u±od©e
(
dœ_block
);

1174 
”r
 = 
	`ext4_hªdË_dœty_dœ’t_node
(
hªdË
, 
šode
, 
dœ_block
);

1175 ià(
”r
)

1176  
”r
;

1177 
	`£t_bufãr_v”if›d
(
dœ_block
);

1178  
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1179 
	}
}

1181 
	$ext4_cÚv”t_šlše_d©a_nŞock
(
hªdË_t
 *
hªdË
,

1182 
šode
 *inode,

1183 
ext4_oc
 *
oc
)

1185 
”rÜ
;

1186 *
buf
 = 
NULL
;

1187 
bufãr_h—d
 *
d©a_bh
 = 
NULL
;

1188 
ext4_m­_blocks
 
m­
;

1189 
šlše_size
;

1191 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

1192 
buf
 = 
	`km®loc
(
šlše_size
, 
GFP_NOFS
);

1193 ià(!
buf
) {

1194 
”rÜ
 = -
ENOMEM
;

1195 
out
;

1198 
”rÜ
 = 
	`ext4_»ad_šlše_d©a
(
šode
, 
buf
, 
šlše_size
, 
oc
);

1199 ià(
”rÜ
 < 0)

1200 
out
;

1206 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

1207 
”rÜ
 = 
	`ext4_check_®l_de
(
šode
, 
oc
->
bh
,

1208 
buf
 + 
EXT4_INLINE_DOTDOT_SIZE
,

1209 
šlše_size
 - 
EXT4_INLINE_DOTDOT_SIZE
);

1210 ià(
”rÜ
)

1211 
out
;

1214 
”rÜ
 = 
	`ext4_de¡roy_šlše_d©a_nŞock
(
hªdË
, 
šode
);

1215 ià(
”rÜ
)

1216 
out
;

1218 
m­
.
m_lblk
 = 0;

1219 
m­
.
m_Ën
 = 1;

1220 
m­
.
m_æags
 = 0;

1221 
”rÜ
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
, 
EXT4_GET_BLOCKS_CREATE
);

1222 ià(
”rÜ
 < 0)

1223 
out_»¡Üe
;

1224 ià(!(
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
)) {

1225 
”rÜ
 = -
EIO
;

1226 
out_»¡Üe
;

1229 
d©a_bh
 = 
	`sb_g‘blk
(
šode
->
i_sb
, 
m­
.
m_pblk
);

1230 ià(!
d©a_bh
) {

1231 
”rÜ
 = -
ENOMEM
;

1232 
out_»¡Üe
;

1235 
	`lock_bufãr
(
d©a_bh
);

1236 
”rÜ
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
d©a_bh
);

1237 ià(
”rÜ
) {

1238 
	`uÆock_bufãr
(
d©a_bh
);

1239 
”rÜ
 = -
EIO
;

1240 
out_»¡Üe
;

1242 
	`mem£t
(
d©a_bh
->
b_d©a
, 0, 
šode
->
i_sb
->
s_blocksize
);

1244 ià(!
	`S_ISDIR
(
šode
->
i_mode
)) {

1245 
	`memıy
(
d©a_bh
->
b_d©a
, 
buf
, 
šlše_size
);

1246 
	`£t_bufãr_u±od©e
(
d©a_bh
);

1247 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
,

1248 
šode
, 
d©a_bh
);

1250 
”rÜ
 = 
	`ext4_fšish_cÚv”t_šlše_dœ
(
hªdË
, 
šode
, 
d©a_bh
,

1251 
buf
, 
šlše_size
);

1254 
	`uÆock_bufãr
(
d©a_bh
);

1255 
out_»¡Üe
:

1256 ià(
”rÜ
)

1257 
	`ext4_»¡Üe_šlše_d©a
(
hªdË
, 
šode
, 
oc
, 
buf
, 
šlše_size
);

1259 
out
:

1260 
	`b»l£
(
d©a_bh
);

1261 
	`kä“
(
buf
);

1262  
”rÜ
;

1263 
	}
}

1270 
	$ext4_Œy_add_šlše_’Œy
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

1271 
šode
 *
dœ
, inode *inode)

1273 
»t
, 
šlše_size
, 
no_ex·nd
;

1274 *
šlše_¡¬t
;

1275 
ext4_oc
 
oc
;

1277 
»t
 = 
	`ext4_g‘_šode_loc
(
dœ
, &
oc
);

1278 ià(
»t
)

1279  
»t
;

1281 
	`ext4_wr™e_lock_x©Œ
(
dœ
, &
no_ex·nd
);

1282 ià(!
	`ext4_has_šlše_d©a
(
dœ
))

1283 
out
;

1285 
šlše_¡¬t
 = (*)
	`ext4_¿w_šode
(&
oc
)->
i_block
 +

1286 
EXT4_INLINE_DOTDOT_SIZE
;

1287 
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 - 
EXT4_INLINE_DOTDOT_SIZE
;

1289 
»t
 = 
	`ext4_add_dœ’t_to_šlše
(
hªdË
, 
âame
, 
dœ
, 
šode
, &
oc
,

1290 
šlše_¡¬t
, 
šlše_size
);

1291 ià(
»t
 !ğ-
ENOSPC
)

1292 
out
;

1295 
šlše_size
 = 
	`EXT4_I
(
dœ
)->
i_šlše_size
 -

1296 
EXT4_MIN_INLINE_DATA_SIZE
;

1297 ià(!
šlše_size
) {

1299 
»t
 = 
	`ext4_upd©e_šlše_dœ
(
hªdË
, 
dœ
, &
oc
);

1300 ià(
»t
 &&„‘ !ğ-
ENOSPC
)

1301 
out
;

1303 
šlše_size
 = 
	`EXT4_I
(
dœ
)->
i_šlše_size
 -

1304 
EXT4_MIN_INLINE_DATA_SIZE
;

1307 ià(
šlše_size
) {

1308 
šlše_¡¬t
 = 
	`ext4_g‘_šlše_x©Œ_pos
(
dœ
, &
oc
);

1310 
»t
 = 
	`ext4_add_dœ’t_to_šlše
(
hªdË
, 
âame
, 
dœ
,

1311 
šode
, &
oc
, 
šlše_¡¬t
,

1312 
šlše_size
);

1314 ià(
»t
 !ğ-
ENOSPC
)

1315 
out
;

1323 
»t
 = 
	`ext4_cÚv”t_šlše_d©a_nŞock
(
hªdË
, 
dœ
, &
oc
);

1325 
out
:

1326 
	`ext4_wr™e_uÆock_x©Œ
(
dœ
, &
no_ex·nd
);

1327 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

1328 
	`b»l£
(
oc
.
bh
);

1329  
»t
;

1330 
	}
}

1337 
	$hŒ“_šlšedœ_to_Œ“
(
fe
 *
dœ_fe
,

1338 
šode
 *
dœ
, 
ext4_lblk_t
 
block
,

1339 
dx_hash_šfo
 *
hšfo
,

1340 
__u32
 
¡¬t_hash
, __u32 
¡¬t_mšÜ_hash
,

1341 *
has_šlše_d©a
)

1343 
”r
 = 0, 
couÁ
 = 0;

1344 
·»Á_šo
;

1345 
pos
;

1346 
ext4_dœ_’Œy_2
 *
de
;

1347 
šode
 *šodğ
	`fe_šode
(
dœ_fe
);

1348 
»t
, 
šlše_size
 = 0;

1349 
ext4_oc
 
oc
;

1350 *
dœ_buf
 = 
NULL
;

1351 
ext4_dœ_’Œy_2
 
çke
;

1352 
fsüy±_¡r
 
tmp_¡r
;

1354 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1355 ià(
»t
)

1356  
»t
;

1358 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1359 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

1360 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1361 *
has_šlše_d©a
 = 0;

1362 
out
;

1365 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

1366 
dœ_buf
 = 
	`km®loc
(
šlše_size
, 
GFP_NOFS
);

1367 ià(!
dœ_buf
) {

1368 
»t
 = -
ENOMEM
;

1369 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1370 
out
;

1373 
»t
 = 
	`ext4_»ad_šlše_d©a
(
šode
, 
dœ_buf
, 
šlše_size
, &
oc
);

1374 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1375 ià(
»t
 < 0)

1376 
out
;

1378 
pos
 = 0;

1379 
·»Á_šo
 = 
	`Ë32_to_ıu
(((
ext4_dœ_’Œy_2
 *)
dœ_buf
)->
šode
);

1380 
pos
 < 
šlše_size
) {

1386 ià(
pos
 == 0) {

1387 
çke
.
šode
 = 
	`ıu_to_Ë32
(šode->
i_šo
);

1388 
çke
.
Çme_Ën
 = 1;

1389 
	`¡rıy
(
çke
.
Çme
, ".");

1390 
çke
.
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

1391 
	`EXT4_DIR_REC_LEN
(
çke
.
Çme_Ën
),

1392 
šlše_size
);

1393 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, &
çke
, 
S_IFDIR
);

1394 
de
 = &
çke
;

1395 
pos
 = 
EXT4_INLINE_DOTDOT_OFFSET
;

1396 } ià(
pos
 =ğ
EXT4_INLINE_DOTDOT_OFFSET
) {

1397 
çke
.
šode
 = 
	`ıu_to_Ë32
(
·»Á_šo
);

1398 
çke
.
Çme_Ën
 = 2;

1399 
	`¡rıy
(
çke
.
Çme
, "..");

1400 
çke
.
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

1401 
	`EXT4_DIR_REC_LEN
(
çke
.
Çme_Ën
),

1402 
šlše_size
);

1403 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, &
çke
, 
S_IFDIR
);

1404 
de
 = &
çke
;

1405 
pos
 = 
EXT4_INLINE_DOTDOT_SIZE
;

1407 
de
 = (
ext4_dœ_’Œy_2
 *)(
dœ_buf
 + 
pos
);

1408 
pos
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
šlše_size
);

1409 ià(
	`ext4_check_dœ_’Œy
(
šode
, 
dœ_fe
, 
de
,

1410 
oc
.
bh
, 
dœ_buf
,

1411 
šlše_size
, 
pos
)) {

1412 
»t
 = 
couÁ
;

1413 
out
;

1417 
	`ext4fs_dœhash
(
de
->
Çme
, de->
Çme_Ën
, 
hšfo
);

1418 ià((
hšfo
->
hash
 < 
¡¬t_hash
) ||

1419 ((
hšfo
->
hash
 =ğ
¡¬t_hash
) &&

1420 (
hšfo
->
mšÜ_hash
 < 
¡¬t_mšÜ_hash
)))

1422 ià(
de
->
šode
 == 0)

1424 
tmp_¡r
.
Çme
 = 
de
->name;

1425 
tmp_¡r
.
Ën
 = 
de
->
Çme_Ën
;

1426 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
, 
hšfo
->
hash
,

1427 
hšfo
->
mšÜ_hash
, 
de
, &
tmp_¡r
);

1428 ià(
”r
) {

1429 
couÁ
 = 
”r
;

1430 
out
;

1432 
couÁ
++;

1434 
»t
 = 
couÁ
;

1435 
out
:

1436 
	`kä“
(
dœ_buf
);

1437 
	`b»l£
(
oc
.
bh
);

1438  
»t
;

1439 
	}
}

1449 
	$ext4_»ad_šlše_dœ
(
fe
 *file,

1450 
dœ_cÚ‹xt
 *
ùx
,

1451 *
has_šlše_d©a
)

1453 
off£t
, 
·»Á_šo
;

1454 
i
;

1455 
ext4_dœ_’Œy_2
 *
de
;

1456 
su³r_block
 *
sb
;

1457 
šode
 *šodğ
	`fe_šode
(
fe
);

1458 
»t
, 
šlše_size
 = 0;

1459 
ext4_oc
 
oc
;

1460 *
dœ_buf
 = 
NULL
;

1461 
dÙdÙ_off£t
, 
dÙdÙ_size
, 
exŒa_off£t
, 
exŒa_size
;

1463 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1464 ià(
»t
)

1465  
»t
;

1467 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1468 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

1469 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1470 *
has_šlše_d©a
 = 0;

1471 
out
;

1474 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

1475 
dœ_buf
 = 
	`km®loc
(
šlše_size
, 
GFP_NOFS
);

1476 ià(!
dœ_buf
) {

1477 
»t
 = -
ENOMEM
;

1478 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1479 
out
;

1482 
»t
 = 
	`ext4_»ad_šlše_d©a
(
šode
, 
dœ_buf
, 
šlše_size
, &
oc
);

1483 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1484 ià(
»t
 < 0)

1485 
out
;

1487 
»t
 = 0;

1488 
sb
 = 
šode
->
i_sb
;

1489 
·»Á_šo
 = 
	`Ë32_to_ıu
(((
ext4_dœ_’Œy_2
 *)
dœ_buf
)->
šode
);

1490 
off£t
 = 
ùx
->
pos
;

1499 
dÙdÙ_off£t
 = 
	`EXT4_DIR_REC_LEN
(1);

1500 
dÙdÙ_size
 = 
dÙdÙ_off£t
 + 
	`EXT4_DIR_REC_LEN
(2);

1501 
exŒa_off£t
 = 
dÙdÙ_size
 - 
EXT4_INLINE_DOTDOT_SIZE
;

1502 
exŒa_size
 = 
exŒa_off£t
 + 
šlše_size
;

1510 ià(
fe
->
f_v”siÚ
 !ğ
šode
->
i_v”siÚ
) {

1511 
i
 = 0; i < 
exŒa_size
 && i < 
off£t
;) {

1516 ià(!
i
) {

1517 
i
 = 
dÙdÙ_off£t
;

1519 } ià(
i
 =ğ
dÙdÙ_off£t
) {

1520 
i
 = 
dÙdÙ_size
;

1526 
de
 = (
ext4_dœ_’Œy_2
 *)

1527 (
dœ_buf
 + 
i
 - 
exŒa_off£t
);

1534 ià(
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
exŒa_size
)

1535 < 
	`EXT4_DIR_REC_LEN
(1))

1537 
i
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

1538 
exŒa_size
);

1540 
off£t
 = 
i
;

1541 
ùx
->
pos
 = 
off£t
;

1542 
fe
->
f_v”siÚ
 = 
šode
->
i_v”siÚ
;

1545 
ùx
->
pos
 < 
exŒa_size
) {

1546 ià(
ùx
->
pos
 == 0) {

1547 ià(!
	`dœ_em™
(
ùx
, ".", 1, 
šode
->
i_šo
, 
DT_DIR
))

1548 
out
;

1549 
ùx
->
pos
 = 
dÙdÙ_off£t
;

1553 ià(
ùx
->
pos
 =ğ
dÙdÙ_off£t
) {

1554 ià(!
	`dœ_em™
(
ùx
, "..", 2, 
·»Á_šo
, 
DT_DIR
))

1555 
out
;

1556 
ùx
->
pos
 = 
dÙdÙ_size
;

1560 
de
 = (
ext4_dœ_’Œy_2
 *)

1561 (
dœ_buf
 + 
ùx
->
pos
 - 
exŒa_off£t
);

1562 ià(
	`ext4_check_dœ_’Œy
(
šode
, 
fe
, 
de
, 
oc
.
bh
, 
dœ_buf
,

1563 
exŒa_size
, 
ùx
->
pos
))

1564 
out
;

1565 ià(
	`Ë32_to_ıu
(
de
->
šode
)) {

1566 ià(!
	`dœ_em™
(
ùx
, 
de
->
Çme
, de->
Çme_Ën
,

1567 
	`Ë32_to_ıu
(
de
->
šode
),

1568 
	`g‘_dty³
(
sb
, 
de
->
fe_ty³
)))

1569 
out
;

1571 
ùx
->
pos
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
exŒa_size
);

1573 
out
:

1574 
	`kä“
(
dœ_buf
);

1575 
	`b»l£
(
oc
.
bh
);

1576  
»t
;

1577 
	}
}

1579 
bufãr_h—d
 *
	$ext4_g‘_fœ¡_šlše_block
(
šode
 *inode,

1580 
ext4_dœ_’Œy_2
 **
·»Á_de
,

1581 *
»tv®
)

1583 
ext4_oc
 
oc
;

1585 *
»tv®
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1586 ià(*
»tv®
)

1587  
NULL
;

1589 *
·»Á_de
 = (
ext4_dœ_’Œy_2
 *)
	`ext4_¿w_šode
(&
oc
)->
i_block
;

1591  
oc
.
bh
;

1592 
	}
}

1599 
	$ext4_Œy_ü—‹_šlše_dœ
(
hªdË_t
 *
hªdË
, 
šode
 *
·»Á
,

1600 
šode
 *inode)

1602 
»t
, 
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
;

1603 
ext4_oc
 
oc
;

1604 
ext4_dœ_’Œy_2
 *
de
;

1606 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1607 ià(
»t
)

1608  
»t
;

1610 
»t
 = 
	`ext4_´•¬e_šlše_d©a
(
hªdË
, 
šode
, 
šlše_size
);

1611 ià(
»t
)

1612 
out
;

1618 
de
 = (
ext4_dœ_’Œy_2
 *)
	`ext4_¿w_šode
(&
oc
)->
i_block
;

1619 
de
->
šode
 = 
	`ıu_to_Ë32
(
·»Á
->
i_šo
);

1620 
de
 = (
ext4_dœ_’Œy_2
 *)((*)d+ 
EXT4_INLINE_DOTDOT_SIZE
);

1621 
de
->
šode
 = 0;

1622 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

1623 
šlše_size
 - 
EXT4_INLINE_DOTDOT_SIZE
,

1624 
šlše_size
);

1625 
	`£t_Æšk
(
šode
, 2);

1626 
šode
->
i_size
 = 
	`EXT4_I
(šode)->
i_disksize
 = 
šlše_size
;

1627 
out
:

1628 
	`b»l£
(
oc
.
bh
);

1629  
»t
;

1630 
	}
}

1632 
bufãr_h—d
 *
	$ext4_fšd_šlše_’Œy
(
šode
 *
dœ
,

1633 
ext4_f’ame
 *
âame
,

1634 
ext4_dœ_’Œy_2
 **
»s_dœ
,

1635 *
has_šlše_d©a
)

1637 
»t
;

1638 
ext4_oc
 
oc
;

1639 *
šlše_¡¬t
;

1640 
šlše_size
;

1642 ià(
	`ext4_g‘_šode_loc
(
dœ
, &
oc
))

1643  
NULL
;

1645 
	`down_»ad
(&
	`EXT4_I
(
dœ
)->
x©Œ_£m
);

1646 ià(!
	`ext4_has_šlše_d©a
(
dœ
)) {

1647 *
has_šlše_d©a
 = 0;

1648 
out
;

1651 
šlše_¡¬t
 = (*)
	`ext4_¿w_šode
(&
oc
)->
i_block
 +

1652 
EXT4_INLINE_DOTDOT_SIZE
;

1653 
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 - 
EXT4_INLINE_DOTDOT_SIZE
;

1654 
»t
 = 
	`ext4_£¬ch_dœ
(
oc
.
bh
, 
šlše_¡¬t
, 
šlše_size
,

1655 
dœ
, 
âame
, 0, 
»s_dœ
);

1656 ià(
»t
 == 1)

1657 
out_fšd
;

1658 ià(
»t
 < 0)

1659 
out
;

1661 ià(
	`ext4_g‘_šlše_size
(
dœ
è=ğ
EXT4_MIN_INLINE_DATA_SIZE
)

1662 
out
;

1664 
šlše_¡¬t
 = 
	`ext4_g‘_šlše_x©Œ_pos
(
dœ
, &
oc
);

1665 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
dœ
è- 
EXT4_MIN_INLINE_DATA_SIZE
;

1667 
»t
 = 
	`ext4_£¬ch_dœ
(
oc
.
bh
, 
šlše_¡¬t
, 
šlše_size
,

1668 
dœ
, 
âame
, 0, 
»s_dœ
);

1669 ià(
»t
 == 1)

1670 
out_fšd
;

1672 
out
:

1673 
	`b»l£
(
oc
.
bh
);

1674 
oc
.
bh
 = 
NULL
;

1675 
out_fšd
:

1676 
	`up_»ad
(&
	`EXT4_I
(
dœ
)->
x©Œ_£m
);

1677  
oc
.
bh
;

1678 
	}
}

1680 
	$ext4_d–‘e_šlše_’Œy
(
hªdË_t
 *
hªdË
,

1681 
šode
 *
dœ
,

1682 
ext4_dœ_’Œy_2
 *
de_d–
,

1683 
bufãr_h—d
 *
bh
,

1684 *
has_šlše_d©a
)

1686 
”r
, 
šlše_size
, 
no_ex·nd
;

1687 
ext4_oc
 
oc
;

1688 *
šlše_¡¬t
;

1690 
”r
 = 
	`ext4_g‘_šode_loc
(
dœ
, &
oc
);

1691 ià(
”r
)

1692  
”r
;

1694 
	`ext4_wr™e_lock_x©Œ
(
dœ
, &
no_ex·nd
);

1695 ià(!
	`ext4_has_šlše_d©a
(
dœ
)) {

1696 *
has_šlše_d©a
 = 0;

1697 
out
;

1700 ià((*)
de_d–
 - ((*)
	`ext4_¿w_šode
(&
oc
)->
i_block
) <

1701 
EXT4_MIN_INLINE_DATA_SIZE
) {

1702 
šlše_¡¬t
 = (*)
	`ext4_¿w_šode
(&
oc
)->
i_block
 +

1703 
EXT4_INLINE_DOTDOT_SIZE
;

1704 
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
 -

1705 
EXT4_INLINE_DOTDOT_SIZE
;

1707 
šlše_¡¬t
 = 
	`ext4_g‘_šlše_x©Œ_pos
(
dœ
, &
oc
);

1708 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
dœ
) -

1709 
EXT4_MIN_INLINE_DATA_SIZE
;

1712 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1713 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1714 ià(
”r
)

1715 
out
;

1717 
”r
 = 
	`ext4_g’”ic_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de_d–
, 
bh
,

1718 
šlše_¡¬t
, 
šlše_size
, 0);

1719 ià(
”r
)

1720 
out
;

1722 
	`ext4_show_šlše_dœ
(
dœ
, 
oc
.
bh
, 
šlše_¡¬t
, 
šlše_size
);

1723 
out
:

1724 
	`ext4_wr™e_uÆock_x©Œ
(
dœ
, &
no_ex·nd
);

1725 ià(
	`lik–y
(
”r
 == 0))

1726 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

1727 
	`b»l£
(
oc
.
bh
);

1728 ià(
”r
 !ğ-
ENOENT
)

1729 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

1730  
”r
;

1731 
	}
}

1736 
šlše
 
ext4_dœ_’Œy_2
 *

1737 
	$ext4_g‘_šlše_’Œy
(
šode
 *inode,

1738 
ext4_oc
 *
oc
,

1739 
off£t
,

1740 **
šlše_¡¬t
,

1741 *
šlše_size
)

1743 *
šlše_pos
;

1745 
	`BUG_ON
(
off£t
 > 
	`ext4_g‘_šlše_size
(
šode
));

1747 ià(
off£t
 < 
EXT4_MIN_INLINE_DATA_SIZE
) {

1748 
šlše_pos
 = (*)
	`ext4_¿w_šode
(
oc
)->
i_block
;

1749 *
šlše_size
 = 
EXT4_MIN_INLINE_DATA_SIZE
;

1751 
šlše_pos
 = 
	`ext4_g‘_šlše_x©Œ_pos
(
šode
, 
oc
);

1752 
off£t
 -ğ
EXT4_MIN_INLINE_DATA_SIZE
;

1753 *
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
) -

1754 
EXT4_MIN_INLINE_DATA_SIZE
;

1757 ià(
šlše_¡¬t
)

1758 *
šlše_¡¬t
 = 
šlše_pos
;

1759  (
ext4_dœ_’Œy_2
 *)(
šlše_pos
 + 
off£t
);

1760 
	}
}

1762 
boŞ
 
	$em±y_šlše_dœ
(
šode
 *
dœ
, *
has_šlše_d©a
)

1764 
”r
, 
šlše_size
;

1765 
ext4_oc
 
oc
;

1766 *
šlše_pos
;

1767 
off£t
;

1768 
ext4_dœ_’Œy_2
 *
de
;

1769 
boŞ
 
»t
 = 
Œue
;

1771 
”r
 = 
	`ext4_g‘_šode_loc
(
dœ
, &
oc
);

1772 ià(
”r
) {

1773 
	`EXT4_ERROR_INODE
(
dœ
, "error %d getting inode %lu block",

1774 
”r
, 
dœ
->
i_šo
);

1775  
Œue
;

1778 
	`down_»ad
(&
	`EXT4_I
(
dœ
)->
x©Œ_£m
);

1779 ià(!
	`ext4_has_šlše_d©a
(
dœ
)) {

1780 *
has_šlše_d©a
 = 0;

1781 
out
;

1784 
de
 = (
ext4_dœ_’Œy_2
 *)
	`ext4_¿w_šode
(&
oc
)->
i_block
;

1785 ià(!
	`Ë32_to_ıu
(
de
->
šode
)) {

1786 
	`ext4_w¬nšg
(
dœ
->
i_sb
,

1788 
dœ
->
i_šo
);

1789 
»t
 = 
Œue
;

1790 
out
;

1793 
off£t
 = 
EXT4_INLINE_DOTDOT_SIZE
;

1794 
off£t
 < 
dœ
->
i_size
) {

1795 
de
 = 
	`ext4_g‘_šlše_’Œy
(
dœ
, &
oc
, 
off£t
,

1796 &
šlše_pos
, &
šlše_size
);

1797 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
,

1798 
oc
.
bh
, 
šlše_pos
,

1799 
šlše_size
, 
off£t
)) {

1800 
	`ext4_w¬nšg
(
dœ
->
i_sb
,

1804 
dœ
->
i_šo
, 
	`Ë32_to_ıu
(
de
->
šode
),

1805 
	`Ë16_to_ıu
(
de
->
»c_Ën
), de->
Çme_Ën
,

1806 
šlše_size
);

1807 
»t
 = 
Œue
;

1808 
out
;

1810 ià(
	`Ë32_to_ıu
(
de
->
šode
)) {

1811 
»t
 = 
çl£
;

1812 
out
;

1814 
off£t
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
šlše_size
);

1817 
out
:

1818 
	`up_»ad
(&
	`EXT4_I
(
dœ
)->
x©Œ_£m
);

1819 
	`b»l£
(
oc
.
bh
);

1820  
»t
;

1821 
	}
}

1823 
	$ext4_de¡roy_šlše_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

1825 
»t
, 
no_ex·nd
;

1827 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

1828 
»t
 = 
	`ext4_de¡roy_šlše_d©a_nŞock
(
hªdË
, 
šode
);

1829 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

1831  
»t
;

1832 
	}
}

1834 
	$ext4_šlše_d©a_f›m­
(
šode
 *inode,

1835 
f›m­_ex‹Á_šfo
 *
f›šfo
,

1836 *
has_šlše
, 
__u64
 
¡¬t
, __u64 
Ën
)

1838 
__u64
 
physiÿl
 = 0;

1839 
__u64
 
šlše_Ën
;

1840 
__u32
 
æags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
 |

1841 
FIEMAP_EXTENT_LAST
;

1842 
”rÜ
 = 0;

1843 
ext4_oc
 
oc
;

1845 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1846 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

1847 *
has_šlše
 = 0;

1848 
out
;

1850 
šlše_Ën
 = 
	`mš_t
(
size_t
, 
	`ext4_g‘_šlše_size
(
šode
),

1851 
	`i_size_»ad
(
šode
));

1852 ià(
¡¬t
 >ğ
šlše_Ën
)

1853 
out
;

1854 ià(
¡¬t
 + 
Ën
 < 
šlše_Ën
)

1855 
šlše_Ën
 = 
¡¬t
 + 
Ën
;

1856 
šlše_Ën
 -ğ
¡¬t
;

1858 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1859 ià(
”rÜ
)

1860 
out
;

1862 
physiÿl
 = (
__u64
)
oc
.
bh
->
b_blockÄ
 << 
šode
->
i_sb
->
s_blocksize_b™s
;

1863 
physiÿl
 +ğ(*)
	`ext4_¿w_šode
(&
oc
è- iloc.
bh
->
b_d©a
;

1864 
physiÿl
 +ğ
	`off£tof
(
ext4_šode
, 
i_block
);

1866 ià(
physiÿl
)

1867 
”rÜ
 = 
	`f›m­_fl_Ãxt_ex‹Á
(
f›šfo
, 
¡¬t
, 
physiÿl
,

1868 
šlše_Ën
, 
æags
);

1869 
	`b»l£
(
oc
.
bh
);

1870 
out
:

1871 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

1872  (
”rÜ
 < 0 ?ƒrror : 0);

1873 
	}
}

1883 
	$ext4_Œy_to_eviù_šlše_d©a
(
hªdË_t
 *
hªdË
,

1884 
šode
 *inode,

1885 
Ãeded
)

1887 
”rÜ
;

1888 
ext4_x©Œ_’Œy
 *
’Œy
;

1889 
ext4_šode
 *
¿w_šode
;

1890 
ext4_oc
 
oc
;

1892 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

1893 ià(
”rÜ
)

1894  
”rÜ
;

1896 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

1897 
’Œy
 = (
ext4_x©Œ_’Œy
 *)((*)
¿w_šode
 +

1898 
	`EXT4_I
(
šode
)->
i_šlše_off
);

1899 ià(
	`EXT4_XATTR_LEN
(
’Œy
->
e_Çme_Ën
) +

1900 
	`EXT4_XATTR_SIZE
(
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
)è< 
Ãeded
) {

1901 
”rÜ
 = -
ENOSPC
;

1902 
out
;

1905 
”rÜ
 = 
	`ext4_cÚv”t_šlše_d©a_nŞock
(
hªdË
, 
šode
, &
oc
);

1906 
out
:

1907 
	`b»l£
(
oc
.
bh
);

1908  
”rÜ
;

1909 
	}
}

1911 
	$ext4_šlše_d©a_Œunÿ‹
(
šode
 *šode, *
has_šlše
)

1913 
hªdË_t
 *
hªdË
;

1914 
šlše_size
, 
v®ue_Ën
, 
Ãeded_blocks
, 
no_ex·nd
, 
”r
 = 0;

1915 
size_t
 
i_size
;

1916 *
v®ue
 = 
NULL
;

1917 
ext4_x©Œ_ibody_fšd
 
is
 = {

1918 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

1920 
ext4_x©Œ_šfo
 
i
 = {

1921 .
Çme_šdex
 = 
EXT4_XATTR_INDEX_SYSTEM
,

1922 .
Çme
 = 
EXT4_XATTR_SYSTEM_DATA
,

1926 
Ãeded_blocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

1927 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 
Ãeded_blocks
);

1928 ià(
	`IS_ERR
(
hªdË
))

1929  
	`PTR_ERR
(
hªdË
);

1931 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

1932 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

1933 *
has_šlše
 = 0;

1934 
	`ext4_jouº®_¡İ
(
hªdË
);

1938 ià((
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
)) != 0)

1939 
out
;

1941 ià((
”r
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
.
oc
)) != 0)

1942 
out
;

1944 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

1945 
i_size
 = 
šode
->i_size;

1946 
šlše_size
 = 
	`ext4_g‘_šlše_size
(
šode
);

1947 
	`EXT4_I
(
šode
)->
i_disksize
 = 
i_size
;

1949 ià(
i_size
 < 
šlše_size
) {

1951 ià(
šlše_size
 > 
EXT4_MIN_INLINE_DATA_SIZE
) {

1952 ià((
”r
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
)) != 0)

1953 
out_”rÜ
;

1955 
	`BUG_ON
(
is
.
s
.
nÙ_found
);

1957 
v®ue_Ën
 = 
	`Ë32_to_ıu
(
is
.
s
.
h”e
->
e_v®ue_size
);

1958 
v®ue
 = 
	`km®loc
(
v®ue_Ën
, 
GFP_NOFS
);

1959 ià(!
v®ue
) {

1960 
”r
 = -
ENOMEM
;

1961 
out_”rÜ
;

1964 
”r
 = 
	`ext4_x©Œ_ibody_g‘
(
šode
, 
i
.
Çme_šdex
,

1965 
i
.
Çme
, 
v®ue
, 
v®ue_Ën
);

1966 ià(
”r
 <= 0)

1967 
out_”rÜ
;

1969 
i
.
v®ue
 = value;

1970 
i
.
v®ue_Ën
 = 
i_size
 > 
EXT4_MIN_INLINE_DATA_SIZE
 ?

1971 
i_size
 - 
EXT4_MIN_INLINE_DATA_SIZE
 : 0;

1972 
”r
 = 
	`ext4_x©Œ_ibody_šlše_£t
(
hªdË
, 
šode
,

1973 &
i
, &
is
);

1974 ià(
”r
)

1975 
out_”rÜ
;

1979 ià(
i_size
 < 
EXT4_MIN_INLINE_DATA_SIZE
) {

1980 *
p
 = (*è
	`ext4_¿w_šode
(&
is
.
oc
)->
i_block
;

1981 
	`mem£t
(
p
 + 
i_size
, 0,

1982 
EXT4_MIN_INLINE_DATA_SIZE
 - 
i_size
);

1985 
	`EXT4_I
(
šode
)->
i_šlše_size
 = 
i_size
 <

1986 
EXT4_MIN_INLINE_DATA_SIZE
 ?

1987 
EXT4_MIN_INLINE_DATA_SIZE
 : 
i_size
;

1990 
out_”rÜ
:

1991 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

1992 
out
:

1993 
	`b»l£
(
is
.
oc
.
bh
);

1994 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

1995 
	`kä“
(
v®ue
);

1996 ià(
šode
->
i_Æšk
)

1997 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

1999 ià(
”r
 == 0) {

2000 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

2001 
	`ext4_fc_Œack_šode
(
šode
);

2002 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2003 ià(
	`IS_SYNC
(
šode
))

2004 
	`ext4_hªdË_sync
(
hªdË
);

2006 
	`ext4_jouº®_¡İ
(
hªdË
);

2007  
”r
;

2008 
	}
}

2010 
	$ext4_cÚv”t_šlše_d©a
(
šode
 *inode)

2012 
”rÜ
, 
Ãeded_blocks
, 
no_ex·nd
;

2013 
hªdË_t
 *
hªdË
;

2014 
ext4_oc
 
oc
;

2016 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

2017 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
);

2021 
Ãeded_blocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

2023 
oc
.
bh
 = 
NULL
;

2024 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

2025 ià(
”rÜ
)

2026  
”rÜ
;

2028 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
, 
Ãeded_blocks
);

2029 ià(
	`IS_ERR
(
hªdË
)) {

2030 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

2031 
out_ä“
;

2034 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

2035 ià(
	`ext4_has_šlše_d©a
(
šode
))

2036 
”rÜ
 = 
	`ext4_cÚv”t_šlše_d©a_nŞock
(
hªdË
, 
šode
, &
oc
);

2037 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

2038 
	`ext4_jouº®_¡İ
(
hªdË
);

2039 
out_ä“
:

2040 
	`b»l£
(
oc
.
bh
);

2041  
”rÜ
;

2042 
	}
}

	@inode.c

21 
	~<lšux/fs.h
>

22 
	~<lšux/time.h
>

23 
	~<lšux/highuid.h
>

24 
	~<lšux/·gem­.h
>

25 
	~<lšux/dax.h
>

26 
	~<lšux/quÙaİs.h
>

27 
	~<lšux/¡ršg.h
>

28 
	~<lšux/bufãr_h—d.h
>

29 
	~<lšux/wr™eback.h
>

30 
	~<lšux/·gevec.h
>

31 
	~<lšux/m·ge.h
>

32 
	~<lšux/Çmei.h
>

33 
	~<lšux/uio.h
>

34 
	~<lšux/bio.h
>

35 
	~<lšux/wÜkqueue.h
>

36 
	~<lšux/k”Ãl.h
>

37 
	~<lšux/´štk.h
>

38 
	~<lšux/¦ab.h
>

39 
	~<lšux/b™İs.h
>

40 
	~<lšux/iom­.h
>

42 
	~"ext4_jbd2.h
"

43 
	~"x©Œ.h
"

44 
	~"aş.h
"

45 
	~"Œunÿ‹.h
"

47 
	~<Œaû/ev’ts/ext4.h
>

49 
	#MPAGE_DA_EXTENT_TAIL
 0x01

	)

51 
__u32
 
	$ext4_šode_csum
(
šode
 *šode, 
ext4_šode
 *
¿w
,

52 
ext4_šode_šfo
 *
ei
)

54 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

55 
__u32
 
csum
;

56 
__u16
 
dummy_csum
 = 0;

57 
off£t
 = 
	`off£tof
(
ext4_šode
, 
i_checksum_lo
);

58 
csum_size
 = (
dummy_csum
);

60 
csum
 = 
	`ext4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
¿w
, 
off£t
);

61 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, 
csum_size
);

62 
off£t
 +ğ
csum_size
;

63 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
¿w
 + 
off£t
,

64 
EXT4_GOOD_OLD_INODE_SIZE
 - 
off£t
);

66 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
) {

67 
off£t
 = 
	`off£tof
(
ext4_šode
, 
i_checksum_hi
);

68 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
¿w
 +

69 
EXT4_GOOD_OLD_INODE_SIZE
,

70 
off£t
 - 
EXT4_GOOD_OLD_INODE_SIZE
);

71 ià(
	`EXT4_FITS_IN_INODE
(
¿w
, 
ei
, 
i_checksum_hi
)) {

72 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
,

73 
csum_size
);

74 
off£t
 +ğ
csum_size
;

76 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
¿w
 + 
off£t
,

77 
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è- 
off£t
);

80  
csum
;

81 
	}
}

83 
	$ext4_šode_csum_v”ify
(
šode
 *šode, 
ext4_šode
 *
¿w
,

84 
ext4_šode_šfo
 *
ei
)

86 
__u32
 
´ovided
, 
ÿlcuÏ‹d
;

88 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
->
s_ü—tÜ_os
 !=

89 
	`ıu_to_Ë32
(
EXT4_OS_LINUX
) ||

90 !
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

93 
´ovided
 = 
	`Ë16_to_ıu
(
¿w
->
i_checksum_lo
);

94 
ÿlcuÏ‹d
 = 
	`ext4_šode_csum
(
šode
, 
¿w
, 
ei
);

95 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
 &&

96 
	`EXT4_FITS_IN_INODE
(
¿w
, 
ei
, 
i_checksum_hi
))

97 
´ovided
 |ğ((
__u32
)
	`Ë16_to_ıu
(
¿w
->
i_checksum_hi
)) << 16;

99 
ÿlcuÏ‹d
 &= 0xFFFF;

101  
´ovided
 =ğ
ÿlcuÏ‹d
;

102 
	}
}

104 
	$ext4_šode_csum_£t
(
šode
 *šode, 
ext4_šode
 *
¿w
,

105 
ext4_šode_šfo
 *
ei
)

107 
__u32
 
csum
;

109 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
->
s_ü—tÜ_os
 !=

110 
	`ıu_to_Ë32
(
EXT4_OS_LINUX
) ||

111 !
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

114 
csum
 = 
	`ext4_šode_csum
(
šode
, 
¿w
, 
ei
);

115 
¿w
->
i_checksum_lo
 = 
	`ıu_to_Ë16
(
csum
 & 0xFFFF);

116 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
 &&

117 
	`EXT4_FITS_IN_INODE
(
¿w
, 
ei
, 
i_checksum_hi
))

118 
¿w
->
i_checksum_hi
 = 
	`ıu_to_Ë16
(
csum
 >> 16);

119 
	}
}

121 
šlše
 
	$ext4_begš_Üd”ed_Œunÿ‹
(
šode
 *inode,

122 
loff_t
 
Ãw_size
)

124 
	`Œaû_ext4_begš_Üd”ed_Œunÿ‹
(
šode
, 
Ãw_size
);

131 ià(!
	`EXT4_I
(
šode
)->
jšode
)

133  
	`jbd2_jouº®_begš_Üd”ed_Œunÿ‹
(
	`EXT4_JOURNAL
(
šode
),

134 
	`EXT4_I
(
šode
)->
jšode
,

135 
Ãw_size
);

136 
	}
}

138 
ext4_šv®id©•age
(
·ge
 *·ge, 
off£t
,

139 
Ëngth
);

140 
__ext4_jouº®Ëd_wr™•age
(
·ge
 *·ge, 
Ën
);

141 
ext4_bh_d–ay_Ü_unwr™‹n
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
);

142 
ext4_m‘a_Œªs_blocks
(
šode
 *šode, 
lblocks
,

143 
³x‹Ás
);

149 
	$ext4_šode_is_ç¡_symlšk
(
šode
 *inode)

151  
	`S_ISLNK
(
šode
->
i_mode
è&& inode->
i_size
 &&

152 (
šode
->
i_size
 < 
EXT4_N_BLOCKS
 * 4);

153 
	}
}

160 
	$ext4_Œunÿ‹_»¡¬t_Œªs
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

161 
nblocks
)

163 
»t
;

171 
	`BUG_ON
(
	`EXT4_JOURNAL
(
šode
è=ğ
NULL
);

172 
	`jbd_debug
(2, "»¡¬tšg hªdË %p\n", 
hªdË
);

173 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

174 
»t
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
nblocks
);

175 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

176 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

178  
»t
;

179 
	}
}

184 
	$ext4_eviù_šode
(
šode
 *inode)

186 
hªdË_t
 *
hªdË
;

187 
”r
;

188 
exŒa_üed™s
 = 3;

189 
ext4_x©Œ_šode_¬¿y
 *
—_šode_¬¿y
 = 
NULL
;

191 
	`Œaû_ext4_eviù_šode
(
šode
);

193 ià(
šode
->
i_Æšk
) {

212 ià(
šode
->
i_šo
 !ğ
EXT4_JOURNAL_INO
 &&

213 
	`ext4_should_jouº®_d©a
(
šode
) &&

214 (
	`S_ISLNK
(
šode
->
i_mode
è|| 
	`S_ISREG
(inode->i_mode)) &&

215 
šode
->
i_d©a
.
Ä·ges
) {

216 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
;

217 
tid_t
 
comm™_tid
 = 
	`EXT4_I
(
šode
)->
i_d©async_tid
;

219 
	`jbd2_com¶‘e_Œª§ùiÚ
(
jouº®
, 
comm™_tid
);

220 
	`fem­_wr™e_ªd_wa™
(&
šode
->
i_d©a
);

222 
	`Œunÿ‹_šode_·ges_fš®
(&
šode
->
i_d©a
);

224 
no_d–‘e
;

227 ià(
	`is_bad_šode
(
šode
))

228 
no_d–‘e
;

229 
	`dquÙ_š™Ÿlize
(
šode
);

231 ià(
	`ext4_should_Üd”_d©a
(
šode
))

232 
	`ext4_begš_Üd”ed_Œunÿ‹
(
šode
, 0);

233 
	`Œunÿ‹_šode_·ges_fš®
(&
šode
->
i_d©a
);

239 
	`sb_¡¬t_štwr™e
(
šode
->
i_sb
);

241 ià(!
	`IS_NOQUOTA
(
šode
))

242 
exŒa_üed™s
 +ğ
	`EXT4_MAXQUOTAS_DEL_BLOCKS
(
šode
->
i_sb
);

244 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
,

245 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
)+
exŒa_üed™s
);

246 ià(
	`IS_ERR
(
hªdË
)) {

247 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
	`PTR_ERR
(
hªdË
));

253 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

254 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

255 
no_d–‘e
;

258 ià(
	`IS_SYNC
(
šode
))

259 
	`ext4_hªdË_sync
(
hªdË
);

268 ià(
	`ext4_šode_is_ç¡_symlšk
(
šode
))

269 
	`mem£t
(
	`EXT4_I
(
šode
)->
i_d©a
, 0, (EXT4_I(inode)->i_data));

270 
šode
->
i_size
 = 0;

271 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

272 ià(
”r
) {

273 
	`ext4_w¬nšg
(
šode
->
i_sb
,

274 "couldn'ˆm¬k inoddœty (”¸%d)", 
”r
);

275 
¡İ_hªdË
;

277 ià(
šode
->
i_blocks
) {

278 
”r
 = 
	`ext4_Œunÿ‹
(
šode
);

279 ià(
”r
) {

280 
	`ext4_”rÜ
(
šode
->
i_sb
,

282 
šode
->
i_šo
, 
”r
);

283 
¡İ_hªdË
;

288 
”r
 = 
	`ext4_x©Œ_d–‘e_šode
(
hªdË
, 
šode
, &
—_šode_¬¿y
,

289 
exŒa_üed™s
);

290 ià(
”r
) {

291 
	`ext4_w¬nšg
(
šode
->
i_sb
, "x©Œ d–‘Ó¼ %d)", 
”r
);

292 
¡İ_hªdË
:

293 
	`ext4_jouº®_¡İ
(
hªdË
);

294 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

295 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

296 
	`ext4_x©Œ_šode_¬¿y_ä“
(
—_šode_¬¿y
);

297 
no_d–‘e
;

308 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

309 
	`EXT4_I
(
šode
)->
i_dtime
 = 
	`g‘_£cÚds
();

318 ià(
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
))

320 
	`ext4_ş—r_šode
(
šode
);

322 
	`ext4_ä“_šode
(
hªdË
, 
šode
);

323 
	`ext4_jouº®_¡İ
(
hªdË
);

324 
	`sb_’d_štwr™e
(
šode
->
i_sb
);

325 
	`ext4_x©Œ_šode_¬¿y_ä“
(
—_šode_¬¿y
);

327 
no_d–‘e
:

328 
	`ext4_ş—r_šode
(
šode
);

329 
	}
}

331 #ifdeà
CONFIG_QUOTA


332 
qsize_t
 *
	$ext4_g‘_»£rved_¥aû
(
šode
 *inode)

334  &
	`EXT4_I
(
šode
)->
i_»£rved_quÙa
;

335 
	}
}

342 
	$ext4_da_upd©e_»£rve_¥aû
(
šode
 *inode,

343 
u£d
, 
quÙa_şaim
)

345 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

346 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

348 
	`¥š_lock
(&
ei
->
i_block_»£rv©iÚ_lock
);

349 
	`Œaû_ext4_da_upd©e_»£rve_¥aû
(
šode
, 
u£d
, 
quÙa_şaim
);

350 ià(
	`uÆik–y
(
u£d
 > 
ei
->
i_»£rved_d©a_blocks
)) {

351 
	`ext4_w¬nšg
(
šode
->
i_sb
, "%s: ino %lu, used %d "

353 
__func__
, 
šode
->
i_šo
, 
u£d
,

354 
ei
->
i_»£rved_d©a_blocks
);

355 
	`WARN_ON
(1);

356 
u£d
 = 
ei
->
i_»£rved_d©a_blocks
;

360 
ei
->
i_»£rved_d©a_blocks
 -ğ
u£d
;

361 
	`³rıu_couÁ”_sub
(&
sbi
->
s_dœtyşu¡”s_couÁ”
, 
u£d
);

363 
	`¥š_uÆock
(&
	`EXT4_I
(
šode
)->
i_block_»£rv©iÚ_lock
);

366 ià(
quÙa_şaim
)

367 
	`dquÙ_şaim_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 
u£d
));

374 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 
u£d
));

382 ià((
ei
->
i_»£rved_d©a_blocks
 == 0) &&

383 (
	`©omic_»ad
(&
šode
->
i_wr™ecouÁ
) == 0))

384 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

385 
	}
}

387 
	$__check_block_v®id™y
(
šode
 *šode, cÚ¡ *
func
,

388 
lše
,

389 
ext4_m­_blocks
 *
m­
)

391 ià(!
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
šode
->
i_sb
), 
m­
->
m_pblk
,

392 
m­
->
m_Ën
)) {

393 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
m­
->
m_pblk
,

395 "Ö’gth %d)", (è
m­
->
m_lblk
,

396 
m­
->
m_Ën
);

397  -
EFSCORRUPTED
;

400 
	}
}

402 
	$ext4_issue_z”oout
(
šode
 *šode, 
ext4_lblk_t
 
lblk
, 
ext4_fsblk_t
 
pblk
,

403 
ext4_lblk_t
 
Ën
)

405 
»t
;

407 ià(
	`ext4_’üy±ed_šode
(
šode
))

408  
	`fsüy±_z”oout_¿nge
(
šode
, 
lblk
, 
pblk
, 
Ën
);

410 
»t
 = 
	`sb_issue_z”oout
(
šode
->
i_sb
, 
pblk
, 
Ën
, 
GFP_NOFS
);

411 ià(
»t
 > 0)

412 
»t
 = 0;

414  
»t
;

415 
	}
}

417 
	#check_block_v®id™y
(
šode
, 
m­
) \

418 
	`__check_block_v®id™y
((
šode
), 
__func__
, 
__LINE__
, (
m­
))

	)

420 #ifdeà
ES_AGGRESSIVE_TEST


421 
	$ext4_m­_blocks_es_»check
(
hªdË_t
 *
hªdË
,

422 
šode
 *inode,

423 
ext4_m­_blocks
 *
es_m­
,

424 
ext4_m­_blocks
 *
m­
,

425 
æags
)

427 
»tv®
;

429 
m­
->
m_æags
 = 0;

437 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

438 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

439 
»tv®
 = 
	`ext4_ext_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
 &

440 
EXT4_GET_BLOCKS_KEEP_SIZE
);

442 
»tv®
 = 
	`ext4_šd_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
 &

443 
EXT4_GET_BLOCKS_KEEP_SIZE
);

445 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

451 ià(
es_m­
->
m_lblk
 !ğ
m­
->m_lblk ||

452 
es_m­
->
m_æags
 !ğ
m­
->m_flags ||

453 
es_m­
->
m_pblk
 !ğ
m­
->m_pblk) {

454 
	`´štk
("ES cache‡ssertion failed for inode: %lu "

457 
šode
->
i_šo
, 
es_m­
->
m_lblk
,ƒs_m­->
m_Ën
,

458 
es_m­
->
m_pblk
,ƒs_m­->
m_æags
, 
m­
->
m_lblk
,

459 
m­
->
m_Ën
, m­->
m_pblk
, m­->
m_æags
,

460 
»tv®
, 
æags
);

462 
	}
}

487 
	$ext4_m­_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

488 
ext4_m­_blocks
 *
m­
, 
æags
)

490 
ex‹Á_¡©us
 
es
;

491 
»tv®
;

492 
»t
 = 0;

493 #ifdeà
ES_AGGRESSIVE_TEST


494 
ext4_m­_blocks
 
Üig_m­
;

496 
	`memıy
(&
Üig_m­
, 
m­
, (*map));

499 
m­
->
m_æags
 = 0;

500 
	`ext_debug
("ext4_map_blocks(): inode %lu, flag %d, max_blocks %u,"

501 "logiÿÈblock %lu\n", 
šode
->
i_šo
, 
æags
, 
m­
->
m_Ën
,

502 (è
m­
->
m_lblk
);

507 ià(
	`uÆik–y
(
m­
->
m_Ën
 > 
INT_MAX
))

508 
m­
->
m_Ën
 = 
INT_MAX
;

511 ià(
	`uÆik–y
(
m­
->
m_lblk
 >ğ
EXT_MAX_BLOCKS
))

512  -
EFSCORRUPTED
;

515 ià(
	`ext4_es_lookup_ex‹Á
(
šode
, 
m­
->
m_lblk
, &
es
)) {

516 ià(
	`ext4_es_is_wr™‹n
(&
es
è|| 
	`ext4_es_is_unwr™‹n
(&es)) {

517 
m­
->
m_pblk
 = 
	`ext4_es_pblock
(&
es
) +

518 
m­
->
m_lblk
 - 
es
.
es_lblk
;

519 
m­
->
m_æags
 |ğ
	`ext4_es_is_wr™‹n
(&
es
) ?

520 
EXT4_MAP_MAPPED
 : 
EXT4_MAP_UNWRITTEN
;

521 
»tv®
 = 
es
.
es_Ën
 - (
m­
->
m_lblk
 -ƒs.
es_lblk
);

522 ià(
»tv®
 > 
m­
->
m_Ën
)

523 
»tv®
 = 
m­
->
m_Ën
;

524 
m­
->
m_Ën
 = 
»tv®
;

525 } ià(
	`ext4_es_is_d–ayed
(&
es
è|| 
	`ext4_es_is_hŞe
(&es)) {

526 
m­
->
m_pblk
 = 0;

527 
»tv®
 = 
es
.
es_Ën
 - (
m­
->
m_lblk
 -ƒs.
es_lblk
);

528 ià(
»tv®
 > 
m­
->
m_Ën
)

529 
»tv®
 = 
m­
->
m_Ën
;

530 
m­
->
m_Ën
 = 
»tv®
;

531 
»tv®
 = 0;

533 
	`BUG_ON
(1);

535 #ifdeà
ES_AGGRESSIVE_TEST


536 
	`ext4_m­_blocks_es_»check
(
hªdË
, 
šode
, 
m­
,

537 &
Üig_m­
, 
æags
);

539 
found
;

546 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

547 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

548 
»tv®
 = 
	`ext4_ext_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
 &

549 
EXT4_GET_BLOCKS_KEEP_SIZE
);

551 
»tv®
 = 
	`ext4_šd_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
 &

552 
EXT4_GET_BLOCKS_KEEP_SIZE
);

554 ià(
»tv®
 > 0) {

555 
¡©us
;

557 ià(
	`uÆik–y
(
»tv®
 !ğ
m­
->
m_Ën
)) {

558 
	`ext4_w¬nšg
(
šode
->
i_sb
,

561 
šode
->
i_šo
, 
»tv®
, 
m­
->
m_Ën
);

562 
	`WARN_ON
(1);

565 
¡©us
 = 
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
 ?

566 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

567 ià(!(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

568 !(
¡©us
 & 
EXTENT_STATUS_WRITTEN
) &&

569 
	`ext4_fšd_d–®loc_¿nge
(
šode
, 
m­
->
m_lblk
,

570 
m­
->
m_lblk
 + m­->
m_Ën
 - 1))

571 
¡©us
 |ğ
EXTENT_STATUS_DELAYED
;

572 
»t
 = 
	`ext4_es_š£¹_ex‹Á
(
šode
, 
m­
->
m_lblk
,

573 
m­
->
m_Ën
, m­->
m_pblk
, 
¡©us
);

574 ià(
»t
 < 0)

575 
»tv®
 = 
»t
;

577 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

579 
found
:

580 ià(
»tv®
 > 0 && 
m­
->
m_æags
 & 
EXT4_MAP_MAPPED
) {

581 
»t
 = 
	`check_block_v®id™y
(
šode
, 
m­
);

582 ià(
»t
 != 0)

583  
»t
;

587 ià((
æags
 & 
EXT4_GET_BLOCKS_CREATE
) == 0)

588  
»tv®
;

597 ià(
»tv®
 > 0 && 
m­
->
m_æags
 & 
EXT4_MAP_MAPPED
)

603 ià(!(
æags
 & 
EXT4_GET_BLOCKS_CONVERT_UNWRITTEN
))

604  
»tv®
;

610 
m­
->
m_æags
 &ğ~
EXT4_MAP_FLAGS
;

618 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

624 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

625 
»tv®
 = 
	`ext4_ext_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
);

627 
»tv®
 = 
	`ext4_šd_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
æags
);

629 ià(
»tv®
 > 0 && 
m­
->
m_æags
 & 
EXT4_MAP_NEW
) {

635 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_MIGRATE
);

644 ià((
»tv®
 > 0) &&

645 (
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
))

646 
	`ext4_da_upd©e_»£rve_¥aû
(
šode
, 
»tv®
, 1);

649 ià(
»tv®
 > 0) {

650 
¡©us
;

652 ià(
	`uÆik–y
(
»tv®
 !ğ
m­
->
m_Ën
)) {

653 
	`ext4_w¬nšg
(
šode
->
i_sb
,

656 
šode
->
i_šo
, 
»tv®
, 
m­
->
m_Ën
);

657 
	`WARN_ON
(1);

667 ià(
æags
 & 
EXT4_GET_BLOCKS_ZERO
 &&

668 
m­
->
m_æags
 & 
EXT4_MAP_MAPPED
 &&

669 
m­
->
m_æags
 & 
EXT4_MAP_NEW
) {

670 
	`ş—n_bdev_®Ÿ£s
(
šode
->
i_sb
->
s_bdev
, 
m­
->
m_pblk
,

671 
m­
->
m_Ën
);

672 
»t
 = 
	`ext4_issue_z”oout
(
šode
, 
m­
->
m_lblk
,

673 
m­
->
m_pblk
, m­->
m_Ën
);

674 ià(
»t
) {

675 
»tv®
 = 
»t
;

676 
out_£m
;

684 ià((
æags
 & 
EXT4_GET_BLOCKS_PRE_IO
) &&

685 
	`ext4_es_lookup_ex‹Á
(
šode
, 
m­
->
m_lblk
, &
es
)) {

686 ià(
	`ext4_es_is_wr™‹n
(&
es
))

687 
out_£m
;

689 
¡©us
 = 
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
 ?

690 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

691 ià(!(
æags
 & 
EXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

692 !(
¡©us
 & 
EXTENT_STATUS_WRITTEN
) &&

693 
	`ext4_fšd_d–®loc_¿nge
(
šode
, 
m­
->
m_lblk
,

694 
m­
->
m_lblk
 + m­->
m_Ën
 - 1))

695 
¡©us
 |ğ
EXTENT_STATUS_DELAYED
;

696 
»t
 = 
	`ext4_es_š£¹_ex‹Á
(
šode
, 
m­
->
m_lblk
, m­->
m_Ën
,

697 
m­
->
m_pblk
, 
¡©us
);

698 ià(
»t
 < 0) {

699 
»tv®
 = 
»t
;

700 
out_£m
;

704 
out_£m
:

705 
	`up_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

706 ià(
»tv®
 > 0 && 
m­
->
m_æags
 & 
EXT4_MAP_MAPPED
) {

707 
»t
 = 
	`check_block_v®id™y
(
šode
, 
m­
);

708 ià(
»t
 != 0)

709  
»t
;

716 ià(
m­
->
m_æags
 & 
EXT4_MAP_NEW
 &&

717 !(
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
) &&

718 !(
æags
 & 
EXT4_GET_BLOCKS_ZERO
) &&

719 !
	`ext4_is_quÙa_fe
(
šode
) &&

720 
	`ext4_should_Üd”_d©a
(
šode
)) {

721 ià(
æags
 & 
EXT4_GET_BLOCKS_IO_SUBMIT
)

722 
»t
 = 
	`ext4_jbd2_šode_add_wa™
(
hªdË
, 
šode
);

724 
»t
 = 
	`ext4_jbd2_šode_add_wr™e
(
hªdË
, 
šode
);

725 ià(
»t
)

726  
»t
;

728 
	`ext4_fc_Œack_¿nge
(
šode
, 
m­
->
m_lblk
,

729 
m­
->
m_lblk
 + m­->
m_Ën
 - 1);

731  
»tv®
;

732 
	}
}

738 
	$ext4_upd©e_bh_¡©e
(
bufãr_h—d
 *
bh
, 
æags
)

740 
Şd_¡©e
;

741 
Ãw_¡©e
;

743 
æags
 &ğ
EXT4_MAP_FLAGS
;

746 ià(!
bh
->
b_·ge
) {

747 
bh
->
b_¡©e
 = (bh->b_¡©& ~
EXT4_MAP_FLAGS
è| 
æags
;

756 
Şd_¡©e
 = 
	`READ_ONCE
(
bh
->
b_¡©e
);

757 
Ãw_¡©e
 = (
Şd_¡©e
 & ~
EXT4_MAP_FLAGS
è| 
æags
;

758 } 
	`uÆik–y
(

759 
	`cmpxchg
(&
bh
->
b_¡©e
, 
Şd_¡©e
, 
Ãw_¡©e
) != old_state));

760 
	}
}

762 
	$_ext4_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

763 
bufãr_h—d
 *
bh
, 
æags
)

765 
ext4_m­_blocks
 
m­
;

766 
»t
 = 0;

768 ià(
	`ext4_has_šlše_d©a
(
šode
))

769  -
ERANGE
;

771 
m­
.
m_lblk
 = 
iblock
;

772 
m­
.
m_Ën
 = 
bh
->
b_size
 >> 
šode
->
i_blkb™s
;

774 
»t
 = 
	`ext4_m­_blocks
(
	`ext4_jouº®_cu¼’t_hªdË
(), 
šode
, &
m­
,

775 
æags
);

776 ià(
»t
 > 0) {

777 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
m­
.
m_pblk
);

778 
	`ext4_upd©e_bh_¡©e
(
bh
, 
m­
.
m_æags
);

779 
bh
->
b_size
 = 
šode
->
i_sb
->
s_blocksize
 * 
m­
.
m_Ën
;

780 
»t
 = 0;

781 } ià(
»t
 == 0) {

783 
bh
->
b_size
 = 
šode
->
i_sb
->
s_blocksize
 * 
m­
.
m_Ën
;

785  
»t
;

786 
	}
}

788 
	$ext4_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

789 
bufãr_h—d
 *
bh
, 
ü—‹
)

791  
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh
,

792 
ü—‹
 ? 
EXT4_GET_BLOCKS_CREATE
 : 0);

793 
	}
}

800 
	$ext4_g‘_block_unwr™‹n
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

801 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

803 
	`ext4_debug
("ext4_get_block_unwritten: inode %lu, create flag %d\n",

804 
šode
->
i_šo
, 
ü—‹
);

805  
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh_»suÉ
,

806 
EXT4_GET_BLOCKS_IO_CREATE_EXT
);

807 
	}
}

810 
	#DIO_MAX_BLOCKS
 4096

	)

817 
	$ext4_g‘_block_Œªs
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

818 
bufãr_h—d
 *
bh_»suÉ
, 
æags
)

820 
dio_üed™s
;

821 
hªdË_t
 *
hªdË
;

822 
»Œ›s
 = 0;

823 
»t
;

826 ià(
bh_»suÉ
->
b_size
 >> 
šode
->
i_blkb™s
 > 
DIO_MAX_BLOCKS
)

827 
bh_»suÉ
->
b_size
 = 
DIO_MAX_BLOCKS
 << 
šode
->
i_blkb™s
;

828 
dio_üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
,

829 
bh_»suÉ
->
b_size
 >> 
šode
->
i_blkb™s
);

830 
»Œy
:

831 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MAP_BLOCKS
, 
dio_üed™s
);

832 ià(
	`IS_ERR
(
hªdË
))

833  
	`PTR_ERR
(
hªdË
);

835 
»t
 = 
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh_»suÉ
, 
æags
);

836 
	`ext4_jouº®_¡İ
(
hªdË
);

838 ià(
»t
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

839 
»Œy
;

840  
»t
;

841 
	}
}

844 
	$ext4_dio_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

845 
bufãr_h—d
 *
bh
, 
ü—‹
)

848 
	`WARN_ON_ONCE
(
	`ext4_jouº®_cu¼’t_hªdË
());

850 ià(!
ü—‹
)

851  
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh
, 0);

852  
	`ext4_g‘_block_Œªs
(
šode
, 
iblock
, 
bh
, 
EXT4_GET_BLOCKS_CREATE
);

853 
	}
}

860 
	$ext4_dio_g‘_block_unwr™‹n_async
(
šode
 *inode,

861 
£ùÜ_t
 
iblock
, 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

863 
»t
;

866 
	`WARN_ON_ONCE
(
	`ext4_jouº®_cu¼’t_hªdË
());

868 
»t
 = 
	`ext4_g‘_block_Œªs
(
šode
, 
iblock
, 
bh_»suÉ
,

869 
EXT4_GET_BLOCKS_IO_CREATE_EXT
);

878 ià(!
»t
 && 
	`bufãr_unwr™‹n
(
bh_»suÉ
)) {

879 ià(!
bh_»suÉ
->
b_´iv©e
) {

880 
ext4_io_’d_t
 *
io_’d
;

882 
io_’d
 = 
	`ext4_š™_io_’d
(
šode
, 
GFP_KERNEL
);

883 ià(!
io_’d
)

884  -
ENOMEM
;

885 
bh_»suÉ
->
b_´iv©e
 = 
io_’d
;

886 
	`ext4_£t_io_unwr™‹n_æag
(
šode
, 
io_’d
);

888 
	`£t_bufãr_deãr_com¶‘iÚ
(
bh_»suÉ
);

891  
»t
;

892 
	}
}

899 
	$ext4_dio_g‘_block_unwr™‹n_sync
(
šode
 *inode,

900 
£ùÜ_t
 
iblock
, 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

902 
»t
;

905 
	`WARN_ON_ONCE
(
	`ext4_jouº®_cu¼’t_hªdË
());

907 
»t
 = 
	`ext4_g‘_block_Œªs
(
šode
, 
iblock
, 
bh_»suÉ
,

908 
EXT4_GET_BLOCKS_IO_CREATE_EXT
);

915 ià(!
»t
 && 
	`bufãr_unwr™‹n
(
bh_»suÉ
))

916 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_DIO_UNWRITTEN
);

918  
»t
;

919 
	}
}

921 
	$ext4_dio_g‘_block_ov”wr™e
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

922 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

924 
»t
;

926 
	`ext4_debug
("ext4_dio_get_block_overwrite: inode %lu, create flag %d\n",

927 
šode
->
i_šo
, 
ü—‹
);

929 
	`WARN_ON_ONCE
(
	`ext4_jouº®_cu¼’t_hªdË
());

931 
»t
 = 
	`_ext4_g‘_block
(
šode
, 
iblock
, 
bh_»suÉ
, 0);

936 
	`WARN_ON_ONCE
(!
	`bufãr_m­³d
(
bh_»suÉ
è|| 
	`bufãr_unwr™‹n
(bh_result));

938  
»t
;

939 
	}
}

945 
bufãr_h—d
 *
	$ext4_g‘blk
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

946 
ext4_lblk_t
 
block
, 
m­_æags
)

948 
ext4_m­_blocks
 
m­
;

949 
bufãr_h—d
 *
bh
;

950 
ü—‹
 = 
m­_æags
 & 
EXT4_GET_BLOCKS_CREATE
;

951 
”r
;

953 
	`J_ASSERT
(
hªdË
 !ğ
NULL
 || 
ü—‹
 == 0);

955 
m­
.
m_lblk
 = 
block
;

956 
m­
.
m_Ën
 = 1;

957 
”r
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
, 
m­_æags
);

959 ià(
”r
 == 0)

960  
ü—‹
 ? 
	`ERR_PTR
(-
ENOSPC
è: 
NULL
;

961 ià(
”r
 < 0)

962  
	`ERR_PTR
(
”r
);

964 
bh
 = 
	`sb_g‘blk
(
šode
->
i_sb
, 
m­
.
m_pblk
);

965 ià(
	`uÆik–y
(!
bh
))

966  
	`ERR_PTR
(-
ENOMEM
);

967 ià(
m­
.
m_æags
 & 
EXT4_MAP_NEW
) {

968 
	`J_ASSERT
(
ü—‹
 != 0);

969 
	`J_ASSERT
(
hªdË
 !ğ
NULL
);

978 
	`lock_bufãr
(
bh
);

979 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

980 
”r
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
bh
);

981 ià(
	`uÆik–y
(
”r
)) {

982 
	`uÆock_bufãr
(
bh
);

983 
”rout
;

985 ià(!
	`bufãr_u±od©e
(
bh
)) {

986 
	`mem£t
(
bh
->
b_d©a
, 0, 
šode
->
i_sb
->
s_blocksize
);

987 
	`£t_bufãr_u±od©e
(
bh
);

989 
	`uÆock_bufãr
(
bh
);

990 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

991 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

992 ià(
	`uÆik–y
(
”r
))

993 
”rout
;

995 
	`BUFFER_TRACE
(
bh
, "not‡‚ew buffer");

996  
bh
;

997 
”rout
:

998 
	`b»l£
(
bh
);

999  
	`ERR_PTR
(
”r
);

1000 
	}
}

1002 
bufãr_h—d
 *
	$ext4_b»ad
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1003 
ext4_lblk_t
 
block
, 
m­_æags
)

1005 
bufãr_h—d
 *
bh
;

1007 
bh
 = 
	`ext4_g‘blk
(
hªdË
, 
šode
, 
block
, 
m­_æags
);

1008 ià(
	`IS_ERR
(
bh
))

1009  
bh
;

1010 ià(!
bh
 || 
	`bufãr_u±od©e
(bh))

1011  
bh
;

1012 
	`Î_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
bh
);

1013 
	`wa™_Ú_bufãr
(
bh
);

1014 ià(
	`bufãr_u±od©e
(
bh
))

1015  
bh
;

1016 
	`put_bh
(
bh
);

1017  
	`ERR_PTR
(-
EIO
);

1018 
	}
}

1021 
	$ext4_b»ad_b©ch
(
šode
 *šode, 
ext4_lblk_t
 
block
, 
bh_couÁ
,

1022 
boŞ
 
wa™
, 
bufãr_h—d
 **
bhs
)

1024 
i
, 
”r
;

1026 
i
 = 0; i < 
bh_couÁ
; i++) {

1027 
bhs
[
i
] = 
	`ext4_g‘blk
(
NULL
, 
šode
, 
block
 + i, 0 );

1028 ià(
	`IS_ERR
(
bhs
[
i
])) {

1029 
”r
 = 
	`PTR_ERR
(
bhs
[
i
]);

1030 
bh_couÁ
 = 
i
;

1031 
out_b»l£
;

1035 
i
 = 0; i < 
bh_couÁ
; i++)

1037 ià(
bhs
[
i
] && !
	`bufãr_u±od©e
(bhs[i]))

1038 
	`Î_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1,

1039 &
bhs
[
i
]);

1041 ià(!
wa™
)

1044 
i
 = 0; i < 
bh_couÁ
; i++)

1045 ià(
bhs
[
i
])

1046 
	`wa™_Ú_bufãr
(
bhs
[
i
]);

1048 
i
 = 0; i < 
bh_couÁ
; i++) {

1049 ià(
bhs
[
i
] && !
	`bufãr_u±od©e
(bhs[i])) {

1050 
”r
 = -
EIO
;

1051 
out_b»l£
;

1056 
out_b»l£
:

1057 
i
 = 0; i < 
bh_couÁ
; i++) {

1058 
	`b»l£
(
bhs
[
i
]);

1059 
bhs
[
i
] = 
NULL
;

1061  
”r
;

1062 
	}
}

1064 
ext4_w®k_·ge_bufãrs
(
hªdË_t
 *
hªdË
,

1065 
bufãr_h—d
 *
h—d
,

1066 
äom
,

1067 
to
,

1068 *
·¹Ÿl
,

1069 (*
â
)(
hªdË_t
 *
hªdË
,

1070 
bufãr_h—d
 *
bh
))

1072 
bufãr_h—d
 *
bh
;

1073 
block_¡¬t
, 
block_’d
;

1074 
blocksize
 = 
h—d
->
b_size
;

1075 
”r
, 
»t
 = 0;

1076 
bufãr_h—d
 *
Ãxt
;

1078 
bh
 = 
h—d
, 
block_¡¬t
 = 0;

1079 
»t
 =ğ0 && (
bh
 !ğ
h—d
 || !
block_¡¬t
);

1080 
block_¡¬t
 = 
block_’d
, 
bh
 = 
Ãxt
) {

1081 
Ãxt
 = 
bh
->
b_this_·ge
;

1082 
block_’d
 = 
block_¡¬t
 + 
blocksize
;

1083 ià(
block_’d
 <ğ
äom
 || 
block_¡¬t
 >ğ
to
) {

1084 ià(
·¹Ÿl
 && !
	`bufãr_u±od©e
(
bh
))

1085 *
·¹Ÿl
 = 1;

1088 
”r
 = (*
â
)(
hªdË
, 
bh
);

1089 ià(!
»t
)

1090 
»t
 = 
”r
;

1092  
»t
;

1093 
	}
}

1119 
	$do_jouº®_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
,

1120 
bufãr_h—d
 *
bh
)

1122 
dœty
 = 
	`bufãr_dœty
(
bh
);

1123 
»t
;

1125 ià(!
	`bufãr_m­³d
(
bh
è|| 
	`bufãr_ä“d
(bh))

1135 ià(
dœty
)

1136 
	`ş—r_bufãr_dœty
(
bh
);

1137 
	`BUFFER_TRACE
(
bh
, "get write‡ccess");

1138 
»t
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1139 ià(!
»t
 && 
dœty
)

1140 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

1141  
»t
;

1142 
	}
}

1144 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


1145 
	$ext4_block_wr™e_begš
(
·ge
 *·ge, 
loff_t
 
pos
, 
Ën
,

1146 
g‘_block_t
 *
g‘_block
)

1148 
äom
 = 
pos
 & (
PAGE_SIZE
 - 1);

1149 
to
 = 
äom
 + 
Ën
;

1150 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1151 
block_¡¬t
, 
block_’d
;

1152 
£ùÜ_t
 
block
;

1153 
”r
 = 0;

1154 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

1155 
bb™s
;

1156 
bufãr_h—d
 *
bh
, *
h—d
, *
wa™
[2], **
wa™_bh
 = wait;

1157 
boŞ
 
deüy±
 = 
çl£
;

1159 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

1160 
	`BUG_ON
(
äom
 > 
PAGE_SIZE
);

1161 
	`BUG_ON
(
to
 > 
PAGE_SIZE
);

1162 
	`BUG_ON
(
äom
 > 
to
);

1164 ià(!
	`·ge_has_bufãrs
(
·ge
))

1165 
	`ü—‹_em±y_bufãrs
(
·ge
, 
blocksize
, 0);

1166 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

1167 
bb™s
 = 
	`og2
(
blocksize
);

1168 
block
 = (
£ùÜ_t
)
·ge
->
šdex
 << (
PAGE_SHIFT
 - 
bb™s
);

1170 
bh
 = 
h—d
, 
block_¡¬t
 = 0; bh != head || !block_start;

1171 
block
++, 
block_¡¬t
 = 
block_’d
, 
bh
 = bh->
b_this_·ge
) {

1172 
block_’d
 = 
block_¡¬t
 + 
blocksize
;

1173 ià(
block_’d
 <ğ
äom
 || 
block_¡¬t
 >ğ
to
) {

1174 ià(
	`PageU±od©e
(
·ge
)) {

1175 ià(!
	`bufãr_u±od©e
(
bh
))

1176 
	`£t_bufãr_u±od©e
(
bh
);

1180 ià(
	`bufãr_Ãw
(
bh
))

1181 
	`ş—r_bufãr_Ãw
(
bh
);

1182 ià(!
	`bufãr_m­³d
(
bh
)) {

1183 
	`WARN_ON
(
bh
->
b_size
 !ğ
blocksize
);

1184 
”r
 = 
	`g‘_block
(
šode
, 
block
, 
bh
, 1);

1185 ià(
”r
)

1187 ià(
	`bufãr_Ãw
(
bh
)) {

1188 
	`ş—n_bdev_bh_®Ÿs
(
bh
);

1189 ià(
	`PageU±od©e
(
·ge
)) {

1190 
	`ş—r_bufãr_Ãw
(
bh
);

1191 
	`£t_bufãr_u±od©e
(
bh
);

1192 
	`m¬k_bufãr_dœty
(
bh
);

1195 ià(
block_’d
 > 
to
 || 
block_¡¬t
 < 
äom
)

1196 
	`z”o_u£r_£gm’ts
(
·ge
, 
to
, 
block_’d
,

1197 
block_¡¬t
, 
äom
);

1201 ià(
	`PageU±od©e
(
·ge
)) {

1202 ià(!
	`bufãr_u±od©e
(
bh
))

1203 
	`£t_bufãr_u±od©e
(
bh
);

1206 ià(!
	`bufãr_u±od©e
(
bh
è&& !
	`bufãr_d–ay
(bh) &&

1207 !
	`bufãr_unwr™‹n
(
bh
) &&

1208 (
block_¡¬t
 < 
äom
 || 
block_’d
 > 
to
)) {

1209 
	`Î_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1210 *
wa™_bh
++ = 
bh
;

1211 
deüy±
 = 
	`ext4_’üy±ed_šode
(
šode
) &&

1212 
	`S_ISREG
(
šode
->
i_mode
);

1218 
wa™_bh
 > 
wa™
) {

1219 
	`wa™_Ú_bufãr
(*--
wa™_bh
);

1220 ià(!
	`bufãr_u±od©e
(*
wa™_bh
))

1221 
”r
 = -
EIO
;

1223 ià(
	`uÆik–y
(
”r
))

1224 
	`·ge_z”o_Ãw_bufãrs
(
·ge
, 
äom
, 
to
);

1225 ià(
deüy±
)

1226 
”r
 = 
	`fsüy±_deüy±_·ge
(
·ge
->
m­pšg
->
ho¡
,…age,

1227 
PAGE_SIZE
, 0, 
·ge
->
šdex
);

1228  
”r
;

1229 
	}
}

1232 
	$ext4_wr™e_begš
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
,

1233 
loff_t
 
pos
, 
Ën
, 
æags
,

1234 
·ge
 **
·g•
, **
fsd©a
)

1236 
šode
 *šodğ
m­pšg
->
ho¡
;

1237 
»t
, 
Ãeded_blocks
;

1238 
hªdË_t
 *
hªdË
;

1239 
»Œ›s
 = 0;

1240 
·ge
 *page;

1241 
pgoff_t
 
šdex
;

1242 
äom
, 
to
;

1244 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

1245  -
EIO
;

1247 
	`Œaû_ext4_wr™e_begš
(
šode
, 
pos
, 
Ën
, 
æags
);

1252 
Ãeded_blocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
) + 1;

1253 
šdex
 = 
pos
 >> 
PAGE_SHIFT
;

1254 
äom
 = 
pos
 & (
PAGE_SIZE
 - 1);

1255 
to
 = 
äom
 + 
Ën
;

1257 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
)) {

1258 
»t
 = 
	`ext4_Œy_to_wr™e_šlše_d©a
(
m­pšg
, 
šode
, 
pos
, 
Ën
,

1259 
æags
, 
·g•
);

1260 ià(
»t
 < 0)

1261  
»t
;

1262 ià(
»t
 == 1)

1273 
»Œy_g¿b
:

1274 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 
šdex
, 
æags
);

1275 ià(!
·ge
)

1276  -
ENOMEM
;

1277 
	`uÆock_·ge
(
·ge
);

1279 
»Œy_jouº®
:

1280 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
, 
Ãeded_blocks
);

1281 ià(
	`IS_ERR
(
hªdË
)) {

1282 
	`put_·ge
(
·ge
);

1283  
	`PTR_ERR
(
hªdË
);

1286 
	`lock_·ge
(
·ge
);

1287 ià(
·ge
->
m­pšg
 != mapping) {

1289 
	`uÆock_·ge
(
·ge
);

1290 
	`put_·ge
(
·ge
);

1291 
	`ext4_jouº®_¡İ
(
hªdË
);

1292 
»Œy_g¿b
;

1295 
	`wa™_fÜ_¡abË_·ge
(
·ge
);

1297 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


1298 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
))

1299 
»t
 = 
	`ext4_block_wr™e_begš
(
·ge
, 
pos
, 
Ën
,

1300 
ext4_g‘_block_unwr™‹n
);

1302 
»t
 = 
	`ext4_block_wr™e_begš
(
·ge
, 
pos
, 
Ën
,

1303 
ext4_g‘_block
);

1305 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
))

1306 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
pos
, 
Ën
,

1307 
ext4_g‘_block_unwr™‹n
);

1309 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
pos
, 
Ën
, 
ext4_g‘_block
);

1311 ià(!
»t
 && 
	`ext4_should_jouº®_d©a
(
šode
)) {

1312 
»t
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
	`·ge_bufãrs
(
·ge
),

1313 
äom
, 
to
, 
NULL
,

1314 
do_jouº®_g‘_wr™e_acûss
);

1317 ià(
»t
) {

1318 
	`uÆock_·ge
(
·ge
);

1327 ià(
pos
 + 
Ën
 > 
šode
->
i_size
 && 
	`ext4_ÿn_Œunÿ‹
(inode))

1328 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

1330 
	`ext4_jouº®_¡İ
(
hªdË
);

1331 ià(
pos
 + 
Ën
 > 
šode
->
i_size
) {

1332 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

1339 ià(
šode
->
i_Æšk
)

1340 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

1343 ià(
»t
 =ğ-
ENOSPC
 &&

1344 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

1345 
»Œy_jouº®
;

1346 
	`put_·ge
(
·ge
);

1347  
»t
;

1349 *
·g•
 = 
·ge
;

1350  
»t
;

1351 
	}
}

1354 
	$wr™e_’d_â
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1356 
»t
;

1357 ià(!
	`bufãr_m­³d
(
bh
è|| 
	`bufãr_ä“d
(bh))

1359 
	`£t_bufãr_u±od©e
(
bh
);

1360 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

1361 
	`ş—r_bufãr_m‘a
(
bh
);

1362 
	`ş—r_bufãr_´io
(
bh
);

1363  
»t
;

1364 
	}
}

1373 
	$ext4_wr™e_’d
(
fe
 *file,

1374 
add»ss_¥aû
 *
m­pšg
,

1375 
loff_t
 
pos
, 
Ën
, 
cİ›d
,

1376 
·ge
 *·ge, *
fsd©a
)

1378 
hªdË_t
 *
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

1379 
šode
 *šodğ
m­pšg
->
ho¡
;

1380 
loff_t
 
Şd_size
 = 
šode
->
i_size
;

1381 
»t
 = 0, 
»t2
;

1382 
i_size_chªged
 = 0;

1384 
	`Œaû_ext4_wr™e_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
);

1385 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

1386 
»t
 = 
	`ext4_wr™e_šlše_d©a_’d
(
šode
, 
pos
, 
Ën
,

1387 
cİ›d
, 
·ge
);

1388 ià(
»t
 < 0) {

1389 
	`uÆock_·ge
(
·ge
);

1390 
	`put_·ge
(
·ge
);

1391 
”rout
;

1393 
cİ›d
 = 
»t
;

1395 
cİ›d
 = 
	`block_wr™e_’d
(
fe
, 
m­pšg
, 
pos
,

1396 
Ën
, 
cİ›d
, 
·ge
, 
fsd©a
);

1401 
i_size_chªged
 = 
	`ext4_upd©e_šode_size
(
šode
, 
pos
 + 
cİ›d
);

1402 
	`uÆock_·ge
(
·ge
);

1403 
	`put_·ge
(
·ge
);

1405 ià(
Şd_size
 < 
pos
)

1406 
	`·geÿche_isize_ex‹nded
(
šode
, 
Şd_size
, 
pos
);

1413 ià(
i_size_chªged
)

1414 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1416 ià(
pos
 + 
Ën
 > 
šode
->
i_size
 && 
	`ext4_ÿn_Œunÿ‹
(inode))

1421 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

1422 
”rout
:

1423 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1424 ià(!
»t
)

1425 
»t
 = 
»t2
;

1427 ià(
pos
 + 
Ën
 > 
šode
->
i_size
) {

1428 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

1434 ià(
šode
->
i_Æšk
)

1435 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

1438  
»t
 ?„‘ : 
cİ›d
;

1439 
	}
}

1446 
	$ext4_jouº®Ëd_z”o_Ãw_bufãrs
(
hªdË_t
 *
hªdË
,

1447 
·ge
 *page,

1448 
äom
, 
to
)

1450 
block_¡¬t
 = 0, 
block_’d
;

1451 
bufãr_h—d
 *
h—d
, *
bh
;

1453 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

1455 
block_’d
 = 
block_¡¬t
 + 
bh
->
b_size
;

1456 ià(
	`bufãr_Ãw
(
bh
)) {

1457 ià(
block_’d
 > 
äom
 && 
block_¡¬t
 < 
to
) {

1458 ià(!
	`PageU±od©e
(
·ge
)) {

1459 
¡¬t
, 
size
;

1461 
¡¬t
 = 
	`max
(
äom
, 
block_¡¬t
);

1462 
size
 = 
	`mš
(
to
, 
block_’d
è- 
¡¬t
;

1464 
	`z”o_u£r
(
·ge
, 
¡¬t
, 
size
);

1465 
	`wr™e_’d_â
(
hªdË
, 
bh
);

1467 
	`ş—r_bufãr_Ãw
(
bh
);

1470 
block_¡¬t
 = 
block_’d
;

1471 
bh
 = bh->
b_this_·ge
;

1472 } 
bh
 !ğ
h—d
);

1473 
	}
}

1475 
	$ext4_jouº®Ëd_wr™e_’d
(
fe
 *file,

1476 
add»ss_¥aû
 *
m­pšg
,

1477 
loff_t
 
pos
, 
Ën
, 
cİ›d
,

1478 
·ge
 *·ge, *
fsd©a
)

1480 
hªdË_t
 *
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

1481 
šode
 *šodğ
m­pšg
->
ho¡
;

1482 
loff_t
 
Şd_size
 = 
šode
->
i_size
;

1483 
»t
 = 0, 
»t2
;

1484 
·¹Ÿl
 = 0;

1485 
äom
, 
to
;

1486 
size_chªged
 = 0;

1488 
	`Œaû_ext4_jouº®Ëd_wr™e_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
);

1489 
äom
 = 
pos
 & (
PAGE_SIZE
 - 1);

1490 
to
 = 
äom
 + 
Ën
;

1492 
	`BUG_ON
(!
	`ext4_hªdË_v®id
(
hªdË
));

1494 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

1495 
»t
 = 
	`ext4_wr™e_šlše_d©a_’d
(
šode
, 
pos
, 
Ën
,

1496 
cİ›d
, 
·ge
);

1497 ià(
»t
 < 0) {

1498 
	`uÆock_·ge
(
·ge
);

1499 
	`put_·ge
(
·ge
);

1500 
”rout
;

1502 
cİ›d
 = 
»t
;

1503 } ià(
	`uÆik–y
(
cİ›d
 < 
Ën
è&& !
	`PageU±od©e
(
·ge
)) {

1504 
cİ›d
 = 0;

1505 
	`ext4_jouº®Ëd_z”o_Ãw_bufãrs
(
hªdË
, 
·ge
, 
äom
, 
to
);

1507 ià(
	`uÆik–y
(
cİ›d
 < 
Ën
))

1508 
	`ext4_jouº®Ëd_z”o_Ãw_bufãrs
(
hªdË
, 
·ge
,

1509 
äom
 + 
cİ›d
, 
to
);

1510 
»t
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
	`·ge_bufãrs
(
·ge
), 
äom
,

1511 
äom
 + 
cİ›d
, &
·¹Ÿl
,

1512 
wr™e_’d_â
);

1513 ià(!
·¹Ÿl
)

1514 
	`S‘PageU±od©e
(
·ge
);

1516 
size_chªged
 = 
	`ext4_upd©e_šode_size
(
šode
, 
pos
 + 
cİ›d
);

1517 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
);

1518 
	`EXT4_I
(
šode
)->
i_d©async_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

1519 
	`uÆock_·ge
(
·ge
);

1520 
	`put_·ge
(
·ge
);

1522 ià(
Şd_size
 < 
pos
)

1523 
	`·geÿche_isize_ex‹nded
(
šode
, 
Şd_size
, 
pos
);

1525 ià(
size_chªged
) {

1526 
»t2
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1527 ià(!
»t
)

1528 
»t
 = 
»t2
;

1531 ià(
pos
 + 
Ën
 > 
šode
->
i_size
 && 
	`ext4_ÿn_Œunÿ‹
(inode))

1536 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

1538 
”rout
:

1539 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1540 ià(!
»t
)

1541 
»t
 = 
»t2
;

1542 ià(
pos
 + 
Ën
 > 
šode
->
i_size
) {

1543 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

1549 ià(
šode
->
i_Æšk
)

1550 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

1553  
»t
 ?„‘ : 
cİ›d
;

1554 
	}
}

1559 
	$ext4_da_»£rve_¥aû
(
šode
 *inode)

1561 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1562 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1563 
»t
;

1570 
»t
 = 
	`dquÙ_»£rve_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 1));

1571 ià(
»t
)

1572  
»t
;

1574 
	`¥š_lock
(&
ei
->
i_block_»£rv©iÚ_lock
);

1575 ià(
	`ext4_şaim_ä“_şu¡”s
(
sbi
, 1, 0)) {

1576 
	`¥š_uÆock
(&
ei
->
i_block_»£rv©iÚ_lock
);

1577 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 1));

1578  -
ENOSPC
;

1580 
ei
->
i_»£rved_d©a_blocks
++;

1581 
	`Œaû_ext4_da_»£rve_¥aû
(
šode
);

1582 
	`¥š_uÆock
(&
ei
->
i_block_»£rv©iÚ_lock
);

1585 
	}
}

1587 
	$ext4_da_»Ëa£_¥aû
(
šode
 *šode, 
to_ä“
)

1589 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1590 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1592 ià(!
to_ä“
)

1595 
	`¥š_lock
(&
	`EXT4_I
(
šode
)->
i_block_»£rv©iÚ_lock
);

1597 
	`Œaû_ext4_da_»Ëa£_¥aû
(
šode
, 
to_ä“
);

1598 ià(
	`uÆik–y
(
to_ä“
 > 
ei
->
i_»£rved_d©a_blocks
)) {

1605 
	`ext4_w¬nšg
(
šode
->
i_sb
, "ext4_da_release_space: "

1607 "d©¨blocks", 
šode
->
i_šo
, 
to_ä“
,

1608 
ei
->
i_»£rved_d©a_blocks
);

1609 
	`WARN_ON
(1);

1610 
to_ä“
 = 
ei
->
i_»£rved_d©a_blocks
;

1612 
ei
->
i_»£rved_d©a_blocks
 -ğ
to_ä“
;

1615 
	`³rıu_couÁ”_sub
(&
sbi
->
s_dœtyşu¡”s_couÁ”
, 
to_ä“
);

1617 
	`¥š_uÆock
(&
	`EXT4_I
(
šode
)->
i_block_»£rv©iÚ_lock
);

1619 
	`dquÙ_»Ëa£_»£rv©iÚ_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 
to_ä“
));

1620 
	}
}

1622 
	$ext4_da_·ge_»Ëa£_»£rv©iÚ
(
·ge
 *page,

1623 
off£t
,

1624 
Ëngth
)

1626 
to_»Ëa£
 = 0, 
cÚtiguous_blks
 = 0;

1627 
bufãr_h—d
 *
h—d
, *
bh
;

1628 
cu¼_off
 = 0;

1629 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

1630 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1631 
¡İ
 = 
off£t
 + 
Ëngth
;

1632 
num_şu¡”s
;

1633 
ext4_fsblk_t
 
lblk
;

1635 
	`BUG_ON
(
¡İ
 > 
PAGE_SIZE
 || stİ < 
Ëngth
);

1637 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

1638 
bh
 = 
h—d
;

1640 
Ãxt_off
 = 
cu¼_off
 + 
bh
->
b_size
;

1642 ià(
Ãxt_off
 > 
¡İ
)

1645 ià((
off£t
 <ğ
cu¼_off
è&& (
	`bufãr_d–ay
(
bh
))) {

1646 
to_»Ëa£
++;

1647 
cÚtiguous_blks
++;

1648 
	`ş—r_bufãr_d–ay
(
bh
);

1649 } ià(
cÚtiguous_blks
) {

1650 
lblk
 = 
·ge
->
šdex
 <<

1651 (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

1652 
lblk
 +ğ(
cu¼_off
 >> 
šode
->
i_blkb™s
) -

1653 
cÚtiguous_blks
;

1654 
	`ext4_es_»move_ex‹Á
(
šode
, 
lblk
, 
cÚtiguous_blks
);

1655 
cÚtiguous_blks
 = 0;

1657 
cu¼_off
 = 
Ãxt_off
;

1658 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

1660 ià(
cÚtiguous_blks
) {

1661 
lblk
 = 
·ge
->
šdex
 << (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

1662 
lblk
 +ğ(
cu¼_off
 >> 
šode
->
i_blkb™s
è- 
cÚtiguous_blks
;

1663 
	`ext4_es_»move_ex‹Á
(
šode
, 
lblk
, 
cÚtiguous_blks
);

1668 
num_şu¡”s
 = 
	`EXT4_NUM_B2C
(
sbi
, 
to_»Ëa£
);

1669 
num_şu¡”s
 > 0) {

1670 
lblk
 = (
·ge
->
šdex
 << (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
)) +

1671 ((
num_şu¡”s
 - 1è<< 
sbi
->
s_şu¡”_b™s
);

1672 ià(
sbi
->
s_şu¡”_¿tio
 == 1 ||

1673 !
	`ext4_fšd_d–®loc_şu¡”
(
šode
, 
lblk
))

1674 
	`ext4_da_»Ëa£_¥aû
(
šode
, 1);

1676 
num_şu¡”s
--;

1678 
	}
}

1684 
	sm·ge_da_d©a
 {

1685 
šode
 *
	mšode
;

1686 
wr™eback_cÚŒŞ
 *
	mwbc
;

1688 
pgoff_t
 
	mfœ¡_·ge
;

1689 
pgoff_t
 
	mÃxt_·ge
;

1690 
pgoff_t
 
	mÏ¡_·ge
;

1696 
ext4_m­_blocks
 
	mm­
;

1697 
ext4_io_subm™
 
	mio_subm™
;

1698 
	mdo_m­
:1;

1701 
	$m·ge_»Ëa£_unu£d_·ges
(
m·ge_da_d©a
 *
mpd
,

1702 
boŞ
 
šv®id©e
)

1704 
Ä_·ges
, 
i
;

1705 
pgoff_t
 
šdex
, 
’d
;

1706 
·gevec
 
pvec
;

1707 
šode
 *šodğ
mpd
->inode;

1708 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

1711 ià(
mpd
->
fœ¡_·ge
 >ğmpd->
Ãxt_·ge
)

1714 
šdex
 = 
mpd
->
fœ¡_·ge
;

1715 
’d
 = 
mpd
->
Ãxt_·ge
 - 1;

1716 ià(
šv®id©e
) {

1717 
ext4_lblk_t
 
¡¬t
, 
Ï¡
;

1718 
¡¬t
 = 
šdex
 << (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

1719 
Ï¡
 = 
’d
 << (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

1720 
	`ext4_es_»move_ex‹Á
(
šode
, 
¡¬t
, 
Ï¡
 - start + 1);

1723 
	`·gevec_š™
(&
pvec
, 0);

1724 
šdex
 <ğ
’d
) {

1725 
Ä_·ges
 = 
	`·gevec_lookup
(&
pvec
, 
m­pšg
, 
šdex
, 
PAGEVEC_SIZE
);

1726 ià(
Ä_·ges
 == 0)

1728 
i
 = 0; i < 
Ä_·ges
; i++) {

1729 
·ge
 *·gğ
pvec
.
·ges
[
i
];

1730 ià(
·ge
->
šdex
 > 
’d
)

1732 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

1733 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

1734 ià(
šv®id©e
) {

1735 ià(
	`·ge_m­³d
(
·ge
))

1736 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

1737 
	`block_šv®id©•age
(
·ge
, 0, 
PAGE_SIZE
);

1738 
	`CË¬PageU±od©e
(
·ge
);

1740 
	`uÆock_·ge
(
·ge
);

1742 
šdex
 = 
pvec
.
·ges
[
Ä_·ges
 - 1]->index + 1;

1743 
	`·gevec_»Ëa£
(&
pvec
);

1745 
	}
}

1747 
	$ext4_´št_ä“_blocks
(
šode
 *inode)

1749 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

1750 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1751 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1753 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Total free blocks count %lld",

1754 
	`EXT4_C2B
(
	`EXT4_SB
(
šode
->
i_sb
),

1755 
	`ext4_couÁ_ä“_şu¡”s
(
sb
)));

1756 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Free/Dirty block details");

1757 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "free_blocks=%lld",

1758 (è
	`EXT4_C2B
(
	`EXT4_SB
(
sb
),

1759 
	`³rıu_couÁ”_sum
(&
sbi
->
s_ä“şu¡”s_couÁ”
)));

1760 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "dirty_blocks=%lld",

1761 (è
	`EXT4_C2B
(
	`EXT4_SB
(
sb
),

1762 
	`³rıu_couÁ”_sum
(&
sbi
->
s_dœtyşu¡”s_couÁ”
)));

1763 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Block„eservation details");

1764 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "i_reserved_data_blocks=%u",

1765 
ei
->
i_»£rved_d©a_blocks
);

1767 
	}
}

1769 
	$ext4_bh_d–ay_Ü_unwr™‹n
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1771  (
	`bufãr_d–ay
(
bh
è|| 
	`bufãr_unwr™‹n
(bh)è&& 
	`bufãr_dœty
(bh);

1772 
	}
}

1780 
	$ext4_da_m­_blocks
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1781 
ext4_m­_blocks
 *
m­
,

1782 
bufãr_h—d
 *
bh
)

1784 
ex‹Á_¡©us
 
es
;

1785 
»tv®
;

1786 
£ùÜ_t
 
šv®id_block
 = ~((sector_t) 0xffff);

1787 #ifdeà
ES_AGGRESSIVE_TEST


1788 
ext4_m­_blocks
 
Üig_m­
;

1790 
	`memıy
(&
Üig_m­
, 
m­
, (*map));

1793 ià(
šv®id_block
 < 
	`ext4_blocks_couÁ
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
))

1794 
šv®id_block
 = ~0;

1796 
m­
->
m_æags
 = 0;

1797 
	`ext_debug
("ext4_da_map_blocks(): inode %lu, max_blocks %u,"

1798 "logiÿÈblock %lu\n", 
šode
->
i_šo
, 
m­
->
m_Ën
,

1799 (è
m­
->
m_lblk
);

1802 ià(
	`ext4_es_lookup_ex‹Á
(
šode
, 
iblock
, &
es
)) {

1803 ià(
	`ext4_es_is_hŞe
(&
es
)) {

1804 
»tv®
 = 0;

1805 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

1806 
add_d–ayed
;

1813 ià(
	`ext4_es_is_d–ayed
(&
es
è&& !
	`ext4_es_is_unwr™‹n
(&es)) {

1814 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
šv®id_block
);

1815 
	`£t_bufãr_Ãw
(
bh
);

1816 
	`£t_bufãr_d–ay
(
bh
);

1820 
m­
->
m_pblk
 = 
	`ext4_es_pblock
(&
es
è+ 
iblock
 -ƒs.
es_lblk
;

1821 
»tv®
 = 
es
.
es_Ën
 - (
iblock
 -ƒs.
es_lblk
);

1822 ià(
»tv®
 > 
m­
->
m_Ën
)

1823 
»tv®
 = 
m­
->
m_Ën
;

1824 
m­
->
m_Ën
 = 
»tv®
;

1825 ià(
	`ext4_es_is_wr™‹n
(&
es
))

1826 
m­
->
m_æags
 |ğ
EXT4_MAP_MAPPED
;

1827 ià(
	`ext4_es_is_unwr™‹n
(&
es
))

1828 
m­
->
m_æags
 |ğ
EXT4_MAP_UNWRITTEN
;

1830 
	`BUG_ON
(1);

1832 #ifdeà
ES_AGGRESSIVE_TEST


1833 
	`ext4_m­_blocks_es_»check
(
NULL
, 
šode
, 
m­
, &
Üig_m­
, 0);

1835  
»tv®
;

1842 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

1843 ià(
	`ext4_has_šlše_d©a
(
šode
))

1844 
»tv®
 = 0;

1845 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

1846 
»tv®
 = 
	`ext4_ext_m­_blocks
(
NULL
, 
šode
, 
m­
, 0);

1848 
»tv®
 = 
	`ext4_šd_m­_blocks
(
NULL
, 
šode
, 
m­
, 0);

1850 
add_d–ayed
:

1851 ià(
»tv®
 == 0) {

1852 
»t
;

1862 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_şu¡”_¿tio
 == 1 ||

1863 !
	`ext4_fšd_d–®loc_şu¡”
(
šode
, 
m­
->
m_lblk
)) {

1864 
»t
 = 
	`ext4_da_»£rve_¥aû
(
šode
);

1865 ià(
»t
) {

1867 
»tv®
 = 
»t
;

1868 
out_uÆock
;

1872 
»t
 = 
	`ext4_es_š£¹_ex‹Á
(
šode
, 
m­
->
m_lblk
, m­->
m_Ën
,

1873 ~0, 
EXTENT_STATUS_DELAYED
);

1874 ià(
»t
) {

1875 
»tv®
 = 
»t
;

1876 
out_uÆock
;

1879 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
šv®id_block
);

1880 
	`£t_bufãr_Ãw
(
bh
);

1881 
	`£t_bufãr_d–ay
(
bh
);

1882 } ià(
»tv®
 > 0) {

1883 
»t
;

1884 
¡©us
;

1886 ià(
	`uÆik–y
(
»tv®
 !ğ
m­
->
m_Ën
)) {

1887 
	`ext4_w¬nšg
(
šode
->
i_sb
,

1890 
šode
->
i_šo
, 
»tv®
, 
m­
->
m_Ën
);

1891 
	`WARN_ON
(1);

1894 
¡©us
 = 
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
 ?

1895 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

1896 
»t
 = 
	`ext4_es_š£¹_ex‹Á
(
šode
, 
m­
->
m_lblk
, m­->
m_Ën
,

1897 
m­
->
m_pblk
, 
¡©us
);

1898 ià(
»t
 != 0)

1899 
»tv®
 = 
»t
;

1902 
out_uÆock
:

1903 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

1905  
»tv®
;

1906 
	}
}

1920 
	$ext4_da_g‘_block_´•
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1921 
bufãr_h—d
 *
bh
, 
ü—‹
)

1923 
ext4_m­_blocks
 
m­
;

1924 
»t
 = 0;

1926 
	`BUG_ON
(
ü—‹
 == 0);

1927 
	`BUG_ON
(
bh
->
b_size
 !ğ
šode
->
i_sb
->
s_blocksize
);

1929 
m­
.
m_lblk
 = 
iblock
;

1930 
m­
.
m_Ën
 = 1;

1937 
»t
 = 
	`ext4_da_m­_blocks
(
šode
, 
iblock
, &
m­
, 
bh
);

1938 ià(
»t
 <= 0)

1939  
»t
;

1941 
	`m­_bh
(
bh
, 
šode
->
i_sb
, 
m­
.
m_pblk
);

1942 
	`ext4_upd©e_bh_¡©e
(
bh
, 
m­
.
m_æags
);

1944 ià(
	`bufãr_unwr™‹n
(
bh
)) {

1951 
	`£t_bufãr_Ãw
(
bh
);

1952 
	`£t_bufãr_m­³d
(
bh
);

1955 
	}
}

1957 
	$bg‘_Úe
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1959 
	`g‘_bh
(
bh
);

1961 
	}
}

1963 
	$bput_Úe
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1965 
	`put_bh
(
bh
);

1967 
	}
}

1969 
	$__ext4_jouº®Ëd_wr™•age
(
·ge
 *page,

1970 
Ën
)

1972 
add»ss_¥aû
 *
m­pšg
 = 
·ge
->mapping;

1973 
šode
 *šodğ
m­pšg
->
ho¡
;

1974 
bufãr_h—d
 *
·ge_bufs
 = 
NULL
;

1975 
hªdË_t
 *
hªdË
 = 
NULL
;

1976 
»t
 = 0, 
”r
 = 0;

1977 
šlše_d©a
 = 
	`ext4_has_šlše_d©a
(
šode
);

1978 
bufãr_h—d
 *
šode_bh
 = 
NULL
;

1980 
	`CË¬PageChecked
(
·ge
);

1982 ià(
šlše_d©a
) {

1983 
	`BUG_ON
(
·ge
->
šdex
 != 0);

1984 
	`BUG_ON
(
Ën
 > 
	`ext4_g‘_max_šlše_size
(
šode
));

1985 
šode_bh
 = 
	`ext4_jouº®Ëd_wr™e_šlše_d©a
(
šode
, 
Ën
, 
·ge
);

1986 ià(
šode_bh
 =ğ
NULL
)

1987 
out
;

1989 
·ge_bufs
 = 
	`·ge_bufãrs
(
·ge
);

1990 ià(!
·ge_bufs
) {

1991 
	`BUG
();

1992 
out
;

1994 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
·ge_bufs
, 0, 
Ën
,

1995 
NULL
, 
bg‘_Úe
);

2002 
	`g‘_·ge
(
·ge
);

2003 
	`uÆock_·ge
(
·ge
);

2005 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
,

2006 
	`ext4_wr™•age_Œªs_blocks
(
šode
));

2007 ià(
	`IS_ERR
(
hªdË
)) {

2008 
»t
 = 
	`PTR_ERR
(
hªdË
);

2009 
	`put_·ge
(
·ge
);

2010 
out_no_·g–ock
;

2012 
	`BUG_ON
(!
	`ext4_hªdË_v®id
(
hªdË
));

2014 
	`lock_·ge
(
·ge
);

2015 
	`put_·ge
(
·ge
);

2016 ià(
·ge
->
m­pšg
 != mapping) {

2018 
	`ext4_jouº®_¡İ
(
hªdË
);

2019 
»t
 = 0;

2020 
out
;

2023 ià(
šlše_d©a
) {

2024 
	`BUFFER_TRACE
(
šode_bh
, "get write‡ccess");

2025 
»t
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
šode_bh
);

2027 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
šode_bh
);

2030 
»t
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
·ge_bufs
, 0, 
Ën
, 
NULL
,

2031 
do_jouº®_g‘_wr™e_acûss
);

2033 
”r
 = 
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
·ge_bufs
, 0, 
Ën
, 
NULL
,

2034 
wr™e_’d_â
);

2036 ià(
»t
 == 0)

2037 
»t
 = 
”r
;

2038 
	`EXT4_I
(
šode
)->
i_d©async_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

2039 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

2040 ià(!
»t
)

2041 
»t
 = 
”r
;

2043 ià(!
	`ext4_has_šlše_d©a
(
šode
))

2044 
	`ext4_w®k_·ge_bufãrs
(
NULL
, 
·ge_bufs
, 0, 
Ën
,

2045 
NULL
, 
bput_Úe
);

2046 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
);

2047 
out
:

2048 
	`uÆock_·ge
(
·ge
);

2049 
out_no_·g–ock
:

2050 
	`b»l£
(
šode_bh
);

2051  
»t
;

2052 
	}
}

2095 
	$ext4_wr™•age
(
·ge
 *page,

2096 
wr™eback_cÚŒŞ
 *
wbc
)

2098 
»t
 = 0;

2099 
loff_t
 
size
;

2100 
Ën
;

2101 
bufãr_h—d
 *
·ge_bufs
 = 
NULL
;

2102 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

2103 
ext4_io_subm™
 
io_subm™
;

2104 
boŞ
 
k“p_towr™e
 = 
çl£
;

2106 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
)))) {

2107 
	`ext4_šv®id©•age
(
·ge
, 0, 
PAGE_SIZE
);

2108 
	`uÆock_·ge
(
·ge
);

2109  -
EIO
;

2112 
	`Œaû_ext4_wr™•age
(
·ge
);

2113 
size
 = 
	`i_size_»ad
(
šode
);

2114 ià(
·ge
->
šdex
 =ğ
size
 >> 
PAGE_SHIFT
)

2115 
Ën
 = 
size
 & ~
PAGE_MASK
;

2117 
Ën
 = 
PAGE_SIZE
;

2119 
·ge_bufs
 = 
	`·ge_bufãrs
(
·ge
);

2137 ià(
	`ext4_w®k_·ge_bufãrs
(
NULL
, 
·ge_bufs
, 0, 
Ën
, NULL,

2138 
ext4_bh_d–ay_Ü_unwr™‹n
)) {

2139 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

2140 ià((
cu¼’t
->
æags
 & 
PF_MEMALLOC
) ||

2141 (
šode
->
i_sb
->
s_blocksize
 =ğ
PAGE_SIZE
)) {

2147 
	`WARN_ON_ONCE
((
cu¼’t
->
æags
 & (
PF_MEMALLOC
|
PF_KSWAPD
))

2148 =ğ
PF_MEMALLOC
);

2149 
	`uÆock_·ge
(
·ge
);

2152 
k“p_towr™e
 = 
Œue
;

2155 ià(
	`PageChecked
(
·ge
è&& 
	`ext4_should_jouº®_d©a
(
šode
))

2160  
	`__ext4_jouº®Ëd_wr™•age
(
·ge
, 
Ën
);

2162 
	`ext4_io_subm™_š™
(&
io_subm™
, 
wbc
);

2163 
io_subm™
.
io_’d
 = 
	`ext4_š™_io_’d
(
šode
, 
GFP_NOFS
);

2164 ià(!
io_subm™
.
io_’d
) {

2165 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

2166 
	`uÆock_·ge
(
·ge
);

2167  -
ENOMEM
;

2169 
»t
 = 
	`ext4_bio_wr™e_·ge
(&
io_subm™
, 
·ge
, 
Ën
, 
wbc
, 
k“p_towr™e
);

2170 
	`ext4_io_subm™
(&
io_subm™
);

2172 
	`ext4_put_io_’d_deãr
(
io_subm™
.
io_’d
);

2173  
»t
;

2174 
	}
}

2176 
	$m·ge_subm™_·ge
(
m·ge_da_d©a
 *
mpd
, 
·ge
 *page)

2178 
Ën
;

2179 
loff_t
 
size
;

2180 
”r
;

2182 
	`BUG_ON
(
·ge
->
šdex
 !ğ
mpd
->
fœ¡_·ge
);

2183 
	`ş—r_·ge_dœty_fÜ_io
(
·ge
);

2197 
size
 = 
	`i_size_»ad
(
mpd
->
šode
);

2198 ià(
·ge
->
šdex
 =ğ
size
 >> 
PAGE_SHIFT
)

2199 
Ën
 = 
size
 & ~
PAGE_MASK
;

2201 
Ën
 = 
PAGE_SIZE
;

2202 
”r
 = 
	`ext4_bio_wr™e_·ge
(&
mpd
->
io_subm™
, 
·ge
, 
Ën
, mpd->
wbc
, 
çl£
);

2203 ià(!
”r
)

2204 
mpd
->
wbc
->
Ä_to_wr™e
--;

2205 
mpd
->
fœ¡_·ge
++;

2207  
”r
;

2208 
	}
}

2210 
	#BH_FLAGS
 ((1 << 
BH_Unwr™‹n
è| (1 << 
BH_D–ay
))

	)

2217 
	#MAX_WRITEPAGES_EXTENT_LEN
 2048

	)

2233 
boŞ
 
	$m·ge_add_bh_to_ex‹Á
(
m·ge_da_d©a
 *
mpd
, 
ext4_lblk_t
 
lblk
,

2234 
bufãr_h—d
 *
bh
)

2236 
ext4_m­_blocks
 *
m­
 = &
mpd
->map;

2239 ià(!
	`bufãr_dœty
(
bh
è|| !
	`bufãr_m­³d
(bh) ||

2240 (!
	`bufãr_d–ay
(
bh
è&& !
	`bufãr_unwr™‹n
(bh))) {

2242 ià(
m­
->
m_Ën
 == 0)

2243  
Œue
;

2244  
çl£
;

2248 ià(
m­
->
m_Ën
 == 0) {

2250 ià(!
mpd
->
do_m­
)

2251  
çl£
;

2252 
m­
->
m_lblk
 = 
lblk
;

2253 
m­
->
m_Ën
 = 1;

2254 
m­
->
m_æags
 = 
bh
->
b_¡©e
 & 
BH_FLAGS
;

2255  
Œue
;

2259 ià(
m­
->
m_Ën
 >ğ
MAX_WRITEPAGES_EXTENT_LEN
)

2260  
çl£
;

2263 ià(
lblk
 =ğ
m­
->
m_lblk
 + m­->
m_Ën
 &&

2264 (
bh
->
b_¡©e
 & 
BH_FLAGS
è=ğ
m­
->
m_æags
) {

2265 
m­
->
m_Ën
++;

2266  
Œue
;

2268  
çl£
;

2269 
	}
}

2287 
	$m·ge_´oûss_·ge_bufs
(
m·ge_da_d©a
 *
mpd
,

2288 
bufãr_h—d
 *
h—d
,

2289 
bufãr_h—d
 *
bh
,

2290 
ext4_lblk_t
 
lblk
)

2292 
šode
 *šodğ
mpd
->inode;

2293 
”r
;

2294 
ext4_lblk_t
 
blocks
 = (
	`i_size_»ad
(
šode
è+ 
	`i_blocksize
(inode) - 1)

2295 >> 
šode
->
i_blkb™s
;

2298 
	`BUG_ON
(
	`bufãr_locked
(
bh
));

2300 ià(
lblk
 >ğ
blocks
 || !
	`m·ge_add_bh_to_ex‹Á
(
mpd
,†blk, 
bh
)) {

2302 ià(
mpd
->
m­
.
m_Ën
)

2305 ià(!
mpd
->
do_m­
)

2310 } 
lblk
++, (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

2312 ià(
mpd
->
m­
.
m_Ën
 == 0) {

2313 
”r
 = 
	`m·ge_subm™_·ge
(
mpd
, 
h—d
->
b_·ge
);

2314 ià(
”r
 < 0)

2315  
”r
;

2317  
lblk
 < 
blocks
;

2318 
	}
}

2334 
	$m·ge_m­_ªd_subm™_bufãrs
(
m·ge_da_d©a
 *
mpd
)

2336 
·gevec
 
pvec
;

2337 
Ä_·ges
, 
i
;

2338 
šode
 *šodğ
mpd
->inode;

2339 
bufãr_h—d
 *
h—d
, *
bh
;

2340 
bµ_b™s
 = 
PAGE_SHIFT
 - 
šode
->
i_blkb™s
;

2341 
pgoff_t
 
¡¬t
, 
’d
;

2342 
ext4_lblk_t
 
lblk
;

2343 
£ùÜ_t
 
pblock
;

2344 
”r
;

2346 
¡¬t
 = 
mpd
->
m­
.
m_lblk
 >> 
bµ_b™s
;

2347 
’d
 = (
mpd
->
m­
.
m_lblk
 + mpd->m­.
m_Ën
 - 1è>> 
bµ_b™s
;

2348 
lblk
 = 
¡¬t
 << 
bµ_b™s
;

2349 
pblock
 = 
mpd
->
m­
.
m_pblk
;

2351 
	`·gevec_š™
(&
pvec
, 0);

2352 
¡¬t
 <ğ
’d
) {

2353 
Ä_·ges
 = 
	`·gevec_lookup
(&
pvec
, 
šode
->
i_m­pšg
, 
¡¬t
,

2354 
PAGEVEC_SIZE
);

2355 ià(
Ä_·ges
 == 0)

2357 
i
 = 0; i < 
Ä_·ges
; i++) {

2358 
·ge
 *·gğ
pvec
.
·ges
[
i
];

2360 ià(
·ge
->
šdex
 > 
’d
)

2363 
	`BUG_ON
(
·ge
->
šdex
 !ğ
¡¬t
);

2364 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

2366 ià(
lblk
 < 
mpd
->
m­
.
m_lblk
)

2368 ià(
lblk
 >ğ
mpd
->
m­
.
m_lblk
 + mpd->m­.
m_Ën
) {

2373 
mpd
->
m­
.
m_Ën
 = 0;

2374 
mpd
->
m­
.
m_æags
 = 0;

2382 
”r
 = 
	`m·ge_´oûss_·ge_bufs
(
mpd
, 
h—d
,

2383 
bh
, 
lblk
);

2384 
	`·gevec_»Ëa£
(&
pvec
);

2385 ià(
”r
 > 0)

2386 
”r
 = 0;

2387  
”r
;

2389 ià(
	`bufãr_d–ay
(
bh
)) {

2390 
	`ş—r_bufãr_d–ay
(
bh
);

2391 
bh
->
b_blockÄ
 = 
pblock
++;

2393 
	`ş—r_bufãr_unwr™‹n
(
bh
);

2394 } 
lblk
++, (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

2401 
mpd
->
io_subm™
.
io_’d
->
size
 +ğ
PAGE_SIZE
;

2403 
”r
 = 
	`m·ge_subm™_·ge
(
mpd
, 
·ge
);

2404 ià(
”r
 < 0) {

2405 
	`·gevec_»Ëa£
(&
pvec
);

2406  
”r
;

2408 
¡¬t
++;

2410 
	`·gevec_»Ëa£
(&
pvec
);

2413 
mpd
->
m­
.
m_Ën
 = 0;

2414 
mpd
->
m­
.
m_æags
 = 0;

2416 
	}
}

2418 
	$m·ge_m­_Úe_ex‹Á
(
hªdË_t
 *
hªdË
, 
m·ge_da_d©a
 *
mpd
)

2420 
šode
 *šodğ
mpd
->inode;

2421 
ext4_m­_blocks
 *
m­
 = &
mpd
->map;

2422 
g‘_blocks_æags
;

2423 
”r
, 
diÜ—d_nŞock
;

2425 
	`Œaû_ext4_da_wr™e_·ges_ex‹Á
(
šode
, 
m­
);

2441 
g‘_blocks_æags
 = 
EXT4_GET_BLOCKS_CREATE
 |

2442 
EXT4_GET_BLOCKS_METADATA_NOFAIL
 |

2443 
EXT4_GET_BLOCKS_IO_SUBMIT
;

2444 
diÜ—d_nŞock
 = 
	`ext4_should_diÜ—d_nŞock
(
šode
);

2445 ià(
diÜ—d_nŞock
)

2446 
g‘_blocks_æags
 |ğ
EXT4_GET_BLOCKS_IO_CREATE_EXT
;

2447 ià(
m­
->
m_æags
 & (1 << 
BH_D–ay
))

2448 
g‘_blocks_æags
 |ğ
EXT4_GET_BLOCKS_DELALLOC_RESERVE
;

2450 
”r
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, 
m­
, 
g‘_blocks_æags
);

2451 ià(
”r
 < 0)

2452  
”r
;

2453 ià(
diÜ—d_nŞock
 && (
m­
->
m_æags
 & 
EXT4_MAP_UNWRITTEN
)) {

2454 ià(!
mpd
->
io_subm™
.
io_’d
->
hªdË
 &&

2455 
	`ext4_hªdË_v®id
(
hªdË
)) {

2456 
mpd
->
io_subm™
.
io_’d
->
hªdË
 = hªdË->
h_rsv_hªdË
;

2457 
hªdË
->
h_rsv_hªdË
 = 
NULL
;

2459 
	`ext4_£t_io_unwr™‹n_æag
(
šode
, 
mpd
->
io_subm™
.
io_’d
);

2462 
	`BUG_ON
(
m­
->
m_Ën
 == 0);

2463 ià(
m­
->
m_æags
 & 
EXT4_MAP_NEW
) {

2464 
	`ş—n_bdev_®Ÿ£s
(
šode
->
i_sb
->
s_bdev
, 
m­
->
m_pblk
,

2465 
m­
->
m_Ën
);

2468 
	}
}

2490 
	$m·ge_m­_ªd_subm™_ex‹Á
(
hªdË_t
 *
hªdË
,

2491 
m·ge_da_d©a
 *
mpd
,

2492 
boŞ
 *
give_up_Ú_wr™e
)

2494 
šode
 *šodğ
mpd
->inode;

2495 
ext4_m­_blocks
 *
m­
 = &
mpd
->map;

2496 
”r
;

2497 
loff_t
 
disksize
;

2498 
´og»ss
 = 0;

2500 
mpd
->
io_subm™
.
io_’d
->
off£t
 =

2501 ((
loff_t
)
m­
->
m_lblk
è<< 
šode
->
i_blkb™s
;

2503 
”r
 = 
	`m·ge_m­_Úe_ex‹Á
(
hªdË
, 
mpd
);

2504 ià(
”r
 < 0) {

2505 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

2507 ià(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
)) ||

2508 
	`EXT4_SB
(
sb
)->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
)

2509 
šv®id©e_dœty_·ges
;

2515 ià((
”r
 =ğ-
ENOMEM
) ||

2516 (
”r
 =ğ-
ENOSPC
 && 
	`ext4_couÁ_ä“_şu¡”s
(
sb
))) {

2517 ià(
´og»ss
)

2518 
upd©e_disksize
;

2519  
”r
;

2521 
	`ext4_msg
(
sb
, 
KERN_CRIT
,

2525 
šode
->
i_šo
,

2526 ()
m­
->
m_lblk
,

2527 ()
m­
->
m_Ën
, -
”r
);

2528 
	`ext4_msg
(
sb
, 
KERN_CRIT
,

2531 ià(
”r
 =ğ-
ENOSPC
)

2532 
	`ext4_´št_ä“_blocks
(
šode
);

2533 
šv®id©e_dœty_·ges
:

2534 *
give_up_Ú_wr™e
 = 
Œue
;

2535  
”r
;

2537 
´og»ss
 = 1;

2542 
”r
 = 
	`m·ge_m­_ªd_subm™_bufãrs
(
mpd
);

2543 ià(
”r
 < 0)

2544 
upd©e_disksize
;

2545 } 
m­
->
m_Ën
);

2547 
upd©e_disksize
:

2552 
disksize
 = ((
loff_t
)
mpd
->
fœ¡_·ge
è<< 
PAGE_SHIFT
;

2553 ià(
disksize
 > 
	`EXT4_I
(
šode
)->
i_disksize
) {

2554 
”r2
;

2555 
loff_t
 
i_size
;

2557 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2558 
i_size
 = 
	`i_size_»ad
(
šode
);

2559 ià(
disksize
 > 
i_size
)

2560 
disksize
 = 
i_size
;

2561 ià(
disksize
 > 
	`EXT4_I
(
šode
)->
i_disksize
)

2562 
	`EXT4_I
(
šode
)->
i_disksize
 = 
disksize
;

2563 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

2564 
”r2
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2565 ià(
”r2
)

2566 
	`ext4_”rÜ
(
šode
->
i_sb
,

2568 
šode
->
i_šo
);

2569 ià(!
”r
)

2570 
”r
 = 
”r2
;

2572  
”r
;

2573 
	}
}

2582 
	$ext4_da_wr™•ages_Œªs_blocks
(
šode
 *inode)

2584 
bµ
 = 
	`ext4_jouº®_blocks_³r_·ge
(
šode
);

2586  
	`ext4_m‘a_Œªs_blocks
(
šode
,

2587 
MAX_WRITEPAGES_EXTENT_LEN
 + 
bµ
 - 1, bpp);

2588 
	}
}

2608 
	$m·ge_´•¬e_ex‹Á_to_m­
(
m·ge_da_d©a
 *
mpd
)

2610 
add»ss_¥aû
 *
m­pšg
 = 
mpd
->
šode
->
i_m­pšg
;

2611 
·gevec
 
pvec
;

2612 
Ä_·ges
;

2613 
Ëá
 = 
mpd
->
wbc
->
Ä_to_wr™e
;

2614 
pgoff_t
 
šdex
 = 
mpd
->
fœ¡_·ge
;

2615 
pgoff_t
 
’d
 = 
mpd
->
Ï¡_·ge
;

2616 
g
;

2617 
i
, 
”r
 = 0;

2618 
blkb™s
 = 
mpd
->
šode
->
i_blkb™s
;

2619 
ext4_lblk_t
 
lblk
;

2620 
bufãr_h—d
 *
h—d
;

2622 ià(
mpd
->
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || mpd->wbc->
gged_wr™•ages
)

2623 
g
 = 
PAGECACHE_TAG_TOWRITE
;

2625 
g
 = 
PAGECACHE_TAG_DIRTY
;

2627 
	`·gevec_š™
(&
pvec
, 0);

2628 
mpd
->
m­
.
m_Ën
 = 0;

2629 
mpd
->
Ãxt_·ge
 = 
šdex
;

2630 
šdex
 <ğ
’d
) {

2631 
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
m­pšg
, &
šdex
, 
g
,

2632 
	`mš
(
’d
 - 
šdex
, (
pgoff_t
)
PAGEVEC_SIZE
-1) + 1);

2633 ià(
Ä_·ges
 == 0)

2634 
out
;

2636 
i
 = 0; i < 
Ä_·ges
; i++) {

2637 
·ge
 *·gğ
pvec
.
·ges
[
i
];

2646 ià(
·ge
->
šdex
 > 
’d
)

2647 
out
;

2657 ià(
mpd
->
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
 && 
Ëá
 <= 0)

2658 
out
;

2661 ià(
mpd
->
m­
.
m_Ën
 > 0 && mpd->
Ãxt_·ge
 !ğ
·ge
->
šdex
)

2662 
out
;

2664 
	`lock_·ge
(
·ge
);

2672 ià(!
	`PageDœty
(
·ge
) ||

2673 (
	`PageWr™eback
(
·ge
) &&

2674 (
mpd
->
wbc
->
sync_mode
 =ğ
WB_SYNC_NONE
)) ||

2675 
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

2676 
	`uÆock_·ge
(
·ge
);

2680 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

2681 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

2683 ià(
mpd
->
m­
.
m_Ën
 == 0)

2684 
mpd
->
fœ¡_·ge
 = 
·ge
->
šdex
;

2685 
mpd
->
Ãxt_·ge
 = 
·ge
->
šdex
 + 1;

2687 
lblk
 = ((
ext4_lblk_t
)
·ge
->
šdex
) <<

2688 (
PAGE_SHIFT
 - 
blkb™s
);

2689 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

2690 
”r
 = 
	`m·ge_´oûss_·ge_bufs
(
mpd
, 
h—d
, h—d, 
lblk
);

2691 ià(
”r
 <= 0)

2692 
out
;

2693 
”r
 = 0;

2694 
Ëá
--;

2696 
	`·gevec_»Ëa£
(&
pvec
);

2697 
	`cÚd_»sched
();

2700 
out
:

2701 
	`·gevec_»Ëa£
(&
pvec
);

2702  
”r
;

2703 
	}
}

2705 
	$__wr™•age
(
·ge
 *·ge, 
wr™eback_cÚŒŞ
 *
wbc
,

2706 *
d©a
)

2708 
add»ss_¥aû
 *
m­pšg
 = 
d©a
;

2709 
»t
 = 
	`ext4_wr™•age
(
·ge
, 
wbc
);

2710 
	`m­pšg_£t_”rÜ
(
m­pšg
, 
»t
);

2711  
»t
;

2712 
	}
}

2714 
	$ext4_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

2715 
wr™eback_cÚŒŞ
 *
wbc
)

2717 
pgoff_t
 
wr™eback_šdex
 = 0;

2718 
Ä_to_wr™e
 = 
wbc
->nr_to_write;

2719 
¿nge_whŞe
 = 0;

2720 
cyşed
 = 1;

2721 
hªdË_t
 *
hªdË
 = 
NULL
;

2722 
m·ge_da_d©a
 
mpd
;

2723 
šode
 *šodğ
m­pšg
->
ho¡
;

2724 
Ãeded_blocks
, 
rsv_blocks
 = 0, 
»t
 = 0;

2725 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
m­pšg
->
ho¡
->
i_sb
);

2726 
boŞ
 
dÚe
;

2727 
blk_¶ug
 
¶ug
;

2728 
boŞ
 
give_up_Ú_wr™e
 = 
çl£
;

2730 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

2731  -
EIO
;

2733 
	`³rıu_down_»ad
(&
sbi
->
s_jouº®_æag_rw£m
);

2734 
	`Œaû_ext4_wr™•ages
(
šode
, 
wbc
);

2736 ià(
	`dax_m­pšg
(
m­pšg
)) {

2737 
»t
 = 
	`dax_wr™eback_m­pšg_¿nge
(
m­pšg
, 
šode
->
i_sb
->
s_bdev
,

2738 
wbc
);

2739 
out_wr™•ages
;

2747 ià(!
m­pšg
->
Ä·ges
 || !
	`m­pšg_gged
(m­pšg, 
PAGECACHE_TAG_DIRTY
))

2748 
out_wr™•ages
;

2750 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

2751 
blk_¶ug
 
¶ug
;

2753 
	`blk_¡¬t_¶ug
(&
¶ug
);

2754 
»t
 = 
	`wr™e_ÿche_·ges
(
m­pšg
, 
wbc
, 
__wr™•age
, mapping);

2755 
	`blk_fšish_¶ug
(&
¶ug
);

2756 
out_wr™•ages
;

2769 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
m­pšg
->
ho¡
->
i_sb
)) ||

2770 
sbi
->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
)) {

2771 
»t
 = -
EROFS
;

2772 
out_wr™•ages
;

2775 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
)) {

2780 
rsv_blocks
 = 1 + (
PAGE_SIZE
 >> 
šode
->
i_blkb™s
);

2788 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

2790 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

2791 ià(
	`IS_ERR
(
hªdË
)) {

2792 
»t
 = 
	`PTR_ERR
(
hªdË
);

2793 
out_wr™•ages
;

2795 
	`BUG_ON
(
	`ext4_‹¡_šode_¡©e
(
šode
,

2796 
EXT4_STATE_MAY_INLINE_DATA
));

2797 
	`ext4_de¡roy_šlše_d©a
(
hªdË
, 
šode
);

2798 
	`ext4_jouº®_¡İ
(
hªdË
);

2801 ià(
wbc
->
¿nge_¡¬t
 =ğ0 && wbc->
¿nge_’d
 =ğ
LLONG_MAX
)

2802 
¿nge_whŞe
 = 1;

2804 ià(
wbc
->
¿nge_cyşic
) {

2805 
wr™eback_šdex
 = 
m­pšg
->writeback_index;

2806 ià(
wr™eback_šdex
)

2807 
cyşed
 = 0;

2808 
mpd
.
fœ¡_·ge
 = 
wr™eback_šdex
;

2809 
mpd
.
Ï¡_·ge
 = -1;

2811 
mpd
.
fœ¡_·ge
 = 
wbc
->
¿nge_¡¬t
 >> 
PAGE_SHIFT
;

2812 
mpd
.
Ï¡_·ge
 = 
wbc
->
¿nge_’d
 >> 
PAGE_SHIFT
;

2815 
mpd
.
šode
 = inode;

2816 
mpd
.
wbc
 = wbc;

2817 
	`ext4_io_subm™_š™
(&
mpd
.
io_subm™
, 
wbc
);

2818 
»Œy
:

2819 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 || wbc->
gged_wr™•ages
)

2820 
	`g_·ges_fÜ_wr™eback
(
m­pšg
, 
mpd
.
fœ¡_·ge
, mpd.
Ï¡_·ge
);

2821 
dÚe
 = 
çl£
;

2822 
	`blk_¡¬t_¶ug
(&
¶ug
);

2830 
mpd
.
do_m­
 = 0;

2831 
mpd
.
io_subm™
.
io_’d
 = 
	`ext4_š™_io_’d
(
šode
, 
GFP_KERNEL
);

2832 ià(!
mpd
.
io_subm™
.
io_’d
) {

2833 
»t
 = -
ENOMEM
;

2834 
uÅlug
;

2836 
»t
 = 
	`m·ge_´•¬e_ex‹Á_to_m­
(&
mpd
);

2838 
	`ext4_io_subm™
(&
mpd
.
io_subm™
);

2839 
	`ext4_put_io_’d_deãr
(
mpd
.
io_subm™
.
io_’d
);

2840 
mpd
.
io_subm™
.
io_’d
 = 
NULL
;

2842 
	`m·ge_»Ëa£_unu£d_·ges
(&
mpd
, 
çl£
);

2843 ià(
»t
 < 0)

2844 
uÅlug
;

2846 !
dÚe
 && 
mpd
.
fœ¡_·ge
 <ğmpd.
Ï¡_·ge
) {

2848 
mpd
.
io_subm™
.
io_’d
 = 
	`ext4_š™_io_’d
(
šode
, 
GFP_KERNEL
);

2849 ià(!
mpd
.
io_subm™
.
io_’d
) {

2850 
»t
 = -
ENOMEM
;

2861 
	`BUG_ON
(
	`ext4_should_jouº®_d©a
(
šode
));

2862 
Ãeded_blocks
 = 
	`ext4_da_wr™•ages_Œªs_blocks
(
šode
);

2865 
hªdË
 = 
	`ext4_jouº®_¡¬t_w™h_»£rve
(
šode
,

2866 
EXT4_HT_WRITE_PAGE
, 
Ãeded_blocks
, 
rsv_blocks
);

2867 ià(
	`IS_ERR
(
hªdË
)) {

2868 
»t
 = 
	`PTR_ERR
(
hªdË
);

2869 
	`ext4_msg
(
šode
->
i_sb
, 
KERN_CRIT
, "%s: jbd2_start: "

2870 "%ld…ages, inØ%lu;ƒ¼ %d", 
__func__
,

2871 
wbc
->
Ä_to_wr™e
, 
šode
->
i_šo
, 
»t
);

2873 
	`ext4_put_io_’d
(
mpd
.
io_subm™
.
io_’d
);

2874 
mpd
.
io_subm™
.
io_’d
 = 
NULL
;

2877 
mpd
.
do_m­
 = 1;

2879 
	`Œaû_ext4_da_wr™e_·ges
(
šode
, 
mpd
.
fœ¡_·ge
, mpd.
wbc
);

2880 
»t
 = 
	`m·ge_´•¬e_ex‹Á_to_m­
(&
mpd
);

2881 ià(!
»t
) {

2882 ià(
mpd
.
m­
.
m_Ën
)

2883 
»t
 = 
	`m·ge_m­_ªd_subm™_ex‹Á
(
hªdË
, &
mpd
,

2884 &
give_up_Ú_wr™e
);

2892 
dÚe
 = 
Œue
;

2905 ià(!
	`ext4_hªdË_v®id
(
hªdË
è|| hªdË->
h_sync
 == 0) {

2906 
	`ext4_jouº®_¡İ
(
hªdË
);

2907 
hªdË
 = 
NULL
;

2908 
mpd
.
do_m­
 = 0;

2911 
	`ext4_io_subm™
(&
mpd
.
io_subm™
);

2913 
	`m·ge_»Ëa£_unu£d_·ges
(&
mpd
, 
give_up_Ú_wr™e
);

2921 ià(
hªdË
) {

2922 
	`ext4_put_io_’d_deãr
(
mpd
.
io_subm™
.
io_’d
);

2923 
	`ext4_jouº®_¡İ
(
hªdË
);

2925 
	`ext4_put_io_’d
(
mpd
.
io_subm™
.
io_’d
);

2926 
mpd
.
io_subm™
.
io_’d
 = 
NULL
;

2928 ià(
»t
 =ğ-
ENOSPC
 && 
sbi
->
s_jouº®
) {

2934 
	`jbd2_jouº®_fÜû_comm™_Ã¡ed
(
sbi
->
s_jouº®
);

2935 
»t
 = 0;

2939 ià(
»t
)

2942 
uÅlug
:

2943 
	`blk_fšish_¶ug
(&
¶ug
);

2944 ià(!
»t
 && !
cyşed
 && 
wbc
->
Ä_to_wr™e
 > 0) {

2945 
cyşed
 = 1;

2946 
mpd
.
Ï¡_·ge
 = 
wr™eback_šdex
 - 1;

2947 
mpd
.
fœ¡_·ge
 = 0;

2948 
»Œy
;

2952 ià(
wbc
->
¿nge_cyşic
 || (
¿nge_whŞe
 && wbc->
Ä_to_wr™e
 > 0))

2957 
m­pšg
->
wr™eback_šdex
 = 
mpd
.
fœ¡_·ge
;

2959 
out_wr™•ages
:

2960 
	`Œaû_ext4_wr™•ages_»suÉ
(
šode
, 
wbc
, 
»t
,

2961 
Ä_to_wr™e
 - 
wbc
->nr_to_write);

2962 
	`ext4_fc_Œack_šode
(
šode
);

2963 
	`³rıu_up_»ad
(&
sbi
->
s_jouº®_æag_rw£m
);

2964  
»t
;

2965 
	}
}

2967 
	$ext4_nÚda_sw™ch
(
su³r_block
 *
sb
)

2969 
s64
 
ä“_şu¡”s
, 
dœty_şu¡”s
;

2970 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2980 
ä“_şu¡”s
 =

2981 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_ä“şu¡”s_couÁ”
);

2982 
dœty_şu¡”s
 =

2983 
	`³rıu_couÁ”_»ad_pos™ive
(&
sbi
->
s_dœtyşu¡”s_couÁ”
);

2987 ià(
dœty_şu¡”s
 && (
ä“_şu¡”s
 < 2 * dirty_clusters))

2988 
	`Œy_to_wr™eback_šodes_sb
(
sb
, 
WB_REASON_FS_FREE_SPACE
);

2990 ià(2 * 
ä“_şu¡”s
 < 3 * 
dœty_şu¡”s
 ||

2991 
ä“_şu¡”s
 < (
dœty_şu¡”s
 + 
EXT4_FREECLUSTERS_WATERMARK
)) {

2999 
	}
}

3002 
	$ext4_da_wr™e_üed™s
(
šode
 *šode, 
loff_t
 
pos
, 
Ën
)

3004 ià(
	`lik–y
(
	`ext4_has_ã©u»_Ïrge_fe
(
šode
->
i_sb
)))

3007 ià(
pos
 + 
Ën
 <= 0x7fffffffULL)

3012 
	}
}

3014 
	$ext4_da_wr™e_begš
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
,

3015 
loff_t
 
pos
, 
Ën
, 
æags
,

3016 
·ge
 **
·g•
, **
fsd©a
)

3018 
»t
, 
»Œ›s
 = 0;

3019 
·ge
 *page;

3020 
pgoff_t
 
šdex
;

3021 
šode
 *šodğ
m­pšg
->
ho¡
;

3022 
hªdË_t
 *
hªdË
;

3024 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

3025  -
EIO
;

3027 
šdex
 = 
pos
 >> 
PAGE_SHIFT
;

3029 ià(
	`ext4_nÚda_sw™ch
(
šode
->
i_sb
) ||

3030 
	`S_ISLNK
(
šode
->
i_mode
)) {

3031 *
fsd©a
 = (*)
FALL_BACK_TO_NONDELALLOC
;

3032  
	`ext4_wr™e_begš
(
fe
, 
m­pšg
, 
pos
,

3033 
Ën
, 
æags
, 
·g•
, 
fsd©a
);

3035 *
fsd©a
 = (*)0;

3036 
	`Œaû_ext4_da_wr™e_begš
(
šode
, 
pos
, 
Ën
, 
æags
);

3038 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
)) {

3039 
»t
 = 
	`ext4_da_wr™e_šlše_d©a_begš
(
m­pšg
, 
šode
,

3040 
pos
, 
Ën
, 
æags
,

3041 
·g•
, 
fsd©a
);

3042 ià(
»t
 < 0)

3043  
»t
;

3044 ià(
»t
 == 1)

3055 
»Œy_g¿b
:

3056 
·ge
 = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
, 
šdex
, 
æags
);

3057 ià(!
·ge
)

3058  -
ENOMEM
;

3059 
	`uÆock_·ge
(
·ge
);

3067 
»Œy_jouº®
:

3068 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
,

3069 
	`ext4_da_wr™e_üed™s
(
šode
, 
pos
, 
Ën
));

3070 ià(
	`IS_ERR
(
hªdË
)) {

3071 
	`put_·ge
(
·ge
);

3072  
	`PTR_ERR
(
hªdË
);

3075 
	`lock_·ge
(
·ge
);

3076 ià(
·ge
->
m­pšg
 != mapping) {

3078 
	`uÆock_·ge
(
·ge
);

3079 
	`put_·ge
(
·ge
);

3080 
	`ext4_jouº®_¡İ
(
hªdË
);

3081 
»Œy_g¿b
;

3084 
	`wa™_fÜ_¡abË_·ge
(
·ge
);

3086 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


3087 
»t
 = 
	`ext4_block_wr™e_begš
(
·ge
, 
pos
, 
Ën
,

3088 
ext4_da_g‘_block_´•
);

3090 
»t
 = 
	`__block_wr™e_begš
(
·ge
, 
pos
, 
Ën
, 
ext4_da_g‘_block_´•
);

3092 ià(
»t
 < 0) {

3093 
	`uÆock_·ge
(
·ge
);

3094 
	`ext4_jouº®_¡İ
(
hªdË
);

3100 ià(
pos
 + 
Ën
 > 
šode
->
i_size
)

3101 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

3103 ià(
»t
 =ğ-
ENOSPC
 &&

3104 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

3105 
»Œy_jouº®
;

3107 
	`put_·ge
(
·ge
);

3108  
»t
;

3111 *
·g•
 = 
·ge
;

3112  
»t
;

3113 
	}
}

3119 
	$ext4_da_should_upd©e_i_disksize
(
·ge
 *page,

3120 
off£t
)

3122 
bufãr_h—d
 *
bh
;

3123 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

3124 
idx
;

3125 
i
;

3127 
bh
 = 
	`·ge_bufãrs
(
·ge
);

3128 
idx
 = 
off£t
 >> 
šode
->
i_blkb™s
;

3130 
i
 = 0; i < 
idx
; i++)

3131 
bh
 = bh->
b_this_·ge
;

3133 ià(!
	`bufãr_m­³d
(
bh
è|| (
	`bufãr_d–ay
(bh)è|| 
	`bufãr_unwr™‹n
(bh))

3136 
	}
}

3138 
	$ext4_da_wr™e_’d
(
fe
 *file,

3139 
add»ss_¥aû
 *
m­pšg
,

3140 
loff_t
 
pos
, 
Ën
, 
cİ›d
,

3141 
·ge
 *·ge, *
fsd©a
)

3143 
šode
 *šodğ
m­pšg
->
ho¡
;

3144 
»t
 = 0, 
»t2
;

3145 
hªdË_t
 *
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

3146 
loff_t
 
Ãw_i_size
;

3147 
¡¬t
, 
’d
;

3148 
wr™e_mode
 = ()()
fsd©a
;

3150 ià(
wr™e_mode
 =ğ
FALL_BACK_TO_NONDELALLOC
)

3151  
	`ext4_wr™e_’d
(
fe
, 
m­pšg
, 
pos
,

3152 
Ën
, 
cİ›d
, 
·ge
, 
fsd©a
);

3154 
	`Œaû_ext4_da_wr™e_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
);

3155 
¡¬t
 = 
pos
 & (
PAGE_SIZE
 - 1);

3156 
’d
 = 
¡¬t
 + 
cİ›d
 - 1;

3163 
Ãw_i_size
 = 
pos
 + 
cİ›d
;

3164 ià(
cİ›d
 && 
Ãw_i_size
 > 
	`EXT4_I
(
šode
)->
i_disksize
) {

3165 ià(
	`ext4_has_šlše_d©a
(
šode
) ||

3166 
	`ext4_da_should_upd©e_i_disksize
(
·ge
, 
’d
)) {

3167 
	`ext4_upd©e_i_disksize
(
šode
, 
Ãw_i_size
);

3172 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3176 ià(
wr™e_mode
 !ğ
CONVERT_INLINE_DATA
 &&

3177 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
) &&

3178 
	`ext4_has_šlše_d©a
(
šode
))

3179 
»t2
 = 
	`ext4_da_wr™e_šlše_d©a_’d
(
šode
, 
pos
, 
Ën
, 
cİ›d
,

3180 
·ge
);

3182 
»t2
 = 
	`g’”ic_wr™e_’d
(
fe
, 
m­pšg
, 
pos
, 
Ën
, 
cİ›d
,

3183 
·ge
, 
fsd©a
);

3185 
cİ›d
 = 
»t2
;

3186 ià(
»t2
 < 0)

3187 
»t
 = 
»t2
;

3188 
»t2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

3189 ià(!
»t
)

3190 
»t
 = 
»t2
;

3192  
»t
 ?„‘ : 
cİ›d
;

3193 
	}
}

3195 
	$ext4_da_šv®id©•age
(
·ge
 *·ge, 
off£t
,

3196 
Ëngth
)

3201 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

3202 ià(!
	`·ge_has_bufãrs
(
·ge
))

3203 
out
;

3205 
	`ext4_da_·ge_»Ëa£_»£rv©iÚ
(
·ge
, 
off£t
, 
Ëngth
);

3207 
out
:

3208 
	`ext4_šv®id©•age
(
·ge
, 
off£t
, 
Ëngth
);

3211 
	}
}

3216 
	$ext4_®loc_da_blocks
(
šode
 *inode)

3218 
	`Œaû_ext4_®loc_da_blocks
(
šode
);

3220 ià(!
	`EXT4_I
(
šode
)->
i_»£rved_d©a_blocks
)

3254  
	`fem­_æush
(
šode
->
i_m­pšg
);

3255 
	}
}

3271 
£ùÜ_t
 
	$ext4_bm­
(
add»ss_¥aû
 *
m­pšg
, 
£ùÜ_t
 
block
)

3273 
šode
 *šodğ
m­pšg
->
ho¡
;

3274 
jouº®_t
 *
jouº®
;

3275 
”r
;

3280 ià(
	`ext4_has_šlše_d©a
(
šode
))

3283 ià(
	`m­pšg_gged
(
m­pšg
, 
PAGECACHE_TAG_DIRTY
) &&

3284 
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
)) {

3290 
	`fem­_wr™e_ªd_wa™
(
m­pšg
);

3293 ià(
	`EXT4_JOURNAL
(
šode
) &&

3294 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
)) {

3313 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
);

3314 
jouº®
 = 
	`EXT4_JOURNAL
(
šode
);

3315 
	`jbd2_jouº®_lock_upd©es
(
jouº®
);

3316 
”r
 = 
	`jbd2_jouº®_æush
(
jouº®
);

3317 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

3319 ià(
”r
)

3323  
	`g’”ic_block_bm­
(
m­pšg
, 
block
, 
ext4_g‘_block
);

3324 
	}
}

3326 
	$ext4_»ad·ge
(
fe
 *fe, 
·ge
 *page)

3328 
»t
 = -
EAGAIN
;

3329 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

3331 
	`Œaû_ext4_»ad·ge
(
·ge
);

3333 ià(
	`ext4_has_šlše_d©a
(
šode
))

3334 
»t
 = 
	`ext4_»ad·ge_šlše
(
šode
, 
·ge
);

3336 ià(
»t
 =ğ-
EAGAIN
)

3337  
	`ext4_m·ge_»ad·ges
(
·ge
->
m­pšg
, 
NULL
,…age, 1);

3339  
»t
;

3340 
	}
}

3343 
	$ext4_»ad·ges
(
fe
 *fe, 
add»ss_¥aû
 *
m­pšg
,

3344 
li¡_h—d
 *
·ges
, 
Ä_·ges
)

3346 
šode
 *šodğ
m­pšg
->
ho¡
;

3349 ià(
	`ext4_has_šlše_d©a
(
šode
))

3352  
	`ext4_m·ge_»ad·ges
(
m­pšg
, 
·ges
, 
NULL
, 
Ä_·ges
);

3353 
	}
}

3355 
	$ext4_šv®id©•age
(
·ge
 *·ge, 
off£t
,

3356 
Ëngth
)

3358 
	`Œaû_ext4_šv®id©•age
(
·ge
, 
off£t
, 
Ëngth
);

3361 
	`WARN_ON
(
	`·ge_has_bufãrs
(
·ge
è&& 
	`bufãr_jbd
(
	`·ge_bufãrs
(page)));

3363 
	`block_šv®id©•age
(
·ge
, 
off£t
, 
Ëngth
);

3364 
	}
}

3366 
	$__ext4_jouº®Ëd_šv®id©•age
(
·ge
 *page,

3367 
off£t
,

3368 
Ëngth
)

3370 
jouº®_t
 *
jouº®
 = 
	`EXT4_JOURNAL
(
·ge
->
m­pšg
->
ho¡
);

3372 
	`Œaû_ext4_jouº®Ëd_šv®id©•age
(
·ge
, 
off£t
, 
Ëngth
);

3377 ià(
off£t
 =ğ0 && 
Ëngth
 =ğ
PAGE_SIZE
)

3378 
	`CË¬PageChecked
(
·ge
);

3380  
	`jbd2_jouº®_šv®id©•age
(
jouº®
, 
·ge
, 
off£t
, 
Ëngth
);

3381 
	}
}

3384 
	$ext4_jouº®Ëd_šv®id©•age
(
·ge
 *page,

3385 
off£t
,

3386 
Ëngth
)

3388 
	`WARN_ON
(
	`__ext4_jouº®Ëd_šv®id©•age
(
·ge
, 
off£t
, 
Ëngth
) < 0);

3389 
	}
}

3391 
	$ext4_»Ëa£·ge
(
·ge
 *·ge, 
gå_t
 
wa™
)

3393 
jouº®_t
 *
jouº®
 = 
	`EXT4_JOURNAL
(
·ge
->
m­pšg
->
ho¡
);

3395 
	`Œaû_ext4_»Ëa£·ge
(
·ge
);

3398 ià(
	`PageChecked
(
·ge
))

3400 ià(
jouº®
)

3401  
	`jbd2_jouº®_Œy_to_ä“_bufãrs
(
jouº®
, 
·ge
, 
wa™
);

3403  
	`Œy_to_ä“_bufãrs
(
·ge
);

3404 
	}
}

3406 #ifdeà
CONFIG_FS_DAX


3407 
	$ext4_iom­_begš
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
,

3408 
æags
, 
iom­
 *iomap)

3410 
block_deviû
 *
bdev
;

3411 
blkb™s
 = 
šode
->
i_blkb™s
;

3412 
fœ¡_block
 = 
off£t
 >> 
blkb™s
;

3413 
Ï¡_block
 = (
off£t
 + 
Ëngth
 - 1è>> 
blkb™s
;

3414 
ext4_m­_blocks
 
m­
;

3415 
»t
;

3417 ià(
	`WARN_ON_ONCE
(
	`ext4_has_šlše_d©a
(
šode
)))

3418  -
ERANGE
;

3420 
m­
.
m_lblk
 = 
fœ¡_block
;

3421 
m­
.
m_Ën
 = 
Ï¡_block
 - 
fœ¡_block
 + 1;

3423 ià(!(
æags
 & 
IOMAP_WRITE
)) {

3424 
»t
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

3426 
dio_üed™s
;

3427 
hªdË_t
 *
hªdË
;

3428 
»Œ›s
 = 0;

3431 ià(
m­
.
m_Ën
 > 
DIO_MAX_BLOCKS
)

3432 
m­
.
m_Ën
 = 
DIO_MAX_BLOCKS
;

3433 
dio_üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
šode
, 
m­
.
m_Ën
);

3434 
»Œy
:

3441 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MAP_BLOCKS
,

3442 
dio_üed™s
);

3443 ià(
	`IS_ERR
(
hªdË
))

3444  
	`PTR_ERR
(
hªdË
);

3446 
»t
 = 
	`ext4_m­_blocks
(
hªdË
, 
šode
, &
m­
,

3447 
EXT4_GET_BLOCKS_CREATE_ZERO
);

3448 ià(
»t
 < 0) {

3449 
	`ext4_jouº®_¡İ
(
hªdË
);

3450 ià(
»t
 =ğ-
ENOSPC
 &&

3451 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

3452 
»Œy
;

3453  
»t
;

3465 ià(!(
æags
 & 
IOMAP_FAULT
è&& 
fœ¡_block
 + 
m­
.
m_Ën
 >

3466 (
	`i_size_»ad
(
šode
è+ (1 << 
blkb™s
) - 1) >> blkbits) {

3467 
”r
;

3469 
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

3470 ià(
”r
 < 0) {

3471 
	`ext4_jouº®_¡İ
(
hªdË
);

3472  
”r
;

3475 
	`ext4_jouº®_¡İ
(
hªdË
);

3478 
iom­
->
æags
 = 0;

3479 
bdev
 = 
šode
->
i_sb
->
s_bdev
;

3480 
iom­
->
bdev
 = bdev;

3481 ià(
	`blk_queue_dax
(
bdev
->
bd_queue
))

3482 
iom­
->
dax_dev
 = 
	`fs_dax_g‘_by_ho¡
(
bdev
->
bd_disk
->
disk_Çme
);

3484 
iom­
->
dax_dev
 = 
NULL
;

3485 
iom­
->
off£t
 = 
fœ¡_block
 << 
blkb™s
;

3487 ià(
»t
 == 0) {

3488 
iom­
->
ty³
 = 
IOMAP_HOLE
;

3489 
iom­
->
blkno
 = 
IOMAP_NULL_BLOCK
;

3490 
iom­
->
Ëngth
 = (
u64
)
m­
.
m_Ën
 << 
blkb™s
;

3492 ià(
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
) {

3493 
iom­
->
ty³
 = 
IOMAP_MAPPED
;

3494 } ià(
m­
.
m_æags
 & 
EXT4_MAP_UNWRITTEN
) {

3495 
iom­
->
ty³
 = 
IOMAP_UNWRITTEN
;

3497 
	`WARN_ON_ONCE
(1);

3498  -
EIO
;

3500 
iom­
->
blkno
 = (
£ùÜ_t
)
m­
.
m_pblk
 << (
blkb™s
 - 9);

3501 
iom­
->
Ëngth
 = (
u64
)
m­
.
m_Ën
 << 
blkb™s
;

3508 ià(
m­
.
m_æags
 & 
EXT4_MAP_NEW
)

3509 
iom­
->
æags
 |ğ
IOMAP_F_NEW
;

3511 
	}
}

3513 
	$ext4_iom­_’d
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
,

3514 
ssize_t
 
wr™‹n
, 
æags
, 
iom­
 *iomap)

3516 
»t
 = 0;

3517 
hªdË_t
 *
hªdË
;

3518 
blkb™s
 = 
šode
->
i_blkb™s
;

3519 
boŞ
 
Œunÿ‹
 = 
çl£
;

3521 
	`fs_put_dax
(
iom­
->
dax_dev
);

3522 ià(!(
æags
 & 
IOMAP_WRITE
è|| (æag & 
IOMAP_FAULT
))

3525 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 2);

3526 ià(
	`IS_ERR
(
hªdË
)) {

3527 
»t
 = 
	`PTR_ERR
(
hªdË
);

3528 
Üphª_d–
;

3530 ià(
	`ext4_upd©e_šode_size
(
šode
, 
off£t
 + 
wr™‹n
))

3531 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3535 ià(
iom­
->
off£t
 + iom­->
Ëngth
 >

3536 
	`ALIGN
(
šode
->
i_size
, 1 << 
blkb™s
)) {

3537 
ext4_lblk_t
 
wr™‹n_blk
, 
’d_blk
;

3539 
wr™‹n_blk
 = (
off£t
 + 
wr™‹n
è>> 
blkb™s
;

3540 
’d_blk
 = (
off£t
 + 
Ëngth
è>> 
blkb™s
;

3541 ià(
wr™‹n_blk
 < 
’d_blk
 && 
	`ext4_ÿn_Œunÿ‹
(
šode
))

3542 
Œunÿ‹
 = 
Œue
;

3548 ià(!
Œunÿ‹
 && 
šode
->
i_Æšk
 &&

3549 !
	`li¡_em±y
(&
	`EXT4_I
(
šode
)->
i_Üphª
))

3550 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

3551 
	`ext4_jouº®_¡İ
(
hªdË
);

3552 ià(
Œunÿ‹
) {

3553 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

3554 
Üphª_d–
:

3560 ià(
šode
->
i_Æšk
)

3561 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

3563  
»t
;

3564 
	}
}

3566 cÚ¡ 
iom­_İs
 
	gext4_iom­_İs
 = {

3567 .
iom­_begš
 = 
ext4_iom­_begš
,

3568 .
	giom­_’d
 = 
ext4_iom­_’d
,

3573 
	$ext4_’d_io_dio
(
kiocb
 *
iocb
, 
loff_t
 
off£t
,

3574 
ssize_t
 
size
, *
´iv©e
)

3576 
ext4_io_’d_t
 *
io_’d
 = 
´iv©e
;

3579 ià(!
io_’d
)

3582 
	`ext_debug
("ext4_end_io_dio(): io_end 0x%p "

3584 
io_’d
, io_’d->
šode
->
i_šo
, 
iocb
, 
off£t
, 
size
);

3590 ià(
size
 <= 0) {

3591 
	`ext4_ş—r_io_unwr™‹n_æag
(
io_’d
);

3592 
size
 = 0;

3594 
io_’d
->
off£t
 = offset;

3595 
io_’d
->
size
 = size;

3596 
	`ext4_put_io_’d
(
io_’d
);

3599 
	}
}

3622 
ssize_t
 
	$ext4_dœeù_IO_wr™e
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

3624 
fe
 *fğ
iocb
->
ki_fp
;

3625 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

3626 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

3627 
ssize_t
 
»t
;

3628 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3629 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

3630 
ov”wr™e
 = 0;

3631 
g‘_block_t
 *
g‘_block_func
 = 
NULL
;

3632 
dio_æags
 = 0;

3633 
loff_t
 
fš®_size
 = 
off£t
 + 
couÁ
;

3634 
Üphª
 = 0;

3635 
hªdË_t
 *
hªdË
;

3637 ià(
fš®_size
 > 
šode
->
i_size
) {

3639 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 2);

3640 ià(
	`IS_ERR
(
hªdË
)) {

3641 
»t
 = 
	`PTR_ERR
(
hªdË
);

3642 
out
;

3644 
»t
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

3645 ià(
»t
) {

3646 
	`ext4_jouº®_¡İ
(
hªdË
);

3647 
out
;

3649 
Üphª
 = 1;

3650 
ei
->
i_disksize
 = 
šode
->
i_size
;

3651 
	`ext4_jouº®_¡İ
(
hªdË
);

3654 
	`BUG_ON
(
iocb
->
´iv©e
 =ğ
NULL
);

3661 
	`šode_dio_begš
(
šode
);

3664 
ov”wr™e
 = *((*)
iocb
->
´iv©e
);

3666 ià(
ov”wr™e
)

3667 
	`šode_uÆock
(
šode
);

3689 
iocb
->
´iv©e
 = 
NULL
;

3690 ià(
ov”wr™e
)

3691 
g‘_block_func
 = 
ext4_dio_g‘_block_ov”wr™e
;

3692 ià(!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
) ||

3693 
	`round_down
(
off£t
, 
	`i_blocksize
(
šode
)è>ğšode->
i_size
) {

3694 
g‘_block_func
 = 
ext4_dio_g‘_block
;

3695 
dio_æags
 = 
DIO_LOCKING
 | 
DIO_SKIP_HOLES
;

3696 } ià(
	`is_sync_kiocb
(
iocb
)) {

3697 
g‘_block_func
 = 
ext4_dio_g‘_block_unwr™‹n_sync
;

3698 
dio_æags
 = 
DIO_LOCKING
;

3700 
g‘_block_func
 = 
ext4_dio_g‘_block_unwr™‹n_async
;

3701 
dio_æags
 = 
DIO_LOCKING
;

3703 
»t
 = 
	`__blockdev_dœeù_IO
(
iocb
, 
šode
, inode->
i_sb
->
s_bdev
, 
™”
,

3704 
g‘_block_func
, 
ext4_’d_io_dio
, 
NULL
,

3705 
dio_æags
);

3707 ià(
»t
 > 0 && !
ov”wr™e
 && 
	`ext4_‹¡_šode_¡©e
(
šode
,

3708 
EXT4_STATE_DIO_UNWRITTEN
)) {

3709 
”r
;

3714 
”r
 = 
	`ext4_cÚv”t_unwr™‹n_ex‹Ás
(
NULL
, 
šode
,

3715 
off£t
, 
»t
);

3716 ià(
”r
 < 0)

3717 
»t
 = 
”r
;

3718 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_DIO_UNWRITTEN
);

3721 
	`šode_dio_’d
(
šode
);

3723 ià(
ov”wr™e
)

3724 
	`šode_lock
(
šode
);

3726 ià(
»t
 < 0 && 
fš®_size
 > 
šode
->
i_size
)

3727 
	`ext4_Œunÿ‹_çed_wr™e
(
šode
);

3730 ià(
Üphª
) {

3731 
”r
;

3734 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 2);

3735 ià(
	`IS_ERR
(
hªdË
)) {

3739 
»t
 = 
	`PTR_ERR
(
hªdË
);

3740 ià(
šode
->
i_Æšk
)

3741 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

3743 
out
;

3745 ià(
šode
->
i_Æšk
)

3746 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

3747 ià(
»t
 > 0) {

3748 
loff_t
 
’d
 = 
off£t
 + 
»t
;

3749 ià(
’d
 > 
šode
->
i_size
) {

3750 
ei
->
i_disksize
 = 
’d
;

3751 
	`i_size_wr™e
(
šode
, 
’d
);

3759 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3762 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

3763 ià(
»t
 == 0)

3764 
»t
 = 
”r
;

3766 
out
:

3767  
»t
;

3768 
	}
}

3770 
ssize_t
 
	$ext4_dœeù_IO_»ad
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

3772 
add»ss_¥aû
 *
m­pšg
 = 
iocb
->
ki_fp
->
f_m­pšg
;

3773 
šode
 *šodğ
m­pšg
->
ho¡
;

3774 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

3775 
ssize_t
 
»t
;

3782 
	`šode_lock_sh¬ed
(
šode
);

3783 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
m­pšg
, 
iocb
->
ki_pos
,

3784 
iocb
->
ki_pos
 + 
couÁ
 - 1);

3785 ià(
»t
)

3786 
out_uÆock
;

3787 
»t
 = 
	`__blockdev_dœeù_IO
(
iocb
, 
šode
, inode->
i_sb
->
s_bdev
,

3788 
™”
, 
ext4_dio_g‘_block
, 
NULL
, NULL, 0);

3789 
out_uÆock
:

3790 
	`šode_uÆock_sh¬ed
(
šode
);

3791  
»t
;

3792 
	}
}

3794 
ssize_t
 
	$ext4_dœeù_IO
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

3796 
fe
 *fğ
iocb
->
ki_fp
;

3797 
šode
 *šodğ
fe
->
f_m­pšg
->
ho¡
;

3798 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

3799 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3800 
ssize_t
 
»t
;

3802 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


3803 ià(
	`ext4_’üy±ed_šode
(
šode
è&& 
	`S_ISREG
(šode->
i_mode
))

3810 ià(
	`ext4_should_jouº®_d©a
(
šode
))

3814 ià(
	`ext4_has_šlše_d©a
(
šode
))

3818 ià(
	`WARN_ON_ONCE
(
	`IS_DAX
(
šode
)))

3821 
	`Œaû_ext4_dœeù_IO_’‹r
(
šode
, 
off£t
, 
couÁ
, 
	`iov_™”_rw
(
™”
));

3822 ià(
	`iov_™”_rw
(
™”
è=ğ
READ
)

3823 
»t
 = 
	`ext4_dœeù_IO_»ad
(
iocb
, 
™”
);

3825 
»t
 = 
	`ext4_dœeù_IO_wr™e
(
iocb
, 
™”
);

3826 
	`Œaû_ext4_dœeù_IO_ex™
(
šode
, 
off£t
, 
couÁ
, 
	`iov_™”_rw
(
™”
), 
»t
);

3827  
»t
;

3828 
	}
}

3843 
	$ext4_jouº®Ëd_£t_·ge_dœty
(
·ge
 *page)

3845 
	`S‘PageChecked
(
·ge
);

3846  
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

3847 
	}
}

3849 
	$ext4_£t_·ge_dœty
(
·ge
 *page)

3851 
	`WARN_ON_ONCE
(!
	`PageLocked
(
·ge
è&& !
	`PageDœty
(page));

3852 
	`WARN_ON_ONCE
(!
	`·ge_has_bufãrs
(
·ge
));

3853  
	`__£t_·ge_dœty_bufãrs
(
·ge
);

3854 
	}
}

3856 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gext4_aİs
 = {

3857 .
»ad·ge
 = 
ext4_»ad·ge
,

3858 .
	g»ad·ges
 = 
ext4_»ad·ges
,

3859 .
	gwr™•age
 = 
ext4_wr™•age
,

3860 .
	gwr™•ages
 = 
ext4_wr™•ages
,

3861 .
	gwr™e_begš
 = 
ext4_wr™e_begš
,

3862 .
	gwr™e_’d
 = 
ext4_wr™e_’d
,

3863 .
	g£t_·ge_dœty
 = 
ext4_£t_·ge_dœty
,

3864 .
	gbm­
 = 
ext4_bm­
,

3865 .
	gšv®id©•age
 = 
ext4_šv®id©•age
,

3866 .
	g»Ëa£·ge
 = 
ext4_»Ëa£·ge
,

3867 .
	gdœeù_IO
 = 
ext4_dœeù_IO
,

3868 .
	gmig¿‹·ge
 = 
bufãr_mig¿‹_·ge
,

3869 .
	gis_·¹ŸÎy_u±od©e
 = 
block_is_·¹ŸÎy_u±od©e
,

3870 .
	g”rÜ_»move_·ge
 = 
g’”ic_”rÜ_»move_·ge
,

3873 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gext4_jouº®Ëd_aİs
 = {

3874 .
»ad·ge
 = 
ext4_»ad·ge
,

3875 .
	g»ad·ges
 = 
ext4_»ad·ges
,

3876 .
	gwr™•age
 = 
ext4_wr™•age
,

3877 .
	gwr™•ages
 = 
ext4_wr™•ages
,

3878 .
	gwr™e_begš
 = 
ext4_wr™e_begš
,

3879 .
	gwr™e_’d
 = 
ext4_jouº®Ëd_wr™e_’d
,

3880 .
	g£t_·ge_dœty
 = 
ext4_jouº®Ëd_£t_·ge_dœty
,

3881 .
	gbm­
 = 
ext4_bm­
,

3882 .
	gšv®id©•age
 = 
ext4_jouº®Ëd_šv®id©•age
,

3883 .
	g»Ëa£·ge
 = 
ext4_»Ëa£·ge
,

3884 .
	gdœeù_IO
 = 
ext4_dœeù_IO
,

3885 .
	gis_·¹ŸÎy_u±od©e
 = 
block_is_·¹ŸÎy_u±od©e
,

3886 .
	g”rÜ_»move_·ge
 = 
g’”ic_”rÜ_»move_·ge
,

3889 cÚ¡ 
add»ss_¥aû_İ”©iÚs
 
	gext4_da_aİs
 = {

3890 .
»ad·ge
 = 
ext4_»ad·ge
,

3891 .
	g»ad·ges
 = 
ext4_»ad·ges
,

3892 .
	gwr™•age
 = 
ext4_wr™•age
,

3893 .
	gwr™•ages
 = 
ext4_wr™•ages
,

3894 .
	gwr™e_begš
 = 
ext4_da_wr™e_begš
,

3895 .
	gwr™e_’d
 = 
ext4_da_wr™e_’d
,

3896 .
	g£t_·ge_dœty
 = 
ext4_£t_·ge_dœty
,

3897 .
	gbm­
 = 
ext4_bm­
,

3898 .
	gšv®id©•age
 = 
ext4_da_šv®id©•age
,

3899 .
	g»Ëa£·ge
 = 
ext4_»Ëa£·ge
,

3900 .
	gdœeù_IO
 = 
ext4_dœeù_IO
,

3901 .
	gmig¿‹·ge
 = 
bufãr_mig¿‹_·ge
,

3902 .
	gis_·¹ŸÎy_u±od©e
 = 
block_is_·¹ŸÎy_u±od©e
,

3903 .
	g”rÜ_»move_·ge
 = 
g’”ic_”rÜ_»move_·ge
,

3906 
	$ext4_£t_aİs
(
šode
 *inode)

3908 
	`ext4_šode_jouº®_mode
(
šode
)) {

3909 
EXT4_INODE_ORDERED_DATA_MODE
:

3910 
EXT4_INODE_WRITEBACK_DATA_MODE
:

3912 
EXT4_INODE_JOURNAL_DATA_MODE
:

3913 
šode
->
i_m­pšg
->
a_İs
 = &
ext4_jouº®Ëd_aİs
;

3916 
	`BUG
();

3918 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
))

3919 
šode
->
i_m­pšg
->
a_İs
 = &
ext4_da_aİs
;

3921 
šode
->
i_m­pšg
->
a_İs
 = &
ext4_aİs
;

3922 
	}
}

3924 
	$__ext4_block_z”o_·ge_¿nge
(
hªdË_t
 *
hªdË
,

3925 
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
äom
,†off_ˆ
Ëngth
)

3927 
ext4_fsblk_t
 
šdex
 = 
äom
 >> 
PAGE_SHIFT
;

3928 
off£t
 = 
äom
 & (
PAGE_SIZE
-1);

3929 
blocksize
, 
pos
;

3930 
ext4_lblk_t
 
iblock
;

3931 
šode
 *šodğ
m­pšg
->
ho¡
;

3932 
bufãr_h—d
 *
bh
;

3933 
·ge
 *page;

3934 
”r
 = 0;

3936 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
m­pšg
, 
äom
 >> 
PAGE_SHIFT
,

3937 
	`m­pšg_gå_cÚ¡¿št
(
m­pšg
, ~
__GFP_FS
));

3938 ià(!
·ge
)

3939  -
ENOMEM
;

3941 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

3943 
iblock
 = 
šdex
 << (
PAGE_SHIFT
 - 
šode
->
i_sb
->
s_blocksize_b™s
);

3945 ià(!
	`·ge_has_bufãrs
(
·ge
))

3946 
	`ü—‹_em±y_bufãrs
(
·ge
, 
blocksize
, 0);

3949 
bh
 = 
	`·ge_bufãrs
(
·ge
);

3950 
pos
 = 
blocksize
;

3951 
off£t
 >ğ
pos
) {

3952 
bh
 = bh->
b_this_·ge
;

3953 
iblock
++;

3954 
pos
 +ğ
blocksize
;

3956 ià(
	`bufãr_ä“d
(
bh
)) {

3957 
	`BUFFER_TRACE
(
bh
, "freed: skip");

3958 
uÆock
;

3960 ià(!
	`bufãr_m­³d
(
bh
)) {

3961 
	`BUFFER_TRACE
(
bh
, "unmapped");

3962 
	`ext4_g‘_block
(
šode
, 
iblock
, 
bh
, 0);

3964 ià(!
	`bufãr_m­³d
(
bh
)) {

3965 
	`BUFFER_TRACE
(
bh
, "still unmapped");

3966 
uÆock
;

3971 ià(
	`PageU±od©e
(
·ge
))

3972 
	`£t_bufãr_u±od©e
(
bh
);

3974 ià(!
	`bufãr_u±od©e
(
bh
)) {

3975 
”r
 = -
EIO
;

3976 
	`Î_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

3977 
	`wa™_Ú_bufãr
(
bh
);

3979 ià(!
	`bufãr_u±od©e
(
bh
))

3980 
uÆock
;

3981 ià(
	`S_ISREG
(
šode
->
i_mode
) &&

3982 
	`ext4_’üy±ed_šode
(
šode
)) {

3984 
	`BUG_ON
(!
	`fsüy±_has_’üy±iÚ_key
(
šode
));

3985 
	`BUG_ON
(
blocksize
 !ğ
PAGE_SIZE
);

3986 
	`WARN_ON_ONCE
(
	`fsüy±_deüy±_·ge
(
·ge
->
m­pšg
->
ho¡
,

3987 
·ge
, 
PAGE_SIZE
, 0,…age->
šdex
));

3990 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

3991 
	`BUFFER_TRACE
(
bh
, "get write‡ccess");

3992 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

3993 ià(
”r
)

3994 
uÆock
;

3996 
	`z”o_u£r
(
·ge
, 
off£t
, 
Ëngth
);

3997 
	`BUFFER_TRACE
(
bh
, "zeroedƒnd of block");

3999 ià(
	`ext4_should_jouº®_d©a
(
šode
)) {

4000 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

4002 
”r
 = 0;

4003 
	`m¬k_bufãr_dœty
(
bh
);

4004 ià(
	`ext4_should_Üd”_d©a
(
šode
))

4005 
”r
 = 
	`ext4_jbd2_šode_add_wr™e
(
hªdË
, 
šode
);

4008 
uÆock
:

4009 
	`uÆock_·ge
(
·ge
);

4010 
	`put_·ge
(
·ge
);

4011  
”r
;

4012 
	}
}

4021 
	$ext4_block_z”o_·ge_¿nge
(
hªdË_t
 *
hªdË
,

4022 
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
äom
,†off_ˆ
Ëngth
)

4024 
šode
 *šodğ
m­pšg
->
ho¡
;

4025 
off£t
 = 
äom
 & (
PAGE_SIZE
-1);

4026 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

4027 
max
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4033 ià(
Ëngth
 > 
max
 ||†ength < 0)

4034 
Ëngth
 = 
max
;

4036 ià(
	`IS_DAX
(
šode
)) {

4037  
	`iom­_z”o_¿nge
(
šode
, 
äom
, 
Ëngth
, 
NULL
,

4038 &
ext4_iom­_İs
);

4040  
	`__ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
, 
äom
, 
Ëngth
);

4041 
	}
}

4049 
	$ext4_block_Œunÿ‹_·ge
(
hªdË_t
 *
hªdË
,

4050 
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
äom
)

4052 
off£t
 = 
äom
 & (
PAGE_SIZE
-1);

4053 
Ëngth
;

4054 
blocksize
;

4055 
šode
 *šodğ
m­pšg
->
ho¡
;

4058 ià(
	`ext4_’üy±ed_šode
(
šode
è&& !
	`fsüy±_has_’üy±iÚ_key
(inode))

4061 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

4062 
Ëngth
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4064  
	`ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
, 
äom
, 
Ëngth
);

4065 
	}
}

4067 
	$ext4_z”o_·¹Ÿl_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4068 
loff_t
 
l¡¬t
,†off_ˆ
Ëngth
)

4070 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4071 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

4072 
·¹Ÿl_¡¬t
, 
·¹Ÿl_’d
;

4073 
ext4_fsblk_t
 
¡¬t
, 
’d
;

4074 
loff_t
 
by‹_’d
 = (
l¡¬t
 + 
Ëngth
 - 1);

4075 
”r
 = 0;

4077 
·¹Ÿl_¡¬t
 = 
l¡¬t
 & (
sb
->
s_blocksize
 - 1);

4078 
·¹Ÿl_’d
 = 
by‹_’d
 & (
sb
->
s_blocksize
 - 1);

4080 
¡¬t
 = 
l¡¬t
 >> 
sb
->
s_blocksize_b™s
;

4081 
’d
 = 
by‹_’d
 >> 
sb
->
s_blocksize_b™s
;

4084 ià(
¡¬t
 =ğ
’d
 &&

4085 (
·¹Ÿl_¡¬t
 || (
·¹Ÿl_’d
 !ğ
sb
->
s_blocksize
 - 1))) {

4086 
”r
 = 
	`ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
,

4087 
l¡¬t
, 
Ëngth
);

4088  
”r
;

4091 ià(
·¹Ÿl_¡¬t
) {

4092 
”r
 = 
	`ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
,

4093 
l¡¬t
, 
sb
->
s_blocksize
);

4094 ià(
”r
)

4095  
”r
;

4098 ià(
·¹Ÿl_’d
 !ğ
sb
->
s_blocksize
 - 1)

4099 
”r
 = 
	`ext4_block_z”o_·ge_¿nge
(
hªdË
, 
m­pšg
,

4100 
by‹_’d
 - 
·¹Ÿl_’d
,

4101 
·¹Ÿl_’d
 + 1);

4102  
”r
;

4103 
	}
}

4105 
	$ext4_ÿn_Œunÿ‹
(
šode
 *inode)

4107 ià(
	`S_ISREG
(
šode
->
i_mode
))

4109 ià(
	`S_ISDIR
(
šode
->
i_mode
))

4111 ià(
	`S_ISLNK
(
šode
->
i_mode
))

4112  !
	`ext4_šode_is_ç¡_symlšk
(
šode
);

4114 
	}
}

4122 
	$ext4_upd©e_disksize_befÜe_punch
(
šode
 *šode, 
loff_t
 
off£t
,

4123 
loff_t
 
Ën
)

4125 
hªdË_t
 *
hªdË
;

4126 
loff_t
 
size
 = 
	`i_size_»ad
(
šode
);

4128 
	`WARN_ON
(!
	`šode_is_locked
(
šode
));

4129 ià(
off£t
 > 
size
 || off£ˆ+ 
Ën
 < size)

4132 ià(
	`EXT4_I
(
šode
)->
i_disksize
 >ğ
size
)

4135 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MISC
, 1);

4136 ià(
	`IS_ERR
(
hªdË
))

4137  
	`PTR_ERR
(
hªdË
);

4138 
	`ext4_upd©e_i_disksize
(
šode
, 
size
);

4139 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4140 
	`ext4_jouº®_¡İ
(
hªdË
);

4143 
	}
}

4157 
	$ext4_m‘a_punch_hŞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
, 
hªdË_t
 *
hªdË
)

4159 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4160 
ext4_lblk_t
 
fœ¡_block
, 
¡İ_block
;

4161 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

4162 
loff_t
 
fœ¡_block_off£t
, 
Ï¡_block_off£t
;

4163 
üed™s
;

4164 
»t
 = 0;

4166 ià(!
	`S_ISREG
(
šode
->
i_mode
))

4167  -
EOPNOTSUPP
;

4169 
	`Œaû_ext4_punch_hŞe
(
šode
, 
off£t
, 
Ëngth
, 0);

4185 ià(
off£t
 >ğ
šode
->
i_size
)

4186 
out_mu‹x
;

4192 ià(
off£t
 + 
Ëngth
 > 
šode
->
i_size
) {

4193 
Ëngth
 = 
šode
->
i_size
 +

4194 
PAGE_SIZE
 - (
šode
->
i_size
 & (PAGE_SIZE - 1)) -

4195 
off£t
;

4198 ià(
off£t
 & (
sb
->
s_blocksize
 - 1) ||

4199 (
off£t
 + 
Ëngth
è& (
sb
->
s_blocksize
 - 1)) {

4204 
»t
 = 
	`ext4_šode_©ch_jšode
(
šode
);

4205 ià(
»t
 < 0)

4206 
out_mu‹x
;

4211 
	`ext4_šode_block_uÆocked_dio
(
šode
);

4212 
	`šode_dio_wa™
(
šode
);

4218 
fœ¡_block_off£t
 = 
	`round_up
(
off£t
, 
sb
->
s_blocksize
);

4219 
Ï¡_block_off£t
 = 
	`round_down
((
off£t
 + 
Ëngth
), 
sb
->
s_blocksize
) - 1;

4222 ià(
Ï¡_block_off£t
 > 
fœ¡_block_off£t
) {

4223 
»t
 = 
	`ext4_upd©e_disksize_befÜe_punch
(
šode
, 
off£t
, 
Ëngth
);

4224 ià(
»t
)

4225 
out_dio
;

4230 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4231 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

4233 
üed™s
 = 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
);

4235 
»t
 = 
	`ext4_z”o_·¹Ÿl_blocks
(
hªdË
, 
šode
, 
off£t
,

4236 
Ëngth
);

4237 ià(
»t
)

4238 
out_¡İ
;

4240 
fœ¡_block
 = (
off£t
 + 
sb
->
s_blocksize
 - 1) >>

4241 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

4242 
¡İ_block
 = (
off£t
 + 
Ëngth
è>> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

4245 ià(
fœ¡_block
 >ğ
¡İ_block
)

4246 
out_¡İ
;

4248 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

4250 
»t
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
fœ¡_block
,

4251 
¡İ_block
 - 
fœ¡_block
);

4252 ià(
»t
) {

4253 
out_¡İ
;

4256 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4257 
»t
 = 
	`ext4_ext_»move_¥aû
(
šode
, 
fœ¡_block
,

4258 
¡İ_block
 - 1);

4260 
»t
 = 
	`ext4_šd_»move_¥aû
(
hªdË
, 
šode
, 
fœ¡_block
,

4261 
¡İ_block
);

4263 ià(
	`IS_SYNC
(
šode
))

4264 
	`ext4_hªdË_sync
(
hªdË
);

4266 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

4267 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4268 ià(
»t
 >= 0)

4269 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4270 
out_¡İ
:

4272 
out_dio
:

4273 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

4274 
out_mu‹x
:

4275  
»t
;

4276 
	}
}

4290 
	$ext4_punch_hŞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ëngth
)

4292 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4293 
ext4_lblk_t
 
fœ¡_block
, 
¡İ_block
;

4294 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

4295 
loff_t
 
fœ¡_block_off£t
, 
Ï¡_block_off£t
;

4296 
hªdË_t
 *
hªdË
;

4297 
üed™s
;

4298 
»t
 = 0;

4300 ià(!
	`S_ISREG
(
šode
->
i_mode
))

4301  -
EOPNOTSUPP
;

4303 
	`Œaû_ext4_punch_hŞe
(
šode
, 
off£t
, 
Ëngth
, 0);

4309 ià(
	`m­pšg_gged
(
m­pšg
, 
PAGECACHE_TAG_DIRTY
)) {

4310 
»t
 = 
	`fem­_wr™e_ªd_wa™_¿nge
(
m­pšg
, 
off£t
,

4311 
off£t
 + 
Ëngth
 - 1);

4312 ià(
»t
)

4313  
»t
;

4316 
	`šode_lock
(
šode
);

4319 ià(
off£t
 >ğ
šode
->
i_size
)

4320 
out_mu‹x
;

4326 ià(
off£t
 + 
Ëngth
 > 
šode
->
i_size
) {

4327 
Ëngth
 = 
šode
->
i_size
 +

4328 
PAGE_SIZE
 - (
šode
->
i_size
 & (PAGE_SIZE - 1)) -

4329 
off£t
;

4332 ià(
off£t
 & (
sb
->
s_blocksize
 - 1) ||

4333 (
off£t
 + 
Ëngth
è& (
sb
->
s_blocksize
 - 1)) {

4338 
»t
 = 
	`ext4_šode_©ch_jšode
(
šode
);

4339 ià(
»t
 < 0)

4340 
out_mu‹x
;

4345 
	`ext4_šode_block_uÆocked_dio
(
šode
);

4346 
	`šode_dio_wa™
(
šode
);

4352 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4353 
fœ¡_block_off£t
 = 
	`round_up
(
off£t
, 
sb
->
s_blocksize
);

4354 
Ï¡_block_off£t
 = 
	`round_down
((
off£t
 + 
Ëngth
), 
sb
->
s_blocksize
) - 1;

4357 ià(
Ï¡_block_off£t
 > 
fœ¡_block_off£t
) {

4358 
»t
 = 
	`ext4_upd©e_disksize_befÜe_punch
(
šode
, 
off£t
, 
Ëngth
);

4359 ià(
»t
)

4360 
out_dio
;

4361 
	`Œunÿ‹_·geÿche_¿nge
(
šode
, 
fœ¡_block_off£t
,

4362 
Ï¡_block_off£t
);

4365 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4366 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

4368 
üed™s
 = 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
);

4369 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
üed™s
);

4370 ià(
	`IS_ERR
(
hªdË
)) {

4371 
»t
 = 
	`PTR_ERR
(
hªdË
);

4372 
	`ext4_¡d_”rÜ
(
sb
, 
»t
);

4373 
out_dio
;

4376 
»t
 = 
	`ext4_z”o_·¹Ÿl_blocks
(
hªdË
, 
šode
, 
off£t
,

4377 
Ëngth
);

4378 ià(
»t
)

4379 
out_¡İ
;

4381 
fœ¡_block
 = (
off£t
 + 
sb
->
s_blocksize
 - 1) >>

4382 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

4383 
¡İ_block
 = (
off£t
 + 
Ëngth
è>> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

4386 ià(
fœ¡_block
 >ğ
¡İ_block
)

4387 
out_¡İ
;

4389 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

4390 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

4392 
»t
 = 
	`ext4_es_»move_ex‹Á
(
šode
, 
fœ¡_block
,

4393 
¡İ_block
 - 
fœ¡_block
);

4394 ià(
»t
) {

4395 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

4396 
out_¡İ
;

4399 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4400 
»t
 = 
	`ext4_ext_»move_¥aû
(
šode
, 
fœ¡_block
,

4401 
¡İ_block
 - 1);

4403 
»t
 = 
	`ext4_šd_»move_¥aû
(
hªdË
, 
šode
, 
fœ¡_block
,

4404 
¡İ_block
);

4406 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

4407 
	`ext4_fc_Œack_¿nge
(
šode
, 
fœ¡_block
, 
¡İ_block
);

4408 ià(
	`IS_SYNC
(
šode
))

4409 
	`ext4_hªdË_sync
(
hªdË
);

4411 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

4412 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4413 ià(
»t
 >= 0)

4414 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 1);

4415 
out_¡İ
:

4416 
	`ext4_jouº®_¡İ
(
hªdË
);

4417 
out_dio
:

4418 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

4419 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

4420 
out_mu‹x
:

4421 
	`šode_uÆock
(
šode
);

4422  
»t
;

4423 
	}
}

4425 
	$ext4_šode_©ch_jšode
(
šode
 *inode)

4427 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

4428 
jbd2_šode
 *
jšode
;

4430 ià(
ei
->
jšode
 || !
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
)

4433 
jšode
 = 
	`jbd2_®loc_šode
(
GFP_KERNEL
);

4434 
	`¥š_lock
(&
šode
->
i_lock
);

4435 ià(!
ei
->
jšode
) {

4436 ià(!
jšode
) {

4437 
	`¥š_uÆock
(&
šode
->
i_lock
);

4438  -
ENOMEM
;

4440 
ei
->
jšode
 = jinode;

4441 
	`jbd2_jouº®_š™_jbd_šode
(
ei
->
jšode
, 
šode
);

4442 
jšode
 = 
NULL
;

4444 
	`¥š_uÆock
(&
šode
->
i_lock
);

4445 ià(
	`uÆik–y
(
jšode
 !ğ
NULL
))

4446 
	`jbd2_ä“_šode
(
jšode
);

4448 
	}
}

4478 
	$ext4_Œunÿ‹
(
šode
 *inode)

4480 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

4481 
üed™s
;

4482 
”r
 = 0;

4483 
hªdË_t
 *
hªdË
;

4484 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

4491 ià(!(
šode
->
i_¡©e
 & (
I_NEW
|
I_FREEING
)))

4492 
	`WARN_ON
(!
	`šode_is_locked
(
šode
));

4493 
	`Œaû_ext4_Œunÿ‹_’‹r
(
šode
);

4495 ià(!
	`ext4_ÿn_Œunÿ‹
(
šode
))

4498 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EOFBLOCKS
);

4500 ià(
šode
->
i_size
 =ğ0 && !
	`‹¡_İt
(šode->
i_sb
, 
NO_AUTO_DA_ALLOC
))

4501 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_DA_ALLOC_CLOSE
);

4503 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

4504 
has_šlše
 = 1;

4506 
”r
 = 
	`ext4_šlše_d©a_Œunÿ‹
(
šode
, &
has_šlše
);

4507 ià(
”r
)

4508  
”r
;

4509 ià(
has_šlše
)

4514 ià(
šode
->
i_size
 & (šode->
i_sb
->
s_blocksize
 - 1)) {

4515 ià(
	`ext4_šode_©ch_jšode
(
šode
) < 0)

4519 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4520 
üed™s
 = 
	`ext4_wr™•age_Œªs_blocks
(
šode
);

4522 
üed™s
 = 
	`ext4_blocks_fÜ_Œunÿ‹
(
šode
);

4524 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_TRUNCATE
, 
üed™s
);

4525 ià(
	`IS_ERR
(
hªdË
))

4526  
	`PTR_ERR
(
hªdË
);

4528 ià(
šode
->
i_size
 & (šode->
i_sb
->
s_blocksize
 - 1))

4529 
	`ext4_block_Œunÿ‹_·ge
(
hªdË
, 
m­pšg
, 
šode
->
i_size
);

4540 
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

4541 ià(
”r
)

4542 
out_¡İ
;

4544 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

4546 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

4548 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))

4549 
”r
 = 
	`ext4_ext_Œunÿ‹
(
hªdË
, 
šode
);

4551 
	`ext4_šd_Œunÿ‹
(
hªdË
, 
šode
);

4553 
	`up_wr™e
(&
ei
->
i_d©a_£m
);

4554 ià(
”r
)

4555 
out_¡İ
;

4557 ià(
	`IS_SYNC
(
šode
))

4558 
	`ext4_hªdË_sync
(
hªdË
);

4560 
out_¡İ
:

4568 ià(
šode
->
i_Æšk
)

4569 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

4571 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

4572 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

4573 
	`ext4_jouº®_¡İ
(
hªdË
);

4575 
	`Œaû_ext4_Œunÿ‹_ex™
(
šode
);

4576  
”r
;

4577 
	}
}

4585 
	$__ext4_g‘_šode_loc
(
su³r_block
 *
sb
,

4586 
šo
,

4587 
ext4_oc
 *
oc
, 
š_mem
,

4588 
ext4_fsblk_t
 *
»t_block
)

4590 
ext4_group_desc
 *
gdp
;

4591 
bufãr_h—d
 *
bh
;

4592 
ext4_fsblk_t
 
block
;

4593 
šodes_³r_block
, 
šode_off£t
;

4595 
oc
->
bh
 = 
NULL
;

4596 ià(!
	`ext4_v®id_šum
(
sb
, 
šo
))

4597  -
EFSCORRUPTED
;

4599 
oc
->
block_group
 = (
šo
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(
sb
);

4600 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
oc
->
block_group
, 
NULL
);

4601 ià(!
gdp
)

4602  -
EIO
;

4607 
šodes_³r_block
 = 
	`EXT4_SB
(
sb
)->
s_šodes_³r_block
;

4608 
šode_off£t
 = ((
šo
 - 1) %

4609 
	`EXT4_INODES_PER_GROUP
(
sb
));

4610 
block
 = 
	`ext4_šode_bË
(
sb
, 
gdp
è+ (
šode_off£t
 / 
šodes_³r_block
);

4611 
oc
->
off£t
 = (
šode_off£t
 % 
šodes_³r_block
è* 
	`EXT4_INODE_SIZE
(
sb
);

4613 
bh
 = 
	`sb_g‘blk
(
sb
, 
block
);

4614 ià(
	`uÆik–y
(!
bh
))

4615  -
ENOMEM
;

4616 ià(!
	`bufãr_u±od©e
(
bh
)) {

4617 
	`lock_bufãr
(
bh
);

4625 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
è&& !
	`bufãr_u±od©e
(bh))

4626 
	`£t_bufãr_u±od©e
(
bh
);

4628 ià(
	`bufãr_u±od©e
(
bh
)) {

4630 
	`uÆock_bufãr
(
bh
);

4631 
has_bufãr
;

4639 ià(
š_mem
) {

4640 
bufãr_h—d
 *
b™m­_bh
;

4641 
i
, 
¡¬t
;

4643 
¡¬t
 = 
šode_off£t
 & ~(
šodes_³r_block
 - 1);

4646 
b™m­_bh
 = 
	`sb_g‘blk
(
sb
, 
	`ext4_šode_b™m­
(sb, 
gdp
));

4647 ià(
	`uÆik–y
(!
b™m­_bh
))

4648 
make_io
;

4655 ià(!
	`bufãr_u±od©e
(
b™m­_bh
)) {

4656 
	`b»l£
(
b™m­_bh
);

4657 
make_io
;

4659 
i
 = 
¡¬t
; i < s¹ + 
šodes_³r_block
; i++) {

4660 ià(
i
 =ğ
šode_off£t
)

4662 ià(
	`ext4_‹¡_b™
(
i
, 
b™m­_bh
->
b_d©a
))

4665 
	`b»l£
(
b™m­_bh
);

4666 ià(
i
 =ğ
¡¬t
 + 
šodes_³r_block
) {

4668 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

4669 
	`£t_bufãr_u±od©e
(
bh
);

4670 
	`uÆock_bufãr
(
bh
);

4671 
has_bufãr
;

4675 
make_io
:

4680 ià(
	`EXT4_SB
(
sb
)->
s_šode_»adah—d_blks
) {

4681 
ext4_fsblk_t
 
b
, 
’d
, 
bË
;

4682 
num
;

4683 
__u32
 
¿_blks
 = 
	`EXT4_SB
(
sb
)->
s_šode_»adah—d_blks
;

4685 
bË
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

4687 
b
 = 
block
 & ~((
ext4_fsblk_t
è
¿_blks
 - 1);

4688 ià(
bË
 > 
b
)

4689 
b
 = 
bË
;

4690 
’d
 = 
b
 + 
¿_blks
;

4691 
num
 = 
	`EXT4_INODES_PER_GROUP
(
sb
);

4692 ià(
	`ext4_has_group_desc_csum
(
sb
))

4693 
num
 -ğ
	`ext4_™abË_unu£d_couÁ
(
sb
, 
gdp
);

4694 
bË
 +ğ
num
 / 
šodes_³r_block
;

4695 ià(
’d
 > 
bË
)

4696 
’d
 = 
bË
;

4697 
b
 <ğ
’d
)

4698 
	`sb_b»adah—d
(
sb
, 
b
++);

4706 
	`Œaû_ext4_lßd_šode
(
sb
, 
šo
);

4707 
	`g‘_bh
(
bh
);

4708 
bh
->
b_’d_io
 = 
’d_bufãr_»ad_sync
;

4709 
	`subm™_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

4710 
	`wa™_Ú_bufãr
(
bh
);

4711 ià(!
	`bufãr_u±od©e
(
bh
)) {

4712 ià(
»t_block
)

4713 *
»t_block
 = 
block
;

4714 
	`b»l£
(
bh
);

4715  -
EIO
;

4718 
has_bufãr
:

4719 
oc
->
bh
 = bh;

4721 
	}
}

4723 
	$__ext4_g‘_šode_loc_nošmem
(
šode
 *inode,

4724 
ext4_oc
 *
oc
)

4726 
ext4_fsblk_t
 
”r_blk
;

4727 
»t
;

4729 
»t
 = 
	`__ext4_g‘_šode_loc
(
šode
->
i_sb
, inode->
i_šo
, 
oc
, 0,

4730 &
”r_blk
);

4732 ià(
»t
 =ğ-
EIO
)

4733 
	`EXT4_ERROR_INODE_BLOCK
(
šode
, 
”r_blk
,

4736  
»t
;

4737 
	}
}

4739 
	$ext4_g‘_šode_loc
(
šode
 *šode, 
ext4_oc
 *
oc
)

4741 
ext4_fsblk_t
 
”r_blk
;

4742 
»t
;

4745 
»t
 = 
	`__ext4_g‘_šode_loc
(
šode
->
i_sb
, inode->
i_šo
, 
oc
,

4746 !
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
), &
”r_blk
);

4748 ià(
»t
 =ğ-
EIO
)

4749 
	`EXT4_ERROR_INODE_BLOCK
(
šode
, 
”r_blk
,

4752  
»t
;

4753 
	}
}

4756 
	$ext4_g‘_fc_šode_loc
(
su³r_block
 *
sb
, 
šo
,

4757 
ext4_oc
 *
oc
)

4759  
	`__ext4_g‘_šode_loc
(
sb
, 
šo
, 
oc
, 0, 
NULL
);

4760 
	}
}

4762 
	$ext4_£t_šode_æags
(
šode
 *inode)

4764 
æags
 = 
	`EXT4_I
(
šode
)->
i_æags
;

4765 
Ãw_æ
 = 0;

4767 ià(
æags
 & 
EXT4_SYNC_FL
)

4768 
Ãw_æ
 |ğ
S_SYNC
;

4769 ià(
æags
 & 
EXT4_APPEND_FL
)

4770 
Ãw_æ
 |ğ
S_APPEND
;

4771 ià(
æags
 & 
EXT4_IMMUTABLE_FL
)

4772 
Ãw_æ
 |ğ
S_IMMUTABLE
;

4773 ià(
æags
 & 
EXT4_NOATIME_FL
)

4774 
Ãw_æ
 |ğ
S_NOATIME
;

4775 ià(
æags
 & 
EXT4_DIRSYNC_FL
)

4776 
Ãw_æ
 |ğ
S_DIRSYNC
;

4777 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DAX
è&& 
	`S_ISREG
(šode->
i_mode
) &&

4778 !
	`ext4_should_jouº®_d©a
(
šode
è&& !
	`ext4_has_šlše_d©a
(inode) &&

4779 !
	`ext4_’üy±ed_šode
(
šode
))

4780 
Ãw_æ
 |ğ
S_DAX
;

4781 
	`šode_£t_æags
(
šode
, 
Ãw_æ
,

4782 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
|
S_DAX
);

4783 
	}
}

4785 
blkút_t
 
	$ext4_šode_blocks
(
ext4_šode
 *
¿w_šode
,

4786 
ext4_šode_šfo
 *
ei
)

4788 
blkút_t
 
i_blocks
 ;

4789 
šode
 *šodğ&(
ei
->
vfs_šode
);

4790 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4792 ià(
	`ext4_has_ã©u»_huge_fe
(
sb
)) {

4794 
i_blocks
 = ((
u64
)
	`Ë16_to_ıu
(
¿w_šode
->
i_blocks_high
)) << 32 |

4795 
	`Ë32_to_ıu
(
¿w_šode
->
i_blocks_lo
);

4796 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_HUGE_FILE
)) {

4798  
i_blocks
 << (
šode
->
i_blkb™s
 - 9);

4800  
i_blocks
;

4803  
	`Ë32_to_ıu
(
¿w_šode
->
i_blocks_lo
);

4805 
	}
}

4807 
šlše
 
	$ext4_ig‘_exŒa_šode
(
šode
 *inode,

4808 
ext4_šode
 *
¿w_šode
,

4809 
ext4_šode_šfo
 *
ei
)

4811 
__Ë32
 *
magic
 = (*)
¿w_šode
 +

4812 
EXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exŒa_isize
;

4813 ià(
EXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exŒa_isize
 + (
__Ë32
) <=

4814 
	`EXT4_INODE_SIZE
(
šode
->
i_sb
) &&

4815 *
magic
 =ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
)) {

4816 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

4817 
	`ext4_fšd_šlše_d©a_nŞock
(
šode
);

4819 
	`EXT4_I
(
šode
)->
i_šlše_off
 = 0;

4820 
	}
}

4822 
	$ext4_g‘_´ojid
(
šode
 *šode, 
k´ojid_t
 *
´ojid
)

4824 ià(!
	`ext4_has_ã©u»_´ojeù
(
šode
->
i_sb
))

4825  -
EOPNOTSUPP
;

4826 *
´ojid
 = 
	`EXT4_I
(
šode
)->
i_´ojid
;

4828 
	}
}

4830 
šode
 *
	$ext4_ig‘
(
su³r_block
 *
sb
, 
šo
)

4832 
ext4_oc
 
oc
;

4833 
ext4_šode
 *
¿w_šode
;

4834 
ext4_šode_šfo
 *
ei
;

4835 
šode
 *inode;

4836 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

4837 
»t
;

4838 
loff_t
 
size
;

4839 
block
;

4840 
uid_t
 
i_uid
;

4841 
gid_t
 
i_gid
;

4842 
´ojid_t
 
i_´ojid
;

4844 
šode
 = 
	`ig‘_locked
(
sb
, 
šo
);

4845 ià(!
šode
)

4846  
	`ERR_PTR
(-
ENOMEM
);

4847 ià(!(
šode
->
i_¡©e
 & 
I_NEW
))

4848  
šode
;

4850 
ei
 = 
	`EXT4_I
(
šode
);

4851 
oc
.
bh
 = 
NULL
;

4853 
»t
 = 
	`__ext4_g‘_šode_loc_nošmem
(
šode
, &
oc
);

4854 ià(
»t
 < 0)

4855 
bad_šode
;

4856 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

4858 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
) {

4859 
ei
->
i_exŒa_isize
 = 
	`Ë16_to_ıu
(
¿w_šode
->i_extra_isize);

4860 ià(
EXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exŒa_isize
 >

4861 
	`EXT4_INODE_SIZE
(
šode
->
i_sb
) ||

4862 (
ei
->
i_exŒa_isize
 & 3)) {

4863 
	`EXT4_ERROR_INODE
(
šode
,

4865 
ei
->
i_exŒa_isize
,

4866 
	`EXT4_INODE_SIZE
(
šode
->
i_sb
));

4867 
»t
 = -
EFSCORRUPTED
;

4868 
bad_šode
;

4871 
ei
->
i_exŒa_isize
 = 0;

4874 ià(
	`ext4_has_m‘ad©a_csum
(
sb
)) {

4875 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

4876 
__u32
 
csum
;

4877 
__Ë32
 
šum
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

4878 
__Ë32
 
g’
 = 
¿w_šode
->
i_g’”©iÚ
;

4879 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
šum
,

4880 (
šum
));

4881 
ei
->
i_csum_£ed
 = 
	`ext4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
g’
,

4882 (
g’
));

4885 ià(!
	`ext4_šode_csum_v”ify
(
šode
, 
¿w_šode
, 
ei
)) {

4886 
	`EXT4_ERROR_INODE
(
šode
, "checksum invalid");

4887 
»t
 = -
EFSBADCRC
;

4888 
bad_šode
;

4891 
šode
->
i_mode
 = 
	`Ë16_to_ıu
(
¿w_šode
->i_mode);

4892 
i_uid
 = (
uid_t
)
	`Ë16_to_ıu
(
¿w_šode
->
i_uid_low
);

4893 
i_gid
 = (
gid_t
)
	`Ë16_to_ıu
(
¿w_šode
->
i_gid_low
);

4894 ià(
	`ext4_has_ã©u»_´ojeù
(
sb
) &&

4895 
	`EXT4_INODE_SIZE
(
sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
 &&

4896 
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_´ojid
))

4897 
i_´ojid
 = (
´ojid_t
)
	`Ë32_to_ıu
(
¿w_šode
->i_projid);

4899 
i_´ojid
 = 
EXT4_DEF_PROJID
;

4901 ià(!(
	`‹¡_İt
(
šode
->
i_sb
, 
NO_UID32
))) {

4902 
i_uid
 |ğ
	`Ë16_to_ıu
(
¿w_šode
->
i_uid_high
) << 16;

4903 
i_gid
 |ğ
	`Ë16_to_ıu
(
¿w_šode
->
i_gid_high
) << 16;

4905 
	`i_uid_wr™e
(
šode
, 
i_uid
);

4906 
	`i_gid_wr™e
(
šode
, 
i_gid
);

4907 
ei
->
i_´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, i_projid);

4908 
	`£t_Æšk
(
šode
, 
	`Ë16_to_ıu
(
¿w_šode
->
i_lšks_couÁ
));

4910 
	`ext4_ş—r_¡©e_æags
(
ei
);

4911 
ei
->
i_šlše_off
 = 0;

4912 
ei
->
i_dœ_¡¬t_lookup
 = 0;

4913 
ei
->
i_dtime
 = 
	`Ë32_to_ıu
(
¿w_šode
->i_dtime);

4919 ià(
šode
->
i_Æšk
 == 0) {

4920 ià((
šode
->
i_mode
 == 0 ||

4921 !(
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_¡©e
 & 
EXT4_ORPHAN_FS
)) &&

4922 
šo
 !ğ
EXT4_BOOT_LOADER_INO
) {

4924 
»t
 = -
ESTALE
;

4925 
bad_šode
;

4934 
ei
->
i_æags
 = 
	`Ë32_to_ıu
(
¿w_šode
->i_flags);

4935 
šode
->
i_blocks
 = 
	`ext4_šode_blocks
(
¿w_šode
, 
ei
);

4936 
ei
->
i_fe_aş
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_fe_aş_lo
);

4937 ià(
	`ext4_has_ã©u»_64b™
(
sb
))

4938 
ei
->
i_fe_aş
 |=

4939 ((
__u64
)
	`Ë16_to_ıu
(
¿w_šode
->
i_fe_aş_high
)) << 32;

4940 
šode
->
i_size
 = 
	`ext4_isize
(
sb
, 
¿w_šode
);

4941 ià((
size
 = 
	`i_size_»ad
(
šode
)) < 0) {

4942 
	`EXT4_ERROR_INODE
(
šode
, "bad i_sizv®ue: %Îd", 
size
);

4943 
»t
 = -
EFSCORRUPTED
;

4944 
bad_šode
;

4946 
ei
->
i_disksize
 = 
šode
->
i_size
;

4947 #ifdeà
CONFIG_QUOTA


4948 
ei
->
i_»£rved_quÙa
 = 0;

4950 
šode
->
i_g’”©iÚ
 = 
	`Ë32_to_ıu
(
¿w_šode
->i_generation);

4951 
ei
->
i_block_group
 = 
oc
.
block_group
;

4952 
ei
->
i_Ï¡_®loc_group
 = ~0;

4957 
block
 = 0; block < 
EXT4_N_BLOCKS
; block++)

4958 
ei
->
i_d©a
[
block
] = 
¿w_šode
->
i_block
[block];

4959 
	`INIT_LIST_HEAD
(&
ei
->
i_Üphª
);

4960 
	`ext4_š™_šode_fc_šfo
(&
ei
->
vfs_šode
);

4969 ià(
jouº®
) {

4970 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

4971 
tid_t
 
tid
;

4973 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

4974 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
)

4975 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

4977 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

4978 ià(
Œª§ùiÚ
)

4979 
tid
 = 
Œª§ùiÚ
->
t_tid
;

4981 
tid
 = 
jouº®
->
j_comm™_£qu’û
;

4982 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

4983 
ei
->
i_sync_tid
 = 
tid
;

4984 
ei
->
i_d©async_tid
 = 
tid
;

4987 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
) {

4988 ià(
ei
->
i_exŒa_isize
 == 0) {

4990 
	`BUILD_BUG_ON
((
ext4_šode
) & 3);

4991 
ei
->
i_exŒa_isize
 = (
ext4_šode
) -

4992 
EXT4_GOOD_OLD_INODE_SIZE
;

4994 
	`ext4_ig‘_exŒa_šode
(
šode
, 
¿w_šode
, 
ei
);

4998 
	`EXT4_INODE_GET_XTIME
(
i_ùime
, 
šode
, 
¿w_šode
);

4999 
	`EXT4_INODE_GET_XTIME
(
i_mtime
, 
šode
, 
¿w_šode
);

5000 
	`EXT4_INODE_GET_XTIME
(
i_©ime
, 
šode
, 
¿w_šode
);

5001 
	`EXT4_EINODE_GET_XTIME
(
i_ütime
, 
ei
, 
¿w_šode
);

5003 ià(
	`lik–y
(!
	`‹¡_İt2
(
šode
->
i_sb
, 
HURD_COMPAT
))) {

5004 
šode
->
i_v”siÚ
 = 
	`Ë32_to_ıu
(
¿w_šode
->
i_disk_v”siÚ
);

5005 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
) {

5006 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_v”siÚ_hi
))

5007 
šode
->
i_v”siÚ
 |=

5008 (
__u64
)(
	`Ë32_to_ıu
(
¿w_šode
->
i_v”siÚ_hi
)) << 32;

5012 
»t
 = 0;

5013 ià(
ei
->
i_fe_aş
 &&

5014 !
	`ext4_d©a_block_v®id
(
	`EXT4_SB
(
sb
), 
ei
->
i_fe_aş
, 1)) {

5015 
	`EXT4_ERROR_INODE
(
šode
, "badƒxtended‡ttribute block %llu",

5016 
ei
->
i_fe_aş
);

5017 
»t
 = -
EFSCORRUPTED
;

5018 
bad_šode
;

5019 } ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

5020 ià(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)) {

5021 ià((
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

5022 (
	`S_ISLNK
(
šode
->
i_mode
) &&

5023 !
	`ext4_šode_is_ç¡_symlšk
(
šode
))))

5025 
»t
 = 
	`ext4_ext_check_šode
(
šode
);

5026 } ià(
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

5027 (
	`S_ISLNK
(
šode
->
i_mode
) &&

5028 !
	`ext4_šode_is_ç¡_symlšk
(
šode
))) {

5030 
»t
 = 
	`ext4_šd_check_šode
(
šode
);

5033 ià(
»t
)

5034 
bad_šode
;

5036 ià(
	`S_ISREG
(
šode
->
i_mode
)) {

5037 
šode
->
i_İ
 = &
ext4_fe_šode_İ”©iÚs
;

5038 
šode
->
i_fİ
 = &
ext4_fe_İ”©iÚs
;

5039 
	`ext4_£t_aİs
(
šode
);

5040 } ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

5041 
šode
->
i_İ
 = &
ext4_dœ_šode_İ”©iÚs
;

5042 
šode
->
i_fİ
 = &
ext4_dœ_İ”©iÚs
;

5043 } ià(
	`S_ISLNK
(
šode
->
i_mode
)) {

5044 ià(
	`ext4_’üy±ed_šode
(
šode
)) {

5045 
šode
->
i_İ
 = &
ext4_’üy±ed_symlšk_šode_İ”©iÚs
;

5046 
	`ext4_£t_aİs
(
šode
);

5047 } ià(
	`ext4_šode_is_ç¡_symlšk
(
šode
)) {

5048 
šode
->
i_lšk
 = (*)
ei
->
i_d©a
;

5049 
šode
->
i_İ
 = &
ext4_ç¡_symlšk_šode_İ”©iÚs
;

5050 
	`nd_‹rmš©e_lšk
(
ei
->
i_d©a
, 
šode
->
i_size
,

5051 (
ei
->
i_d©a
) - 1);

5053 
šode
->
i_İ
 = &
ext4_symlšk_šode_İ”©iÚs
;

5054 
	`ext4_£t_aİs
(
šode
);

5056 
	`šode_nohighmem
(
šode
);

5057 } ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode) ||

5058 
	`S_ISFIFO
(
šode
->
i_mode
è|| 
	`S_ISSOCK
(inode->i_mode)) {

5059 
šode
->
i_İ
 = &
ext4_¥ecŸl_šode_İ”©iÚs
;

5060 ià(
¿w_šode
->
i_block
[0])

5061 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
,

5062 
	`Şd_decode_dev
(
	`Ë32_to_ıu
(
¿w_šode
->
i_block
[0])));

5064 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
,

5065 
	`Ãw_decode_dev
(
	`Ë32_to_ıu
(
¿w_šode
->
i_block
[1])));

5066 } ià(
šo
 =ğ
EXT4_BOOT_LOADER_INO
) {

5067 
	`make_bad_šode
(
šode
);

5069 
»t
 = -
EFSCORRUPTED
;

5070 
	`EXT4_ERROR_INODE
(
šode
, "bogu i_mod(%o)", inode->
i_mode
);

5071 
bad_šode
;

5073 
	`b»l£
(
oc
.
bh
);

5074 
	`ext4_£t_šode_æags
(
šode
);

5076 ià(
ei
->
i_æags
 & 
EXT4_EA_INODE_FL
) {

5077 
	`ext4_x©Œ_šode_£t_şass
(
šode
);

5079 
	`šode_lock
(
šode
);

5080 
šode
->
i_æags
 |ğ
S_NOQUOTA
;

5081 
	`šode_uÆock
(
šode
);

5084 
	`uÆock_Ãw_šode
(
šode
);

5085  
šode
;

5087 
bad_šode
:

5088 
	`b»l£
(
oc
.
bh
);

5089 
	`ig‘_çed
(
šode
);

5090  
	`ERR_PTR
(
»t
);

5091 
	}
}

5093 
šode
 *
	$ext4_ig‘_nÜm®
(
su³r_block
 *
sb
, 
šo
)

5095 ià(
šo
 < 
	`EXT4_FIRST_INO
(
sb
è&& inØ!ğ
EXT4_ROOT_INO
)

5096  
	`ERR_PTR
(-
EFSCORRUPTED
);

5097  
	`ext4_ig‘
(
sb
, 
šo
);

5098 
	}
}

5100 
	$ext4_šode_blocks_£t
(
hªdË_t
 *
hªdË
,

5101 
ext4_šode
 *
¿w_šode
,

5102 
ext4_šode_šfo
 *
ei
)

5104 
šode
 *šodğ&(
ei
->
vfs_šode
);

5105 
u64
 
i_blocks
 = 
šode
->i_blocks;

5106 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

5108 ià(
i_blocks
 <= ~0U) {

5113 
¿w_šode
->
i_blocks_lo
 = 
	`ıu_to_Ë32
(
i_blocks
);

5114 
¿w_šode
->
i_blocks_high
 = 0;

5115 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_HUGE_FILE
);

5118 ià(!
	`ext4_has_ã©u»_huge_fe
(
sb
))

5119  -
EFBIG
;

5121 ià(
i_blocks
 <= 0xffffffffffffULL) {

5126 
¿w_šode
->
i_blocks_lo
 = 
	`ıu_to_Ë32
(
i_blocks
);

5127 
¿w_šode
->
i_blocks_high
 = 
	`ıu_to_Ë16
(
i_blocks
 >> 32);

5128 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_HUGE_FILE
);

5130 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_HUGE_FILE
);

5132 
i_blocks
 = i_block >> (
šode
->
i_blkb™s
 - 9);

5133 
¿w_šode
->
i_blocks_lo
 = 
	`ıu_to_Ë32
(
i_blocks
);

5134 
¿w_šode
->
i_blocks_high
 = 
	`ıu_to_Ë16
(
i_blocks
 >> 32);

5137 
	}
}

5139 
	sÙh”_šode
 {

5140 
	mÜig_šo
;

5141 
ext4_šode
 *
	m¿w_šode
;

5144 
	$Ùh”_šode_m©ch
(
šode
 * inode, 
šo
,

5145 *
d©a
)

5147 
Ùh”_šode
 *
oi
 = (Ùh”_šod*è
d©a
;

5149 ià((
šode
->
i_šo
 !ğ
šo
) ||

5150 (
šode
->
i_¡©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5151 
I_DIRTY_SYNC
 | 
I_DIRTY_DATASYNC
)) ||

5152 ((
šode
->
i_¡©e
 & 
I_DIRTY_TIME
) == 0))

5154 
	`¥š_lock
(&
šode
->
i_lock
);

5155 ià(((
šode
->
i_¡©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5156 
I_DIRTY_SYNC
 | 
I_DIRTY_DATASYNC
)) == 0) &&

5157 (
šode
->
i_¡©e
 & 
I_DIRTY_TIME
)) {

5158 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

5160 
šode
->
i_¡©e
 &ğ~(
I_DIRTY_TIME
 | 
I_DIRTY_TIME_EXPIRED
);

5161 
	`¥š_uÆock
(&
šode
->
i_lock
);

5163 
	`¥š_lock
(&
ei
->
i_¿w_lock
);

5164 
	`EXT4_INODE_SET_XTIME
(
i_ùime
, 
šode
, 
oi
->
¿w_šode
);

5165 
	`EXT4_INODE_SET_XTIME
(
i_mtime
, 
šode
, 
oi
->
¿w_šode
);

5166 
	`EXT4_INODE_SET_XTIME
(
i_©ime
, 
šode
, 
oi
->
¿w_šode
);

5167 
	`ext4_šode_csum_£t
(
šode
, 
oi
->
¿w_šode
, 
ei
);

5168 
	`¥š_uÆock
(&
ei
->
i_¿w_lock
);

5169 
	`Œaû_ext4_Ùh”_šode_upd©e_time
(
šode
, 
oi
->
Üig_šo
);

5172 
	`¥š_uÆock
(&
šode
->
i_lock
);

5174 
	}
}

5180 
	$ext4_upd©e_Ùh”_šodes_time
(
su³r_block
 *
sb
,

5181 
Üig_šo
, *
buf
)

5183 
Ùh”_šode
 
oi
;

5184 
šo
;

5185 
i
, 
šodes_³r_block
 = 
	`EXT4_SB
(
sb
)->
s_šodes_³r_block
;

5186 
šode_size
 = 
	`EXT4_INODE_SIZE
(
sb
);

5188 
oi
.
Üig_šo
 = orig_ino;

5194 
šo
 = ((
Üig_šo
 - 1è& ~(
šodes_³r_block
 - 1)) + 1;

5195 
i
 = 0; i < 
šodes_³r_block
; i++, 
šo
++, 
buf
 +ğ
šode_size
) {

5196 ià(
šo
 =ğ
Üig_šo
)

5198 
oi
.
¿w_šode
 = (
ext4_šode
 *è
buf
;

5199 (è
	`fšd_šode_nowa™
(
sb
, 
šo
, 
Ùh”_šode_m©ch
, &
oi
);

5201 
	}
}

5210 
	$ext4_do_upd©e_šode
(
hªdË_t
 *
hªdË
,

5211 
šode
 *inode,

5212 
ext4_oc
 *
oc
)

5214 
ext4_šode
 *
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

5215 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

5216 
bufãr_h—d
 *
bh
 = 
oc
->bh;

5217 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

5218 
”r
 = 0, 
rc
, 
block
;

5219 
Ãed_d©async
 = 0, 
£t_Ïrge_fe
 = 0;

5220 
uid_t
 
i_uid
;

5221 
gid_t
 
i_gid
;

5222 
´ojid_t
 
i_´ojid
;

5224 
	`¥š_lock
(&
ei
->
i_¿w_lock
);

5228 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
))

5229 
	`mem£t
(
¿w_šode
, 0, 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
);

5231 
¿w_šode
->
i_mode
 = 
	`ıu_to_Ë16
(
šode
->i_mode);

5232 
i_uid
 = 
	`i_uid_»ad
(
šode
);

5233 
i_gid
 = 
	`i_gid_»ad
(
šode
);

5234 
i_´ojid
 = 
	`äom_k´ojid
(&
š™_u£r_ns
, 
ei
->i_projid);

5235 ià(!(
	`‹¡_İt
(
šode
->
i_sb
, 
NO_UID32
))) {

5236 
¿w_šode
->
i_uid_low
 = 
	`ıu_to_Ë16
(
	`low_16_b™s
(
i_uid
));

5237 
¿w_šode
->
i_gid_low
 = 
	`ıu_to_Ë16
(
	`low_16_b™s
(
i_gid
));

5242 ià(
ei
->
i_dtime
 && 
	`li¡_em±y
(&ei->
i_Üphª
)) {

5243 
¿w_šode
->
i_uid_high
 = 0;

5244 
¿w_šode
->
i_gid_high
 = 0;

5246 
¿w_šode
->
i_uid_high
 =

5247 
	`ıu_to_Ë16
(
	`high_16_b™s
(
i_uid
));

5248 
¿w_šode
->
i_gid_high
 =

5249 
	`ıu_to_Ë16
(
	`high_16_b™s
(
i_gid
));

5252 
¿w_šode
->
i_uid_low
 = 
	`ıu_to_Ë16
(
	`fs_high2lowuid
(
i_uid
));

5253 
¿w_šode
->
i_gid_low
 = 
	`ıu_to_Ë16
(
	`fs_high2lowgid
(
i_gid
));

5254 
¿w_šode
->
i_uid_high
 = 0;

5255 
¿w_šode
->
i_gid_high
 = 0;

5257 
¿w_šode
->
i_lšks_couÁ
 = 
	`ıu_to_Ë16
(
šode
->
i_Æšk
);

5259 
	`EXT4_INODE_SET_XTIME
(
i_ùime
, 
šode
, 
¿w_šode
);

5260 
	`EXT4_INODE_SET_XTIME
(
i_mtime
, 
šode
, 
¿w_šode
);

5261 
	`EXT4_INODE_SET_XTIME
(
i_©ime
, 
šode
, 
¿w_šode
);

5262 
	`EXT4_EINODE_SET_XTIME
(
i_ütime
, 
ei
, 
¿w_šode
);

5264 
”r
 = 
	`ext4_šode_blocks_£t
(
hªdË
, 
¿w_šode
, 
ei
);

5265 ià(
”r
) {

5266 
	`¥š_uÆock
(&
ei
->
i_¿w_lock
);

5267 
out_b»l£
;

5269 
¿w_šode
->
i_dtime
 = 
	`ıu_to_Ë32
(
ei
->i_dtime);

5270 
¿w_šode
->
i_æags
 = 
	`ıu_to_Ë32
(
ei
->i_flags & 0xFFFFFFFF);

5271 ià(
	`lik–y
(!
	`‹¡_İt2
(
šode
->
i_sb
, 
HURD_COMPAT
)))

5272 
¿w_šode
->
i_fe_aş_high
 =

5273 
	`ıu_to_Ë16
(
ei
->
i_fe_aş
 >> 32);

5274 
¿w_šode
->
i_fe_aş_lo
 = 
	`ıu_to_Ë32
(
ei
->
i_fe_aş
);

5275 ià(
ei
->
i_disksize
 !ğ
	`ext4_isize
(
šode
->
i_sb
, 
¿w_šode
)) {

5276 
	`ext4_isize_£t
(
¿w_šode
, 
ei
->
i_disksize
);

5277 
Ãed_d©async
 = 1;

5279 ià(
ei
->
i_disksize
 > 0x7fffffffULL) {

5280 ià(!
	`ext4_has_ã©u»_Ïrge_fe
(
sb
) ||

5281 
	`EXT4_SB
(
sb
)->
s_es
->
s_»v_Ëv–
 ==

5282 
	`ıu_to_Ë32
(
EXT4_GOOD_OLD_REV
))

5283 
£t_Ïrge_fe
 = 1;

5285 
¿w_šode
->
i_g’”©iÚ
 = 
	`ıu_to_Ë32
(
šode
->i_generation);

5286 ià(
	`S_ISCHR
(
šode
->
i_mode
è|| 
	`S_ISBLK
(inode->i_mode)) {

5287 ià(
	`Şd_v®id_dev
(
šode
->
i_rdev
)) {

5288 
¿w_šode
->
i_block
[0] =

5289 
	`ıu_to_Ë32
(
	`Şd_’code_dev
(
šode
->
i_rdev
));

5290 
¿w_šode
->
i_block
[1] = 0;

5292 
¿w_šode
->
i_block
[0] = 0;

5293 
¿w_šode
->
i_block
[1] =

5294 
	`ıu_to_Ë32
(
	`Ãw_’code_dev
(
šode
->
i_rdev
));

5295 
¿w_šode
->
i_block
[2] = 0;

5297 } ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

5298 
block
 = 0; block < 
EXT4_N_BLOCKS
; block++)

5299 
¿w_šode
->
i_block
[
block
] = 
ei
->
i_d©a
[block];

5302 ià(
	`lik–y
(!
	`‹¡_İt2
(
šode
->
i_sb
, 
HURD_COMPAT
))) {

5303 
¿w_šode
->
i_disk_v”siÚ
 = 
	`ıu_to_Ë32
(
šode
->
i_v”siÚ
);

5304 ià(
ei
->
i_exŒa_isize
) {

5305 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_v”siÚ_hi
))

5306 
¿w_šode
->
i_v”siÚ_hi
 =

5307 
	`ıu_to_Ë32
(
šode
->
i_v”siÚ
 >> 32);

5308 
¿w_šode
->
i_exŒa_isize
 =

5309 
	`ıu_to_Ë16
(
ei
->
i_exŒa_isize
);

5313 
	`BUG_ON
(!
	`ext4_has_ã©u»_´ojeù
(
šode
->
i_sb
) &&

5314 
i_´ojid
 !ğ
EXT4_DEF_PROJID
);

5316 ià(
	`EXT4_INODE_SIZE
(
šode
->
i_sb
è> 
EXT4_GOOD_OLD_INODE_SIZE
 &&

5317 
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_´ojid
))

5318 
¿w_šode
->
i_´ojid
 = 
	`ıu_to_Ë32
(i_projid);

5320 
	`ext4_šode_csum_£t
(
šode
, 
¿w_šode
, 
ei
);

5321 
	`¥š_uÆock
(&
ei
->
i_¿w_lock
);

5322 ià(
šode
->
i_sb
->
s_æags
 & 
MS_LAZYTIME
)

5323 
	`ext4_upd©e_Ùh”_šodes_time
(
šode
->
i_sb
, inode->
i_šo
,

5324 
bh
->
b_d©a
);

5326 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

5327 
rc
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

5328 ià(!
”r
)

5329 
”r
 = 
rc
;

5330 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
);

5331 ià(
£t_Ïrge_fe
) {

5332 
	`BUFFER_TRACE
(
	`EXT4_SB
(
sb
)->
s_sbh
, "get write‡ccess");

5333 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
	`EXT4_SB
(
sb
)->
s_sbh
);

5334 ià(
”r
)

5335 
out_b»l£
;

5336 
	`ext4_upd©e_dyÇmic_»v
(
sb
);

5337 
	`ext4_£t_ã©u»_Ïrge_fe
(
sb
);

5338 
	`ext4_hªdË_sync
(
hªdË
);

5339 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

5341 
	`ext4_upd©e_šode_fsync_Œªs
(
hªdË
, 
šode
, 
Ãed_d©async
);

5342 
out_b»l£
:

5343 
	`b»l£
(
bh
);

5344 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

5345  
”r
;

5346 
	}
}

5382 
	$ext4_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒŞ
 *
wbc
)

5384 
”r
;

5386 ià(
	`WARN_ON_ONCE
(
cu¼’t
->
æags
 & 
PF_MEMALLOC
))

5389 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
) {

5390 ià(
	`ext4_jouº®_cu¼’t_hªdË
()) {

5391 
	`jbd_debug
(1, "called„ecursively,‚on-PF_MEMALLOC!\n");

5392 
	`dump_¡ack
();

5393  -
EIO
;

5401 ià(
wbc
->
sync_mode
 !ğ
WB_SYNC_ALL
 || wbc->
fÜ_sync
)

5404 
”r
 = 
	`ext4_fc_async_comm™_šode
(
	`EXT4_SB
(
šode
->
i_sb
)

5405 ->
s_jouº®
,

5406 
	`EXT4_I
(
šode
)->
i_sync_tid
,

5407 
šode
);

5409 
ext4_oc
 
oc
;

5411 
”r
 = 
	`__ext4_g‘_šode_loc_nošmem
(
šode
, &
oc
);

5412 ià(
”r
)

5413  
”r
;

5418 ià(
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 && !wbc->
fÜ_sync
)

5419 
	`sync_dœty_bufãr
(
oc
.
bh
);

5420 ià(
	`bufãr_»q
(
oc
.
bh
è&& !
	`bufãr_u±od©e
(iloc.bh)) {

5421 
	`EXT4_ERROR_INODE_BLOCK
(
šode
, 
oc
.
bh
->
b_blockÄ
,

5423 
”r
 = -
EIO
;

5425 
	`b»l£
(
oc
.
bh
);

5427  
”r
;

5428 
	}
}

5435 
	$ext4_wa™_fÜ__·ge_comm™
(
šode
 *inode)

5437 
·ge
 *page;

5438 
off£t
;

5439 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
;

5440 
tid_t
 
comm™_tid
 = 0;

5441 
»t
;

5443 
off£t
 = 
šode
->
i_size
 & (
PAGE_SIZE
 - 1);

5449 ià(
off£t
 > 
PAGE_SIZE
 - 
	`i_blocksize
(
šode
))

5452 
·ge
 = 
	`fšd_lock_·ge
(
šode
->
i_m­pšg
,

5453 
šode
->
i_size
 >> 
PAGE_SHIFT
);

5454 ià(!
·ge
)

5456 
»t
 = 
	`__ext4_jouº®Ëd_šv®id©•age
(
·ge
, 
off£t
,

5457 
PAGE_SIZE
 - 
off£t
);

5458 
	`uÆock_·ge
(
·ge
);

5459 
	`put_·ge
(
·ge
);

5460 ià(
»t
 !ğ-
EBUSY
)

5462 
comm™_tid
 = 0;

5463 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

5464 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

5465 
comm™_tid
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

5466 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

5467 ià(
comm™_tid
)

5468 
	`jbd2_log_wa™_comm™
(
jouº®
, 
comm™_tid
);

5470 
	}
}

5496 
	$ext4_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
)

5498 
šode
 *šodğ
	`d_šode
(
d’Œy
);

5499 
”rÜ
, 
rc
 = 0;

5500 
Üphª
 = 0;

5501 cÚ¡ 
Ÿ_v®id
 = 
©Œ
->ia_valid;

5503 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

5504  -
EIO
;

5506 
”rÜ
 = 
	`£‰r_´•¬e
(
d’Œy
, 
©Œ
);

5507 ià(
”rÜ
)

5508  
”rÜ
;

5510 ià(
	`is_quÙa_modifiÿtiÚ
(
šode
, 
©Œ
)) {

5511 
”rÜ
 = 
	`dquÙ_š™Ÿlize
(
šode
);

5512 ià(
”rÜ
)

5513  
”rÜ
;

5515 ià((
Ÿ_v®id
 & 
ATTR_UID
 && !
	`uid_eq
(
©Œ
->
Ÿ_uid
, 
šode
->
i_uid
)) ||

5516 (
Ÿ_v®id
 & 
ATTR_GID
 && !
	`gid_eq
(
©Œ
->
Ÿ_gid
, 
šode
->
i_gid
))) {

5517 
hªdË_t
 *
hªdË
;

5521 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
,

5522 (
	`EXT4_MAXQUOTAS_INIT_BLOCKS
(
šode
->
i_sb
) +

5523 
	`EXT4_MAXQUOTAS_DEL_BLOCKS
(
šode
->
i_sb
)) + 3);

5524 ià(
	`IS_ERR
(
hªdË
)) {

5525 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

5526 
”r_out
;

5532 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

5533 
”rÜ
 = 
	`dquÙ_Œªsãr
(
šode
, 
©Œ
);

5534 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

5536 ià(
”rÜ
) {

5537 
	`ext4_jouº®_¡İ
(
hªdË
);

5538  
”rÜ
;

5542 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_UID
)

5543 
šode
->
i_uid
 = 
©Œ
->
Ÿ_uid
;

5544 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_GID
)

5545 
šode
->
i_gid
 = 
©Œ
->
Ÿ_gid
;

5546 
”rÜ
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5547 
	`ext4_fc_Œack_šode
(
šode
);

5548 
	`ext4_jouº®_¡İ
(
hªdË
);

5551 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_SIZE
) {

5552 
hªdË_t
 *
hªdË
;

5553 
loff_t
 
Şdsize
 = 
šode
->
i_size
;

5554 
shršk
 = (
©Œ
->
Ÿ_size
 <ğ
šode
->
i_size
);

5556 ià(
	`ext4_’üy±ed_šode
(
šode
)) {

5557 
”rÜ
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
);

5558 ià(
”rÜ
)

5559  
”rÜ
;

5560 ià(!
	`fsüy±_has_’üy±iÚ_key
(
šode
))

5561  -
ENOKEY
;

5564 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
))) {

5565 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

5567 ià(
©Œ
->
Ÿ_size
 > 
sbi
->
s_b™m­_maxby‹s
)

5568  -
EFBIG
;

5570 ià(!
	`S_ISREG
(
šode
->
i_mode
))

5571  -
EINVAL
;

5573 ià(
	`IS_I_VERSION
(
šode
è&& 
©Œ
->
Ÿ_size
 !ğšode->
i_size
)

5574 
	`šode_šc_iv”siÚ
(
šode
);

5576 ià(
	`ext4_should_Üd”_d©a
(
šode
) &&

5577 (
©Œ
->
Ÿ_size
 < 
šode
->
i_size
)) {

5578 
”rÜ
 = 
	`ext4_begš_Üd”ed_Œunÿ‹
(
šode
,

5579 
©Œ
->
Ÿ_size
);

5580 ià(
”rÜ
)

5581 
”r_out
;

5583 ià(
©Œ
->
Ÿ_size
 !ğ
šode
->
i_size
) {

5584 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 3);

5585 ià(
	`IS_ERR
(
hªdË
)) {

5586 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

5587 
”r_out
;

5589 ià(
	`ext4_hªdË_v®id
(
hªdË
è&& 
shršk
) {

5590 
”rÜ
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

5591 
Üphª
 = 1;

5597 ià(!
shršk
) {

5598 
šode
->
i_mtime
 = 
	`cu¼’t_time
(inode);

5599 
šode
->
i_ùime
 = inode->
i_mtime
;

5602 ià(
shršk
)

5603 
	`ext4_fc_Œack_¿nge
(

5604 
šode
, 
©Œ
->
Ÿ_size
 >>

5605 
šode
->
i_sb
->
s_blocksize_b™s
,

5606 
Şdsize
 >>

5607 
šode
->
i_sb
->
s_blocksize_b™s
);

5609 
	`ext4_fc_Œack_¿nge
(

5610 
šode
, 
Şdsize
 >>

5611 
šode
->
i_sb
->
s_blocksize_b™s
,

5612 
©Œ
->
Ÿ_size
 >>

5613 
šode
->
i_sb
->
s_blocksize_b™s
);

5615 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5616 
	`EXT4_I
(
šode
)->
i_disksize
 = 
©Œ
->
Ÿ_size
;

5617 
rc
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5618 ià(!
”rÜ
)

5619 
”rÜ
 = 
rc
;

5625 ià(!
”rÜ
)

5626 
	`i_size_wr™e
(
šode
, 
©Œ
->
Ÿ_size
);

5627 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

5628 
	`ext4_jouº®_¡İ
(
hªdË
);

5629 ià(
”rÜ
) {

5630 ià(
Üphª
)

5631 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

5632 
”r_out
;

5635 ià(!
shršk
)

5636 
	`·geÿche_isize_ex‹nded
(
šode
, 
Şdsize
, inode->
i_size
);

5643 ià(
Üphª
) {

5644 ià(!
	`ext4_should_jouº®_d©a
(
šode
)) {

5645 
	`ext4_šode_block_uÆocked_dio
(
šode
);

5646 
	`šode_dio_wa™
(
šode
);

5647 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

5649 
	`ext4_wa™_fÜ__·ge_comm™
(
šode
);

5651 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5656 
	`Œunÿ‹_·geÿche
(
šode
, inode->
i_size
);

5657 ià(
shršk
) {

5658 
rc
 = 
	`ext4_Œunÿ‹
(
šode
);

5659 ià(
rc
)

5660 
”rÜ
 = 
rc
;

5662 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

5665 ià(!
”rÜ
) {

5666 
	`£‰r_cİy
(
šode
, 
©Œ
);

5667 
	`ext4_fc_Œack_šode
(
šode
);

5668 
	`m¬k_šode_dœty
(
šode
);

5675 ià(
Üphª
 && 
šode
->
i_Æšk
)

5676 
	`ext4_Üphª_d–
(
NULL
, 
šode
);

5678 ià(!
”rÜ
 && (
Ÿ_v®id
 & 
ATTR_MODE
))

5679 
rc
 = 
	`posix_aş_chmod
(
šode
, inode->
i_mode
);

5681 
”r_out
:

5682 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”rÜ
);

5683 ià(!
”rÜ
)

5684 
”rÜ
 = 
rc
;

5685  
”rÜ
;

5686 
	}
}

5688 
	$ext4_g‘©Œ
(cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

5689 
u32
 
»que¡_mask
, 
qu”y_æags
)

5691 
šode
 *šodğ
	`d_šode
(
·th
->
d’Œy
);

5692 
ext4_šode
 *
¿w_šode
;

5693 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

5694 
æags
;

5696 ià(
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_ütime
)) {

5697 
¡©
->
»suÉ_mask
 |ğ
STATX_BTIME
;

5698 
¡©
->
btime
.
tv_£c
 = 
ei
->
i_ütime
.tv_sec;

5699 
¡©
->
btime
.
tv_n£c
 = 
ei
->
i_ütime
.tv_nsec;

5702 
æags
 = 
ei
->
i_æags
 & 
EXT4_FL_USER_VISIBLE
;

5703 ià(
æags
 & 
EXT4_APPEND_FL
)

5704 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_APPEND
;

5705 ià(
æags
 & 
EXT4_COMPR_FL
)

5706 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_COMPRESSED
;

5707 ià(
æags
 & 
EXT4_ENCRYPT_FL
)

5708 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_ENCRYPTED
;

5709 ià(
æags
 & 
EXT4_IMMUTABLE_FL
)

5710 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_IMMUTABLE
;

5711 ià(
æags
 & 
EXT4_NODUMP_FL
)

5712 
¡©
->
©Œibu‹s
 |ğ
STATX_ATTR_NODUMP
;

5714 
¡©
->
©Œibu‹s_mask
 |ğ(
STATX_ATTR_APPEND
 |

5715 
STATX_ATTR_COMPRESSED
 |

5716 
STATX_ATTR_ENCRYPTED
 |

5717 
STATX_ATTR_IMMUTABLE
 |

5718 
STATX_ATTR_NODUMP
);

5720 
	`g’”ic_fÏ‰r
(
šode
, 
¡©
);

5722 
	}
}

5724 
	$ext4_fe_g‘©Œ
(cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

5725 
u32
 
»que¡_mask
, 
qu”y_æags
)

5727 
šode
 *šodğ
	`d_šode
(
·th
->
d’Œy
);

5728 
u64
 
d–®loc_blocks
;

5730 
	`ext4_g‘©Œ
(
·th
, 
¡©
, 
»que¡_mask
, 
qu”y_æags
);

5738 ià(
	`uÆik–y
(
	`ext4_has_šlše_d©a
(
šode
)))

5739 
¡©
->
blocks
 +ğ(¡©->
size
 + 511) >> 9;

5751 
d–®loc_blocks
 = 
	`EXT4_C2B
(
	`EXT4_SB
(
šode
->
i_sb
),

5752 
	`EXT4_I
(
šode
)->
i_»£rved_d©a_blocks
);

5753 
¡©
->
blocks
 +ğ
d–®loc_blocks
 << (
šode
->
i_sb
->
s_blocksize_b™s
 - 9);

5755 
	}
}

5757 
	$ext4_šdex_Œªs_blocks
(
šode
 *šode, 
lblocks
,

5758 
³x‹Ás
)

5760 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

5761  
	`ext4_šd_Œªs_blocks
(
šode
, 
lblocks
);

5762  
	`ext4_ext_šdex_Œªs_blocks
(
šode
, 
³x‹Ás
);

5763 
	}
}

5776 
	$ext4_m‘a_Œªs_blocks
(
šode
 *šode, 
lblocks
,

5777 
³x‹Ás
)

5779 
ext4_group_t
 
groups
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
šode
->
i_sb
);

5780 
gdpblocks
;

5781 
idxblocks
;

5782 
»t
 = 0;

5788 
idxblocks
 = 
	`ext4_šdex_Œªs_blocks
(
šode
, 
lblocks
, 
³x‹Ás
);

5790 
»t
 = 
idxblocks
;

5796 
groups
 = 
idxblocks
 + 
³x‹Ás
;

5797 
gdpblocks
 = 
groups
;

5798 ià(
groups
 > 
ngroups
)

5799 
groups
 = 
ngroups
;

5800 ià(
groups
 > 
	`EXT4_SB
(
šode
->
i_sb
)->
s_gdb_couÁ
)

5801 
gdpblocks
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_gdb_couÁ
;

5804 
»t
 +ğ
groups
 + 
gdpblocks
;

5807 
»t
 +ğ
	`EXT4_META_TRANS_BLOCKS
(
šode
->
i_sb
);

5809  
»t
;

5810 
	}
}

5822 
	$ext4_wr™•age_Œªs_blocks
(
šode
 *inode)

5824 
bµ
 = 
	`ext4_jouº®_blocks_³r_·ge
(
šode
);

5825 
»t
;

5827 
»t
 = 
	`ext4_m‘a_Œªs_blocks
(
šode
, 
bµ
, bpp);

5830 ià(
	`ext4_should_jouº®_d©a
(
šode
))

5831 
»t
 +ğ
bµ
;

5832  
»t
;

5833 
	}
}

5844 
	$ext4_chunk_Œªs_blocks
(
šode
 *šode, 
Äblocks
)

5846  
	`ext4_m‘a_Œªs_blocks
(
šode
, 
Äblocks
, 1);

5847 
	}
}

5853 
	$ext4_m¬k_oc_dœty
(
hªdË_t
 *
hªdË
,

5854 
šode
 *šode, 
ext4_oc
 *
oc
)

5856 
”r
 = 0;

5858 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

5859  -
EIO
;

5861 ià(
	`IS_I_VERSION
(
šode
))

5862 
	`šode_šc_iv”siÚ
(
šode
);

5865 
	`g‘_bh
(
oc
->
bh
);

5868 
”r
 = 
	`ext4_do_upd©e_šode
(
hªdË
, 
šode
, 
oc
);

5869 
	`put_bh
(
oc
->
bh
);

5870  
”r
;

5871 
	}
}

5879 
	$ext4_»£rve_šode_wr™e
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

5880 
ext4_oc
 *
oc
)

5882 
”r
;

5884 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

5885  -
EIO
;

5887 
”r
 = 
	`ext4_g‘_šode_loc
(
šode
, 
oc
);

5888 ià(!
”r
) {

5889 
	`BUFFER_TRACE
(
oc
->
bh
, "get_write_access");

5890 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
->
bh
);

5891 ià(
”r
) {

5892 
	`b»l£
(
oc
->
bh
);

5893 
oc
->
bh
 = 
NULL
;

5896 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

5897  
”r
;

5898 
	}
}

5900 
	$__ext4_ex·nd_exŒa_isize
(
šode
 *inode,

5901 
Ãw_exŒa_isize
,

5902 
ext4_oc
 *
oc
,

5903 
hªdË_t
 *
hªdË
, *
no_ex·nd
)

5905 
ext4_šode
 *
¿w_šode
;

5906 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

5907 
”rÜ
;

5909 
¿w_šode
 = 
	`ext4_¿w_šode
(
oc
);

5911 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

5914 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
) ||

5915 
h—d”
->
h_magic
 !ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
)) {

5916 
	`mem£t
((*)
¿w_šode
 + 
EXT4_GOOD_OLD_INODE_SIZE
 +

5917 
	`EXT4_I
(
šode
)->
i_exŒa_isize
, 0,

5918 
Ãw_exŒa_isize
 - 
	`EXT4_I
(
šode
)->
i_exŒa_isize
);

5919 
	`EXT4_I
(
šode
)->
i_exŒa_isize
 = 
Ãw_exŒa_isize
;

5924 
”rÜ
 = 
	`ext4_ex·nd_exŒa_isize_—
(
šode
, 
Ãw_exŒa_isize
,

5925 
¿w_šode
, 
hªdË
);

5926 ià(
”rÜ
) {

5930 *
no_ex·nd
 = 1;

5933  
”rÜ
;

5934 
	}
}

5940 
	$ext4_Œy_to_ex·nd_exŒa_isize
(
šode
 *inode,

5941 
Ãw_exŒa_isize
,

5942 
ext4_oc
 
oc
,

5943 
hªdË_t
 *
hªdË
)

5945 
no_ex·nd
;

5946 
”rÜ
;

5948 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
))

5949  -
EOVERFLOW
;

5960 ià(
	`ext4_hªdË_v®id
(
hªdË
) &&

5961 
	`jbd2_jouº®_ex‹nd
(
hªdË
,

5962 
	`EXT4_DATA_TRANS_BLOCKS
(
šode
->
i_sb
)) != 0)

5963  -
ENOSPC
;

5965 ià(
	`ext4_wr™e_Œylock_x©Œ
(
šode
, &
no_ex·nd
) == 0)

5966  -
EBUSY
;

5968 
”rÜ
 = 
	`__ext4_ex·nd_exŒa_isize
(
šode
, 
Ãw_exŒa_isize
, &
oc
,

5969 
hªdË
, &
no_ex·nd
);

5970 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

5972  
”rÜ
;

5973 
	}
}

5975 
	$ext4_ex·nd_exŒa_isize
(
šode
 *inode,

5976 
Ãw_exŒa_isize
,

5977 
ext4_oc
 *
oc
)

5979 
hªdË_t
 *
hªdË
;

5980 
no_ex·nd
;

5981 
”rÜ
, 
rc
;

5983 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
)) {

5984 
	`b»l£
(
oc
->
bh
);

5985  -
EOVERFLOW
;

5988 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
,

5989 
	`EXT4_DATA_TRANS_BLOCKS
(
šode
->
i_sb
));

5990 ià(
	`IS_ERR
(
hªdË
)) {

5991 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

5992 
	`b»l£
(
oc
->
bh
);

5993  
”rÜ
;

5996 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

5998 
	`BUFFER_TRACE
(
oc
.
bh
, "get_write_access");

5999 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
->
bh
);

6000 ià(
”rÜ
) {

6001 
	`b»l£
(
oc
->
bh
);

6002 
out_¡İ
;

6005 
”rÜ
 = 
	`__ext4_ex·nd_exŒa_isize
(
šode
, 
Ãw_exŒa_isize
, 
oc
,

6006 
hªdË
, &
no_ex·nd
);

6008 
rc
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, 
oc
);

6009 ià(!
”rÜ
)

6010 
”rÜ
 = 
rc
;

6012 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

6013 
out_¡İ
:

6014 
	`ext4_jouº®_¡İ
(
hªdË
);

6015  
”rÜ
;

6016 
	}
}

6031 
	$ext4_m¬k_šode_dœty
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

6033 
ext4_oc
 
oc
;

6034 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

6035 
”r
;

6037 
	`might_¦“p
();

6038 
	`Œaû_ext4_m¬k_šode_dœty
(
šode
, 
_RET_IP_
);

6039 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

6040 ià(
”r
)

6041  
”r
;

6043 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 < 
sbi
->
s_wªt_exŒa_isize
)

6044 
	`ext4_Œy_to_ex·nd_exŒa_isize
(
šode
, 
sbi
->
s_wªt_exŒa_isize
,

6045 
oc
, 
hªdË
);

6047  
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

6048 
	}
}

6068 
	$ext4_dœty_šode
(
šode
 *šode, 
æags
)

6070 
hªdË_t
 *
hªdË
;

6072 ià(
æags
 =ğ
I_DIRTY_TIME
)

6074 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 2);

6075 ià(
	`IS_ERR
(
hªdË
))

6076 
out
;

6078 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6079 
	`ext4_fc_Œack_šode
(
šode
);

6081 
	`ext4_jouº®_¡İ
(
hªdË
);

6082 
out
:

6084 
	}
}

6094 
	$ext4_pš_šode
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

6096 
ext4_oc
 
oc
;

6098 
”r
 = 0;

6099 ià(
hªdË
) {

6100 
”r
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

6101 ià(!
”r
) {

6102 
	`BUFFER_TRACE
(
oc
.
bh
, "get_write_access");

6103 
”r
 = 
	`jbd2_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
.
bh
);

6104 ià(!
”r
)

6105 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
,

6106 
NULL
,

6107 
oc
.
bh
);

6108 
	`b»l£
(
oc
.
bh
);

6111 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

6112  
”r
;

6113 
	}
}

6116 
	$ext4_chªge_šode_jouº®_æag
(
šode
 *šode, 
v®
)

6118 
jouº®_t
 *
jouº®
;

6119 
hªdË_t
 *
hªdË
;

6120 
”r
;

6121 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

6133 
jouº®
 = 
	`EXT4_JOURNAL
(
šode
);

6134 ià(!
jouº®
)

6136 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

6137  -
EROFS
;

6140 
	`ext4_šode_block_uÆocked_dio
(
šode
);

6141 
	`šode_dio_wa™
(
šode
);

6151 ià(
v®
) {

6152 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6153 
”r
 = 
	`fem­_wr™e_ªd_wa™
(
šode
->
i_m­pšg
);

6154 ià(
”r
 < 0) {

6155 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6156 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

6157  
”r
;

6161 
	`³rıu_down_wr™e
(&
sbi
->
s_jouº®_æag_rw£m
);

6162 
	`jbd2_jouº®_lock_upd©es
(
jouº®
);

6172 ià(
v®
)

6173 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_JOURNAL_DATA
);

6175 
”r
 = 
	`jbd2_jouº®_æush
(
jouº®
);

6176 ià(
”r
 < 0) {

6177 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

6178 
	`³rıu_up_wr™e
(&
sbi
->
s_jouº®_æag_rw£m
);

6179 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

6180  
”r
;

6182 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_JOURNAL_DATA
);

6184 
	`ext4_£t_aİs
(
šode
);

6189 
	`ext4_£t_šode_æags
(
šode
);

6191 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

6192 
	`³rıu_up_wr™e
(&
sbi
->
s_jouº®_æag_rw£m
);

6194 ià(
v®
)

6195 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6196 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

6200 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

6201 ià(
	`IS_ERR
(
hªdË
))

6202  
	`PTR_ERR
(
hªdË
);

6204 
	`ext4_fc_m¬k_š–igibË
(
šode
,

6205 
EXT4_FC_REASON_JOURNAL_FLAG_CHANGE
);

6206 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

6207 
	`ext4_hªdË_sync
(
hªdË
);

6208 
	`ext4_jouº®_¡İ
(
hªdË
);

6209 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

6211  
”r
;

6212 
	}
}

6214 
	$ext4_bh_unm­³d
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

6216  !
	`bufãr_m­³d
(
bh
);

6217 
	}
}

6219 
	$ext4_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
)

6221 
vm_¬—_¡ruù
 *
vma
 = 
vmf
->vma;

6222 
·ge
 *·gğ
vmf
->page;

6223 
loff_t
 
size
;

6224 
Ën
;

6225 
»t
;

6226 
fe
 *fğ
vma
->
vm_fe
;

6227 
šode
 *šodğ
	`fe_šode
(
fe
);

6228 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

6229 
hªdË_t
 *
hªdË
;

6230 
g‘_block_t
 *
g‘_block
;

6231 
»Œ›s
 = 0;

6233 
	`sb_¡¬t_·geçuÉ
(
šode
->
i_sb
);

6234 
	`fe_upd©e_time
(
vma
->
vm_fe
);

6236 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6238 
»t
 = 
	`ext4_cÚv”t_šlše_d©a
(
šode
);

6239 ià(
»t
)

6240 
out_»t
;

6243 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
) &&

6244 !
	`ext4_should_jouº®_d©a
(
šode
) &&

6245 !
	`ext4_nÚda_sw™ch
(
šode
->
i_sb
)) {

6247 
»t
 = 
	`block_·ge_mkwr™e
(
vma
, 
vmf
,

6248 
ext4_da_g‘_block_´•
);

6249 } 
»t
 =ğ-
ENOSPC
 &&

6250 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
));

6251 
out_»t
;

6254 
	`lock_·ge
(
·ge
);

6255 
size
 = 
	`i_size_»ad
(
šode
);

6257 ià(
·ge
->
m­pšg
 !ğm­pšg || 
	`·ge_off£t
Õageè> 
size
) {

6258 
	`uÆock_·ge
(
·ge
);

6259 
»t
 = 
VM_FAULT_NOPAGE
;

6260 
out
;

6263 ià(
·ge
->
šdex
 =ğ
size
 >> 
PAGE_SHIFT
)

6264 
Ën
 = 
size
 & ~
PAGE_MASK
;

6266 
Ën
 = 
PAGE_SIZE
;

6271 ià(
	`·ge_has_bufãrs
(
·ge
)) {

6272 ià(!
	`ext4_w®k_·ge_bufãrs
(
NULL
, 
	`·ge_bufãrs
(
·ge
),

6273 0, 
Ën
, 
NULL
,

6274 
ext4_bh_unm­³d
)) {

6276 
	`wa™_fÜ_¡abË_·ge
(
·ge
);

6277 
»t
 = 
VM_FAULT_LOCKED
;

6278 
out
;

6281 
	`uÆock_·ge
(
·ge
);

6283 ià(
	`ext4_should_diÜ—d_nŞock
(
šode
))

6284 
g‘_block
 = 
ext4_g‘_block_unwr™‹n
;

6286 
g‘_block
 = 
ext4_g‘_block
;

6287 
»Œy_®loc
:

6288 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_WRITE_PAGE
,

6289 
	`ext4_wr™•age_Œªs_blocks
(
šode
));

6290 ià(
	`IS_ERR
(
hªdË
)) {

6291 
»t
 = 
VM_FAULT_SIGBUS
;

6292 
out
;

6294 
»t
 = 
	`block_·ge_mkwr™e
(
vma
, 
vmf
, 
g‘_block
);

6295 ià(!
»t
 && 
	`ext4_should_jouº®_d©a
(
šode
)) {

6296 ià(
	`ext4_w®k_·ge_bufãrs
(
hªdË
, 
	`·ge_bufãrs
(
·ge
), 0,

6297 
PAGE_SIZE
, 
NULL
, 
do_jouº®_g‘_wr™e_acûss
)) {

6298 
	`uÆock_·ge
(
·ge
);

6299 
»t
 = 
VM_FAULT_SIGBUS
;

6300 
	`ext4_jouº®_¡İ
(
hªdË
);

6301 
out
;

6303 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_JDATA
);

6305 
	`ext4_jouº®_¡İ
(
hªdË
);

6306 ià(
»t
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

6307 
»Œy_®loc
;

6308 
out_»t
:

6309 
»t
 = 
	`block_·ge_mkwr™e_»tuº
(ret);

6310 
out
:

6311 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6312 
	`sb_’d_·geçuÉ
(
šode
->
i_sb
);

6313  
»t
;

6314 
	}
}

6316 
	$ext4_fem­_çuÉ
(
vm_çuÉ
 *
vmf
)

6318 
šode
 *šodğ
	`fe_šode
(
vmf
->
vma
->
vm_fe
);

6319 
”r
;

6321 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6322 
”r
 = 
	`fem­_çuÉ
(
vmf
);

6323 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

6325  
”r
;

6326 
	}
}

6336 
	$ext4_g‘_Ãxt_ex‹Á
(
šode
 *šode, 
ext4_lblk_t
 
lblk
,

6337 
m­_Ën
, 
ex‹Á_¡©us
 *
»suÉ
)

6339 
ext4_m­_blocks
 
m­
;

6340 
ex‹Á_¡©us
 
es
 = {};

6341 
»t
;

6343 
m­
.
m_lblk
 = 
lblk
;

6344 
m­
.
m_Ën
 = 
m­_Ën
;

6350 
m­
.
m_Ën
 > 0) {

6351 
»t
 = 
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0);

6352 ià(
»t
 < 0)

6353  
»t
;

6355 ià(
»t
 > 0) {

6356 
¡©us
;

6358 
	`ext4_es_¡Üe_pblock
(
»suÉ
, 
m­
.
m_pblk
);

6359 
»suÉ
->
es_lblk
 = 
m­
.
m_lblk
;

6360 
»suÉ
->
es_Ën
 = 
m­
.
m_Ën
;

6361 ià(
m­
.
m_æags
 & 
EXT4_MAP_UNWRITTEN
)

6362 
¡©us
 = 
EXTENT_STATUS_UNWRITTEN
;

6364 
¡©us
 = 
EXTENT_STATUS_WRITTEN
;

6365 
	`ext4_es_¡Üe_¡©us
(
»suÉ
, 
¡©us
);

6368 
	`ext4_es_fšd_d–ayed_ex‹Á_¿nge
(
šode
, 
m­
.
m_lblk
,

6369 
m­
.
m_lblk
 + m­.
m_Ën
 - 1,

6370 &
es
);

6372 ià(
es
.
es_Ën
 &&ƒs.
es_lblk
 < 
m­
.
m_lblk
 + m­.
m_Ën
) {

6373 
ext4_lblk_t
 
off£t
 = 0;

6375 ià(
es
.
es_lblk
 < 
lblk
)

6376 
off£t
 = 
lblk
 - 
es
.
es_lblk
;

6377 
»suÉ
->
es_lblk
 = 
es
.es_lblk + 
off£t
;

6378 
	`ext4_es_¡Üe_pblock
(
»suÉ
,

6379 
	`ext4_es_pblock
(&
es
è+ 
off£t
);

6380 
»suÉ
->
es_Ën
 = 
es
.es_ËÀ- 
off£t
;

6381 
	`ext4_es_¡Üe_¡©us
(
»suÉ
, 
	`ext4_es_¡©us
(&
es
));

6386 
m­
.
m_lblk
 +ğm­.
m_Ën
;

6387 
m­_Ën
 -ğ
m­
.
m_Ën
;

6388 
m­
.
m_Ën
 = 
m­_Ën
;

6389 
	`cÚd_»sched
();

6391 
»suÉ
->
es_Ën
 = 0;

6393 
	}
}

	@ioctl.c

10 
	~<lšux/fs.h
>

11 
	~<lšux/ÿ·b™y.h
>

12 
	~<lšux/time.h
>

13 
	~<lšux/com·t.h
>

14 
	~<lšux/mouÁ.h
>

15 
	~<lšux/fe.h
>

16 
	~<lšux/quÙaİs.h
>

17 
	~<lšux/uuid.h
>

18 
	~<lšux/uacûss.h
>

19 
	~<lšux/d–ay.h
>

20 
	~"ext4_jbd2.h
"

21 
	~"ext4.h
"

22 
	~<lšux/fsm­.h
>

23 
	~"fsm­.h
"

24 
	~<Œaû/ev’ts/ext4.h
>

34 
	$memsw­
(*
a
, *
b
, 
size_t
 
Ën
)

36 *
­
, *
bp
;

38 
­
 = (*)
a
;

39 
bp
 = (*)
b
;

40 
Ën
-- > 0) {

41 
	`sw­
(*
­
, *
bp
);

42 
­
++;

43 
bp
++;

45 
	}
}

58 
	$sw­_šode_d©a
(
šode
 *
šode1
, šod*
šode2
)

60 
loff_t
 
isize
;

61 
ext4_šode_šfo
 *
ei1
;

62 
ext4_šode_šfo
 *
ei2
;

64 
ei1
 = 
	`EXT4_I
(
šode1
);

65 
ei2
 = 
	`EXT4_I
(
šode2
);

67 
	`sw­
(
šode1
->
i_æags
, 
šode2
->i_flags);

68 
	`sw­
(
šode1
->
i_v”siÚ
, 
šode2
->i_version);

69 
	`sw­
(
šode1
->
i_blocks
, 
šode2
->i_blocks);

70 
	`sw­
(
šode1
->
i_by‹s
, 
šode2
->i_bytes);

71 
	`sw­
(
šode1
->
i_©ime
, 
šode2
->i_atime);

72 
	`sw­
(
šode1
->
i_mtime
, 
šode2
->i_mtime);

74 
	`memsw­
(
ei1
->
i_d©a
, 
ei2
->i_data, (ei1->i_data));

75 
	`sw­
(
ei1
->
i_æags
, 
ei2
->i_flags);

76 
	`sw­
(
ei1
->
i_disksize
, 
ei2
->i_disksize);

77 
	`ext4_es_»move_ex‹Á
(
šode1
, 0, 
EXT_MAX_BLOCKS
);

78 
	`ext4_es_»move_ex‹Á
(
šode2
, 0, 
EXT_MAX_BLOCKS
);

80 
isize
 = 
	`i_size_»ad
(
šode1
);

81 
	`i_size_wr™e
(
šode1
, 
	`i_size_»ad
(
šode2
));

82 
	`i_size_wr™e
(
šode2
, 
isize
);

83 
	}
}

94 
	$sw­_šode_boÙ_lßd”
(
su³r_block
 *
sb
,

95 
šode
 *inode)

97 
hªdË_t
 *
hªdË
;

98 
”r
;

99 
šode
 *
šode_bl
;

100 
ext4_šode_šfo
 *
ei_bl
;

101 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

103 ià(
šode
->
i_Æšk
 !ğ1 || !
	`S_ISREG
(šode->
i_mode
))

104  -
EINVAL
;

106 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
è|| !
	`ÿ·bË
(
CAP_SYS_ADMIN
))

107  -
EPERM
;

109 
šode_bl
 = 
	`ext4_ig‘
(
sb
, 
EXT4_BOOT_LOADER_INO
);

110 ià(
	`IS_ERR
(
šode_bl
))

111  
	`PTR_ERR
(
šode_bl
);

112 
ei_bl
 = 
	`EXT4_I
(
šode_bl
);

114 
	`fem­_æush
(
šode
->
i_m­pšg
);

115 
	`fem­_æush
(
šode_bl
->
i_m­pšg
);

119 
	`lock_two_nÚdœeùÜ›s
(
šode
, 
šode_bl
);

121 
	`Œunÿ‹_šode_·ges
(&
šode
->
i_d©a
, 0);

122 
	`Œunÿ‹_šode_·ges
(&
šode_bl
->
i_d©a
, 0);

125 
	`ext4_šode_block_uÆocked_dio
(
šode
);

126 
	`ext4_šode_block_uÆocked_dio
(
šode_bl
);

127 
	`šode_dio_wa™
(
šode
);

128 
	`šode_dio_wa™
(
šode_bl
);

130 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode_bl
, 
EXT4_HT_MOVE_EXTENTS
, 2);

131 ià(
	`IS_ERR
(
hªdË
)) {

132 
”r
 = -
EINVAL
;

133 
jouº®_”r_out
;

137 
	`ext4_doubË_down_wr™e_d©a_£m
(
šode
, 
šode_bl
);

139 ià(
šode_bl
->
i_Æšk
 == 0) {

141 
	`£t_Æšk
(
šode_bl
, 1);

142 
	`i_uid_wr™e
(
šode_bl
, 0);

143 
	`i_gid_wr™e
(
šode_bl
, 0);

144 
šode_bl
->
i_æags
 = 0;

145 
ei_bl
->
i_æags
 = 0;

146 
šode_bl
->
i_v”siÚ
 = 1;

147 
	`i_size_wr™e
(
šode_bl
, 0);

148 
šode_bl
->
i_mode
 = 
S_IFREG
;

149 ià(
	`ext4_has_ã©u»_ex‹Ás
(
sb
)) {

150 
	`ext4_£t_šode_æag
(
šode_bl
, 
EXT4_INODE_EXTENTS
);

151 
	`ext4_ext_Œ“_š™
(
hªdË
, 
šode_bl
);

153 
	`mem£t
(
ei_bl
->
i_d©a
, 0, (ei_bl->i_data));

156 
	`sw­_šode_d©a
(
šode
, 
šode_bl
);

158 
šode
->
i_ùime
 = 
šode_bl
->i_ùimğ
	`cu¼’t_time
(inode);

160 
	`¥š_lock
(&
sbi
->
s_Ãxt_g’_lock
);

161 
šode
->
i_g’”©iÚ
 = 
sbi
->
s_Ãxt_g’”©iÚ
++;

162 
šode_bl
->
i_g’”©iÚ
 = 
sbi
->
s_Ãxt_g’”©iÚ
++;

163 
	`¥š_uÆock
(&
sbi
->
s_Ãxt_g’_lock
);

165 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

167 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
)

168 
	`ext4_fc_di§bË
(
sb
, 
EXT4_FC_REASON_SWAP_BOOT
);

169 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

170 ià(
”r
 < 0) {

171 
	`ext4_w¬nšg
(
šode
->
i_sb
,

173 
šode
->
i_šo
, 
”r
);

175 
	`sw­_šode_d©a
(
šode
, 
šode_bl
);

177 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode_bl
);

178 ià(
”r
 < 0) {

179 
	`ext4_w¬nšg
(
šode_bl
->
i_sb
,

181 
šode_bl
->
i_šo
, 
”r
);

183 
	`sw­_šode_d©a
(
šode
, 
šode_bl
);

184 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

187 
	`ext4_jouº®_¡İ
(
hªdË
);

188 
	`ext4_doubË_up_wr™e_d©a_£m
(
šode
, 
šode_bl
);

190 
jouº®_”r_out
:

191 
	`ext4_šode_»sume_uÆocked_dio
(
šode
);

192 
	`ext4_šode_»sume_uÆocked_dio
(
šode_bl
);

193 
	`uÆock_two_nÚdœeùÜ›s
(
šode
, 
šode_bl
);

194 
	`ut
(
šode_bl
);

195  
”r
;

196 
	}
}

198 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


199 
	$uuid_is_z”o
(
__u8
 
u
[16])

201 
i
;

203 
i
 = 0; i < 16; i++)

204 ià(
u
[
i
])

207 
	}
}

210 
	$ext4_ioùl_£tæags
(
šode
 *inode,

211 
æags
)

213 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

214 
hªdË_t
 *
hªdË
 = 
NULL
;

215 
”r
 = -
EPERM
, 
mig¿‹
 = 0;

216 
ext4_oc
 
oc
;

217 
Şdæags
, 
mask
, 
i
;

218 
jæag
;

221 ià(
	`ext4_is_quÙa_fe
(
šode
))

222 
æags_out
;

224 
Şdæags
 = 
ei
->
i_æags
;

227 
jæag
 = 
æags
 & 
EXT4_JOURNAL_DATA_FL
;

235 ià((
æags
 ^ 
Şdæags
è& (
EXT4_APPEND_FL
 | 
EXT4_IMMUTABLE_FL
)) {

236 ià(!
	`ÿ·bË
(
CAP_LINUX_IMMUTABLE
))

237 
æags_out
;

244 ià((
jæag
 ^ 
Şdæags
è& (
EXT4_JOURNAL_DATA_FL
)) {

245 ià(!
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

246 
æags_out
;

248 ià((
æags
 ^ 
Şdæags
è& 
EXT4_EXTENTS_FL
)

249 
mig¿‹
 = 1;

251 ià(
æags
 & 
EXT4_EOFBLOCKS_FL
) {

253 ià(!(
Şdæags
 & 
EXT4_EOFBLOCKS_FL
)) {

254 
”r
 = -
EOPNOTSUPP
;

255 
æags_out
;

257 } ià(
Şdæags
 & 
EXT4_EOFBLOCKS_FL
) {

258 
”r
 = 
	`ext4_Œunÿ‹
(
šode
);

259 ià(
”r
)

260 
æags_out
;

263 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

264 ià(
	`IS_ERR
(
hªdË
)) {

265 
”r
 = 
	`PTR_ERR
(
hªdË
);

266 
æags_out
;

268 ià(
	`IS_SYNC
(
šode
))

269 
	`ext4_hªdË_sync
(
hªdË
);

270 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

271 ià(
”r
)

272 
æags_”r
;

274 
i
 = 0, 
mask
 = 1; i < 32; i++, mask <<= 1) {

275 ià(!(
mask
 & 
EXT4_FL_USER_MODIFIABLE
))

278 ià(
mask
 =ğ
EXT4_JOURNAL_DATA_FL
 || mask =ğ
EXT4_EXTENTS_FL
)

280 ià(
mask
 & 
æags
)

281 
	`ext4_£t_šode_æag
(
šode
, 
i
);

283 
	`ext4_ş—r_šode_æag
(
šode
, 
i
);

286 
	`ext4_£t_šode_æags
(
šode
);

287 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

289 
”r
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

290 
	`ext4_fc_Œack_šode
(
šode
);

292 
æags_”r
:

293 
	`ext4_jouº®_¡İ
(
hªdË
);

294 ià(
”r
)

295 
æags_out
;

297 ià((
jæag
 ^ 
Şdæags
è& (
EXT4_JOURNAL_DATA_FL
))

298 
”r
 = 
	`ext4_chªge_šode_jouº®_æag
(
šode
, 
jæag
);

299 ià(
”r
)

300 
æags_out
;

301 ià(
mig¿‹
) {

302 ià(
æags
 & 
EXT4_EXTENTS_FL
)

303 
”r
 = 
	`ext4_ext_mig¿‹
(
šode
);

305 
”r
 = 
	`ext4_šd_mig¿‹
(
šode
);

308 
æags_out
:

309  
”r
;

310 
	}
}

312 #ifdeà
CONFIG_QUOTA


313 
	$ext4_ioùl_£rojeù
(
fe
 *
fp
, 
__u32
 
´ojid
)

315 
šode
 *šodğ
	`fe_šode
(
fp
);

316 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

317 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

318 
”r
, 
rc
;

319 
hªdË_t
 *
hªdË
;

320 
k´ojid_t
 
k´ojid
;

321 
ext4_oc
 
oc
;

322 
ext4_šode
 *
¿w_šode
;

323 
dquÙ
 *
Œªsãr_to
[
MAXQUOTAS
] = { };

325 ià(!
	`ext4_has_ã©u»_´ojeù
(
sb
)) {

326 ià(
´ojid
 !ğ
EXT4_DEF_PROJID
)

327  -
EOPNOTSUPP
;

332 ià(
	`EXT4_INODE_SIZE
(
sb
è<ğ
EXT4_GOOD_OLD_INODE_SIZE
)

333  -
EOPNOTSUPP
;

335 
k´ojid
 = 
	`make_k´ojid
(&
š™_u£r_ns
, (
´ojid_t
)
´ojid
);

337 ià(
	`´ojid_eq
(
k´ojid
, 
	`EXT4_I
(
šode
)->
i_´ojid
))

340 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

341 ià(
”r
)

342  
”r
;

344 
”r
 = -
EPERM
;

345 
	`šode_lock
(
šode
);

347 ià(
	`ext4_is_quÙa_fe
(
šode
))

348 
out_uÆock
;

350 
”r
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

351 ià(
”r
)

352 
out_uÆock
;

354 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

355 ià(!
	`EXT4_FITS_IN_INODE
(
¿w_šode
, 
ei
, 
i_´ojid
)) {

356 
”r
 = 
	`ext4_ex·nd_exŒa_isize
(
šode
,

357 
	`EXT4_SB
(
sb
)->
s_wªt_exŒa_isize
,

358 &
oc
);

359 ià(
”r
)

360 
out_uÆock
;

362 
	`b»l£
(
oc
.
bh
);

365 
	`dquÙ_š™Ÿlize
(
šode
);

367 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
,

368 
	`EXT4_QUOTA_INIT_BLOCKS
(
sb
) +

369 
	`EXT4_QUOTA_DEL_BLOCKS
(
sb
) + 3);

370 ià(
	`IS_ERR
(
hªdË
)) {

371 
”r
 = 
	`PTR_ERR
(
hªdË
);

372 
out_uÆock
;

375 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

376 ià(
”r
)

377 
out_¡İ
;

379 
Œªsãr_to
[
PRJQUOTA
] = 
	`dqg‘
(
sb
, 
	`make_kqid_´ojid
(
k´ojid
));

380 ià(!
	`IS_ERR
(
Œªsãr_to
[
PRJQUOTA
])) {

385 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

386 
”r
 = 
	`__dquÙ_Œªsãr
(
šode
, 
Œªsãr_to
);

387 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

388 
	`dqput
(
Œªsãr_to
[
PRJQUOTA
]);

389 ià(
”r
)

390 
out_dœty
;

393 
	`EXT4_I
(
šode
)->
i_´ojid
 = 
k´ojid
;

394 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

395 
out_dœty
:

396 
rc
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

397 ià(!
”r
)

398 
”r
 = 
rc
;

399 
out_¡İ
:

400 
	`ext4_jouº®_¡İ
(
hªdË
);

401 
out_uÆock
:

402 
	`šode_uÆock
(
šode
);

403 
	`mÁ_drİ_wr™e_fe
(
fp
);

404  
”r
;

405 
	}
}

407 
	$ext4_ioùl_£rojeù
(
fe
 *
fp
, 
__u32
 
´ojid
)

409 ià(
´ojid
 !ğ
EXT4_DEF_PROJID
)

410  -
EOPNOTSUPP
;

412 
	}
}

416 
šlše
 
__u32
 
	$ext4_iæags_to_xæags
(
iæags
)

418 
__u32
 
xæags
 = 0;

420 ià(
iæags
 & 
EXT4_SYNC_FL
)

421 
xæags
 |ğ
FS_XFLAG_SYNC
;

422 ià(
iæags
 & 
EXT4_IMMUTABLE_FL
)

423 
xæags
 |ğ
FS_XFLAG_IMMUTABLE
;

424 ià(
iæags
 & 
EXT4_APPEND_FL
)

425 
xæags
 |ğ
FS_XFLAG_APPEND
;

426 ià(
iæags
 & 
EXT4_NODUMP_FL
)

427 
xæags
 |ğ
FS_XFLAG_NODUMP
;

428 ià(
iæags
 & 
EXT4_NOATIME_FL
)

429 
xæags
 |ğ
FS_XFLAG_NOATIME
;

430 ià(
iæags
 & 
EXT4_PROJINHERIT_FL
)

431 
xæags
 |ğ
FS_XFLAG_PROJINHERIT
;

432  
xæags
;

433 
	}
}

435 
	#EXT4_SUPPORTED_FS_XFLAGS
 (
FS_XFLAG_SYNC
 | 
FS_XFLAG_IMMUTABLE
 | \

436 
FS_XFLAG_APPEND
 | 
FS_XFLAG_NODUMP
 | \

437 
FS_XFLAG_NOATIME
 | 
FS_XFLAG_PROJINHERIT
)

	)

440 
šlše
 
	$ext4_xæags_to_iæags
(
__u32
 
xæags
)

442 
iæags
 = 0;

444 ià(
xæags
 & 
FS_XFLAG_SYNC
)

445 
iæags
 |ğ
EXT4_SYNC_FL
;

446 ià(
xæags
 & 
FS_XFLAG_IMMUTABLE
)

447 
iæags
 |ğ
EXT4_IMMUTABLE_FL
;

448 ià(
xæags
 & 
FS_XFLAG_APPEND
)

449 
iæags
 |ğ
EXT4_APPEND_FL
;

450 ià(
xæags
 & 
FS_XFLAG_NODUMP
)

451 
iæags
 |ğ
EXT4_NODUMP_FL
;

452 ià(
xæags
 & 
FS_XFLAG_NOATIME
)

453 
iæags
 |ğ
EXT4_NOATIME_FL
;

454 ià(
xæags
 & 
FS_XFLAG_PROJINHERIT
)

455 
iæags
 |ğ
EXT4_PROJINHERIT_FL
;

457  
iæags
;

458 
	}
}

460 
	$ext4_shutdown
(
su³r_block
 *
sb
, 
¬g
)

462 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

463 
__u32
 
æags
;

465 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

466  -
EPERM
;

468 ià(
	`g‘_u£r
(
æags
, (
__u32
 
__u£r
 *)
¬g
))

469  -
EFAULT
;

471 ià(
æags
 > 
EXT4_GOING_FLAGS_NOLOGFLUSH
)

472  -
EINVAL
;

474 ià(
	`ext4_fÜûd_shutdown
(
sbi
))

477 
	`ext4_msg
(
sb
, 
KERN_ALERT
, "shuˆdowÀ»que¡ed (%d)", 
æags
);

479 
æags
) {

480 
EXT4_GOING_FLAGS_DEFAULT
:

481 
	`ä“ze_bdev
(
sb
->
s_bdev
);

482 
	`£t_b™
(
EXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_ext4_æags
);

483 
	`thaw_bdev
(
sb
->
s_bdev
, sb);

485 
EXT4_GOING_FLAGS_LOGFLUSH
:

486 
	`£t_b™
(
EXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_ext4_æags
);

487 ià(
sbi
->
s_jouº®
 && !
	`is_jouº®_abÜ‹d
(sbi->s_journal)) {

488 (è
	`ext4_fÜû_comm™
(
sb
);

489 
	`jbd2_jouº®_abÜt
(
sbi
->
s_jouº®
, 0);

492 
EXT4_GOING_FLAGS_NOLOGFLUSH
:

493 
	`£t_b™
(
EXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_ext4_æags
);

494 ià(
sbi
->
s_jouº®
 && !
	`is_jouº®_abÜ‹d
(sbi->s_journal)) {

495 
	`m¦“p
(100);

496 
	`jbd2_jouº®_abÜt
(
sbi
->
s_jouº®
, 0);

500  -
EINVAL
;

502 
	`ş—r_İt
(
sb
, 
DISCARD
);

504 
	}
}

506 
	sg‘fsm­_šfo
 {

507 
su³r_block
 *
	mgi_sb
;

508 
fsm­_h—d
 
__u£r
 *
	mgi_d©a
;

509 
	mgi_idx
;

510 
__u32
 
	mgi_Ï¡_æags
;

513 
	$ext4_g‘fsm­_fÜm©
(
ext4_fsm­
 *
xfm
, *
´iv
)

515 
g‘fsm­_šfo
 *
šfo
 = 
´iv
;

516 
fsm­
 
fm
;

518 
	`Œaû_ext4_g‘fsm­_m­pšg
(
šfo
->
gi_sb
, 
xfm
);

520 
šfo
->
gi_Ï¡_æags
 = 
xfm
->
fmr_æags
;

521 
	`ext4_fsm­_äom_š‹º®
(
šfo
->
gi_sb
, &
fm
, 
xfm
);

522 ià(
	`cİy_to_u£r
(&
šfo
->
gi_d©a
->
fmh_»cs
[šfo->
gi_idx
++], &
fm
,

523 (
fsm­
)))

524  -
EFAULT
;

527 
	}
}

529 
	$ext4_ioc_g‘fsm­
(
su³r_block
 *
sb
,

530 
fsm­_h—d
 
__u£r
 *
¬g
)

532 
g‘fsm­_šfo
 
šfo
 = {0};

533 
ext4_fsm­_h—d
 
xh—d
 = {0};

534 
fsm­_h—d
 
h—d
;

535 
boŞ
 
abÜ‹d
 = 
çl£
;

536 
”rÜ
;

538 ià(
	`cİy_äom_u£r
(&
h—d
, 
¬g
, (
fsm­_h—d
)))

539  -
EFAULT
;

540 ià(
	`memchr_šv
(
h—d
.
fmh_»£rved
, 0, (head.fmh_reserved)) ||

541 
	`memchr_šv
(
h—d
.
fmh_keys
[0].
fmr_»£rved
, 0,

542 (
h—d
.
fmh_keys
[0].
fmr_»£rved
)) ||

543 
	`memchr_šv
(
h—d
.
fmh_keys
[1].
fmr_»£rved
, 0,

544 (
h—d
.
fmh_keys
[1].
fmr_»£rved
)))

545  -
EINVAL
;

550 ià(
h—d
.
fmh_keys
[0].
fmr_off£t
 ||

551 (
h—d
.
fmh_keys
[1].
fmr_off£t
 != 0 &&

552 
h—d
.
fmh_keys
[1].
fmr_off£t
 != -1ULL))

553  -
EINVAL
;

555 
xh—d
.
fmh_iæags
 = 
h—d
.fmh_iflags;

556 
xh—d
.
fmh_couÁ
 = 
h—d
.fmh_count;

557 
	`ext4_fsm­_to_š‹º®
(
sb
, &
xh—d
.
fmh_keys
[0], &
h—d
.fmh_keys[0]);

558 
	`ext4_fsm­_to_š‹º®
(
sb
, &
xh—d
.
fmh_keys
[1], &
h—d
.fmh_keys[1]);

560 
	`Œaû_ext4_g‘fsm­_low_key
(
sb
, &
xh—d
.
fmh_keys
[0]);

561 
	`Œaû_ext4_g‘fsm­_high_key
(
sb
, &
xh—d
.
fmh_keys
[1]);

563 
šfo
.
gi_sb
 = 
sb
;

564 
šfo
.
gi_d©a
 = 
¬g
;

565 
”rÜ
 = 
	`ext4_g‘fsm­
(
sb
, &
xh—d
, 
ext4_g‘fsm­_fÜm©
, &
šfo
);

566 ià(
”rÜ
 =ğ
EXT4_QUERY_RANGE_ABORT
) {

567 
”rÜ
 = 0;

568 
abÜ‹d
 = 
Œue
;

569 } ià(
”rÜ
)

570  
”rÜ
;

573 ià(!
abÜ‹d
 && 
šfo
.
gi_idx
) {

574 
šfo
.
gi_Ï¡_æags
 |ğ
FMR_OF_LAST
;

575 ià(
	`cİy_to_u£r
(&
šfo
.
gi_d©a
->
fmh_»cs
[šfo.
gi_idx
 - 1].
fmr_æags
,

576 &
šfo
.
gi_Ï¡_æags
,

577 (
šfo
.
gi_Ï¡_æags
)))

578  -
EFAULT
;

582 
h—d
.
fmh_’Œ›s
 = 
xh—d
.fmh_entries;

583 
h—d
.
fmh_oæags
 = 
xh—d
.fmh_oflags;

584 ià(
	`cİy_to_u£r
(
¬g
, &
h—d
, (
fsm­_h—d
)))

585  -
EFAULT
;

588 
	}
}

590 
	$ext4_ioùl
(
fe
 *
fp
, 
cmd
, 
¬g
)

592 
šode
 *šodğ
	`fe_šode
(
fp
);

593 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

594 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

595 
æags
;

597 
	`ext4_debug
("cmd = %u,‡rg = %lu\n", 
cmd
, 
¬g
);

599 
cmd
) {

600 
FS_IOC_GETFSMAP
:

601  
	`ext4_ioc_g‘fsm­
(
sb
, (
__u£r
 *)
¬g
);

602 
EXT4_IOC_GETFLAGS
:

603 
æags
 = 
ei
->
i_æags
 & 
EXT4_FL_USER_VISIBLE
;

604  
	`put_u£r
(
æags
, (
__u£r
 *è
¬g
);

605 
EXT4_IOC_SETFLAGS
: {

606 
”r
;

608 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

609  -
EACCES
;

611 ià(
	`g‘_u£r
(
æags
, (
__u£r
 *è
¬g
))

612  -
EFAULT
;

614 ià(
æags
 & ~
EXT4_FL_USER_VISIBLE
)

615  -
EOPNOTSUPP
;

622 
æags
 &ğ
EXT4_FL_USER_MODIFIABLE
;

623 ià(
	`ext4_mask_æags
(
šode
->
i_mode
, 
æags
) != flags)

624  -
EOPNOTSUPP
;

626 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

627 ià(
”r
)

628  
”r
;

630 
	`šode_lock
(
šode
);

631 
”r
 = 
	`ext4_ioùl_£tæags
(
šode
, 
æags
);

632 
	`šode_uÆock
(
šode
);

633 
	`mÁ_drİ_wr™e_fe
(
fp
);

634  
”r
;

636 
EXT4_IOC_GETVERSION
:

637 
EXT4_IOC_GETVERSION_OLD
:

638  
	`put_u£r
(
šode
->
i_g’”©iÚ
, (
__u£r
 *è
¬g
);

639 
EXT4_IOC_SETVERSION
:

640 
EXT4_IOC_SETVERSION_OLD
: {

641 
hªdË_t
 *
hªdË
;

642 
ext4_oc
 
oc
;

643 
__u32
 
g’”©iÚ
;

644 
”r
;

646 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

647  -
EPERM
;

649 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
)) {

650 
	`ext4_w¬nšg
(
sb
, "Setting inode version is‚ot "

652  -
ENOTTY
;

655 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

656 ià(
”r
)

657  
”r
;

658 ià(
	`g‘_u£r
(
g’”©iÚ
, (
__u£r
 *è
¬g
)) {

659 
”r
 = -
EFAULT
;

660 
£tv”siÚ_out
;

663 
	`šode_lock
(
šode
);

664 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_INODE
, 1);

665 ià(
	`IS_ERR
(
hªdË
)) {

666 
”r
 = 
	`PTR_ERR
(
hªdË
);

667 
uÆock_out
;

669 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

670 ià(
”r
 == 0) {

671 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

672 
šode
->
i_g’”©iÚ
 = 
g’”©iÚ
;

673 
”r
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

675 
	`ext4_jouº®_¡İ
(
hªdË
);

677 
uÆock_out
:

678 
	`šode_uÆock
(
šode
);

679 
£tv”siÚ_out
:

680 
	`mÁ_drİ_wr™e_fe
(
fp
);

681  
”r
;

683 
EXT4_IOC_GROUP_EXTEND
: {

684 
ext4_fsblk_t
 
n_blocks_couÁ
;

685 
”r
, 
”r2
=0;

687 
”r
 = 
	`ext4_»size_begš
(
sb
);

688 ià(
”r
)

689  
”r
;

691 ià(
	`g‘_u£r
(
n_blocks_couÁ
, (
__u32
 
__u£r
 *)
¬g
)) {

692 
”r
 = -
EFAULT
;

693 
group_ex‹nd_out
;

696 ià(
	`ext4_has_ã©u»_big®loc
(
sb
)) {

697 
	`ext4_msg
(
sb
, 
KERN_ERR
,

699 
”r
 = -
EOPNOTSUPP
;

700 
group_ex‹nd_out
;

703 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

704 ià(
”r
)

705 
group_ex‹nd_out
;

707 
”r
 = 
	`ext4_group_ex‹nd
(
sb
, 
	`EXT4_SB
(sb)->
s_es
, 
n_blocks_couÁ
);

708 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

709 
	`jbd2_jouº®_lock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

710 
”r2
 = 
	`jbd2_jouº®_æush
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

711 
	`jbd2_jouº®_uÆock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

713 ià(
”r
 == 0)

714 
”r
 = 
”r2
;

715 
	`mÁ_drİ_wr™e_fe
(
fp
);

716 
group_ex‹nd_out
:

717 
	`ext4_»size_’d
(
sb
);

718  
”r
;

721 
EXT4_IOC_MOVE_EXT
: {

722 
move_ex‹Á
 
me
;

723 
fd
 
dÚÜ
;

724 
”r
;

726 ià(!(
fp
->
f_mode
 & 
FMODE_READ
) ||

727 !(
fp
->
f_mode
 & 
FMODE_WRITE
))

728  -
EBADF
;

730 ià(
	`cİy_äom_u£r
(&
me
,

731 (
move_ex‹Á
 
__u£r
 *)
¬g
, (
me
)))

732  -
EFAULT
;

733 
me
.
moved_Ën
 = 0;

735 
dÚÜ
 = 
	`fdg‘
(
me
.
dÚÜ_fd
);

736 ià(!
dÚÜ
.
fe
)

737  -
EBADF
;

739 ià(!(
dÚÜ
.
fe
->
f_mode
 & 
FMODE_WRITE
)) {

740 
”r
 = -
EBADF
;

741 
mext_out
;

744 ià(
	`ext4_has_ã©u»_big®loc
(
sb
)) {

745 
	`ext4_msg
(
sb
, 
KERN_ERR
,

747 
”r
 = -
EOPNOTSUPP
;

748 
mext_out
;

749 } ià(
	`IS_DAX
(
šode
)) {

750 
	`ext4_msg
(
sb
, 
KERN_ERR
,

752 
”r
 = -
EOPNOTSUPP
;

753 
mext_out
;

756 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

757 ià(
”r
)

758 
mext_out
;

760 
”r
 = 
	`ext4_move_ex‹Ás
(
fp
, 
dÚÜ
.
fe
, 
me
.
Üig_¡¬t
,

761 
me
.
dÚÜ_¡¬t
, me.
Ën
, &me.
moved_Ën
);

762 
	`mÁ_drİ_wr™e_fe
(
fp
);

764 ià(
	`cİy_to_u£r
((
move_ex‹Á
 
__u£r
 *)
¬g
,

765 &
me
, (me)))

766 
”r
 = -
EFAULT
;

767 
mext_out
:

768 
	`fdput
(
dÚÜ
);

769  
”r
;

772 
EXT4_IOC_GROUP_ADD
: {

773 
ext4_Ãw_group_d©a
 
šput
;

774 
”r
, 
”r2
=0;

776 
”r
 = 
	`ext4_»size_begš
(
sb
);

777 ià(
”r
)

778  
”r
;

780 ià(
	`cİy_äom_u£r
(&
šput
, (
ext4_Ãw_group_šput
 
__u£r
 *)
¬g
,

781 (
šput
))) {

782 
”r
 = -
EFAULT
;

783 
group_add_out
;

786 ià(
	`ext4_has_ã©u»_big®loc
(
sb
)) {

787 
	`ext4_msg
(
sb
, 
KERN_ERR
,

789 
”r
 = -
EOPNOTSUPP
;

790 
group_add_out
;

793 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

794 ià(
”r
)

795 
group_add_out
;

797 
”r
 = 
	`ext4_group_add
(
sb
, &
šput
);

798 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

799 
	`jbd2_jouº®_lock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

800 
”r2
 = 
	`jbd2_jouº®_æush
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

801 
	`jbd2_jouº®_uÆock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

803 ià(
”r
 == 0)

804 
”r
 = 
”r2
;

805 
	`mÁ_drİ_wr™e_fe
(
fp
);

806 ià(!
”r
 && 
	`ext4_has_group_desc_csum
(
sb
) &&

807 
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
))

808 
”r
 = 
	`ext4_»gi¡”_li_»que¡
(
sb
, 
šput
.
group
);

809 
group_add_out
:

810 
	`ext4_»size_’d
(
sb
);

811  
”r
;

814 
EXT4_IOC_MIGRATE
:

816 
”r
;

817 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

818  -
EACCES
;

820 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

821 ià(
”r
)

822  
”r
;

829 
	`šode_lock
((
šode
));

830 
”r
 = 
	`ext4_ext_mig¿‹
(
šode
);

831 
	`šode_uÆock
((
šode
));

832 
	`mÁ_drİ_wr™e_fe
(
fp
);

833  
”r
;

836 
EXT4_IOC_ALLOC_DA_BLKS
:

838 
”r
;

839 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

840  -
EACCES
;

842 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

843 ià(
”r
)

844  
”r
;

845 
”r
 = 
	`ext4_®loc_da_blocks
(
šode
);

846 
	`mÁ_drİ_wr™e_fe
(
fp
);

847  
”r
;

850 
EXT4_IOC_SWAP_BOOT
:

852 
”r
;

853 ià(!(
fp
->
f_mode
 & 
FMODE_WRITE
))

854  -
EBADF
;

855 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

856 ià(
”r
)

857  
”r
;

858 
”r
 = 
	`sw­_šode_boÙ_lßd”
(
sb
, 
šode
);

859 
	`mÁ_drİ_wr™e_fe
(
fp
);

860  
”r
;

863 
EXT4_IOC_RESIZE_FS
: {

864 
ext4_fsblk_t
 
n_blocks_couÁ
;

865 
”r
 = 0, 
”r2
 = 0;

866 
ext4_group_t
 
o_group
 = 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;

868 ià(
	`ext4_has_ã©u»_big®loc
(
sb
)) {

869 
	`ext4_msg
(
sb
, 
KERN_ERR
,

871  -
EOPNOTSUPP
;

874 ià(
	`cİy_äom_u£r
(&
n_blocks_couÁ
, (
__u64
 
__u£r
 *)
¬g
,

875 (
__u64
))) {

876  -
EFAULT
;

879 
”r
 = 
	`ext4_»size_begš
(
sb
);

880 ià(
”r
)

881  
”r
;

883 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

884 ià(
”r
)

885 
»sizefs_out
;

887 
”r
 = 
	`ext4_»size_fs
(
sb
, 
n_blocks_couÁ
);

888 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

889 
	`ext4_fc_di§bË
(
sb
, 
EXT4_FC_REASON_RESIZE
);

890 
	`jbd2_jouº®_lock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

891 
”r2
 = 
	`jbd2_jouº®_æush
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

892 
	`jbd2_jouº®_uÆock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

894 ià(
”r
 == 0)

895 
”r
 = 
”r2
;

896 
	`mÁ_drİ_wr™e_fe
(
fp
);

897 ià(!
”r
 && (
o_group
 > 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
) &&

898 
	`ext4_has_group_desc_csum
(
sb
) &&

899 
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
))

900 
”r
 = 
	`ext4_»gi¡”_li_»que¡
(
sb
, 
o_group
);

902 
»sizefs_out
:

903 
	`ext4_»size_’d
(
sb
);

904  
”r
;

907 
FITRIM
:

909 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

910 
f¡rim_¿nge
 
¿nge
;

911 
»t
 = 0;

913 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

914  -
EPERM
;

916 ià(!
	`blk_queue_disÿrd
(
q
))

917  -
EOPNOTSUPP
;

919 ià(
	`cİy_äom_u£r
(&
¿nge
, (
f¡rim_¿nge
 
__u£r
 *)
¬g
,

920 (
¿nge
)))

921  -
EFAULT
;

923 
¿nge
.
mšËn
 = 
	`max
(()range.minlen,

924 
q
->
lim™s
.
disÿrd_g¿nuÏr™y
);

925 
»t
 = 
	`ext4_Œim_fs
(
sb
, &
¿nge
);

926 ià(
»t
 < 0)

927  
»t
;

929 ià(
	`cİy_to_u£r
((
f¡rim_¿nge
 
__u£r
 *)
¬g
, &
¿nge
,

930 (
¿nge
)))

931  -
EFAULT
;

935 
EXT4_IOC_PRECACHE_EXTENTS
:

936  
	`ext4_ext_´eÿche
(
šode
);

938 
EXT4_IOC_SET_ENCRYPTION_POLICY
:

939 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

940  -
EOPNOTSUPP
;

941  
	`fsüy±_ioùl_£t_pŞicy
(
fp
, (cÚ¡ 
__u£r
 *)
¬g
);

943 
EXT4_IOC_GET_ENCRYPTION_PWSALT
: {

944 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


945 
”r
, 
”r2
;

946 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

947 
hªdË_t
 *
hªdË
;

949 ià(!
	`ext4_has_ã©u»_’üy±
(
sb
))

950  -
EOPNOTSUPP
;

951 ià(
	`uuid_is_z”o
(
sbi
->
s_es
->
s_’üy±_pw_§É
)) {

952 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

953 ià(
”r
)

954  
”r
;

955 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_MISC
, 1);

956 ià(
	`IS_ERR
(
hªdË
)) {

957 
”r
 = 
	`PTR_ERR
(
hªdË
);

958 
pw§É_”r_ex™
;

960 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

961 ià(
”r
)

962 
pw§É_”r_jouº®
;

963 
	`g’”©e_¿ndom_uuid
(
sbi
->
s_es
->
s_’üy±_pw_§É
);

964 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
,

965 
sbi
->
s_sbh
);

966 
pw§É_”r_jouº®
:

967 
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

968 ià(
”r2
 && !
”r
)

969 
”r
 = 
”r2
;

970 
pw§É_”r_ex™
:

971 
	`mÁ_drİ_wr™e_fe
(
fp
);

972 ià(
”r
)

973  
”r
;

975 ià(
	`cİy_to_u£r
((
__u£r
 *è
¬g
,

976 
sbi
->
s_es
->
s_’üy±_pw_§É
, 16))

977  -
EFAULT
;

980  -
EOPNOTSUPP
;

983 
EXT4_IOC_GET_ENCRYPTION_POLICY
:

984  
	`fsüy±_ioùl_g‘_pŞicy
(
fp
, (
__u£r
 *)
¬g
);

986 
EXT4_IOC_FSGETXATTR
:

988 
fsx©Œ
 
ç
;

990 
	`mem£t
(&
ç
, 0, (
fsx©Œ
));

991 
ç
.
fsx_xæags
 = 
	`ext4_iæags_to_xæags
(
ei
->
i_æags
 & 
EXT4_FL_USER_VISIBLE
);

993 ià(
	`ext4_has_ã©u»_´ojeù
(
šode
->
i_sb
)) {

994 
ç
.
fsx_´ojid
 = (
__u32
)
	`äom_k´ojid
(&
š™_u£r_ns
,

995 
	`EXT4_I
(
šode
)->
i_´ojid
);

998 ià(
	`cİy_to_u£r
((
fsx©Œ
 
__u£r
 *)
¬g
,

999 &
ç
, (fa)))

1000  -
EFAULT
;

1003 
EXT4_IOC_FSSETXATTR
:

1005 
fsx©Œ
 
ç
;

1006 
”r
;

1008 ià(
	`cİy_äom_u£r
(&
ç
, (
fsx©Œ
 
__u£r
 *)
¬g
,

1009 (
ç
)))

1010  -
EFAULT
;

1013 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1014  -
EACCES
;

1016 ià(
ç
.
fsx_xæags
 & ~
EXT4_SUPPORTED_FS_XFLAGS
)

1017  -
EOPNOTSUPP
;

1019 
æags
 = 
	`ext4_xæags_to_iæags
(
ç
.
fsx_xæags
);

1020 ià(
	`ext4_mask_æags
(
šode
->
i_mode
, 
æags
) != flags)

1021  -
EOPNOTSUPP
;

1023 
”r
 = 
	`mÁ_wªt_wr™e_fe
(
fp
);

1024 ià(
”r
)

1025  
”r
;

1027 
	`šode_lock
(
šode
);

1028 
æags
 = (
ei
->
i_æags
 & ~
EXT4_FL_XFLAG_VISIBLE
) |

1029 (
æags
 & 
EXT4_FL_XFLAG_VISIBLE
);

1030 
”r
 = 
	`ext4_ioùl_£tæags
(
šode
, 
æags
);

1031 
	`šode_uÆock
(
šode
);

1032 
	`mÁ_drİ_wr™e_fe
(
fp
);

1033 ià(
”r
)

1034  
”r
;

1036 
”r
 = 
	`ext4_ioùl_£rojeù
(
fp
, 
ç
.
fsx_´ojid
);

1037 ià(
”r
)

1038  
”r
;

1042 
EXT4_IOC_SHUTDOWN
:

1043  
	`ext4_shutdown
(
sb
, 
¬g
);

1045  -
ENOTTY
;

1047 
	}
}

1049 #ifdeà
CONFIG_COMPAT


1050 
	$ext4_com·t_ioùl
(
fe
 *fe, 
cmd
, 
¬g
)

1053 
cmd
) {

1054 
EXT4_IOC32_GETFLAGS
:

1055 
cmd
 = 
EXT4_IOC_GETFLAGS
;

1057 
EXT4_IOC32_SETFLAGS
:

1058 
cmd
 = 
EXT4_IOC_SETFLAGS
;

1060 
EXT4_IOC32_GETVERSION
:

1061 
cmd
 = 
EXT4_IOC_GETVERSION
;

1063 
EXT4_IOC32_SETVERSION
:

1064 
cmd
 = 
EXT4_IOC_SETVERSION
;

1066 
EXT4_IOC32_GROUP_EXTEND
:

1067 
cmd
 = 
EXT4_IOC_GROUP_EXTEND
;

1069 
EXT4_IOC32_GETVERSION_OLD
:

1070 
cmd
 = 
EXT4_IOC_GETVERSION_OLD
;

1072 
EXT4_IOC32_SETVERSION_OLD
:

1073 
cmd
 = 
EXT4_IOC_SETVERSION_OLD
;

1075 
EXT4_IOC32_GETRSVSZ
:

1076 
cmd
 = 
EXT4_IOC_GETRSVSZ
;

1078 
EXT4_IOC32_SETRSVSZ
:

1079 
cmd
 = 
EXT4_IOC_SETRSVSZ
;

1081 
EXT4_IOC32_GROUP_ADD
: {

1082 
com·t_ext4_Ãw_group_šput
 
__u£r
 *
ušput
;

1083 
ext4_Ãw_group_šput
 
šput
;

1084 
mm_£gm’t_t
 
Şd_fs
;

1085 
”r
;

1087 
ušput
 = 
	`com·t_±r
(
¬g
);

1088 
”r
 = 
	`g‘_u£r
(
šput
.
group
, &
ušput
->group);

1089 
”r
 |ğ
	`g‘_u£r
(
šput
.
block_b™m­
, &
ušput
->block_bitmap);

1090 
”r
 |ğ
	`g‘_u£r
(
šput
.
šode_b™m­
, &
ušput
->inode_bitmap);

1091 
”r
 |ğ
	`g‘_u£r
(
šput
.
šode_bË
, &
ušput
->inode_table);

1092 
”r
 |ğ
	`g‘_u£r
(
šput
.
blocks_couÁ
, &
ušput
->blocks_count);

1093 
”r
 |ğ
	`g‘_u£r
(
šput
.
»£rved_blocks
,

1094 &
ušput
->
»£rved_blocks
);

1095 ià(
”r
)

1096  -
EFAULT
;

1097 
Şd_fs
 = 
	`g‘_fs
();

1098 
	`£t_fs
(
KERNEL_DS
);

1099 
”r
 = 
	`ext4_ioùl
(
fe
, 
EXT4_IOC_GROUP_ADD
,

1100 (è&
šput
);

1101 
	`£t_fs
(
Şd_fs
);

1102  
”r
;

1104 
EXT4_IOC_MOVE_EXT
:

1105 
EXT4_IOC_RESIZE_FS
:

1106 
EXT4_IOC_PRECACHE_EXTENTS
:

1107 
EXT4_IOC_SET_ENCRYPTION_POLICY
:

1108 
EXT4_IOC_GET_ENCRYPTION_PWSALT
:

1109 
EXT4_IOC_GET_ENCRYPTION_POLICY
:

1110 
EXT4_IOC_SHUTDOWN
:

1111 
FS_IOC_GETFSMAP
:

1114  -
ENOIOCTLCMD
;

1116  
	`ext4_ioùl
(
fe
, 
cmd
, (è
	`com·t_±r
(
¬g
));

1117 
	}
}

	@mballoc.c

24 
	~"ext4_jbd2.h
"

25 
	~"mb®loc.h
"

26 
	~<lšux/log2.h
>

27 
	~<lšux/moduË.h
>

28 
	~<lšux/¦ab.h
>

29 
	~<lšux/backšg-dev.h
>

30 
	~<Œaû/ev’ts/ext4.h
>

32 #ifdeà
CONFIG_EXT4_DEBUG


33 
ushÜt
 
ext4_mb®loc_debug
 
	g__»ad_mo¡ly
;

35 
moduË_·¿m_Çmed
(
mb®loc_debug
, 
ext4_mb®loc_debug
, 
ushÜt
, 0644);

36 
MODULE_PARM_DESC
(
mb®loc_debug
, "Debugging†evel forƒxt4's mballoc");

350 
kmem_ÿche
 *
	gext4_p¥aû_ÿch•
;

351 
kmem_ÿche
 *
	gext4_ac_ÿch•
;

352 
kmem_ÿche
 *
	gext4_ä“_d©a_ÿch•
;

357 
	#NR_GRPINFO_CACHES
 8

	)

358 
kmem_ÿche
 *
	gext4_groupšfo_ÿches
[
NR_GRPINFO_CACHES
];

360 cÚ¡ * cÚ¡ 
	gext4_groupšfo_¦ab_Çmes
[
NR_GRPINFO_CACHES
] = {

366 
ext4_mb_g’”©e_äom_·
(
su³r_block
 *
sb
, *
b™m­
,

367 
ext4_group_t
 
group
);

368 
ext4_mb_g’”©e_äom_ä“li¡
(
su³r_block
 *
sb
, *
b™m­
,

369 
ext4_group_t
 
group
);

371 
šlše
 *
	$mb_cÜ»ù_addr_ªd_b™
(*
b™
, *
addr
)

373 #ià
BITS_PER_LONG
 == 64

374 *
b™
 +ğ((è
addr
 & 7UL) << 3;

375 
addr
 = (*) (()‡ddr & ~7UL);

376 #–ià
BITS_PER_LONG
 == 32

377 *
b™
 +ğ((è
addr
 & 3UL) << 3;

378 
addr
 = (*) (()‡ddr & ~3UL);

382  
addr
;

383 
	}
}

385 
šlše
 
	$mb_‹¡_b™
(
b™
, *
addr
)

391 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
b™
,‡ddr);

392  
	`ext4_‹¡_b™
(
b™
, 
addr
);

393 
	}
}

395 
šlše
 
	$mb_£t_b™
(
b™
, *
addr
)

397 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
b™
,‡ddr);

398 
	`ext4_£t_b™
(
b™
, 
addr
);

399 
	}
}

401 
šlše
 
	$mb_ş—r_b™
(
b™
, *
addr
)

403 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
b™
,‡ddr);

404 
	`ext4_ş—r_b™
(
b™
, 
addr
);

405 
	}
}

407 
šlše
 
	$mb_‹¡_ªd_ş—r_b™
(
b™
, *
addr
)

409 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
b™
,‡ddr);

410  
	`ext4_‹¡_ªd_ş—r_b™
(
b™
, 
addr
);

411 
	}
}

413 
šlše
 
	$mb_fšd_Ãxt_z”o_b™
(*
addr
, 
max
, 
¡¬t
)

415 
fix
 = 0, 
»t
, 
tmpmax
;

416 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
fix
,‡ddr);

417 
tmpmax
 = 
max
 + 
fix
;

418 
¡¬t
 +ğ
fix
;

420 
»t
 = 
	`ext4_fšd_Ãxt_z”o_b™
(
addr
, 
tmpmax
, 
¡¬t
è- 
fix
;

421 ià(
»t
 > 
max
)

422  
max
;

423  
»t
;

424 
	}
}

426 
šlše
 
	$mb_fšd_Ãxt_b™
(*
addr
, 
max
, 
¡¬t
)

428 
fix
 = 0, 
»t
, 
tmpmax
;

429 
addr
 = 
	`mb_cÜ»ù_addr_ªd_b™
(&
fix
,‡ddr);

430 
tmpmax
 = 
max
 + 
fix
;

431 
¡¬t
 +ğ
fix
;

433 
»t
 = 
	`ext4_fšd_Ãxt_b™
(
addr
, 
tmpmax
, 
¡¬t
è- 
fix
;

434 ià(
»t
 > 
max
)

435  
max
;

436  
»t
;

437 
	}
}

439 *
	$mb_fšd_buddy
(
ext4_buddy
 *
e4b
, 
Üd”
, *
max
)

441 *
bb
;

443 
	`BUG_ON
(
e4b
->
bd_b™m­
 =ğe4b->
bd_buddy
);

444 
	`BUG_ON
(
max
 =ğ
NULL
);

446 ià(
Üd”
 > 
e4b
->
bd_blkb™s
 + 1) {

447 *
max
 = 0;

448  
NULL
;

452 ià(
Üd”
 == 0) {

453 *
max
 = 1 << (
e4b
->
bd_blkb™s
 + 3);

454  
e4b
->
bd_b™m­
;

457 
bb
 = 
e4b
->
bd_buddy
 + 
	`EXT4_SB
Ó4b->
bd_sb
)->
s_mb_off£ts
[
Üd”
];

458 *
max
 = 
	`EXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[
Üd”
];

460  
bb
;

461 
	}
}

463 #ifdeà
DOUBLE_CHECK


464 
	$mb_ä“_blocks_doubË
(
šode
 *šode, 
ext4_buddy
 *
e4b
,

465 
fœ¡
, 
couÁ
)

467 
i
;

468 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

470 ià(
	`uÆik–y
(
e4b
->
bd_šfo
->
bb_b™m­
 =ğ
NULL
))

472 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

473 
i
 = 0; i < 
couÁ
; i++) {

474 ià(!
	`mb_‹¡_b™
(
fœ¡
 + 
i
, 
e4b
->
bd_šfo
->
bb_b™m­
)) {

475 
ext4_fsblk_t
 
blockÄ
;

477 
blockÄ
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
e4b
->
bd_group
);

478 
blockÄ
 +ğ
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 
fœ¡
 + 
i
);

479 
	`ext4_g½_locked_”rÜ
(
sb
, 
e4b
->
bd_group
,

480 
šode
 ? inode->
i_šo
 : 0,

481 
blockÄ
,

484 
fœ¡
 + 
i
);

486 
	`mb_ş—r_b™
(
fœ¡
 + 
i
, 
e4b
->
bd_šfo
->
bb_b™m­
);

488 
	}
}

490 
	$mb_m¬k_u£d_doubË
(
ext4_buddy
 *
e4b
, 
fœ¡
, 
couÁ
)

492 
i
;

494 ià(
	`uÆik–y
(
e4b
->
bd_šfo
->
bb_b™m­
 =ğ
NULL
))

496 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
e4b
->
bd_sb
,ƒ4b->
bd_group
));

497 
i
 = 0; i < 
couÁ
; i++) {

498 
	`BUG_ON
(
	`mb_‹¡_b™
(
fœ¡
 + 
i
, 
e4b
->
bd_šfo
->
bb_b™m­
));

499 
	`mb_£t_b™
(
fœ¡
 + 
i
, 
e4b
->
bd_šfo
->
bb_b™m­
);

501 
	}
}

503 
	$mb_cmp_b™m­s
(
ext4_buddy
 *
e4b
, *
b™m­
)

505 ià(
	`memcmp
(
e4b
->
bd_šfo
->
bb_b™m­
, 
b™m­
,ƒ4b->
bd_sb
->
s_blocksize
)) {

506 *
b1
, *
b2
;

507 
i
;

508 
b1
 = (*è
e4b
->
bd_šfo
->
bb_b™m­
;

509 
b2
 = (*è
b™m­
;

510 
i
 = 0; i < 
e4b
->
bd_sb
->
s_blocksize
; i++) {

511 ià(
b1
[
i
] !ğ
b2
[i]) {

512 
	`ext4_msg
(
e4b
->
bd_sb
, 
KERN_ERR
,

516 
e4b
->
bd_group
, 
i
, i * 8, 
b1
[i], 
b2
[i]);

517 
	`BUG
();

521 
	}
}

524 
šlše
 
	$mb_ä“_blocks_doubË
(
šode
 *inode,

525 
ext4_buddy
 *
e4b
, 
fœ¡
, 
couÁ
)

528 
	}
}

529 
šlše
 
	$mb_m¬k_u£d_doubË
(
ext4_buddy
 *
e4b
,

530 
fœ¡
, 
couÁ
)

533 
	}
}

534 
šlše
 
	$mb_cmp_b™m­s
(
ext4_buddy
 *
e4b
, *
b™m­
)

537 
	}
}

540 #ifdeà
AGGRESSIVE_CHECK


542 
	#MB_CHECK_ASSERT
(
as£¹
) \

544 ià(!(
as£¹
)) { \

545 
	`´štk
(
KERN_EMERG
 \

547 
funùiÚ
, 
fe
, 
lše
, #assert); \

548 
	`BUG
(); \

550 } 0)

	)

552 
	$__mb_check_buddy
(
ext4_buddy
 *
e4b
, *
fe
,

553 cÚ¡ *
funùiÚ
, 
lše
)

555 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

556 
Üd”
 = 
e4b
->
bd_blkb™s
 + 1;

557 
max
;

558 
max2
;

559 
i
;

560 
j
;

561 
k
;

562 
couÁ
;

563 
ext4_group_šfo
 *
g½
;

564 
äagm’ts
 = 0;

565 
f¡¬t
;

566 
li¡_h—d
 *
cur
;

567 *
buddy
;

568 *
buddy2
;

571 
mb_check_couÁ”
;

572 ià(
mb_check_couÁ”
++ % 100 != 0)

576 
Üd”
 > 1) {

577 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
, &
max
);

578 
	`MB_CHECK_ASSERT
(
buddy
);

579 
buddy2
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
 - 1, &
max2
);

580 
	`MB_CHECK_ASSERT
(
buddy2
);

581 
	`MB_CHECK_ASSERT
(
buddy
 !ğ
buddy2
);

582 
	`MB_CHECK_ASSERT
(
max
 * 2 =ğ
max2
);

584 
couÁ
 = 0;

585 
i
 = 0; i < 
max
; i++) {

587 ià(
	`mb_‹¡_b™
(
i
, 
buddy
)) {

589 ià(!
	`mb_‹¡_b™
(
i
 << 1, 
buddy2
)) {

590 
	`MB_CHECK_ASSERT
(

591 
	`mb_‹¡_b™
((
i
<<1)+1, 
buddy2
));

592 } ià(!
	`mb_‹¡_b™
((
i
 << 1è+ 1, 
buddy2
)) {

593 
	`MB_CHECK_ASSERT
(

594 
	`mb_‹¡_b™
(
i
 << 1, 
buddy2
));

600 
	`MB_CHECK_ASSERT
(
	`mb_‹¡_b™
(
i
 << 1, 
buddy2
));

601 
	`MB_CHECK_ASSERT
(
	`mb_‹¡_b™
((
i
 << 1è+ 1, 
buddy2
));

603 
j
 = 0; j < (1 << 
Üd”
); j++) {

604 
k
 = (
i
 * (1 << 
Üd”
)è+ 
j
;

605 
	`MB_CHECK_ASSERT
(

606 !
	`mb_‹¡_b™
(
k
, 
e4b
->
bd_b™m­
));

608 
couÁ
++;

610 
	`MB_CHECK_ASSERT
(
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd”
] =ğ
couÁ
);

611 
Üd”
--;

614 
f¡¬t
 = -1;

615 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 0, &
max
);

616 
i
 = 0; i < 
max
; i++) {

617 ià(!
	`mb_‹¡_b™
(
i
, 
buddy
)) {

618 
	`MB_CHECK_ASSERT
(
i
 >ğ
e4b
->
bd_šfo
->
bb_fœ¡_ä“
);

619 ià(
f¡¬t
 == -1) {

620 
äagm’ts
++;

621 
f¡¬t
 = 
i
;

625 
f¡¬t
 = -1;

627 
j
 = 0; j < 
e4b
->
bd_blkb™s
 + 1; j++) {

628 
buddy2
 = 
	`mb_fšd_buddy
(
e4b
, 
j
, &
max2
);

629 
k
 = 
i
 >> 
j
;

630 
	`MB_CHECK_ASSERT
(
k
 < 
max2
);

631 
	`MB_CHECK_ASSERT
(
	`mb_‹¡_b™
(
k
, 
buddy2
));

634 
	`MB_CHECK_ASSERT
(!
	`EXT4_MB_GRP_NEED_INIT
(
e4b
->
bd_šfo
));

635 
	`MB_CHECK_ASSERT
(
e4b
->
bd_šfo
->
bb_äagm’ts
 =ğ
äagm’ts
);

637 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
e4b
->
bd_group
);

638 
	`li¡_fÜ_—ch
(
cur
, &
g½
->
bb_´—Îoc_li¡
) {

639 
ext4_group_t
 
grou²r
;

640 
ext4_´—Îoc_¥aû
 *
·
;

641 
·
 = 
	`li¡_’Œy
(
cur
, 
ext4_´—Îoc_¥aû
, 
·_group_li¡
);

642 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
, &
grou²r
, &
k
);

643 
	`MB_CHECK_ASSERT
(
grou²r
 =ğ
e4b
->
bd_group
);

644 
i
 = 0; i < 
·
->
·_Ën
; i++)

645 
	`MB_CHECK_ASSERT
(
	`mb_‹¡_b™
(
k
 + 
i
, 
buddy
));

648 
	}
}

649 #undeà
MB_CHECK_ASSERT


650 
	#mb_check_buddy
(
e4b
è
	`__mb_check_buddy
(e4b, \

651 
__FILE__
, 
__func__
, 
__LINE__
)

	)

653 
	#mb_check_buddy
(
e4b
)

	)

662 
	$ext4_mb_m¬k_ä“_sim¶e
(
su³r_block
 *
sb
,

663 *
buddy
, 
ext4_g½blk_t
 
fœ¡
,ƒxt4_g½blk_ˆ
Ën
,

664 
ext4_group_šfo
 *
g½
)

666 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

667 
ext4_g½blk_t
 
mš
;

668 
ext4_g½blk_t
 
max
;

669 
ext4_g½blk_t
 
chunk
;

670 
bÜd”
;

672 
	`BUG_ON
(
Ën
 > 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
));

674 
bÜd”
 = 2 << 
sb
->
s_blocksize_b™s
;

676 
Ën
 > 0) {

678 
max
 = 
	`ffs
(
fœ¡
 | 
bÜd”
) - 1;

681 
mš
 = 
	`æs
(
Ën
) - 1;

683 ià(
max
 < 
mš
)

684 
mš
 = 
max
;

685 
chunk
 = 1 << 
mš
;

688 
g½
->
bb_couÁ”s
[
mš
]++;

689 ià(
mš
 > 0)

690 
	`mb_ş—r_b™
(
fœ¡
 >> 
mš
,

691 
buddy
 + 
sbi
->
s_mb_off£ts
[
mš
]);

693 
Ën
 -ğ
chunk
;

694 
fœ¡
 +ğ
chunk
;

696 
	}
}

703 
	$mb_£t_Ïrge¡_ä“_Üd”
(
su³r_block
 *
sb
, 
ext4_group_šfo
 *
g½
)

705 
i
;

706 
b™s
;

708 
g½
->
bb_Ïrge¡_ä“_Üd”
 = -1;

710 
b™s
 = 
sb
->
s_blocksize_b™s
 + 1;

711 
i
 = 
b™s
; i >= 0; i--) {

712 ià(
g½
->
bb_couÁ”s
[
i
] > 0) {

713 
g½
->
bb_Ïrge¡_ä“_Üd”
 = 
i
;

717 
	}
}

719 
nošlše_fÜ_¡ack


720 
	$ext4_mb_g’”©e_buddy
(
su³r_block
 *
sb
,

721 *
buddy
, *
b™m­
, 
ext4_group_t
 
group
)

723 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

724 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

725 
ext4_g½blk_t
 
max
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
);

726 
ext4_g½blk_t
 
i
 = 0;

727 
ext4_g½blk_t
 
fœ¡
;

728 
ext4_g½blk_t
 
Ën
;

729 
ä“
 = 0;

730 
äagm’ts
 = 0;

731 
³riod
 = 
	`g‘_cyşes
();

735 
i
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
, 
max
, 0);

736 
g½
->
bb_fœ¡_ä“
 = 
i
;

737 
i
 < 
max
) {

738 
äagm’ts
++;

739 
fœ¡
 = 
i
;

740 
i
 = 
	`mb_fšd_Ãxt_b™
(
b™m­
, 
max
, i);

741 
Ën
 = 
i
 - 
fœ¡
;

742 
ä“
 +ğ
Ën
;

743 ià(
Ën
 > 1)

744 
	`ext4_mb_m¬k_ä“_sim¶e
(
sb
, 
buddy
, 
fœ¡
, 
Ën
, 
g½
);

746 
g½
->
bb_couÁ”s
[0]++;

747 ià(
i
 < 
max
)

748 
i
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
, 
max
, i);

750 
g½
->
bb_äagm’ts
 = 
äagm’ts
;

752 ià(
ä“
 !ğ
g½
->
bb_ä“
) {

753 
	`ext4_g½_locked_”rÜ
(
sb
, 
group
, 0, 0,

756 
ä“
, 
g½
->
bb_ä“
);

761 
g½
->
bb_ä“
 = 
ä“
;

762 ià(!
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
))

763 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

764 
g½
->
bb_ä“
);

765 
	`£t_b™
(
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &
g½
->
bb_¡©e
);

767 
	`mb_£t_Ïrge¡_ä“_Üd”
(
sb
, 
g½
);

769 
	`ş—r_b™
(
EXT4_GROUP_INFO_NEED_INIT_BIT
, &(
g½
->
bb_¡©e
));

771 
³riod
 = 
	`g‘_cyşes
() -…eriod;

772 
	`¥š_lock
(&
	`EXT4_SB
(
sb
)->
s_b®_lock
);

773 
	`EXT4_SB
(
sb
)->
s_mb_budd›s_g’”©ed
++;

774 
	`EXT4_SB
(
sb
)->
s_mb_g’”©iÚ_time
 +ğ
³riod
;

775 
	`¥š_uÆock
(&
	`EXT4_SB
(
sb
)->
s_b®_lock
);

776 
	}
}

778 
	$mb_»g’”©e_buddy
(
ext4_buddy
 *
e4b
)

780 
couÁ
;

781 
Üd”
 = 1;

782 *
buddy
;

784 (
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
++, &
couÁ
))) {

785 
	`ext4_£t_b™s
(
buddy
, 0, 
couÁ
);

787 
e4b
->
bd_šfo
->
bb_äagm’ts
 = 0;

788 
	`mem£t
(
e4b
->
bd_šfo
->
bb_couÁ”s
, 0,

789 (*
e4b
->
bd_šfo
->
bb_couÁ”s
) *

790 (
e4b
->
bd_sb
->
s_blocksize_b™s
 + 2));

792 
	`ext4_mb_g’”©e_buddy
(
e4b
->
bd_sb
,ƒ4b->
bd_buddy
,

793 
e4b
->
bd_b™m­
,ƒ4b->
bd_group
);

794 
	}
}

816 
	$ext4_mb_š™_ÿche
(
·ge
 *·ge, *
šcÜe
, 
gå_t
 
gå
)

818 
ext4_group_t
 
ngroups
;

819 
blocksize
;

820 
blocks_³r_·ge
;

821 
groups_³r_·ge
;

822 
”r
 = 0;

823 
i
;

824 
ext4_group_t
 
fœ¡_group
, 
group
;

825 
fœ¡_block
;

826 
su³r_block
 *
sb
;

827 
bufãr_h—d
 *
bhs
;

828 
bufãr_h—d
 **
bh
 = 
NULL
;

829 
šode
 *inode;

830 *
d©a
;

831 *
b™m­
;

832 
ext4_group_šfo
 *
gršfo
;

834 
	`mb_debug
(1, "š™…ag%lu\n", 
·ge
->
šdex
);

836 
šode
 = 
·ge
->
m­pšg
->
ho¡
;

837 
sb
 = 
šode
->
i_sb
;

838 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

839 
blocksize
 = 
	`i_blocksize
(
šode
);

840 
blocks_³r_·ge
 = 
PAGE_SIZE
 / 
blocksize
;

842 
groups_³r_·ge
 = 
blocks_³r_·ge
 >> 1;

843 ià(
groups_³r_·ge
 == 0)

844 
groups_³r_·ge
 = 1;

847 ià(
groups_³r_·ge
 > 1) {

848 
i
 = (
bufãr_h—d
 *è* 
groups_³r_·ge
;

849 
bh
 = 
	`kz®loc
(
i
, 
gå
);

850 ià(
bh
 =ğ
NULL
) {

851 
”r
 = -
ENOMEM
;

852 
out
;

855 
bh
 = &
bhs
;

857 
fœ¡_group
 = 
·ge
->
šdex
 * 
blocks_³r_·ge
 / 2;

860 
i
 = 0, 
group
 = 
fœ¡_group
; i < 
groups_³r_·ge
; i++, group++) {

861 ià(
group
 >ğ
ngroups
)

864 
gršfo
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

871 ià(
	`PageU±od©e
(
·ge
è&& !
	`EXT4_MB_GRP_NEED_INIT
(
gršfo
)) {

872 
bh
[
i
] = 
NULL
;

875 
bh
[
i
] = 
	`ext4_»ad_block_b™m­_nowa™
(
sb
, 
group
);

876 ià(
	`IS_ERR
(
bh
[
i
])) {

877 
”r
 = 
	`PTR_ERR
(
bh
[
i
]);

878 
bh
[
i
] = 
NULL
;

879 
out
;

881 
	`mb_debug
(1, "»ad b™m­ fÜ grou°%u\n", 
group
);

885 
i
 = 0, 
group
 = 
fœ¡_group
; i < 
groups_³r_·ge
; i++, group++) {

886 
”r2
;

888 ià(!
bh
[
i
])

890 
”r2
 = 
	`ext4_wa™_block_b™m­
(
sb
, 
group
, 
bh
[
i
]);

891 ià(!
”r
)

892 
”r
 = 
”r2
;

895 
fœ¡_block
 = 
·ge
->
šdex
 * 
blocks_³r_·ge
;

896 
i
 = 0; i < 
blocks_³r_·ge
; i++) {

897 
group
 = (
fœ¡_block
 + 
i
) >> 1;

898 ià(
group
 >ğ
ngroups
)

901 ià(!
bh
[
group
 - 
fœ¡_group
])

905 ià(!
	`bufãr_v”if›d
(
bh
[
group
 - 
fœ¡_group
]))

908 
”r
 = 0;

916 
d©a
 = 
	`·ge_add»ss
(
·ge
è+ (
i
 * 
blocksize
);

917 
b™m­
 = 
bh
[
group
 - 
fœ¡_group
]->
b_d©a
;

923 ià((
fœ¡_block
 + 
i
) & 1) {

925 
	`BUG_ON
(
šcÜe
 =ğ
NULL
);

926 
	`mb_debug
(1, "put buddy for group %u in…age %lu/%x\n",

927 
group
, 
·ge
->
šdex
, 
i
 * 
blocksize
);

928 
	`Œaû_ext4_mb_buddy_b™m­_lßd
(
sb
, 
group
);

929 
gršfo
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

930 
gršfo
->
bb_äagm’ts
 = 0;

931 
	`mem£t
(
gršfo
->
bb_couÁ”s
, 0,

932 (*
gršfo
->
bb_couÁ”s
) *

933 (
sb
->
s_blocksize_b™s
+2));

937 
	`ext4_lock_group
(
sb
, 
group
);

939 
	`mem£t
(
d©a
, 0xff, 
blocksize
);

940 
	`ext4_mb_g’”©e_buddy
(
sb
, 
d©a
, 
šcÜe
, 
group
);

941 
	`ext4_uÆock_group
(
sb
, 
group
);

942 
šcÜe
 = 
NULL
;

945 
	`BUG_ON
(
šcÜe
 !ğ
NULL
);

946 
	`mb_debug
(1, "put bitmap for group %u in…age %lu/%x\n",

947 
group
, 
·ge
->
šdex
, 
i
 * 
blocksize
);

948 
	`Œaû_ext4_mb_b™m­_lßd
(
sb
, 
group
);

951 
	`ext4_lock_group
(
sb
, 
group
);

952 
	`memıy
(
d©a
, 
b™m­
, 
blocksize
);

955 
	`ext4_mb_g’”©e_äom_·
(
sb
, 
d©a
, 
group
);

956 
	`ext4_mb_g’”©e_äom_ä“li¡
(
sb
, 
d©a
, 
group
);

957 
	`ext4_uÆock_group
(
sb
, 
group
);

962 
šcÜe
 = 
d©a
;

965 
	`S‘PageU±od©e
(
·ge
);

967 
out
:

968 ià(
bh
) {

969 
i
 = 0; i < 
groups_³r_·ge
; i++)

970 
	`b»l£
(
bh
[
i
]);

971 ià(
bh
 !ğ&
bhs
)

972 
	`kä“
(
bh
);

974  
”r
;

975 
	}
}

983 
	$ext4_mb_g‘_buddy_·ge_lock
(
su³r_block
 *
sb
,

984 
ext4_group_t
 
group
, 
ext4_buddy
 *
e4b
, 
gå_t
 
gå
)

986 
šode
 *šodğ
	`EXT4_SB
(
sb
)->
s_buddy_ÿche
;

987 
block
, 
²um
, 
poff
;

988 
blocks_³r_·ge
;

989 
·ge
 *page;

991 
e4b
->
bd_buddy_·ge
 = 
NULL
;

992 
e4b
->
bd_b™m­_·ge
 = 
NULL
;

994 
blocks_³r_·ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

1000 
block
 = 
group
 * 2;

1001 
²um
 = 
block
 / 
blocks_³r_·ge
;

1002 
poff
 = 
block
 % 
blocks_³r_·ge
;

1003 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
²um
, 
gå
);

1004 ià(!
·ge
)

1005  -
ENOMEM
;

1006 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
);

1007 
e4b
->
bd_b™m­_·ge
 = 
·ge
;

1008 
e4b
->
bd_b™m­
 = 
	`·ge_add»ss
(
·ge
è+ (
poff
 * 
sb
->
s_blocksize
);

1010 ià(
blocks_³r_·ge
 >= 2) {

1015 
block
++;

1016 
²um
 = 
block
 / 
blocks_³r_·ge
;

1017 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
²um
, 
gå
);

1018 ià(!
·ge
)

1019  -
ENOMEM
;

1020 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
);

1021 
e4b
->
bd_buddy_·ge
 = 
·ge
;

1023 
	}
}

1025 
	$ext4_mb_put_buddy_·ge_lock
(
ext4_buddy
 *
e4b
)

1027 ià(
e4b
->
bd_b™m­_·ge
) {

1028 
	`uÆock_·ge
(
e4b
->
bd_b™m­_·ge
);

1029 
	`put_·ge
(
e4b
->
bd_b™m­_·ge
);

1031 ià(
e4b
->
bd_buddy_·ge
) {

1032 
	`uÆock_·ge
(
e4b
->
bd_buddy_·ge
);

1033 
	`put_·ge
(
e4b
->
bd_buddy_·ge
);

1035 
	}
}

1042 
nošlše_fÜ_¡ack


1043 
	$ext4_mb_š™_group
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
, 
gå_t
 
gå
)

1046 
ext4_group_šfo
 *
this_g½
;

1047 
ext4_buddy
 
e4b
;

1048 
·ge
 *page;

1049 
»t
 = 0;

1051 
	`might_¦“p
();

1052 
	`mb_debug
(1, "š™ grou°%u\n", 
group
);

1053 
this_g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

1063 
»t
 = 
	`ext4_mb_g‘_buddy_·ge_lock
(
sb
, 
group
, &
e4b
, 
gå
);

1064 ià(
»t
 || !
	`EXT4_MB_GRP_NEED_INIT
(
this_g½
)) {

1069 
”r
;

1072 
·ge
 = 
e4b
.
bd_b™m­_·ge
;

1073 
»t
 = 
	`ext4_mb_š™_ÿche
(
·ge
, 
NULL
, 
gå
);

1074 ià(
»t
)

1075 
”r
;

1076 ià(!
	`PageU±od©e
(
·ge
)) {

1077 
»t
 = -
EIO
;

1078 
”r
;

1081 ià(
e4b
.
bd_buddy_·ge
 =ğ
NULL
) {

1087 
»t
 = 0;

1088 
”r
;

1091 
·ge
 = 
e4b
.
bd_buddy_·ge
;

1092 
»t
 = 
	`ext4_mb_š™_ÿche
(
·ge
, 
e4b
.
bd_b™m­
, 
gå
);

1093 ià(
»t
)

1094 
”r
;

1095 ià(!
	`PageU±od©e
(
·ge
)) {

1096 
»t
 = -
EIO
;

1097 
”r
;

1099 
”r
:

1100 
	`ext4_mb_put_buddy_·ge_lock
(&
e4b
);

1101  
»t
;

1102 
	}
}

1109 
nošlše_fÜ_¡ack
 

1110 
	$ext4_mb_lßd_buddy_gå
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

1111 
ext4_buddy
 *
e4b
, 
gå_t
 
gå
)

1113 
blocks_³r_·ge
;

1114 
block
;

1115 
²um
;

1116 
poff
;

1117 
·ge
 *page;

1118 
»t
;

1119 
ext4_group_šfo
 *
g½
;

1120 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1121 
šode
 *šodğ
sbi
->
s_buddy_ÿche
;

1123 
	`might_¦“p
();

1124 
	`mb_debug
(1, "lßd grou°%u\n", 
group
);

1126 
blocks_³r_·ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

1127 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

1129 
e4b
->
bd_blkb™s
 = 
sb
->
s_blocksize_b™s
;

1130 
e4b
->
bd_šfo
 = 
g½
;

1131 
e4b
->
bd_sb
 = 
sb
;

1132 
e4b
->
bd_group
 = 
group
;

1133 
e4b
->
bd_buddy_·ge
 = 
NULL
;

1134 
e4b
->
bd_b™m­_·ge
 = 
NULL
;

1136 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_NEED_INIT
(
g½
))) {

1141 
»t
 = 
	`ext4_mb_š™_group
(
sb
, 
group
, 
gå
);

1142 ià(
»t
)

1143  
»t
;

1151 
block
 = 
group
 * 2;

1152 
²um
 = 
block
 / 
blocks_³r_·ge
;

1153 
poff
 = 
block
 % 
blocks_³r_·ge
;

1157 
·ge
 = 
	`fšd_g‘_·ge_æags
(
šode
->
i_m­pšg
, 
²um
, 
FGP_ACCESSED
);

1158 ià(
·ge
 =ğ
NULL
 || !
	`PageU±od©e
(page)) {

1159 ià(
·ge
)

1168 
	`put_·ge
(
·ge
);

1169 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
²um
, 
gå
);

1170 ià(
·ge
) {

1171 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
);

1172 ià(!
	`PageU±od©e
(
·ge
)) {

1173 
»t
 = 
	`ext4_mb_š™_ÿche
(
·ge
, 
NULL
, 
gå
);

1174 ià(
»t
) {

1175 
	`uÆock_·ge
(
·ge
);

1176 
”r
;

1178 
	`mb_cmp_b™m­s
(
e4b
, 
	`·ge_add»ss
(
·ge
) +

1179 (
poff
 * 
sb
->
s_blocksize
));

1181 
	`uÆock_·ge
(
·ge
);

1184 ià(
·ge
 =ğ
NULL
) {

1185 
»t
 = -
ENOMEM
;

1186 
”r
;

1188 ià(!
	`PageU±od©e
(
·ge
)) {

1189 
»t
 = -
EIO
;

1190 
”r
;

1194 
e4b
->
bd_b™m­_·ge
 = 
·ge
;

1195 
e4b
->
bd_b™m­
 = 
	`·ge_add»ss
(
·ge
è+ (
poff
 * 
sb
->
s_blocksize
);

1197 
block
++;

1198 
²um
 = 
block
 / 
blocks_³r_·ge
;

1199 
poff
 = 
block
 % 
blocks_³r_·ge
;

1201 
·ge
 = 
	`fšd_g‘_·ge_æags
(
šode
->
i_m­pšg
, 
²um
, 
FGP_ACCESSED
);

1202 ià(
·ge
 =ğ
NULL
 || !
	`PageU±od©e
(page)) {

1203 ià(
·ge
)

1204 
	`put_·ge
(
·ge
);

1205 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
²um
, 
gå
);

1206 ià(
·ge
) {

1207 
	`BUG_ON
(
·ge
->
m­pšg
 !ğ
šode
->
i_m­pšg
);

1208 ià(!
	`PageU±od©e
(
·ge
)) {

1209 
»t
 = 
	`ext4_mb_š™_ÿche
(
·ge
, 
e4b
->
bd_b™m­
,

1210 
gå
);

1211 ià(
»t
) {

1212 
	`uÆock_·ge
(
·ge
);

1213 
”r
;

1216 
	`uÆock_·ge
(
·ge
);

1219 ià(
·ge
 =ğ
NULL
) {

1220 
»t
 = -
ENOMEM
;

1221 
”r
;

1223 ià(!
	`PageU±od©e
(
·ge
)) {

1224 
»t
 = -
EIO
;

1225 
”r
;

1229 
e4b
->
bd_buddy_·ge
 = 
·ge
;

1230 
e4b
->
bd_buddy
 = 
	`·ge_add»ss
(
·ge
è+ (
poff
 * 
sb
->
s_blocksize
);

1232 
	`BUG_ON
(
e4b
->
bd_b™m­_·ge
 =ğ
NULL
);

1233 
	`BUG_ON
(
e4b
->
bd_buddy_·ge
 =ğ
NULL
);

1237 
”r
:

1238 ià(
·ge
)

1239 
	`put_·ge
(
·ge
);

1240 ià(
e4b
->
bd_b™m­_·ge
)

1241 
	`put_·ge
(
e4b
->
bd_b™m­_·ge
);

1242 ià(
e4b
->
bd_buddy_·ge
)

1243 
	`put_·ge
(
e4b
->
bd_buddy_·ge
);

1244 
e4b
->
bd_buddy
 = 
NULL
;

1245 
e4b
->
bd_b™m­
 = 
NULL
;

1246  
»t
;

1247 
	}
}

1249 
	$ext4_mb_lßd_buddy
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

1250 
ext4_buddy
 *
e4b
)

1252  
	`ext4_mb_lßd_buddy_gå
(
sb
, 
group
, 
e4b
, 
GFP_NOFS
);

1253 
	}
}

1255 
	$ext4_mb_uÆßd_buddy
(
ext4_buddy
 *
e4b
)

1257 ià(
e4b
->
bd_b™m­_·ge
)

1258 
	`put_·ge
(
e4b
->
bd_b™m­_·ge
);

1259 ià(
e4b
->
bd_buddy_·ge
)

1260 
	`put_·ge
(
e4b
->
bd_buddy_·ge
);

1261 
	}
}

1264 
	$mb_fšd_Üd”_fÜ_block
(
ext4_buddy
 *
e4b
, 
block
)

1266 
Üd”
 = 1;

1267 
bb_šü
 = 1 << (
e4b
->
bd_blkb™s
 - 1);

1268 *
bb
;

1270 
	`BUG_ON
(
e4b
->
bd_b™m­
 =ğe4b->
bd_buddy
);

1271 
	`BUG_ON
(
block
 >ğ(1 << (
e4b
->
bd_blkb™s
 + 3)));

1273 
bb
 = 
e4b
->
bd_buddy
;

1274 
Üd”
 <ğ
e4b
->
bd_blkb™s
 + 1) {

1275 
block
 = block >> 1;

1276 ià(!
	`mb_‹¡_b™
(
block
, 
bb
)) {

1278  
Üd”
;

1280 
bb
 +ğ
bb_šü
;

1281 
bb_šü
 >>= 1;

1282 
Üd”
++;

1285 
	}
}

1287 
	$mb_ş—r_b™s
(*
bm
, 
cur
, 
Ën
)

1289 
__u32
 *
addr
;

1291 
Ën
 = 
cur
 +†en;

1292 
cur
 < 
Ën
) {

1293 ià((
cur
 & 31è=ğ0 && (
Ën
 - cur) >= 32) {

1295 
addr
 = 
bm
 + (
cur
 >> 3);

1296 *
addr
 = 0;

1297 
cur
 += 32;

1300 
	`mb_ş—r_b™
(
cur
, 
bm
);

1301 
cur
++;

1303 
	}
}

1308 
	$mb_‹¡_ªd_ş—r_b™s
(*
bm
, 
cur
, 
Ën
)

1310 
__u32
 *
addr
;

1311 
z”o_b™
 = -1;

1313 
Ën
 = 
cur
 +†en;

1314 
cur
 < 
Ën
) {

1315 ià((
cur
 & 31è=ğ0 && (
Ën
 - cur) >= 32) {

1317 
addr
 = 
bm
 + (
cur
 >> 3);

1318 ià(*
addr
 !ğ(
__u32
)(-1è&& 
z”o_b™
 == -1)

1319 
z”o_b™
 = 
cur
 + 
	`mb_fšd_Ãxt_z”o_b™
(
addr
, 32, 0);

1320 *
addr
 = 0;

1321 
cur
 += 32;

1324 ià(!
	`mb_‹¡_ªd_ş—r_b™
(
cur
, 
bm
è&& 
z”o_b™
 == -1)

1325 
z”o_b™
 = 
cur
;

1326 
cur
++;

1329  
z”o_b™
;

1330 
	}
}

1332 
	$ext4_£t_b™s
(*
bm
, 
cur
, 
Ën
)

1334 
__u32
 *
addr
;

1336 
Ën
 = 
cur
 +†en;

1337 
cur
 < 
Ën
) {

1338 ià((
cur
 & 31è=ğ0 && (
Ën
 - cur) >= 32) {

1340 
addr
 = 
bm
 + (
cur
 >> 3);

1341 *
addr
 = 0xffffffff;

1342 
cur
 += 32;

1345 
	`mb_£t_b™
(
cur
, 
bm
);

1346 
cur
++;

1348 
	}
}

1353 
šlše
 
	$mb_buddy_adju¡_bÜd”
(* 
b™
, * 
b™m­
, 
side
)

1355 ià(
	`mb_‹¡_b™
(*
b™
 + 
side
, 
b™m­
)) {

1356 
	`mb_ş—r_b™
(*
b™
, 
b™m­
);

1357 (*
b™
è-ğ
side
;

1361 (*
b™
è+ğ
side
;

1362 
	`mb_£t_b™
(*
b™
, 
b™m­
);

1365 
	}
}

1367 
	$mb_buddy_m¬k_ä“
(
ext4_buddy
 *
e4b
, 
fœ¡
, 
Ï¡
)

1369 
max
;

1370 
Üd”
 = 1;

1371 *
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
, &
max
);

1373 
buddy
) {

1374 *
buddy2
;

1405 ià(
fœ¡
 & 1)

1406 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd”
] +ğ
	`mb_buddy_adju¡_bÜd”
(&
fœ¡
, 
buddy
, -1);

1407 ià(!(
Ï¡
 & 1))

1408 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd”
] +ğ
	`mb_buddy_adju¡_bÜd”
(&
Ï¡
, 
buddy
, 1);

1409 ià(
fœ¡
 > 
Ï¡
)

1411 
Üd”
++;

1413 ià(
fœ¡
 =ğ
Ï¡
 || !(
buddy2
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd”
, &
max
))) {

1414 
	`mb_ş—r_b™s
(
buddy
, 
fœ¡
, 
Ï¡
 - first + 1);

1415 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd”
 - 1] +ğ
Ï¡
 - 
fœ¡
 + 1;

1418 
fœ¡
 >>= 1;

1419 
Ï¡
 >>= 1;

1420 
buddy
 = 
buddy2
;

1422 
	}
}

1424 
	$mb_ä“_blocks
(
šode
 *šode, 
ext4_buddy
 *
e4b
,

1425 
fœ¡
, 
couÁ
)

1427 
Ëá_is_ä“
 = 0;

1428 
right_is_ä“
 = 0;

1429 
block
;

1430 
Ï¡
 = 
fœ¡
 + 
couÁ
 - 1;

1431 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

1433 ià(
	`WARN_ON
(
couÁ
 == 0))

1435 
	`BUG_ON
(
Ï¡
 >ğ(
sb
->
s_blocksize
 << 3));

1436 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

1438 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_šfo
)))

1441 
	`mb_check_buddy
(
e4b
);

1442 
	`mb_ä“_blocks_doubË
(
šode
, 
e4b
, 
fœ¡
, 
couÁ
);

1444 
e4b
->
bd_šfo
->
bb_ä“
 +ğ
couÁ
;

1445 ià(
fœ¡
 < 
e4b
->
bd_šfo
->
bb_fœ¡_ä“
)

1446 
e4b
->
bd_šfo
->
bb_fœ¡_ä“
 = 
fœ¡
;

1451 ià(
fœ¡
 != 0)

1452 
Ëá_is_ä“
 = !
	`mb_‹¡_b™
(
fœ¡
 - 1, 
e4b
->
bd_b™m­
);

1453 
block
 = 
	`mb_‹¡_ªd_ş—r_b™s
(
e4b
->
bd_b™m­
, 
fœ¡
, 
couÁ
);

1454 ià(
Ï¡
 + 1 < 
	`EXT4_SB
(
sb
)->
s_mb_maxs
[0])

1455 
right_is_ä“
 = !
	`mb_‹¡_b™
(
Ï¡
 + 1, 
e4b
->
bd_b™m­
);

1457 ià(
	`uÆik–y
(
block
 != -1)) {

1458 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1459 
ext4_fsblk_t
 
blockÄ
;

1461 
blockÄ
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
e4b
->
bd_group
);

1462 
blockÄ
 +ğ
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 
block
);

1463 
	`ext4_g½_locked_”rÜ
(
sb
, 
e4b
->
bd_group
,

1464 
šode
 ? inode->
i_šo
 : 0,

1465 
blockÄ
,

1468 
block
);

1469 ià(!
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_šfo
))

1470 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

1471 
e4b
->
bd_šfo
->
bb_ä“
);

1473 
	`£t_b™
(
EXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
,

1474 &
e4b
->
bd_šfo
->
bb_¡©e
);

1475 
	`mb_»g’”©e_buddy
(
e4b
);

1476 
dÚe
;

1480 ià(
Ëá_is_ä“
 && 
right_is_ä“
)

1481 
e4b
->
bd_šfo
->
bb_äagm’ts
--;

1482 ià(!
Ëá_is_ä“
 && !
right_is_ä“
)

1483 
e4b
->
bd_šfo
->
bb_äagm’ts
++;

1491 ià(
fœ¡
 & 1) {

1492 
fœ¡
 +ğ!
Ëá_is_ä“
;

1493 
e4b
->
bd_šfo
->
bb_couÁ”s
[0] +ğ
Ëá_is_ä“
 ? -1 : 1;

1495 ià(!(
Ï¡
 & 1)) {

1496 
Ï¡
 -ğ!
right_is_ä“
;

1497 
e4b
->
bd_šfo
->
bb_couÁ”s
[0] +ğ
right_is_ä“
 ? -1 : 1;

1500 ià(
fœ¡
 <ğ
Ï¡
)

1501 
	`mb_buddy_m¬k_ä“
(
e4b
, 
fœ¡
 >> 1, 
Ï¡
 >> 1);

1503 
dÚe
:

1504 
	`mb_£t_Ïrge¡_ä“_Üd”
(
sb
, 
e4b
->
bd_šfo
);

1505 
	`mb_check_buddy
(
e4b
);

1506 
	}
}

1508 
	$mb_fšd_ex‹Á
(
ext4_buddy
 *
e4b
, 
block
,

1509 
Ãeded
, 
ext4_ä“_ex‹Á
 *
ex
)

1511 
Ãxt
 = 
block
;

1512 
max
, 
Üd”
;

1513 *
buddy
;

1515 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
e4b
->
bd_sb
,ƒ4b->
bd_group
));

1516 
	`BUG_ON
(
ex
 =ğ
NULL
);

1518 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 0, &
max
);

1519 
	`BUG_ON
(
buddy
 =ğ
NULL
);

1520 
	`BUG_ON
(
block
 >ğ
max
);

1521 ià(
	`mb_‹¡_b™
(
block
, 
buddy
)) {

1522 
ex
->
ã_Ën
 = 0;

1523 
ex
->
ã_¡¬t
 = 0;

1524 
ex
->
ã_group
 = 0;

1529 
Üd”
 = 
	`mb_fšd_Üd”_fÜ_block
(
e4b
, 
block
);

1530 
block
 = block >> 
Üd”
;

1532 
ex
->
ã_Ën
 = 1 << 
Üd”
;

1533 
ex
->
ã_¡¬t
 = 
block
 << 
Üd”
;

1534 
ex
->
ã_group
 = 
e4b
->
bd_group
;

1537 
Ãxt
 =‚exˆ- 
ex
->
ã_¡¬t
;

1538 
ex
->
ã_Ën
 -ğ
Ãxt
;

1539 
ex
->
ã_¡¬t
 +ğ
Ãxt
;

1541 
Ãeded
 > 
ex
->
ã_Ën
 &&

1542 
	`mb_fšd_buddy
(
e4b
, 
Üd”
, &
max
)) {

1544 ià(
block
 + 1 >ğ
max
)

1547 
Ãxt
 = (
block
 + 1è* (1 << 
Üd”
);

1548 ià(
	`mb_‹¡_b™
(
Ãxt
, 
e4b
->
bd_b™m­
))

1551 
Üd”
 = 
	`mb_fšd_Üd”_fÜ_block
(
e4b
, 
Ãxt
);

1553 
block
 = 
Ãxt
 >> 
Üd”
;

1554 
ex
->
ã_Ën
 +ğ1 << 
Üd”
;

1557 ià(
ex
->
ã_¡¬t
 +ƒx->
ã_Ën
 > (1 << (
e4b
->
bd_blkb™s
 + 3))) {

1559 
	`WARN_ON
(1);

1560 
	`ext4_”rÜ
(
e4b
->
bd_sb
, "corruption or bug in mb_find_extent "

1562 
block
, 
Üd”
, 
Ãeded
, 
ex
->
ã_group
,ƒx->
ã_¡¬t
,

1563 
ex
->
ã_Ën
,ƒx->
ã_logiÿl
);

1564 
ex
->
ã_Ën
 = 0;

1565 
ex
->
ã_¡¬t
 = 0;

1566 
ex
->
ã_group
 = 0;

1568  
ex
->
ã_Ën
;

1569 
	}
}

1571 
	$mb_m¬k_u£d
(
ext4_buddy
 *
e4b
, 
ext4_ä“_ex‹Á
 *
ex
)

1573 
Üd
;

1574 
mËn
 = 0;

1575 
max
 = 0;

1576 
cur
;

1577 
¡¬t
 = 
ex
->
ã_¡¬t
;

1578 
Ën
 = 
ex
->
ã_Ën
;

1579 
»t
 = 0;

1580 
Ën0
 = 
Ën
;

1581 *
buddy
;

1583 
	`BUG_ON
(
¡¬t
 + 
Ën
 > (
e4b
->
bd_sb
->
s_blocksize
 << 3));

1584 
	`BUG_ON
(
e4b
->
bd_group
 !ğ
ex
->
ã_group
);

1585 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
e4b
->
bd_sb
,ƒ4b->
bd_group
));

1586 
	`mb_check_buddy
(
e4b
);

1587 
	`mb_m¬k_u£d_doubË
(
e4b
, 
¡¬t
, 
Ën
);

1589 
e4b
->
bd_šfo
->
bb_ä“
 -ğ
Ën
;

1590 ià(
e4b
->
bd_šfo
->
bb_fœ¡_ä“
 =ğ
¡¬t
)

1591 
e4b
->
bd_šfo
->
bb_fœ¡_ä“
 +ğ
Ën
;

1594 ià(
¡¬t
 != 0)

1595 
mËn
 = !
	`mb_‹¡_b™
(
¡¬t
 - 1, 
e4b
->
bd_b™m­
);

1596 ià(
¡¬t
 + 
Ën
 < 
	`EXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[0])

1597 
max
 = !
	`mb_‹¡_b™
(
¡¬t
 + 
Ën
, 
e4b
->
bd_b™m­
);

1598 ià(
mËn
 && 
max
)

1599 
e4b
->
bd_šfo
->
bb_äagm’ts
++;

1600 ià(!
mËn
 && !
max
)

1601 
e4b
->
bd_šfo
->
bb_äagm’ts
--;

1604 
Ën
) {

1605 
Üd
 = 
	`mb_fšd_Üd”_fÜ_block
(
e4b
, 
¡¬t
);

1607 ià(((
¡¬t
 >> 
Üd
è<< ordè=ğ¡¬ˆ&& 
Ën
 >= (1 << ord)) {

1609 
mËn
 = 1 << 
Üd
;

1610 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd
, &
max
);

1611 
	`BUG_ON
((
¡¬t
 >> 
Üd
è>ğ
max
);

1612 
	`mb_£t_b™
(
¡¬t
 >> 
Üd
, 
buddy
);

1613 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd
]--;

1614 
¡¬t
 +ğ
mËn
;

1615 
Ën
 -ğ
mËn
;

1616 
	`BUG_ON
(
Ën
 < 0);

1621 ià(
»t
 == 0)

1622 
»t
 = 
Ën
 | (
Üd
 << 16);

1625 
	`BUG_ON
(
Üd
 <= 0);

1626 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd
, &
max
);

1627 
	`mb_£t_b™
(
¡¬t
 >> 
Üd
, 
buddy
);

1628 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd
]--;

1630 
Üd
--;

1631 
cur
 = (
¡¬t
 >> 
Üd
) & ~1U;

1632 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
Üd
, &
max
);

1633 
	`mb_ş—r_b™
(
cur
, 
buddy
);

1634 
	`mb_ş—r_b™
(
cur
 + 1, 
buddy
);

1635 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd
]++;

1636 
e4b
->
bd_šfo
->
bb_couÁ”s
[
Üd
]++;

1638 
	`mb_£t_Ïrge¡_ä“_Üd”
(
e4b
->
bd_sb
,ƒ4b->
bd_šfo
);

1640 
	`ext4_£t_b™s
(
e4b
->
bd_b™m­
, 
ex
->
ã_¡¬t
, 
Ën0
);

1641 
	`mb_check_buddy
(
e4b
);

1643  
»t
;

1644 
	}
}

1649 
	$ext4_mb_u£_be¡_found
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1650 
ext4_buddy
 *
e4b
)

1652 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

1653 
»t
;

1655 
	`BUG_ON
(
ac
->
ac_b_ex
.
ã_group
 !ğ
e4b
->
bd_group
);

1656 
	`BUG_ON
(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
);

1658 
ac
->
ac_b_ex
.
ã_Ën
 = 
	`mš
×c->ac_b_ex.ã_Ën,‡c->
ac_g_ex
.fe_len);

1659 
ac
->
ac_b_ex
.
ã_logiÿl
 =‡c->
ac_g_ex
.fe_logical;

1660 
»t
 = 
	`mb_m¬k_u£d
(
e4b
, &
ac
->
ac_b_ex
);

1664 
ac
->
ac_f_ex
 =‡c->
ac_b_ex
;

1666 
ac
->
ac_¡©us
 = 
AC_STATUS_FOUND
;

1667 
ac
->
ac_
 = 
»t
 & 0xffff;

1668 
ac
->
ac_buddy
 = 
»t
 >> 16;

1677 
ac
->
ac_b™m­_·ge
 = 
e4b
->
bd_b™m­_·ge
;

1678 
	`g‘_·ge
(
ac
->
ac_b™m­_·ge
);

1679 
ac
->
ac_buddy_·ge
 = 
e4b
->
bd_buddy_·ge
;

1680 
	`g‘_·ge
(
ac
->
ac_buddy_·ge
);

1682 ià(
ac
->
ac_æags
 & 
EXT4_MB_STREAM_ALLOC
) {

1683 
	`¥š_lock
(&
sbi
->
s_md_lock
);

1684 
sbi
->
s_mb_Ï¡_group
 = 
ac
->
ac_f_ex
.
ã_group
;

1685 
sbi
->
s_mb_Ï¡_¡¬t
 = 
ac
->
ac_f_ex
.
ã_¡¬t
;

1686 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

1688 
	}
}

1694 
	$ext4_mb_check_lim™s
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1695 
ext4_buddy
 *
e4b
,

1696 
fšish_group
)

1698 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

1699 
ext4_ä“_ex‹Á
 *
bex
 = &
ac
->
ac_b_ex
;

1700 
ext4_ä“_ex‹Á
 *
gex
 = &
ac
->
ac_g_ex
;

1701 
ext4_ä“_ex‹Á
 
ex
;

1702 
max
;

1704 ià(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
)

1709 ià(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sÿn
 &&

1710 !(
ac
->
ac_æags
 & 
EXT4_MB_HINT_FIRST
)) {

1711 
ac
->
ac_¡©us
 = 
AC_STATUS_BREAK
;

1718 ià(
bex
->
ã_Ën
 < 
gex
->fe_len)

1721 ià((
fšish_group
 || 
ac
->
ac_found
 > 
sbi
->
s_mb_mš_to_sÿn
)

1722 && 
bex
->
ã_group
 =ğ
e4b
->
bd_group
) {

1726 
max
 = 
	`mb_fšd_ex‹Á
(
e4b
, 
bex
->
ã_¡¬t
, 
gex
->
ã_Ën
, &
ex
);

1727 ià(
max
 >ğ
gex
->
ã_Ën
) {

1728 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1732 
	}
}

1744 
	$ext4_mb_m—su»_ex‹Á
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1745 
ext4_ä“_ex‹Á
 *
ex
,

1746 
ext4_buddy
 *
e4b
)

1748 
ext4_ä“_ex‹Á
 *
bex
 = &
ac
->
ac_b_ex
;

1749 
ext4_ä“_ex‹Á
 *
gex
 = &
ac
->
ac_g_ex
;

1751 
	`BUG_ON
(
ex
->
ã_Ën
 <= 0);

1752 
	`BUG_ON
(
ex
->
ã_Ën
 > 
	`EXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1753 
	`BUG_ON
(
ex
->
ã_¡¬t
 >ğ
	`EXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1754 
	`BUG_ON
(
ac
->
ac_¡©us
 !ğ
AC_STATUS_CONTINUE
);

1756 
ac
->
ac_found
++;

1761 ià(
	`uÆik–y
(
ac
->
ac_æags
 & 
EXT4_MB_HINT_FIRST
)) {

1762 *
bex
 = *
ex
;

1763 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1770 ià(
ex
->
ã_Ën
 =ğ
gex
->fe_len) {

1771 *
bex
 = *
ex
;

1772 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1779 ià(
bex
->
ã_Ën
 == 0) {

1780 *
bex
 = *
ex
;

1787 ià(
bex
->
ã_Ën
 < 
gex
->fe_len) {

1790 ià(
ex
->
ã_Ën
 > 
bex
->fe_len)

1791 *
bex
 = *
ex
;

1792 } ià(
ex
->
ã_Ën
 > 
gex
->fe_len) {

1796 ià(
ex
->
ã_Ën
 < 
bex
->fe_len)

1797 *
bex
 = *
ex
;

1800 
	`ext4_mb_check_lim™s
(
ac
, 
e4b
, 0);

1801 
	}
}

1803 
nošlše_fÜ_¡ack


1804 
	$ext4_mb_Œy_be¡_found
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1805 
ext4_buddy
 *
e4b
)

1807 
ext4_ä“_ex‹Á
 
ex
 = 
ac
->
ac_b_ex
;

1808 
ext4_group_t
 
group
 = 
ex
.
ã_group
;

1809 
max
;

1810 
”r
;

1812 
	`BUG_ON
(
ex
.
ã_Ën
 <= 0);

1813 
”r
 = 
	`ext4_mb_lßd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1814 ià(
”r
)

1815  
”r
;

1817 
	`ext4_lock_group
(
ac
->
ac_sb
, 
group
);

1818 
max
 = 
	`mb_fšd_ex‹Á
(
e4b
, 
ex
.
ã_¡¬t
,ƒx.
ã_Ën
, &ex);

1820 ià(
max
 > 0) {

1821 
ac
->
ac_b_ex
 = 
ex
;

1822 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1825 
	`ext4_uÆock_group
(
ac
->
ac_sb
, 
group
);

1826 
	`ext4_mb_uÆßd_buddy
(
e4b
);

1829 
	}
}

1831 
nošlše_fÜ_¡ack


1832 
	$ext4_mb_fšd_by_gßl
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1833 
ext4_buddy
 *
e4b
)

1835 
ext4_group_t
 
group
 = 
ac
->
ac_g_ex
.
ã_group
;

1836 
max
;

1837 
”r
;

1838 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

1839 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
ac
->
ac_sb
, 
group
);

1840 
ext4_ä“_ex‹Á
 
ex
;

1842 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_TRY_GOAL
))

1844 ià(
g½
->
bb_ä“
 == 0)

1847 
”r
 = 
	`ext4_mb_lßd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1848 ià(
”r
)

1849  
”r
;

1851 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_šfo
))) {

1852 
	`ext4_mb_uÆßd_buddy
(
e4b
);

1856 
	`ext4_lock_group
(
ac
->
ac_sb
, 
group
);

1857 
max
 = 
	`mb_fšd_ex‹Á
(
e4b
, 
ac
->
ac_g_ex
.
ã_¡¬t
,

1858 
ac
->
ac_g_ex
.
ã_Ën
, &
ex
);

1859 
ex
.
ã_logiÿl
 = 0xDEADFA11;

1861 ià(
max
 >ğ
ac
->
ac_g_ex
.
ã_Ën
 &&‡c->ac_g_ex.ã_ËÀ=ğ
sbi
->
s_¡re
) {

1862 
ext4_fsblk_t
 
¡¬t
;

1864 
¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
ac
->
ac_sb
, 
e4b
->
bd_group
) +

1865 
ex
.
ã_¡¬t
;

1867 ià(
	`do_div
(
¡¬t
, 
sbi
->
s_¡re
) == 0) {

1868 
ac
->
ac_found
++;

1869 
ac
->
ac_b_ex
 = 
ex
;

1870 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1872 } ià(
max
 >ğ
ac
->
ac_g_ex
.
ã_Ën
) {

1873 
	`BUG_ON
(
ex
.
ã_Ën
 <= 0);

1874 
	`BUG_ON
(
ex
.
ã_group
 !ğ
ac
->
ac_g_ex
.fe_group);

1875 
	`BUG_ON
(
ex
.
ã_¡¬t
 !ğ
ac
->
ac_g_ex
.fe_start);

1876 
ac
->
ac_found
++;

1877 
ac
->
ac_b_ex
 = 
ex
;

1878 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1879 } ià(
max
 > 0 && (
ac
->
ac_æags
 & 
EXT4_MB_HINT_MERGE
)) {

1882 
	`BUG_ON
(
ex
.
ã_Ën
 <= 0);

1883 
	`BUG_ON
(
ex
.
ã_group
 !ğ
ac
->
ac_g_ex
.fe_group);

1884 
	`BUG_ON
(
ex
.
ã_¡¬t
 !ğ
ac
->
ac_g_ex
.fe_start);

1885 
ac
->
ac_found
++;

1886 
ac
->
ac_b_ex
 = 
ex
;

1887 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1889 
	`ext4_uÆock_group
(
ac
->
ac_sb
, 
group
);

1890 
	`ext4_mb_uÆßd_buddy
(
e4b
);

1893 
	}
}

1899 
nošlše_fÜ_¡ack


1900 
	$ext4_mb_sim¶e_sÿn_group
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1901 
ext4_buddy
 *
e4b
)

1903 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

1904 
ext4_group_šfo
 *
g½
 = 
e4b
->
bd_šfo
;

1905 *
buddy
;

1906 
i
;

1907 
k
;

1908 
max
;

1910 
	`BUG_ON
(
ac
->
ac_2Üd”
 <= 0);

1911 
i
 = 
ac
->
ac_2Üd”
; i <ğ
sb
->
s_blocksize_b™s
 + 1; i++) {

1912 ià(
g½
->
bb_couÁ”s
[
i
] == 0)

1915 
buddy
 = 
	`mb_fšd_buddy
(
e4b
, 
i
, &
max
);

1916 
	`BUG_ON
(
buddy
 =ğ
NULL
);

1918 
k
 = 
	`mb_fšd_Ãxt_z”o_b™
(
buddy
, 
max
, 0);

1919 
	`BUG_ON
(
k
 >ğ
max
);

1921 
ac
->
ac_found
++;

1923 
ac
->
ac_b_ex
.
ã_Ën
 = 1 << 
i
;

1924 
ac
->
ac_b_ex
.
ã_¡¬t
 = 
k
 << 
i
;

1925 
ac
->
ac_b_ex
.
ã_group
 = 
e4b
->
bd_group
;

1927 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

1929 
	`BUG_ON
(
ac
->
ac_b_ex
.
ã_Ën
 !ğac->
ac_g_ex
.fe_len);

1931 ià(
	`EXT4_SB
(
sb
)->
s_mb_¡©s
)

1932 
	`©omic_šc
(&
	`EXT4_SB
(
sb
)->
s_b®_2Üd”s
);

1936 
	}
}

1943 
nošlše_fÜ_¡ack


1944 
	$ext4_mb_com¶ex_sÿn_group
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

1945 
ext4_buddy
 *
e4b
)

1947 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

1948 *
b™m­
 = 
e4b
->
bd_b™m­
;

1949 
ext4_ä“_ex‹Á
 
ex
;

1950 
i
;

1951 
ä“
;

1953 
ä“
 = 
e4b
->
bd_šfo
->
bb_ä“
;

1954 
	`BUG_ON
(
ä“
 <= 0);

1956 
i
 = 
e4b
->
bd_šfo
->
bb_fœ¡_ä“
;

1958 
ä“
 && 
ac
->
ac_¡©us
 =ğ
AC_STATUS_CONTINUE
) {

1959 
i
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
,

1960 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
), 
i
);

1961 ià(
i
 >ğ
	`EXT4_CLUSTERS_PER_GROUP
(
sb
)) {

1967 
	`ext4_g½_locked_”rÜ
(
sb
, 
e4b
->
bd_group
, 0, 0,

1970 
ä“
);

1974 
	`mb_fšd_ex‹Á
(
e4b
, 
i
, 
ac
->
ac_g_ex
.
ã_Ën
, &
ex
);

1975 
	`BUG_ON
(
ex
.
ã_Ën
 <= 0);

1976 ià(
ä“
 < 
ex
.
ã_Ën
) {

1977 
	`ext4_g½_locked_”rÜ
(
sb
, 
e4b
->
bd_group
, 0, 0,

1980 
ä“
, 
ex
.
ã_Ën
);

1988 
ex
.
ã_logiÿl
 = 0xDEADC0DE;

1989 
	`ext4_mb_m—su»_ex‹Á
(
ac
, &
ex
, 
e4b
);

1991 
i
 +ğ
ex
.
ã_Ën
;

1992 
ä“
 -ğ
ex
.
ã_Ën
;

1995 
	`ext4_mb_check_lim™s
(
ac
, 
e4b
, 1);

1996 
	}
}

2002 
nošlše_fÜ_¡ack


2003 
	$ext4_mb_sÿn_®igÃd
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

2004 
ext4_buddy
 *
e4b
)

2006 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

2007 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2008 *
b™m­
 = 
e4b
->
bd_b™m­
;

2009 
ext4_ä“_ex‹Á
 
ex
;

2010 
ext4_fsblk_t
 
fœ¡_group_block
;

2011 
ext4_fsblk_t
 
a
;

2012 
ext4_g½blk_t
 
i
;

2013 
max
;

2015 
	`BUG_ON
(
sbi
->
s_¡re
 == 0);

2018 
fœ¡_group_block
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
e4b
->
bd_group
);

2020 
a
 = 
fœ¡_group_block
 + 
sbi
->
s_¡re
 - 1;

2021 
	`do_div
(
a
, 
sbi
->
s_¡re
);

2022 
i
 = (
a
 * 
sbi
->
s_¡re
è- 
fœ¡_group_block
;

2024 
i
 < 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
)) {

2025 ià(!
	`mb_‹¡_b™
(
i
, 
b™m­
)) {

2026 
max
 = 
	`mb_fšd_ex‹Á
(
e4b
, 
i
, 
sbi
->
s_¡re
, &
ex
);

2027 ià(
max
 >ğ
sbi
->
s_¡re
) {

2028 
ac
->
ac_found
++;

2029 
ex
.
ã_logiÿl
 = 0xDEADF00D;

2030 
ac
->
ac_b_ex
 = 
ex
;

2031 
	`ext4_mb_u£_be¡_found
(
ac
, 
e4b
);

2035 
i
 +ğ
sbi
->
s_¡re
;

2037 
	}
}

2045 
	$ext4_mb_good_group
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

2046 
ext4_group_t
 
group
, 
ü
)

2048 
ä“
, 
äagm’ts
;

2049 
æex_size
 = 
	`ext4_æex_bg_size
(
	`EXT4_SB
(
ac
->
ac_sb
));

2050 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
ac
->
ac_sb
, 
group
);

2052 
	`BUG_ON
(
ü
 < 0 || cr >= 4);

2054 
ä“
 = 
g½
->
bb_ä“
;

2055 ià(
ä“
 == 0)

2057 ià(
ü
 <ğ2 && 
ä“
 < 
ac
->
ac_g_ex
.
ã_Ën
)

2060 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(
g½
)))

2064 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_NEED_INIT
(
g½
))) {

2065 
»t
 = 
	`ext4_mb_š™_group
(
ac
->
ac_sb
, 
group
, 
GFP_NOFS
);

2066 ià(
»t
)

2067  
»t
;

2070 
äagm’ts
 = 
g½
->
bb_äagm’ts
;

2071 ià(
äagm’ts
 == 0)

2074 
ü
) {

2076 
	`BUG_ON
(
ac
->
ac_2Üd”
 == 0);

2079 ià((
ac
->
ac_æags
 & 
EXT4_MB_HINT_DATA
) &&

2080 (
æex_size
 >ğ
EXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) &&

2081 ((
group
 % 
æex_size
) == 0))

2084 ià((
ac
->
ac_2Üd”
 >‡c->
ac_sb
->
s_blocksize_b™s
+1) ||

2085 (
ä“
 / 
äagm’ts
è>ğ
ac
->
ac_g_ex
.
ã_Ën
)

2088 ià(
g½
->
bb_Ïrge¡_ä“_Üd”
 < 
ac
->
ac_2Üd”
)

2093 ià((
ä“
 / 
äagm’ts
è>ğ
ac
->
ac_g_ex
.
ã_Ën
)

2097 ià(
ä“
 >ğ
ac
->
ac_g_ex
.
ã_Ën
)

2103 
	`BUG
();

2107 
	}
}

2109 
nošlše_fÜ_¡ack
 

2110 
	$ext4_mb_»guÏr_®loÿtÜ
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

2112 
ext4_group_t
 
ngroups
, 
group
, 
i
;

2113 
ü
;

2114 
”r
 = 0, 
fœ¡_”r
 = 0;

2115 
ext4_sb_šfo
 *
sbi
;

2116 
su³r_block
 *
sb
;

2117 
ext4_buddy
 
e4b
;

2119 
sb
 = 
ac
->
ac_sb
;

2120 
sbi
 = 
	`EXT4_SB
(
sb
);

2121 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

2123 ià(!(
	`ext4_‹¡_šode_æag
(
ac
->
ac_šode
, 
EXT4_INODE_EXTENTS
)))

2124 
ngroups
 = 
sbi
->
s_blockfe_groups
;

2126 
	`BUG_ON
(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
);

2129 
”r
 = 
	`ext4_mb_fšd_by_gßl
(
ac
, &
e4b
);

2130 ià(
”r
 || 
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
)

2131 
out
;

2133 ià(
	`uÆik–y
(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GOAL_ONLY
))

2134 
out
;

2141 
i
 = 
	`æs
(
ac
->
ac_g_ex
.
ã_Ën
);

2142 
ac
->
ac_2Üd”
 = 0;

2150 ià(
i
 >ğ
sbi
->
s_mb_Üd”2_»qs
 && i <ğ
sb
->
s_blocksize_b™s
 + 2) {

2154 ià((
ac
->
ac_g_ex
.
ã_Ën
 & (~(1 << (
i
 - 1)))) == 0)

2155 
ac
->
ac_2Üd”
 = 
i
 - 1;

2159 ià(
ac
->
ac_æags
 & 
EXT4_MB_STREAM_ALLOC
) {

2161 
	`¥š_lock
(&
sbi
->
s_md_lock
);

2162 
ac
->
ac_g_ex
.
ã_group
 = 
sbi
->
s_mb_Ï¡_group
;

2163 
ac
->
ac_g_ex
.
ã_¡¬t
 = 
sbi
->
s_mb_Ï¡_¡¬t
;

2164 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

2168 
ü
 = 
ac
->
ac_2Üd”
 ? 0 : 1;

2173 
»³©
:

2174 ; 
ü
 < 4 && 
ac
->
ac_¡©us
 =ğ
AC_STATUS_CONTINUE
; cr++) {

2175 
ac
->
ac_ü™”Ÿ
 = 
ü
;

2180 
group
 = 
ac
->
ac_g_ex
.
ã_group
;

2182 
i
 = 0; i < 
ngroups
; 
group
++, i++) {

2183 
»t
 = 0;

2184 
	`cÚd_»sched
();

2189 ià(
group
 >ğ
ngroups
)

2190 
group
 = 0;

2193 
»t
 = 
	`ext4_mb_good_group
(
ac
, 
group
, 
ü
);

2194 ià(
»t
 <= 0) {

2195 ià(!
fœ¡_”r
)

2196 
fœ¡_”r
 = 
»t
;

2200 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

2201 ià(
”r
)

2202 
out
;

2204 
	`ext4_lock_group
(
sb
, 
group
);

2210 
»t
 = 
	`ext4_mb_good_group
(
ac
, 
group
, 
ü
);

2211 ià(
»t
 <= 0) {

2212 
	`ext4_uÆock_group
(
sb
, 
group
);

2213 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

2214 ià(!
fœ¡_”r
)

2215 
fœ¡_”r
 = 
»t
;

2219 
ac
->
ac_groups_sÿÂed
++;

2220 ià(
ü
 == 0)

2221 
	`ext4_mb_sim¶e_sÿn_group
(
ac
, &
e4b
);

2222 ià(
ü
 =ğ1 && 
sbi
->
s_¡re
 &&

2223 !(
ac
->
ac_g_ex
.
ã_Ën
 % 
sbi
->
s_¡re
))

2224 
	`ext4_mb_sÿn_®igÃd
(
ac
, &
e4b
);

2226 
	`ext4_mb_com¶ex_sÿn_group
(
ac
, &
e4b
);

2228 
	`ext4_uÆock_group
(
sb
, 
group
);

2229 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

2231 ià(
ac
->
ac_¡©us
 !ğ
AC_STATUS_CONTINUE
)

2236 ià(
ac
->
ac_b_ex
.
ã_Ën
 > 0 &&‡c->
ac_¡©us
 !ğ
AC_STATUS_FOUND
 &&

2237 !(
ac
->
ac_æags
 & 
EXT4_MB_HINT_FIRST
)) {

2243 
	`ext4_mb_Œy_be¡_found
(
ac
, &
e4b
);

2244 ià(
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
) {

2251 
ac
->
ac_b_ex
.
ã_group
 = 0;

2252 
ac
->
ac_b_ex
.
ã_¡¬t
 = 0;

2253 
ac
->
ac_b_ex
.
ã_Ën
 = 0;

2254 
ac
->
ac_¡©us
 = 
AC_STATUS_CONTINUE
;

2255 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_FIRST
;

2256 
ü
 = 3;

2257 
	`©omic_šc
(&
sbi
->
s_mb_lo¡_chunks
);

2258 
»³©
;

2261 
out
:

2262 ià(!
”r
 && 
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
 && 
fœ¡_”r
)

2263 
”r
 = 
fœ¡_”r
;

2264  
”r
;

2265 
	}
}

2267 *
	$ext4_mb_£q_groups_¡¬t
(
£q_fe
 *
£q
, 
loff_t
 *
pos
)

2269 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

2270 
ext4_group_t
 
group
;

2272 ià(*
pos
 < 0 || *po >ğ
	`ext4_g‘_groups_couÁ
(
sb
))

2273  
NULL
;

2274 
group
 = *
pos
 + 1;

2275  (*è((è
group
);

2276 
	}
}

2278 *
	$ext4_mb_£q_groups_Ãxt
(
£q_fe
 *
£q
, *
v
, 
loff_t
 *
pos
)

2280 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

2281 
ext4_group_t
 
group
;

2283 ++*
pos
;

2284 ià(*
pos
 < 0 || *po >ğ
	`ext4_g‘_groups_couÁ
(
sb
))

2285  
NULL
;

2286 
group
 = *
pos
 + 1;

2287  (*è((è
group
);

2288 
	}
}

2290 
	$ext4_mb_£q_groups_show
(
£q_fe
 *
£q
, *
v
)

2292 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

2293 
ext4_group_t
 
group
 = (ext4_group_tè((è
v
);

2294 
i
;

2295 
”r
, 
buddy_lßded
 = 0;

2296 
ext4_buddy
 
e4b
;

2297 
ext4_group_šfo
 *
gršfo
;

2298 
blocksize_b™s
 = 
	`mš_t
(,

2299 
sb
->
s_blocksize_b™s
,

2300 
EXT4_MAX_BLOCK_LOG_SIZE
);

2301 
	ssg
 {

2302 
ext4_group_šfo
 
šfo
;

2303 
ext4_g½blk_t
 
couÁ”s
[
EXT4_MAX_BLOCK_LOG_SIZE
 + 2];

2304 } 
sg
;

2306 
group
--;

2307 ià(
group
 == 0)

2308 
	`£q_puts
(
£q
, "#group: free frags first ["

2312 
i
 = (
blocksize_b™s
 + 2è* (
sg
.
šfo
.
bb_couÁ”s
[0]) +

2313 (
ext4_group_šfo
);

2315 
gršfo
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

2317 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_NEED_INIT
(
gršfo
))) {

2318 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

2319 ià(
”r
) {

2320 
	`£q_´štf
(
£q
, "#%-5u: I/Oƒ¼Ü\n", 
group
);

2323 
buddy_lßded
 = 1;

2326 
	`memıy
(&
sg
, 
	`ext4_g‘_group_šfo
(
sb
, 
group
), 
i
);

2328 ià(
buddy_lßded
)

2329 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

2331 
	`£q_´štf
(
£q
, "#%-5u: %-5u %-5u %-5u [", 
group
, 
sg
.
šfo
.
bb_ä“
,

2332 
sg
.
šfo
.
bb_äagm’ts
, sg.šfo.
bb_fœ¡_ä“
);

2333 
i
 = 0; i <= 13; i++)

2334 
	`£q_´štf
(
£q
, " %-5u", 
i
 <ğ
blocksize_b™s
 + 1 ?

2335 
sg
.
šfo
.
bb_couÁ”s
[
i
] : 0);

2336 
	`£q_´štf
(
£q
, " ]\n");

2339 
	}
}

2341 
	$ext4_mb_£q_groups_¡İ
(
£q_fe
 *
£q
, *
v
)

2343 
	}
}

2345 cÚ¡ 
£q_İ”©iÚs
 
	gext4_mb_£q_groups_İs
 = {

2346 .
¡¬t
 = 
ext4_mb_£q_groups_¡¬t
,

2347 .
	gÃxt
 = 
ext4_mb_£q_groups_Ãxt
,

2348 .
	g¡İ
 = 
ext4_mb_£q_groups_¡İ
,

2349 .
	gshow
 = 
ext4_mb_£q_groups_show
,

2352 
	$ext4_mb_£q_groups_İ’
(
šode
 *šode, 
fe
 *file)

2354 
su³r_block
 *
sb
 = 
	`PDE_DATA
(
šode
);

2355 
rc
;

2357 
rc
 = 
	`£q_İ’
(
fe
, &
ext4_mb_£q_groups_İs
);

2358 ià(
rc
 == 0) {

2359 
£q_fe
 *
m
 = 
fe
->
´iv©e_d©a
;

2360 
m
->
´iv©e
 = 
sb
;

2362  
rc
;

2364 
	}
}

2366 cÚ¡ 
fe_İ”©iÚs
 
	gext4_£q_mb_groups_fİs
 = {

2367 .
İ’
 = 
ext4_mb_£q_groups_İ’
,

2368 .
	g»ad
 = 
£q_»ad
,

2369 .
	gÎ£ek
 = 
£q_l£ek
,

2370 .
	g»Ëa£
 = 
£q_»Ëa£
,

2373 
kmem_ÿche
 *
	$g‘_groupšfo_ÿche
(
blocksize_b™s
)

2375 
ÿche_šdex
 = 
blocksize_b™s
 - 
EXT4_MIN_BLOCK_LOG_SIZE
;

2376 
kmem_ÿche
 *
ÿch•
 = 
ext4_groupšfo_ÿches
[
ÿche_šdex
];

2378 
	`BUG_ON
(!
ÿch•
);

2379  
ÿch•
;

2380 
	}
}

2386 
	$ext4_mb_®loc_groupšfo
(
su³r_block
 *
sb
, 
ext4_group_t
 
ngroups
)

2388 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2389 
size
;

2390 
ext4_group_šfo
 ***
Ãw_groupšfo
;

2392 
size
 = (
ngroups
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2393 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

2394 ià(
size
 <ğ
sbi
->
s_group_šfo_size
)

2397 
size
 = 
	`roundup_pow_of_two
((*
sbi
->
s_group_šfo
) * size);

2398 
Ãw_groupšfo
 = 
	`kvz®loc
(
size
, 
GFP_KERNEL
);

2399 ià(!
Ãw_groupšfo
) {

2400 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't‡llocate buddy meta group");

2401  -
ENOMEM
;

2403 ià(
sbi
->
s_group_šfo
) {

2404 
	`memıy
(
Ãw_groupšfo
, 
sbi
->
s_group_šfo
,

2405 
sbi
->
s_group_šfo_size
 * (*sbi->
s_group_šfo
));

2406 
	`kvä“
(
sbi
->
s_group_šfo
);

2408 
sbi
->
s_group_šfo
 = 
Ãw_groupšfo
;

2409 
sbi
->
s_group_šfo_size
 = 
size
 / (*sbi->
s_group_šfo
);

2410 
	`ext4_debug
("allocated s_groupinfo‡rray for %d meta_bg's\n",

2411 
sbi
->
s_group_šfo_size
);

2413 
	}
}

2416 
	$ext4_mb_add_groupšfo
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

2417 
ext4_group_desc
 *
desc
)

2419 
i
;

2420 
m‘®’
 = 0;

2421 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2422 
ext4_group_šfo
 **
m‘a_group_šfo
;

2423 
kmem_ÿche
 *
ÿch•
 = 
	`g‘_groupšfo_ÿche
(
sb
->
s_blocksize_b™s
);

2430 ià(
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2431 
m‘®’
 = (*
m‘a_group_šfo
) <<

2432 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

2433 
m‘a_group_šfo
 = 
	`km®loc
(
m‘®’
, 
GFP_NOFS
);

2434 ià(
m‘a_group_šfo
 =ğ
NULL
) {

2435 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't‡llocate mem "

2437 
ex™_m‘a_group_šfo
;

2439 
sbi
->
s_group_šfo
[
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)] =

2440 
m‘a_group_šfo
;

2443 
m‘a_group_šfo
 =

2444 
sbi
->
s_group_šfo
[
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)];

2445 
i
 = 
group
 & (
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1);

2447 
m‘a_group_šfo
[
i
] = 
	`kmem_ÿche_z®loc
(
ÿch•
, 
GFP_NOFS
);

2448 ià(
m‘a_group_šfo
[
i
] =ğ
NULL
) {

2449 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't‡llocate buddy mem");

2450 
ex™_group_šfo
;

2452 
	`£t_b™
(
EXT4_GROUP_INFO_NEED_INIT_BIT
,

2453 &(
m‘a_group_šfo
[
i
]->
bb_¡©e
));

2459 ià(
desc
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
)) {

2460 
m‘a_group_šfo
[
i
]->
bb_ä“
 =

2461 
	`ext4_ä“_şu¡”s_aá”_š™
(
sb
, 
group
, 
desc
);

2463 
m‘a_group_šfo
[
i
]->
bb_ä“
 =

2464 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
);

2467 
	`INIT_LIST_HEAD
(&
m‘a_group_šfo
[
i
]->
bb_´—Îoc_li¡
);

2468 
	`š™_rw£m
(&
m‘a_group_šfo
[
i
]->
®loc_£m
);

2469 
m‘a_group_šfo
[
i
]->
bb_ä“_roÙ
 = 
RB_ROOT
;

2470 
m‘a_group_šfo
[
i
]->
bb_Ïrge¡_ä“_Üd”
 = -1;

2472 #ifdeà
DOUBLE_CHECK


2474 
bufãr_h—d
 *
bh
;

2475 
m‘a_group_šfo
[
i
]->
bb_b™m­
 =

2476 
	`km®loc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

2477 
	`BUG_ON
(
m‘a_group_šfo
[
i
]->
bb_b™m­
 =ğ
NULL
);

2478 
bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

2479 
	`BUG_ON
(
	`IS_ERR_OR_NULL
(
bh
));

2480 
	`memıy
(
m‘a_group_šfo
[
i
]->
bb_b™m­
, 
bh
->
b_d©a
,

2481 
sb
->
s_blocksize
);

2482 
	`put_bh
(
bh
);

2488 
ex™_group_šfo
:

2490 ià(
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2491 
	`kä“
(
sbi
->
s_group_šfo
[
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)]);

2492 
sbi
->
s_group_šfo
[
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)] = 
NULL
;

2494 
ex™_m‘a_group_šfo
:

2495  -
ENOMEM
;

2496 
	}
}

2498 
	$ext4_mb_š™_back’d
(
su³r_block
 *
sb
)

2500 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

2501 
ext4_group_t
 
i
;

2502 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2503 
”r
;

2504 
ext4_group_desc
 *
desc
;

2505 
kmem_ÿche
 *
ÿch•
;

2507 
”r
 = 
	`ext4_mb_®loc_groupšfo
(
sb
, 
ngroups
);

2508 ià(
”r
)

2509  
”r
;

2511 
sbi
->
s_buddy_ÿche
 = 
	`Ãw_šode
(
sb
);

2512 ià(
sbi
->
s_buddy_ÿche
 =ğ
NULL
) {

2513 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't get‚ew inode");

2514 
”r_ä“sgi
;

2520 
sbi
->
s_buddy_ÿche
->
i_šo
 = 
EXT4_BAD_INO
;

2521 
	`EXT4_I
(
sbi
->
s_buddy_ÿche
)->
i_disksize
 = 0;

2522 
i
 = 0; i < 
ngroups
; i++) {

2523 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

2524 ià(
desc
 =ğ
NULL
) {

2525 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ÿn'ˆ»ad desütÜ %u", 
i
);

2526 
”r_ä“buddy
;

2528 ià(
	`ext4_mb_add_groupšfo
(
sb
, 
i
, 
desc
) != 0)

2529 
”r_ä“buddy
;

2534 
”r_ä“buddy
:

2535 
ÿch•
 = 
	`g‘_groupšfo_ÿche
(
sb
->
s_blocksize_b™s
);

2536 
i
-- > 0)

2537 
	`kmem_ÿche_ä“
(
ÿch•
, 
	`ext4_g‘_group_šfo
(
sb
, 
i
));

2538 
i
 = 
sbi
->
s_group_šfo_size
;

2539 
i
-- > 0)

2540 
	`kä“
(
sbi
->
s_group_šfo
[
i
]);

2541 
	`ut
(
sbi
->
s_buddy_ÿche
);

2542 
”r_ä“sgi
:

2543 
	`kvä“
(
sbi
->
s_group_šfo
);

2544  -
ENOMEM
;

2545 
	}
}

2547 
	$ext4_groupšfo_de¡roy_¦abs
()

2549 
i
;

2551 
i
 = 0; i < 
NR_GRPINFO_CACHES
; i++) {

2552 ià(
ext4_groupšfo_ÿches
[
i
])

2553 
	`kmem_ÿche_de¡roy
(
ext4_groupšfo_ÿches
[
i
]);

2554 
ext4_groupšfo_ÿches
[
i
] = 
NULL
;

2556 
	}
}

2558 
	$ext4_groupšfo_ü—‹_¦ab
(
size_t
 
size
)

2560 
	`DEFINE_MUTEX
(
ext4_g½šfo_¦ab_ü—‹_mu‹x
);

2561 
¦ab_size
;

2562 
blocksize_b™s
 = 
	`Üd”_ba£_2
(
size
);

2563 
ÿche_šdex
 = 
blocksize_b™s
 - 
EXT4_MIN_BLOCK_LOG_SIZE
;

2564 
kmem_ÿche
 *
ÿch•
;

2566 ià(
ÿche_šdex
 >ğ
NR_GRPINFO_CACHES
)

2567  -
EINVAL
;

2569 ià(
	`uÆik–y
(
ÿche_šdex
 < 0))

2570 
ÿche_šdex
 = 0;

2572 
	`mu‹x_lock
(&
ext4_g½šfo_¦ab_ü—‹_mu‹x
);

2573 ià(
ext4_groupšfo_ÿches
[
ÿche_šdex
]) {

2574 
	`mu‹x_uÆock
(&
ext4_g½šfo_¦ab_ü—‹_mu‹x
);

2578 
¦ab_size
 = 
	`off£tof
(
ext4_group_šfo
,

2579 
bb_couÁ”s
[
blocksize_b™s
 + 2]);

2581 
ÿch•
 = 
	`kmem_ÿche_ü—‹
(
ext4_groupšfo_¦ab_Çmes
[
ÿche_šdex
],

2582 
¦ab_size
, 0, 
SLAB_RECLAIM_ACCOUNT
,

2583 
NULL
);

2585 
ext4_groupšfo_ÿches
[
ÿche_šdex
] = 
ÿch•
;

2587 
	`mu‹x_uÆock
(&
ext4_g½šfo_¦ab_ü—‹_mu‹x
);

2588 ià(!
ÿch•
) {

2589 
	`´štk
(
KERN_EMERG


2591  -
ENOMEM
;

2595 
	}
}

2597 
	$ext4_mb_š™
(
su³r_block
 *
sb
)

2599 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2600 
i
, 
j
;

2601 
off£t
, 
off£t_šü
;

2602 
max
;

2603 
»t
;

2605 
i
 = (
sb
->
s_blocksize_b™s
 + 2è* (*
sbi
->
s_mb_off£ts
);

2607 
sbi
->
s_mb_off£ts
 = 
	`km®loc
(
i
, 
GFP_KERNEL
);

2608 ià(
sbi
->
s_mb_off£ts
 =ğ
NULL
) {

2609 
»t
 = -
ENOMEM
;

2610 
out
;

2613 
i
 = (
sb
->
s_blocksize_b™s
 + 2è* (*
sbi
->
s_mb_maxs
);

2614 
sbi
->
s_mb_maxs
 = 
	`km®loc
(
i
, 
GFP_KERNEL
);

2615 ià(
sbi
->
s_mb_maxs
 =ğ
NULL
) {

2616 
»t
 = -
ENOMEM
;

2617 
out
;

2620 
»t
 = 
	`ext4_groupšfo_ü—‹_¦ab
(
sb
->
s_blocksize
);

2621 ià(
»t
 < 0)

2622 
out
;

2625 
sbi
->
s_mb_maxs
[0] = 
sb
->
s_blocksize
 << 3;

2626 
sbi
->
s_mb_off£ts
[0] = 0;

2628 
i
 = 1;

2629 
off£t
 = 0;

2630 
off£t_šü
 = 1 << (
sb
->
s_blocksize_b™s
 - 1);

2631 
max
 = 
sb
->
s_blocksize
 << 2;

2633 
sbi
->
s_mb_off£ts
[
i
] = 
off£t
;

2634 
sbi
->
s_mb_maxs
[
i
] = 
max
;

2635 
off£t
 +ğ
off£t_šü
;

2636 
off£t_šü
 = offset_incr >> 1;

2637 
max
 = max >> 1;

2638 
i
++;

2639 } 
i
 <ğ
sb
->
s_blocksize_b™s
 + 1);

2641 
	`¥š_lock_š™
(&
sbi
->
s_md_lock
);

2642 
	`¥š_lock_š™
(&
sbi
->
s_b®_lock
);

2643 
sbi
->
s_mb_ä“_³ndšg
 = 0;

2644 
	`INIT_LIST_HEAD
(&
sbi
->
s_ä“d_d©a_li¡
);

2646 
sbi
->
s_mb_max_to_sÿn
 = 
MB_DEFAULT_MAX_TO_SCAN
;

2647 
sbi
->
s_mb_mš_to_sÿn
 = 
MB_DEFAULT_MIN_TO_SCAN
;

2648 
sbi
->
s_mb_¡©s
 = 
MB_DEFAULT_STATS
;

2649 
sbi
->
s_mb_¡»am_»que¡
 = 
MB_DEFAULT_STREAM_THRESHOLD
;

2650 
sbi
->
s_mb_Üd”2_»qs
 = 
MB_DEFAULT_ORDER2_REQS
;

2663 
sbi
->
s_mb_group_´—Îoc
 = 
	`max
(
MB_DEFAULT_GROUP_PREALLOC
 >>

2664 
sbi
->
s_şu¡”_b™s
, 32);

2673 ià(
sbi
->
s_¡re
 > 1) {

2674 
sbi
->
s_mb_group_´—Îoc
 = 
	`roundup
(

2675 
sbi
->
s_mb_group_´—Îoc
, sbi->
s_¡re
);

2678 
sbi
->
s_loÿl™y_groups
 = 
	`®loc_³rıu
(
ext4_loÿl™y_group
);

2679 ià(
sbi
->
s_loÿl™y_groups
 =ğ
NULL
) {

2680 
»t
 = -
ENOMEM
;

2681 
out
;

2683 
	`fÜ_—ch_possibË_ıu
(
i
) {

2684 
ext4_loÿl™y_group
 *
lg
;

2685 
lg
 = 
	`³r_ıu_±r
(
sbi
->
s_loÿl™y_groups
, 
i
);

2686 
	`mu‹x_š™
(&
lg
->
lg_mu‹x
);

2687 
j
 = 0; j < 
PREALLOC_TB_SIZE
; j++)

2688 
	`INIT_LIST_HEAD
(&
lg
->
lg_´—Îoc_li¡
[
j
]);

2689 
	`¥š_lock_š™
(&
lg
->
lg_´—Îoc_lock
);

2693 
»t
 = 
	`ext4_mb_š™_back’d
(
sb
);

2694 ià(
»t
 != 0)

2695 
out_ä“_loÿl™y_groups
;

2699 
out_ä“_loÿl™y_groups
:

2700 
	`ä“_³rıu
(
sbi
->
s_loÿl™y_groups
);

2701 
sbi
->
s_loÿl™y_groups
 = 
NULL
;

2702 
out
:

2703 
	`kä“
(
sbi
->
s_mb_off£ts
);

2704 
sbi
->
s_mb_off£ts
 = 
NULL
;

2705 
	`kä“
(
sbi
->
s_mb_maxs
);

2706 
sbi
->
s_mb_maxs
 = 
NULL
;

2707  
»t
;

2708 
	}
}

2711 
	$ext4_mb_ş—nup_·
(
ext4_group_šfo
 *
g½
)

2713 
ext4_´—Îoc_¥aû
 *
·
;

2714 
li¡_h—d
 *
cur
, *
tmp
;

2715 
couÁ
 = 0;

2717 
	`li¡_fÜ_—ch_§ã
(
cur
, 
tmp
, &
g½
->
bb_´—Îoc_li¡
) {

2718 
·
 = 
	`li¡_’Œy
(
cur
, 
ext4_´—Îoc_¥aû
, 
·_group_li¡
);

2719 
	`li¡_d–
(&
·
->
·_group_li¡
);

2720 
couÁ
++;

2721 
	`kmem_ÿche_ä“
(
ext4_p¥aû_ÿch•
, 
·
);

2723 ià(
couÁ
)

2724 
	`mb_debug
(1, "mb®loc: %u PA Ëá\n", 
couÁ
);

2726 
	}
}

2728 
	$ext4_mb_»Ëa£
(
su³r_block
 *
sb
)

2730 
ext4_group_t
 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

2731 
ext4_group_t
 
i
;

2732 
num_m‘a_group_šfos
;

2733 
ext4_group_šfo
 *
gršfo
;

2734 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2735 
kmem_ÿche
 *
ÿch•
 = 
	`g‘_groupšfo_ÿche
(
sb
->
s_blocksize_b™s
);

2737 ià(
sbi
->
s_group_šfo
) {

2738 
i
 = 0; i < 
ngroups
; i++) {

2739 
gršfo
 = 
	`ext4_g‘_group_šfo
(
sb
, 
i
);

2740 #ifdeà
DOUBLE_CHECK


2741 
	`kä“
(
gršfo
->
bb_b™m­
);

2743 
	`ext4_lock_group
(
sb
, 
i
);

2744 
	`ext4_mb_ş—nup_·
(
gršfo
);

2745 
	`ext4_uÆock_group
(
sb
, 
i
);

2746 
	`kmem_ÿche_ä“
(
ÿch•
, 
gršfo
);

2748 
num_m‘a_group_šfos
 = (
ngroups
 +

2749 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2750 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

2751 
i
 = 0; i < 
num_m‘a_group_šfos
; i++)

2752 
	`kä“
(
sbi
->
s_group_šfo
[
i
]);

2753 
	`kvä“
(
sbi
->
s_group_šfo
);

2755 
	`kä“
(
sbi
->
s_mb_off£ts
);

2756 
	`kä“
(
sbi
->
s_mb_maxs
);

2757 
	`ut
(
sbi
->
s_buddy_ÿche
);

2758 ià(
sbi
->
s_mb_¡©s
) {

2759 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2761 
	`©omic_»ad
(&
sbi
->
s_b®_®loÿ‹d
),

2762 
	`©omic_»ad
(&
sbi
->
s_b®_»qs
),

2763 
	`©omic_»ad
(&
sbi
->
s_b®_sucûss
));

2764 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2767 
	`©omic_»ad
(&
sbi
->
s_b®_ex_sÿÂed
),

2768 
	`©omic_»ad
(&
sbi
->
s_b®_gßls
),

2769 
	`©omic_»ad
(&
sbi
->
s_b®_2Üd”s
),

2770 
	`©omic_»ad
(&
sbi
->
s_b®_b»aks
),

2771 
	`©omic_»ad
(&
sbi
->
s_mb_lo¡_chunks
));

2772 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2774 
sbi
->
s_mb_budd›s_g’”©ed
,

2775 
sbi
->
s_mb_g’”©iÚ_time
);

2776 
	`ext4_msg
(
sb
, 
KERN_INFO
,

2778 
	`©omic_»ad
(&
sbi
->
s_mb_´—Îoÿ‹d
),

2779 
	`©omic_»ad
(&
sbi
->
s_mb_disÿrded
));

2782 
	`ä“_³rıu
(
sbi
->
s_loÿl™y_groups
);

2785 
	}
}

2787 
šlše
 
	$ext4_issue_disÿrd
(
su³r_block
 *
sb
,

2788 
ext4_group_t
 
block_group
, 
ext4_g½blk_t
 
şu¡”
, 
couÁ
,

2789 
bio
 **
biİ
)

2791 
ext4_fsblk_t
 
disÿrd_block
;

2793 
disÿrd_block
 = (
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 
şu¡”
) +

2794 
	`ext4_group_fœ¡_block_no
(
sb
, 
block_group
));

2795 
couÁ
 = 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), count);

2796 
	`Œaû_ext4_disÿrd_blocks
(
sb
,

2797 (è
disÿrd_block
, 
couÁ
);

2798 ià(
biİ
) {

2799  
	`__blkdev_issue_disÿrd
(
sb
->
s_bdev
,

2800 (
£ùÜ_t
)
disÿrd_block
 << (
sb
->
s_blocksize_b™s
 - 9),

2801 (
£ùÜ_t
)
couÁ
 << (
sb
->
s_blocksize_b™s
 - 9),

2802 
GFP_NOFS
, 0, 
biİ
);

2804  
	`sb_issue_disÿrd
(
sb
, 
disÿrd_block
, 
couÁ
, 
GFP_NOFS
, 0);

2805 
	}
}

2807 
	$ext4_ä“_d©a_š_buddy
(
su³r_block
 *
sb
,

2808 
ext4_ä“_d©a
 *
’Œy
)

2810 
ext4_buddy
 
e4b
;

2811 
ext4_group_šfo
 *
db
;

2812 
”r
, 
couÁ
 = 0, 
couÁ2
 = 0;

2814 
	`mb_debug
(1, "gonna free %u blocks in group %u (0x%p):",

2815 
’Œy
->
efd_couÁ
,ƒÁry->
efd_group
,ƒntry);

2817 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
’Œy
->
efd_group
, &
e4b
);

2819 
	`BUG_ON
(
”r
 != 0);

2821 
	`¥š_lock
(&
	`EXT4_SB
(
sb
)->
s_md_lock
);

2822 
	`EXT4_SB
(
sb
)->
s_mb_ä“_³ndšg
 -ğ
’Œy
->
efd_couÁ
;

2823 
	`¥š_uÆock
(&
	`EXT4_SB
(
sb
)->
s_md_lock
);

2825 
db
 = 
e4b
.
bd_šfo
;

2827 
couÁ
 +ğ
’Œy
->
efd_couÁ
;

2828 
couÁ2
++;

2829 
	`ext4_lock_group
(
sb
, 
’Œy
->
efd_group
);

2831 
	`rb_”a£
(&
’Œy
->
efd_node
, &(
db
->
bb_ä“_roÙ
));

2832 
	`mb_ä“_blocks
(
NULL
, &
e4b
, 
’Œy
->
efd_¡¬t_şu¡”
,ƒÁry->
efd_couÁ
);

2840 ià(!
	`‹¡_İt
(
sb
, 
DISCARD
))

2841 
	`EXT4_MB_GRP_CLEAR_TRIMMED
(
db
);

2843 ià(!
db
->
bb_ä“_roÙ
.
rb_node
) {

2847 
	`put_·ge
(
e4b
.
bd_buddy_·ge
);

2848 
	`put_·ge
(
e4b
.
bd_b™m­_·ge
);

2850 
	`ext4_uÆock_group
(
sb
, 
’Œy
->
efd_group
);

2851 
	`kmem_ÿche_ä“
(
ext4_ä“_d©a_ÿch•
, 
’Œy
);

2852 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

2854 
	`mb_debug
(1, "ä“d %u block š %u sŒuùu»s\n", 
couÁ
, 
couÁ2
);

2855 
	}
}

2861 
	$ext4_´oûss_ä“d_d©a
(
su³r_block
 *
sb
, 
tid_t
 
comm™_tid
)

2863 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2864 
ext4_ä“_d©a
 *
’Œy
, *
tmp
;

2865 
bio
 *
disÿrd_bio
 = 
NULL
;

2866 
li¡_h—d
 
ä“d_d©a_li¡
;

2867 
li¡_h—d
 *
cut_pos
 = 
NULL
;

2868 
”r
;

2870 
	`INIT_LIST_HEAD
(&
ä“d_d©a_li¡
);

2872 
	`¥š_lock
(&
sbi
->
s_md_lock
);

2873 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
sbi
->
s_ä“d_d©a_li¡
, 
efd_li¡
) {

2874 ià(
’Œy
->
efd_tid
 !ğ
comm™_tid
)

2876 
cut_pos
 = &
’Œy
->
efd_li¡
;

2878 ià(
cut_pos
)

2879 
	`li¡_cut_pos™iÚ
(&
ä“d_d©a_li¡
, &
sbi
->
s_ä“d_d©a_li¡
,

2880 
cut_pos
);

2881 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

2883 ià(
	`‹¡_İt
(
sb
, 
DISCARD
)) {

2884 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, &
ä“d_d©a_li¡
, 
efd_li¡
) {

2885 
”r
 = 
	`ext4_issue_disÿrd
(
sb
, 
’Œy
->
efd_group
,

2886 
’Œy
->
efd_¡¬t_şu¡”
,

2887 
’Œy
->
efd_couÁ
,

2888 &
disÿrd_bio
);

2889 ià(
”r
 &&ƒ¼ !ğ-
EOPNOTSUPP
) {

2890 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "discard„equest in"

2892 " w™h %d", 
’Œy
->
efd_group
,

2893 
’Œy
->
efd_¡¬t_şu¡”
,

2894 
’Œy
->
efd_couÁ
, 
”r
);

2895 } ià(
”r
 =ğ-
EOPNOTSUPP
)

2899 ià(
disÿrd_bio
) {

2900 
	`subm™_bio_wa™
(
disÿrd_bio
);

2901 
	`bio_put
(
disÿrd_bio
);

2905 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, &
ä“d_d©a_li¡
, 
efd_li¡
)

2906 
	`ext4_ä“_d©a_š_buddy
(
sb
, 
’Œy
);

2907 
	}
}

2909 
__š™
 
	$ext4_š™_mb®loc
()

2911 
ext4_p¥aû_ÿch•
 = 
	`KMEM_CACHE
(
ext4_´—Îoc_¥aû
,

2912 
SLAB_RECLAIM_ACCOUNT
);

2913 ià(
ext4_p¥aû_ÿch•
 =ğ
NULL
)

2914  -
ENOMEM
;

2916 
ext4_ac_ÿch•
 = 
	`KMEM_CACHE
(
ext4_®loÿtiÚ_cÚ‹xt
,

2917 
SLAB_RECLAIM_ACCOUNT
);

2918 ià(
ext4_ac_ÿch•
 =ğ
NULL
) {

2919 
	`kmem_ÿche_de¡roy
(
ext4_p¥aû_ÿch•
);

2920  -
ENOMEM
;

2923 
ext4_ä“_d©a_ÿch•
 = 
	`KMEM_CACHE
(
ext4_ä“_d©a
,

2924 
SLAB_RECLAIM_ACCOUNT
);

2925 ià(
ext4_ä“_d©a_ÿch•
 =ğ
NULL
) {

2926 
	`kmem_ÿche_de¡roy
(
ext4_p¥aû_ÿch•
);

2927 
	`kmem_ÿche_de¡roy
(
ext4_ac_ÿch•
);

2928  -
ENOMEM
;

2931 
	}
}

2933 
	$ext4_ex™_mb®loc
()

2939 
	`rcu_b¬r›r
();

2940 
	`kmem_ÿche_de¡roy
(
ext4_p¥aû_ÿch•
);

2941 
	`kmem_ÿche_de¡roy
(
ext4_ac_ÿch•
);

2942 
	`kmem_ÿche_de¡roy
(
ext4_ä“_d©a_ÿch•
);

2943 
	`ext4_groupšfo_de¡roy_¦abs
();

2944 
	}
}

2951 
nošlše_fÜ_¡ack
 

2952 
	$ext4_mb_m¬k_disk¥aû_u£d
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

2953 
hªdË_t
 *
hªdË
, 
»£rv_ş¡rs
)

2955 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

2956 
ext4_group_desc
 *
gdp
;

2957 
bufãr_h—d
 *
gdp_bh
;

2958 
ext4_sb_šfo
 *
sbi
;

2959 
su³r_block
 *
sb
;

2960 
ext4_fsblk_t
 
block
;

2961 
”r
, 
Ën
;

2963 
	`BUG_ON
(
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
);

2964 
	`BUG_ON
(
ac
->
ac_b_ex
.
ã_Ën
 <= 0);

2966 
sb
 = 
ac
->
ac_sb
;

2967 
sbi
 = 
	`EXT4_SB
(
sb
);

2969 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

2970 ià(
	`IS_ERR
(
b™m­_bh
)) {

2971 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

2972 
b™m­_bh
 = 
NULL
;

2973 
out_”r
;

2976 
	`BUFFER_TRACE
(
b™m­_bh
, "getting write‡ccess");

2977 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
b™m­_bh
);

2978 ià(
”r
)

2979 
out_”r
;

2981 
”r
 = -
EIO
;

2982 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
ac
->
ac_b_ex
.
ã_group
, &
gdp_bh
);

2983 ià(!
gdp
)

2984 
out_”r
;

2986 
	`ext4_debug
("usšg block grou°%u(%d)\n", 
ac
->
ac_b_ex
.
ã_group
,

2987 
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
));

2989 
	`BUFFER_TRACE
(
gdp_bh
, "get_write_access");

2990 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdp_bh
);

2991 ià(
”r
)

2992 
out_”r
;

2994 
block
 = 
	`ext4_g½_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

2996 
Ën
 = 
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
);

2997 ià(!
	`ext4_d©a_block_v®id
(
sbi
, 
block
, 
Ën
)) {

2998 
	`ext4_”rÜ
(
sb
, "Allocating blocks %llu-%llu which overlap "

2999 "f m‘ad©a", 
block
, block+
Ën
);

3004 
	`ext4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3005 
	`ext4_£t_b™s
(
b™m­_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
ã_¡¬t
,

3006 
ac
->
ac_b_ex
.
ã_Ën
);

3007 
	`ext4_uÆock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3008 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

3009 ià(!
”r
)

3010 
”r
 = -
EFSCORRUPTED
;

3011 
out_”r
;

3014 
	`ext4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3015 #ifdeà
AGGRESSIVE_CHECK


3017 
i
;

3018 
i
 = 0; i < 
ac
->
ac_b_ex
.
ã_Ën
; i++) {

3019 
	`BUG_ON
(
	`mb_‹¡_b™
(
ac
->
ac_b_ex
.
ã_¡¬t
 + 
i
,

3020 
b™m­_bh
->
b_d©a
));

3024 
	`ext4_£t_b™s
(
b™m­_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
ã_¡¬t
,

3025 
ac
->
ac_b_ex
.
ã_Ën
);

3026 ià(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
)) {

3027 
gdp
->
bg_æags
 &ğ
	`ıu_to_Ë16
(~
EXT4_BG_BLOCK_UNINIT
);

3028 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
,

3029 
	`ext4_ä“_şu¡”s_aá”_š™
(
sb
,

3030 
ac
->
ac_b_ex
.
ã_group
, 
gdp
));

3032 
Ën
 = 
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
è- 
ac
->
ac_b_ex
.
ã_Ën
;

3033 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
, 
Ën
);

3034 
	`ext4_block_b™m­_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
ã_group
, 
gdp
, 
b™m­_bh
);

3035 
	`ext4_group_desc_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
ã_group
, 
gdp
);

3037 
	`ext4_uÆock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3038 
	`³rıu_couÁ”_sub
(&
sbi
->
s_ä“şu¡”s_couÁ”
, 
ac
->
ac_b_ex
.
ã_Ën
);

3042 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_DELALLOC_RESERVED
))

3044 
	`³rıu_couÁ”_sub
(&
sbi
->
s_dœtyşu¡”s_couÁ”
,

3045 
»£rv_ş¡rs
);

3047 ià(
sbi
->
s_log_groups_³r_æex
) {

3048 
ext4_group_t
 
æex_group
 = 
	`ext4_æex_group
(
sbi
,

3049 
ac
->
ac_b_ex
.
ã_group
);

3050 
	`©omic64_sub
(
ac
->
ac_b_ex
.
ã_Ën
,

3051 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

3054 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

3055 ià(
”r
)

3056 
out_”r
;

3057 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gdp_bh
);

3059 
out_”r
:

3060 
	`b»l£
(
b™m­_bh
);

3061  
”r
;

3062 
	}
}

3064 
	$ext4_mb_m¬k_u£d
(
su³r_block
 *
sb
, 
ext4_fsblk_t
 
block
,

3065 
Ën
)

3067 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

3068 
ext4_group_desc
 *
gdp
;

3069 
bufãr_h—d
 *
gdp_bh
;

3070 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3071 
ext4_group_t
 
group
;

3072 
ext4_fsblk_t
 
şu¡”
;

3073 
ext4_g½blk_t
 
blkoff
;

3074 
i
, 
ş’
, 
”r
;

3075 
®»ady_®loÿ‹d_couÁ
;

3077 
şu¡”
 = 
	`EXT4_B2C
(
sbi
, 
block
);

3078 
ş’
 = 
	`EXT4_B2C
(
sbi
, 
Ën
);

3080 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
block
, &
group
, &
blkoff
);

3081 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

3082 ià(
	`IS_ERR
(
b™m­_bh
)) {

3083 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

3084 
b™m­_bh
 = 
NULL
;

3085 
out_”r
;

3088 
”r
 = -
EIO
;

3089 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, &
gdp_bh
);

3090 ià(!
gdp
)

3091 
out_”r
;

3093 ià(!
	`ext4_d©a_block_v®id
(
sbi
, 
block
, 
Ën
)) {

3094 
	`ext4_”rÜ
(
sb
, "Allocating blks %llu-%llu which overlap mdata",

3095 
şu¡”
, clu¡”+
ş’
);

3100 
	`ext4_lock_group
(
sb
, 
group
);

3101 
	`ext4_£t_b™s
(
b™m­_bh
->
b_d©a
, 
blkoff
, 
ş’
);

3102 
	`ext4_uÆock_group
(
sb
, 
group
);

3103 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
NULL
, NULL, 
b™m­_bh
);

3104 ià(!
”r
)

3105 
”r
 = -
EFSCORRUPTED
;

3106 
	`sync_dœty_bufãr
(
b™m­_bh
);

3107 
out_”r
;

3110 
	`ext4_lock_group
(
sb
, 
group
);

3111 
®»ady_®loÿ‹d_couÁ
 = 0;

3112 
i
 = 0; i < 
ş’
; i++)

3113 ià(
	`mb_‹¡_b™
(
blkoff
 + 
i
, 
b™m­_bh
->
b_d©a
))

3114 
®»ady_®loÿ‹d_couÁ
++;

3116 
	`ext4_£t_b™s
(
b™m­_bh
->
b_d©a
, 
blkoff
, 
ş’
);

3117 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

3118 (
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_BLOCK_UNINIT
))) {

3119 
gdp
->
bg_æags
 &ğ
	`ıu_to_Ë16
(~
EXT4_BG_BLOCK_UNINIT
);

3120 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
,

3121 
	`ext4_ä“_şu¡”s_aá”_š™
(
sb
,

3122 
group
, 
gdp
));

3124 
ş’
 = 
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
) - clen +

3125 
®»ady_®loÿ‹d_couÁ
;

3126 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
, 
ş’
);

3127 
	`ext4_block_b™m­_csum_£t
(
sb
, 
group
, 
gdp
, 
b™m­_bh
);

3128 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

3130 
	`ext4_uÆock_group
(
sb
, 
group
);

3132 ià(
sbi
->
s_log_groups_³r_æex
) {

3133 
ext4_group_t
 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
group
);

3135 
	`©omic64_sub
(
Ën
,

3136 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

3139 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
NULL
, NULL, 
b™m­_bh
);

3140 ià(
”r
)

3141 
out_”r
;

3142 
	`sync_dœty_bufãr
(
b™m­_bh
);

3143 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
NULL
, NULL, 
gdp_bh
);

3144 
	`sync_dœty_bufãr
(
gdp_bh
);

3146 
out_”r
:

3147 
	`b»l£
(
b™m­_bh
);

3148 
	}
}

3159 
	$ext4_mb_nÜm®ize_group_»que¡
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3161 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

3162 
ext4_loÿl™y_group
 *
lg
 = 
ac
->
ac_lg
;

3164 
	`BUG_ON
(
lg
 =ğ
NULL
);

3165 
ac
->
ac_g_ex
.
ã_Ën
 = 
	`EXT4_SB
(
sb
)->
s_mb_group_´—Îoc
;

3166 
	`mb_debug
(1, "#%u: goal %u blocks for†ocality group\n",

3167 
cu¼’t
->
pid
, 
ac
->
ac_g_ex
.
ã_Ën
);

3168 
	}
}

3174 
nošlše_fÜ_¡ack
 

3175 
	$ext4_mb_nÜm®ize_»que¡
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

3176 
ext4_®loÿtiÚ_»que¡
 *
¬
)

3178 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

3179 
bsb™s
, 
max
;

3180 
ext4_lblk_t
 
’d
;

3181 
loff_t
 
size
, 
¡¬t_off
;

3182 
loff_t
 
Üig_size
 
__maybe_unu£d
;

3183 
ext4_lblk_t
 
¡¬t
;

3184 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
ac
->
ac_šode
);

3185 
ext4_´—Îoc_¥aû
 *
·
;

3189 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_DATA
))

3193 ià(
	`uÆik–y
(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GOAL_ONLY
))

3198 ià(
ac
->
ac_æags
 & 
EXT4_MB_HINT_NOPREALLOC
)

3201 ià(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GROUP_ALLOC
) {

3202 
	`ext4_mb_nÜm®ize_group_»que¡
(
ac
);

3206 
bsb™s
 = 
ac
->
ac_sb
->
s_blocksize_b™s
;

3210 
size
 = 
ac
->
ac_o_ex
.
ã_logiÿl
 + 
	`EXT4_C2B
(
sbi
,‡c->ac_o_ex.
ã_Ën
);

3211 
size
 = siz<< 
bsb™s
;

3212 ià(
size
 < 
	`i_size_»ad
(
ac
->
ac_šode
))

3213 
size
 = 
	`i_size_»ad
(
ac
->
ac_šode
);

3214 
Üig_size
 = 
size
;

3217 
max
 = 2 << 
bsb™s
;

3219 
	#NRL_CHECK_SIZE
(
»q
, 
size
, 
max
, 
chunk_size
) \

3220 (
»q
 <ğ(
size
è|| 
max
 <ğ(
chunk_size
))

	)

3224 
¡¬t_off
 = 0;

3225 ià(
size
 <= 16 * 1024) {

3226 
size
 = 16 * 1024;

3227 } ià(
size
 <= 32 * 1024) {

3228 
size
 = 32 * 1024;

3229 } ià(
size
 <= 64 * 1024) {

3230 
size
 = 64 * 1024;

3231 } ià(
size
 <= 128 * 1024) {

3232 
size
 = 128 * 1024;

3233 } ià(
size
 <= 256 * 1024) {

3234 
size
 = 256 * 1024;

3235 } ià(
size
 <= 512 * 1024) {

3236 
size
 = 512 * 1024;

3237 } ià(
size
 <= 1024 * 1024) {

3238 
size
 = 1024 * 1024;

3239 } ià(
	`NRL_CHECK_SIZE
(
size
, 4 * 1024 * 1024, 
max
, 2 * 1024)) {

3240 
¡¬t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
ã_logiÿl
 >>

3241 (21 - 
bsb™s
)) << 21;

3242 
size
 = 2 * 1024 * 1024;

3243 } ià(
	`NRL_CHECK_SIZE
(
size
, 8 * 1024 * 1024, 
max
, 4 * 1024)) {

3244 
¡¬t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
ã_logiÿl
 >>

3245 (22 - 
bsb™s
)) << 22;

3246 
size
 = 4 * 1024 * 1024;

3247 } ià(
	`NRL_CHECK_SIZE
(
ac
->
ac_o_ex
.
ã_Ën
,

3248 (8<<20)>>
bsb™s
, 
max
, 8 * 1024)) {

3249 
¡¬t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
ã_logiÿl
 >>

3250 (23 - 
bsb™s
)) << 23;

3251 
size
 = 8 * 1024 * 1024;

3253 
¡¬t_off
 = (
loff_t
è
ac
->
ac_o_ex
.
ã_logiÿl
 << 
bsb™s
;

3254 
size
 = (
loff_t
è
	`EXT4_C2B
(
	`EXT4_SB
(
ac
->
ac_sb
),

3255 
ac
->
ac_o_ex
.
ã_Ën
è<< 
bsb™s
;

3257 
size
 = siz>> 
bsb™s
;

3258 
¡¬t
 = 
¡¬t_off
 >> 
bsb™s
;

3261 ià(
¬
->
¶eá
 && 
¡¬t
 <ğ¬->
Îeá
) {

3262 
size
 -ğ
¬
->
Îeá
 + 1 - 
¡¬t
;

3263 
¡¬t
 = 
¬
->
Îeá
 + 1;

3265 ià(
¬
->
´ight
 && 
¡¬t
 + 
size
 - 1 >ğ¬->
Ìight
)

3266 
size
 -ğ
¡¬t
 + siz- 
¬
->
Ìight
;

3272 ià(
size
 > 
	`EXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
))

3273 
size
 = 
	`EXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
);

3275 
’d
 = 
¡¬t
 + 
size
;

3278 
	`rcu_»ad_lock
();

3279 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
ei
->
i_´—Îoc_li¡
, 
·_šode_li¡
) {

3280 
ext4_lblk_t
 
·_’d
;

3282 ià(
·
->
·_d–‘ed
)

3284 
	`¥š_lock
(&
·
->
·_lock
);

3285 ià(
·
->
·_d–‘ed
) {

3286 
	`¥š_uÆock
(&
·
->
·_lock
);

3290 
·_’d
 = 
·
->
·_l¡¬t
 + 
	`EXT4_C2B
(
	`EXT4_SB
(
ac
->
ac_sb
),

3291 
·
->
·_Ën
);

3294 
	`BUG_ON
(!(
ac
->
ac_o_ex
.
ã_logiÿl
 >ğ
·_’d
 ||

3295 
ac
->
ac_o_ex
.
ã_logiÿl
 < 
·
->
·_l¡¬t
));

3298 ià(
·
->
·_l¡¬t
 >ğ
’d
 || 
·_’d
 <ğ
¡¬t
) {

3299 
	`¥š_uÆock
(&
·
->
·_lock
);

3302 
	`BUG_ON
(
·
->
·_l¡¬t
 <ğ
¡¬t
 && 
·_’d
 >ğ
’d
);

3305 ià(
·_’d
 <ğ
ac
->
ac_o_ex
.
ã_logiÿl
) {

3306 
	`BUG_ON
(
·_’d
 < 
¡¬t
);

3307 
¡¬t
 = 
·_’d
;

3308 } ià(
·
->
·_l¡¬t
 > 
ac
->
ac_o_ex
.
ã_logiÿl
) {

3309 
	`BUG_ON
(
·
->
·_l¡¬t
 > 
’d
);

3310 
’d
 = 
·
->
·_l¡¬t
;

3312 
	`¥š_uÆock
(&
·
->
·_lock
);

3314 
	`rcu_»ad_uÆock
();

3315 
size
 = 
’d
 - 
¡¬t
;

3318 
	`rcu_»ad_lock
();

3319 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
ei
->
i_´—Îoc_li¡
, 
·_šode_li¡
) {

3320 
ext4_lblk_t
 
·_’d
;

3322 
	`¥š_lock
(&
·
->
·_lock
);

3323 ià(
·
->
·_d–‘ed
 == 0) {

3324 
·_’d
 = 
·
->
·_l¡¬t
 + 
	`EXT4_C2B
(
	`EXT4_SB
(
ac
->
ac_sb
),

3325 
·
->
·_Ën
);

3326 
	`BUG_ON
(!(
¡¬t
 >ğ
·_’d
 || 
’d
 <ğ
·
->
·_l¡¬t
));

3328 
	`¥š_uÆock
(&
·
->
·_lock
);

3330 
	`rcu_»ad_uÆock
();

3332 ià(
¡¬t
 + 
size
 <ğ
ac
->
ac_o_ex
.
ã_logiÿl
 &&

3333 
¡¬t
 > 
ac
->
ac_o_ex
.
ã_logiÿl
) {

3334 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
,

3336 (è
¡¬t
, (è
size
,

3337 (è
ac
->
ac_o_ex
.
ã_logiÿl
);

3338 
	`BUG
();

3340 
	`BUG_ON
(
size
 <ğ0 || siz> 
	`EXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
));

3346 
ac
->
ac_g_ex
.
ã_logiÿl
 = 
¡¬t
;

3347 
ac
->
ac_g_ex
.
ã_Ën
 = 
	`EXT4_NUM_B2C
(
sbi
, 
size
);

3350 ià(
¬
->
´ight
 && (¬->
Ìight
 =ğ(
¡¬t
 + 
size
))) {

3352 
	`ext4_g‘_group_no_ªd_off£t
(
ac
->
ac_sb
, 
¬
->
´ight
 - 
size
,

3353 &
ac
->
ac_f_ex
.
ã_group
,

3354 &
ac
->
ac_f_ex
.
ã_¡¬t
);

3355 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_TRY_GOAL
;

3357 ià(
¬
->
¶eá
 && (¬->
Îeá
 + 1 =ğ
¡¬t
)) {

3359 
	`ext4_g‘_group_no_ªd_off£t
(
ac
->
ac_sb
, 
¬
->
¶eá
 + 1,

3360 &
ac
->
ac_f_ex
.
ã_group
,

3361 &
ac
->
ac_f_ex
.
ã_¡¬t
);

3362 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_TRY_GOAL
;

3365 
	`mb_debug
(1, "gßl: %u(wa %uèblock © %u\n", (è
size
,

3366 (è
Üig_size
, (è
¡¬t
);

3367 
	}
}

3369 
	$ext4_mb_cŞËù_¡©s
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3371 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

3373 ià(
sbi
->
s_mb_¡©s
 && 
ac
->
ac_g_ex
.
ã_Ën
 > 1) {

3374 
	`©omic_šc
(&
sbi
->
s_b®_»qs
);

3375 
	`©omic_add
(
ac
->
ac_b_ex
.
ã_Ën
, &
sbi
->
s_b®_®loÿ‹d
);

3376 ià(
ac
->
ac_b_ex
.
ã_Ën
 >ğac->
ac_o_ex
.fe_len)

3377 
	`©omic_šc
(&
sbi
->
s_b®_sucûss
);

3378 
	`©omic_add
(
ac
->
ac_found
, &
sbi
->
s_b®_ex_sÿÂed
);

3379 ià(
ac
->
ac_g_ex
.
ã_¡¬t
 =ğac->
ac_b_ex
.fe_start &&

3380 
ac
->
ac_g_ex
.
ã_group
 =ğac->
ac_b_ex
.fe_group)

3381 
	`©omic_šc
(&
sbi
->
s_b®_gßls
);

3382 ià(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sÿn
)

3383 
	`©omic_šc
(&
sbi
->
s_b®_b»aks
);

3386 ià(
ac
->
ac_İ
 =ğ
EXT4_MB_HISTORY_ALLOC
)

3387 
	`Œaû_ext4_mb®loc_®loc
(
ac
);

3389 
	`Œaû_ext4_mb®loc_´—Îoc
(
ac
);

3390 
	}
}

3398 
	$ext4_disÿrd_®loÿ‹d_blocks
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3400 
ext4_´—Îoc_¥aû
 *
·
 = 
ac
->
ac_·
;

3401 
ext4_buddy
 
e4b
;

3402 
”r
;

3404 ià(
·
 =ğ
NULL
) {

3405 ià(
ac
->
ac_f_ex
.
ã_Ën
 == 0)

3407 
”r
 = 
	`ext4_mb_lßd_buddy
(
ac
->
ac_sb
,‡c->
ac_f_ex
.
ã_group
, &
e4b
);

3408 ià(
”r
) {

3414 
	`WARN
(1, "mb_lßd_buddy faed (%d)", 
”r
);

3417 
	`ext4_lock_group
(
ac
->
ac_sb
,‡c->
ac_f_ex
.
ã_group
);

3418 
	`mb_ä“_blocks
(
ac
->
ac_šode
, &
e4b
,‡c->
ac_f_ex
.
ã_¡¬t
,

3419 
ac
->
ac_f_ex
.
ã_Ën
);

3420 
	`ext4_uÆock_group
(
ac
->
ac_sb
,‡c->
ac_f_ex
.
ã_group
);

3421 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

3424 ià(
·
->
·_ty³
 =ğ
MB_INODE_PA
)

3425 
·
->
·_ä“
 +ğ
ac
->
ac_b_ex
.
ã_Ën
;

3426 
	}
}

3431 
	$ext4_mb_u£_šode_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

3432 
ext4_´—Îoc_¥aû
 *
·
)

3434 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

3435 
ext4_fsblk_t
 
¡¬t
;

3436 
ext4_fsblk_t
 
’d
;

3437 
Ën
;

3440 
¡¬t
 = 
·
->
·_p¡¬t
 + (
ac
->
ac_o_ex
.
ã_logiÿl
 -…a->
·_l¡¬t
);

3441 
’d
 = 
	`mš
(
·
->
·_p¡¬t
 + 
	`EXT4_C2B
(
sbi
,…a->
·_Ën
),

3442 
¡¬t
 + 
	`EXT4_C2B
(
sbi
, 
ac
->
ac_o_ex
.
ã_Ën
));

3443 
Ën
 = 
	`EXT4_NUM_B2C
(
sbi
, 
’d
 - 
¡¬t
);

3444 
	`ext4_g‘_group_no_ªd_off£t
(
ac
->
ac_sb
, 
¡¬t
, &ac->
ac_b_ex
.
ã_group
,

3445 &
ac
->
ac_b_ex
.
ã_¡¬t
);

3446 
ac
->
ac_b_ex
.
ã_Ën
 = 
Ën
;

3447 
ac
->
ac_¡©us
 = 
AC_STATUS_FOUND
;

3448 
ac
->
ac_·
 = 
·
;

3450 
	`BUG_ON
(
¡¬t
 < 
·
->
·_p¡¬t
);

3451 
	`BUG_ON
(
’d
 > 
·
->
·_p¡¬t
 + 
	`EXT4_C2B
(
sbi
,…a->
·_Ën
));

3452 
	`BUG_ON
(
·
->
·_ä“
 < 
Ën
);

3453 
·
->
·_ä“
 -ğ
Ën
;

3455 
	`mb_debug
(1, "u£ %Îu/%u from inod· %p\n", 
¡¬t
, 
Ën
, 
·
);

3456 
	}
}

3461 
	$ext4_mb_u£_group_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

3462 
ext4_´—Îoc_¥aû
 *
·
)

3464 
Ën
 = 
ac
->
ac_o_ex
.
ã_Ën
;

3466 
	`ext4_g‘_group_no_ªd_off£t
(
ac
->
ac_sb
, 
·
->
·_p¡¬t
,

3467 &
ac
->
ac_b_ex
.
ã_group
,

3468 &
ac
->
ac_b_ex
.
ã_¡¬t
);

3469 
ac
->
ac_b_ex
.
ã_Ën
 = 
Ën
;

3470 
ac
->
ac_¡©us
 = 
AC_STATUS_FOUND
;

3471 
ac
->
ac_·
 = 
·
;

3479 
	`mb_debug
(1, "u£ %u/%u from grou°· %p\n", 
·
->
·_l¡¬t
-
Ën
,†en,…a);

3480 
	}
}

3488 
ext4_´—Îoc_¥aû
 *

3489 
	$ext4_mb_check_group_·
(
ext4_fsblk_t
 
gßl_block
,

3490 
ext4_´—Îoc_¥aû
 *
·
,

3491 
ext4_´—Îoc_¥aû
 *
ıa
)

3493 
ext4_fsblk_t
 
cur_di¡ªû
, 
Ãw_di¡ªû
;

3495 ià(
ıa
 =ğ
NULL
) {

3496 
	`©omic_šc
(&
·
->
·_couÁ
);

3497  
·
;

3499 
cur_di¡ªû
 = 
	`abs
(
gßl_block
 - 
ıa
->
·_p¡¬t
);

3500 
Ãw_di¡ªû
 = 
	`abs
(
gßl_block
 - 
·
->
·_p¡¬t
);

3502 ià(
cur_di¡ªû
 <ğ
Ãw_di¡ªû
)

3503  
ıa
;

3506 
	`©omic_dec
(&
ıa
->
·_couÁ
);

3507 
	`©omic_šc
(&
·
->
·_couÁ
);

3508  
·
;

3509 
	}
}

3514 
nošlše_fÜ_¡ack
 

3515 
	$ext4_mb_u£_´—Îoÿ‹d
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3517 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

3518 
Üd”
, 
i
;

3519 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
ac
->
ac_šode
);

3520 
ext4_loÿl™y_group
 *
lg
;

3521 
ext4_´—Îoc_¥aû
 *
·
, *
ıa
 = 
NULL
;

3522 
ext4_fsblk_t
 
gßl_block
;

3525 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_DATA
))

3529 
	`rcu_»ad_lock
();

3530 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
ei
->
i_´—Îoc_li¡
, 
·_šode_li¡
) {

3534 ià(
ac
->
ac_o_ex
.
ã_logiÿl
 < 
·
->
·_l¡¬t
 ||

3535 
ac
->
ac_o_ex
.
ã_logiÿl
 >ğ(
·
->
·_l¡¬t
 +

3536 
	`EXT4_C2B
(
sbi
, 
·
->
·_Ën
)))

3540 ià(!(
	`ext4_‹¡_šode_æag
(
ac
->
ac_šode
, 
EXT4_INODE_EXTENTS
)) &&

3541 (
·
->
·_p¡¬t
 + 
	`EXT4_C2B
(
sbi
,…a->
·_Ën
) >

3542 
EXT4_MAX_BLOCK_FILE_PHYS
))

3546 
	`¥š_lock
(&
·
->
·_lock
);

3547 ià(
·
->
·_d–‘ed
 =ğ0 &&…a->
·_ä“
) {

3548 
	`©omic_šc
(&
·
->
·_couÁ
);

3549 
	`ext4_mb_u£_šode_·
(
ac
, 
·
);

3550 
	`¥š_uÆock
(&
·
->
·_lock
);

3551 
ac
->
ac_ü™”Ÿ
 = 10;

3552 
	`rcu_»ad_uÆock
();

3555 
	`¥š_uÆock
(&
·
->
·_lock
);

3557 
	`rcu_»ad_uÆock
();

3560 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GROUP_ALLOC
))

3564 
lg
 = 
ac
->
ac_lg
;

3565 ià(
lg
 =ğ
NULL
)

3567 
Üd”
 = 
	`æs
(
ac
->
ac_o_ex
.
ã_Ën
) - 1;

3568 ià(
Üd”
 > 
PREALLOC_TB_SIZE
 - 1)

3570 
Üd”
 = 
PREALLOC_TB_SIZE
 - 1;

3572 
gßl_block
 = 
	`ext4_g½_offs_to_block
(
ac
->
ac_sb
, &ac->
ac_g_ex
);

3577 
i
 = 
Üd”
; i < 
PREALLOC_TB_SIZE
; i++) {

3578 
	`rcu_»ad_lock
();

3579 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
lg
->
lg_´—Îoc_li¡
[
i
],

3580 
·_šode_li¡
) {

3581 
	`¥š_lock
(&
·
->
·_lock
);

3582 ià(
·
->
·_d–‘ed
 == 0 &&

3583 
·
->
·_ä“
 >ğ
ac
->
ac_o_ex
.
ã_Ën
) {

3585 
ıa
 = 
	`ext4_mb_check_group_·
(
gßl_block
,

3586 
·
, 
ıa
);

3588 
	`¥š_uÆock
(&
·
->
·_lock
);

3590 
	`rcu_»ad_uÆock
();

3592 ià(
ıa
) {

3593 
	`ext4_mb_u£_group_·
(
ac
, 
ıa
);

3594 
ac
->
ac_ü™”Ÿ
 = 20;

3598 
	}
}

3606 
	$ext4_mb_g’”©e_äom_ä“li¡
(
su³r_block
 *
sb
, *
b™m­
,

3607 
ext4_group_t
 
group
)

3609 
rb_node
 *
n
;

3610 
ext4_group_šfo
 *
g½
;

3611 
ext4_ä“_d©a
 *
’Œy
;

3613 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

3614 
n
 = 
	`rb_fœ¡
(&(
g½
->
bb_ä“_roÙ
));

3616 
n
) {

3617 
’Œy
 = 
	`rb_’Œy
(
n
, 
ext4_ä“_d©a
, 
efd_node
);

3618 
	`ext4_£t_b™s
(
b™m­
, 
’Œy
->
efd_¡¬t_şu¡”
,ƒÁry->
efd_couÁ
);

3619 
n
 = 
	`rb_Ãxt
(n);

3622 
	}
}

3629 
nošlše_fÜ_¡ack


3630 
	$ext4_mb_g’”©e_äom_·
(
su³r_block
 *
sb
, *
b™m­
,

3631 
ext4_group_t
 
group
)

3633 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

3634 
ext4_´—Îoc_¥aû
 *
·
;

3635 
li¡_h—d
 *
cur
;

3636 
ext4_group_t
 
grou²r
;

3637 
ext4_g½blk_t
 
¡¬t
;

3638 
´—Îoÿ‹d
 = 0;

3639 
Ën
;

3649 
	`li¡_fÜ_—ch
(
cur
, &
g½
->
bb_´—Îoc_li¡
) {

3650 
·
 = 
	`li¡_’Œy
(
cur
, 
ext4_´—Îoc_¥aû
, 
·_group_li¡
);

3651 
	`¥š_lock
(&
·
->
·_lock
);

3652 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
,

3653 &
grou²r
, &
¡¬t
);

3654 
Ën
 = 
·
->
·_Ën
;

3655 
	`¥š_uÆock
(&
·
->
·_lock
);

3656 ià(
	`uÆik–y
(
Ën
 == 0))

3658 
	`BUG_ON
(
grou²r
 !ğ
group
);

3659 
	`ext4_£t_b™s
(
b™m­
, 
¡¬t
, 
Ën
);

3660 
´—Îoÿ‹d
 +ğ
Ën
;

3662 
	`mb_debug
(1, "´—Îoÿ‹d %u fÜ grou°%u\n", 
´—Îoÿ‹d
, 
group
);

3663 
	}
}

3665 
	$ext4_mb_·_ÿÎback
(
rcu_h—d
 *
h—d
)

3667 
ext4_´—Îoc_¥aû
 *
·
;

3668 
·
 = 
	`cÚš”_of
(
h—d
, 
ext4_´—Îoc_¥aû
, 
u
.
·_rcu
);

3670 
	`BUG_ON
(
	`©omic_»ad
(&
·
->
·_couÁ
));

3671 
	`BUG_ON
(
·
->
·_d–‘ed
 == 0);

3672 
	`kmem_ÿche_ä“
(
ext4_p¥aû_ÿch•
, 
·
);

3673 
	}
}

3679 
	$ext4_mb_put_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

3680 
su³r_block
 *
sb
, 
ext4_´—Îoc_¥aû
 *
·
)

3682 
ext4_group_t
 
g½
;

3683 
ext4_fsblk_t
 
g½_blk
;

3686 
	`¥š_lock
(&
·
->
·_lock
);

3687 ià(!
	`©omic_dec_ªd_‹¡
(&
·
->
·_couÁ
è||…a->
·_ä“
 != 0) {

3688 
	`¥š_uÆock
(&
·
->
·_lock
);

3692 ià(
·
->
·_d–‘ed
 == 1) {

3693 
	`¥š_uÆock
(&
·
->
·_lock
);

3697 
·
->
·_d–‘ed
 = 1;

3698 
	`¥š_uÆock
(&
·
->
·_lock
);

3700 
g½_blk
 = 
·
->
·_p¡¬t
;

3705 ià(
·
->
·_ty³
 =ğ
MB_GROUP_PA
)

3706 
g½_blk
--;

3708 
g½
 = 
	`ext4_g‘_group_numb”
(
sb
, 
g½_blk
);

3724 
	`ext4_lock_group
(
sb
, 
g½
);

3725 
	`li¡_d–
(&
·
->
·_group_li¡
);

3726 
	`ext4_uÆock_group
(
sb
, 
g½
);

3728 
	`¥š_lock
(
·
->
·_obj_lock
);

3729 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

3730 
	`¥š_uÆock
(
·
->
·_obj_lock
);

3732 
	`ÿÎ_rcu
(&(
·
)->
u
.
·_rcu
, 
ext4_mb_·_ÿÎback
);

3733 
	}
}

3738 
nošlše_fÜ_¡ack
 

3739 
	$ext4_mb_Ãw_šode_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3741 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

3742 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3743 
ext4_´—Îoc_¥aû
 *
·
;

3744 
ext4_group_šfo
 *
g½
;

3745 
ext4_šode_šfo
 *
ei
;

3748 
	`BUG_ON
(
ac
->
ac_o_ex
.
ã_Ën
 >ğac->
ac_b_ex
.fe_len);

3749 
	`BUG_ON
(
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
);

3750 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_šode
->
i_mode
));

3752 
·
 = 
	`kmem_ÿche_®loc
(
ext4_p¥aû_ÿch•
, 
GFP_NOFS
);

3753 ià(
·
 =ğ
NULL
)

3754  -
ENOMEM
;

3756 ià(
ac
->
ac_b_ex
.
ã_Ën
 <‡c->
ac_g_ex
.fe_len) {

3757 
wšl
;

3758 
wšs
;

3759 
wš
;

3760 
offs
;

3765 
	`BUG_ON
(
ac
->
ac_g_ex
.
ã_logiÿl
 >‡c->
ac_o_ex
.fe_logical);

3766 
	`BUG_ON
(
ac
->
ac_g_ex
.
ã_Ën
 <‡c->
ac_o_ex
.fe_len);

3771 
wšl
 = 
ac
->
ac_o_ex
.
ã_logiÿl
 -‡c->
ac_g_ex
.fe_logical;

3774 
wšs
 = 
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
 -‡c->
ac_o_ex
.fe_len);

3777 
wš
 = 
	`mš
(
wšl
, 
wšs
);

3779 
offs
 = 
ac
->
ac_o_ex
.
ã_logiÿl
 %

3780 
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
);

3781 ià(
offs
 && off < 
wš
)

3782 
wš
 = 
offs
;

3784 
ac
->
ac_b_ex
.
ã_logiÿl
 =‡c->
ac_o_ex
.fe_logical -

3785 
	`EXT4_NUM_B2C
(
sbi
, 
wš
);

3786 
	`BUG_ON
(
ac
->
ac_o_ex
.
ã_logiÿl
 <‡c->
ac_b_ex
.fe_logical);

3787 
	`BUG_ON
(
ac
->
ac_o_ex
.
ã_Ën
 >‡c->
ac_b_ex
.fe_len);

3792 
ac
->
ac_f_ex
 =‡c->
ac_b_ex
;

3794 
·
->
·_l¡¬t
 = 
ac
->
ac_b_ex
.
ã_logiÿl
;

3795 
·
->
·_p¡¬t
 = 
	`ext4_g½_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3796 
·
->
·_Ën
 = 
ac
->
ac_b_ex
.
ã_Ën
;

3797 
·
->
·_ä“
 =…a->
·_Ën
;

3798 
	`©omic_£t
(&
·
->
·_couÁ
, 1);

3799 
	`¥š_lock_š™
(&
·
->
·_lock
);

3800 
	`INIT_LIST_HEAD
(&
·
->
·_šode_li¡
);

3801 
	`INIT_LIST_HEAD
(&
·
->
·_group_li¡
);

3802 
·
->
·_d–‘ed
 = 0;

3803 
·
->
·_ty³
 = 
MB_INODE_PA
;

3805 
	`mb_debug
(1, "Ãw inod· %p: %Îu/%u fÜ %u\n", 
·
,

3806 
·
->
·_p¡¬t
,…a->
·_Ën
,…a->
·_l¡¬t
);

3807 
	`Œaû_ext4_mb_Ãw_šode_·
(
ac
, 
·
);

3809 
	`ext4_mb_u£_šode_·
(
ac
, 
·
);

3810 
	`©omic_add
(
·
->
·_ä“
, &
sbi
->
s_mb_´—Îoÿ‹d
);

3812 
ei
 = 
	`EXT4_I
(
ac
->
ac_šode
);

3813 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3815 
·
->
·_obj_lock
 = &
ei
->
i_´—Îoc_lock
;

3816 
·
->
·_šode
 = 
ac
->
ac_šode
;

3818 
	`ext4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3819 
	`li¡_add
(&
·
->
·_group_li¡
, &
g½
->
bb_´—Îoc_li¡
);

3820 
	`ext4_uÆock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3822 
	`¥š_lock
(
·
->
·_obj_lock
);

3823 
	`li¡_add_rcu
(&
·
->
·_šode_li¡
, &
ei
->
i_´—Îoc_li¡
);

3824 
	`¥š_uÆock
(
·
->
·_obj_lock
);

3827 
	}
}

3832 
nošlše_fÜ_¡ack
 

3833 
	$ext4_mb_Ãw_group_·
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3835 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

3836 
ext4_loÿl™y_group
 *
lg
;

3837 
ext4_´—Îoc_¥aû
 *
·
;

3838 
ext4_group_šfo
 *
g½
;

3841 
	`BUG_ON
(
ac
->
ac_o_ex
.
ã_Ën
 >ğac->
ac_b_ex
.fe_len);

3842 
	`BUG_ON
(
ac
->
ac_¡©us
 !ğ
AC_STATUS_FOUND
);

3843 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_šode
->
i_mode
));

3845 
	`BUG_ON
(
ext4_p¥aû_ÿch•
 =ğ
NULL
);

3846 
·
 = 
	`kmem_ÿche_®loc
(
ext4_p¥aû_ÿch•
, 
GFP_NOFS
);

3847 ià(
·
 =ğ
NULL
)

3848  -
ENOMEM
;

3852 
ac
->
ac_f_ex
 =‡c->
ac_b_ex
;

3854 
·
->
·_p¡¬t
 = 
	`ext4_g½_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3855 
·
->
·_l¡¬t
 =…a->
·_p¡¬t
;

3856 
·
->
·_Ën
 = 
ac
->
ac_b_ex
.
ã_Ën
;

3857 
·
->
·_ä“
 =…a->
·_Ën
;

3858 
	`©omic_£t
(&
·
->
·_couÁ
, 1);

3859 
	`¥š_lock_š™
(&
·
->
·_lock
);

3860 
	`INIT_LIST_HEAD
(&
·
->
·_šode_li¡
);

3861 
	`INIT_LIST_HEAD
(&
·
->
·_group_li¡
);

3862 
·
->
·_d–‘ed
 = 0;

3863 
·
->
·_ty³
 = 
MB_GROUP_PA
;

3865 
	`mb_debug
(1, "Ãw grou°· %p: %Îu/%u fÜ %u\n", 
·
,

3866 
·
->
·_p¡¬t
,…a->
·_Ën
,…a->
·_l¡¬t
);

3867 
	`Œaû_ext4_mb_Ãw_group_·
(
ac
, 
·
);

3869 
	`ext4_mb_u£_group_·
(
ac
, 
·
);

3870 
	`©omic_add
(
·
->
·_ä“
, &
	`EXT4_SB
(
sb
)->
s_mb_´—Îoÿ‹d
);

3872 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3873 
lg
 = 
ac
->
ac_lg
;

3874 
	`BUG_ON
(
lg
 =ğ
NULL
);

3876 
·
->
·_obj_lock
 = &
lg
->
lg_´—Îoc_lock
;

3877 
·
->
·_šode
 = 
NULL
;

3879 
	`ext4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3880 
	`li¡_add
(&
·
->
·_group_li¡
, &
g½
->
bb_´—Îoc_li¡
);

3881 
	`ext4_uÆock_group
(
sb
, 
ac
->
ac_b_ex
.
ã_group
);

3888 
	}
}

3890 
	$ext4_mb_Ãw_´—ÎoÿtiÚ
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

3892 
”r
;

3894 ià(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GROUP_ALLOC
)

3895 
”r
 = 
	`ext4_mb_Ãw_group_·
(
ac
);

3897 
”r
 = 
	`ext4_mb_Ãw_šode_·
(
ac
);

3898  
”r
;

3899 
	}
}

3909 
nošlše_fÜ_¡ack
 

3910 
	$ext4_mb_»Ëa£_šode_·
(
ext4_buddy
 *
e4b
, 
bufãr_h—d
 *
b™m­_bh
,

3911 
ext4_´—Îoc_¥aû
 *
·
)

3913 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

3914 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3915 
’d
;

3916 
Ãxt
;

3917 
ext4_group_t
 
group
;

3918 
ext4_g½blk_t
 
b™
;

3919 
g½_blk_¡¬t
;

3920 
”r
 = 0;

3921 
ä“
 = 0;

3923 
	`BUG_ON
(
·
->
·_d–‘ed
 == 0);

3924 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
, &
group
, &
b™
);

3925 
g½_blk_¡¬t
 = 
·
->
·_p¡¬t
 - 
	`EXT4_C2B
(
sbi
, 
b™
);

3926 
	`BUG_ON
(
group
 !ğ
e4b
->
bd_group
 && 
·
->
·_Ën
 != 0);

3927 
’d
 = 
b™
 + 
·
->
·_Ën
;

3929 
b™
 < 
’d
) {

3930 
b™
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­_bh
->
b_d©a
, 
’d
, bit);

3931 ià(
b™
 >ğ
’d
)

3933 
Ãxt
 = 
	`mb_fšd_Ãxt_b™
(
b™m­_bh
->
b_d©a
, 
’d
, 
b™
);

3934 
	`mb_debug
(1, " free…reallocated %u/%u in group %u\n",

3935 (è
	`ext4_group_fœ¡_block_no
(
sb
, 
group
è+ 
b™
,

3936 (è
Ãxt
 - 
b™
, (è
group
);

3937 
ä“
 +ğ
Ãxt
 - 
b™
;

3939 
	`Œaû_ext4_mb®loc_disÿrd
(
sb
, 
NULL
, 
group
, 
b™
, 
Ãxt
 - bit);

3940 
	`Œaû_ext4_mb_»Ëa£_šode_·
(
·
, (
g½_blk_¡¬t
 +

3941 
	`EXT4_C2B
(
sbi
, 
b™
)),

3942 
Ãxt
 - 
b™
);

3943 
	`mb_ä“_blocks
(
·
->
·_šode
, 
e4b
, 
b™
, 
Ãxt
 - bit);

3944 
b™
 = 
Ãxt
 + 1;

3946 ià(
ä“
 !ğ
·
->
·_ä“
) {

3947 
	`ext4_msg
(
e4b
->
bd_sb
, 
KERN_CRIT
,

3949 
·
, (è·->
·_l¡¬t
,

3950 (è
·
->
·_p¡¬t
,

3951 (è
·
->
·_Ën
);

3952 
	`ext4_g½_locked_”rÜ
(
sb
, 
group
, 0, 0, "free %u,…a_free %u",

3953 
ä“
, 
·
->
·_ä“
);

3959 
	`©omic_add
(
ä“
, &
sbi
->
s_mb_disÿrded
);

3961  
”r
;

3962 
	}
}

3964 
nošlše_fÜ_¡ack
 

3965 
	$ext4_mb_»Ëa£_group_·
(
ext4_buddy
 *
e4b
,

3966 
ext4_´—Îoc_¥aû
 *
·
)

3968 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

3969 
ext4_group_t
 
group
;

3970 
ext4_g½blk_t
 
b™
;

3972 
	`Œaû_ext4_mb_»Ëa£_group_·
(
sb
, 
·
);

3973 
	`BUG_ON
(
·
->
·_d–‘ed
 == 0);

3974 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
, &
group
, &
b™
);

3975 
	`BUG_ON
(
group
 !ğ
e4b
->
bd_group
 && 
·
->
·_Ën
 != 0);

3976 
	`mb_ä“_blocks
(
·
->
·_šode
, 
e4b
, 
b™
,…a->
·_Ën
);

3977 
	`©omic_add
(
·
->
·_Ën
, &
	`EXT4_SB
(
sb
)->
s_mb_disÿrded
);

3978 
	`Œaû_ext4_mb®loc_disÿrd
(
sb
, 
NULL
, 
group
, 
b™
, 
·
->
·_Ën
);

3981 
	}
}

3992 
nošlše_fÜ_¡ack
 

3993 
	$ext4_mb_disÿrd_group_´—ÎoÿtiÚs
(
su³r_block
 *
sb
,

3994 
ext4_group_t
 
group
, 
Ãeded
)

3996 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

3997 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

3998 
ext4_´—Îoc_¥aû
 *
·
, *
tmp
;

3999 
li¡_h—d
 
li¡
;

4000 
ext4_buddy
 
e4b
;

4001 
”r
;

4002 
busy
 = 0;

4003 
ä“
 = 0;

4005 
	`mb_debug
(1, "disÿrd…»®loÿtiÚ fÜ grou°%u\n", 
group
);

4007 ià(
	`li¡_em±y
(&
g½
->
bb_´—Îoc_li¡
))

4010 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

4011 ià(
	`IS_ERR
(
b™m­_bh
)) {

4012 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

4013 
	`ext4_”rÜ
(
sb
, "Error %d„eading block bitmap for %u",

4014 
”r
, 
group
);

4018 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

4019 ià(
”r
) {

4020 
	`ext4_w¬nšg
(
sb
, "Error %d†oading buddy information for %u",

4021 
”r
, 
group
);

4022 
	`put_bh
(
b™m­_bh
);

4026 ià(
Ãeded
 == 0)

4027 
Ãeded
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) + 1;

4029 
	`INIT_LIST_HEAD
(&
li¡
);

4030 
»³©
:

4031 
	`ext4_lock_group
(
sb
, 
group
);

4032 
	`li¡_fÜ_—ch_’Œy_§ã
(
·
, 
tmp
,

4033 &
g½
->
bb_´—Îoc_li¡
, 
·_group_li¡
) {

4034 
	`¥š_lock
(&
·
->
·_lock
);

4035 ià(
	`©omic_»ad
(&
·
->
·_couÁ
)) {

4036 
	`¥š_uÆock
(&
·
->
·_lock
);

4037 
busy
 = 1;

4040 ià(
·
->
·_d–‘ed
) {

4041 
	`¥š_uÆock
(&
·
->
·_lock
);

4046 
·
->
·_d–‘ed
 = 1;

4049 
ä“
 +ğ
·
->
·_ä“
;

4051 
	`¥š_uÆock
(&
·
->
·_lock
);

4053 
	`li¡_d–
(&
·
->
·_group_li¡
);

4054 
	`li¡_add
(&
·
->
u
.
·_tmp_li¡
, &
li¡
);

4058 ià(
ä“
 < 
Ãeded
 && 
busy
) {

4059 
busy
 = 0;

4060 
	`ext4_uÆock_group
(
sb
, 
group
);

4061 
	`cÚd_»sched
();

4062 
»³©
;

4066 ià(
	`li¡_em±y
(&
li¡
)) {

4067 
	`BUG_ON
(
ä“
 != 0);

4068 
out
;

4072 
	`li¡_fÜ_—ch_’Œy_§ã
(
·
, 
tmp
, &
li¡
, 
u
.
·_tmp_li¡
) {

4075 
	`¥š_lock
(
·
->
·_obj_lock
);

4076 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

4077 
	`¥š_uÆock
(
·
->
·_obj_lock
);

4079 ià(
·
->
·_ty³
 =ğ
MB_GROUP_PA
)

4080 
	`ext4_mb_»Ëa£_group_·
(&
e4b
, 
·
);

4082 
	`ext4_mb_»Ëa£_šode_·
(&
e4b
, 
b™m­_bh
, 
·
);

4084 
	`li¡_d–
(&
·
->
u
.
·_tmp_li¡
);

4085 
	`ÿÎ_rcu
(&(
·
)->
u
.
·_rcu
, 
ext4_mb_·_ÿÎback
);

4088 
out
:

4089 
	`ext4_uÆock_group
(
sb
, 
group
);

4090 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

4091 
	`put_bh
(
b™m­_bh
);

4092  
ä“
;

4093 
	}
}

4104 
	$ext4_disÿrd_´—ÎoÿtiÚs
(
šode
 *inode)

4106 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

4107 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4108 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

4109 
ext4_´—Îoc_¥aû
 *
·
, *
tmp
;

4110 
ext4_group_t
 
group
 = 0;

4111 
li¡_h—d
 
li¡
;

4112 
ext4_buddy
 
e4b
;

4113 
”r
;

4115 ià(!
	`S_ISREG
(
šode
->
i_mode
)) {

4120 
	`mb_debug
(1, "disÿrd…»®loÿtiÚ fÜ inod%lu\n", 
šode
->
i_šo
);

4121 
	`Œaû_ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

4123 
	`INIT_LIST_HEAD
(&
li¡
);

4125 
»³©
:

4127 
	`¥š_lock
(&
ei
->
i_´—Îoc_lock
);

4128 !
	`li¡_em±y
(&
ei
->
i_´—Îoc_li¡
)) {

4129 
·
 = 
	`li¡_’Œy
(
ei
->
i_´—Îoc_li¡
.
Ãxt
,

4130 
ext4_´—Îoc_¥aû
, 
·_šode_li¡
);

4131 
	`BUG_ON
(
·
->
·_obj_lock
 !ğ&
ei
->
i_´—Îoc_lock
);

4132 
	`¥š_lock
(&
·
->
·_lock
);

4133 ià(
	`©omic_»ad
(&
·
->
·_couÁ
)) {

4136 
	`¥š_uÆock
(&
·
->
·_lock
);

4137 
	`¥š_uÆock
(&
ei
->
i_´—Îoc_lock
);

4138 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4140 
	`WARN_ON
(1);

4141 
	`scheduË_timeout_unš‹¼u±ibË
(
HZ
);

4142 
»³©
;

4145 ià(
·
->
·_d–‘ed
 == 0) {

4146 
·
->
·_d–‘ed
 = 1;

4147 
	`¥š_uÆock
(&
·
->
·_lock
);

4148 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

4149 
	`li¡_add
(&
·
->
u
.
·_tmp_li¡
, &
li¡
);

4154 
	`¥š_uÆock
(&
·
->
·_lock
);

4155 
	`¥š_uÆock
(&
ei
->
i_´—Îoc_lock
);

4169 
	`scheduË_timeout_unš‹¼u±ibË
(
HZ
);

4170 
»³©
;

4172 
	`¥š_uÆock
(&
ei
->
i_´—Îoc_lock
);

4174 
	`li¡_fÜ_—ch_’Œy_§ã
(
·
, 
tmp
, &
li¡
, 
u
.
·_tmp_li¡
) {

4175 
	`BUG_ON
(
·
->
·_ty³
 !ğ
MB_INODE_PA
);

4176 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
·
->
·_p¡¬t
);

4178 
”r
 = 
	`ext4_mb_lßd_buddy_gå
(
sb
, 
group
, &
e4b
,

4179 
GFP_NOFS
|
__GFP_NOFAIL
);

4180 ià(
”r
) {

4181 
	`ext4_”rÜ
(
sb
, "Error %d†oading buddy information for %u",

4182 
”r
, 
group
);

4186 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

4187 ià(
	`IS_ERR
(
b™m­_bh
)) {

4188 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

4189 
	`ext4_”rÜ
(
sb
, "Error %d„eading block bitmap for %u",

4190 
”r
, 
group
);

4191 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

4195 
	`ext4_lock_group
(
sb
, 
group
);

4196 
	`li¡_d–
(&
·
->
·_group_li¡
);

4197 
	`ext4_mb_»Ëa£_šode_·
(&
e4b
, 
b™m­_bh
, 
·
);

4198 
	`ext4_uÆock_group
(
sb
, 
group
);

4200 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

4201 
	`put_bh
(
b™m­_bh
);

4203 
	`li¡_d–
(&
·
->
u
.
·_tmp_li¡
);

4204 
	`ÿÎ_rcu
(&(
·
)->
u
.
·_rcu
, 
ext4_mb_·_ÿÎback
);

4206 
	}
}

4208 #ifdeà
CONFIG_EXT4_DEBUG


4209 
	$ext4_mb_show_ac
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4211 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

4212 
ext4_group_t
 
ngroups
, 
i
;

4214 ià(!
ext4_mb®loc_debug
 ||

4215 (
	`EXT4_SB
(
sb
)->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
))

4218 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "Can't‡llocate:"

4220 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "status %d flags %d",

4221 
ac
->
ac_¡©us
,‡c->
ac_æags
);

4222 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "orig %lu/%lu/%lu@%lu, "

4225 ()
ac
->
ac_o_ex
.
ã_group
,

4226 ()
ac
->
ac_o_ex
.
ã_¡¬t
,

4227 ()
ac
->
ac_o_ex
.
ã_Ën
,

4228 ()
ac
->
ac_o_ex
.
ã_logiÿl
,

4229 ()
ac
->
ac_g_ex
.
ã_group
,

4230 ()
ac
->
ac_g_ex
.
ã_¡¬t
,

4231 ()
ac
->
ac_g_ex
.
ã_Ën
,

4232 ()
ac
->
ac_g_ex
.
ã_logiÿl
,

4233 ()
ac
->
ac_b_ex
.
ã_group
,

4234 ()
ac
->
ac_b_ex
.
ã_¡¬t
,

4235 ()
ac
->
ac_b_ex
.
ã_Ën
,

4236 ()
ac
->
ac_b_ex
.
ã_logiÿl
,

4237 ()
ac
->
ac_ü™”Ÿ
);

4238 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "%d found",‡c->
ac_found
);

4239 
	`ext4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "groups: ");

4240 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

4241 
i
 = 0; i < 
ngroups
; i++) {

4242 
ext4_group_šfo
 *
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
i
);

4243 
ext4_´—Îoc_¥aû
 *
·
;

4244 
ext4_g½blk_t
 
¡¬t
;

4245 
li¡_h—d
 *
cur
;

4246 
	`ext4_lock_group
(
sb
, 
i
);

4247 
	`li¡_fÜ_—ch
(
cur
, &
g½
->
bb_´—Îoc_li¡
) {

4248 
·
 = 
	`li¡_’Œy
(
cur
, 
ext4_´—Îoc_¥aû
,

4249 
·_group_li¡
);

4250 
	`¥š_lock
(&
·
->
·_lock
);

4251 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
·
->
·_p¡¬t
,

4252 
NULL
, &
¡¬t
);

4253 
	`¥š_uÆock
(&
·
->
·_lock
);

4254 
	`´štk
(
KERN_ERR
 "PA:%u:%d:%u \n", 
i
,

4255 
¡¬t
, 
·
->
·_Ën
);

4257 
	`ext4_uÆock_group
(
sb
, 
i
);

4259 ià(
g½
->
bb_ä“
 == 0)

4261 
	`´štk
(
KERN_ERR
 "%u: %d/%d \n",

4262 
i
, 
g½
->
bb_ä“
, g½->
bb_äagm’ts
);

4264 
	`´štk
(
KERN_ERR
 "\n");

4265 
	}
}

4267 
šlše
 
	$ext4_mb_show_ac
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4270 
	}
}

4280 
	$ext4_mb_group_Ü_fe
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4282 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

4283 
bsb™s
 = 
ac
->
ac_sb
->
s_blocksize_b™s
;

4284 
loff_t
 
size
, 
isize
;

4286 ià(!(
ac
->
ac_æags
 & 
EXT4_MB_HINT_DATA
))

4289 ià(
	`uÆik–y
(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GOAL_ONLY
))

4292 
size
 = 
ac
->
ac_o_ex
.
ã_logiÿl
 + 
	`EXT4_C2B
(
sbi
,‡c->ac_o_ex.
ã_Ën
);

4293 
isize
 = (
	`i_size_»ad
(
ac
->
ac_šode
è+‡c->
ac_sb
->
s_blocksize
 - 1)

4294 >> 
bsb™s
;

4296 ià((
size
 =ğ
isize
) &&

4297 !
	`ext4_fs_is_busy
(
sbi
) &&

4298 (
	`©omic_»ad
(&
ac
->
ac_šode
->
i_wr™ecouÁ
) == 0)) {

4299 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_NOPREALLOC
;

4303 ià(
sbi
->
s_mb_group_´—Îoc
 <= 0) {

4304 
ac
->
ac_æags
 |ğ
EXT4_MB_STREAM_ALLOC
;

4309 
size
 = 
	`max
(size, 
isize
);

4310 ià(
size
 > 
sbi
->
s_mb_¡»am_»que¡
) {

4311 
ac
->
ac_æags
 |ğ
EXT4_MB_STREAM_ALLOC
;

4315 
	`BUG_ON
(
ac
->
ac_lg
 !ğ
NULL
);

4321 
ac
->
ac_lg
 = 
	`¿w_ıu_±r
(
sbi
->
s_loÿl™y_groups
);

4324 
ac
->
ac_æags
 |ğ
EXT4_MB_HINT_GROUP_ALLOC
;

4327 
	`mu‹x_lock
(&
ac
->
ac_lg
->
lg_mu‹x
);

4328 
	}
}

4330 
nošlše_fÜ_¡ack
 

4331 
	$ext4_mb_š™Ÿlize_cÚ‹xt
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
,

4332 
ext4_®loÿtiÚ_»que¡
 *
¬
)

4334 
su³r_block
 *
sb
 = 
¬
->
šode
->
i_sb
;

4335 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4336 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

4337 
ext4_group_t
 
group
;

4338 
Ën
;

4339 
ext4_fsblk_t
 
gßl
;

4340 
ext4_g½blk_t
 
block
;

4343 
Ën
 = 
¬
->len;

4346 ià(
Ën
 >ğ
	`EXT4_CLUSTERS_PER_GROUP
(
sb
))

4347 
Ën
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
);

4350 
gßl
 = 
¬
->goal;

4351 ià(
gßl
 < 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
) ||

4352 
gßl
 >ğ
	`ext4_blocks_couÁ
(
es
))

4353 
gßl
 = 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
);

4354 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
gßl
, &
group
, &
block
);

4357 
ac
->
ac_b_ex
.
ã_logiÿl
 = 
	`EXT4_LBLK_CMASK
(
sbi
, 
¬
->
logiÿl
);

4358 
ac
->
ac_¡©us
 = 
AC_STATUS_CONTINUE
;

4359 
ac
->
ac_sb
 = 
sb
;

4360 
ac
->
ac_šode
 = 
¬
->
šode
;

4361 
ac
->
ac_o_ex
.
ã_logiÿl
 =‡c->
ac_b_ex
.fe_logical;

4362 
ac
->
ac_o_ex
.
ã_group
 = 
group
;

4363 
ac
->
ac_o_ex
.
ã_¡¬t
 = 
block
;

4364 
ac
->
ac_o_ex
.
ã_Ën
 = 
Ën
;

4365 
ac
->
ac_g_ex
 =‡c->
ac_o_ex
;

4366 
ac
->
ac_æags
 = 
¬
->
æags
;

4370 
	`ext4_mb_group_Ü_fe
(
ac
);

4372 
	`mb_debug
(1, "init‡c: %u blocks @ %u, goal %u, flags %x, 2^%d, "

4374 (è
¬
->
Ën
, (è¬->
logiÿl
,

4375 (è
¬
->
gßl
, 
ac
->
ac_æags
,‡c->
ac_2Üd”
,

4376 (è
¬
->
Îeá
, (è¬->
¶eá
,

4377 (è
¬
->
Ìight
, (è¬->
´ight
,

4378 
	`©omic_»ad
(&
¬
->
šode
->
i_wr™ecouÁ
) ? "" : "non-");

4381 
	}
}

4383 
nošlše_fÜ_¡ack
 

4384 
	$ext4_mb_disÿrd_lg_´—ÎoÿtiÚs
(
su³r_block
 *
sb
,

4385 
ext4_loÿl™y_group
 *
lg
,

4386 
Üd”
, 
tÙ®_’Œ›s
)

4388 
ext4_group_t
 
group
 = 0;

4389 
ext4_buddy
 
e4b
;

4390 
li¡_h—d
 
disÿrd_li¡
;

4391 
ext4_´—Îoc_¥aû
 *
·
, *
tmp
;

4393 
	`mb_debug
(1, "discard†ocality group…reallocation\n");

4395 
	`INIT_LIST_HEAD
(&
disÿrd_li¡
);

4397 
	`¥š_lock
(&
lg
->
lg_´—Îoc_lock
);

4398 
	`li¡_fÜ_—ch_’Œy_rcu
(
·
, &
lg
->
lg_´—Îoc_li¡
[
Üd”
],

4399 
·_šode_li¡
) {

4400 
	`¥š_lock
(&
·
->
·_lock
);

4401 ià(
	`©omic_»ad
(&
·
->
·_couÁ
)) {

4407 
	`¥š_uÆock
(&
·
->
·_lock
);

4410 ià(
·
->
·_d–‘ed
) {

4411 
	`¥š_uÆock
(&
·
->
·_lock
);

4415 
	`BUG_ON
(
·
->
·_ty³
 !ğ
MB_GROUP_PA
);

4418 
·
->
·_d–‘ed
 = 1;

4419 
	`¥š_uÆock
(&
·
->
·_lock
);

4421 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

4422 
	`li¡_add
(&
·
->
u
.
·_tmp_li¡
, &
disÿrd_li¡
);

4424 
tÙ®_’Œ›s
--;

4425 ià(
tÙ®_’Œ›s
 <= 5) {

4435 
	`¥š_uÆock
(&
lg
->
lg_´—Îoc_lock
);

4437 
	`li¡_fÜ_—ch_’Œy_§ã
(
·
, 
tmp
, &
disÿrd_li¡
, 
u
.
·_tmp_li¡
) {

4438 
”r
;

4440 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
·
->
·_p¡¬t
);

4441 
”r
 = 
	`ext4_mb_lßd_buddy_gå
(
sb
, 
group
, &
e4b
,

4442 
GFP_NOFS
|
__GFP_NOFAIL
);

4443 ià(
”r
) {

4444 
	`ext4_”rÜ
(
sb
, "Error %d†oading buddy information for %u",

4445 
”r
, 
group
);

4448 
	`ext4_lock_group
(
sb
, 
group
);

4449 
	`li¡_d–
(&
·
->
·_group_li¡
);

4450 
	`ext4_mb_»Ëa£_group_·
(&
e4b
, 
·
);

4451 
	`ext4_uÆock_group
(
sb
, 
group
);

4453 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

4454 
	`li¡_d–
(&
·
->
u
.
·_tmp_li¡
);

4455 
	`ÿÎ_rcu
(&(
·
)->
u
.
·_rcu
, 
ext4_mb_·_ÿÎback
);

4457 
	}
}

4468 
	$ext4_mb_add_n_Œim
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4470 
Üd”
, 
added
 = 0, 
lg_´—Îoc_couÁ
 = 1;

4471 
su³r_block
 *
sb
 = 
ac
->
ac_sb
;

4472 
ext4_loÿl™y_group
 *
lg
 = 
ac
->
ac_lg
;

4473 
ext4_´—Îoc_¥aû
 *
tmp_·
, *
·
 = 
ac
->
ac_·
;

4475 
Üd”
 = 
	`æs
(
·
->
·_ä“
) - 1;

4476 ià(
Üd”
 > 
PREALLOC_TB_SIZE
 - 1)

4478 
Üd”
 = 
PREALLOC_TB_SIZE
 - 1;

4480 
	`¥š_lock
(&
lg
->
lg_´—Îoc_lock
);

4481 
	`li¡_fÜ_—ch_’Œy_rcu
(
tmp_·
, &
lg
->
lg_´—Îoc_li¡
[
Üd”
],

4482 
·_šode_li¡
) {

4483 
	`¥š_lock
(&
tmp_·
->
·_lock
);

4484 ià(
tmp_·
->
·_d–‘ed
) {

4485 
	`¥š_uÆock
(&
tmp_·
->
·_lock
);

4488 ià(!
added
 && 
·
->
·_ä“
 < 
tmp_·
->pa_free) {

4490 
	`li¡_add__rcu
(&
·
->
·_šode_li¡
,

4491 &
tmp_·
->
·_šode_li¡
);

4492 
added
 = 1;

4498 
	`¥š_uÆock
(&
tmp_·
->
·_lock
);

4499 
lg_´—Îoc_couÁ
++;

4501 ià(!
added
)

4502 
	`li¡_add__rcu
(&
·
->
·_šode_li¡
,

4503 &
lg
->
lg_´—Îoc_li¡
[
Üd”
]);

4504 
	`¥š_uÆock
(&
lg
->
lg_´—Îoc_lock
);

4507 ià(
lg_´—Îoc_couÁ
 > 8) {

4508 
	`ext4_mb_disÿrd_lg_´—ÎoÿtiÚs
(
sb
, 
lg
,

4509 
Üd”
, 
lg_´—Îoc_couÁ
);

4513 
	}
}

4518 
	$ext4_mb_»Ëa£_cÚ‹xt
(
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
)

4520 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
ac
->
ac_sb
);

4521 
ext4_´—Îoc_¥aû
 *
·
 = 
ac
->
ac_·
;

4522 ià(
·
) {

4523 ià(
·
->
·_ty³
 =ğ
MB_GROUP_PA
) {

4525 
	`¥š_lock
(&
·
->
·_lock
);

4526 
·
->
·_p¡¬t
 +ğ
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
);

4527 
·
->
·_l¡¬t
 +ğ
	`EXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
ã_Ën
);

4528 
·
->
·_ä“
 -ğ
ac
->
ac_b_ex
.
ã_Ën
;

4529 
·
->
·_Ën
 -ğ
ac
->
ac_b_ex
.
ã_Ën
;

4530 
	`¥š_uÆock
(&
·
->
·_lock
);

4533 ià(
·
) {

4540 ià((
·
->
·_ty³
 =ğ
MB_GROUP_PA
è&& 
	`lik–y
Õa->
·_ä“
)) {

4541 
	`¥š_lock
(
·
->
·_obj_lock
);

4542 
	`li¡_d–_rcu
(&
·
->
·_šode_li¡
);

4543 
	`¥š_uÆock
(
·
->
·_obj_lock
);

4544 
	`ext4_mb_add_n_Œim
(
ac
);

4546 
	`ext4_mb_put_·
(
ac
,‡c->
ac_sb
, 
·
);

4548 ià(
ac
->
ac_b™m­_·ge
)

4549 
	`put_·ge
(
ac
->
ac_b™m­_·ge
);

4550 ià(
ac
->
ac_buddy_·ge
)

4551 
	`put_·ge
(
ac
->
ac_buddy_·ge
);

4552 ià(
ac
->
ac_æags
 & 
EXT4_MB_HINT_GROUP_ALLOC
)

4553 
	`mu‹x_uÆock
(&
ac
->
ac_lg
->
lg_mu‹x
);

4554 
	`ext4_mb_cŞËù_¡©s
(
ac
);

4556 
	}
}

4558 
	$ext4_mb_disÿrd_´—ÎoÿtiÚs
(
su³r_block
 *
sb
, 
Ãeded
)

4560 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

4561 
»t
;

4562 
ä“d
 = 0;

4564 
	`Œaû_ext4_mb_disÿrd_´—ÎoÿtiÚs
(
sb
, 
Ãeded
);

4565 
i
 = 0; i < 
ngroups
 && 
Ãeded
 > 0; i++) {

4566 
»t
 = 
	`ext4_mb_disÿrd_group_´—ÎoÿtiÚs
(
sb
, 
i
, 
Ãeded
);

4567 
ä“d
 +ğ
»t
;

4568 
Ãeded
 -ğ
»t
;

4571  
ä“d
;

4572 
	}
}

4579 
ext4_fsblk_t
 
	$ext4_mb_Ãw_blocks
(
hªdË_t
 *
hªdË
,

4580 
ext4_®loÿtiÚ_»que¡
 *
¬
, *
”½
)

4582 
ä“d
;

4583 
ext4_®loÿtiÚ_cÚ‹xt
 *
ac
 = 
NULL
;

4584 
ext4_sb_šfo
 *
sbi
;

4585 
su³r_block
 *
sb
;

4586 
ext4_fsblk_t
 
block
 = 0;

4587 
šquÙa
 = 0;

4588 
»£rv_ş¡rs
 = 0;

4590 
	`might_¦“p
();

4591 
sb
 = 
¬
->
šode
->
i_sb
;

4592 
sbi
 = 
	`EXT4_SB
(
sb
);

4594 
	`Œaû_ext4_»que¡_blocks
(
¬
);

4597 ià(
	`ext4_is_quÙa_fe
(
¬
->
šode
))

4598 
¬
->
æags
 |ğ
EXT4_MB_USE_ROOT_BLOCKS
;

4600 ià((
¬
->
æags
 & 
EXT4_MB_DELALLOC_RESERVED
) == 0) {

4605 
¬
->
Ën
 &&

4606 
	`ext4_şaim_ä“_şu¡”s
(
sbi
, 
¬
->
Ën
,‡r->
æags
)) {

4609 
	`cÚd_»sched
();

4610 
¬
->
Ën
 =‡r->len >> 1;

4612 ià(!
¬
->
Ën
) {

4613 *
”½
 = -
ENOSPC
;

4616 
»£rv_ş¡rs
 = 
¬
->
Ën
;

4617 ià(
¬
->
æags
 & 
EXT4_MB_USE_ROOT_BLOCKS
) {

4618 
	`dquÙ_®loc_block_noç
(
¬
->
šode
,

4619 
	`EXT4_C2B
(
sbi
, 
¬
->
Ën
));

4621 
¬
->
Ën
 &&

4622 
	`dquÙ_®loc_block
(
¬
->
šode
,

4623 
	`EXT4_C2B
(
sbi
, 
¬
->
Ën
))) {

4625 
¬
->
æags
 |ğ
EXT4_MB_HINT_NOPREALLOC
;

4626 
¬
->
Ën
--;

4629 
šquÙa
 = 
¬
->
Ën
;

4630 ià(
¬
->
Ën
 == 0) {

4631 *
”½
 = -
EDQUOT
;

4632 
out
;

4636 
ac
 = 
	`kmem_ÿche_z®loc
(
ext4_ac_ÿch•
, 
GFP_NOFS
);

4637 ià(!
ac
) {

4638 
¬
->
Ën
 = 0;

4639 *
”½
 = -
ENOMEM
;

4640 
out
;

4643 *
”½
 = 
	`ext4_mb_š™Ÿlize_cÚ‹xt
(
ac
, 
¬
);

4644 ià(*
”½
) {

4645 
¬
->
Ën
 = 0;

4646 
out
;

4649 
ac
->
ac_İ
 = 
EXT4_MB_HISTORY_PREALLOC
;

4650 ià(!
	`ext4_mb_u£_´—Îoÿ‹d
(
ac
)) {

4651 
ac
->
ac_İ
 = 
EXT4_MB_HISTORY_ALLOC
;

4652 
	`ext4_mb_nÜm®ize_»que¡
(
ac
, 
¬
);

4653 
»³©
:

4655 *
”½
 = 
	`ext4_mb_»guÏr_®loÿtÜ
(
ac
);

4656 ià(*
”½
)

4657 
disÿrd_ªd_ex™
;

4662 ià(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
 &&

4663 
ac
->
ac_o_ex
.
ã_Ën
 <‡c->
ac_b_ex
.fe_len)

4664 *
”½
 = 
	`ext4_mb_Ãw_´—ÎoÿtiÚ
(
ac
);

4665 ià(*
”½
) {

4666 
disÿrd_ªd_ex™
:

4667 
	`ext4_disÿrd_®loÿ‹d_blocks
(
ac
);

4668 
”rout
;

4671 ià(
	`lik–y
(
ac
->
ac_¡©us
 =ğ
AC_STATUS_FOUND
)) {

4672 *
”½
 = 
	`ext4_mb_m¬k_disk¥aû_u£d
(
ac
, 
hªdË
, 
»£rv_ş¡rs
);

4673 ià(*
”½
) {

4674 
	`ext4_disÿrd_®loÿ‹d_blocks
(
ac
);

4675 
”rout
;

4677 
block
 = 
	`ext4_g½_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

4678 
¬
->
Ën
 = 
ac
->
ac_b_ex
.
ã_Ën
;

4681 
ä“d
 = 
	`ext4_mb_disÿrd_´—ÎoÿtiÚs
(
sb
, 
ac
->
ac_o_ex
.
ã_Ën
);

4682 ià(
ä“d
)

4683 
»³©
;

4684 *
”½
 = -
ENOSPC
;

4687 
”rout
:

4688 ià(*
”½
) {

4689 
ac
->
ac_b_ex
.
ã_Ën
 = 0;

4690 
¬
->
Ën
 = 0;

4691 
	`ext4_mb_show_ac
(
ac
);

4693 
	`ext4_mb_»Ëa£_cÚ‹xt
(
ac
);

4694 
out
:

4695 ià(
ac
)

4696 
	`kmem_ÿche_ä“
(
ext4_ac_ÿch•
, 
ac
);

4697 ià(
šquÙa
 && 
¬
->
Ën
 < inquota)

4698 
	`dquÙ_ä“_block
(
¬
->
šode
, 
	`EXT4_C2B
(
sbi
, 
šquÙa
 -‡r->
Ën
));

4699 ià(!
¬
->
Ën
) {

4700 ià((
¬
->
æags
 & 
EXT4_MB_DELALLOC_RESERVED
) == 0)

4702 
	`³rıu_couÁ”_sub
(&
sbi
->
s_dœtyşu¡”s_couÁ”
,

4703 
»£rv_ş¡rs
);

4706 
	`Œaû_ext4_®loÿ‹_blocks
(
¬
, ()
block
);

4708  
block
;

4709 
	}
}

4716 
	$ext4_Œy_m”ge_ä“d_ex‹Á
(
ext4_sb_šfo
 *
sbi
,

4717 
ext4_ä“_d©a
 *
’Œy
,

4718 
ext4_ä“_d©a
 *
Ãw_’Œy
,

4719 
rb_roÙ
 *
’Œy_rb_roÙ
)

4721 ià((
’Œy
->
efd_tid
 !ğ
Ãw_’Œy
->efd_tid) ||

4722 (
’Œy
->
efd_group
 !ğ
Ãw_’Œy
->efd_group))

4724 ià(
’Œy
->
efd_¡¬t_şu¡”
 +ƒÁry->
efd_couÁ
 ==

4725 
Ãw_’Œy
->
efd_¡¬t_şu¡”
) {

4726 
Ãw_’Œy
->
efd_¡¬t_şu¡”
 = 
’Œy
->efd_start_cluster;

4727 
Ãw_’Œy
->
efd_couÁ
 +ğ
’Œy
->efd_count;

4728 } ià(
Ãw_’Œy
->
efd_¡¬t_şu¡”
 +‚ew_’Œy->
efd_couÁ
 ==

4729 
’Œy
->
efd_¡¬t_şu¡”
) {

4730 
Ãw_’Œy
->
efd_couÁ
 +ğ
’Œy
->efd_count;

4733 
	`¥š_lock
(&
sbi
->
s_md_lock
);

4734 
	`li¡_d–
(&
’Œy
->
efd_li¡
);

4735 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

4736 
	`rb_”a£
(&
’Œy
->
efd_node
, 
’Œy_rb_roÙ
);

4737 
	`kmem_ÿche_ä“
(
ext4_ä“_d©a_ÿch•
, 
’Œy
);

4738 
	}
}

4740 
nošlše_fÜ_¡ack
 

4741 
	$ext4_mb_ä“_m‘ad©a
(
hªdË_t
 *
hªdË
, 
ext4_buddy
 *
e4b
,

4742 
ext4_ä“_d©a
 *
Ãw_’Œy
)

4744 
ext4_group_t
 
group
 = 
e4b
->
bd_group
;

4745 
ext4_g½blk_t
 
şu¡”
;

4746 
ext4_g½blk_t
 
şu¡”s
 = 
Ãw_’Œy
->
efd_couÁ
;

4747 
ext4_ä“_d©a
 *
’Œy
;

4748 
ext4_group_šfo
 *
db
 = 
e4b
->
bd_šfo
;

4749 
su³r_block
 *
sb
 = 
e4b
->
bd_sb
;

4750 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4751 
rb_node
 **
n
 = &
db
->
bb_ä“_roÙ
.rb_node, *
node
;

4752 
rb_node
 *
·»Á
 = 
NULL
, *
Ãw_node
;

4754 
	`BUG_ON
(!
	`ext4_hªdË_v®id
(
hªdË
));

4755 
	`BUG_ON
(
e4b
->
bd_b™m­_·ge
 =ğ
NULL
);

4756 
	`BUG_ON
(
e4b
->
bd_buddy_·ge
 =ğ
NULL
);

4758 
Ãw_node
 = &
Ãw_’Œy
->
efd_node
;

4759 
şu¡”
 = 
Ãw_’Œy
->
efd_¡¬t_şu¡”
;

4761 ià(!*
n
) {

4767 
	`g‘_·ge
(
e4b
->
bd_buddy_·ge
);

4768 
	`g‘_·ge
(
e4b
->
bd_b™m­_·ge
);

4770 *
n
) {

4771 
·»Á
 = *
n
;

4772 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ext4_ä“_d©a
, 
efd_node
);

4773 ià(
şu¡”
 < 
’Œy
->
efd_¡¬t_şu¡”
)

4774 
n
 = &(*n)->
rb_Ëá
;

4775 ià(
şu¡”
 >ğ(
’Œy
->
efd_¡¬t_şu¡”
 +ƒÁry->
efd_couÁ
))

4776 
n
 = &(*n)->
rb_right
;

4778 
	`ext4_g½_locked_”rÜ
(
sb
, 
group
, 0,

4779 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
) +

4780 
	`EXT4_C2B
(
sbi
, 
şu¡”
),

4786 
	`rb_lšk_node
(
Ãw_node
, 
·»Á
, 
n
);

4787 
	`rb_š£¹_cŞÜ
(
Ãw_node
, &
db
->
bb_ä“_roÙ
);

4790 
node
 = 
	`rb_´ev
(
Ãw_node
);

4791 ià(
node
) {

4792 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_ä“_d©a
, 
efd_node
);

4793 
	`ext4_Œy_m”ge_ä“d_ex‹Á
(
sbi
, 
’Œy
, 
Ãw_’Œy
,

4794 &(
db
->
bb_ä“_roÙ
));

4797 
node
 = 
	`rb_Ãxt
(
Ãw_node
);

4798 ià(
node
) {

4799 
’Œy
 = 
	`rb_’Œy
(
node
, 
ext4_ä“_d©a
, 
efd_node
);

4800 
	`ext4_Œy_m”ge_ä“d_ex‹Á
(
sbi
, 
’Œy
, 
Ãw_’Œy
,

4801 &(
db
->
bb_ä“_roÙ
));

4804 
	`¥š_lock
(&
sbi
->
s_md_lock
);

4805 
	`li¡_add_
(&
Ãw_’Œy
->
efd_li¡
, &
sbi
->
s_ä“d_d©a_li¡
);

4806 
sbi
->
s_mb_ä“_³ndšg
 +ğ
şu¡”s
;

4807 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

4809 
	}
}

4811 
	$ext4_ä“_blocks_sim¶e
(
šode
 *šode, 
ext4_fsblk_t
 
block
,

4812 
couÁ
)

4814 
bufãr_h—d
 *
b™m­_bh
;

4815 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4816 
ext4_group_desc
 *
gdp
;

4817 
bufãr_h—d
 *
gdp_bh
;

4818 
ext4_group_t
 
group
;

4819 
ext4_g½blk_t
 
blkoff
;

4820 
®»ady_ä“d
 = 0, 
”r
, 
i
;

4821 
ext4_buddy
 
e4b
;

4823 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
block
, &
group
, &
blkoff
);

4824 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
group
);

4825 ià(
	`IS_ERR
(
b™m­_bh
)) {

4826 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

4827 
	`´_w¬n
("Failedo„ead block bitmap\n");

4830 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, &
gdp_bh
);

4831 ià(!
gdp
)

4835 
”r
 = 
	`ext4_mb_lßd_buddy_gå
(
sb
, 
group
, &
e4b
,

4836 
GFP_NOFS
|
__GFP_NOFAIL
);

4837 ià(
”r
)

4840 
i
 = 0; i < 
couÁ
; i++) {

4841 ià(!
	`mb_‹¡_b™
(
blkoff
 + 
i
, 
b™m­_bh
->
b_d©a
))

4842 
®»ady_ä“d
++;

4844 
	`ext4_lock_group
(
sb
, 
group
);

4845 
	`mb_ş—r_b™s
(
b™m­_bh
->
b_d©a
, 
blkoff
, 
couÁ
);

4846 
	`mb_ä“_blocks
(
šode
, &
e4b
, 
blkoff
, 
couÁ
);

4847 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
NULL
, NULL, 
b™m­_bh
);

4848 ià(
”r
)

4850 
	`ext4_ä“_group_şu¡”s_£t
(

4851 
sb
, 
gdp
, 
	`ext4_ä“_group_şu¡”s
(sb, gdp) +

4852 
couÁ
 - 
®»ady_ä“d
);

4853 
	`ext4_block_b™m­_csum_£t
(
sb
, 
group
, 
gdp
, 
b™m­_bh
);

4854 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

4855 
	`ext4_uÆock_group
(
sb
, 
group
);

4856 
	`ext4_hªdË_dœty_m‘ad©a
(
NULL
, NULL, 
gdp_bh
);

4857 
	`sync_dœty_bufãr
(
b™m­_bh
);

4858 
	`sync_dœty_bufãr
(
gdp_bh
);

4859 
	`b»l£
(
b™m­_bh
);

4860 
	}
}

4870 
	$ext4_ä“_blocks
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

4871 
bufãr_h—d
 *
bh
, 
ext4_fsblk_t
 
block
,

4872 
couÁ
, 
æags
)

4874 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

4875 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

4876 
ext4_group_desc
 *
gdp
;

4877 
ov”æow
;

4878 
ext4_g½blk_t
 
b™
;

4879 
bufãr_h—d
 *
gd_bh
;

4880 
ext4_group_t
 
block_group
;

4881 
ext4_sb_šfo
 *
sbi
;

4882 
ext4_buddy
 
e4b
;

4883 
couÁ_şu¡”s
;

4884 
”r
 = 0;

4885 
»t
;

4887 
sbi
 = 
	`EXT4_SB
(
sb
);

4889 ià(
sbi
->
s_mouÁ_¡©e
 & 
EXT4_FC_REPLAY
) {

4890 
	`ext4_ä“_blocks_sim¶e
(
šode
, 
block
, 
couÁ
);

4894 
	`might_¦“p
();

4895 ià(
bh
) {

4896 ià(
block
)

4897 
	`BUG_ON
(
block
 !ğ
bh
->
b_blockÄ
);

4899 
block
 = 
bh
->
b_blockÄ
;

4902 ià(!(
æags
 & 
EXT4_FREE_BLOCKS_VALIDATED
) &&

4903 !
	`ext4_d©a_block_v®id
(
sbi
, 
block
, 
couÁ
)) {

4904 
	`ext4_”rÜ
(
sb
, "Freeing blocks‚ot in datazone - "

4905 "block = %Îu, couÁ = %lu", 
block
, 
couÁ
);

4906 
”rÜ_»tuº
;

4909 
	`ext4_debug
("ä“šg block %Îu\n", 
block
);

4910 
	`Œaû_ext4_ä“_blocks
(
šode
, 
block
, 
couÁ
, 
æags
);

4912 ià(
bh
 && (
æags
 & 
EXT4_FREE_BLOCKS_FORGET
)) {

4913 
	`BUG_ON
(
couÁ
 > 1);

4915 
	`ext4_fÜg‘
(
hªdË
, 
æags
 & 
EXT4_FREE_BLOCKS_METADATA
,

4916 
šode
, 
bh
, 
block
);

4926 
ov”æow
 = 
	`EXT4_PBLK_COFF
(
sbi
, 
block
);

4927 ià(
ov”æow
) {

4928 ià(
æags
 & 
EXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
) {

4929 
ov”æow
 = 
sbi
->
s_şu¡”_¿tio
 - overflow;

4930 
block
 +ğ
ov”æow
;

4931 ià(
couÁ
 > 
ov”æow
)

4932 
couÁ
 -ğ
ov”æow
;

4936 
block
 -ğ
ov”æow
;

4937 
couÁ
 +ğ
ov”æow
;

4940 
ov”æow
 = 
	`EXT4_LBLK_COFF
(
sbi
, 
couÁ
);

4941 ià(
ov”æow
) {

4942 ià(
æags
 & 
EXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
) {

4943 ià(
couÁ
 > 
ov”æow
)

4944 
couÁ
 -ğ
ov”æow
;

4948 
couÁ
 +ğ
sbi
->
s_şu¡”_¿tio
 - 
ov”æow
;

4951 ià(!
bh
 && (
æags
 & 
EXT4_FREE_BLOCKS_FORGET
)) {

4952 
i
;

4953 
is_m‘ad©a
 = 
æags
 & 
EXT4_FREE_BLOCKS_METADATA
;

4955 
i
 = 0; i < 
couÁ
; i++) {

4956 
	`cÚd_»sched
();

4957 ià(
is_m‘ad©a
)

4958 
bh
 = 
	`sb_fšd_g‘_block
(
šode
->
i_sb
, 
block
 + 
i
);

4959 
	`ext4_fÜg‘
(
hªdË
, 
is_m‘ad©a
, 
šode
, 
bh
, 
block
 + 
i
);

4963 
do_mÜe
:

4964 
ov”æow
 = 0;

4965 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
block
, &
block_group
, &
b™
);

4967 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_BBITMAP_CORRUPT
(

4968 
	`ext4_g‘_group_šfo
(
sb
, 
block_group
))))

4975 ià(
	`EXT4_C2B
(
sbi
, 
b™
è+ 
couÁ
 > 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)) {

4976 
ov”æow
 = 
	`EXT4_C2B
(
sbi
, 
b™
è+ 
couÁ
 -

4977 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

4978 
couÁ
 -ğ
ov”æow
;

4980 
couÁ_şu¡”s
 = 
	`EXT4_NUM_B2C
(
sbi
, 
couÁ
);

4981 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
block_group
);

4982 ià(
	`IS_ERR
(
b™m­_bh
)) {

4983 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

4984 
b™m­_bh
 = 
NULL
;

4985 
”rÜ_»tuº
;

4987 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, &
gd_bh
);

4988 ià(!
gdp
) {

4989 
”r
 = -
EIO
;

4990 
”rÜ_»tuº
;

4993 ià(
	`š_¿nge
(
	`ext4_block_b™m­
(
sb
, 
gdp
), 
block
, 
couÁ
) ||

4994 
	`š_¿nge
(
	`ext4_šode_b™m­
(
sb
, 
gdp
), 
block
, 
couÁ
) ||

4995 
	`š_¿nge
(
block
, 
	`ext4_šode_bË
(
sb
, 
gdp
),

4996 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
) ||

4997 
	`š_¿nge
(
block
 + 
couÁ
 - 1, 
	`ext4_šode_bË
(
sb
, 
gdp
),

4998 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
)) {

5000 
	`ext4_”rÜ
(
sb
, "Freeing blocks in system zone - "

5001 "Block = %Îu, couÁ = %lu", 
block
, 
couÁ
);

5003 
”rÜ_»tuº
;

5006 
	`BUFFER_TRACE
(
b™m­_bh
, "getting write‡ccess");

5007 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
b™m­_bh
);

5008 ià(
”r
)

5009 
”rÜ_»tuº
;

5016 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

5017 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gd_bh
);

5018 ià(
”r
)

5019 
”rÜ_»tuº
;

5020 #ifdeà
AGGRESSIVE_CHECK


5022 
i
;

5023 
i
 = 0; i < 
couÁ_şu¡”s
; i++)

5024 
	`BUG_ON
(!
	`mb_‹¡_b™
(
b™
 + 
i
, 
b™m­_bh
->
b_d©a
));

5027 
	`Œaû_ext4_mb®loc_ä“
(
sb
, 
šode
, 
block_group
, 
b™
, 
couÁ_şu¡”s
);

5030 
”r
 = 
	`ext4_mb_lßd_buddy_gå
(
sb
, 
block_group
, &
e4b
,

5031 
GFP_NOFS
|
__GFP_NOFAIL
);

5032 ià(
”r
)

5033 
”rÜ_»tuº
;

5041 ià(
	`ext4_hªdË_v®id
(
hªdË
) &&

5042 ((
æags
 & 
EXT4_FREE_BLOCKS_METADATA
) ||

5043 !
	`ext4_should_wr™eback_d©a
(
šode
))) {

5044 
ext4_ä“_d©a
 *
Ãw_’Œy
;

5049 
Ãw_’Œy
 = 
	`kmem_ÿche_®loc
(
ext4_ä“_d©a_ÿch•
,

5050 
GFP_NOFS
|
__GFP_NOFAIL
);

5051 
Ãw_’Œy
->
efd_¡¬t_şu¡”
 = 
b™
;

5052 
Ãw_’Œy
->
efd_group
 = 
block_group
;

5053 
Ãw_’Œy
->
efd_couÁ
 = 
couÁ_şu¡”s
;

5054 
Ãw_’Œy
->
efd_tid
 = 
hªdË
->
h_Œª§ùiÚ
->
t_tid
;

5056 
	`ext4_lock_group
(
sb
, 
block_group
);

5057 
	`mb_ş—r_b™s
(
b™m­_bh
->
b_d©a
, 
b™
, 
couÁ_şu¡”s
);

5058 
	`ext4_mb_ä“_m‘ad©a
(
hªdË
, &
e4b
, 
Ãw_’Œy
);

5064 ià(
	`‹¡_İt
(
sb
, 
DISCARD
)) {

5065 
”r
 = 
	`ext4_issue_disÿrd
(
sb
, 
block_group
, 
b™
, 
couÁ
,

5066 
NULL
);

5067 ià(
”r
 &&ƒ¼ !ğ-
EOPNOTSUPP
)

5068 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "discard„equest in"

5070 " w™h %d", 
block_group
, 
b™
, 
couÁ
,

5071 
”r
);

5073 
	`EXT4_MB_GRP_CLEAR_TRIMMED
(
e4b
.
bd_šfo
);

5075 
	`ext4_lock_group
(
sb
, 
block_group
);

5076 
	`mb_ş—r_b™s
(
b™m­_bh
->
b_d©a
, 
b™
, 
couÁ_şu¡”s
);

5077 
	`mb_ä“_blocks
(
šode
, &
e4b
, 
b™
, 
couÁ_şu¡”s
);

5080 
»t
 = 
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
è+ 
couÁ_şu¡”s
;

5081 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
, 
»t
);

5082 
	`ext4_block_b™m­_csum_£t
(
sb
, 
block_group
, 
gdp
, 
b™m­_bh
);

5083 
	`ext4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

5084 
	`ext4_uÆock_group
(
sb
, 
block_group
);

5086 ià(
sbi
->
s_log_groups_³r_æex
) {

5087 
ext4_group_t
 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
block_group
);

5088 
	`©omic64_add
(
couÁ_şu¡”s
,

5089 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

5092 ià(!(
æags
 & 
EXT4_FREE_BLOCKS_NO_QUOT_UPDATE
))

5093 
	`dquÙ_ä“_block
(
šode
, 
	`EXT4_C2B
(
sbi
, 
couÁ_şu¡”s
));

5094 
	`³rıu_couÁ”_add
(&
sbi
->
s_ä“şu¡”s_couÁ”
, 
couÁ_şu¡”s
);

5096 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

5099 
	`BUFFER_TRACE
(
b™m­_bh
, "dirtied bitmap block");

5100 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

5103 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

5104 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gd_bh
);

5105 ià(!
”r
)

5106 
”r
 = 
»t
;

5108 ià(
ov”æow
 && !
”r
) {

5109 
block
 +ğ
couÁ
;

5110 
couÁ
 = 
ov”æow
;

5111 
	`put_bh
(
b™m­_bh
);

5112 
do_mÜe
;

5114 
”rÜ_»tuº
:

5115 
	`b»l£
(
b™m­_bh
);

5116 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

5118 
	}
}

5129 
	$ext4_group_add_blocks
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

5130 
ext4_fsblk_t
 
block
, 
couÁ
)

5132 
bufãr_h—d
 *
b™m­_bh
 = 
NULL
;

5133 
bufãr_h—d
 *
gd_bh
;

5134 
ext4_group_t
 
block_group
;

5135 
ext4_g½blk_t
 
b™
;

5136 
i
;

5137 
ext4_group_desc
 *
desc
;

5138 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

5139 
ext4_buddy
 
e4b
;

5140 
”r
 = 0, 
»t
, 
blk_ä“_couÁ
;

5141 
ext4_g½blk_t
 
blocks_ä“d
;

5143 
	`ext4_debug
("Addšg block(sè%Îu-%Îu\n", 
block
, block + 
couÁ
 - 1);

5145 ià(
couÁ
 == 0)

5148 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
block
, &
block_group
, &
b™
);

5153 ià(
b™
 + 
couÁ
 > 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)) {

5154 
	`ext4_w¬nšg
(
sb
, "too much blocks‡ddedo group %u",

5155 
block_group
);

5156 
”r
 = -
EINVAL
;

5157 
”rÜ_»tuº
;

5160 
b™m­_bh
 = 
	`ext4_»ad_block_b™m­
(
sb
, 
block_group
);

5161 ià(
	`IS_ERR
(
b™m­_bh
)) {

5162 
”r
 = 
	`PTR_ERR
(
b™m­_bh
);

5163 
b™m­_bh
 = 
NULL
;

5164 
”rÜ_»tuº
;

5167 
desc
 = 
	`ext4_g‘_group_desc
(
sb
, 
block_group
, &
gd_bh
);

5168 ià(!
desc
) {

5169 
”r
 = -
EIO
;

5170 
”rÜ_»tuº
;

5173 ià(
	`š_¿nge
(
	`ext4_block_b™m­
(
sb
, 
desc
), 
block
, 
couÁ
) ||

5174 
	`š_¿nge
(
	`ext4_šode_b™m­
(
sb
, 
desc
), 
block
, 
couÁ
) ||

5175 
	`š_¿nge
(
block
, 
	`ext4_šode_bË
(
sb
, 
desc
), 
sbi
->
s_™b_³r_group
) ||

5176 
	`š_¿nge
(
block
 + 
couÁ
 - 1, 
	`ext4_šode_bË
(
sb
, 
desc
),

5177 
sbi
->
s_™b_³r_group
)) {

5178 
	`ext4_”rÜ
(
sb
, "Adding blocks in system zones - "

5180 
block
, 
couÁ
);

5181 
”r
 = -
EINVAL
;

5182 
”rÜ_»tuº
;

5185 
	`BUFFER_TRACE
(
b™m­_bh
, "getting write‡ccess");

5186 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
b™m­_bh
);

5187 ià(
”r
)

5188 
”rÜ_»tuº
;

5195 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

5196 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gd_bh
);

5197 ià(
”r
)

5198 
”rÜ_»tuº
;

5200 
i
 = 0, 
blocks_ä“d
 = 0; i < 
couÁ
; i++) {

5201 
	`BUFFER_TRACE
(
b™m­_bh
, "clear bit");

5202 ià(!
	`mb_‹¡_b™
(
b™
 + 
i
, 
b™m­_bh
->
b_d©a
)) {

5203 
	`ext4_”rÜ
(
sb
, "bit‡lready cleared for block %llu",

5204 (
ext4_fsblk_t
)(
block
 + 
i
));

5205 
	`BUFFER_TRACE
(
b™m­_bh
, "bit‡lready cleared");

5207 
blocks_ä“d
++;

5211 
”r
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
block_group
, &
e4b
);

5212 ià(
”r
)

5213 
”rÜ_»tuº
;

5220 
	`ext4_lock_group
(
sb
, 
block_group
);

5221 
	`mb_ş—r_b™s
(
b™m­_bh
->
b_d©a
, 
b™
, 
couÁ
);

5222 
	`mb_ä“_blocks
(
NULL
, &
e4b
, 
b™
, 
couÁ
);

5223 
blk_ä“_couÁ
 = 
blocks_ä“d
 + 
	`ext4_ä“_group_şu¡”s
(
sb
, 
desc
);

5224 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
desc
, 
blk_ä“_couÁ
);

5225 
	`ext4_block_b™m­_csum_£t
(
sb
, 
block_group
, 
desc
, 
b™m­_bh
);

5226 
	`ext4_group_desc_csum_£t
(
sb
, 
block_group
, 
desc
);

5227 
	`ext4_uÆock_group
(
sb
, 
block_group
);

5228 
	`³rıu_couÁ”_add
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

5229 
	`EXT4_NUM_B2C
(
sbi
, 
blocks_ä“d
));

5231 ià(
sbi
->
s_log_groups_³r_æex
) {

5232 
ext4_group_t
 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
block_group
);

5233 
	`©omic64_add
(
	`EXT4_NUM_B2C
(
sbi
, 
blocks_ä“d
),

5234 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

5237 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

5240 
	`BUFFER_TRACE
(
b™m­_bh
, "dirtied bitmap block");

5241 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
b™m­_bh
);

5244 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

5245 
»t
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gd_bh
);

5246 ià(!
”r
)

5247 
”r
 = 
»t
;

5249 
”rÜ_»tuº
:

5250 
	`b»l£
(
b™m­_bh
);

5251 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

5252  
”r
;

5253 
	}
}

5267 
	$ext4_Œim_ex‹Á
(
su³r_block
 *
sb
, 
¡¬t
, 
couÁ
,

5268 
ext4_group_t
 
group
, 
ext4_buddy
 *
e4b
)

5269 
	$__»Ëa£s
(
b™lock
)

5270 
	$__acquœes
(
b™lock
)

5272 
ext4_ä“_ex‹Á
 
ex
;

5273 
»t
 = 0;

5275 
	`Œaû_ext4_Œim_ex‹Á
(
sb
, 
group
, 
¡¬t
, 
couÁ
);

5277 
	`as£¹_¥š_locked
(
	`ext4_group_lock_±r
(
sb
, 
group
));

5279 
ex
.
ã_¡¬t
 = 
¡¬t
;

5280 
ex
.
ã_group
 = 
group
;

5281 
ex
.
ã_Ën
 = 
couÁ
;

5287 
	`mb_m¬k_u£d
(
e4b
, &
ex
);

5288 
	`ext4_uÆock_group
(
sb
, 
group
);

5289 
»t
 = 
	`ext4_issue_disÿrd
(
sb
, 
group
, 
¡¬t
, 
couÁ
, 
NULL
);

5290 
	`ext4_lock_group
(
sb
, 
group
);

5291 
	`mb_ä“_blocks
(
NULL
, 
e4b
, 
¡¬t
, 
ex
.
ã_Ën
);

5292  
»t
;

5293 
	}
}

5313 
ext4_g½blk_t


5314 
	$ext4_Œim_®l_ä“
(
su³r_block
 *
sb
, 
ext4_group_t
 
group
,

5315 
ext4_g½blk_t
 
¡¬t
,ƒxt4_g½blk_ˆ
max
,

5316 
ext4_g½blk_t
 
mšblocks
)

5318 *
b™m­
;

5319 
ext4_g½blk_t
 
Ãxt
, 
couÁ
 = 0, 
ä“_couÁ
 = 0;

5320 
ext4_buddy
 
e4b
;

5321 
»t
 = 0;

5323 
	`Œaû_ext4_Œim_®l_ä“
(
sb
, 
group
, 
¡¬t
, 
max
);

5325 
»t
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

5326 ià(
»t
) {

5327 
	`ext4_w¬nšg
(
sb
, "Error %d†oading buddy information for %u",

5328 
»t
, 
group
);

5329  
»t
;

5331 
b™m­
 = 
e4b
.
bd_b™m­
;

5333 
	`ext4_lock_group
(
sb
, 
group
);

5334 ià(
	`EXT4_MB_GRP_WAS_TRIMMED
(
e4b
.
bd_šfo
) &&

5335 
mšblocks
 >ğ
	`©omic_»ad
(&
	`EXT4_SB
(
sb
)->
s_Ï¡_Œim_mšblks
))

5336 
out
;

5338 
¡¬t
 = (
e4b
.
bd_šfo
->
bb_fœ¡_ä“
 > start) ?

5339 
e4b
.
bd_šfo
->
bb_fœ¡_ä“
 : 
¡¬t
;

5341 
¡¬t
 <ğ
max
) {

5342 
¡¬t
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
, 
max
 + 1, start);

5343 ià(
¡¬t
 > 
max
)

5345 
Ãxt
 = 
	`mb_fšd_Ãxt_b™
(
b™m­
, 
max
 + 1, 
¡¬t
);

5347 ià((
Ãxt
 - 
¡¬t
è>ğ
mšblocks
) {

5348 
»t
 = 
	`ext4_Œim_ex‹Á
(
sb
, 
¡¬t
,

5349 
Ãxt
 - 
¡¬t
, 
group
, &
e4b
);

5350 ià(
»t
 &&„‘ !ğ-
EOPNOTSUPP
)

5352 
»t
 = 0;

5353 
couÁ
 +ğ
Ãxt
 - 
¡¬t
;

5355 
ä“_couÁ
 +ğ
Ãxt
 - 
¡¬t
;

5356 
¡¬t
 = 
Ãxt
 + 1;

5358 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

5359 
couÁ
 = -
ERESTARTSYS
;

5363 ià(
	`Ãed_»sched
()) {

5364 
	`ext4_uÆock_group
(
sb
, 
group
);

5365 
	`cÚd_»sched
();

5366 
	`ext4_lock_group
(
sb
, 
group
);

5369 ià((
e4b
.
bd_šfo
->
bb_ä“
 - 
ä“_couÁ
è< 
mšblocks
)

5373 ià(!
»t
) {

5374 
»t
 = 
couÁ
;

5375 
	`EXT4_MB_GRP_SET_TRIMMED
(
e4b
.
bd_šfo
);

5377 
out
:

5378 
	`ext4_uÆock_group
(
sb
, 
group
);

5379 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

5381 
	`ext4_debug
("trimmed %d blocks inhe group %d\n",

5382 
couÁ
, 
group
);

5384  
»t
;

5385 
	}
}

5399 
	$ext4_Œim_fs
(
su³r_block
 *
sb
, 
f¡rim_¿nge
 *
¿nge
)

5401 
ext4_group_šfo
 *
g½
;

5402 
ext4_group_t
 
group
, 
fœ¡_group
, 
Ï¡_group
;

5403 
ext4_g½blk_t
 
út
 = 0, 
fœ¡_şu¡”
, 
Ï¡_şu¡”
;

5404 
ušt64_t
 
¡¬t
, 
’d
, 
mšËn
, 
Œimmed
 = 0;

5405 
ext4_fsblk_t
 
fœ¡_d©a_blk
 =

5406 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_d©a_block
);

5407 
ext4_fsblk_t
 
max_blks
 = 
	`ext4_blocks_couÁ
(
	`EXT4_SB
(
sb
)->
s_es
);

5408 
»t
 = 0;

5410 
¡¬t
 = 
¿nge
->¡¬ˆ>> 
sb
->
s_blocksize_b™s
;

5411 
’d
 = 
¡¬t
 + (
¿nge
->
Ën
 >> 
sb
->
s_blocksize_b™s
) - 1;

5412 
mšËn
 = 
	`EXT4_NUM_B2C
(
	`EXT4_SB
(
sb
),

5413 
¿nge
->
mšËn
 >> 
sb
->
s_blocksize_b™s
);

5415 ià(
mšËn
 > 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) ||

5416 
¡¬t
 >ğ
max_blks
 ||

5417 
¿nge
->
Ën
 < 
sb
->
s_blocksize
)

5418  -
EINVAL
;

5419 ià(
’d
 >ğ
max_blks
)

5420 
’d
 = 
max_blks
 - 1;

5421 ià(
’d
 <ğ
fœ¡_d©a_blk
)

5422 
out
;

5423 ià(
¡¬t
 < 
fœ¡_d©a_blk
)

5424 
¡¬t
 = 
fœ¡_d©a_blk
;

5427 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, (
ext4_fsblk_t
è
¡¬t
,

5428 &
fœ¡_group
, &
fœ¡_şu¡”
);

5429 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, (
ext4_fsblk_t
è
’d
,

5430 &
Ï¡_group
, &
Ï¡_şu¡”
);

5433 
’d
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5435 
group
 = 
fœ¡_group
; grou°<ğ
Ï¡_group
; group++) {

5436 
g½
 = 
	`ext4_g‘_group_šfo
(
sb
, 
group
);

5438 ià(
	`uÆik–y
(
	`EXT4_MB_GRP_NEED_INIT
(
g½
))) {

5439 
»t
 = 
	`ext4_mb_š™_group
(
sb
, 
group
, 
GFP_NOFS
);

5440 ià(
»t
)

5450 ià(
group
 =ğ
Ï¡_group
)

5451 
’d
 = 
Ï¡_şu¡”
;

5453 ià(
g½
->
bb_ä“
 >ğ
mšËn
) {

5454 
út
 = 
	`ext4_Œim_®l_ä“
(
sb
, 
group
, 
fœ¡_şu¡”
,

5455 
’d
, 
mšËn
);

5456 ià(
út
 < 0) {

5457 
»t
 = 
út
;

5460 
Œimmed
 +ğ
út
;

5467 
fœ¡_şu¡”
 = 0;

5470 ià(!
»t
)

5471 
	`©omic_£t
(&
	`EXT4_SB
(
sb
)->
s_Ï¡_Œim_mšblks
, 
mšËn
);

5473 
out
:

5474 
¿nge
->
Ën
 = 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 
Œimmed
è<< sb->
s_blocksize_b™s
;

5475  
»t
;

5476 
	}
}

5480 
	$ext4_mb®loc_qu”y_¿nge
(

5481 
su³r_block
 *
sb
,

5482 
ext4_group_t
 
group
,

5483 
ext4_g½blk_t
 
¡¬t
,

5484 
ext4_g½blk_t
 
’d
,

5485 
ext4_mb®loc_qu”y_¿nge_â
 
fÜm©‹r
,

5486 *
´iv
)

5488 *
b™m­
;

5489 
ext4_g½blk_t
 
Ãxt
;

5490 
ext4_buddy
 
e4b
;

5491 
”rÜ
;

5493 
”rÜ
 = 
	`ext4_mb_lßd_buddy
(
sb
, 
group
, &
e4b
);

5494 ià(
”rÜ
)

5495  
”rÜ
;

5496 
b™m­
 = 
e4b
.
bd_b™m­
;

5498 
	`ext4_lock_group
(
sb
, 
group
);

5500 
¡¬t
 = (
e4b
.
bd_šfo
->
bb_fœ¡_ä“
 > start) ?

5501 
e4b
.
bd_šfo
->
bb_fœ¡_ä“
 : 
¡¬t
;

5502 ià(
’d
 >ğ
	`EXT4_CLUSTERS_PER_GROUP
(
sb
))

5503 
’d
 = 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5505 
¡¬t
 <ğ
’d
) {

5506 
¡¬t
 = 
	`mb_fšd_Ãxt_z”o_b™
(
b™m­
, 
’d
 + 1, start);

5507 ià(
¡¬t
 > 
’d
)

5509 
Ãxt
 = 
	`mb_fšd_Ãxt_b™
(
b™m­
, 
’d
 + 1, 
¡¬t
);

5511 
	`ext4_uÆock_group
(
sb
, 
group
);

5512 
”rÜ
 = 
	`fÜm©‹r
(
sb
, 
group
, 
¡¬t
, 
Ãxt
 - s¹, 
´iv
);

5513 ià(
”rÜ
)

5514 
out_uÆßd
;

5515 
	`ext4_lock_group
(
sb
, 
group
);

5517 
¡¬t
 = 
Ãxt
 + 1;

5520 
	`ext4_uÆock_group
(
sb
, 
group
);

5521 
out_uÆßd
:

5522 
	`ext4_mb_uÆßd_buddy
(&
e4b
);

5524  
”rÜ
;

5525 
	}
}

	@mballoc.h

7 #iâdeà
_EXT4_MBALLOC_H


8 
	#_EXT4_MBALLOC_H


	)

10 
	~<lšux/time.h
>

11 
	~<lšux/fs.h
>

12 
	~<lšux/Çmei.h
>

13 
	~<lšux/quÙaİs.h
>

14 
	~<lšux/bufãr_h—d.h
>

15 
	~<lšux/moduË.h
>

16 
	~<lšux/sw­.h
>

17 
	~<lšux/´oc_fs.h
>

18 
	~<lšux/·gem­.h
>

19 
	~<lšux/£q_fe.h
>

20 
	~<lšux/blkdev.h
>

21 
	~<lšux/mu‹x.h
>

22 
	~"ext4_jbd2.h
"

23 
	~"ext4.h
"

27 #ifdeà
CONFIG_EXT4_DEBUG


28 
ushÜt
 
ext4_mb®loc_debug
;

30 
	#mb_debug
(
n
, 
fmt
, ...) \

32 ià((
n
è<ğ
ext4_mb®loc_debug
) { \

33 
	`´štk
(
KERN_DEBUG
 "(%s, %d): %s: " 
fmt
, \

34 
__FILE__
, 
__LINE__
, 
__func__
, ##
__VA_ARGS__
); \

36 } 0)

	)

38 
	#mb_debug
(
n
, 
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

41 
	#EXT4_MB_HISTORY_ALLOC
 1

	)

42 
	#EXT4_MB_HISTORY_PREALLOC
 2

	)

47 
	#MB_DEFAULT_MAX_TO_SCAN
 200

	)

52 
	#MB_DEFAULT_MIN_TO_SCAN
 10

	)

58 
	#MB_DEFAULT_STATS
 0

	)

67 
	#MB_DEFAULT_STREAM_THRESHOLD
 16

	)

72 
	#MB_DEFAULT_ORDER2_REQS
 2

	)

77 
	#MB_DEFAULT_GROUP_PREALLOC
 512

	)

80 
	sext4_ä“_d©a
 {

82 
li¡_h—d
 
	mefd_li¡
;

85 
rb_node
 
	mefd_node
;

88 
ext4_group_t
 
	mefd_group
;

91 
ext4_g½blk_t
 
	mefd_¡¬t_şu¡”
;

92 
ext4_g½blk_t
 
	mefd_couÁ
;

95 
tid_t
 
	mefd_tid
;

98 
	sext4_´—Îoc_¥aû
 {

99 
li¡_h—d
 
	m·_šode_li¡
;

100 
li¡_h—d
 
	m·_group_li¡
;

102 
li¡_h—d
 
	m·_tmp_li¡
;

103 
rcu_h—d
 
	m·_rcu
;

104 } 
	mu
;

105 
¥šlock_t
 
	m·_lock
;

106 
©omic_t
 
	m·_couÁ
;

107 
	m·_d–‘ed
;

108 
ext4_fsblk_t
 
	m·_p¡¬t
;

109 
ext4_lblk_t
 
	m·_l¡¬t
;

110 
ext4_g½blk_t
 
	m·_Ën
;

111 
ext4_g½blk_t
 
	m·_ä“
;

112 
	m·_ty³
;

113 
¥šlock_t
 *
	m·_obj_lock
;

114 
šode
 *
	m·_šode
;

118 
	mMB_INODE_PA
 = 0,

119 
	mMB_GROUP_PA
 = 1

122 
	sext4_ä“_ex‹Á
 {

123 
ext4_lblk_t
 
	mã_logiÿl
;

124 
ext4_g½blk_t
 
	mã_¡¬t
;

125 
ext4_group_t
 
	mã_group
;

126 
ext4_g½blk_t
 
	mã_Ën
;

137 
	#PREALLOC_TB_SIZE
 10

	)

138 
	sext4_loÿl™y_group
 {

141 
mu‹x
 
	mlg_mu‹x
;

143 
li¡_h—d
 
	mlg_´—Îoc_li¡
[
PREALLOC_TB_SIZE
];

144 
¥šlock_t
 
	mlg_´—Îoc_lock
;

147 
	sext4_®loÿtiÚ_cÚ‹xt
 {

148 
šode
 *
	mac_šode
;

149 
su³r_block
 *
	mac_sb
;

152 
ext4_ä“_ex‹Á
 
	mac_o_ex
;

155 
ext4_ä“_ex‹Á
 
	mac_g_ex
;

158 
ext4_ä“_ex‹Á
 
	mac_b_ex
;

161 
ext4_ä“_ex‹Á
 
	mac_f_ex
;

163 
__u16
 
	mac_groups_sÿÂed
;

164 
__u16
 
	mac_found
;

165 
__u16
 
	mac_
;

166 
__u16
 
	mac_buddy
;

167 
__u16
 
	mac_æags
;

168 
__u8
 
	mac_¡©us
;

169 
__u8
 
	mac_ü™”Ÿ
;

170 
__u8
 
	mac_2Üd”
;

172 
__u8
 
	mac_İ
;

173 
·ge
 *
	mac_b™m­_·ge
;

174 
·ge
 *
	mac_buddy_·ge
;

175 
ext4_´—Îoc_¥aû
 *
	mac_·
;

176 
ext4_loÿl™y_group
 *
	mac_lg
;

179 
	#AC_STATUS_CONTINUE
 1

	)

180 
	#AC_STATUS_FOUND
 2

	)

181 
	#AC_STATUS_BREAK
 3

	)

183 
	sext4_buddy
 {

184 
·ge
 *
	mbd_buddy_·ge
;

185 *
	mbd_buddy
;

186 
·ge
 *
	mbd_b™m­_·ge
;

187 *
	mbd_b™m­
;

188 
ext4_group_šfo
 *
	mbd_šfo
;

189 
su³r_block
 *
	mbd_sb
;

190 
__u16
 
	mbd_blkb™s
;

191 
ext4_group_t
 
	mbd_group
;

194 
šlše
 
ext4_fsblk_t
 
	$ext4_g½_offs_to_block
(
su³r_block
 *
sb
,

195 
ext4_ä“_ex‹Á
 *
ãx
)

197  
	`ext4_group_fœ¡_block_no
(
sb
, 
ãx
->
ã_group
) +

198 (
ãx
->
ã_¡¬t
 << 
	`EXT4_SB
(
sb
)->
s_şu¡”_b™s
);

199 
	}
}

201 (*
	text4_mb®loc_qu”y_¿nge_â
)(

202 
	tsu³r_block
 *
	tsb
,

203 
	text4_group_t
 
	tagno
,

204 
	text4_g½blk_t
 
	t¡¬t
,

205 
	text4_g½blk_t
 
	tËn
,

206 *
	t´iv
);

209 
	`ext4_mb®loc_qu”y_¿nge
(

210 
su³r_block
 *
sb
,

211 
ext4_group_t
 
agno
,

212 
ext4_g½blk_t
 
¡¬t
,

213 
ext4_g½blk_t
 
’d
,

214 
ext4_mb®loc_qu”y_¿nge_â
 
fÜm©‹r
,

215 *
´iv
);

217 
	`ext4_mb_m¬k_u£d
(
su³r_block
 *
sb
, 
ext4_fsblk_t
 
block
,

218 
Ën
);

	@migrate.c

15 
	~<lšux/¦ab.h
>

16 
	~"ext4_jbd2.h
"

17 
	~"ext4_ex‹Ás.h
"

23 
	smig¿‹_¡ruù
 {

24 
ext4_lblk_t
 
	mfœ¡_block
, 
	mÏ¡_block
, 
	mcu¼_block
;

25 
ext4_fsblk_t
 
	mfœ¡_pblock
, 
	mÏ¡_pblock
;

28 
	$fšish_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

29 
mig¿‹_¡ruù
 *
lb
)

32 
»tv®
 = 0, 
Ãeded
;

33 
ext4_ex‹Á
 
Ãwext
;

34 
ext4_ext_·th
 *
·th
;

35 ià(
lb
->
fœ¡_pblock
 == 0)

39 
Ãwext
.
“_block
 = 
	`ıu_to_Ë32
(
lb
->
fœ¡_block
);

40 
Ãwext
.
“_Ën
 = 
	`ıu_to_Ë16
(
lb
->
Ï¡_block
 -†b->
fœ¡_block
 + 1);

41 
	`ext4_ext_¡Üe_pblock
(&
Ãwext
, 
lb
->
fœ¡_pblock
);

43 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

44 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
lb
->
fœ¡_block
, 
NULL
, 0);

45 ià(
	`IS_ERR
(
·th
)) {

46 
»tv®
 = 
	`PTR_ERR
(
·th
);

47 
·th
 = 
NULL
;

48 
”r_out
;

57 
Ãeded
 = 
	`ext4_ext_ÿlc_üed™s_fÜ_sšgË_ex‹Á
(
šode
,

58 
lb
->
Ï¡_block
 -†b->
fœ¡_block
 + 1, 
·th
);

63 ià(
Ãeded
 && 
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
,

64 
EXT4_RESERVE_TRANS_BLOCKS
)) {

65 
	`up_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

66 
»tv®
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
Ãeded
);

67 
	`down_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

68 ià(
»tv®
)

69 
”r_out
;

70 } ià(
Ãeded
) {

71 
»tv®
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
Ãeded
);

72 ià(
»tv®
) {

76 
	`up_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

77 
»tv®
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
Ãeded
);

78 
	`down_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

79 ià(
»tv®
)

80 
”r_out
;

83 
»tv®
 = 
	`ext4_ext_š£¹_ex‹Á
(
hªdË
, 
šode
, &
·th
, &
Ãwext
, 0);

84 
”r_out
:

85 
	`up_wr™e
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

86 
	`ext4_ext_drİ_»fs
(
·th
);

87 
	`kä“
(
·th
);

88 
lb
->
fœ¡_pblock
 = 0;

89  
»tv®
;

90 
	}
}

92 
	$upd©e_ex‹Á_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

93 
ext4_fsblk_t
 
pblock
, 
mig¿‹_¡ruù
 *
lb
)

95 
»tv®
;

99 ià(
lb
->
fœ¡_pblock
 &&

100 (
lb
->
Ï¡_pblock
+1 =ğ
pblock
) &&

101 (
lb
->
Ï¡_block
+1 =ğlb->
cu¼_block
)) {

102 
lb
->
Ï¡_pblock
 = 
pblock
;

103 
lb
->
Ï¡_block
 =†b->
cu¼_block
;

104 
lb
->
cu¼_block
++;

110 
»tv®
 = 
	`fšish_¿nge
(
hªdË
, 
šode
, 
lb
);

111 
lb
->
fœ¡_pblock
 =†b->
Ï¡_pblock
 = 
pblock
;

112 
lb
->
fœ¡_block
 =†b->
Ï¡_block
 =†b->
cu¼_block
;

113 
lb
->
cu¼_block
++;

114  
»tv®
;

115 
	}
}

117 
	$upd©e_šd_ex‹Á_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

118 
ext4_fsblk_t
 
pblock
,

119 
mig¿‹_¡ruù
 *
lb
)

121 
bufãr_h—d
 *
bh
;

122 
__Ë32
 *
i_d©a
;

123 
i
, 
»tv®
 = 0;

124 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

126 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
pblock
);

127 ià(!
bh
)

128  -
EIO
;

130 
i_d©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

131 
i
 = 0; i < 
max_’Œ›s
; i++) {

132 ià(
i_d©a
[
i
]) {

133 
»tv®
 = 
	`upd©e_ex‹Á_¿nge
(
hªdË
, 
šode
,

134 
	`Ë32_to_ıu
(
i_d©a
[
i
]), 
lb
);

135 ià(
»tv®
)

138 
lb
->
cu¼_block
++;

141 
	`put_bh
(
bh
);

142  
»tv®
;

144 
	}
}

146 
	$upd©e_dšd_ex‹Á_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

147 
ext4_fsblk_t
 
pblock
,

148 
mig¿‹_¡ruù
 *
lb
)

150 
bufãr_h—d
 *
bh
;

151 
__Ë32
 *
i_d©a
;

152 
i
, 
»tv®
 = 0;

153 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

155 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
pblock
);

156 ià(!
bh
)

157  -
EIO
;

159 
i_d©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

160 
i
 = 0; i < 
max_’Œ›s
; i++) {

161 ià(
i_d©a
[
i
]) {

162 
»tv®
 = 
	`upd©e_šd_ex‹Á_¿nge
(
hªdË
, 
šode
,

163 
	`Ë32_to_ıu
(
i_d©a
[
i
]), 
lb
);

164 ià(
»tv®
)

168 
lb
->
cu¼_block
 +ğ
max_’Œ›s
;

171 
	`put_bh
(
bh
);

172  
»tv®
;

174 
	}
}

176 
	$upd©e_tšd_ex‹Á_¿nge
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

177 
ext4_fsblk_t
 
pblock
,

178 
mig¿‹_¡ruù
 *
lb
)

180 
bufãr_h—d
 *
bh
;

181 
__Ë32
 *
i_d©a
;

182 
i
, 
»tv®
 = 0;

183 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

185 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
pblock
);

186 ià(!
bh
)

187  -
EIO
;

189 
i_d©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

190 
i
 = 0; i < 
max_’Œ›s
; i++) {

191 ià(
i_d©a
[
i
]) {

192 
»tv®
 = 
	`upd©e_dšd_ex‹Á_¿nge
(
hªdË
, 
šode
,

193 
	`Ë32_to_ıu
(
i_d©a
[
i
]), 
lb
);

194 ià(
»tv®
)

198 
lb
->
cu¼_block
 +ğ
max_’Œ›s
 * max_entries;

201 
	`put_bh
(
bh
);

202  
»tv®
;

204 
	}
}

206 
	$ex‹nd_üed™_fÜ_blkd–
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

208 
»tv®
 = 0, 
Ãeded
;

210 ià(
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
, 
EXT4_RESERVE_TRANS_BLOCKS
+1))

218 
Ãeded
 = 3 + 
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
šode
->
i_sb
);

220 ià(
	`ext4_jouº®_ex‹nd
(
hªdË
, 
Ãeded
) != 0)

221 
»tv®
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
Ãeded
);

223  
»tv®
;

224 
	}
}

226 
	$ä“_dšd_blocks
(
hªdË_t
 *
hªdË
,

227 
šode
 *šode, 
__Ë32
 
i_d©a
)

229 
i
;

230 
__Ë32
 *
tmp_id©a
;

231 
bufãr_h—d
 *
bh
;

232 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

234 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
	`Ë32_to_ıu
(
i_d©a
));

235 ià(!
bh
)

236  -
EIO
;

238 
tmp_id©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

239 
i
 = 0; i < 
max_’Œ›s
; i++) {

240 ià(
tmp_id©a
[
i
]) {

241 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

242 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

243 
	`Ë32_to_ıu
(
tmp_id©a
[
i
]), 1,

244 
EXT4_FREE_BLOCKS_METADATA
 |

245 
EXT4_FREE_BLOCKS_FORGET
);

248 
	`put_bh
(
bh
);

249 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

250 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
	`Ë32_to_ıu
(
i_d©a
), 1,

251 
EXT4_FREE_BLOCKS_METADATA
 |

252 
EXT4_FREE_BLOCKS_FORGET
);

254 
	}
}

256 
	$ä“_tšd_blocks
(
hªdË_t
 *
hªdË
,

257 
šode
 *šode, 
__Ë32
 
i_d©a
)

259 
i
, 
»tv®
 = 0;

260 
__Ë32
 *
tmp_id©a
;

261 
bufãr_h—d
 *
bh
;

262 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

264 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
	`Ë32_to_ıu
(
i_d©a
));

265 ià(!
bh
)

266  -
EIO
;

268 
tmp_id©a
 = (
__Ë32
 *)
bh
->
b_d©a
;

269 
i
 = 0; i < 
max_’Œ›s
; i++) {

270 ià(
tmp_id©a
[
i
]) {

271 
»tv®
 = 
	`ä“_dšd_blocks
(
hªdË
,

272 
šode
, 
tmp_id©a
[
i
]);

273 ià(
»tv®
) {

274 
	`put_bh
(
bh
);

275  
»tv®
;

279 
	`put_bh
(
bh
);

280 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

281 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
	`Ë32_to_ıu
(
i_d©a
), 1,

282 
EXT4_FREE_BLOCKS_METADATA
 |

283 
EXT4_FREE_BLOCKS_FORGET
);

285 
	}
}

287 
	$ä“_šd_block
(
hªdË_t
 *
hªdË
, 
šode
 *šode, 
__Ë32
 *
i_d©a
)

289 
»tv®
;

292 ià(
i_d©a
[0]) {

293 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

294 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
,

295 
	`Ë32_to_ıu
(
i_d©a
[0]), 1,

296 
EXT4_FREE_BLOCKS_METADATA
 |

297 
EXT4_FREE_BLOCKS_FORGET
);

301 ià(
i_d©a
[1]) {

302 
»tv®
 = 
	`ä“_dšd_blocks
(
hªdË
, 
šode
, 
i_d©a
[1]);

303 ià(
»tv®
)

304  
»tv®
;

308 ià(
i_d©a
[2]) {

309 
»tv®
 = 
	`ä“_tšd_blocks
(
hªdË
, 
šode
, 
i_d©a
[2]);

310 ià(
»tv®
)

311  
»tv®
;

314 
	}
}

316 
	$ext4_ext_sw­_šode_d©a
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

317 
šode
 *
tmp_šode
)

319 
»tv®
;

320 
__Ë32
 
i_d©a
[3];

321 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

322 
ext4_šode_šfo
 *
tmp_ei
 = 
	`EXT4_I
(
tmp_šode
);

328 
»tv®
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 1);

329 ià(
»tv®
) {

330 
»tv®
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 1);

331 ià(
»tv®
)

332 
”r_out
;

335 
i_d©a
[0] = 
ei
->i_d©a[
EXT4_IND_BLOCK
];

336 
i_d©a
[1] = 
ei
->i_d©a[
EXT4_DIND_BLOCK
];

337 
i_d©a
[2] = 
ei
->i_d©a[
EXT4_TIND_BLOCK
];

339 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

345 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_MIGRATE
)) {

346 
»tv®
 = -
EAGAIN
;

347 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

348 
”r_out
;

350 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_MIGRATE
);

355 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

356 
	`memıy
(
ei
->
i_d©a
, 
tmp_ei
->i_data, (ei->i_data));

367 
	`¥š_lock
(&
šode
->
i_lock
);

368 
šode
->
i_blocks
 +ğ
tmp_šode
->i_blocks;

369 
	`¥š_uÆock
(&
šode
->
i_lock
);

370 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

376 
»tv®
 = 
	`ä“_šd_block
(
hªdË
, 
šode
, 
i_d©a
);

377 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

379 
”r_out
:

380  
»tv®
;

381 
	}
}

383 
	$ä“_ext_idx
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

384 
ext4_ex‹Á_idx
 *
ix
)

386 
i
, 
»tv®
 = 0;

387 
ext4_fsblk_t
 
block
;

388 
bufãr_h—d
 *
bh
;

389 
ext4_ex‹Á_h—d”
 *
eh
;

391 
block
 = 
	`ext4_idx_pblock
(
ix
);

392 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
block
);

393 ià(!
bh
)

394  -
EIO
;

396 
eh
 = (
ext4_ex‹Á_h—d”
 *)
bh
->
b_d©a
;

397 ià(
eh
->
eh_d•th
 != 0) {

398 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

399 
i
 = 0; i < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); i++, 
ix
++) {

400 
»tv®
 = 
	`ä“_ext_idx
(
hªdË
, 
šode
, 
ix
);

401 ià(
»tv®
)

405 
	`put_bh
(
bh
);

406 
	`ex‹nd_üed™_fÜ_blkd–
(
hªdË
, 
šode
);

407 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
block
, 1,

408 
EXT4_FREE_BLOCKS_METADATA
 | 
EXT4_FREE_BLOCKS_FORGET
);

409  
»tv®
;

410 
	}
}

415 
	$ä“_ext_block
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

417 
i
, 
»tv®
 = 0;

418 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

419 
ext4_ex‹Á_h—d”
 *
eh
 = (ext4_ex‹Á_h—d” *)
ei
->
i_d©a
;

420 
ext4_ex‹Á_idx
 *
ix
;

421 ià(
eh
->
eh_d•th
 == 0)

426 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

427 
i
 = 0; i < 
	`Ë16_to_ıu
(
eh
->
eh_’Œ›s
); i++, 
ix
++) {

428 
»tv®
 = 
	`ä“_ext_idx
(
hªdË
, 
šode
, 
ix
);

429 ià(
»tv®
)

430  
»tv®
;

432  
»tv®
;

433 
	}
}

435 
	$ext4_ext_mig¿‹
(
šode
 *inode)

437 
hªdË_t
 *
hªdË
;

438 
»tv®
 = 0, 
i
;

439 
__Ë32
 *
i_d©a
;

440 
ext4_šode_šfo
 *
ei
;

441 
šode
 *
tmp_šode
 = 
NULL
;

442 
mig¿‹_¡ruù
 
lb
;

443 
max_’Œ›s
;

444 
__u32
 
gßl
;

445 
uid_t
 
owÃr
[2];

451 ià(!
	`ext4_has_ã©u»_ex‹Ás
(
šode
->
i_sb
) ||

452 (
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

453  -
EINVAL
;

455 ià(
	`S_ISLNK
(
šode
->
i_mode
è&& inode->
i_blocks
 == 0)

459  
»tv®
;

466 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MIGRATE
,

467 4 + 
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
šode
->
i_sb
));

469 ià(
	`IS_ERR
(
hªdË
)) {

470 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

471  
»tv®
;

473 
gßl
 = (((
šode
->
i_šo
 - 1è/ 
	`EXT4_INODES_PER_GROUP
(šode->
i_sb
)) *

474 
	`EXT4_INODES_PER_GROUP
(
šode
->
i_sb
)) + 1;

475 
owÃr
[0] = 
	`i_uid_»ad
(
šode
);

476 
owÃr
[1] = 
	`i_gid_»ad
(
šode
);

477 
tmp_šode
 = 
	`ext4_Ãw_šode
(
hªdË
, 
	`d_šode
(
šode
->
i_sb
->
s_roÙ
),

478 
S_IFREG
, 
NULL
, 
gßl
, 
owÃr
, 0);

479 ià(
	`IS_ERR
(
tmp_šode
)) {

480 
»tv®
 = 
	`PTR_ERR
(
tmp_šode
);

481 
	`ext4_jouº®_¡İ
(
hªdË
);

482  
»tv®
;

484 
	`i_size_wr™e
(
tmp_šode
, 
	`i_size_»ad
(
šode
));

489 
	`ş—r_Æšk
(
tmp_šode
);

491 
	`ext4_ext_Œ“_š™
(
hªdË
, 
tmp_šode
);

492 
	`ext4_Üphª_add
(
hªdË
, 
tmp_šode
);

493 
	`ext4_jouº®_¡İ
(
hªdË
);

511 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

512 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_EXT_MIGRATE
);

513 
	`up_»ad
((&
	`EXT4_I
(
šode
)->
i_d©a_£m
));

515 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MIGRATE
, 1);

516 ià(
	`IS_ERR
(
hªdË
)) {

522 
	`ext4_Üphª_d–
(
NULL
, 
tmp_šode
);

523 
	`ext4_fc_d–
(
šode
);

524 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

525 
out
;

528 
ei
 = 
	`EXT4_I
(
šode
);

529 
i_d©a
 = 
ei
->i_data;

530 
	`mem£t
(&
lb
, 0, (lb));

533 
max_’Œ›s
 = 
šode
->
i_sb
->
s_blocksize
 >> 2;

534 
i
 = 0; i < 
EXT4_NDIR_BLOCKS
; i++) {

535 ià(
i_d©a
[
i
]) {

536 
»tv®
 = 
	`upd©e_ex‹Á_¿nge
(
hªdË
, 
tmp_šode
,

537 
	`Ë32_to_ıu
(
i_d©a
[
i
]), &
lb
);

538 ià(
»tv®
)

539 
”r_out
;

541 
lb
.
cu¼_block
++;

543 ià(
i_d©a
[
EXT4_IND_BLOCK
]) {

544 
»tv®
 = 
	`upd©e_šd_ex‹Á_¿nge
(
hªdË
, 
tmp_šode
,

545 
	`Ë32_to_ıu
(
i_d©a
[
EXT4_IND_BLOCK
]), &
lb
);

546 ià(
»tv®
)

547 
”r_out
;

549 
lb
.
cu¼_block
 +ğ
max_’Œ›s
;

550 ià(
i_d©a
[
EXT4_DIND_BLOCK
]) {

551 
»tv®
 = 
	`upd©e_dšd_ex‹Á_¿nge
(
hªdË
, 
tmp_šode
,

552 
	`Ë32_to_ıu
(
i_d©a
[
EXT4_DIND_BLOCK
]), &
lb
);

553 ià(
»tv®
)

554 
”r_out
;

556 
lb
.
cu¼_block
 +ğ
max_’Œ›s
 * max_entries;

557 ià(
i_d©a
[
EXT4_TIND_BLOCK
]) {

558 
»tv®
 = 
	`upd©e_tšd_ex‹Á_¿nge
(
hªdË
, 
tmp_šode
,

559 
	`Ë32_to_ıu
(
i_d©a
[
EXT4_TIND_BLOCK
]), &
lb
);

560 ià(
»tv®
)

561 
”r_out
;

566 
»tv®
 = 
	`fšish_¿nge
(
hªdË
, 
tmp_šode
, &
lb
);

567 
”r_out
:

568 ià(
»tv®
)

573 
	`ä“_ext_block
(
hªdË
, 
tmp_šode
);

575 
»tv®
 = 
	`ext4_ext_sw­_šode_d©a
(
hªdË
, 
šode
, 
tmp_šode
);

576 ià(
»tv®
)

581 
	`ä“_ext_block
(
hªdË
, 
tmp_šode
);

585 ià(
	`ext4_jouº®_ex‹nd
(
hªdË
, 1) != 0)

586 
	`ext4_jouº®_»¡¬t
(
hªdË
, 1);

591 
	`i_size_wr™e
(
tmp_šode
, 0);

601 
tmp_šode
->
i_blocks
 = 0;

604 
	`ext4_ext_Œ“_š™
(
hªdË
, 
tmp_šode
);

605 
	`ext4_jouº®_¡İ
(
hªdË
);

606 
out
:

607 
	`uÆock_Ãw_šode
(
tmp_šode
);

608 
	`ut
(
tmp_šode
);

610  
»tv®
;

611 
	}
}

616 
	$ext4_šd_mig¿‹
(
šode
 *inode)

618 
ext4_ex‹Á_h—d”
 *
eh
;

619 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

620 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

621 
ext4_ex‹Á
 *
ex
;

622 
i
, 
Ën
;

623 
ext4_lblk_t
 
¡¬t
, 
’d
;

624 
ext4_fsblk_t
 
blk
;

625 
hªdË_t
 *
hªdË
;

626 
»t
;

628 ià(!
	`ext4_has_ã©u»_ex‹Ás
(
šode
->
i_sb
) ||

629 (!
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

630  -
EINVAL
;

632 ià(
	`ext4_has_ã©u»_big®loc
(
šode
->
i_sb
))

633  -
EOPNOTSUPP
;

640 ià(
	`‹¡_İt
(
šode
->
i_sb
, 
DELALLOC
))

641 
	`ext4_®loc_da_blocks
(
šode
);

643 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MIGRATE
, 1);

644 ià(
	`IS_ERR
(
hªdË
))

645  
	`PTR_ERR
(
hªdË
);

647 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

648 
»t
 = 
	`ext4_ext_check_šode
(
šode
);

649 ià(
»t
)

650 
”rout
;

652 
eh
 = 
	`ext_šode_hdr
(
šode
);

653 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

654 ià(
	`ext4_blocks_couÁ
(
es
è> 
EXT4_MAX_BLOCK_FILE_PHYS
 ||

655 
eh
->
eh_d•th
 !ğ0 || 
	`Ë16_to_ıu
Óh->
eh_’Œ›s
) > 1) {

656 
»t
 = -
EOPNOTSUPP
;

657 
”rout
;

659 ià(
eh
->
eh_’Œ›s
 == 0)

660 
blk
 = 
Ën
 = 
¡¬t
 = 
’d
 = 0;

662 
Ën
 = 
	`Ë16_to_ıu
(
ex
->
“_Ën
);

663 
blk
 = 
	`ext4_ext_pblock
(
ex
);

664 
¡¬t
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

665 
’d
 = 
¡¬t
 + 
Ën
 - 1;

666 ià(
’d
 >ğ
EXT4_NDIR_BLOCKS
) {

667 
»t
 = -
EOPNOTSUPP
;

668 
”rout
;

672 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

673 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

674 
i
 = 
¡¬t
; i <ğ
’d
; i++)

675 
ei
->
i_d©a
[
i
] = 
	`ıu_to_Ë32
(
blk
++);

676 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

677 
”rout
:

678 
	`ext4_jouº®_¡İ
(
hªdË
);

679 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_d©a_£m
);

680  
»t
;

681 
	}
}

	@mmp.c

1 
	~<lšux/fs.h
>

2 
	~<lšux/¿ndom.h
>

3 
	~<lšux/bufãr_h—d.h
>

4 
	~<lšux/ut¢ame.h
>

5 
	~<lšux/kth»ad.h
>

7 
	~"ext4.h
"

10 
__Ë32
 
	$ext4_mmp_csum
(
su³r_block
 *
sb
, 
mmp_¡ruù
 *
mmp
)

12 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

13 
off£t
 = 
	`off£tof
(
mmp_¡ruù
, 
mmp_checksum
);

14 
__u32
 
csum
;

16 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (*)
mmp
, 
off£t
);

18  
	`ıu_to_Ë32
(
csum
);

19 
	}
}

21 
	$ext4_mmp_csum_v”ify
(
su³r_block
 *
sb
, 
mmp_¡ruù
 *
mmp
)

23 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

26  
mmp
->
mmp_checksum
 =ğ
	`ext4_mmp_csum
(
sb
, mmp);

27 
	}
}

29 
	$ext4_mmp_csum_£t
(
su³r_block
 *
sb
, 
mmp_¡ruù
 *
mmp
)

31 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

34 
mmp
->
mmp_checksum
 = 
	`ext4_mmp_csum
(
sb
, mmp);

35 
	}
}

41 
	$wr™e_mmp_block
(
su³r_block
 *
sb
, 
bufãr_h—d
 *
bh
)

43 
mmp_¡ruù
 *
mmp
 = (mmp_¡ruù *)(
bh
->
b_d©a
);

49 
	`sb_¡¬t_wr™e
(
sb
);

50 
	`ext4_mmp_csum_£t
(
sb
, 
mmp
);

51 
	`m¬k_bufãr_dœty
(
bh
);

52 
	`lock_bufãr
(
bh
);

53 
bh
->
b_’d_io
 = 
’d_bufãr_wr™e_sync
;

54 
	`g‘_bh
(
bh
);

55 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
, 
bh
);

56 
	`wa™_Ú_bufãr
(
bh
);

57 
	`sb_’d_wr™e
(
sb
);

58 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

62 
	}
}

68 
	$»ad_mmp_block
(
su³r_block
 *
sb
, 
bufãr_h—d
 **
bh
,

69 
ext4_fsblk_t
 
mmp_block
)

71 
mmp_¡ruù
 *
mmp
;

72 
»t
;

74 ià(*
bh
)

75 
	`ş—r_bufãr_u±od©e
(*
bh
);

80 ià(!*
bh
) {

81 *
bh
 = 
	`sb_g‘blk
(
sb
, 
mmp_block
);

82 ià(!*
bh
) {

83 
»t
 = -
ENOMEM
;

84 
w¬n_ex™
;

88 
	`g‘_bh
(*
bh
);

89 
	`lock_bufãr
(*
bh
);

90 (*
bh
)->
b_’d_io
 = 
’d_bufãr_»ad_sync
;

91 
	`subm™_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, *
bh
);

92 
	`wa™_Ú_bufãr
(*
bh
);

93 ià(!
	`bufãr_u±od©e
(*
bh
)) {

94 
»t
 = -
EIO
;

95 
w¬n_ex™
;

97 
mmp
 = (
mmp_¡ruù
 *)((*
bh
)->
b_d©a
);

98 ià(
	`Ë32_to_ıu
(
mmp
->
mmp_magic
è!ğ
EXT4_MMP_MAGIC
) {

99 
»t
 = -
EFSCORRUPTED
;

100 
w¬n_ex™
;

102 ià(!
	`ext4_mmp_csum_v”ify
(
sb
, 
mmp
)) {

103 
»t
 = -
EFSBADCRC
;

104 
w¬n_ex™
;

107 
w¬n_ex™
:

108 
	`b»l£
(*
bh
);

109 *
bh
 = 
NULL
;

110 
	`ext4_w¬nšg
(
sb
, "Error %d while„eading MMP block %llu",

111 
»t
, 
mmp_block
);

112  
»t
;

113 
	}
}

118 
	$__dump_mmp_msg
(
su³r_block
 *
sb
, 
mmp_¡ruù
 *
mmp
,

119 cÚ¡ *
funùiÚ
, 
lše
, cÚ¡ *
msg
)

121 
	`__ext4_w¬nšg
(
sb
, 
funùiÚ
, 
lše
, "%s", 
msg
);

122 
	`__ext4_w¬nšg
(
sb
, 
funùiÚ
, 
lše
,

125 (è
	`Ë64_to_ıu
(
mmp
->
mmp_time
),

126 
mmp
->
mmp_nod’ame
, mmp->
mmp_bdevÇme
);

127 
	}
}

132 
	$kmmpd
(*
d©a
)

134 
su³r_block
 *
sb
 = ((
mmpd_d©a
 *è
d©a
)->sb;

135 
bufãr_h—d
 *
bh
 = ((
mmpd_d©a
 *è
d©a
)->bh;

136 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

137 
mmp_¡ruù
 *
mmp
;

138 
ext4_fsblk_t
 
mmp_block
;

139 
u32
 
£q
 = 0;

140 
çed_wr™es
 = 0;

141 
mmp_upd©e_š‹rv®
 = 
	`Ë16_to_ıu
(
es
->
s_mmp_upd©e_š‹rv®
);

142 
mmp_check_š‹rv®
;

143 
Ï¡_upd©e_time
;

144 
diff
;

145 
»tv®
;

147 
mmp_block
 = 
	`Ë64_to_ıu
(
es
->
s_mmp_block
);

148 
mmp
 = (
mmp_¡ruù
 *)(
bh
->
b_d©a
);

149 
mmp
->
mmp_time
 = 
	`ıu_to_Ë64
(
	`g‘_£cÚds
());

154 
mmp_check_š‹rv®
 = 
	`max
(
EXT4_MMP_CHECK_MULT
 * 
mmp_upd©e_š‹rv®
,

155 
EXT4_MMP_MIN_CHECK_INTERVAL
);

156 
mmp
->
mmp_check_š‹rv®
 = 
	`ıu_to_Ë16
(mmp_check_interval);

157 
	`bdevÇme
(
bh
->
b_bdev
, 
mmp
->
mmp_bdevÇme
);

159 
	`memıy
(
mmp
->
mmp_nod’ame
, 
	`š™_ut¢ame
()->
nod’ame
,

160 (
mmp
->
mmp_nod’ame
));

162 !
	`kth»ad_should_¡İ
()) {

163 ià(++
£q
 > 
EXT4_MMP_SEQ_MAX
)

164 
£q
 = 1;

166 
mmp
->
mmp_£q
 = 
	`ıu_to_Ë32
(
£q
);

167 
mmp
->
mmp_time
 = 
	`ıu_to_Ë64
(
	`g‘_£cÚds
());

168 
Ï¡_upd©e_time
 = 
jiff›s
;

170 
»tv®
 = 
	`wr™e_mmp_block
(
sb
, 
bh
);

175 ià(
»tv®
) {

176 ià((
çed_wr™es
 % 60) == 0)

177 
	`ext4_”rÜ
(
sb
, "Error writingo MMP block");

178 
çed_wr™es
++;

181 ià(!(
	`Ë32_to_ıu
(
es
->
s_ã©u»_šcom·t
) &

182 
EXT4_FEATURE_INCOMPAT_MMP
)) {

183 
	`ext4_w¬nšg
(
sb
, "kmmpd being stopped since MMP feature"

185 
ex™_th»ad
;

188 ià(
sb
->
s_æags
 & 
MS_RDONLY
) {

189 
	`ext4_w¬nšg
(
sb
, "kmmpd being stopped since filesystem "

191 
ex™_th»ad
;

194 
diff
 = 
jiff›s
 - 
Ï¡_upd©e_time
;

195 ià(
diff
 < 
mmp_upd©e_š‹rv®
 * 
HZ
)

196 
	`scheduË_timeout_š‹¼u±ibË
(
mmp_upd©e_š‹rv®
 *

197 
HZ
 - 
diff
);

204 
diff
 = 
jiff›s
 - 
Ï¡_upd©e_time
;

205 ià(
diff
 > 
mmp_check_š‹rv®
 * 
HZ
) {

206 
bufãr_h—d
 *
bh_check
 = 
NULL
;

207 
mmp_¡ruù
 *
mmp_check
;

209 
»tv®
 = 
	`»ad_mmp_block
(
sb
, &
bh_check
, 
mmp_block
);

210 ià(
»tv®
) {

211 
	`ext4_”rÜ
(
sb
, "error„eading MMP data: %d",

212 
»tv®
);

213 
ex™_th»ad
;

216 
mmp_check
 = (
mmp_¡ruù
 *)(
bh_check
->
b_d©a
);

217 ià(
mmp
->
mmp_£q
 !ğ
mmp_check
->mmp_seq ||

218 
	`memcmp
(
mmp
->
mmp_nod’ame
, 
mmp_check
->mmp_nodename,

219 (
mmp
->
mmp_nod’ame
))) {

220 
	`dump_mmp_msg
(
sb
, 
mmp_check
,

224 
	`ext4_”rÜ
(
sb
, "abort");

225 
	`put_bh
(
bh_check
);

226 
»tv®
 = -
EBUSY
;

227 
ex™_th»ad
;

229 
	`put_bh
(
bh_check
);

236 
mmp_check_š‹rv®
 = 
	`max
(
	`mš
(
EXT4_MMP_CHECK_MULT
 * 
diff
 / 
HZ
,

237 
EXT4_MMP_MAX_CHECK_INTERVAL
),

238 
EXT4_MMP_MIN_CHECK_INTERVAL
);

239 
mmp
->
mmp_check_š‹rv®
 = 
	`ıu_to_Ë16
(mmp_check_interval);

245 
mmp
->
mmp_£q
 = 
	`ıu_to_Ë32
(
EXT4_MMP_SEQ_CLEAN
);

246 
mmp
->
mmp_time
 = 
	`ıu_to_Ë64
(
	`g‘_£cÚds
());

248 
»tv®
 = 
	`wr™e_mmp_block
(
sb
, 
bh
);

250 
ex™_th»ad
:

251 
	`EXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

252 
	`kä“
(
d©a
);

253 
	`b»l£
(
bh
);

254  
»tv®
;

255 
	}
}

261 
	$mmp_Ãw_£q
()

263 
u32
 
Ãw_£q
;

266 
Ãw_£q
 = 
	`´ªdom_u32
();

267 } 
Ãw_£q
 > 
EXT4_MMP_SEQ_MAX
);

269  
Ãw_£q
;

270 
	}
}

275 
	$ext4_muÉi_mouÁ_´Ùeù
(
su³r_block
 *
sb
,

276 
ext4_fsblk_t
 
mmp_block
)

278 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

279 
bufãr_h—d
 *
bh
 = 
NULL
;

280 
mmp_¡ruù
 *
mmp
 = 
NULL
;

281 
mmpd_d©a
 *mmpd_data;

282 
u32
 
£q
;

283 
mmp_check_š‹rv®
 = 
	`Ë16_to_ıu
(
es
->
s_mmp_upd©e_š‹rv®
);

284 
wa™_time
 = 0;

285 
»tv®
;

287 ià(
mmp_block
 < 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
) ||

288 
mmp_block
 >ğ
	`ext4_blocks_couÁ
(
es
)) {

289 
	`ext4_w¬nšg
(
sb
, "Invalid MMP block in superblock");

290 
çed
;

293 
»tv®
 = 
	`»ad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

294 ià(
»tv®
)

295 
çed
;

297 
mmp
 = (
mmp_¡ruù
 *)(
bh
->
b_d©a
);

299 ià(
mmp_check_š‹rv®
 < 
EXT4_MMP_MIN_CHECK_INTERVAL
)

300 
mmp_check_š‹rv®
 = 
EXT4_MMP_MIN_CHECK_INTERVAL
;

306 ià(
	`Ë16_to_ıu
(
mmp
->
mmp_check_š‹rv®
) > mmp_check_interval)

307 
mmp_check_š‹rv®
 = 
	`Ë16_to_ıu
(
mmp
->mmp_check_interval);

309 
£q
 = 
	`Ë32_to_ıu
(
mmp
->
mmp_£q
);

310 ià(
£q
 =ğ
EXT4_MMP_SEQ_CLEAN
)

311 
sk
;

313 ià(
£q
 =ğ
EXT4_MMP_SEQ_FSCK
) {

314 
	`dump_mmp_msg
(
sb
, 
mmp
, "fsck is„unning onhe filesystem");

315 
çed
;

318 
wa™_time
 = 
	`mš
(
mmp_check_š‹rv®
 * 2 + 1,

319 
mmp_check_š‹rv®
 + 60);

322 ià(
wa™_time
 > 
EXT4_MMP_MIN_CHECK_INTERVAL
 * 4)

323 
	`ext4_w¬nšg
(
sb
, "MMP interval %u higherhanƒxpected,…lease"

324 " wa™.\n", 
wa™_time
 * 2);

326 ià(
	`scheduË_timeout_š‹¼u±ibË
(
HZ
 * 
wa™_time
) != 0) {

327 
	`ext4_w¬nšg
(
sb
, "MMP startup interrupted, failing mount\n");

328 
çed
;

331 
»tv®
 = 
	`»ad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

332 ià(
»tv®
)

333 
çed
;

334 
mmp
 = (
mmp_¡ruù
 *)(
bh
->
b_d©a
);

335 ià(
£q
 !ğ
	`Ë32_to_ıu
(
mmp
->
mmp_£q
)) {

336 
	`dump_mmp_msg
(
sb
, 
mmp
,

338 
çed
;

341 
sk
:

345 
£q
 = 
	`mmp_Ãw_£q
();

346 
mmp
->
mmp_£q
 = 
	`ıu_to_Ë32
(
£q
);

348 
»tv®
 = 
	`wr™e_mmp_block
(
sb
, 
bh
);

349 ià(
»tv®
)

350 
çed
;

355 ià(
	`scheduË_timeout_š‹¼u±ibË
(
HZ
 * 
wa™_time
) != 0) {

356 
	`ext4_w¬nšg
(
sb
, "MMP startup interrupted, failing mount");

357 
çed
;

360 
»tv®
 = 
	`»ad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

361 ià(
»tv®
)

362 
çed
;

363 
mmp
 = (
mmp_¡ruù
 *)(
bh
->
b_d©a
);

364 ià(
£q
 !ğ
	`Ë32_to_ıu
(
mmp
->
mmp_£q
)) {

365 
	`dump_mmp_msg
(
sb
, 
mmp
,

367 
çed
;

370 
mmpd_d©a
 = 
	`km®loc
((mmpd_d©a), 
GFP_KERNEL
);

371 ià(!
mmpd_d©a
) {

372 
	`ext4_w¬nšg
(
sb
, "notƒnough memory for mmpd_data");

373 
çed
;

375 
mmpd_d©a
->
sb
 = sb;

376 
mmpd_d©a
->
bh
 = bh;

381 
	`EXT4_SB
(
sb
)->
s_mmp_tsk
 = 
	`kth»ad_run
(
kmmpd
, 
mmpd_d©a
, "kmmpd-%s",

382 
	`bdevÇme
(
bh
->
b_bdev
,

383 
mmp
->
mmp_bdevÇme
));

384 ià(
	`IS_ERR
(
	`EXT4_SB
(
sb
)->
s_mmp_tsk
)) {

385 
	`EXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

386 
	`kä“
(
mmpd_d©a
);

387 
	`ext4_w¬nšg
(
sb
, "Unableo create kmmpdhread for %s.",

388 
sb
->
s_id
);

389 
çed
;

394 
çed
:

395 
	`b»l£
(
bh
);

397 
	}
}

	@move_extent.c

16 
	~<lšux/fs.h
>

17 
	~<lšux/quÙaİs.h
>

18 
	~<lšux/¦ab.h
>

19 
	~"ext4_jbd2.h
"

20 
	~"ext4.h
"

21 
	~"ext4_ex‹Ás.h
"

33 
šlše
 

34 
	$g‘_ext_·th
(
šode
 *šode, 
ext4_lblk_t
 
lblock
,

35 
ext4_ext_·th
 **
µ©h
)

37 
ext4_ext_·th
 *
·th
;

39 
·th
 = 
	`ext4_fšd_ex‹Á
(
šode
, 
lblock
, 
µ©h
, 
EXT4_EX_NOCACHE
);

40 ià(
	`IS_ERR
(
·th
))

41  
	`PTR_ERR
(
·th
);

42 ià(
·th
[
	`ext_d•th
(
šode
)].
p_ext
 =ğ
NULL
) {

43 
	`ext4_ext_drİ_»fs
(
·th
);

44 
	`kä“
(
·th
);

45 *
µ©h
 = 
NULL
;

46  -
ENODATA
;

48 *
µ©h
 = 
·th
;

50 
	}
}

59 
	$ext4_doubË_down_wr™e_d©a_£m
(
šode
 *
fœ¡
, šod*
£cÚd
)

61 ià(
fœ¡
 < 
£cÚd
) {

62 
	`down_wr™e
(&
	`EXT4_I
(
fœ¡
)->
i_d©a_£m
);

63 
	`down_wr™e_Ã¡ed
(&
	`EXT4_I
(
£cÚd
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

65 
	`down_wr™e
(&
	`EXT4_I
(
£cÚd
)->
i_d©a_£m
);

66 
	`down_wr™e_Ã¡ed
(&
	`EXT4_I
(
fœ¡
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

69 
	}
}

79 
	$ext4_doubË_up_wr™e_d©a_£m
(
šode
 *
Üig_šode
,

80 
šode
 *
dÚÜ_šode
)

82 
	`up_wr™e
(&
	`EXT4_I
(
Üig_šode
)->
i_d©a_£m
);

83 
	`up_wr™e
(&
	`EXT4_I
(
dÚÜ_šode
)->
i_d©a_£m
);

84 
	}
}

98 
	$mext_check_cov”age
(
šode
 *šode, 
ext4_lblk_t
 
äom
,ƒxt4_lblk_ˆ
couÁ
,

99 
unwr™‹n
, *
”r
)

101 
ext4_ext_·th
 *
·th
 = 
NULL
;

102 
ext4_ex‹Á
 *
ext
;

103 
»t
 = 0;

104 
ext4_lblk_t
 
Ï¡
 = 
äom
 + 
couÁ
;

105 
äom
 < 
Ï¡
) {

106 *
”r
 = 
	`g‘_ext_·th
(
šode
, 
äom
, &
·th
);

107 ià(*
”r
)

108 
out
;

109 
ext
 = 
·th
[
	`ext_d•th
(
šode
)].
p_ext
;

110 ià(
unwr™‹n
 !ğ
	`ext4_ext_is_unwr™‹n
(
ext
))

111 
out
;

112 
äom
 +ğ
	`ext4_ext_g‘_aùu®_Ën
(
ext
);

113 
	`ext4_ext_drİ_»fs
(
·th
);

115 
»t
 = 1;

116 
out
:

117 
	`ext4_ext_drİ_»fs
(
·th
);

118 
	`kä“
(
·th
);

119  
»t
;

120 
	}
}

134 
	$mext_·ge_doubË_lock
(
šode
 *
šode1
, šod*
šode2
,

135 
pgoff_t
 
šdex1
,…goff_ˆ
šdex2
, 
·ge
 *page[2])

137 
add»ss_¥aû
 *
m­pšg
[2];

138 
æ
 = 
AOP_FLAG_NOFS
;

140 
	`BUG_ON
(!
šode1
 || !
šode2
);

141 ià(
šode1
 < 
šode2
) {

142 
m­pšg
[0] = 
šode1
->
i_m­pšg
;

143 
m­pšg
[1] = 
šode2
->
i_m­pšg
;

145 
pgoff_t
 
tmp
 = 
šdex1
;

146 
šdex1
 = 
šdex2
;

147 
šdex2
 = 
tmp
;

148 
m­pšg
[0] = 
šode2
->
i_m­pšg
;

149 
m­pšg
[1] = 
šode1
->
i_m­pšg
;

152 
·ge
[0] = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
[0], 
šdex1
, 
æ
);

153 ià(!
·ge
[0])

154  -
ENOMEM
;

156 
·ge
[1] = 
	`g¿b_ÿche_·ge_wr™e_begš
(
m­pšg
[1], 
šdex2
, 
æ
);

157 ià(!
·ge
[1]) {

158 
	`uÆock_·ge
(
·ge
[0]);

159 
	`put_·ge
(
·ge
[0]);

160  -
ENOMEM
;

167 
	`wa™_Ú_·ge_wr™eback
(
·ge
[0]);

168 
	`wa™_Ú_·ge_wr™eback
(
·ge
[1]);

169 ià(
šode1
 > 
šode2
)

170 
	`sw­
(
·ge
[0],…age[1]);

173 
	}
}

177 
	$mext_·ge_mku±od©e
(
·ge
 *·ge, 
äom
, 
to
)

179 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

180 
£ùÜ_t
 
block
;

181 
bufãr_h—d
 *
bh
, *
h—d
, *
¬r
[
MAX_BUF_PER_PAGE
];

182 
blocksize
, 
block_¡¬t
, 
block_’d
;

183 
i
, 
”r
, 
Ä
 = 0, 
·¹Ÿl
 = 0;

184 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

185 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

187 ià(
	`PageU±od©e
(
·ge
))

190 
blocksize
 = 
	`i_blocksize
(
šode
);

191 ià(!
	`·ge_has_bufãrs
(
·ge
))

192 
	`ü—‹_em±y_bufãrs
(
·ge
, 
blocksize
, 0);

194 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

195 
block
 = (
£ùÜ_t
)
·ge
->
šdex
 << (
PAGE_SHIFT
 - 
šode
->
i_blkb™s
);

196 
bh
 = 
h—d
, 
block_¡¬t
 = 0; bh != head || !block_start;

197 
block
++, 
block_¡¬t
 = 
block_’d
, 
bh
 = bh->
b_this_·ge
) {

198 
block_’d
 = 
block_¡¬t
 + 
blocksize
;

199 ià(
block_’d
 <ğ
äom
 || 
block_¡¬t
 >ğ
to
) {

200 ià(!
	`bufãr_u±od©e
(
bh
))

201 
·¹Ÿl
 = 1;

204 ià(
	`bufãr_u±od©e
(
bh
))

206 ià(!
	`bufãr_m­³d
(
bh
)) {

207 
”r
 = 
	`ext4_g‘_block
(
šode
, 
block
, 
bh
, 0);

208 ià(
”r
) {

209 
	`S‘PageE¼Ü
(
·ge
);

210  
”r
;

212 ià(!
	`bufãr_m­³d
(
bh
)) {

213 
	`z”o_u£r
(
·ge
, 
block_¡¬t
, 
blocksize
);

214 
	`£t_bufãr_u±od©e
(
bh
);

218 
	`BUG_ON
(
Ä
 >ğ
MAX_BUF_PER_PAGE
);

219 
¬r
[
Ä
++] = 
bh
;

222 ià(!
Ä
)

223 
out
;

225 
i
 = 0; i < 
Ä
; i++) {

226 
bh
 = 
¬r
[
i
];

227 ià(!
	`bh_u±od©e_Ü_lock
(
bh
)) {

228 
”r
 = 
	`bh_subm™_»ad
(
bh
);

229 ià(
”r
)

230  
”r
;

233 
out
:

234 ià(!
·¹Ÿl
)

235 
	`S‘PageU±od©e
(
·ge
);

237 
	}
}

257 
	$move_ex‹Á_³r_·ge
(
fe
 *
o_fp
, 
šode
 *
dÚÜ_šode
,

258 
pgoff_t
 
Üig_·ge_off£t
,…goff_ˆ
dÚÜ_·ge_off£t
,

259 
d©a_off£t_š_·ge
,

260 
block_Ën_š_·ge
, 
unwr™‹n
, *
”r
)

262 
šode
 *
Üig_šode
 = 
	`fe_šode
(
o_fp
);

263 
·ge
 *
·g•
[2] = {
NULL
, NULL};

264 
hªdË_t
 *
hªdË
;

265 
ext4_lblk_t
 
Üig_blk_off£t
, 
dÚÜ_blk_off£t
;

266 
blocksize
 = 
Üig_šode
->
i_sb
->
s_blocksize
;

267 
tmp_d©a_size
, 
d©a_size
, 
»¶aûd_size
;

268 
i
, 
”r2
, 
jblocks
, 
»Œ›s
 = 0;

269 
»¶aûd_couÁ
 = 0;

270 
äom
 = 
d©a_off£t_š_·ge
 << 
Üig_šode
->
i_blkb™s
;

271 
blocks_³r_·ge
 = 
PAGE_SIZE
 >> 
Üig_šode
->
i_blkb™s
;

272 
su³r_block
 *
sb
 = 
Üig_šode
->
i_sb
;

273 
bufãr_h—d
 *
bh
 = 
NULL
;

279 
agaš
:

280 *
”r
 = 0;

281 
jblocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
Üig_šode
) * 2;

282 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
Üig_šode
, 
EXT4_HT_MOVE_EXTENTS
, 
jblocks
);

283 ià(
	`IS_ERR
(
hªdË
)) {

284 *
”r
 = 
	`PTR_ERR
(
hªdË
);

288 
Üig_blk_off£t
 = 
Üig_·ge_off£t
 * 
blocks_³r_·ge
 +

289 
d©a_off£t_š_·ge
;

291 
dÚÜ_blk_off£t
 = 
dÚÜ_·ge_off£t
 * 
blocks_³r_·ge
 +

292 
d©a_off£t_š_·ge
;

295 ià((
Üig_blk_off£t
 + 
block_Ën_š_·ge
 - 1) ==

296 ((
Üig_šode
->
i_size
 - 1è>> orig_šode->
i_blkb™s
)) {

298 
tmp_d©a_size
 = 
Üig_šode
->
i_size
 & (
blocksize
 - 1);

303 ià(
tmp_d©a_size
 == 0)

304 
tmp_d©a_size
 = 
blocksize
;

306 
d©a_size
 = 
tmp_d©a_size
 +

307 ((
block_Ën_š_·ge
 - 1è<< 
Üig_šode
->
i_blkb™s
);

309 
d©a_size
 = 
block_Ën_š_·ge
 << 
Üig_šode
->
i_blkb™s
;

311 
»¶aûd_size
 = 
d©a_size
;

313 *
”r
 = 
	`mext_·ge_doubË_lock
(
Üig_šode
, 
dÚÜ_šode
, 
Üig_·ge_off£t
,

314 
dÚÜ_·ge_off£t
, 
·g•
);

315 ià(
	`uÆik–y
(*
”r
 < 0))

316 
¡İ_jouº®
;

324 ià(
unwr™‹n
) {

325 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

328 
unwr™‹n
 = 
	`mext_check_cov”age
(
Üig_šode
, 
Üig_blk_off£t
,

329 
block_Ën_š_·ge
, 1, 
”r
);

330 ià(*
”r
)

331 
drİ_d©a_£m
;

333 
unwr™‹n
 &ğ
	`mext_check_cov”age
(
dÚÜ_šode
, 
dÚÜ_blk_off£t
,

334 
block_Ën_š_·ge
, 1, 
”r
);

335 ià(*
”r
)

336 
drİ_d©a_£m
;

338 ià(!
unwr™‹n
) {

339 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

340 
d©a_cİy
;

342 ià((
	`·ge_has_´iv©e
(
·g•
[0]) &&

343 !
	`Œy_to_»Ëa£_·ge
(
·g•
[0], 0)) ||

344 (
	`·ge_has_´iv©e
(
·g•
[1]) &&

345 !
	`Œy_to_»Ëa£_·ge
(
·g•
[1], 0))) {

346 *
”r
 = -
EBUSY
;

347 
drİ_d©a_£m
;

349 
»¶aûd_couÁ
 = 
	`ext4_sw­_ex‹Ás
(
hªdË
, 
Üig_šode
,

350 
dÚÜ_šode
, 
Üig_blk_off£t
,

351 
dÚÜ_blk_off£t
,

352 
block_Ën_š_·ge
, 1, 
”r
);

353 
drİ_d©a_£m
:

354 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

355 
uÆock_·ges
;

357 
d©a_cİy
:

358 *
”r
 = 
	`mext_·ge_mku±od©e
(
·g•
[0], 
äom
, from + 
»¶aûd_size
);

359 ià(*
”r
)

360 
uÆock_·ges
;

364 ià((
	`·ge_has_´iv©e
(
·g•
[0]è&& !
	`Œy_to_»Ëa£_·ge
(pagep[0], 0)) ||

365 (
	`·ge_has_´iv©e
(
·g•
[1]è&& !
	`Œy_to_»Ëa£_·ge
(pagep[1], 0))) {

366 *
”r
 = -
EBUSY
;

367 
uÆock_·ges
;

369 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

370 
»¶aûd_couÁ
 = 
	`ext4_sw­_ex‹Ás
(
hªdË
, 
Üig_šode
, 
dÚÜ_šode
,

371 
Üig_blk_off£t
, 
dÚÜ_blk_off£t
,

372 
block_Ën_š_·ge
, 1, 
”r
);

373 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

374 ià(*
”r
) {

375 ià(
»¶aûd_couÁ
) {

376 
block_Ën_š_·ge
 = 
»¶aûd_couÁ
;

377 
»¶aûd_size
 =

378 
block_Ën_š_·ge
 << 
Üig_šode
->
i_blkb™s
;

380 
uÆock_·ges
;

384 ià(!
	`·ge_has_bufãrs
(
·g•
[0]))

385 
	`ü—‹_em±y_bufãrs
(
·g•
[0], 1 << 
Üig_šode
->
i_blkb™s
, 0);

386 
bh
 = 
	`·ge_bufãrs
(
·g•
[0]);

387 
i
 = 0; i < 
d©a_off£t_š_·ge
; i++)

388 
bh
 = bh->
b_this_·ge
;

389 
i
 = 0; i < 
block_Ën_š_·ge
; i++) {

390 *
”r
 = 
	`ext4_g‘_block
(
Üig_šode
, 
Üig_blk_off£t
 + 
i
, 
bh
, 0);

391 ià(*
”r
 < 0)

393 
bh
 = bh->
b_this_·ge
;

395 ià(!*
”r
)

396 *
”r
 = 
	`block_comm™_wr™e
(
·g•
[0], 
äom
, from + 
»¶aûd_size
);

398 ià(
	`uÆik–y
(*
”r
 < 0))

399 
»·œ_b¿nches
;

403 *
”r
 = 
	`ext4_jbd2_šode_add_wr™e
(
hªdË
, 
Üig_šode
);

405 
uÆock_·ges
:

406 
	`uÆock_·ge
(
·g•
[0]);

407 
	`put_·ge
(
·g•
[0]);

408 
	`uÆock_·ge
(
·g•
[1]);

409 
	`put_·ge
(
·g•
[1]);

410 
¡İ_jouº®
:

411 
	`ext4_jouº®_¡İ
(
hªdË
);

412 ià(*
”r
 =ğ-
ENOSPC
 &&

413 
	`ext4_should_»Œy_®loc
(
sb
, &
»Œ›s
))

414 
agaš
;

417 ià(*
”r
 =ğ-
EBUSY
 && 
»Œ›s
++ < 4 && 
	`EXT4_SB
(
sb
)->
s_jouº®
 &&

418 
	`jbd2_jouº®_fÜû_comm™_Ã¡ed
(
	`EXT4_SB
(
sb
)->
s_jouº®
))

419 
agaš
;

420  
»¶aûd_couÁ
;

422 
»·œ_b¿nches
:

428 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

429 
»¶aûd_couÁ
 = 
	`ext4_sw­_ex‹Ás
(
hªdË
, 
dÚÜ_šode
, 
Üig_šode
,

430 
Üig_blk_off£t
, 
dÚÜ_blk_off£t
,

431 
block_Ën_š_·ge
, 0, &
”r2
);

432 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

433 ià(
»¶aûd_couÁ
 !ğ
block_Ën_š_·ge
) {

434 
	`EXT4_ERROR_INODE_BLOCK
(
Üig_šode
, (
£ùÜ_t
)(
Üig_blk_off£t
),

437 *
”r
 = -
EIO
;

439 
»¶aûd_couÁ
 = 0;

440 
uÆock_·ges
;

441 
	}
}

457 
	$mext_check_¬gum’ts
(
šode
 *
Üig_šode
,

458 
šode
 *
dÚÜ_šode
, 
__u64
 
Üig_¡¬t
,

459 
__u64
 
dÚÜ_¡¬t
, __u64 *
Ën
)

461 
__u64
 
Üig_eof
, 
dÚÜ_eof
;

462 
blkb™s
 = 
Üig_šode
->
i_blkb™s
;

463 
blocksize
 = 1 << 
blkb™s
;

465 
Üig_eof
 = (
	`i_size_»ad
(
Üig_šode
è+ 
blocksize
 - 1è>> 
blkb™s
;

466 
dÚÜ_eof
 = (
	`i_size_»ad
(
dÚÜ_šode
è+ 
blocksize
 - 1è>> 
blkb™s
;

469 ià(
dÚÜ_šode
->
i_mode
 & (
S_ISUID
|
S_ISGID
)) {

470 
	`ext4_debug
("ext4 moveƒxtent: suid or sgid is set"

472 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

473  -
EINVAL
;

476 ià(
	`IS_IMMUTABLE
(
dÚÜ_šode
è|| 
	`IS_APPEND
(donor_inode))

477  -
EPERM
;

480 ià(
	`IS_SWAPFILE
(
Üig_šode
è|| IS_SWAPFILE(
dÚÜ_šode
)) {

481 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files should "

483 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

484  -
EBUSY
;

487 ià(
	`ext4_is_quÙa_fe
(
Üig_šode
è&&ƒxt4_is_quÙa_fe(
dÚÜ_šode
)) {

488 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files should "

490 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

491  -
EBUSY
;

495 ià(!(
	`ext4_‹¡_šode_æag
(
Üig_šode
, 
EXT4_INODE_EXTENTS
))) {

496 
	`ext4_debug
("ext4 moveƒxtent: orig file is‚otƒxtents "

497 "ba£d f[šo:Üig %lu]\n", 
Üig_šode
->
i_šo
);

498  -
EOPNOTSUPP
;

499 } ià(!(
	`ext4_‹¡_šode_æag
(
dÚÜ_šode
, 
EXT4_INODE_EXTENTS
))) {

500 
	`ext4_debug
("ext4 moveƒxtent: donor file is‚otƒxtents "

501 "ba£d f[šo:dÚÜ %lu]\n", 
dÚÜ_šode
->
i_šo
);

502  -
EOPNOTSUPP
;

505 ià((!
Üig_šode
->
i_size
è|| (!
dÚÜ_šode
->i_size)) {

506 
	`ext4_debug
("ext4 moveƒxtent: File size is 0 byte\n");

508  -
EINVAL
;

512 ià((
Üig_¡¬t
 & ~(
PAGE_MASK
 >> 
Üig_šode
->
i_blkb™s
)) !=

513 (
dÚÜ_¡¬t
 & ~(
PAGE_MASK
 >> 
Üig_šode
->
i_blkb™s
))) {

514 
	`ext4_debug
("ext4 moveƒxtent: orig‡nd donor's start "

516 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

517 
	`´štk
(
KERN_INFO
 "%s: off£t ¬nÙ same. orig_¡¬ˆğ%Îd, dÚÜ_¡¬ˆğ%Îd\n", 
__func__
, 
Üig_¡¬t
, 
dÚÜ_¡¬t
);

518  -
EINVAL
;

521 ià((
Üig_¡¬t
 >ğ
EXT_MAX_BLOCKS
) ||

522 (
dÚÜ_¡¬t
 >ğ
EXT_MAX_BLOCKS
) ||

523 (*
Ën
 > 
EXT_MAX_BLOCKS
) ||

524 (
dÚÜ_¡¬t
 + *
Ën
 >ğ
EXT_MAX_BLOCKS
) ||

525 (
Üig_¡¬t
 + *
Ën
 >ğ
EXT_MAX_BLOCKS
)) {

526 
	`ext4_debug
("ext4 moveƒxtent: Can't handle over [%u] blocks "

527 "[šo:Üig %lu, dÚÜ %lu]\n", 
EXT_MAX_BLOCKS
,

528 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

529 
	`´štk
(
KERN_INFO
 "%s: cª'ˆhªdËoØmªy blocks.\n", 
__func__
);

530  -
EINVAL
;

532 ià(
Üig_eof
 < 
Üig_¡¬t
 + *
Ën
 - 1)

533 *
Ën
 = 
Üig_eof
 - 
Üig_¡¬t
;

534 ià(
dÚÜ_eof
 < 
dÚÜ_¡¬t
 + *
Ën
 - 1)

535 *
Ën
 = 
dÚÜ_eof
 - 
dÚÜ_¡¬t
;

536 ià(!*
Ën
) {

537 
	`ext4_debug
("ext4 moveƒxtent:†en should‚ot be 0 "

538 "[šo:Üig %lu, dÚÜ %lu]\n", 
Üig_šode
->
i_šo
,

539 
dÚÜ_šode
->
i_šo
);

540 
	`´štk
(
KERN_INFO
 "%s:†’ should‚Ù b0.\n", 
__func__
);

541  -
EINVAL
;

545 
	}
}

562 
	$ext4_move_ex‹Ás
(
fe
 *
o_fp
, f*
d_fp
, 
__u64
 
Üig_blk
,

563 
__u64
 
dÚÜ_blk
, __u64 
Ën
, __u64 *
moved_Ën
)

565 
šode
 *
Üig_šode
 = 
	`fe_šode
(
o_fp
);

566 
šode
 *
dÚÜ_šode
 = 
	`fe_šode
(
d_fp
);

567 
ext4_ext_·th
 *
·th
 = 
NULL
;

568 
blocks_³r_·ge
 = 
PAGE_SIZE
 >> 
Üig_šode
->
i_blkb™s
;

569 
ext4_lblk_t
 
o_’d
, 
o_¡¬t
 = 
Üig_blk
;

570 
ext4_lblk_t
 
d_¡¬t
 = 
dÚÜ_blk
;

571 
»t
;

573 ià(
Üig_šode
->
i_sb
 !ğ
dÚÜ_šode
->i_sb) {

574 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files "

576 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

577  -
EINVAL
;

581 ià(
Üig_šode
 =ğ
dÚÜ_šode
) {

582 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files should‚ot "

584 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

585  -
EINVAL
;

589 ià(!
	`S_ISREG
(
Üig_šode
->
i_mode
è|| !S_ISREG(
dÚÜ_šode
->i_mode)) {

590 
	`ext4_debug
("ext4 moveƒxtent: The‡rgument files should be "

592 
Üig_šode
->
i_šo
, 
dÚÜ_šode
->i_ino);

593  -
EINVAL
;

598 ià(
	`ext4_should_jouº®_d©a
(
Üig_šode
) ||

599 
	`ext4_should_jouº®_d©a
(
dÚÜ_šode
)) {

600 
	`ext4_msg
(
Üig_šode
->
i_sb
, 
KERN_ERR
,

602  -
EOPNOTSUPP
;

605 ià(
	`ext4_’üy±ed_šode
(
Üig_šode
) ||

606 
	`ext4_’üy±ed_šode
(
dÚÜ_šode
)) {

607 
	`ext4_msg
(
Üig_šode
->
i_sb
, 
KERN_ERR
,

609  -
EOPNOTSUPP
;

613 
	`lock_two_nÚdœeùÜ›s
(
Üig_šode
, 
dÚÜ_šode
);

616 
	`ext4_šode_block_uÆocked_dio
(
Üig_šode
);

617 
	`ext4_šode_block_uÆocked_dio
(
dÚÜ_šode
);

618 
	`šode_dio_wa™
(
Üig_šode
);

619 
	`šode_dio_wa™
(
dÚÜ_šode
);

622 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

624 
»t
 = 
	`mext_check_¬gum’ts
(
Üig_šode
, 
dÚÜ_šode
, 
Üig_blk
,

625 
dÚÜ_blk
, &
Ën
);

626 ià(
»t
)

627 
out
;

628 
o_’d
 = 
o_¡¬t
 + 
Ën
;

630 
o_¡¬t
 < 
o_’d
) {

631 
ext4_ex‹Á
 *
ex
;

632 
ext4_lblk_t
 
cur_blk
, 
Ãxt_blk
;

633 
pgoff_t
 
Üig_·ge_šdex
, 
dÚÜ_·ge_šdex
;

634 
off£t_š_·ge
;

635 
unwr™‹n
, 
cur_Ën
;

637 
»t
 = 
	`g‘_ext_·th
(
Üig_šode
, 
o_¡¬t
, &
·th
);

638 ià(
»t
)

639 
out
;

640 
ex
 = 
·th
[·th->
p_d•th
].
p_ext
;

641 
Ãxt_blk
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

642 
cur_blk
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

643 
cur_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

645 ià(
cur_blk
 + 
cur_Ën
 - 1 < 
o_¡¬t
) {

646 ià(
Ãxt_blk
 =ğ
EXT_MAX_BLOCKS
) {

647 
o_¡¬t
 = 
o_’d
;

648 
»t
 = -
ENODATA
;

649 
out
;

651 
d_¡¬t
 +ğ
Ãxt_blk
 - 
o_¡¬t
;

652 
o_¡¬t
 = 
Ãxt_blk
;

655 } ià(
cur_blk
 > 
o_¡¬t
) {

657 
d_¡¬t
 +ğ
cur_blk
 - 
o_¡¬t
;

658 
o_¡¬t
 = 
cur_blk
;

660 ià(
cur_blk
 >ğ
o_’d
)

661 
out
;

663 
cur_Ën
 +ğ
cur_blk
 - 
o_¡¬t
;

665 
unwr™‹n
 = 
	`ext4_ext_is_unwr™‹n
(
ex
);

666 ià(
o_’d
 - 
o_¡¬t
 < 
cur_Ën
)

667 
cur_Ën
 = 
o_’d
 - 
o_¡¬t
;

669 
Üig_·ge_šdex
 = 
o_¡¬t
 >> (
PAGE_SHIFT
 -

670 
Üig_šode
->
i_blkb™s
);

671 
dÚÜ_·ge_šdex
 = 
d_¡¬t
 >> (
PAGE_SHIFT
 -

672 
dÚÜ_šode
->
i_blkb™s
);

673 
off£t_š_·ge
 = 
o_¡¬t
 % 
blocks_³r_·ge
;

674 ià(
cur_Ën
 > 
blocks_³r_·ge
- 
off£t_š_·ge
)

675 
cur_Ën
 = 
blocks_³r_·ge
 - 
off£t_š_·ge
;

683 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

685 
	`move_ex‹Á_³r_·ge
(
o_fp
, 
dÚÜ_šode
,

686 
Üig_·ge_šdex
, 
dÚÜ_·ge_šdex
,

687 
off£t_š_·ge
, 
cur_Ën
,

688 
unwr™‹n
, &
»t
);

689 
	`ext4_doubË_down_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

690 ià(
»t
 < 0)

692 
o_¡¬t
 +ğ
cur_Ën
;

693 
d_¡¬t
 +ğ
cur_Ën
;

695 *
moved_Ën
 = 
o_¡¬t
 - 
Üig_blk
;

696 ià(*
moved_Ën
 > 
Ën
)

697 *
moved_Ën
 = 
Ën
;

699 
out
:

700 ià(*
moved_Ën
) {

701 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
Üig_šode
);

702 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
dÚÜ_šode
);

705 
	`ext4_ext_drİ_»fs
(
·th
);

706 
	`kä“
(
·th
);

707 
	`ext4_doubË_up_wr™e_d©a_£m
(
Üig_šode
, 
dÚÜ_šode
);

708 
	`ext4_šode_»sume_uÆocked_dio
(
Üig_šode
);

709 
	`ext4_šode_»sume_uÆocked_dio
(
dÚÜ_šode
);

710 
	`uÆock_two_nÚdœeùÜ›s
(
Üig_šode
, 
dÚÜ_šode
);

712  
»t
;

713 
	}
}

730 
	$move_m‘a_ex‹Á_³r_·ge
(
hªdË_t
 *
hªdË
, 
fe
 *
o_fp
,

731 
šode
 *
dÚÜ_šode
,

732 
pgoff_t
 
»c_·ge_off£t
,

733 
pgoff_t
 
dÚÜ_·ge_off£t
,

734 
d©a_off£t_š_·ge
,

735 
block_Ën_š_·ge
, *
”r
)

737 
šode
 *
»c_šode
 = 
	`fe_šode
(
o_fp
);

738 
ext4_lblk_t
 
»c_blk_off£t
, 
dÚÜ_blk_off£t
;

739 
blocksize
 = 
»c_šode
->
i_sb
->
s_blocksize
;

740 
tmp_d©a_size
, 
d©a_size
, 
»¶aûd_size
;

741 
»¶aûd_couÁ
 = 0, 
»Ár›s
 = 0;

742 
blocks_³r_·ge
 = 
PAGE_SIZE
 >> 
»c_šode
->
i_blkb™s
;

743 
su³r_block
 *
sb
 = 
»c_šode
->
i_sb
;

750 
agaš
:

751 *
”r
 = 0;

753 
»c_blk_off£t
 = 
»c_·ge_off£t
 * 
blocks_³r_·ge
 +

754 
d©a_off£t_š_·ge
;

756 
dÚÜ_blk_off£t
 = 
dÚÜ_·ge_off£t
 * 
blocks_³r_·ge
 +

757 
d©a_off£t_š_·ge
;

760 ià((
»c_blk_off£t
 + 
block_Ën_š_·ge
 - 1) ==

761 ((
»c_šode
->
i_size
 - 1è>>„ec_šode->
i_blkb™s
)) {

763 
tmp_d©a_size
 = 
»c_šode
->
i_size
 & (
blocksize
 - 1);

769 ià(
tmp_d©a_size
 == 0)

770 
tmp_d©a_size
 = 
blocksize
;

772 
d©a_size
 = 
tmp_d©a_size
 +

773 ((
block_Ën_š_·ge
 - 1è<< 
»c_šode
->
i_blkb™s
);

775 
d©a_size
 = 
block_Ën_š_·ge
 << 
»c_šode
->
i_blkb™s
;

777 
»¶aûd_size
 = 
d©a_size
;

789 
	`ext4_doubË_down_wr™e_d©a_£m
(
»c_šode
, 
dÚÜ_šode
);

826 
»¶aûd_couÁ
 = 
	`ext4_m‘a_sw­_ex‹Ás
(
hªdË
, 
»c_šode
,

827 
dÚÜ_šode
, 
»c_blk_off£t
,

828 
dÚÜ_blk_off£t
,

829 
block_Ën_š_·ge
, 
”r
);

833 
	`ext4_doubË_up_wr™e_d©a_£m
(
»c_šode
, 
dÚÜ_šode
);

834 
uÆock_·ges
;

836 
uÆock_·ges
:

843 ià(*
”r
 =ğ-
ENOSPC
 &&

844 
	`ext4_should_»Œy_®loc
(
sb
, &
»Ár›s
))

845 
agaš
;

848 ià(*
”r
 =ğ-
EBUSY
 && 
»Ár›s
++ < 4 && 
	`EXT4_SB
(
sb
)->
s_jouº®
 &&

849 
	`jbd2_jouº®_fÜû_comm™_Ã¡ed
(
	`EXT4_SB
(
sb
)->
s_jouº®
))

850 
agaš
;

851  
»¶aûd_couÁ
;

852 
	}
}

876 
	$ext4_dyÇmic_»m­
(
fe
 *
fe1
, f*
fe2
,

877 
loff_t
 
off£t1
,†off_ˆ
off£t2
,

878 
loff_t
 
couÁ
)

880 
šode
 *
»c_šode
 = 
	`fe_šode
(
fe1
);

881 
šode
 *
dÚÜ_šode
 = 
	`fe_šode
(
fe2
);

882 
ext4_ext_·th
 *
·th
 = 
NULL
;

883 
hªdË_t
 *
hªdË
;

884 
blocks_³r_·ge
 = 
PAGE_SIZE
 >> 
»c_šode
->
i_blkb™s
;

885 
blkb™s
 = 
»c_šode
->
i_blkb™s
;

886 
ext4_lblk_t
 
o_’d
, 
o_¡¬t
 = 0;

887 
ext4_lblk_t
 
d_¡¬t
 = 0, 
d_Œunc_¡¬t
 = 0, 
d_Œunc_’d
 = 0;

888 
__u64
 
Ën
;

889 
ext4_lblk_t
 
»c_blk
, 
dÚÜ_blk
;

890 
»t
, 
jblocks
 = 0, 
üed™s
 = 0;

891 
size_»m­³d
 = 0;

898 
	`lock_two_nÚdœeùÜ›s
(
»c_šode
, 
dÚÜ_šode
);

900 
jblocks
 = 
	`ext4_wr™•age_Œªs_blocks
(
»c_šode
) * 2;

901 
üed™s
 = 
	`ext4_chunk_Œªs_blocks
(
»c_šode
, 
Ën
);

902 
jblocks
 = jblock + 
üed™s
;

903 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
»c_šode
, 
EXT4_HT_MOVE_EXTENTS
, 
jblocks
);

904 ià(
	`IS_ERR
(
hªdË
)) {

905 
»t
 = 
	`PTR_ERR
(
hªdË
);

914 
	`ext4_çÎoÿ‹_fÜ_dr
(
hªdË
, 
fe1
, 0, 
off£t1
, 
couÁ
);

919 
	`ext4_šode_block_uÆocked_dio
(
»c_šode
);

920 
	`ext4_šode_block_uÆocked_dio
(
dÚÜ_šode
);

921 
	`šode_dio_wa™
(
»c_šode
);

922 
	`šode_dio_wa™
(
dÚÜ_šode
);

925 
	`ext4_doubË_down_wr™e_d©a_£m
(
»c_šode
, 
dÚÜ_šode
);

928 
Ën
 = (
couÁ
 >> 
blkb™s
);

929 ià(
couÁ
 % 
PAGE_SIZE
 != 0)

930 
Ën
 += 1;

931 
o_¡¬t
 = 
off£t1
 >> 
blkb™s
;

932 
o_’d
 = 
o_¡¬t
 + 
Ën
;

933 
d_¡¬t
 = 
off£t2
 >> 
blkb™s
;

934 
d_Œunc_¡¬t
 = 
d_¡¬t
;

935 
d_Œunc_’d
 = 
d_¡¬t
 + 
Ën
 - 1;

936 
»c_blk
 = 
o_¡¬t
;

937 
dÚÜ_blk
 = 
d_¡¬t
;

941 
»t
 = 
	`mext_check_¬gum’ts
(
»c_šode
, 
dÚÜ_šode
, 
»c_blk
,

942 
dÚÜ_blk
, &
Ën
);

943 ià(
»t
) {

945 
out
;

949 
o_’d
 = 
o_¡¬t
 + 
Ën
;

953 
o_¡¬t
 < 
o_’d
) {

954 
ext4_ex‹Á
 *
ex
;

955 
ext4_lblk_t
 
cur_blk
, 
Ãxt_blk
;

956 
pgoff_t
 
»c_·ge_šdex
, 
dÚÜ_·ge_šdex
;

957 
off£t_š_·ge
;

958 
cur_Ën
;

960 
»t
 = 
	`g‘_ext_·th
(
»c_šode
, 
o_¡¬t
, &
·th
);

961 ià(
»t
) {

963 
out
;

965 
ex
 = 
·th
[·th->
p_d•th
].
p_ext
;

966 
Ãxt_blk
 = 
	`ext4_ext_Ãxt_®loÿ‹d_block
(
·th
);

967 
cur_blk
 = 
	`Ë32_to_ıu
(
ex
->
“_block
);

968 
cur_Ën
 = 
	`ext4_ext_g‘_aùu®_Ën
(
ex
);

970 ià(
cur_blk
 + 
cur_Ën
 - 1 < 
o_¡¬t
) {

971 ià(
Ãxt_blk
 =ğ
EXT_MAX_BLOCKS
) {

972 
o_¡¬t
 = 
o_’d
;

973 
»t
 = -
ENODATA
;

975 
out
;

977 
d_¡¬t
 +ğ
Ãxt_blk
 - 
o_¡¬t
;

978 
o_¡¬t
 = 
Ãxt_blk
;

980 } ià(
cur_blk
 > 
o_¡¬t
) {

982 
d_¡¬t
 +ğ
cur_blk
 - 
o_¡¬t
;

983 
o_¡¬t
 = 
cur_blk
;

985 ià(
cur_blk
 >ğ
o_’d
) {

987 
out
;

990 
cur_Ën
 +ğ
cur_blk
 - 
o_¡¬t
;

992 ià(
o_’d
 - 
o_¡¬t
 < 
cur_Ën
)

993 
cur_Ën
 = 
o_’d
 - 
o_¡¬t
;

994 
»c_·ge_šdex
 = 
o_¡¬t
 >> (
PAGE_SHIFT
 -

995 
»c_šode
->
i_blkb™s
);

996 
dÚÜ_·ge_šdex
 = 
d_¡¬t
 >> (
PAGE_SHIFT
 -

997 
dÚÜ_šode
->
i_blkb™s
);

998 
off£t_š_·ge
 = 
o_¡¬t
 % 
blocks_³r_·ge
;

1013 
	`ext4_doubË_up_wr™e_d©a_£m
(
»c_šode
, 
dÚÜ_šode
);

1015 
	`move_m‘a_ex‹Á_³r_·ge
(
hªdË
, 
fe1
, 
dÚÜ_šode
,

1016 
»c_·ge_šdex
, 
dÚÜ_·ge_šdex
,

1017 
off£t_š_·ge
, 
cur_Ën
,

1018 &
»t
);

1019 
	`ext4_doubË_down_wr™e_d©a_£m
(
»c_šode
, 
dÚÜ_šode
);

1023 ià(
»t
 < 0)

1025 
o_¡¬t
 +ğ
cur_Ën
;

1026 
d_¡¬t
 +ğ
cur_Ën
;

1030 
Ën
 = 
couÁ
;

1031 ià(
Ën
 % 
PAGE_SIZE
 != 0)

1032 
Ën
 =†’ - (ËÀ% 
PAGE_SIZE
);

1033 ià(
off£t2
 % 
PAGE_SIZE
 != 0)

1034 
off£t2
 = off£t2 + (
PAGE_SIZE
 - (offset2 % PAGE_SIZE));

1035 
	`ext4_çÎoÿ‹_fÜ_dr
(
hªdË
, 
fe2
, 
FALLOC_FL_PUNCH_HOLE
, 
off£t2
, 
Ën
);

1037 
size_»m­³d
 = (
o_¡¬t
 - 
»c_blk
è<< 
blkb™s
;

1038 ià(
size_»m­³d
 > 
couÁ
)

1039 
size_»m­³d
 = 
couÁ
;

1041 
out
:

1042 ià(
size_»m­³d
) {

1043 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
»c_šode
);

1044 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
dÚÜ_šode
);

1047 
	`ext4_ext_drİ_»fs
(
·th
);

1048 
	`kä“
(
·th
);

1049 
	`ext4_doubË_up_wr™e_d©a_£m
(
»c_šode
, 
dÚÜ_šode
);

1050 
	`ext4_šode_»sume_uÆocked_dio
(
»c_šode
);

1051 
	`ext4_šode_»sume_uÆocked_dio
(
dÚÜ_šode
);

1053 
	`ext4_jouº®_¡İ
(
hªdË
);

1054 
	`uÆock_two_nÚdœeùÜ›s
(
»c_šode
, 
dÚÜ_šode
);

1058  
size_»m­³d
;

1059 
	}
}

	@namei.c

27 
	~<lšux/fs.h
>

28 
	~<lšux/·gem­.h
>

29 
	~<lšux/time.h
>

30 
	~<lšux/fú.h
>

31 
	~<lšux/¡©.h
>

32 
	~<lšux/¡ršg.h
>

33 
	~<lšux/quÙaİs.h
>

34 
	~<lšux/bufãr_h—d.h
>

35 
	~<lšux/bio.h
>

36 
	~"ext4.h
"

37 
	~"ext4_jbd2.h
"

39 
	~"x©Œ.h
"

40 
	~"aş.h
"

42 
	~<Œaû/ev’ts/ext4.h
>

46 
	#NAMEI_RA_CHUNKS
 2

	)

47 
	#NAMEI_RA_BLOCKS
 4

	)

48 
	#NAMEI_RA_SIZE
 (
NAMEI_RA_CHUNKS
 * 
NAMEI_RA_BLOCKS
)

	)

50 
bufãr_h—d
 *
	$ext4_­³nd
(
hªdË_t
 *
hªdË
,

51 
šode
 *inode,

52 
ext4_lblk_t
 *
block
)

54 
bufãr_h—d
 *
bh
;

55 
”r
;

57 ià(
	`uÆik–y
(
	`EXT4_SB
(
šode
->
i_sb
)->
s_max_dœ_size_kb
 &&

58 ((
šode
->
i_size
 >> 10) >=

59 
	`EXT4_SB
(
šode
->
i_sb
)->
s_max_dœ_size_kb
)))

60  
	`ERR_PTR
(-
ENOSPC
);

62 *
block
 = 
šode
->
i_size
 >> inode->
i_sb
->
s_blocksize_b™s
;

64 
bh
 = 
	`ext4_b»ad
(
hªdË
, 
šode
, *
block
, 
EXT4_GET_BLOCKS_CREATE
);

65 ià(
	`IS_ERR
(
bh
))

66  
bh
;

67 
šode
->
i_size
 +ğšode->
i_sb
->
s_blocksize
;

68 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_size
;

69 
	`BUFFER_TRACE
(
bh
, "get_write_access");

70 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

71 ià(
”r
) {

72 
	`b»l£
(
bh
);

73 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

74  
	`ERR_PTR
(
”r
);

76  
bh
;

77 
	}
}

79 
ext4_dx_csum_v”ify
(
šode
 *inode,

80 
ext4_dœ_’Œy
 *
dœ’t
);

83 
	mEITHER
, 
	mINDEX
, 
	mDIRENT


84 } 
	tdœblock_ty³_t
;

86 
	#ext4_»ad_dœblock
(
šode
, 
block
, 
ty³
) \

87 
	`__ext4_»ad_dœblock
((
šode
), (
block
), (
ty³
), 
__func__
, 
__LINE__
)

	)

89 
bufãr_h—d
 *
	$__ext4_»ad_dœblock
(
šode
 *inode,

90 
ext4_lblk_t
 
block
,

91 
dœblock_ty³_t
 
ty³
,

92 cÚ¡ *
func
,

93 
lše
)

95 
bufãr_h—d
 *
bh
;

96 
ext4_dœ_’Œy
 *
dœ’t
;

97 
is_dx_block
 = 0;

99 
bh
 = 
	`ext4_b»ad
(
NULL
, 
šode
, 
block
, 0);

100 ià(
	`IS_ERR
(
bh
)) {

101 
	`__ext4_w¬nšg
(
šode
->
i_sb
, 
func
, 
lše
,

104 
šode
->
i_šo
, ()
block
,

105 
cu¼’t
->
comm
, 
	`PTR_ERR
(
bh
));

107  
bh
;

109 ià(!
bh
) {

110 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
,

112  
	`ERR_PTR
(-
EFSCORRUPTED
);

114 
dœ’t
 = (
ext4_dœ_’Œy
 *è
bh
->
b_d©a
;

116 ià(
	`is_dx
(
šode
)) {

117 ià(
block
 == 0)

118 
is_dx_block
 = 1;

119 ià(
	`ext4_»c_Ën_äom_disk
(
dœ’t
->
»c_Ën
,

120 
šode
->
i_sb
->
s_blocksize
) ==

121 
šode
->
i_sb
->
s_blocksize
)

122 
is_dx_block
 = 1;

124 ià(!
is_dx_block
 && 
ty³
 =ğ
INDEX
) {

125 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
,

127  
	`ERR_PTR
(-
EFSCORRUPTED
);

129 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
) ||

130 
	`bufãr_v”if›d
(
bh
))

131  
bh
;

138 ià(
is_dx_block
 && 
ty³
 =ğ
INDEX
) {

139 ià(
	`ext4_dx_csum_v”ify
(
šode
, 
dœ’t
))

140 
	`£t_bufãr_v”if›d
(
bh
);

142 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
,

144 
	`b»l£
(
bh
);

145  
	`ERR_PTR
(-
EFSBADCRC
);

148 ià(!
is_dx_block
) {

149 ià(
	`ext4_dœ’t_csum_v”ify
(
šode
, 
dœ’t
))

150 
	`£t_bufãr_v”if›d
(
bh
);

152 
	`ext4_”rÜ_šode
(
šode
, 
func
, 
lše
, 
block
,

154 
	`b»l£
(
bh
);

155  
	`ERR_PTR
(-
EFSBADCRC
);

158  
bh
;

159 
	}
}

161 #iâdeà
as£¹


162 
	#as£¹
(
‹¡
è
	`J_ASSERT
Ñe¡)

	)

165 #ifdeà
DX_DEBUG


166 
	#dxŒaû
(
commªd
è
	)
command

168 
	#dxŒaû
(
commªd
)

	)

171 
	sçke_dœ’t


173 
__Ë32
 
	mšode
;

174 
__Ë16
 
	m»c_Ën
;

175 
u8
 
	mÇme_Ën
;

176 
u8
 
	mfe_ty³
;

179 
	sdx_couÁlim™


181 
__Ë16
 
	mlim™
;

182 
__Ë16
 
	mcouÁ
;

185 
	sdx_’Œy


187 
__Ë32
 
	mhash
;

188 
__Ë32
 
	mblock
;

197 
	sdx_roÙ


199 
çke_dœ’t
 
	mdÙ
;

200 
	mdÙ_Çme
[4];

201 
çke_dœ’t
 
	mdÙdÙ
;

202 
	mdÙdÙ_Çme
[4];

203 
	sdx_roÙ_šfo


205 
__Ë32
 
	m»£rved_z”o
;

206 
u8
 
	mhash_v”siÚ
;

207 
u8
 
	mšfo_Ëngth
;

208 
u8
 
	mšdœeù_Ëv–s
;

209 
u8
 
	munu£d_æags
;

211 
	mšfo
;

212 
dx_’Œy
 
	m’Œ›s
[0];

215 
	sdx_node


217 
çke_dœ’t
 
	mçke
;

218 
dx_’Œy
 
	m’Œ›s
[0];

222 
	sdx_äame


224 
bufãr_h—d
 *
	mbh
;

225 
dx_’Œy
 *
	m’Œ›s
;

226 
dx_’Œy
 *
	m©
;

229 
	sdx_m­_’Œy


231 
u32
 
	mhash
;

232 
u16
 
	moffs
;

233 
u16
 
	msize
;

239 
	sdx_
 {

240 
u32
 
	mdt_»£rved
;

241 
__Ë32
 
	mdt_checksum
;

244 
šlše
 
ext4_lblk_t
 
dx_g‘_block
(
dx_’Œy
 *
’Œy
);

245 
dx_£t_block
(
dx_’Œy
 *
’Œy
, 
ext4_lblk_t
 
v®ue
);

246 
šlše
 
dx_g‘_hash
(
dx_’Œy
 *
’Œy
);

247 
dx_£t_hash
(
dx_’Œy
 *
’Œy
, 
v®ue
);

248 
dx_g‘_couÁ
(
dx_’Œy
 *
’Œ›s
);

249 
dx_g‘_lim™
(
dx_’Œy
 *
’Œ›s
);

250 
dx_£t_couÁ
(
dx_’Œy
 *
’Œ›s
, 
v®ue
);

251 
dx_£t_lim™
(
dx_’Œy
 *
’Œ›s
, 
v®ue
);

252 
dx_roÙ_lim™
(
šode
 *
dœ
, 
šfosize
);

253 
dx_node_lim™
(
šode
 *
dœ
);

254 
dx_äame
 *
dx_´obe
(
ext4_f’ame
 *
âame
,

255 
šode
 *
dœ
,

256 
dx_hash_šfo
 *
hšfo
,

257 
dx_äame
 *
äame
);

258 
dx_»Ëa£
(
dx_äame
 *
äames
);

259 
dx_make_m­
(
šode
 *
dœ
, 
ext4_dœ_’Œy_2
 *
de
,

260 
blocksize
, 
dx_hash_šfo
 *
hšfo
,

261 
dx_m­_’Œy
 
m­
[]);

262 
dx_sÜt_m­
(
dx_m­_’Œy
 *
m­
, 
couÁ
);

263 
ext4_dœ_’Œy_2
 *
dx_move_dœ’ts
(*
äom
, *
to
,

264 
dx_m­_’Œy
 *
off£ts
, 
couÁ
, 
blocksize
);

265 
ext4_dœ_’Œy_2
* 
dx_·ck_dœ’ts
(*
ba£
, 
blocksize
);

266 
dx_š£¹_block
(
dx_äame
 *
äame
,

267 
u32
 
hash
, 
ext4_lblk_t
 
block
);

268 
ext4_hŒ“_Ãxt_block
(
šode
 *
dœ
, 
__u32
 
hash
,

269 
dx_äame
 *
äame
,

270 
dx_äame
 *
äames
,

271 
__u32
 *
¡¬t_hash
);

272 
bufãr_h—d
 * 
ext4_dx_fšd_’Œy
(
šode
 *
dœ
,

273 
ext4_f’ame
 *
âame
,

274 
ext4_dœ_’Œy_2
 **
»s_dœ
);

275 
ext4_dx_add_’Œy
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

276 
šode
 *
dœ
, inode *inode);

279 
	$š™Ÿlize_dœ’t_
(
ext4_dœ_’Œy_
 *
t
,

280 
blocksize
)

282 
	`mem£t
(
t
, 0, (
ext4_dœ_’Œy_
));

283 
t
->
d‘_»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

284 (
ext4_dœ_’Œy_
), 
blocksize
);

285 
t
->
d‘_»£rved_á
 = 
EXT4_FT_DIR_CSUM
;

286 
	}
}

289 
ext4_dœ_’Œy_
 *
	$g‘_dœ’t_
(
šode
 *inode,

290 
ext4_dœ_’Œy
 *
de
)

292 
ext4_dœ_’Œy_
 *
t
;

294 #ifdeà
PARANOID


295 
ext4_dœ_’Œy
 *
d
, *
tİ
;

297 
d
 = 
de
;

298 
tİ
 = (
ext4_dœ_’Œy
 *)(((*)
de
) +

299 (
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
) -

300 (
ext4_dœ_’Œy_
)));

301 
d
 < 
tİ
 && d->
»c_Ën
)

302 
d
 = (
ext4_dœ_’Œy
 *)(((*)d) +

303 
	`Ë16_to_ıu
(
d
->
»c_Ën
));

305 ià(
d
 !ğ
tİ
)

306  
NULL
;

308 
t
 = (
ext4_dœ_’Œy_
 *)
d
;

310 
t
 = 
	`EXT4_DIRENT_TAIL
(
de
, 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
));

313 ià(
t
->
d‘_»£rved_z”o1
 ||

314 
	`Ë16_to_ıu
(
t
->
d‘_»c_Ën
è!ğ(
ext4_dœ_’Œy_
) ||

315 
t
->
d‘_»£rved_z”o2
 ||

316 
t
->
d‘_»£rved_á
 !ğ
EXT4_FT_DIR_CSUM
)

317  
NULL
;

319  
t
;

320 
	}
}

322 
__Ë32
 
	$ext4_dœ’t_csum
(
šode
 *inode,

323 
ext4_dœ_’Œy
 *
dœ’t
, 
size
)

325 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

326 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

327 
__u32
 
csum
;

329 
csum
 = 
	`ext4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dœ’t
, 
size
);

330  
	`ıu_to_Ë32
(
csum
);

331 
	}
}

333 
	#w¬n_no_¥aû_fÜ_csum
(
šode
) \

334 
	`__w¬n_no_¥aû_fÜ_csum
((
šode
), 
__func__
, 
__LINE__
)

	)

336 
	$__w¬n_no_¥aû_fÜ_csum
(
šode
 *šode, cÚ¡ *
func
,

337 
lše
)

339 
	`__ext4_w¬nšg_šode
(
šode
, 
func
, 
lše
,

341 
	}
}

343 
	$ext4_dœ’t_csum_v”ify
(
šode
 *šode, 
ext4_dœ_’Œy
 *
dœ’t
)

345 
ext4_dœ_’Œy_
 *
t
;

347 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

350 
t
 = 
	`g‘_dœ’t_
(
šode
, 
dœ’t
);

351 ià(!
t
) {

352 
	`w¬n_no_¥aû_fÜ_csum
(
šode
);

356 ià(
t
->
d‘_checksum
 !ğ
	`ext4_dœ’t_csum
(
šode
, 
dœ’t
,

357 (*)
t
 - (*)
dœ’t
))

361 
	}
}

363 
	$ext4_dœ’t_csum_£t
(
šode
 *inode,

364 
ext4_dœ_’Œy
 *
dœ’t
)

366 
ext4_dœ_’Œy_
 *
t
;

368 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

371 
t
 = 
	`g‘_dœ’t_
(
šode
, 
dœ’t
);

372 ià(!
t
) {

373 
	`w¬n_no_¥aû_fÜ_csum
(
šode
);

377 
t
->
d‘_checksum
 = 
	`ext4_dœ’t_csum
(
šode
, 
dœ’t
,

378 (*)
t
 - (*)
dœ’t
);

379 
	}
}

381 
	$ext4_hªdË_dœty_dœ’t_node
(
hªdË_t
 *
hªdË
,

382 
šode
 *inode,

383 
bufãr_h—d
 *
bh
)

385 
	`ext4_dœ’t_csum_£t
(
šode
, (
ext4_dœ_’Œy
 *)
bh
->
b_d©a
);

386  
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

387 
	}
}

389 
dx_couÁlim™
 *
	$g‘_dx_couÁlim™
(
šode
 *inode,

390 
ext4_dœ_’Œy
 *
dœ’t
,

391 *
off£t
)

393 
ext4_dœ_’Œy
 *
dp
;

394 
dx_roÙ_šfo
 *
roÙ
;

395 
couÁ_off£t
;

397 ià(
	`Ë16_to_ıu
(
dœ’t
->
»c_Ën
è=ğ
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
))

398 
couÁ_off£t
 = 8;

399 ià(
	`Ë16_to_ıu
(
dœ’t
->
»c_Ën
) == 12) {

400 
dp
 = (
ext4_dœ_’Œy
 *)(((*)
dœ’t
) + 12);

401 ià(
	`Ë16_to_ıu
(
dp
->
»c_Ën
) !=

402 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
) - 12)

403  
NULL
;

404 
roÙ
 = (
dx_roÙ_šfo
 *)(((*)
dp
 + 12));

405 ià(
roÙ
->
»£rved_z”o
 ||

406 
roÙ
->
šfo_Ëngth
 !ğ(
dx_roÙ_šfo
))

407  
NULL
;

408 
couÁ_off£t
 = 32;

410  
NULL
;

412 ià(
off£t
)

413 *
off£t
 = 
couÁ_off£t
;

414  (
dx_couÁlim™
 *)(((*)
dœ’t
è+ 
couÁ_off£t
);

415 
	}
}

417 
__Ë32
 
	$ext4_dx_csum
(
šode
 *šode, 
ext4_dœ_’Œy
 *
dœ’t
,

418 
couÁ_off£t
, 
couÁ
, 
dx_
 *
t
)

420 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

421 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

422 
__u32
 
csum
;

423 
size
;

424 
__u32
 
dummy_csum
 = 0;

425 
off£t
 = 
	`off£tof
(
dx_
, 
dt_checksum
);

427 
size
 = 
couÁ_off£t
 + (
couÁ
 * (
dx_’Œy
));

428 
csum
 = 
	`ext4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dœ’t
, 
size
);

429 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
t
, 
off£t
);

430 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

432  
	`ıu_to_Ë32
(
csum
);

433 
	}
}

435 
	$ext4_dx_csum_v”ify
(
šode
 *inode,

436 
ext4_dœ_’Œy
 *
dœ’t
)

438 
dx_couÁlim™
 *
c
;

439 
dx_
 *
t
;

440 
couÁ_off£t
, 
lim™
, 
couÁ
;

442 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

445 
c
 = 
	`g‘_dx_couÁlim™
(
šode
, 
dœ’t
, &
couÁ_off£t
);

446 ià(!
c
) {

447 
	`EXT4_ERROR_INODE
(
šode
, "dir seems corrupt? Runƒ2fsck -D.");

450 
lim™
 = 
	`Ë16_to_ıu
(
c
->limit);

451 
couÁ
 = 
	`Ë16_to_ıu
(
c
->count);

452 ià(
couÁ_off£t
 + (
lim™
 * (
dx_’Œy
)) >

453 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
è- (
dx_
)) {

454 
	`w¬n_no_¥aû_fÜ_csum
(
šode
);

457 
t
 = (
dx_
 *)(((
dx_’Œy
 *)
c
è+ 
lim™
);

459 ià(
t
->
dt_checksum
 !ğ
	`ext4_dx_csum
(
šode
, 
dœ’t
, 
couÁ_off£t
,

460 
couÁ
, 
t
))

463 
	}
}

465 
	$ext4_dx_csum_£t
(
šode
 *šode, 
ext4_dœ_’Œy
 *
dœ’t
)

467 
dx_couÁlim™
 *
c
;

468 
dx_
 *
t
;

469 
couÁ_off£t
, 
lim™
, 
couÁ
;

471 ià(!
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

474 
c
 = 
	`g‘_dx_couÁlim™
(
šode
, 
dœ’t
, &
couÁ_off£t
);

475 ià(!
c
) {

476 
	`EXT4_ERROR_INODE
(
šode
, "dir seems corrupt? Runƒ2fsck -D.");

479 
lim™
 = 
	`Ë16_to_ıu
(
c
->limit);

480 
couÁ
 = 
	`Ë16_to_ıu
(
c
->count);

481 ià(
couÁ_off£t
 + (
lim™
 * (
dx_’Œy
)) >

482 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
è- (
dx_
)) {

483 
	`w¬n_no_¥aû_fÜ_csum
(
šode
);

486 
t
 = (
dx_
 *)(((
dx_’Œy
 *)
c
è+ 
lim™
);

488 
t
->
dt_checksum
 = 
	`ext4_dx_csum
(
šode
, 
dœ’t
, 
couÁ_off£t
, 
couÁ
,);

489 
	}
}

491 
šlše
 
	$ext4_hªdË_dœty_dx_node
(
hªdË_t
 *
hªdË
,

492 
šode
 *inode,

493 
bufãr_h—d
 *
bh
)

495 
	`ext4_dx_csum_£t
(
šode
, (
ext4_dœ_’Œy
 *)
bh
->
b_d©a
);

496  
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

497 
	}
}

502 
šlše
 
ext4_dœ_’Œy_2
 *

503 
	$ext4_Ãxt_’Œy
(
ext4_dœ_’Œy_2
 *
p
, 
blocksize
)

505  (
ext4_dœ_’Œy_2
 *)((*)
p
 +

506 
	`ext4_»c_Ën_äom_disk
(
p
->
»c_Ën
, 
blocksize
));

507 
	}
}

514 
šlše
 
ext4_lblk_t
 
	$dx_g‘_block
(
dx_’Œy
 *
’Œy
)

516  
	`Ë32_to_ıu
(
’Œy
->
block
) & 0x0fffffff;

517 
	}
}

519 
šlše
 
	$dx_£t_block
(
dx_’Œy
 *
’Œy
, 
ext4_lblk_t
 
v®ue
)

521 
’Œy
->
block
 = 
	`ıu_to_Ë32
(
v®ue
);

522 
	}
}

524 
šlše
 
	$dx_g‘_hash
(
dx_’Œy
 *
’Œy
)

526  
	`Ë32_to_ıu
(
’Œy
->
hash
);

527 
	}
}

529 
šlše
 
	$dx_£t_hash
(
dx_’Œy
 *
’Œy
, 
v®ue
)

531 
’Œy
->
hash
 = 
	`ıu_to_Ë32
(
v®ue
);

532 
	}
}

534 
šlše
 
	$dx_g‘_couÁ
(
dx_’Œy
 *
’Œ›s
)

536  
	`Ë16_to_ıu
(((
dx_couÁlim™
 *è
’Œ›s
)->
couÁ
);

537 
	}
}

539 
šlše
 
	$dx_g‘_lim™
(
dx_’Œy
 *
’Œ›s
)

541  
	`Ë16_to_ıu
(((
dx_couÁlim™
 *è
’Œ›s
)->
lim™
);

542 
	}
}

544 
šlše
 
	$dx_£t_couÁ
(
dx_’Œy
 *
’Œ›s
, 
v®ue
)

546 ((
dx_couÁlim™
 *è
’Œ›s
)->
couÁ
 = 
	`ıu_to_Ë16
(
v®ue
);

547 
	}
}

549 
šlše
 
	$dx_£t_lim™
(
dx_’Œy
 *
’Œ›s
, 
v®ue
)

551 ((
dx_couÁlim™
 *è
’Œ›s
)->
lim™
 = 
	`ıu_to_Ë16
(
v®ue
);

552 
	}
}

554 
šlše
 
	$dx_roÙ_lim™
(
šode
 *
dœ
, 
šfosize
)

556 
’Œy_¥aû
 = 
dœ
->
i_sb
->
s_blocksize
 - 
	`EXT4_DIR_REC_LEN
(1) -

557 
	`EXT4_DIR_REC_LEN
(2è- 
šfosize
;

559 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

560 
’Œy_¥aû
 -ğ(
dx_
);

561  
’Œy_¥aû
 / (
dx_’Œy
);

562 
	}
}

564 
šlše
 
	$dx_node_lim™
(
šode
 *
dœ
)

566 
’Œy_¥aû
 = 
dœ
->
i_sb
->
s_blocksize
 - 
	`EXT4_DIR_REC_LEN
(0);

568 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

569 
’Œy_¥aû
 -ğ(
dx_
);

570  
’Œy_¥aû
 / (
dx_’Œy
);

571 
	}
}

576 #ifdeà
DX_DEBUG


577 
	$dx_show_šdex
(* 
Ïb–
, 
dx_’Œy
 *
’Œ›s
)

579 
i
, 
n
 = 
	`dx_g‘_couÁ
 (
’Œ›s
);

580 
	`´štk
(
KERN_DEBUG
 "% šdex", 
Ïb–
);

581 
i
 = 0; i < 
n
; i++) {

582 
	`´štk
(
KERN_CONT
 " %x->%lu",

583 
i
 ? 
	`dx_g‘_hash
(
’Œ›s
 + i) : 0,

584 ()
	`dx_g‘_block
(
’Œ›s
 + 
i
));

586 
	`´štk
(
KERN_CONT
 "\n");

587 
	}
}

589 
	s¡©s


591 
	mÇmes
;

592 
	m¥aû
;

593 
	mbcouÁ
;

596 
¡©s
 
	$dx_show_Ëaf
(
šode
 *
dœ
,

597 
dx_hash_šfo
 *
hšfo
,

598 
ext4_dœ_’Œy_2
 *
de
,

599 
size
, 
show_Çmes
)

601 
Çmes
 = 0, 
¥aû
 = 0;

602 *
ba£
 = (*è
de
;

603 
dx_hash_šfo
 
h
 = *
hšfo
;

605 
	`´štk
("names: ");

606 (*è
de
 < 
ba£
 + 
size
)

608 ià(
de
->
šode
)

610 ià(
show_Çmes
)

612 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


613 
Ën
;

614 *
Çme
;

615 
fsüy±_¡r
 
âame_üy±o_¡r
 =

616 
	`FSTR_INIT
(
NULL
, 0);

617 
»s
 = 0;

619 
Çme
 = 
de
->name;

620 
Ën
 = 
de
->
Çme_Ën
;

621 ià(
	`ext4_’üy±ed_šode
(
dœ
))

622 
»s
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

623 ià(
»s
) {

624 
	`´štk
(
KERN_WARNING
 "Error setting up"

625 " fÇmüy±o: %d\n", 
»s
);

627 ià(!
	`fsüy±_has_’üy±iÚ_key
(
dœ
)) {

629 
	`ext4fs_dœhash
(
de
->
Çme
,

630 
de
->
Çme_Ën
, &
h
);

631 
	`´štk
("%*.s:(U)%x.%u ", 
Ën
,

632 
Çme
, 
h
.
hash
,

633 (è((*è
de


634 - 
ba£
));

636 
fsüy±_¡r
 
de_Çme
 =

637 
	`FSTR_INIT
(
Çme
, 
Ën
);

640 
»s
 = 
	`fsüy±_âame_®loc_bufãr
(

641 
dœ
, 
Ën
,

642 &
âame_üy±o_¡r
);

643 ià(
»s
)

644 
	`´štk
(
KERN_WARNING
 "Error "

648 
»s
 = 
	`fsüy±_âame_disk_to_u¤
(
dœ
,

649 0, 0, &
de_Çme
,

650 &
âame_üy±o_¡r
);

651 ià(
»s
) {

652 
	`´štk
(
KERN_WARNING
 "Error "

656 
Çme
 = "??";

657 
Ën
 = 2;

659 
Çme
 = 
âame_üy±o_¡r
.name;

660 
Ën
 = 
âame_üy±o_¡r
.len;

662 
	`ext4fs_dœhash
(
de
->
Çme
, de->
Çme_Ën
,

663 &
h
);

664 
	`´štk
("%*.s:(E)%x.%u ", 
Ën
, 
Çme
,

665 
h
.
hash
, (è((*è
de


666 - 
ba£
));

667 
	`fsüy±_âame_ä“_bufãr
(

668 &
âame_üy±o_¡r
);

671 
Ën
 = 
de
->
Çme_Ën
;

672 *
Çme
 = 
de
->name;

673 
	`ext4fs_dœhash
(
de
->
Çme
, de->
Çme_Ën
, &
h
);

674 
	`´štk
("%*.s:%x.%u ", 
Ën
, 
Çme
, 
h
.
hash
,

675 (è((*è
de
 - 
ba£
));

678 
¥aû
 +ğ
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

679 
Çmes
++;

681 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
size
);

683 
	`´štk
(
KERN_CONT
 "(%i)\n", 
Çmes
);

684  (
¡©s
è{ 
Çmes
, 
¥aû
, 1 };

685 
	}
}

687 
¡©s
 
	$dx_show_’Œ›s
(
dx_hash_šfo
 *
hšfo
, 
šode
 *
dœ
,

688 
dx_’Œy
 *
’Œ›s
, 
Ëv–s
)

690 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

691 
couÁ
 = 
	`dx_g‘_couÁ
(
’Œ›s
), 
Çmes
 = 0, 
¥aû
 = 0, 
i
;

692 
bcouÁ
 = 0;

693 
bufãr_h—d
 *
bh
;

694 
	`´štk
("%˜šdexed blocks...\n", 
couÁ
);

695 
i
 = 0; i < 
couÁ
; i++, 
’Œ›s
++)

697 
ext4_lblk_t
 
block
 = 
	`dx_g‘_block
(
’Œ›s
);

698 
ext4_lblk_t
 
hash
 = 
i
 ? 
	`dx_g‘_hash
(
’Œ›s
): 0;

699 
u32
 
¿nge
 = 
i
 < 
couÁ
 - 1? (
	`dx_g‘_hash
(
’Œ›s
 + 1è- 
hash
): ~hash;

700 
¡©s
 stats;

701 
	`´štk
("%s%3u:%03u hash %8x/%8x ",
Ëv–s
?"":" ", 
i
, 
block
, 
hash
, 
¿nge
);

702 
bh
 = 
	`ext4_b»ad
(
NULL
,
dœ
, 
block
, 0);

703 ià(!
bh
 || 
	`IS_ERR
(bh))

705 
¡©s
 = 
Ëv–s
?

706 
	`dx_show_’Œ›s
(
hšfo
, 
dœ
, ((
dx_node
 *è
bh
->
b_d©a
)->
’Œ›s
, 
Ëv–s
 - 1):

707 
	`dx_show_Ëaf
(
dœ
, 
hšfo
, (
ext4_dœ_’Œy_2
 *)

708 
bh
->
b_d©a
, 
blocksize
, 0);

709 
Çmes
 +ğ
¡©s
.names;

710 
¥aû
 +ğ
¡©s
.space;

711 
bcouÁ
 +ğ
¡©s
.bcount;

712 
	`b»l£
(
bh
);

714 ià(
bcouÁ
)

715 
	`´štk
(
KERN_DEBUG
 "%snames %u, fullness %u (%u%%)\n",

716 
Ëv–s
 ? "" : " ", 
Çmes
, 
¥aû
/
bcouÁ
,

717 (
¥aû
/
bcouÁ
)*100/
blocksize
);

718  (
¡©s
è{ 
Çmes
, 
¥aû
, 
bcouÁ
};

719 
	}
}

731 
dx_äame
 *

732 
	$dx_´obe
(
ext4_f’ame
 *
âame
, 
šode
 *
dœ
,

733 
dx_hash_šfo
 *
hšfo
, 
dx_äame
 *
äame_š
)

735 
couÁ
, 
šdœeù
;

736 
dx_’Œy
 *
©
, *
’Œ›s
, *
p
, *
q
, *
m
;

737 
dx_roÙ
 *
roÙ
;

738 
dx_äame
 *
äame
 = 
äame_š
;

739 
dx_äame
 *
»t_”r
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

740 
u32
 
hash
;

742 
	`mem£t
(
äame_š
, 0, 
EXT4_HTREE_LEVEL
 * (frame_in[0]));

743 
äame
->
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 0, 
INDEX
);

744 ià(
	`IS_ERR
(
äame
->
bh
))

745  (
dx_äame
 *è
äame
->
bh
;

747 
roÙ
 = (
dx_roÙ
 *è
äame
->
bh
->
b_d©a
;

748 ià(
roÙ
->
šfo
.
hash_v”siÚ
 !ğ
DX_HASH_TEA
 &&

749 
roÙ
->
šfo
.
hash_v”siÚ
 !ğ
DX_HASH_HALF_MD4
 &&

750 
roÙ
->
šfo
.
hash_v”siÚ
 !ğ
DX_HASH_LEGACY
) {

751 
	`ext4_w¬nšg_šode
(
dœ
, "Unrecognised inode hash code %u",

752 
roÙ
->
šfo
.
hash_v”siÚ
);

753 
ç
;

755 ià(
âame
)

756 
hšfo
 = &
âame
->hinfo;

757 
hšfo
->
hash_v”siÚ
 = 
roÙ
->
šfo
.hash_version;

758 ià(
hšfo
->
hash_v”siÚ
 <ğ
DX_HASH_TEA
)

759 
hšfo
->
hash_v”siÚ
 +ğ
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_unsigÃd
;

760 
hšfo
->
£ed
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_£ed
;

761 ià(
âame
 && 
	`âame_Çme
(fname))

762 
	`ext4fs_dœhash
(
	`âame_Çme
(
âame
), 
	`âame_Ën
(âame), 
hšfo
);

763 
hash
 = 
hšfo
->hash;

765 ià(
roÙ
->
šfo
.
unu£d_æags
 & 1) {

766 
	`ext4_w¬nšg_šode
(
dœ
, "Unimplemented hash flags: %#06x",

767 
roÙ
->
šfo
.
unu£d_æags
);

768 
ç
;

771 
šdœeù
 = 
roÙ
->
šfo
.
šdœeù_Ëv–s
;

772 ià(
šdœeù
 >ğ
	`ext4_dœ_hŒ“_Ëv–
(
dœ
->
i_sb
)) {

773 
	`ext4_w¬nšg
(
dœ
->
i_sb
,

775 "suµÜ‹d v®ue", 
dœ
->
i_šo
,

776 
	`ext4_dœ_hŒ“_Ëv–
(
dœ
->
i_sb
));

777 ià(
	`ext4_dœ_hŒ“_Ëv–
(
dœ
->
i_sb
è< 
EXT4_HTREE_LEVEL
) {

778 
	`ext4_w¬nšg
(
dœ
->
i_sb
, "Enable†arge directory "

781 
ç
;

784 
’Œ›s
 = (
dx_’Œy
 *)(((*)&
roÙ
->
šfo
) +

785 
roÙ
->
šfo
.
šfo_Ëngth
);

787 ià(
	`dx_g‘_lim™
(
’Œ›s
è!ğ
	`dx_roÙ_lim™
(
dœ
,

788 
roÙ
->
šfo
.
šfo_Ëngth
)) {

789 
	`ext4_w¬nšg_šode
(
dœ
, "dxƒntry:†imit %u !=„oot†imit %u",

790 
	`dx_g‘_lim™
(
’Œ›s
),

791 
	`dx_roÙ_lim™
(
dœ
, 
roÙ
->
šfo
.
šfo_Ëngth
));

792 
ç
;

795 
	`dxŒaû
(
	`´štk
("Look u°%x", 
hash
));

797 
couÁ
 = 
	`dx_g‘_couÁ
(
’Œ›s
);

798 ià(!
couÁ
 || couÁ > 
	`dx_g‘_lim™
(
’Œ›s
)) {

799 
	`ext4_w¬nšg_šode
(
dœ
,

801 
couÁ
, 
	`dx_g‘_lim™
(
’Œ›s
));

802 
ç
;

805 
p
 = 
’Œ›s
 + 1;

806 
q
 = 
’Œ›s
 + 
couÁ
 - 1;

807 
p
 <ğ
q
) {

808 
m
 = 
p
 + (
q
 -…) / 2;

809 
	`dxŒaû
(
	`´štk
(
KERN_CONT
 "."));

810 ià(
	`dx_g‘_hash
(
m
è> 
hash
)

811 
q
 = 
m
 - 1;

813 
p
 = 
m
 + 1;

817 
n
 = 
couÁ
 - 1;

818 
©
 = 
’Œ›s
;

819 
n
--)

821 
	`dxŒaû
(
	`´štk
(
KERN_CONT
 ","));

822 ià(
	`dx_g‘_hash
(++
©
è> 
hash
)

824 
©
--;

828 
	`as£¹
 (
©
 =ğ
p
 - 1);

831 
©
 = 
p
 - 1;

832 
	`dxŒaû
(
	`´štk
(
KERN_CONT
 " %x->%u\n",

833 
©
 =ğ
’Œ›s
 ? 0 : 
	`dx_g‘_hash
(at),

834 
	`dx_g‘_block
(
©
)));

835 
äame
->
’Œ›s
 =ƒntries;

836 
äame
->
©
 =‡t;

837 ià(!
šdœeù
--)

838  
äame
;

839 
äame
++;

840 
äame
->
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
	`dx_g‘_block
(
©
), 
INDEX
);

841 ià(
	`IS_ERR
(
äame
->
bh
)) {

842 
»t_”r
 = (
dx_äame
 *è
äame
->
bh
;

843 
äame
->
bh
 = 
NULL
;

844 
ç
;

846 
’Œ›s
 = ((
dx_node
 *è
äame
->
bh
->
b_d©a
)->entries;

848 ià(
	`dx_g‘_lim™
(
’Œ›s
è!ğ
	`dx_node_lim™
(
dœ
)) {

849 
	`ext4_w¬nšg_šode
(
dœ
,

851 
	`dx_g‘_lim™
(
’Œ›s
), 
	`dx_node_lim™
(
dœ
));

852 
ç
;

855 
ç
:

856 
äame
 >ğ
äame_š
) {

857 
	`b»l£
(
äame
->
bh
);

858 
äame
--;

861 ià(
»t_”r
 =ğ
	`ERR_PTR
(
ERR_BAD_DX_DIR
))

862 
	`ext4_w¬nšg_šode
(
dœ
,

864  
»t_”r
;

865 
	}
}

867 
	$dx_»Ëa£
(
dx_äame
 *
äames
)

869 
dx_roÙ_šfo
 *
šfo
;

870 
i
;

872 ià(
äames
[0].
bh
 =ğ
NULL
)

875 
šfo
 = &((
dx_roÙ
 *)
äames
[0].
bh
->
b_d©a
)->info;

876 
i
 = 0; i <ğ
šfo
->
šdœeù_Ëv–s
; i++) {

877 ià(
äames
[
i
].
bh
 =ğ
NULL
)

879 
	`b»l£
(
äames
[
i
].
bh
);

880 
äames
[
i
].
bh
 = 
NULL
;

882 
	}
}

901 
	$ext4_hŒ“_Ãxt_block
(
šode
 *
dœ
, 
__u32
 
hash
,

902 
dx_äame
 *
äame
,

903 
dx_äame
 *
äames
,

904 
__u32
 *
¡¬t_hash
)

906 
dx_äame
 *
p
;

907 
bufãr_h—d
 *
bh
;

908 
num_äames
 = 0;

909 
__u32
 
bhash
;

911 
p
 = 
äame
;

920 ià(++(
p
->
©
è<…->
’Œ›s
 + 
	`dx_g‘_couÁ
(p->entries))

922 ià(
p
 =ğ
äames
)

924 
num_äames
++;

925 
p
--;

935 
bhash
 = 
	`dx_g‘_hash
(
p
->
©
);

936 ià(
¡¬t_hash
)

937 *
¡¬t_hash
 = 
bhash
;

938 ià((
hash
 & 1) == 0) {

939 ià((
bhash
 & ~1è!ğ
hash
)

946 
num_äames
--) {

947 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
	`dx_g‘_block
(
p
->
©
), 
INDEX
);

948 ià(
	`IS_ERR
(
bh
))

949  
	`PTR_ERR
(
bh
);

950 
p
++;

951 
	`b»l£
(
p
->
bh
);

952 
p
->
bh
 = bh;

953 
p
->
©
 =…->
’Œ›s
 = ((
dx_node
 *è
bh
->
b_d©a
)->entries;

956 
	}
}

964 
	$hŒ“_dœblock_to_Œ“
(
fe
 *
dœ_fe
,

965 
šode
 *
dœ
, 
ext4_lblk_t
 
block
,

966 
dx_hash_šfo
 *
hšfo
,

967 
__u32
 
¡¬t_hash
, __u32 
¡¬t_mšÜ_hash
)

969 
bufãr_h—d
 *
bh
;

970 
ext4_dœ_’Œy_2
 *
de
, *
tİ
;

971 
”r
 = 0, 
couÁ
 = 0;

972 
fsüy±_¡r
 
âame_üy±o_¡r
 = 
	`FSTR_INIT
(
NULL
, 0), 
tmp_¡r
;

974 
	`dxŒaû
(
	`´štk
(
KERN_INFO
 "In htree dirblock_to_tree: block %lu\n",

975 ()
block
));

976 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
block
, 
DIRENT
);

977 ià(
	`IS_ERR
(
bh
))

978  
	`PTR_ERR
(
bh
);

980 
de
 = (
ext4_dœ_’Œy_2
 *è
bh
->
b_d©a
;

981 
tİ
 = (
ext4_dœ_’Œy_2
 *è((*è
de
 +

982 
dœ
->
i_sb
->
s_blocksize
 -

983 
	`EXT4_DIR_REC_LEN
(0));

984 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


986 ià(
	`ext4_’üy±ed_šode
(
dœ
)) {

987 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

988 ià(
”r
 < 0) {

989 
	`b»l£
(
bh
);

990  
”r
;

992 
”r
 = 
	`fsüy±_âame_®loc_bufãr
(
dœ
, 
EXT4_NAME_LEN
,

993 &
âame_üy±o_¡r
);

994 ià(
”r
 < 0) {

995 
	`b»l£
(
bh
);

996  
”r
;

1000 ; 
de
 < 
tİ
; dğ
	`ext4_Ãxt_’Œy
(de, 
dœ
->
i_sb
->
s_blocksize
)) {

1001 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

1002 
bh
->
b_d©a
, bh->
b_size
,

1003 (
block
<<
	`EXT4_BLOCK_SIZE_BITS
(
dœ
->
i_sb
))

1004 + ((*)
de
 - 
bh
->
b_d©a
))) {

1008 
	`ext4fs_dœhash
(
de
->
Çme
, de->
Çme_Ën
, 
hšfo
);

1009 ià((
hšfo
->
hash
 < 
¡¬t_hash
) ||

1010 ((
hšfo
->
hash
 =ğ
¡¬t_hash
) &&

1011 (
hšfo
->
mšÜ_hash
 < 
¡¬t_mšÜ_hash
)))

1013 ià(
de
->
šode
 == 0)

1015 ià(!
	`ext4_’üy±ed_šode
(
dœ
)) {

1016 
tmp_¡r
.
Çme
 = 
de
->name;

1017 
tmp_¡r
.
Ën
 = 
de
->
Çme_Ën
;

1018 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
,

1019 
hšfo
->
hash
, hšfo->
mšÜ_hash
, 
de
,

1020 &
tmp_¡r
);

1022 
§ve_Ën
 = 
âame_üy±o_¡r
.
Ën
;

1023 
fsüy±_¡r
 
de_Çme
 = 
	`FSTR_INIT
(
de
->
Çme
,

1024 
de
->
Çme_Ën
);

1027 
”r
 = 
	`fsüy±_âame_disk_to_u¤
(
dœ
, 
hšfo
->
hash
,

1028 
hšfo
->
mšÜ_hash
, &
de_Çme
,

1029 &
âame_üy±o_¡r
);

1030 ià(
”r
) {

1031 
couÁ
 = 
”r
;

1032 
”rout
;

1034 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
,

1035 
hšfo
->
hash
, hšfo->
mšÜ_hash
, 
de
,

1036 &
âame_üy±o_¡r
);

1037 
âame_üy±o_¡r
.
Ën
 = 
§ve_Ën
;

1039 ià(
”r
 != 0) {

1040 
couÁ
 = 
”r
;

1041 
”rout
;

1043 
couÁ
++;

1045 
”rout
:

1046 
	`b»l£
(
bh
);

1047 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


1048 
	`fsüy±_âame_ä“_bufãr
(&
âame_üy±o_¡r
);

1050  
couÁ
;

1051 
	}
}

1062 
	$ext4_hŒ“_fl_Œ“
(
fe
 *
dœ_fe
, 
__u32
 
¡¬t_hash
,

1063 
__u32
 
¡¬t_mšÜ_hash
, __u32 *
Ãxt_hash
)

1065 
dx_hash_šfo
 
hšfo
;

1066 
ext4_dœ_’Œy_2
 *
de
;

1067 
dx_äame
 
äames
[
EXT4_HTREE_LEVEL
], *
äame
;

1068 
šode
 *
dœ
;

1069 
ext4_lblk_t
 
block
;

1070 
couÁ
 = 0;

1071 
»t
, 
”r
;

1072 
__u32
 
hashv®
;

1073 
fsüy±_¡r
 
tmp_¡r
;

1075 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "In htree_fill_tree, start hash: %x:%x\n",

1076 
¡¬t_hash
, 
¡¬t_mšÜ_hash
));

1077 
dœ
 = 
	`fe_šode
(
dœ_fe
);

1078 ià(!(
	`ext4_‹¡_šode_æag
(
dœ
, 
EXT4_INODE_INDEX
))) {

1079 
hšfo
.
hash_v”siÚ
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_def_hash_v”siÚ
;

1080 ià(
hšfo
.
hash_v”siÚ
 <ğ
DX_HASH_TEA
)

1081 
hšfo
.
hash_v”siÚ
 +=

1082 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_unsigÃd
;

1083 
hšfo
.
£ed
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_£ed
;

1084 ià(
	`ext4_has_šlše_d©a
(
dœ
)) {

1085 
has_šlše_d©a
 = 1;

1086 
couÁ
 = 
	`hŒ“_šlšedœ_to_Œ“
(
dœ_fe
, 
dœ
, 0,

1087 &
hšfo
, 
¡¬t_hash
,

1088 
¡¬t_mšÜ_hash
,

1089 &
has_šlše_d©a
);

1090 ià(
has_šlše_d©a
) {

1091 *
Ãxt_hash
 = ~0;

1092  
couÁ
;

1095 
couÁ
 = 
	`hŒ“_dœblock_to_Œ“
(
dœ_fe
, 
dœ
, 0, &
hšfo
,

1096 
¡¬t_hash
, 
¡¬t_mšÜ_hash
);

1097 *
Ãxt_hash
 = ~0;

1098  
couÁ
;

1100 
hšfo
.
hash
 = 
¡¬t_hash
;

1101 
hšfo
.
mšÜ_hash
 = 0;

1102 
äame
 = 
	`dx_´obe
(
NULL
, 
dœ
, &
hšfo
, 
äames
);

1103 ià(
	`IS_ERR
(
äame
))

1104  
	`PTR_ERR
(
äame
);

1107 ià(!
¡¬t_hash
 && !
¡¬t_mšÜ_hash
) {

1108 
de
 = (
ext4_dœ_’Œy_2
 *è
äames
[0].
bh
->
b_d©a
;

1109 
tmp_¡r
.
Çme
 = 
de
->name;

1110 
tmp_¡r
.
Ën
 = 
de
->
Çme_Ën
;

1111 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
, 0, 0,

1112 
de
, &
tmp_¡r
);

1113 ià(
”r
 != 0)

1114 
”rout
;

1115 
couÁ
++;

1117 ià(
¡¬t_hash
 < 2 || (¡¬t_hash ==2 && 
¡¬t_mšÜ_hash
==0)) {

1118 
de
 = (
ext4_dœ_’Œy_2
 *è
äames
[0].
bh
->
b_d©a
;

1119 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
dœ
->
i_sb
->
s_blocksize
);

1120 
tmp_¡r
.
Çme
 = 
de
->name;

1121 
tmp_¡r
.
Ën
 = 
de
->
Çme_Ën
;

1122 
”r
 = 
	`ext4_hŒ“_¡Üe_dœ’t
(
dœ_fe
, 2, 0,

1123 
de
, &
tmp_¡r
);

1124 ià(
”r
 != 0)

1125 
”rout
;

1126 
couÁ
++;

1130 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

1131 
”r
 = -
ERESTARTSYS
;

1132 
”rout
;

1134 
	`cÚd_»sched
();

1135 
block
 = 
	`dx_g‘_block
(
äame
->
©
);

1136 
»t
 = 
	`hŒ“_dœblock_to_Œ“
(
dœ_fe
, 
dœ
, 
block
, &
hšfo
,

1137 
¡¬t_hash
, 
¡¬t_mšÜ_hash
);

1138 ià(
»t
 < 0) {

1139 
”r
 = 
»t
;

1140 
”rout
;

1142 
couÁ
 +ğ
»t
;

1143 
hashv®
 = ~0;

1144 
»t
 = 
	`ext4_hŒ“_Ãxt_block
(
dœ
, 
HASH_NB_ALWAYS
,

1145 
äame
, 
äames
, &
hashv®
);

1146 *
Ãxt_hash
 = 
hashv®
;

1147 ià(
»t
 < 0) {

1148 
”r
 = 
»t
;

1149 
”rout
;

1156 ià((
»t
 == 0) ||

1157 (
couÁ
 && ((
hashv®
 & 1) == 0)))

1160 
	`dx_»Ëa£
(
äames
);

1161 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "Fillree:„eturned %dƒntries, "

1162 "Ãxˆhash: %x\n", 
couÁ
, *
Ãxt_hash
));

1163  
couÁ
;

1164 
”rout
:

1165 
	`dx_»Ëa£
(
äames
);

1166  (
”r
);

1167 
	}
}

1169 
šlše
 
	$£¬ch_dœblock
(
bufãr_h—d
 *
bh
,

1170 
šode
 *
dœ
,

1171 
ext4_f’ame
 *
âame
,

1172 
off£t
,

1173 
ext4_dœ_’Œy_2
 **
»s_dœ
)

1175  
	`ext4_£¬ch_dœ
(
bh
, bh->
b_d©a
, 
dœ
->
i_sb
->
s_blocksize
, dir,

1176 
âame
, 
off£t
, 
»s_dœ
);

1177 
	}
}

1187 
	$dx_make_m­
(
šode
 *
dœ
, 
ext4_dœ_’Œy_2
 *
de
,

1188 
blocksize
, 
dx_hash_šfo
 *
hšfo
,

1189 
dx_m­_’Œy
 *
m­_
)

1191 
couÁ
 = 0;

1192 *
ba£
 = (*è
de
;

1193 
dx_hash_šfo
 
h
 = *
hšfo
;

1195 (*è
de
 < 
ba£
 + 
blocksize
) {

1196 ià(
de
->
Çme_Ën
 && de->
šode
) {

1197 
	`ext4fs_dœhash
(
de
->
Çme
, de->
Çme_Ën
, &
h
);

1198 
m­_
--;

1199 
m­_
->
hash
 = 
h
.hash;

1200 
m­_
->
offs
 = ((*è
de
 - 
ba£
)>>2;

1201 
m­_
->
size
 = 
	`Ë16_to_ıu
(
de
->
»c_Ën
);

1202 
couÁ
++;

1203 
	`cÚd_»sched
();

1206 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
blocksize
);

1208  
couÁ
;

1209 
	}
}

1212 
	$dx_sÜt_m­
 (
dx_m­_’Œy
 *
m­
, 
couÁ
)

1214 
dx_m­_’Œy
 *
p
, *
q
, *
tİ
 = 
m­
 + 
couÁ
 - 1;

1215 
mÜe
;

1217 
couÁ
 > 2) {

1218 
couÁ
 = count*10/13;

1219 ià(
couÁ
 - 9 < 2)

1220 
couÁ
 = 11;

1221 
p
 = 
tİ
, 
q
 =… - 
couÁ
; q >ğ
m­
;…--, q--)

1222 ià(
p
->
hash
 < 
q
->hash)

1223 
	`sw­
(*
p
, *
q
);

1227 
mÜe
 = 0;

1228 
q
 = 
tİ
;

1229 
q
-- > 
m­
) {

1230 ià(
q
[1].
hash
 >= q[0].hash)

1232 
	`sw­
(*(
q
+1), *q);

1233 
mÜe
 = 1;

1235 } 
mÜe
);

1236 
	}
}

1238 
	$dx_š£¹_block
(
dx_äame
 *
äame
, 
u32
 
hash
, 
ext4_lblk_t
 
block
)

1240 
dx_’Œy
 *
’Œ›s
 = 
äame
->entries;

1241 
dx_’Œy
 *
Şd
 = 
äame
->
©
, *
Ãw
 = old + 1;

1242 
couÁ
 = 
	`dx_g‘_couÁ
(
’Œ›s
);

1244 
	`as£¹
(
couÁ
 < 
	`dx_g‘_lim™
(
’Œ›s
));

1245 
	`as£¹
(
Şd
 < 
’Œ›s
 + 
couÁ
);

1246 
	`memmove
(
Ãw
 + 1,‚ew, (*)(
’Œ›s
 + 
couÁ
) - (*)(new));

1247 
	`dx_£t_hash
(
Ãw
, 
hash
);

1248 
	`dx_£t_block
(
Ãw
, 
block
);

1249 
	`dx_£t_couÁ
(
’Œ›s
, 
couÁ
 + 1);

1250 
	}
}

1257 
šlše
 
boŞ
 
	$ext4_m©ch
(cÚ¡ 
ext4_f’ame
 *
âame
,

1258 cÚ¡ 
ext4_dœ_’Œy_2
 *
de
)

1260 
fsüy±_Çme
 
f
;

1262 ià(!
de
->
šode
)

1263  
çl£
;

1265 
f
.
u¤_âame
 = 
âame
->usr_fname;

1266 
f
.
disk_Çme
 = 
âame
->disk_name;

1267 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


1268 
f
.
üy±o_buf
 = 
âame
->crypto_buf;

1270  
	`fsüy±_m©ch_Çme
(&
f
, 
de
->
Çme
, de->
Çme_Ën
);

1271 
	}
}

1276 
	$ext4_£¬ch_dœ
(
bufãr_h—d
 *
bh
, *
£¬ch_buf
, 
buf_size
,

1277 
šode
 *
dœ
, 
ext4_f’ame
 *
âame
,

1278 
off£t
, 
ext4_dœ_’Œy_2
 **
»s_dœ
)

1280 
ext4_dœ_’Œy_2
 * 
de
;

1281 * 
dlim™
;

1282 
de_Ën
;

1284 
de
 = (
ext4_dœ_’Œy_2
 *)
£¬ch_buf
;

1285 
dlim™
 = 
£¬ch_buf
 + 
buf_size
;

1286 (*è
de
 < 
dlim™
) {

1289 ià((*è
de
 + de->
Çme_Ën
 <ğ
dlim™
 &&

1290 
	`ext4_m©ch
(
âame
, 
de
)) {

1293 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
,

1294 
bh
->
b_size
, 
off£t
))

1296 *
»s_dœ
 = 
de
;

1300 
de_Ën
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

1301 
dœ
->
i_sb
->
s_blocksize
);

1302 ià(
de_Ën
 <= 0)

1304 
off£t
 +ğ
de_Ën
;

1305 
de
 = (
ext4_dœ_’Œy_2
 *è((*èd+ 
de_Ën
);

1308 
	}
}

1310 
	$is_dx_š‹º®_node
(
šode
 *
dœ
, 
ext4_lblk_t
 
block
,

1311 
ext4_dœ_’Œy
 *
de
)

1313 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

1315 ià(!
	`is_dx
(
dœ
))

1317 ià(
block
 == 0)

1319 ià(
de
->
šode
 == 0 &&

1320 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
sb
->
s_blocksize
) ==

1321 
sb
->
s_blocksize
)

1324 
	}
}

1337 
bufãr_h—d
 * 
	$ext4_fšd_’Œy
 (
šode
 *
dœ
,

1338 cÚ¡ 
q¡r
 *
d_Çme
,

1339 
ext4_dœ_’Œy_2
 **
»s_dœ
,

1340 *
šlšed
)

1342 
su³r_block
 *
sb
;

1343 
bufãr_h—d
 *
bh_u£
[
NAMEI_RA_SIZE
];

1344 
bufãr_h—d
 *
bh
, *
»t
 = 
NULL
;

1345 
ext4_lblk_t
 
¡¬t
, 
block
;

1346 cÚ¡ 
u8
 *
Çme
 = 
d_Çme
->name;

1347 
size_t
 
¿_max
 = 0;

1349 
size_t
 
¿_±r
 = 0;

1351 
ext4_lblk_t
 
nblocks
;

1352 
i
, 
Çm–’
, 
»tv®
;

1353 
ext4_f’ame
 
âame
;

1355 *
»s_dœ
 = 
NULL
;

1356 
sb
 = 
dœ
->
i_sb
;

1357 
Çm–’
 = 
d_Çme
->
Ën
;

1358 ià(
Çm–’
 > 
EXT4_NAME_LEN
)

1359  
NULL
;

1361 
»tv®
 = 
	`ext4_âame_£tup_f’ame
(
dœ
, 
d_Çme
, 1, &
âame
);

1362 ià(
»tv®
 =ğ-
ENOENT
)

1363  
NULL
;

1364 ià(
»tv®
)

1365  
	`ERR_PTR
(
»tv®
);

1367 ià(
	`ext4_has_šlše_d©a
(
dœ
)) {

1368 
has_šlše_d©a
 = 1;

1369 
»t
 = 
	`ext4_fšd_šlše_’Œy
(
dœ
, &
âame
, 
»s_dœ
,

1370 &
has_šlše_d©a
);

1371 ià(
has_šlše_d©a
) {

1372 ià(
šlšed
)

1373 *
šlšed
 = 1;

1374 
ş—nup_ªd_ex™
;

1378 ià((
Çm–’
 <ğ2è&& (
Çme
[0] == '.') &&

1379 (
Çme
[1] == '.' ||‚ame[1] == '\0')) {

1384 
block
 = 
¡¬t
 = 0;

1385 
nblocks
 = 1;

1386 
»¡¬t
;

1388 ià(
	`is_dx
(
dœ
)) {

1389 
»t
 = 
	`ext4_dx_fšd_’Œy
(
dœ
, &
âame
, 
»s_dœ
);

1395 ià(!
	`IS_ERR
(
»t
è|| 
	`PTR_ERR
Ô‘è!ğ
ERR_BAD_DX_DIR
)

1396 
ş—nup_ªd_ex™
;

1397 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "ext4_find_entry: dx failed, "

1400 
nblocks
 = 
dœ
->
i_size
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

1401 
¡¬t
 = 
	`EXT4_I
(
dœ
)->
i_dœ_¡¬t_lookup
;

1402 ià(
¡¬t
 >ğ
nblocks
)

1403 
¡¬t
 = 0;

1404 
block
 = 
¡¬t
;

1405 
»¡¬t
:

1410 ià(
¿_±r
 >ğ
¿_max
) {

1412 
¿_±r
 = 0;

1413 ià(
block
 < 
¡¬t
)

1414 
¿_max
 = 
¡¬t
 - 
block
;

1416 
¿_max
 = 
nblocks
 - 
block
;

1417 
¿_max
 = 
	`mš
Ôa_max, 
	`ARRAY_SIZE
(
bh_u£
));

1418 
»tv®
 = 
	`ext4_b»ad_b©ch
(
dœ
, 
block
, 
¿_max
,

1419 
çl£
 , 
bh_u£
);

1420 ià(
»tv®
) {

1421 
»t
 = 
	`ERR_PTR
(
»tv®
);

1422 
¿_max
 = 0;

1423 
ş—nup_ªd_ex™
;

1426 ià((
bh
 = 
bh_u£
[
¿_±r
++]è=ğ
NULL
)

1427 
Ãxt
;

1428 
	`wa™_Ú_bufãr
(
bh
);

1429 ià(!
	`bufãr_u±od©e
(
bh
)) {

1430 
	`EXT4_ERROR_INODE
(
dœ
, "reading directory†block %lu",

1431 (è
block
);

1432 
	`b»l£
(
bh
);

1433 
»t
 = 
	`ERR_PTR
(-
EIO
);

1434 
ş—nup_ªd_ex™
;

1436 ià(!
	`bufãr_v”if›d
(
bh
) &&

1437 !
	`is_dx_š‹º®_node
(
dœ
, 
block
,

1438 (
ext4_dœ_’Œy
 *)
bh
->
b_d©a
) &&

1439 !
	`ext4_dœ’t_csum_v”ify
(
dœ
,

1440 (
ext4_dœ_’Œy
 *)
bh
->
b_d©a
)) {

1441 
	`EXT4_ERROR_INODE
(
dœ
, "checksumming directory "

1442 "block %lu", ()
block
);

1443 
	`b»l£
(
bh
);

1444 
»t
 = 
	`ERR_PTR
(-
EFSBADCRC
);

1445 
ş—nup_ªd_ex™
;

1447 
	`£t_bufãr_v”if›d
(
bh
);

1448 
i
 = 
	`£¬ch_dœblock
(
bh
, 
dœ
, &
âame
,

1449 
block
 << 
	`EXT4_BLOCK_SIZE_BITS
(
sb
), 
»s_dœ
);

1450 ià(
i
 == 1) {

1451 
	`EXT4_I
(
dœ
)->
i_dœ_¡¬t_lookup
 = 
block
;

1452 
»t
 = 
bh
;

1453 
ş—nup_ªd_ex™
;

1455 
	`b»l£
(
bh
);

1456 ià(
i
 < 0)

1457 
ş—nup_ªd_ex™
;

1459 
Ãxt
:

1460 ià(++
block
 >ğ
nblocks
)

1461 
block
 = 0;

1462 } 
block
 !ğ
¡¬t
);

1468 
block
 = 
nblocks
;

1469 
nblocks
 = 
dœ
->
i_size
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

1470 ià(
block
 < 
nblocks
) {

1471 
¡¬t
 = 0;

1472 
»¡¬t
;

1475 
ş—nup_ªd_ex™
:

1477 ; 
¿_±r
 < 
¿_max
;„a_ptr++)

1478 
	`b»l£
(
bh_u£
[
¿_±r
]);

1479 
	`ext4_âame_ä“_f’ame
(&
âame
);

1480  
»t
;

1481 
	}
}

1483 
bufãr_h—d
 * 
	$ext4_dx_fšd_’Œy
(
šode
 *
dœ
,

1484 
ext4_f’ame
 *
âame
,

1485 
ext4_dœ_’Œy_2
 **
»s_dœ
)

1487 
su³r_block
 * 
sb
 = 
dœ
->
i_sb
;

1488 
dx_äame
 
äames
[
EXT4_HTREE_LEVEL
], *
äame
;

1489 
bufãr_h—d
 *
bh
;

1490 
ext4_lblk_t
 
block
;

1491 
»tv®
;

1493 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


1494 *
»s_dœ
 = 
NULL
;

1496 
äame
 = 
	`dx_´obe
(
âame
, 
dœ
, 
NULL
, 
äames
);

1497 ià(
	`IS_ERR
(
äame
))

1498  (
bufãr_h—d
 *è
äame
;

1500 
block
 = 
	`dx_g‘_block
(
äame
->
©
);

1501 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
block
, 
DIRENT
);

1502 ià(
	`IS_ERR
(
bh
))

1503 
”rout
;

1505 
»tv®
 = 
	`£¬ch_dœblock
(
bh
, 
dœ
, 
âame
,

1506 
block
 << 
	`EXT4_BLOCK_SIZE_BITS
(
sb
),

1507 
»s_dœ
);

1508 ià(
»tv®
 == 1)

1509 
sucûss
;

1510 
	`b»l£
(
bh
);

1511 ià(
»tv®
 == -1) {

1512 
bh
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

1513 
”rout
;

1517 
»tv®
 = 
	`ext4_hŒ“_Ãxt_block
(
dœ
, 
âame
->
hšfo
.
hash
, 
äame
,

1518 
äames
, 
NULL
);

1519 ià(
»tv®
 < 0) {

1520 
	`ext4_w¬nšg_šode
(
dœ
,

1522 
»tv®
);

1523 
bh
 = 
	`ERR_PTR
(
»tv®
);

1524 
”rout
;

1526 } 
»tv®
 == 1);

1528 
bh
 = 
NULL
;

1529 
”rout
:

1530 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "% nÙ found\n", 
âame
->
u¤_âame
->
Çme
));

1531 
sucûss
:

1532 
	`dx_»Ëa£
(
äames
);

1533  
bh
;

1534 
	}
}

1536 
d’Œy
 *
	$ext4_lookup
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
æags
)

1538 
šode
 *inode;

1539 
ext4_dœ_’Œy_2
 *
de
;

1540 
bufãr_h—d
 *
bh
;

1542 ià(
	`ext4_’üy±ed_šode
(
dœ
)) {

1543 
»s
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

1550 ià(
	`fsüy±_has_’üy±iÚ_key
(
dœ
))

1551 
	`fsüy±_£t_’üy±ed_d’Œy
(
d’Œy
);

1552 
	`fsüy±_£t_d_İ
(
d’Œy
);

1553 ià(
»s
 &&„e !ğ-
ENOKEY
)

1554  
	`ERR_PTR
(
»s
);

1557 ià(
d’Œy
->
d_Çme
.
Ën
 > 
EXT4_NAME_LEN
)

1558  
	`ERR_PTR
(-
ENAMETOOLONG
);

1560 
bh
 = 
	`ext4_fšd_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, &
de
, 
NULL
);

1561 ià(
	`IS_ERR
(
bh
))

1562  (
d’Œy
 *è
bh
;

1563 
šode
 = 
NULL
;

1564 ià(
bh
) {

1565 
__u32
 
šo
 = 
	`Ë32_to_ıu
(
de
->
šode
);

1566 
	`b»l£
(
bh
);

1567 ià(!
	`ext4_v®id_šum
(
dœ
->
i_sb
, 
šo
)) {

1568 
	`EXT4_ERROR_INODE
(
dœ
, "bad inodnumb”: %u", 
šo
);

1569  
	`ERR_PTR
(-
EFSCORRUPTED
);

1571 ià(
	`uÆik–y
(
šo
 =ğ
dœ
->
i_šo
)) {

1572 
	`EXT4_ERROR_INODE
(
dœ
, "'%pd'†inkedo…arent dir",

1573 
d’Œy
);

1574  
	`ERR_PTR
(-
EFSCORRUPTED
);

1576 
šode
 = 
	`ext4_ig‘_nÜm®
(
dœ
->
i_sb
, 
šo
);

1577 ià(
šode
 =ğ
	`ERR_PTR
(-
ESTALE
)) {

1578 
	`EXT4_ERROR_INODE
(
dœ
,

1580 
šo
);

1581  
	`ERR_PTR
(-
EFSCORRUPTED
);

1583 ià(!
	`IS_ERR
(
šode
è&& 
	`ext4_’üy±ed_šode
(
dœ
) &&

1584 (
	`S_ISDIR
(
šode
->
i_mode
è|| 
	`S_ISLNK
(inode->i_mode)) &&

1585 !
	`fsüy±_has_³rm™‹d_cÚ‹xt
(
dœ
, 
šode
)) {

1586 
	`ext4_w¬nšg
(
šode
->
i_sb
,

1588 
dœ
->
i_šo
, 
šode
->i_ino);

1589 
	`ut
(
šode
);

1590  
	`ERR_PTR
(-
EPERM
);

1593  
	`d_¥liû_®Ÿs
(
šode
, 
d’Œy
);

1594 
	}
}

1597 
d’Œy
 *
	$ext4_g‘_·»Á
(
d’Œy
 *
chd
)

1599 
__u32
 
šo
;

1600 cÚ¡ 
q¡r
 
dÙdÙ
 = 
	`QSTR_INIT
("..", 2);

1601 
ext4_dœ_’Œy_2
 * 
de
;

1602 
bufãr_h—d
 *
bh
;

1604 
bh
 = 
	`ext4_fšd_’Œy
(
	`d_šode
(
chd
), &
dÙdÙ
, &
de
, 
NULL
);

1605 ià(
	`IS_ERR
(
bh
))

1606  (
d’Œy
 *è
bh
;

1607 ià(!
bh
)

1608  
	`ERR_PTR
(-
ENOENT
);

1609 
šo
 = 
	`Ë32_to_ıu
(
de
->
šode
);

1610 
	`b»l£
(
bh
);

1612 ià(!
	`ext4_v®id_šum
(
chd
->
d_sb
, 
šo
)) {

1613 
	`EXT4_ERROR_INODE
(
	`d_šode
(
chd
),

1614 "bad…¬’ˆšodnumb”: %u", 
šo
);

1615  
	`ERR_PTR
(-
EFSCORRUPTED
);

1618  
	`d_obš_®Ÿs
(
	`ext4_ig‘_nÜm®
(
chd
->
d_sb
, 
šo
));

1619 
	}
}

1625 
ext4_dœ_’Œy_2
 *

1626 
	$dx_move_dœ’ts
(*
äom
, *
to
, 
dx_m­_’Œy
 *
m­
, 
couÁ
,

1627 
blocksize
)

1629 
»c_Ën
 = 0;

1631 
couÁ
--) {

1632 
ext4_dœ_’Œy_2
 *
de
 = (ext4_dir_entry_2 *)

1633 (
äom
 + (
m­
->
offs
<<2));

1634 
»c_Ën
 = 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

1635 
	`memıy
 (
to
, 
de
, 
»c_Ën
);

1636 ((
ext4_dœ_’Œy_2
 *è
to
)->
»c_Ën
 =

1637 
	`ext4_»c_Ën_to_disk
(
»c_Ën
, 
blocksize
);

1638 
de
->
šode
 = 0;

1639 
m­
++;

1640 
to
 +ğ
»c_Ën
;

1642  (
ext4_dœ_’Œy_2
 *è(
to
 - 
»c_Ën
);

1643 
	}
}

1649 
ext4_dœ_’Œy_2
* 
	$dx_·ck_dœ’ts
(*
ba£
, 
blocksize
)

1651 
ext4_dœ_’Œy_2
 *
Ãxt
, *
to
, *
´ev
, *
de
 = (ext4_dœ_’Œy_2 *è
ba£
;

1652 
»c_Ën
 = 0;

1654 
´ev
 = 
to
 = 
de
;

1655 (*)
de
 < 
ba£
 + 
blocksize
) {

1656 
Ãxt
 = 
	`ext4_Ãxt_’Œy
(
de
, 
blocksize
);

1657 ià(
de
->
šode
 && de->
Çme_Ën
) {

1658 
»c_Ën
 = 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

1659 ià(
de
 > 
to
)

1660 
	`memmove
(
to
, 
de
, 
»c_Ën
);

1661 
to
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
Ôec_Ën, 
blocksize
);

1662 
´ev
 = 
to
;

1663 
to
 = (
ext4_dœ_’Œy_2
 *è(((*ètoè+ 
»c_Ën
);

1665 
de
 = 
Ãxt
;

1667  
´ev
;

1668 
	}
}

1675 
ext4_dœ_’Œy_2
 *
	$do_¥l™
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

1676 
bufãr_h—d
 **
bh
,
dx_äame
 *
äame
,

1677 
dx_hash_šfo
 *
hšfo
)

1679 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

1680 
couÁ
, 
cÚtšued
;

1681 
bufãr_h—d
 *
bh2
;

1682 
ext4_lblk_t
 
Ãwblock
;

1683 
u32
 
hash2
;

1684 
dx_m­_’Œy
 *
m­
;

1685 *
d©a1
 = (*
bh
)->
b_d©a
, *
d©a2
;

1686 
¥l™
, 
move
, 
size
;

1687 
ext4_dœ_’Œy_2
 *
de
 = 
NULL
, *
de2
;

1688 
ext4_dœ_’Œy_
 *
t
;

1689 
csum_size
 = 0;

1690 
”r
 = 0, 
i
;

1692 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

1693 
csum_size
 = (
ext4_dœ_’Œy_
);

1695 
bh2
 = 
	`ext4_­³nd
(
hªdË
, 
dœ
, &
Ãwblock
);

1696 ià(
	`IS_ERR
(
bh2
)) {

1697 
	`b»l£
(*
bh
);

1698 *
bh
 = 
NULL
;

1699  (
ext4_dœ_’Œy_2
 *è
bh2
;

1702 
	`BUFFER_TRACE
(*
bh
, "get_write_access");

1703 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, *
bh
);

1704 ià(
”r
)

1705 
jouº®_”rÜ
;

1707 
	`BUFFER_TRACE
(
äame
->
bh
, "get_write_access");

1708 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
äame
->
bh
);

1709 ià(
”r
)

1710 
jouº®_”rÜ
;

1712 
d©a2
 = 
bh2
->
b_d©a
;

1715 
m­
 = (
dx_m­_’Œy
 *è(
d©a2
 + 
blocksize
);

1716 
couÁ
 = 
	`dx_make_m­
(
dœ
, (
ext4_dœ_’Œy_2
 *è
d©a1
,

1717 
blocksize
, 
hšfo
, 
m­
);

1718 
m­
 -ğ
couÁ
;

1719 
	`dx_sÜt_m­
(
m­
, 
couÁ
);

1721 
size
 = 0;

1722 
move
 = 0;

1723 
i
 = 
couÁ
-1; i >= 0; i--) {

1725 ià(
size
 + 
m­
[
i
].size/2 > 
blocksize
/2)

1727 
size
 +ğ
m­
[
i
].size;

1728 
move
++;

1731 
¥l™
 = 
couÁ
 - 
move
;

1732 
hash2
 = 
m­
[
¥l™
].
hash
;

1733 
cÚtšued
 = 
hash2
 =ğ
m­
[
¥l™
 - 1].
hash
;

1734 
	`dxŒaû
(
	`´štk
(
KERN_INFO
 "Split block %lu‡t %x, %i/%i\n",

1735 ()
	`dx_g‘_block
(
äame
->
©
),

1736 
hash2
, 
¥l™
, 
couÁ
-split));

1739 
de2
 = 
	`dx_move_dœ’ts
(
d©a1
, 
d©a2
, 
m­
 + 
¥l™
, 
couÁ
 - split,

1740 
blocksize
);

1741 
de
 = 
	`dx_·ck_dœ’ts
(
d©a1
, 
blocksize
);

1742 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
d©a1
 + (
blocksize
 - 
csum_size
) -

1743 (*è
de
,

1744 
blocksize
);

1745 
de2
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

1746 (*è
de2
,

1747 
blocksize
);

1748 ià(
csum_size
) {

1749 
t
 = 
	`EXT4_DIRENT_TAIL
(
d©a2
, 
blocksize
);

1750 
	`š™Ÿlize_dœ’t_
(
t
, 
blocksize
);

1752 
t
 = 
	`EXT4_DIRENT_TAIL
(
d©a1
, 
blocksize
);

1753 
	`š™Ÿlize_dœ’t_
(
t
, 
blocksize
);

1756 
	`dxŒaû
(
	`dx_show_Ëaf
(
dœ
, 
hšfo
, (
ext4_dœ_’Œy_2
 *è
d©a1
,

1757 
blocksize
, 1));

1758 
	`dxŒaû
(
	`dx_show_Ëaf
(
dœ
, 
hšfo
, (
ext4_dœ_’Œy_2
 *è
d©a2
,

1759 
blocksize
, 1));

1762 ià(
hšfo
->
hash
 >ğ
hash2
) {

1763 
	`sw­
(*
bh
, 
bh2
);

1764 
de
 = 
de2
;

1766 
	`dx_š£¹_block
(
äame
, 
hash2
 + 
cÚtšued
, 
Ãwblock
);

1767 
”r
 = 
	`ext4_hªdË_dœty_dœ’t_node
(
hªdË
, 
dœ
, 
bh2
);

1768 ià(
”r
)

1769 
jouº®_”rÜ
;

1770 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
äame
->
bh
);

1771 ià(
”r
)

1772 
jouº®_”rÜ
;

1773 
	`b»l£
(
bh2
);

1774 
	`dxŒaû
(
	`dx_show_šdex
("äame", 
äame
->
’Œ›s
));

1775  
de
;

1777 
jouº®_”rÜ
:

1778 
	`b»l£
(*
bh
);

1779 
	`b»l£
(
bh2
);

1780 *
bh
 = 
NULL
;

1781 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

1782  
	`ERR_PTR
(
”r
);

1783 
	}
}

1785 
	$ext4_fšd_de¡_de
(
šode
 *
dœ
, inode *inode,

1786 
bufãr_h—d
 *
bh
,

1787 *
buf
, 
buf_size
,

1788 
ext4_f’ame
 *
âame
,

1789 
ext4_dœ_’Œy_2
 **
de¡_de
)

1791 
ext4_dœ_’Œy_2
 *
de
;

1792 
»ş’
 = 
	`EXT4_DIR_REC_LEN
(
	`âame_Ën
(
âame
));

1793 
Æ’
, 
¾’
;

1794 
off£t
 = 0;

1795 *
tİ
;

1797 
de
 = (
ext4_dœ_’Œy_2
 *)
buf
;

1798 
tİ
 = 
buf
 + 
buf_size
 - 
»ş’
;

1799 (*è
de
 <ğ
tİ
) {

1800 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

1801 
buf
, 
buf_size
, 
off£t
))

1802  -
EFSCORRUPTED
;

1803 ià(
	`ext4_m©ch
(
âame
, 
de
))

1804  -
EEXIST
;

1805 
Æ’
 = 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

1806 
¾’
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
buf_size
);

1807 ià((
de
->
šode
 ? 
¾’
 - 
Æ’
 :„Ënè>ğ
»ş’
)

1809 
de
 = (
ext4_dœ_’Œy_2
 *)((*)d+ 
¾’
);

1810 
off£t
 +ğ
¾’
;

1812 ià((*è
de
 > 
tİ
)

1813  -
ENOSPC
;

1815 *
de¡_de
 = 
de
;

1817 
	}
}

1819 
	$ext4_š£¹_d’Œy
(
šode
 *inode,

1820 
ext4_dœ_’Œy_2
 *
de
,

1821 
buf_size
,

1822 
ext4_f’ame
 *
âame
)

1825 
Æ’
, 
¾’
;

1827 
Æ’
 = 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
);

1828 
¾’
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
buf_size
);

1829 ià(
de
->
šode
) {

1830 
ext4_dœ_’Œy_2
 *
de1
 =

1831 (
ext4_dœ_’Œy_2
 *)((*)
de
 + 
Æ’
);

1832 
de1
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
¾’
 - 
Æ’
, 
buf_size
);

1833 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
Æ’
, 
buf_size
);

1834 
de
 = 
de1
;

1836 
de
->
fe_ty³
 = 
EXT4_FT_UNKNOWN
;

1837 
de
->
šode
 = 
	`ıu_to_Ë32
(šode->
i_šo
);

1838 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, 
de
, inode->
i_mode
);

1839 
de
->
Çme_Ën
 = 
	`âame_Ën
(
âame
);

1840 
	`memıy
(
de
->
Çme
, 
	`âame_Çme
(
âame
), 
	`âame_Ën
(fname));

1841 
	}
}

1851 
	$add_dœ’t_to_buf
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

1852 
šode
 *
dœ
,

1853 
šode
 *šode, 
ext4_dœ_’Œy_2
 *
de
,

1854 
bufãr_h—d
 *
bh
)

1856 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

1857 
csum_size
 = 0;

1858 
”r
;

1860 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

1861 
csum_size
 = (
ext4_dœ_’Œy_
);

1863 ià(!
de
) {

1864 
”r
 = 
	`ext4_fšd_de¡_de
(
dœ
, 
šode
, 
bh
, bh->
b_d©a
,

1865 
blocksize
 - 
csum_size
, 
âame
, &
de
);

1866 ià(
”r
)

1867  
”r
;

1869 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1870 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1871 ià(
”r
) {

1872 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

1873  
”r
;

1877 
	`ext4_š£¹_d’Œy
(
šode
, 
de
, 
blocksize
, 
âame
);

1890 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
	`cu¼’t_time
(dir);

1891 
	`ext4_upd©e_dx_æag
(
dœ
);

1892 
	`šode_šc_iv”siÚ
(
dœ
);

1893 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

1894 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

1895 
”r
 = 
	`ext4_hªdË_dœty_dœ’t_node
(
hªdË
, 
dœ
, 
bh
);

1896 ià(
”r
)

1897 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

1899 
	}
}

1905 
	$make_šdexed_dœ
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

1906 
šode
 *
dœ
,

1907 
šode
 *šode, 
bufãr_h—d
 *
bh
)

1909 
bufãr_h—d
 *
bh2
;

1910 
dx_roÙ
 *
roÙ
;

1911 
dx_äame
 
äames
[
EXT4_HTREE_LEVEL
], *
äame
;

1912 
dx_’Œy
 *
’Œ›s
;

1913 
ext4_dœ_’Œy_2
 *
de
, *
de2
;

1914 
ext4_dœ_’Œy_
 *
t
;

1915 *
d©a1
, *
tİ
;

1916 
Ën
;

1917 
»tv®
;

1918 
blocksize
;

1919 
ext4_lblk_t
 
block
;

1920 
çke_dœ’t
 *
fde
;

1921 
csum_size
 = 0;

1923 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

1924 
csum_size
 = (
ext4_dœ_’Œy_
);

1926 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

1927 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "C»©šg index: inod%lu\n", 
dœ
->
i_šo
));

1928 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1929 
»tv®
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1930 ià(
»tv®
) {

1931 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
»tv®
);

1932 
	`b»l£
(
bh
);

1933  
»tv®
;

1935 
roÙ
 = (
dx_roÙ
 *è
bh
->
b_d©a
;

1938 
fde
 = &
roÙ
->
dÙdÙ
;

1939 
de
 = (
ext4_dœ_’Œy_2
 *)((*)
fde
 +

1940 
	`ext4_»c_Ën_äom_disk
(
fde
->
»c_Ën
, 
blocksize
));

1941 ià((*è
de
 >ğ(((*è
roÙ
è+ 
blocksize
)) {

1942 
	`EXT4_ERROR_INODE
(
dœ
, "invalid„ec_len for '..'");

1943 
	`b»l£
(
bh
);

1944  -
EFSCORRUPTED
;

1946 
Ën
 = ((*è
roÙ
è+ (
blocksize
 - 
csum_size
è- (*è
de
;

1949 
bh2
 = 
	`ext4_­³nd
(
hªdË
, 
dœ
, &
block
);

1950 ià(
	`IS_ERR
(
bh2
)) {

1951 
	`b»l£
(
bh
);

1952  
	`PTR_ERR
(
bh2
);

1954 
	`ext4_£t_šode_æag
(
dœ
, 
EXT4_INODE_INDEX
);

1955 
d©a1
 = 
bh2
->
b_d©a
;

1957 
	`memıy
 (
d©a1
, 
de
, 
Ën
);

1958 
de
 = (
ext4_dœ_’Œy_2
 *è
d©a1
;

1959 
tİ
 = 
d©a1
 + 
Ën
;

1960 (*)(
de2
 = 
	`ext4_Ãxt_’Œy
(
de
, 
blocksize
)è< 
tİ
)

1961 
de
 = 
de2
;

1962 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
d©a1
 + (
blocksize
 - 
csum_size
) -

1963 (*è
de
,

1964 
blocksize
);

1966 ià(
csum_size
) {

1967 
t
 = 
	`EXT4_DIRENT_TAIL
(
d©a1
, 
blocksize
);

1968 
	`š™Ÿlize_dœ’t_
(
t
, 
blocksize
);

1972 
de
 = (
ext4_dœ_’Œy_2
 *è(&
roÙ
->
dÙdÙ
);

1973 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
blocksize
 - 
	`EXT4_DIR_REC_LEN
(2),

1974 
blocksize
);

1975 
	`mem£t
 (&
roÙ
->
šfo
, 0, (root->info));

1976 
roÙ
->
šfo
.
šfo_Ëngth
 = (root->info);

1977 
roÙ
->
šfo
.
hash_v”siÚ
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_def_hash_v”siÚ
;

1978 
’Œ›s
 = 
roÙ
->entries;

1979 
	`dx_£t_block
(
’Œ›s
, 1);

1980 
	`dx_£t_couÁ
(
’Œ›s
, 1);

1981 
	`dx_£t_lim™
(
’Œ›s
, 
	`dx_roÙ_lim™
(
dœ
, (
roÙ
->
šfo
)));

1984 
âame
->
hšfo
.
hash_v”siÚ
 = 
roÙ
->
šfo
.hash_version;

1985 ià(
âame
->
hšfo
.
hash_v”siÚ
 <ğ
DX_HASH_TEA
)

1986 
âame
->
hšfo
.
hash_v”siÚ
 +ğ
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_unsigÃd
;

1987 
âame
->
hšfo
.
£ed
 = 
	`EXT4_SB
(
dœ
->
i_sb
)->
s_hash_£ed
;

1988 
	`ext4fs_dœhash
(
	`âame_Çme
(
âame
), 
	`âame_Ën
(âame), &âame->
hšfo
);

1990 
	`mem£t
(
äames
, 0, (frames));

1991 
äame
 = 
äames
;

1992 
äame
->
’Œ›s
 =ƒntries;

1993 
äame
->
©
 = 
’Œ›s
;

1994 
äame
->
bh
 = bh;

1996 
»tv®
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
äame
->
bh
);

1997 ià(
»tv®
)

1998 
out_äames
;

1999 
»tv®
 = 
	`ext4_hªdË_dœty_dœ’t_node
(
hªdË
, 
dœ
, 
bh2
);

2000 ià(
»tv®
)

2001 
out_äames
;

2003 
de
 = 
	`do_¥l™
(
hªdË
,
dœ
, &
bh2
, 
äame
, &
âame
->
hšfo
);

2004 ià(
	`IS_ERR
(
de
)) {

2005 
»tv®
 = 
	`PTR_ERR
(
de
);

2006 
out_äames
;

2009 
»tv®
 = 
	`add_dœ’t_to_buf
(
hªdË
, 
âame
, 
dœ
, 
šode
, 
de
, 
bh2
);

2010 
out_äames
:

2016 ià(
»tv®
)

2017 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

2018 
	`dx_»Ëa£
(
äames
);

2019 
	`b»l£
(
bh2
);

2020  
»tv®
;

2021 
	}
}

2033 
	$ext4_add_’Œy
(
hªdË_t
 *
hªdË
, 
d’Œy
 *dentry,

2034 
šode
 *inode)

2036 
šode
 *
dœ
 = 
	`d_šode
(
d’Œy
->
d_·»Á
);

2037 
bufãr_h—d
 *
bh
 = 
NULL
;

2038 
ext4_dœ_’Œy_2
 *
de
;

2039 
ext4_dœ_’Œy_
 *
t
;

2040 
su³r_block
 *
sb
;

2041 
ext4_f’ame
 
âame
;

2042 
»tv®
;

2043 
dx_çÎback
=0;

2044 
blocksize
;

2045 
ext4_lblk_t
 
block
, 
blocks
;

2046 
csum_size
 = 0;

2048 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

2049 
csum_size
 = (
ext4_dœ_’Œy_
);

2051 
sb
 = 
dœ
->
i_sb
;

2052 
blocksize
 = 
sb
->
s_blocksize
;

2053 ià(!
d’Œy
->
d_Çme
.
Ën
)

2054  -
EINVAL
;

2056 
»tv®
 = 
	`ext4_âame_£tup_f’ame
(
dœ
, &
d’Œy
->
d_Çme
, 0, &
âame
);

2057 ià(
»tv®
)

2058  
»tv®
;

2060 ià(
	`ext4_has_šlše_d©a
(
dœ
)) {

2061 
»tv®
 = 
	`ext4_Œy_add_šlše_’Œy
(
hªdË
, &
âame
, 
dœ
, 
šode
);

2062 ià(
»tv®
 < 0)

2063 
out
;

2064 ià(
»tv®
 == 1) {

2065 
»tv®
 = 0;

2066 
out
;

2070 ià(
	`is_dx
(
dœ
)) {

2071 
»tv®
 = 
	`ext4_dx_add_’Œy
(
hªdË
, &
âame
, 
dœ
, 
šode
);

2072 ià(!
»tv®
 || (»tv® !ğ
ERR_BAD_DX_DIR
))

2073 
out
;

2074 
	`ext4_ş—r_šode_æag
(
dœ
, 
EXT4_INODE_INDEX
);

2075 
dx_çÎback
++;

2076 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

2078 
blocks
 = 
dœ
->
i_size
 >> 
sb
->
s_blocksize_b™s
;

2079 
block
 = 0; block < 
blocks
; block++) {

2080 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
block
, 
DIRENT
);

2081 ià(
	`IS_ERR
(
bh
)) {

2082 
»tv®
 = 
	`PTR_ERR
(
bh
);

2083 
bh
 = 
NULL
;

2084 
out
;

2086 
»tv®
 = 
	`add_dœ’t_to_buf
(
hªdË
, &
âame
, 
dœ
, 
šode
,

2087 
NULL
, 
bh
);

2088 ià(
»tv®
 !ğ-
ENOSPC
)

2089 
out
;

2091 ià(
blocks
 =ğ1 && !
dx_çÎback
 &&

2092 
	`ext4_has_ã©u»_dœ_šdex
(
sb
)) {

2093 
»tv®
 = 
	`make_šdexed_dœ
(
hªdË
, &
âame
, 
dœ
,

2094 
šode
, 
bh
);

2095 
bh
 = 
NULL
;

2096 
out
;

2098 
	`b»l£
(
bh
);

2100 
bh
 = 
	`ext4_­³nd
(
hªdË
, 
dœ
, &
block
);

2101 ià(
	`IS_ERR
(
bh
)) {

2102 
»tv®
 = 
	`PTR_ERR
(
bh
);

2103 
bh
 = 
NULL
;

2104 
out
;

2106 
de
 = (
ext4_dœ_’Œy_2
 *è
bh
->
b_d©a
;

2107 
de
->
šode
 = 0;

2108 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
blocksize
 - 
csum_size
, blocksize);

2110 ià(
csum_size
) {

2111 
t
 = 
	`EXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
blocksize
);

2112 
	`š™Ÿlize_dœ’t_
(
t
, 
blocksize
);

2115 
»tv®
 = 
	`add_dœ’t_to_buf
(
hªdË
, &
âame
, 
dœ
, 
šode
, 
de
, 
bh
);

2116 
out
:

2117 
	`ext4_âame_ä“_f’ame
(&
âame
);

2118 
	`b»l£
(
bh
);

2119 ià(
»tv®
 == 0)

2120 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_NEWENTRY
);

2121  
»tv®
;

2122 
	}
}

2127 
	$ext4_dx_add_’Œy
(
hªdË_t
 *
hªdË
, 
ext4_f’ame
 *
âame
,

2128 
šode
 *
dœ
, inode *inode)

2130 
dx_äame
 
äames
[
EXT4_HTREE_LEVEL
], *
äame
;

2131 
dx_’Œy
 *
’Œ›s
, *
©
;

2132 
bufãr_h—d
 *
bh
;

2133 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

2134 
ext4_dœ_’Œy_2
 *
de
;

2135 
»¡¬t
;

2136 
”r
;

2138 
agaš
:

2139 
»¡¬t
 = 0;

2140 
äame
 = 
	`dx_´obe
(
âame
, 
dœ
, 
NULL
, 
äames
);

2141 ià(
	`IS_ERR
(
äame
))

2142  
	`PTR_ERR
(
äame
);

2143 
’Œ›s
 = 
äame
->entries;

2144 
©
 = 
äame
->at;

2145 
bh
 = 
	`ext4_»ad_dœblock
(
dœ
, 
	`dx_g‘_block
(
äame
->
©
), 
DIRENT
);

2146 ià(
	`IS_ERR
(
bh
)) {

2147 
”r
 = 
	`PTR_ERR
(
bh
);

2148 
bh
 = 
NULL
;

2149 
ş—nup
;

2152 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2153 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

2154 ià(
”r
)

2155 
jouº®_”rÜ
;

2157 
”r
 = 
	`add_dœ’t_to_buf
(
hªdË
, 
âame
, 
dœ
, 
šode
, 
NULL
, 
bh
);

2158 ià(
”r
 !ğ-
ENOSPC
)

2159 
ş—nup
;

2161 
”r
 = 0;

2163 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "using %u of %u‚odeƒntries\n",

2164 
	`dx_g‘_couÁ
(
’Œ›s
), 
	`dx_g‘_lim™
(entries)));

2166 ià(
	`dx_g‘_couÁ
(
’Œ›s
è=ğ
	`dx_g‘_lim™
(entries)) {

2167 
ext4_lblk_t
 
Ãwblock
;

2168 
Ëv–s
 = 
äame
 - 
äames
 + 1;

2169 
icouÁ
;

2170 
add_Ëv–
 = 1;

2171 
dx_’Œy
 *
’Œ›s2
;

2172 
dx_node
 *
node2
;

2173 
bufãr_h—d
 *
bh2
;

2175 
äame
 > 
äames
) {

2176 ià(
	`dx_g‘_couÁ
((
äame
 - 1)->
’Œ›s
) <

2177 
	`dx_g‘_lim™
((
äame
 - 1)->
’Œ›s
)) {

2178 
add_Ëv–
 = 0;

2181 
äame
--;

2182 
©
 = 
äame
->at;

2183 
’Œ›s
 = 
äame
->entries;

2184 
»¡¬t
 = 1;

2186 ià(
add_Ëv–
 && 
Ëv–s
 =ğ
	`ext4_dœ_hŒ“_Ëv–
(
sb
)) {

2187 
	`ext4_w¬nšg
(
sb
, "Directory (ino: %lu) index full, "

2189 
dœ
->
i_šo
, 
Ëv–s
);

2190 ià(
	`ext4_dœ_hŒ“_Ëv–
(
sb
è< 
EXT4_HTREE_LEVEL
) {

2191 
	`ext4_w¬nšg
(
sb
, "Large directory feature is "

2195 
”r
 = -
ENOSPC
;

2196 
ş—nup
;

2198 
icouÁ
 = 
	`dx_g‘_couÁ
(
’Œ›s
);

2199 
bh2
 = 
	`ext4_­³nd
(
hªdË
, 
dœ
, &
Ãwblock
);

2200 ià(
	`IS_ERR
(
bh2
)) {

2201 
”r
 = 
	`PTR_ERR
(
bh2
);

2202 
ş—nup
;

2204 
node2
 = (
dx_node
 *)(
bh2
->
b_d©a
);

2205 
’Œ›s2
 = 
node2
->
’Œ›s
;

2206 
	`mem£t
(&
node2
->
çke
, 0, (
çke_dœ’t
));

2207 
node2
->
çke
.
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
sb
->
s_blocksize
,

2208 
sb
->
s_blocksize
);

2209 
	`BUFFER_TRACE
(
äame
->
bh
, "get_write_access");

2210 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
äame
->
bh
);

2211 ià(
”r
)

2212 
jouº®_”rÜ
;

2213 ià(!
add_Ëv–
) {

2214 
icouÁ1
 = 
icouÁ
/2, 
icouÁ2
 = icount - icount1;

2215 
hash2
 = 
	`dx_g‘_hash
(
’Œ›s
 + 
icouÁ1
);

2216 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG
 "Split index %i/%i\n",

2217 
icouÁ1
, 
icouÁ2
));

2219 
	`BUFFER_TRACE
(
äame
->
bh
, "get_write_access");

2220 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
,

2221 (
äame
 - 1)->
bh
);

2222 ià(
”r
)

2223 
jouº®_”rÜ
;

2225 
	`memıy
((*è
’Œ›s2
, (*è(
’Œ›s
 + 
icouÁ1
),

2226 
icouÁ2
 * (
dx_’Œy
));

2227 
	`dx_£t_couÁ
(
’Œ›s
, 
icouÁ1
);

2228 
	`dx_£t_couÁ
(
’Œ›s2
, 
icouÁ2
);

2229 
	`dx_£t_lim™
(
’Œ›s2
, 
	`dx_node_lim™
(
dœ
));

2232 ià(
©
 - 
’Œ›s
 >ğ
icouÁ1
) {

2233 
äame
->
©
 =‡ˆğ© - 
’Œ›s
 - 
icouÁ1
 + 
’Œ›s2
;

2234 
äame
->
’Œ›s
 =ƒÁr› ğ
’Œ›s2
;

2235 
	`sw­
(
äame
->
bh
, 
bh2
);

2237 
	`dx_š£¹_block
((
äame
 - 1), 
hash2
, 
Ãwblock
);

2238 
	`dxŒaû
(
	`dx_show_šdex
("node", 
äame
->
’Œ›s
));

2239 
	`dxŒaû
(
	`dx_show_šdex
("node",

2240 ((
dx_node
 *è
bh2
->
b_d©a
)->
’Œ›s
));

2241 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
bh2
);

2242 ià(
”r
)

2243 
jouº®_”rÜ
;

2244 
	`b»l£
 (
bh2
);

2245 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
,

2246 (
äame
 - 1)->
bh
);

2247 ià(
”r
)

2248 
jouº®_”rÜ
;

2249 ià(
»¡¬t
) {

2250 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
,

2251 
äame
->
bh
);

2252 
jouº®_”rÜ
;

2255 
dx_roÙ
 *
dxroÙ
;

2256 
	`memıy
((*è
’Œ›s2
, (*è
’Œ›s
,

2257 
icouÁ
 * (
dx_’Œy
));

2258 
	`dx_£t_lim™
(
’Œ›s2
, 
	`dx_node_lim™
(
dœ
));

2261 
	`dx_£t_couÁ
(
’Œ›s
, 1);

2262 
	`dx_£t_block
(
’Œ›s
 + 0, 
Ãwblock
);

2263 
dxroÙ
 = (
dx_roÙ
 *)
äames
[0].
bh
->
b_d©a
;

2264 
dxroÙ
->
šfo
.
šdœeù_Ëv–s
 += 1;

2265 
	`dxŒaû
(
	`´štk
(
KERN_DEBUG


2267 
šfo
->
šdœeù_Ëv–s
));

2268 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
äame
->
bh
);

2269 ià(
”r
)

2270 
jouº®_”rÜ
;

2271 
”r
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
, 
dœ
, 
bh2
);

2272 
	`b»l£
(
bh2
);

2273 
»¡¬t
 = 1;

2274 
jouº®_”rÜ
;

2277 
de
 = 
	`do_¥l™
(
hªdË
, 
dœ
, &
bh
, 
äame
, &
âame
->
hšfo
);

2278 ià(
	`IS_ERR
(
de
)) {

2279 
”r
 = 
	`PTR_ERR
(
de
);

2280 
ş—nup
;

2282 
”r
 = 
	`add_dœ’t_to_buf
(
hªdË
, 
âame
, 
dœ
, 
šode
, 
de
, 
bh
);

2283 
ş—nup
;

2285 
jouº®_”rÜ
:

2286 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

2287 
ş—nup
:

2288 
	`b»l£
(
bh
);

2289 
	`dx_»Ëa£
(
äames
);

2293 ià(
»¡¬t
 && 
”r
 == 0)

2294 
agaš
;

2295  
”r
;

2296 
	}
}

2302 
	$ext4_g’”ic_d–‘e_’Œy
(
hªdË_t
 *
hªdË
,

2303 
šode
 *
dœ
,

2304 
ext4_dœ_’Œy_2
 *
de_d–
,

2305 
bufãr_h—d
 *
bh
,

2306 *
’Œy_buf
,

2307 
buf_size
,

2308 
csum_size
)

2310 
ext4_dœ_’Œy_2
 *
de
, *
pde
;

2311 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

2312 
i
;

2314 
i
 = 0;

2315 
pde
 = 
NULL
;

2316 
de
 = (
ext4_dœ_’Œy_2
 *)
’Œy_buf
;

2317 
i
 < 
buf_size
 - 
csum_size
) {

2318 ià(
	`ext4_check_dœ_’Œy
(
dœ
, 
NULL
, 
de
, 
bh
,

2319 
bh
->
b_d©a
, bh->
b_size
, 
i
))

2320  -
EFSCORRUPTED
;

2321 ià(
de
 =ğ
de_d–
) {

2322 ià(
pde
)

2323 
pde
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

2324 
	`ext4_»c_Ën_äom_disk
(
pde
->
»c_Ën
,

2325 
blocksize
) +

2326 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
,

2327 
blocksize
),

2328 
blocksize
);

2330 
de
->
šode
 = 0;

2331 
	`šode_šc_iv”siÚ
(
dœ
);

2334 
i
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
blocksize
);

2335 
pde
 = 
de
;

2336 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
blocksize
);

2338  -
ENOENT
;

2339 
	}
}

2341 
	$ext4_d–‘e_’Œy
(
hªdË_t
 *
hªdË
,

2342 
šode
 *
dœ
,

2343 
ext4_dœ_’Œy_2
 *
de_d–
,

2344 
bufãr_h—d
 *
bh
)

2346 
”r
, 
csum_size
 = 0;

2348 ià(
	`ext4_has_šlše_d©a
(
dœ
)) {

2349 
has_šlše_d©a
 = 1;

2350 
”r
 = 
	`ext4_d–‘e_šlše_’Œy
(
hªdË
, 
dœ
, 
de_d–
, 
bh
,

2351 &
has_šlše_d©a
);

2352 ià(
has_šlše_d©a
)

2353  
”r
;

2356 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

2357 
csum_size
 = (
ext4_dœ_’Œy_
);

2359 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2360 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

2361 ià(
	`uÆik–y
(
”r
))

2362 
out
;

2364 
”r
 = 
	`ext4_g’”ic_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de_d–
,

2365 
bh
, bh->
b_d©a
,

2366 
dœ
->
i_sb
->
s_blocksize
, 
csum_size
);

2367 ià(
”r
)

2368 
out
;

2370 
	`BUFFER_TRACE
(
bh
, "callƒxt4_handle_dirty_metadata");

2371 
”r
 = 
	`ext4_hªdË_dœty_dœ’t_node
(
hªdË
, 
dœ
, 
bh
);

2372 ià(
	`uÆik–y
(
”r
))

2373 
out
;

2376 
out
:

2377 ià(
”r
 !ğ-
ENOENT
)

2378 
	`ext4_¡d_”rÜ
(
dœ
->
i_sb
, 
”r
);

2379  
”r
;

2380 
	}
}

2393 
	$ext4_šc_couÁ
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

2395 
	`šc_Æšk
(
šode
);

2396 ià(
	`is_dx
(
šode
) &&

2397 (
šode
->
i_Æšk
 > 
EXT4_LINK_MAX
 || inode->i_nlink == 2))

2398 
	`£t_Æšk
(
šode
, 1);

2399 
	}
}

2405 
	$ext4_dec_couÁ
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

2407 ià(!
	`S_ISDIR
(
šode
->
i_mode
è|| inode->
i_Æšk
 > 2)

2408 
	`drİ_Æšk
(
šode
);

2409 
	}
}

2412 
	$ext4_add_nÚdœ
(
hªdË_t
 *
hªdË
,

2413 
d’Œy
 *d’Œy, 
šode
 *inode)

2415 
”r
 = 
	`ext4_add_’Œy
(
hªdË
, 
d’Œy
, 
šode
);

2416 ià(!
”r
) {

2417 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2418 
	`uÆock_Ãw_šode
(
šode
);

2419 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

2422 
	`drİ_Æšk
(
šode
);

2423 
	`uÆock_Ãw_šode
(
šode
);

2424 
	`ut
(
šode
);

2425  
”r
;

2426 
	}
}

2436 
	$ext4_ü—‹
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
,

2437 
boŞ
 
exş
)

2439 
hªdË_t
 *
hªdË
;

2440 
šode
 *šode, *
šode_§ve
;

2441 
”r
, 
üed™s
, 
»Œ›s
 = 0;

2443 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

2444 ià(
”r
)

2445  
”r
;

2447 
üed™s
 = (
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

2448 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2449 
»Œy
:

2450 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
mode
, &
d’Œy
->
d_Çme
, 0,

2451 
NULL
, 
EXT4_HT_DIR
, 
üed™s
);

2452 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

2453 
”r
 = 
	`PTR_ERR
(
šode
);

2454 ià(!
	`IS_ERR
(
šode
)) {

2455 
šode
->
i_İ
 = &
ext4_fe_šode_İ”©iÚs
;

2456 
šode
->
i_fİ
 = &
ext4_fe_İ”©iÚs
;

2457 
	`ext4_£t_aİs
(
šode
);

2458 
šode_§ve
 = 
šode
;

2459 
	`ihŞd
(
šode_§ve
);

2460 
”r
 = 
	`ext4_add_nÚdœ
(
hªdË
, 
d’Œy
, 
šode
);

2461 
	`ext4_fc_Œack_ü—‹
(
šode_§ve
, 
d’Œy
);

2462 
	`ut
(
šode_§ve
);

2463 ià(!
”r
 && 
	`IS_DIRSYNC
(
dœ
))

2464 
	`ext4_hªdË_sync
(
hªdË
);

2466 ià(
hªdË
)

2467 
	`ext4_jouº®_¡İ
(
hªdË
);

2468 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

2469 
»Œy
;

2470  
”r
;

2471 
	}
}

2473 
	$ext4_mknod
(
šode
 *
dœ
, 
d’Œy
 *dentry,

2474 
umode_t
 
mode
, 
dev_t
 
rdev
)

2476 
hªdË_t
 *
hªdË
;

2477 
šode
 *šode, *
šode_§ve
;

2478 
”r
, 
üed™s
, 
»Œ›s
 = 0;

2480 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

2481 ià(
”r
)

2482  
”r
;

2484 
üed™s
 = (
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

2485 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2486 
»Œy
:

2487 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
mode
, &
d’Œy
->
d_Çme
, 0,

2488 
NULL
, 
EXT4_HT_DIR
, 
üed™s
);

2489 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

2490 
”r
 = 
	`PTR_ERR
(
šode
);

2491 ià(!
	`IS_ERR
(
šode
)) {

2492 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
rdev
);

2493 
šode
->
i_İ
 = &
ext4_¥ecŸl_šode_İ”©iÚs
;

2494 
šode_§ve
 = 
šode
;

2495 
	`ihŞd
(
šode_§ve
);

2496 
”r
 = 
	`ext4_add_nÚdœ
(
hªdË
, 
d’Œy
, 
šode
);

2497 ià(!
”r
)

2498 
	`ext4_fc_Œack_ü—‹
(
šode_§ve
, 
d’Œy
);

2499 
	`ut
(
šode_§ve
);

2500 ià(!
”r
 && 
	`IS_DIRSYNC
(
dœ
))

2501 
	`ext4_hªdË_sync
(
hªdË
);

2503 ià(
hªdË
)

2504 
	`ext4_jouº®_¡İ
(
hªdË
);

2505 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

2506 
»Œy
;

2507  
”r
;

2508 
	}
}

2510 
	$ext4_tmpfe
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

2512 
hªdË_t
 *
hªdË
;

2513 
šode
 *inode;

2514 
”r
, 
»Œ›s
 = 0;

2516 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

2517 ià(
”r
)

2518  
”r
;

2520 
»Œy
:

2521 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
mode
,

2522 
NULL
, 0, NULL,

2523 
EXT4_HT_DIR
,

2524 
	`EXT4_MAXQUOTAS_INIT_BLOCKS
(
dœ
->
i_sb
) +

2525 4 + 
EXT4_XATTR_TRANS_BLOCKS
);

2526 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

2527 
”r
 = 
	`PTR_ERR
(
šode
);

2528 ià(!
	`IS_ERR
(
šode
)) {

2529 
šode
->
i_İ
 = &
ext4_fe_šode_İ”©iÚs
;

2530 
šode
->
i_fİ
 = &
ext4_fe_İ”©iÚs
;

2531 
	`ext4_£t_aİs
(
šode
);

2532 
	`d_tmpfe
(
d’Œy
, 
šode
);

2533 
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

2534 ià(
”r
)

2535 
”r_uÆock_šode
;

2537 
	`ext4_fc_Œack_šode
(
šode
);

2538 
	`m¬k_šode_dœty
(
šode
);

2539 
	`uÆock_Ãw_šode
(
šode
);

2541 ià(
hªdË
)

2542 
	`ext4_jouº®_¡İ
(
hªdË
);

2543 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

2544 
»Œy
;

2545  
”r
;

2546 
”r_uÆock_šode
:

2547 
	`ext4_jouº®_¡İ
(
hªdË
);

2548 
	`uÆock_Ãw_šode
(
šode
);

2549  
”r
;

2550 
	}
}

2552 
ext4_dœ_’Œy_2
 *
	$ext4_š™_dÙ_dÙdÙ
(
šode
 *inode,

2553 
ext4_dœ_’Œy_2
 *
de
,

2554 
blocksize
, 
csum_size
,

2555 
·»Á_šo
, 
dÙdÙ_»®_Ën
)

2557 
de
->
šode
 = 
	`ıu_to_Ë32
(šode->
i_šo
);

2558 
de
->
Çme_Ën
 = 1;

2559 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
	`EXT4_DIR_REC_LEN
(de->
Çme_Ën
),

2560 
blocksize
);

2561 
	`¡rıy
(
de
->
Çme
, ".");

2562 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, 
de
, 
S_IFDIR
);

2564 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
blocksize
);

2565 
de
->
šode
 = 
	`ıu_to_Ë32
(
·»Á_šo
);

2566 
de
->
Çme_Ën
 = 2;

2567 ià(!
dÙdÙ_»®_Ën
)

2568 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(
blocksize
 -

2569 (
csum_size
 + 
	`EXT4_DIR_REC_LEN
(1)),

2570 
blocksize
);

2572 
de
->
»c_Ën
 = 
	`ext4_»c_Ën_to_disk
(

2573 
	`EXT4_DIR_REC_LEN
(
de
->
Çme_Ën
), 
blocksize
);

2574 
	`¡rıy
(
de
->
Çme
, "..");

2575 
	`ext4_£t_de_ty³
(
šode
->
i_sb
, 
de
, 
S_IFDIR
);

2577  
	`ext4_Ãxt_’Œy
(
de
, 
blocksize
);

2578 
	}
}

2580 
	$ext4_š™_Ãw_dœ
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

2581 
šode
 *inode)

2583 
bufãr_h—d
 *
dœ_block
 = 
NULL
;

2584 
ext4_dœ_’Œy_2
 *
de
;

2585 
ext4_dœ_’Œy_
 *
t
;

2586 
ext4_lblk_t
 
block
 = 0;

2587 
blocksize
 = 
dœ
->
i_sb
->
s_blocksize
;

2588 
csum_size
 = 0;

2589 
”r
;

2591 ià(
	`ext4_has_m‘ad©a_csum
(
dœ
->
i_sb
))

2592 
csum_size
 = (
ext4_dœ_’Œy_
);

2594 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_MAY_INLINE_DATA
)) {

2595 
”r
 = 
	`ext4_Œy_ü—‹_šlše_dœ
(
hªdË
, 
dœ
, 
šode
);

2596 ià(
”r
 < 0 &&ƒ¼ !ğ-
ENOSPC
)

2597 
out
;

2598 ià(!
”r
)

2599 
out
;

2602 
šode
->
i_size
 = 0;

2603 
dœ_block
 = 
	`ext4_­³nd
(
hªdË
, 
šode
, &
block
);

2604 ià(
	`IS_ERR
(
dœ_block
))

2605  
	`PTR_ERR
(
dœ_block
);

2606 
de
 = (
ext4_dœ_’Œy_2
 *)
dœ_block
->
b_d©a
;

2607 
	`ext4_š™_dÙ_dÙdÙ
(
šode
, 
de
, 
blocksize
, 
csum_size
, 
dœ
->
i_šo
, 0);

2608 
	`£t_Æšk
(
šode
, 2);

2609 ià(
csum_size
) {

2610 
t
 = 
	`EXT4_DIRENT_TAIL
(
dœ_block
->
b_d©a
, 
blocksize
);

2611 
	`š™Ÿlize_dœ’t_
(
t
, 
blocksize
);

2614 
	`BUFFER_TRACE
(
dœ_block
, "callƒxt4_handle_dirty_metadata");

2615 
”r
 = 
	`ext4_hªdË_dœty_dœ’t_node
(
hªdË
, 
šode
, 
dœ_block
);

2616 ià(
”r
)

2617 
out
;

2618 
	`£t_bufãr_v”if›d
(
dœ_block
);

2619 
out
:

2620 
	`b»l£
(
dœ_block
);

2621  
”r
;

2622 
	}
}

2624 
	$ext4_mkdœ
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

2626 
hªdË_t
 *
hªdË
;

2627 
šode
 *inode;

2628 
”r
, 
üed™s
, 
»Œ›s
 = 0;

2630 ià(
	`EXT4_DIR_LINK_MAX
(
dœ
))

2631  -
EMLINK
;

2633 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

2634 ià(
”r
)

2635  
”r
;

2637 
üed™s
 = (
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

2638 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2639 
»Œy
:

2640 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
S_IFDIR
 | 
mode
,

2641 &
d’Œy
->
d_Çme
,

2642 0, 
NULL
, 
EXT4_HT_DIR
, 
üed™s
);

2643 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

2644 
”r
 = 
	`PTR_ERR
(
šode
);

2645 ià(
	`IS_ERR
(
šode
))

2646 
out_¡İ
;

2648 
šode
->
i_İ
 = &
ext4_dœ_šode_İ”©iÚs
;

2649 
šode
->
i_fİ
 = &
ext4_dœ_İ”©iÚs
;

2650 
”r
 = 
	`ext4_š™_Ãw_dœ
(
hªdË
, 
dœ
, 
šode
);

2651 ià(
”r
)

2652 
out_ş—r_šode
;

2653 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2654 ià(!
”r
)

2655 
”r
 = 
	`ext4_add_’Œy
(
hªdË
, 
d’Œy
, 
šode
);

2656 ià(
”r
) {

2657 
out_ş—r_šode
:

2658 
	`ş—r_Æšk
(
šode
);

2659 
	`uÆock_Ãw_šode
(
šode
);

2660 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2661 
	`ut
(
šode
);

2662 
out_¡İ
;

2664 
	`ext4_fc_Œack_ü—‹
(
šode
, 
d’Œy
);

2665 
	`ext4_šc_couÁ
(
hªdË
, 
dœ
);

2666 
	`ext4_upd©e_dx_æag
(
dœ
);

2667 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

2668 ià(
”r
)

2669 
out_ş—r_šode
;

2670 
	`uÆock_Ãw_šode
(
šode
);

2671 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

2672 ià(
	`IS_DIRSYNC
(
dœ
))

2673 
	`ext4_hªdË_sync
(
hªdË
);

2675 
out_¡İ
:

2676 ià(
hªdË
)

2677 
	`ext4_jouº®_¡İ
(
hªdË
);

2678 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

2679 
»Œy
;

2680  
”r
;

2681 
	}
}

2686 
boŞ
 
	$ext4_em±y_dœ
(
šode
 *inode)

2688 
off£t
;

2689 
bufãr_h—d
 *
bh
;

2690 
ext4_dœ_’Œy_2
 *
de
, *
de1
;

2691 
su³r_block
 *
sb
;

2693 ià(
	`ext4_has_šlše_d©a
(
šode
)) {

2694 
has_šlše_d©a
 = 1;

2695 
»t
;

2697 
»t
 = 
	`em±y_šlše_dœ
(
šode
, &
has_šlše_d©a
);

2698 ià(
has_šlše_d©a
)

2699  
»t
;

2702 
sb
 = 
šode
->
i_sb
;

2703 ià(
šode
->
i_size
 < 
	`EXT4_DIR_REC_LEN
(1) + EXT4_DIR_REC_LEN(2)) {

2704 
	`EXT4_ERROR_INODE
(
šode
, "invalid size");

2705  
Œue
;

2707 
bh
 = 
	`ext4_»ad_dœblock
(
šode
, 0, 
EITHER
);

2708 ià(
	`IS_ERR
(
bh
))

2709  
Œue
;

2711 
de
 = (
ext4_dœ_’Œy_2
 *è
bh
->
b_d©a
;

2712 
de1
 = 
	`ext4_Ãxt_’Œy
(
de
, 
sb
->
s_blocksize
);

2713 ià(
	`Ë32_to_ıu
(
de
->
šode
è!ğšode->
i_šo
 ||

2714 
	`Ë32_to_ıu
(
de1
->
šode
) == 0 ||

2715 
	`¡rcmp
(".", 
de
->
Çme
è|| sŒcmp("..", 
de1
->name)) {

2716 
	`ext4_w¬nšg_šode
(
šode
, "directory missing '.'‡nd/or '..'");

2717 
	`b»l£
(
bh
);

2718  
Œue
;

2720 
off£t
 = 
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
sb
->
s_blocksize
) +

2721 
	`ext4_»c_Ën_äom_disk
(
de1
->
»c_Ën
, 
sb
->
s_blocksize
);

2722 
de
 = 
	`ext4_Ãxt_’Œy
(
de1
, 
sb
->
s_blocksize
);

2723 
off£t
 < 
šode
->
i_size
) {

2724 ià((*è
de
 >ğ(*è(
bh
->
b_d©a
+
sb
->
s_blocksize
)) {

2725 
lblock
;

2726 
	`b»l£
(
bh
);

2727 
lblock
 = 
off£t
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

2728 
bh
 = 
	`ext4_»ad_dœblock
(
šode
, 
lblock
, 
EITHER
);

2729 ià(
	`IS_ERR
(
bh
))

2730  
Œue
;

2731 
de
 = (
ext4_dœ_’Œy_2
 *è
bh
->
b_d©a
;

2733 ià(
	`ext4_check_dœ_’Œy
(
šode
, 
NULL
, 
de
, 
bh
,

2734 
bh
->
b_d©a
, bh->
b_size
, 
off£t
)) {

2735 
de
 = (
ext4_dœ_’Œy_2
 *)(
bh
->
b_d©a
 +

2736 
sb
->
s_blocksize
);

2737 
off£t
 = (off£ˆ| (
sb
->
s_blocksize
 - 1)) + 1;

2740 ià(
	`Ë32_to_ıu
(
de
->
šode
)) {

2741 
	`b»l£
(
bh
);

2742  
çl£
;

2744 
off£t
 +ğ
	`ext4_»c_Ën_äom_disk
(
de
->
»c_Ën
, 
sb
->
s_blocksize
);

2745 
de
 = 
	`ext4_Ãxt_’Œy
(de, 
sb
->
s_blocksize
);

2747 
	`b»l£
(
bh
);

2748  
Œue
;

2749 
	}
}

2763 
	$ext4_Üphª_add
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

2765 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

2766 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2767 
ext4_oc
 
oc
;

2768 
”r
 = 0, 
rc
;

2769 
boŞ
 
dœty
 = 
çl£
;

2771 ià(!
sbi
->
s_jouº®
 || 
	`is_bad_šode
(
šode
))

2774 
	`WARN_ON_ONCE
(!(
šode
->
i_¡©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2775 !
	`šode_is_locked
(
šode
));

2780 ià(!
	`li¡_em±y
(&
	`EXT4_I
(
šode
)->
i_Üphª
))

2789 
	`J_ASSERT
((
	`S_ISREG
(
šode
->
i_mode
è|| 
	`S_ISDIR
(inode->i_mode) ||

2790 
	`S_ISLNK
(
šode
->
i_mode
)è|| inode->
i_Æšk
 == 0);

2792 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

2793 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

2794 ià(
”r
)

2795 
out
;

2797 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

2798 ià(
”r
)

2799 
out
;

2801 
	`mu‹x_lock
(&
sbi
->
s_Üphª_lock
);

2806 ià(!
	`NEXT_ORPHAN
(
šode
) || NEXT_ORPHAN(inode) >

2807 (
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_šodes_couÁ
))) {

2809 
	`NEXT_ORPHAN
(
šode
èğ
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_Ï¡_Üphª
);

2810 
sbi
->
s_es
->
s_Ï¡_Üphª
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

2811 
dœty
 = 
Œue
;

2813 
	`li¡_add
(&
	`EXT4_I
(
šode
)->
i_Üphª
, &
sbi
->
s_Üphª
);

2814 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

2816 ià(
dœty
) {

2817 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

2818 
rc
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

2819 ià(!
”r
)

2820 
”r
 = 
rc
;

2821 ià(
”r
) {

2827 
	`mu‹x_lock
(&
sbi
->
s_Üphª_lock
);

2828 
	`li¡_d–_š™
(&
	`EXT4_I
(
šode
)->
i_Üphª
);

2829 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

2832 
	`jbd_debug
(4, "su³rblock wÈpošˆtØ%lu\n", 
šode
->
i_šo
);

2833 
	`jbd_debug
(4, "orphan inode %lu will…ointo %d\n",

2834 
šode
->
i_šo
, 
	`NEXT_ORPHAN
(inode));

2835 
out
:

2836 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

2837  
”r
;

2838 
	}
}

2844 
	$ext4_Üphª_d–
(
hªdË_t
 *
hªdË
, 
šode
 *inode)

2846 
li¡_h—d
 *
´ev
;

2847 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

2848 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2849 
__u32
 
šo_Ãxt
;

2850 
ext4_oc
 
oc
;

2851 
”r
 = 0;

2853 ià(!
sbi
->
s_jouº®
 && !(sbi->
s_mouÁ_¡©e
 & 
EXT4_ORPHAN_FS
))

2856 
	`WARN_ON_ONCE
(!(
šode
->
i_¡©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2857 !
	`šode_is_locked
(
šode
));

2859 ià(
	`li¡_em±y
(&
ei
->
i_Üphª
))

2862 ià(
hªdË
) {

2864 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

2867 
	`mu‹x_lock
(&
sbi
->
s_Üphª_lock
);

2868 
	`jbd_debug
(4, "»movšod%lu from o½hª†i¡\n", 
šode
->
i_šo
);

2870 
´ev
 = 
ei
->
i_Üphª
.prev;

2871 
	`li¡_d–_š™
(&
ei
->
i_Üphª
);

2877 ià(!
hªdË
 || 
”r
) {

2878 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

2879 
out_”r
;

2882 
šo_Ãxt
 = 
	`NEXT_ORPHAN
(
šode
);

2883 ià(
´ev
 =ğ&
sbi
->
s_Üphª
) {

2884 
	`jbd_debug
(4, "su³rblock wÈpošˆtØ%u\n", 
šo_Ãxt
);

2885 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

2886 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

2887 ià(
”r
) {

2888 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

2889 
out_b»l£
;

2891 
sbi
->
s_es
->
s_Ï¡_Üphª
 = 
	`ıu_to_Ë32
(
šo_Ãxt
);

2892 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

2893 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
šode
->
i_sb
);

2895 
ext4_oc
 
oc2
;

2896 
šode
 *
i_´ev
 =

2897 &
	`li¡_’Œy
(
´ev
, 
ext4_šode_šfo
, 
i_Üphª
)->
vfs_šode
;

2899 
	`jbd_debug
(4, "orphan inode %lu will…ointo %u\n",

2900 
i_´ev
->
i_šo
, 
šo_Ãxt
);

2901 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
i_´ev
, &
oc2
);

2902 ià(
”r
) {

2903 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

2904 
out_b»l£
;

2906 
	`NEXT_ORPHAN
(
i_´ev
èğ
šo_Ãxt
;

2907 
”r
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
i_´ev
, &
oc2
);

2908 
	`mu‹x_uÆock
(&
sbi
->
s_Üphª_lock
);

2910 ià(
”r
)

2911 
out_b»l£
;

2912 
	`NEXT_ORPHAN
(
šode
) = 0;

2913 
”r
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

2914 
out_”r
:

2915 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”r
);

2916  
”r
;

2918 
out_b»l£
:

2919 
	`b»l£
(
oc
.
bh
);

2920 
out_”r
;

2921 
	}
}

2923 
	$ext4_rmdœ
(
šode
 *
dœ
, 
d’Œy
 *dentry)

2925 
»tv®
;

2926 
šode
 *inode;

2927 
bufãr_h—d
 *
bh
;

2928 
ext4_dœ_’Œy_2
 *
de
;

2929 
hªdË_t
 *
hªdË
 = 
NULL
;

2931 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
dœ
->
i_sb
))))

2932  -
EIO
;

2936 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

2937 ià(
»tv®
)

2938  
»tv®
;

2939 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
	`d_šode
(
d’Œy
));

2940 ià(
»tv®
)

2941  
»tv®
;

2943 
»tv®
 = -
ENOENT
;

2944 
bh
 = 
	`ext4_fšd_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, &
de
, 
NULL
);

2945 ià(
	`IS_ERR
(
bh
))

2946  
	`PTR_ERR
(
bh
);

2947 ià(!
bh
)

2948 
’d_rmdœ
;

2950 
šode
 = 
	`d_šode
(
d’Œy
);

2952 
»tv®
 = -
EFSCORRUPTED
;

2953 ià(
	`Ë32_to_ıu
(
de
->
šode
è!ğšode->
i_šo
)

2954 
’d_rmdœ
;

2956 
»tv®
 = -
ENOTEMPTY
;

2957 ià(!
	`ext4_em±y_dœ
(
šode
))

2958 
’d_rmdœ
;

2960 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
dœ
, 
EXT4_HT_DIR
,

2961 
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
));

2962 ià(
	`IS_ERR
(
hªdË
)) {

2963 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

2964 
hªdË
 = 
NULL
;

2965 
’d_rmdœ
;

2968 ià(
	`IS_DIRSYNC
(
dœ
))

2969 
	`ext4_hªdË_sync
(
hªdË
);

2971 
»tv®
 = 
	`ext4_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de
, 
bh
);

2972 ià(
»tv®
)

2973 
’d_rmdœ
;

2974 ià(!
	`EXT4_DIR_LINK_EMPTY
(
šode
))

2975 
	`ext4_w¬nšg_šode
(
šode
,

2977 
d’Œy
->
d_Çme
.
Ën
, d’Œy->d_Çme.
Çme
,

2978 
šode
->
i_Æšk
);

2979 
šode
->
i_v”siÚ
++;

2980 
	`ş—r_Æšk
(
šode
);

2984 
šode
->
i_size
 = 0;

2985 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

2986 
šode
->
i_ùime
 = 
dœ
->i_ùimğdœ->
i_mtime
 = 
	`cu¼’t_time
(inode);

2987 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2988 
	`ext4_dec_couÁ
(
hªdË
, 
dœ
);

2989 
	`ext4_upd©e_dx_æag
(
dœ
);

2990 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

2992 
’d_rmdœ
:

2993 
	`b»l£
(
bh
);

2994 ià(
hªdË
)

2995 
	`ext4_jouº®_¡İ
(
hªdË
);

2996  
»tv®
;

2997 
	}
}

2999 
	$__ext4_uÆšk
(
šode
 *
dœ
, cÚ¡ 
q¡r
 *
d_Çme
,

3000 
šode
 *inode)

3002 
bufãr_h—d
 *
bh
;

3003 
ext4_dœ_’Œy_2
 *
de
;

3004 
hªdË_t
 *
hªdË
 = 
NULL
;

3005 
»tv®
 = -
ENOENT
;

3006 
sk_»move_d’Œy
 = 0;

3008 
bh
 = 
	`ext4_fšd_’Œy
(
dœ
, 
d_Çme
, &
de
, 
NULL
);

3009 ià(
	`IS_ERR
(
bh
))

3010  
	`PTR_ERR
(
bh
);

3012 ià(!
bh
) {

3013 
»tv®
 = -
ENOENT
;

3014 
’d_uÆšk
;

3017 
»tv®
 = -
EFSCORRUPTED
;

3018 ià(
	`Ë32_to_ıu
(
de
->
šode
è!ğšode->
i_šo
) {

3024 ià(
	`EXT4_SB
(
šode
->
i_sb
)->
s_mouÁ_¡©e
 & 
EXT4_FC_REPLAY
)

3025 
sk_»move_d’Œy
 = 1;

3027 
’d_uÆšk
;

3030 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
dœ
, 
EXT4_HT_DIR
,

3031 
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
));

3032 ià(
	`IS_ERR
(
hªdË
)) {

3033 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

3034 
hªdË
 = 
NULL
;

3035 
’d_uÆšk
;

3038 ià(
	`IS_DIRSYNC
(
dœ
))

3039 
	`ext4_hªdË_sync
(
hªdË
);

3041 ià(
šode
->
i_Æšk
 == 0) {

3042 
	`ext4_w¬nšg_šode
(
šode
, "Deleting file '%.*s' with‚o†inks",

3043 
d_Çme
->
Ën
, d_Çme->
Çme
);

3044 
	`£t_Æšk
(
šode
, 1);

3046 ià(!
sk_»move_d’Œy
) {

3047 
»tv®
 = 
	`ext4_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de
, 
bh
);

3048 ià(
»tv®
)

3049 
’d_uÆšk
;

3050 
dœ
->
i_ùime
 = dœ->
i_mtime
 = 
	`cu¼’t_time
(dir);

3051 
	`ext4_upd©e_dx_æag
(
dœ
);

3052 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
dœ
);

3054 
»tv®
 = 0;

3056 
	`drİ_Æšk
(
šode
);

3057 ià(!
šode
->
i_Æšk
)

3058 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

3059 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

3060 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3062 
’d_uÆšk
:

3063 
	`b»l£
(
bh
);

3064 ià(
hªdË
)

3065 
	`ext4_jouº®_¡İ
(
hªdË
);

3066  
»tv®
;

3067 
	}
}

3069 
	$ext4_uÆšk
(
šode
 *
dœ
, 
d’Œy
 *dentry)

3071 
»tv®
;

3073 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
dœ
->
i_sb
))))

3074  -
EIO
;

3076 
	`Œaû_ext4_uÆšk_’‹r
(
dœ
, 
d’Œy
);

3081 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

3082 ià(
»tv®
)

3083  
»tv®
;

3084 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
	`d_šode
(
d’Œy
));

3085 ià(
»tv®
)

3086  
»tv®
;

3088 
»tv®
 = 
	`__ext4_uÆšk
(
dœ
, &
d’Œy
->
d_Çme
, 
	`d_šode
(dentry));

3089 ià(!
»tv®
) {

3090 
	`ext4_fc_Œack_uÆšk
(
	`d_šode
(
d’Œy
), dentry);

3093 
	`Œaû_ext4_uÆšk_ex™
(
d’Œy
, 
»tv®
);

3094  
»tv®
;

3095 
	}
}

3097 
	$ext4_symlšk
(
šode
 *
dœ
,

3098 
d’Œy
 *d’Œy, cÚ¡ *
symÇme
)

3100 
hªdË_t
 *
hªdË
;

3101 
šode
 *inode;

3102 
”r
, 
Ën
 = 
	`¡¾’
(
symÇme
);

3103 
üed™s
;

3104 
boŞ
 
’üy±iÚ_»quœed
;

3105 
fsüy±_¡r
 
disk_lšk
;

3106 
fsüy±_symlšk_d©a
 *
sd
 = 
NULL
;

3108 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
dœ
->
i_sb
))))

3109  -
EIO
;

3111 
disk_lšk
.
Ën
 =†en + 1;

3112 
disk_lšk
.
Çme
 = (*è
symÇme
;

3114 
’üy±iÚ_»quœed
 = (
	`ext4_’üy±ed_šode
(
dœ
) ||

3115 
	`DUMMY_ENCRYPTION_ENABLED
(
	`EXT4_SB
(
dœ
->
i_sb
)));

3116 ià(
’üy±iÚ_»quœed
) {

3117 
”r
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
dœ
);

3118 ià(
”r
)

3119  
”r
;

3120 ià(!
	`fsüy±_has_’üy±iÚ_key
(
dœ
))

3121  -
ENOKEY
;

3122 
disk_lšk
.
Ën
 = (
	`fsüy±_âame_’üy±ed_size
(
dœ
,†en) +

3123 (
fsüy±_symlšk_d©a
));

3124 
sd
 = 
	`kz®loc
(
disk_lšk
.
Ën
, 
GFP_KERNEL
);

3125 ià(!
sd
)

3126  -
ENOMEM
;

3129 ià(
disk_lšk
.
Ën
 > 
dœ
->
i_sb
->
s_blocksize
) {

3130 
”r
 = -
ENAMETOOLONG
;

3131 
”r_ä“_sd
;

3134 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

3135 ià(
”r
)

3136 
”r_ä“_sd
;

3138 ià((
disk_lšk
.
Ën
 > 
EXT4_N_BLOCKS
 * 4)) {

3145 
üed™s
 = 4 + 
	`EXT4_MAXQUOTAS_INIT_BLOCKS
(
dœ
->
i_sb
) +

3146 
EXT4_XATTR_TRANS_BLOCKS
;

3154 
üed™s
 = 
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

3155 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3;

3158 
šode
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
dœ
, 
S_IFLNK
|
S_IRWXUGO
,

3159 &
d’Œy
->
d_Çme
, 0, 
NULL
,

3160 
EXT4_HT_DIR
, 
üed™s
);

3161 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

3162 ià(
	`IS_ERR
(
šode
)) {

3163 ià(
hªdË
)

3164 
	`ext4_jouº®_¡İ
(
hªdË
);

3165 
”r
 = 
	`PTR_ERR
(
šode
);

3166 
”r_ä“_sd
;

3169 ià(
’üy±iÚ_»quœed
) {

3170 
q¡r
 
i¡r
;

3171 
fsüy±_¡r
 
o¡r
 =

3172 
	`FSTR_INIT
(
sd
->
’üy±ed_·th
, 
disk_lšk
.
Ën
);

3174 
i¡r
.
Çme
 = (cÚ¡ *è
symÇme
;

3175 
i¡r
.
Ën
 =†en;

3176 
”r
 = 
	`fsüy±_âame_u¤_to_disk
(
šode
, &
i¡r
, &
o¡r
);

3177 ià(
”r
)

3178 
”r_drİ_šode
;

3179 
sd
->
Ën
 = 
	`ıu_to_Ë16
(
o¡r
.len);

3180 
disk_lšk
.
Çme
 = (*è
sd
;

3181 
šode
->
i_İ
 = &
ext4_’üy±ed_symlšk_šode_İ”©iÚs
;

3184 ià((
disk_lšk
.
Ën
 > 
EXT4_N_BLOCKS
 * 4)) {

3185 ià(!
’üy±iÚ_»quœed
)

3186 
šode
->
i_İ
 = &
ext4_symlšk_šode_İ”©iÚs
;

3187 
	`šode_nohighmem
(
šode
);

3188 
	`ext4_£t_aİs
(
šode
);

3199 
	`drİ_Æšk
(
šode
);

3200 
”r
 = 
	`ext4_Üphª_add
(
hªdË
, 
šode
);

3201 
	`ext4_jouº®_¡İ
(
hªdË
);

3202 
hªdË
 = 
NULL
;

3203 ià(
”r
)

3204 
”r_drİ_šode
;

3205 
”r
 = 
	`__·ge_symlšk
(
šode
, 
disk_lšk
.
Çme
, disk_lšk.
Ën
, 1);

3206 ià(
”r
)

3207 
”r_drİ_šode
;

3212 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
dœ
, 
EXT4_HT_DIR
,

3213 
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

3214 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 1);

3215 ià(
	`IS_ERR
(
hªdË
)) {

3216 
”r
 = 
	`PTR_ERR
(
hªdË
);

3217 
hªdË
 = 
NULL
;

3218 
”r_drİ_šode
;

3220 
	`£t_Æšk
(
šode
, 1);

3221 
”r
 = 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

3222 ià(
”r
)

3223 
”r_drİ_šode
;

3226 
	`ext4_ş—r_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
);

3227 ià(!
’üy±iÚ_»quœed
) {

3228 
šode
->
i_İ
 = &
ext4_ç¡_symlšk_šode_İ”©iÚs
;

3229 
šode
->
i_lšk
 = (*)&
	`EXT4_I
(šode)->
i_d©a
;

3231 
	`memıy
((*)&
	`EXT4_I
(
šode
)->
i_d©a
, 
disk_lšk
.
Çme
,

3232 
disk_lšk
.
Ën
);

3233 
šode
->
i_size
 = 
disk_lšk
.
Ën
 - 1;

3235 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_size
;

3236 
”r
 = 
	`ext4_add_nÚdœ
(
hªdË
, 
d’Œy
, 
šode
);

3237 ià(!
”r
 && 
	`IS_DIRSYNC
(
dœ
))

3238 
	`ext4_hªdË_sync
(
hªdË
);

3240 ià(
hªdË
)

3241 
	`ext4_jouº®_¡İ
(
hªdË
);

3242 
	`kä“
(
sd
);

3243  
”r
;

3244 
”r_drİ_šode
:

3245 ià(
hªdË
)

3246 
	`ext4_jouº®_¡İ
(
hªdË
);

3247 
	`ş—r_Æšk
(
šode
);

3248 
	`uÆock_Ãw_šode
(
šode
);

3249 
	`ut
(
šode
);

3250 
”r_ä“_sd
:

3251 
	`kä“
(
sd
);

3252  
”r
;

3253 
	}
}

3255 
	$__ext4_lšk
(
šode
 *
dœ
, šod*šode, 
d’Œy
 *dentry)

3257 
hªdË_t
 *
hªdË
;

3258 
”r
, 
»Œ›s
 = 0;

3259 
»Œy
:

3260 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
dœ
, 
EXT4_HT_DIR
,

3261 (
	`EXT4_DATA_TRANS_BLOCKS
(
dœ
->
i_sb
) +

3262 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
) + 1);

3263 ià(
	`IS_ERR
(
hªdË
))

3264  
	`PTR_ERR
(
hªdË
);

3266 ià(
	`IS_DIRSYNC
(
dœ
))

3267 
	`ext4_hªdË_sync
(
hªdË
);

3269 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

3270 
	`ext4_šc_couÁ
(
hªdË
, 
šode
);

3271 
	`ihŞd
(
šode
);

3273 
”r
 = 
	`ext4_add_’Œy
(
hªdË
, 
d’Œy
, 
šode
);

3274 ià(!
”r
) {

3275 
	`ext4_fc_Œack_lšk
(
šode
, 
d’Œy
);

3276 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

3280 ià(
šode
->
i_Æšk
 == 1)

3281 
	`ext4_Üphª_d–
(
hªdË
, 
šode
);

3282 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

3284 
	`drİ_Æšk
(
šode
);

3285 
	`ut
(
šode
);

3287 
	`ext4_jouº®_¡İ
(
hªdË
);

3288 ià(
”r
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
dœ
->
i_sb
, &
»Œ›s
))

3289 
»Œy
;

3290  
”r
;

3291 
	}
}

3293 
	$ext4_lšk
(
d’Œy
 *
Şd_d’Œy
,

3294 
šode
 *
dœ
, 
d’Œy
 *dentry)

3296 
šode
 *šodğ
	`d_šode
(
Şd_d’Œy
);

3297 
”r
;

3299 ià(
šode
->
i_Æšk
 >ğ
EXT4_LINK_MAX
)

3300  -
EMLINK
;

3302 ià(
	`ext4_’üy±ed_šode
(
dœ
è&& !
	`fsüy±_has_³rm™‹d_cÚ‹xt
(dœ, 
šode
))

3303  -
EPERM
;

3305 ià((
	`ext4_‹¡_šode_æag
(
dœ
, 
EXT4_INODE_PROJINHERIT
)) &&

3306 (!
	`´ojid_eq
(
	`EXT4_I
(
dœ
)->
i_´ojid
,

3307 
	`EXT4_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)))

3308  -
EXDEV
;

3310 
”r
 = 
	`dquÙ_š™Ÿlize
(
dœ
);

3311 ià(
”r
)

3312  
”r
;

3313  
	`__ext4_lšk
(
dœ
, 
šode
, 
d’Œy
);

3314 
	}
}

3322 
bufãr_h—d
 *
	$ext4_g‘_fœ¡_dœ_block
(
hªdË_t
 *
hªdË
,

3323 
šode
 *inode,

3324 *
»tv®
,

3325 
ext4_dœ_’Œy_2
 **
·»Á_de
,

3326 *
šlšed
)

3328 
bufãr_h—d
 *
bh
;

3330 ià(!
	`ext4_has_šlše_d©a
(
šode
)) {

3331 
bh
 = 
	`ext4_»ad_dœblock
(
šode
, 0, 
EITHER
);

3332 ià(
	`IS_ERR
(
bh
)) {

3333 *
»tv®
 = 
	`PTR_ERR
(
bh
);

3334  
NULL
;

3336 *
·»Á_de
 = 
	`ext4_Ãxt_’Œy
(

3337 (
ext4_dœ_’Œy_2
 *)
bh
->
b_d©a
,

3338 
šode
->
i_sb
->
s_blocksize
);

3339  
bh
;

3342 *
šlšed
 = 1;

3343  
	`ext4_g‘_fœ¡_šlše_block
(
šode
, 
·»Á_de
, 
»tv®
);

3344 
	}
}

3346 
	sext4_»Çm’t
 {

3347 
šode
 *
	mdœ
;

3348 
d’Œy
 *
	md’Œy
;

3349 
šode
 *
	mšode
;

3350 
boŞ
 
	mis_dœ
;

3351 
	mdœ_Æšk_d–
;

3354 
bufãr_h—d
 *
	mbh
;

3355 
ext4_dœ_’Œy_2
 *
	mde
;

3356 
	mšlšed
;

3359 
bufãr_h—d
 *
	mdœ_bh
;

3360 
ext4_dœ_’Œy_2
 *
	m·»Á_de
;

3361 
	mdœ_šlšed
;

3364 
	$ext4_»Çme_dœ_´•¬e
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
)

3366 
»tv®
;

3368 
’t
->
dœ_bh
 = 
	`ext4_g‘_fœ¡_dœ_block
(
hªdË
,ƒÁ->
šode
,

3369 &
»tv®
, &
’t
->
·»Á_de
,

3370 &
’t
->
dœ_šlšed
);

3371 ià(!
’t
->
dœ_bh
)

3372  
»tv®
;

3373 ià(
	`Ë32_to_ıu
(
’t
->
·»Á_de
->
šode
è!ğ’t->
dœ
->
i_šo
)

3374  -
EFSCORRUPTED
;

3375 
	`BUFFER_TRACE
(
’t
->
dœ_bh
, "get_write_access");

3376  
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
’t
->
dœ_bh
);

3377 
	}
}

3379 
	$ext4_»Çme_dœ_fšish
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
,

3380 
dœ_šo
)

3382 
»tv®
;

3384 
’t
->
·»Á_de
->
šode
 = 
	`ıu_to_Ë32
(
dœ_šo
);

3385 
	`BUFFER_TRACE
(
’t
->
dœ_bh
, "callƒxt4_handle_dirty_metadata");

3386 ià(!
’t
->
dœ_šlšed
) {

3387 ià(
	`is_dx
(
’t
->
šode
)) {

3388 
»tv®
 = 
	`ext4_hªdË_dœty_dx_node
(
hªdË
,

3389 
’t
->
šode
,

3390 
’t
->
dœ_bh
);

3392 
»tv®
 = 
	`ext4_hªdË_dœty_dœ’t_node
(
hªdË
,

3393 
’t
->
šode
,

3394 
’t
->
dœ_bh
);

3397 
»tv®
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
’t
->
šode
);

3399 ià(
»tv®
) {

3400 
	`ext4_¡d_”rÜ
(
’t
->
dœ
->
i_sb
, 
»tv®
);

3401  
»tv®
;

3404 
	}
}

3406 
	$ext4_£‹Á
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
,

3407 
šo
, 
fe_ty³
)

3409 
»tv®
;

3411 
	`BUFFER_TRACE
(
’t
->
bh
, "get write‡ccess");

3412 
»tv®
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
’t
->
bh
);

3413 ià(
»tv®
)

3414  
»tv®
;

3415 
’t
->
de
->
šode
 = 
	`ıu_to_Ë32
(
šo
);

3416 ià(
	`ext4_has_ã©u»_f‘y³
(
’t
->
dœ
->
i_sb
))

3417 
’t
->
de
->
fe_ty³
 = file_type;

3418 
’t
->
dœ
->
i_v”siÚ
++;

3419 
’t
->
dœ
->
i_ùime
 =ƒÁ->dœ->
i_mtime
 =

3420 
	`cu¼’t_time
(
’t
->
dœ
);

3421 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
’t
->
dœ
);

3422 
	`BUFFER_TRACE
(
’t
->
bh
, "callƒxt4_handle_dirty_metadata");

3423 ià(!
’t
->
šlšed
) {

3424 
»tv®
 = 
	`ext4_hªdË_dœty_dœ’t_node
(
hªdË
,

3425 
’t
->
dœ
,ƒÁ->
bh
);

3426 ià(
	`uÆik–y
(
»tv®
)) {

3427 
	`ext4_¡d_”rÜ
(
’t
->
dœ
->
i_sb
, 
»tv®
);

3428  
»tv®
;

3431 
	`b»l£
(
’t
->
bh
);

3432 
’t
->
bh
 = 
NULL
;

3435 
	}
}

3437 
	$ext4_fšd_d–‘e_’Œy
(
hªdË_t
 *
hªdË
, 
šode
 *
dœ
,

3438 cÚ¡ 
q¡r
 *
d_Çme
)

3440 
»tv®
 = -
ENOENT
;

3441 
bufãr_h—d
 *
bh
;

3442 
ext4_dœ_’Œy_2
 *
de
;

3444 
bh
 = 
	`ext4_fšd_’Œy
(
dœ
, 
d_Çme
, &
de
, 
NULL
);

3445 ià(
	`IS_ERR
(
bh
))

3446  
	`PTR_ERR
(
bh
);

3447 ià(
bh
) {

3448 
»tv®
 = 
	`ext4_d–‘e_’Œy
(
hªdË
, 
dœ
, 
de
, 
bh
);

3449 
	`b»l£
(
bh
);

3451  
»tv®
;

3452 
	}
}

3454 
	$ext4_»Çme_d–‘e
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
,

3455 
fÜû_»»ad
)

3457 
»tv®
;

3464 ià(
	`Ë32_to_ıu
(
’t
->
de
->
šode
è!ğ’t->šode->
i_šo
 ||

3465 
’t
->
de
->
Çme_Ën
 !ğ’t->
d’Œy
->
d_Çme
.
Ën
 ||

3466 
	`¡ºcmp
(
’t
->
de
->
Çme
,ƒÁ->
d’Œy
->
d_Çme
.name,

3467 
’t
->
de
->
Çme_Ën
) ||

3468 
fÜû_»»ad
) {

3469 
»tv®
 = 
	`ext4_fšd_d–‘e_’Œy
(
hªdË
, 
’t
->
dœ
,

3470 &
’t
->
d’Œy
->
d_Çme
);

3472 
»tv®
 = 
	`ext4_d–‘e_’Œy
(
hªdË
, 
’t
->
dœ
,ƒÁ->
de
,ƒÁ->
bh
);

3473 ià(
»tv®
 =ğ-
ENOENT
) {

3474 
»tv®
 = 
	`ext4_fšd_d–‘e_’Œy
(
hªdË
, 
’t
->
dœ
,

3475 &
’t
->
d’Œy
->
d_Çme
);

3479 ià(
»tv®
) {

3480 
	`ext4_w¬nšg_šode
(
’t
->
dœ
,

3482 
’t
->
dœ
->
i_Æšk
, 
»tv®
);

3484 
	}
}

3486 
	$ext4_upd©e_dœ_couÁ
(
hªdË_t
 *
hªdË
, 
ext4_»Çm’t
 *
’t
)

3488 ià(
’t
->
dœ_Æšk_d–
) {

3489 ià(
’t
->
dœ_Æšk_d–
 == -1)

3490 
	`ext4_dec_couÁ
(
hªdË
, 
’t
->
dœ
);

3492 
	`ext4_šc_couÁ
(
hªdË
, 
’t
->
dœ
);

3493 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
’t
->
dœ
);

3495 
	}
}

3497 
šode
 *
	$ext4_wh™eout_fÜ_»Çme
(
ext4_»Çm’t
 *
’t
,

3498 
üed™s
, 
hªdË_t
 **
h
)

3500 
šode
 *
wh
;

3501 
hªdË_t
 *
hªdË
;

3502 
»Œ›s
 = 0;

3508 
üed™s
 +ğ(
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
’t
->
dœ
->
i_sb
) +

3509 
EXT4_XATTR_TRANS_BLOCKS
 + 4);

3510 
»Œy
:

3511 
wh
 = 
	`ext4_Ãw_šode_¡¬t_hªdË
(
’t
->
dœ
, 
S_IFCHR
 | 
WHITEOUT_MODE
,

3512 &
’t
->
d’Œy
->
d_Çme
, 0, 
NULL
,

3513 
EXT4_HT_DIR
, 
üed™s
);

3515 
hªdË
 = 
	`ext4_jouº®_cu¼’t_hªdË
();

3516 ià(
	`IS_ERR
(
wh
)) {

3517 ià(
hªdË
)

3518 
	`ext4_jouº®_¡İ
(
hªdË
);

3519 ià(
	`PTR_ERR
(
wh
è=ğ-
ENOSPC
 &&

3520 
	`ext4_should_»Œy_®loc
(
’t
->
dœ
->
i_sb
, &
»Œ›s
))

3521 
»Œy
;

3523 *
h
 = 
hªdË
;

3524 
	`š™_¥ecŸl_šode
(
wh
, wh->
i_mode
, 
WHITEOUT_DEV
);

3525 
wh
->
i_İ
 = &
ext4_¥ecŸl_šode_İ”©iÚs
;

3527  
wh
;

3528 
	}
}

3538 
	$ext4_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

3539 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

3540 
æags
)

3542 
hªdË_t
 *
hªdË
 = 
NULL
;

3543 
ext4_»Çm’t
 
Şd
 = {

3544 .
dœ
 = 
Şd_dœ
,

3545 .
d’Œy
 = 
Şd_d’Œy
,

3546 .
šode
 = 
	`d_šode
(
Şd_d’Œy
),

3548 
ext4_»Çm’t
 
Ãw
 = {

3549 .
dœ
 = 
Ãw_dœ
,

3550 .
d’Œy
 = 
Ãw_d’Œy
,

3551 .
šode
 = 
	`d_šode
(
Ãw_d’Œy
),

3553 
fÜû_»»ad
;

3554 
»tv®
;

3555 
šode
 *
wh™eout
 = 
NULL
;

3556 
üed™s
;

3557 
u8
 
Şd_fe_ty³
;

3559 ià((
	`ext4_‹¡_šode_æag
(
Ãw_dœ
, 
EXT4_INODE_PROJINHERIT
)) &&

3560 (!
	`´ojid_eq
(
	`EXT4_I
(
Ãw_dœ
)->
i_´ojid
,

3561 
	`EXT4_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)))

3562  -
EXDEV
;

3564 ià((
	`ext4_’üy±ed_šode
(
Şd_dœ
) &&

3565 !
	`fsüy±_has_’üy±iÚ_key
(
Şd_dœ
)) ||

3566 (
	`ext4_’üy±ed_šode
(
Ãw_dœ
) &&

3567 !
	`fsüy±_has_’üy±iÚ_key
(
Ãw_dœ
)))

3568  -
ENOKEY
;

3570 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Şd
.
dœ
);

3571 ià(
»tv®
)

3572  
»tv®
;

3573 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Ãw
.
dœ
);

3574 ià(
»tv®
)

3575  
»tv®
;

3579 ià(
Ãw
.
šode
) {

3580 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Ãw
.
šode
);

3581 ià(
»tv®
)

3582  
»tv®
;

3585 
Şd
.
bh
 = 
	`ext4_fšd_’Œy
(Şd.
dœ
, &Şd.
d’Œy
->
d_Çme
, &Şd.
de
, 
NULL
);

3586 ià(
	`IS_ERR
(
Şd
.
bh
))

3587  
	`PTR_ERR
(
Şd
.
bh
);

3594 
»tv®
 = -
ENOENT
;

3595 ià(!
Şd
.
bh
 || 
	`Ë32_to_ıu
(Şd.
de
->
šode
è!ğŞd.šode->
i_šo
)

3596 
’d_»Çme
;

3598 ià((
Şd
.
dœ
 !ğ
Ãw
.dir) &&

3599 
	`ext4_’üy±ed_šode
(
Ãw
.
dœ
) &&

3600 !
	`fsüy±_has_³rm™‹d_cÚ‹xt
(
Ãw
.
dœ
, 
Şd
.
šode
)) {

3601 
»tv®
 = -
EPERM
;

3602 
’d_»Çme
;

3605 
Ãw
.
bh
 = 
	`ext4_fšd_’Œy
Òew.
dœ
, &Ãw.
d’Œy
->
d_Çme
,

3606 &
Ãw
.
de
, &Ãw.
šlšed
);

3607 ià(
	`IS_ERR
(
Ãw
.
bh
)) {

3608 
»tv®
 = 
	`PTR_ERR
(
Ãw
.
bh
);

3609 
Ãw
.
bh
 = 
NULL
;

3610 
’d_»Çme
;

3612 ià(
Ãw
.
bh
) {

3613 ià(!
Ãw
.
šode
) {

3614 
	`b»l£
(
Ãw
.
bh
);

3615 
Ãw
.
bh
 = 
NULL
;

3618 ià(
Ãw
.
šode
 && !
	`‹¡_İt
Òew.
dœ
->
i_sb
, 
NO_AUTO_DA_ALLOC
))

3619 
	`ext4_®loc_da_blocks
(
Şd
.
šode
);

3621 
üed™s
 = (2 * 
	`EXT4_DATA_TRANS_BLOCKS
(
Şd
.
dœ
->
i_sb
) +

3622 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2);

3623 ià(!(
æags
 & 
RENAME_WHITEOUT
)) {

3624 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
Şd
.
dœ
, 
EXT4_HT_DIR
, 
üed™s
);

3625 ià(
	`IS_ERR
(
hªdË
)) {

3626 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

3627 
hªdË
 = 
NULL
;

3628 
’d_»Çme
;

3631 
wh™eout
 = 
	`ext4_wh™eout_fÜ_»Çme
(&
Şd
, 
üed™s
, &
hªdË
);

3632 ià(
	`IS_ERR
(
wh™eout
)) {

3633 
»tv®
 = 
	`PTR_ERR
(
wh™eout
);

3634 
wh™eout
 = 
NULL
;

3635 
’d_»Çme
;

3639 ià(
	`IS_DIRSYNC
(
Şd
.
dœ
è|| IS_DIRSYNC(
Ãw
.dir))

3640 
	`ext4_hªdË_sync
(
hªdË
);

3642 ià(
	`S_ISDIR
(
Şd
.
šode
->
i_mode
)) {

3643 ià(
Ãw
.
šode
) {

3644 
»tv®
 = -
ENOTEMPTY
;

3645 ià(!
	`ext4_em±y_dœ
(
Ãw
.
šode
))

3646 
’d_»Çme
;

3648 
»tv®
 = -
EMLINK
;

3649 ià(
Ãw
.
dœ
 !ğ
Şd
.dœ && 
	`EXT4_DIR_LINK_MAX
(new.dir))

3650 
’d_»Çme
;

3652 
»tv®
 = 
	`ext4_»Çme_dœ_´•¬e
(
hªdË
, &
Şd
);

3653 ià(
»tv®
)

3654 
’d_»Çme
;

3663 
fÜû_»»ad
 = (
Ãw
.
dœ
->
i_šo
 =ğ
Şd
.dir->i_ino &&

3664 
	`ext4_‹¡_šode_æag
(
Ãw
.
dœ
, 
EXT4_INODE_INLINE_DATA
));

3666 
Şd_fe_ty³
 = 
Şd
.
de
->
fe_ty³
;

3667 ià(
wh™eout
) {

3672 
»tv®
 = 
	`ext4_£‹Á
(
hªdË
, &
Şd
, 
wh™eout
->
i_šo
,

3673 
EXT4_FT_CHRDEV
);

3674 ià(
»tv®
)

3675 
’d_»Çme
;

3676 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
wh™eout
);

3678 ià(!
Ãw
.
bh
) {

3679 
»tv®
 = 
	`ext4_add_’Œy
(
hªdË
, 
Ãw
.
d’Œy
, 
Şd
.
šode
);

3680 ià(
»tv®
)

3681 
’d_»Çme
;

3683 
»tv®
 = 
	`ext4_£‹Á
(
hªdË
, &
Ãw
,

3684 
Şd
.
šode
->
i_šo
, 
Şd_fe_ty³
);

3685 ià(
»tv®
)

3686 
’d_»Çme
;

3688 ià(
fÜû_»»ad
)

3689 
fÜû_»»ad
 = !
	`ext4_‹¡_šode_æag
(
Ãw
.
dœ
,

3690 
EXT4_INODE_INLINE_DATA
);

3696 
Şd
.
šode
->
i_ùime
 = 
	`cu¼’t_time
(old.inode);

3697 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Şd
.
šode
);

3699 ià(!
wh™eout
) {

3703 
	`ext4_»Çme_d–‘e
(
hªdË
, &
Şd
, 
fÜû_»»ad
);

3706 ià(
Ãw
.
šode
) {

3707 
	`ext4_dec_couÁ
(
hªdË
, 
Ãw
.
šode
);

3708 
Ãw
.
šode
->
i_ùime
 = 
	`cu¼’t_time
(new.inode);

3710 
Şd
.
dœ
->
i_ùime
 = old.dœ->
i_mtime
 = 
	`cu¼’t_time
(old.dir);

3711 
	`ext4_upd©e_dx_æag
(
Şd
.
dœ
);

3712 ià(
Şd
.
dœ_bh
) {

3713 
»tv®
 = 
	`ext4_»Çme_dœ_fšish
(
hªdË
, &
Şd
, 
Ãw
.
dœ
->
i_šo
);

3714 ià(
»tv®
)

3715 
’d_»Çme
;

3717 
	`ext4_dec_couÁ
(
hªdË
, 
Şd
.
dœ
);

3718 ià(
Ãw
.
šode
) {

3722 
	`ş—r_Æšk
(
Ãw
.
šode
);

3724 
	`ext4_šc_couÁ
(
hªdË
, 
Ãw
.
dœ
);

3725 
	`ext4_upd©e_dx_æag
(
Ãw
.
dœ
);

3726 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Ãw
.
dœ
);

3730 ià(
	`S_ISDIR
(
Şd
.
šode
->
i_mode
)) {

3738 
	`ext4_fc_di§bË
(
Şd
.
šode
->
i_sb
, 
EXT4_FC_REASON_RENAME_DIR
);

3740 ià(
Ãw
.
šode
)

3741 
	`ext4_fc_Œack_uÆšk
(
Ãw
.
šode
,‚ew.
d’Œy
);

3742 
	`ext4_fc_Œack_lšk
(
Şd
.
šode
, 
Ãw
.
d’Œy
);

3743 
	`ext4_fc_Œack_uÆšk
(
Şd
.
šode
, old.
d’Œy
);

3746 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Şd
.
dœ
);

3747 ià(
Ãw
.
šode
) {

3748 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Ãw
.
šode
);

3749 ià(!
Ãw
.
šode
->
i_Æšk
)

3750 
	`ext4_Üphª_add
(
hªdË
, 
Ãw
.
šode
);

3752 
»tv®
 = 0;

3754 
’d_»Çme
:

3755 
	`b»l£
(
Şd
.
dœ_bh
);

3756 
	`b»l£
(
Şd
.
bh
);

3757 
	`b»l£
(
Ãw
.
bh
);

3758 ià(
wh™eout
) {

3759 ià(
»tv®
)

3760 
	`drİ_Æšk
(
wh™eout
);

3761 
	`uÆock_Ãw_šode
(
wh™eout
);

3762 
	`ut
(
wh™eout
);

3764 ià(
hªdË
)

3765 
	`ext4_jouº®_¡İ
(
hªdË
);

3766  
»tv®
;

3767 
	}
}

3769 
	$ext4_üoss_»Çme
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

3770 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
)

3772 
hªdË_t
 *
hªdË
 = 
NULL
;

3773 
ext4_»Çm’t
 
Şd
 = {

3774 .
dœ
 = 
Şd_dœ
,

3775 .
d’Œy
 = 
Şd_d’Œy
,

3776 .
šode
 = 
	`d_šode
(
Şd_d’Œy
),

3778 
ext4_»Çm’t
 
Ãw
 = {

3779 .
dœ
 = 
Ãw_dœ
,

3780 .
d’Œy
 = 
Ãw_d’Œy
,

3781 .
šode
 = 
	`d_šode
(
Ãw_d’Œy
),

3783 
u8
 
Ãw_fe_ty³
;

3784 
»tv®
;

3785 
time¥ec
 
ùime
;

3787 ià((
	`ext4_’üy±ed_šode
(
Şd_dœ
) &&

3788 !
	`fsüy±_has_’üy±iÚ_key
(
Şd_dœ
)) ||

3789 (
	`ext4_’üy±ed_šode
(
Ãw_dœ
) &&

3790 !
	`fsüy±_has_’üy±iÚ_key
(
Ãw_dœ
)))

3791  -
ENOKEY
;

3793 ià((
	`ext4_’üy±ed_šode
(
Şd_dœ
) ||

3794 
	`ext4_’üy±ed_šode
(
Ãw_dœ
)) &&

3795 (
Şd_dœ
 !ğ
Ãw_dœ
) &&

3796 (!
	`fsüy±_has_³rm™‹d_cÚ‹xt
(
Ãw_dœ
, 
Şd
.
šode
) ||

3797 !
	`fsüy±_has_³rm™‹d_cÚ‹xt
(
Şd_dœ
, 
Ãw
.
šode
)))

3798  -
EPERM
;

3800 ià((
	`ext4_‹¡_šode_æag
(
Ãw_dœ
, 
EXT4_INODE_PROJINHERIT
) &&

3801 !
	`´ojid_eq
(
	`EXT4_I
(
Ãw_dœ
)->
i_´ojid
,

3802 
	`EXT4_I
(
Şd_d’Œy
->
d_šode
)->
i_´ojid
)) ||

3803 (
	`ext4_‹¡_šode_æag
(
Şd_dœ
, 
EXT4_INODE_PROJINHERIT
) &&

3804 !
	`´ojid_eq
(
	`EXT4_I
(
Şd_dœ
)->
i_´ojid
,

3805 
	`EXT4_I
(
Ãw_d’Œy
->
d_šode
)->
i_´ojid
)))

3806  -
EXDEV
;

3808 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Şd
.
dœ
);

3809 ià(
»tv®
)

3810  
»tv®
;

3811 
»tv®
 = 
	`dquÙ_š™Ÿlize
(
Ãw
.
dœ
);

3812 ià(
»tv®
)

3813  
»tv®
;

3815 
Şd
.
bh
 = 
	`ext4_fšd_’Œy
(Şd.
dœ
, &Şd.
d’Œy
->
d_Çme
,

3816 &
Şd
.
de
, &Şd.
šlšed
);

3817 ià(
	`IS_ERR
(
Şd
.
bh
))

3818  
	`PTR_ERR
(
Şd
.
bh
);

3825 
»tv®
 = -
ENOENT
;

3826 ià(!
Şd
.
bh
 || 
	`Ë32_to_ıu
(Şd.
de
->
šode
è!ğŞd.šode->
i_šo
)

3827 
’d_»Çme
;

3829 
Ãw
.
bh
 = 
	`ext4_fšd_’Œy
Òew.
dœ
, &Ãw.
d’Œy
->
d_Çme
,

3830 &
Ãw
.
de
, &Ãw.
šlšed
);

3831 ià(
	`IS_ERR
(
Ãw
.
bh
)) {

3832 
»tv®
 = 
	`PTR_ERR
(
Ãw
.
bh
);

3833 
Ãw
.
bh
 = 
NULL
;

3834 
’d_»Çme
;

3838 ià(!
Ãw
.
bh
 || 
	`Ë32_to_ıu
Òew.
de
->
šode
è!ğÃw.šode->
i_šo
)

3839 
’d_»Çme
;

3841 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
Şd
.
dœ
, 
EXT4_HT_DIR
,

3842 (2 * 
	`EXT4_DATA_TRANS_BLOCKS
(
Şd
.
dœ
->
i_sb
) +

3843 2 * 
EXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2));

3844 ià(
	`IS_ERR
(
hªdË
)) {

3845 
»tv®
 = 
	`PTR_ERR
(
hªdË
);

3846 
hªdË
 = 
NULL
;

3847 
’d_»Çme
;

3850 ià(
	`IS_DIRSYNC
(
Şd
.
dœ
è|| IS_DIRSYNC(
Ãw
.dir))

3851 
	`ext4_hªdË_sync
(
hªdË
);

3853 ià(
	`S_ISDIR
(
Şd
.
šode
->
i_mode
)) {

3854 
Şd
.
is_dœ
 = 
Œue
;

3855 
»tv®
 = 
	`ext4_»Çme_dœ_´•¬e
(
hªdË
, &
Şd
);

3856 ià(
»tv®
)

3857 
’d_»Çme
;

3859 ià(
	`S_ISDIR
(
Ãw
.
šode
->
i_mode
)) {

3860 
Ãw
.
is_dœ
 = 
Œue
;

3861 
»tv®
 = 
	`ext4_»Çme_dœ_´•¬e
(
hªdË
, &
Ãw
);

3862 ià(
»tv®
)

3863 
’d_»Çme
;

3870 ià(
Şd
.
dœ
 !ğ
Ãw
.dœ && old.
is_dœ
 !=‚ew.is_dir) {

3871 
Şd
.
dœ_Æšk_d–
 = old.
is_dœ
 ? -1 : 1;

3872 
Ãw
.
dœ_Æšk_d–
 = -
Şd
.dir_nlink_delta;

3873 
»tv®
 = -
EMLINK
;

3874 ià((
Şd
.
dœ_Æšk_d–
 > 0 && 
	`EXT4_DIR_LINK_MAX
(Şd.
dœ
)) ||

3875 (
Ãw
.
dœ_Æšk_d–
 > 0 && 
	`EXT4_DIR_LINK_MAX
Òew.
dœ
)))

3876 
’d_»Çme
;

3879 
Ãw_fe_ty³
 = 
Ãw
.
de
->
fe_ty³
;

3880 
»tv®
 = 
	`ext4_£‹Á
(
hªdË
, &
Ãw
, 
Şd
.
šode
->
i_šo
, old.
de
->
fe_ty³
);

3881 ià(
»tv®
)

3882 
’d_»Çme
;

3884 
»tv®
 = 
	`ext4_£‹Á
(
hªdË
, &
Şd
, 
Ãw
.
šode
->
i_šo
, 
Ãw_fe_ty³
);

3885 ià(
»tv®
)

3886 
’d_»Çme
;

3892 
ùime
 = 
	`cu¼’t_time
(
Şd
.
šode
);

3893 
Şd
.
šode
->
i_ùime
 = 
ùime
;

3894 
Ãw
.
šode
->
i_ùime
 = 
ùime
;

3895 
	`ext4_fc_m¬k_š–igibË
(
Şd
.
šode
,

3896 
EXT4_FC_REASON_CROSS_RENAME
);

3897 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Şd
.
šode
);

3898 
	`ext4_fc_m¬k_š–igibË
(
Ãw
.
šode
,

3899 
EXT4_FC_REASON_CROSS_RENAME
);

3900 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
Ãw
.
šode
);

3902 ià(
Şd
.
dœ_bh
) {

3903 
»tv®
 = 
	`ext4_»Çme_dœ_fšish
(
hªdË
, &
Şd
, 
Ãw
.
dœ
->
i_šo
);

3904 ià(
»tv®
)

3905 
’d_»Çme
;

3907 ià(
Ãw
.
dœ_bh
) {

3908 
»tv®
 = 
	`ext4_»Çme_dœ_fšish
(
hªdË
, &
Ãw
, 
Şd
.
dœ
->
i_šo
);

3909 ià(
»tv®
)

3910 
’d_»Çme
;

3912 
	`ext4_upd©e_dœ_couÁ
(
hªdË
, &
Şd
);

3913 
	`ext4_upd©e_dœ_couÁ
(
hªdË
, &
Ãw
);

3914 
»tv®
 = 0;

3916 
’d_»Çme
:

3917 
	`b»l£
(
Şd
.
dœ_bh
);

3918 
	`b»l£
(
Ãw
.
dœ_bh
);

3919 
	`b»l£
(
Şd
.
bh
);

3920 
	`b»l£
(
Ãw
.
bh
);

3921 ià(
hªdË
)

3922 
	`ext4_jouº®_¡İ
(
hªdË
);

3923  
»tv®
;

3924 
	}
}

3926 
	$ext4_»Çme2
(
šode
 *
Şd_dœ
, 
d’Œy
 *
Şd_d’Œy
,

3927 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

3928 
æags
)

3930 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
Şd_dœ
->
i_sb
))))

3931  -
EIO
;

3933 ià(
æags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

3934  -
EINVAL
;

3936 ià(
æags
 & 
RENAME_EXCHANGE
) {

3937  
	`ext4_üoss_»Çme
(
Şd_dœ
, 
Şd_d’Œy
,

3938 
Ãw_dœ
, 
Ãw_d’Œy
);

3941  
	`ext4_»Çme
(
Şd_dœ
, 
Şd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
, 
æags
);

3942 
	}
}

3947 cÚ¡ 
šode_İ”©iÚs
 
	gext4_dœ_šode_İ”©iÚs
 = {

3948 .
ü—‹
 = 
ext4_ü—‹
,

3949 .
	glookup
 = 
ext4_lookup
,

3950 .
	glšk
 = 
ext4_lšk
,

3951 .
	guÆšk
 = 
ext4_uÆšk
,

3952 .
	gsymlšk
 = 
ext4_symlšk
,

3953 .
	gmkdœ
 = 
ext4_mkdœ
,

3954 .
	grmdœ
 = 
ext4_rmdœ
,

3955 .
	gmknod
 = 
ext4_mknod
,

3956 .
	gtmpfe
 = 
ext4_tmpfe
,

3957 .
	g»Çme
 = 
ext4_»Çme2
,

3958 .
	g£‰r
 = 
ext4_£‰r
,

3959 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

3960 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

3961 .
	gg‘_aş
 = 
ext4_g‘_aş
,

3962 .
	g£t_aş
 = 
ext4_£t_aş
,

3963 .
	gf›m­
 = 
ext4_f›m­
,

3966 cÚ¡ 
šode_İ”©iÚs
 
	gext4_¥ecŸl_šode_İ”©iÚs
 = {

3967 .
£‰r
 = 
ext4_£‰r
,

3968 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

3969 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

3970 .
	gg‘_aş
 = 
ext4_g‘_aş
,

3971 .
	g£t_aş
 = 
ext4_£t_aş
,

	@page-io.c

9 
	~<lšux/fs.h
>

10 
	~<lšux/time.h
>

11 
	~<lšux/highuid.h
>

12 
	~<lšux/·gem­.h
>

13 
	~<lšux/quÙaİs.h
>

14 
	~<lšux/¡ršg.h
>

15 
	~<lšux/bufãr_h—d.h
>

16 
	~<lšux/wr™eback.h
>

17 
	~<lšux/·gevec.h
>

18 
	~<lšux/m·ge.h
>

19 
	~<lšux/Çmei.h
>

20 
	~<lšux/uio.h
>

21 
	~<lšux/bio.h
>

22 
	~<lšux/wÜkqueue.h
>

23 
	~<lšux/k”Ãl.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/mm.h
>

26 
	~<lšux/backšg-dev.h
>

28 
	~"ext4_jbd2.h
"

29 
	~"x©Œ.h
"

30 
	~"aş.h
"

32 
kmem_ÿche
 *
	gio_’d_ÿch•
;

34 
__š™
 
	$ext4_š™_·geio
()

36 
io_’d_ÿch•
 = 
	`KMEM_CACHE
(
ext4_io_’d
, 
SLAB_RECLAIM_ACCOUNT
);

37 ià(
io_’d_ÿch•
 =ğ
NULL
)

38  -
ENOMEM
;

40 
	}
}

42 
	$ext4_ex™_·geio
()

44 
	`kmem_ÿche_de¡roy
(
io_’d_ÿch•
);

45 
	}
}

54 
	$bufãr_io_”rÜ
(
bufãr_h—d
 *
bh
)

56 
	`´štk_¿‹lim™ed
(
KERN_ERR
 "Buffer I/Oƒrror on device %pg,†ogical block %llu\n",

57 
bh
->
b_bdev
,

58 ()
bh
->
b_blockÄ
);

59 
	}
}

61 
	$ext4_fšish_bio
(
bio
 *bio)

63 
i
;

64 
bio_vec
 *
bvec
;

66 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
) {

67 
·ge
 *·gğ
bvec
->
bv_·ge
;

68 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


69 
·ge
 *
d©a_·ge
 = 
NULL
;

71 
bufãr_h—d
 *
bh
, *
h—d
;

72 
bio_¡¬t
 = 
bvec
->
bv_off£t
;

73 
bio_’d
 = 
bio_¡¬t
 + 
bvec
->
bv_Ën
;

74 
und”_io
 = 0;

75 
æags
;

77 ià(!
·ge
)

80 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


81 ià(!
·ge
->
m­pšg
) {

83 
d©a_·ge
 = 
·ge
;

84 
	`fsüy±_puÎback_bio_·ge
(&
·ge
, 
çl£
);

88 ià(
bio
->
bi_¡©us
) {

89 
	`S‘PageE¼Ü
(
·ge
);

90 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, -
EIO
);

92 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

97 
	`loÿl_œq_§ve
(
æags
);

98 
	`b™_¥š_lock
(
BH_U±od©e_Lock
, &
h—d
->
b_¡©e
);

100 ià(
	`bh_off£t
(
bh
è< 
bio_¡¬t
 ||

101 
	`bh_off£t
(
bh
è+ bh->
b_size
 > 
bio_’d
) {

102 ià(
	`bufãr_async_wr™e
(
bh
))

103 
und”_io
++;

106 
	`ş—r_bufãr_async_wr™e
(
bh
);

107 ià(
bio
->
bi_¡©us
)

108 
	`bufãr_io_”rÜ
(
bh
);

109 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

110 
	`b™_¥š_uÆock
(
BH_U±od©e_Lock
, &
h—d
->
b_¡©e
);

111 
	`loÿl_œq_»¡Üe
(
æags
);

112 ià(!
und”_io
) {

113 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


114 ià(
d©a_·ge
)

115 
	`fsüy±_»¡Üe_cÚŒŞ_·ge
(
d©a_·ge
);

117 
	`’d_·ge_wr™eback
(
·ge
);

120 
	}
}

122 
	$ext4_»Ëa£_io_’d
(
ext4_io_’d_t
 *
io_’d
)

124 
bio
 *bio, *
Ãxt_bio
;

126 
	`BUG_ON
(!
	`li¡_em±y
(&
io_’d
->
li¡
));

127 
	`BUG_ON
(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
);

128 
	`WARN_ON
(
io_’d
->
hªdË
);

130 
bio
 = 
io_’d
->bio; bio; biØğ
Ãxt_bio
) {

131 
Ãxt_bio
 = 
bio
->
bi_´iv©e
;

132 
	`ext4_fšish_bio
(
bio
);

133 
	`bio_put
(
bio
);

135 
	`kmem_ÿche_ä“
(
io_’d_ÿch•
, 
io_’d
);

136 
	}
}

146 
	$ext4_’d_io
(
ext4_io_’d_t
 *
io
)

148 
šode
 *šodğ
io
->inode;

149 
loff_t
 
off£t
 = 
io
->offset;

150 
ssize_t
 
size
 = 
io
->size;

151 
hªdË_t
 *
hªdË
 = 
io
->handle;

152 
»t
 = 0;

154 
	`ext4_debug
("ext4_end_io_nolock: io 0x%p from inode %lu,list->next 0x%p,"

156 
io
, 
šode
->
i_šo
, io->
li¡
.
Ãxt
, io->li¡.
´ev
);

158 
io
->
hªdË
 = 
NULL
;

159 
»t
 = 
	`ext4_cÚv”t_unwr™‹n_ex‹Ás
(
hªdË
, 
šode
, 
off£t
, 
size
);

160 ià(
»t
 < 0 && !
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))) {

161 
	`ext4_msg
(
šode
->
i_sb
, 
KERN_EMERG
,

165 
šode
->
i_šo
, 
off£t
, 
size
, 
»t
);

167 
	`ext4_ş—r_io_unwr™‹n_æag
(
io
);

168 
	`ext4_»Ëa£_io_’d
(
io
);

169  
»t
;

170 
	}
}

172 
	$dump_com¶‘ed_IO
(
šode
 *šode, 
li¡_h—d
 *
h—d
)

174 #ifdef 
EXT4FS_DEBUG


175 
li¡_h—d
 *
cur
, *
befÜe
, *
aá”
;

176 
ext4_io_’d_t
 *
io
, *
io0
, *
io1
;

178 ià(
	`li¡_em±y
(
h—d
))

181 
	`ext4_debug
("Dum°šod%lu com¶‘ed iØli¡\n", 
šode
->
i_šo
);

182 
	`li¡_fÜ_—ch_’Œy
(
io
, 
h—d
, 
li¡
) {

183 
cur
 = &
io
->
li¡
;

184 
befÜe
 = 
cur
->
´ev
;

185 
io0
 = 
	`cÚš”_of
(
befÜe
, 
ext4_io_’d_t
, 
li¡
);

186 
aá”
 = 
cur
->
Ãxt
;

187 
io1
 = 
	`cÚš”_of
(
aá”
, 
ext4_io_’d_t
, 
li¡
);

189 
	`ext4_debug
("io 0x%p from inode %lu,prev 0x%p,next 0x%p\n",

190 
io
, 
šode
->
i_šo
, 
io0
, 
io1
);

193 
	}
}

196 
	$ext4_add_com¶‘e_io
(
ext4_io_’d_t
 *
io_’d
)

198 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
io_’d
->
šode
);

199 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
io_’d
->
šode
->
i_sb
);

200 
wÜkqueue_¡ruù
 *
wq
;

201 
æags
;

204 
	`WARN_ON
(!(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
));

205 
	`WARN_ON
(!
io_’d
->
hªdË
 && 
sbi
->
s_jouº®
);

206 
	`¥š_lock_œq§ve
(&
ei
->
i_com¶‘ed_io_lock
, 
æags
);

207 
wq
 = 
sbi
->
rsv_cÚv”siÚ_wq
;

208 ià(
	`li¡_em±y
(&
ei
->
i_rsv_cÚv”siÚ_li¡
))

209 
	`queue_wÜk
(
wq
, &
ei
->
i_rsv_cÚv”siÚ_wÜk
);

210 
	`li¡_add_
(&
io_’d
->
li¡
, &
ei
->
i_rsv_cÚv”siÚ_li¡
);

211 
	`¥š_uÆock_œq»¡Üe
(&
ei
->
i_com¶‘ed_io_lock
, 
æags
);

212 
	}
}

214 
	$ext4_do_æush_com¶‘ed_IO
(
šode
 *inode,

215 
li¡_h—d
 *
h—d
)

217 
ext4_io_’d_t
 *
io
;

218 
li¡_h—d
 
unwr™‹n
;

219 
æags
;

220 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

221 
”r
, 
»t
 = 0;

223 
	`¥š_lock_œq§ve
(&
ei
->
i_com¶‘ed_io_lock
, 
æags
);

224 
	`dump_com¶‘ed_IO
(
šode
, 
h—d
);

225 
	`li¡_»¶aû_š™
(
h—d
, &
unwr™‹n
);

226 
	`¥š_uÆock_œq»¡Üe
(&
ei
->
i_com¶‘ed_io_lock
, 
æags
);

228 !
	`li¡_em±y
(&
unwr™‹n
)) {

229 
io
 = 
	`li¡_’Œy
(
unwr™‹n
.
Ãxt
, 
ext4_io_’d_t
, 
li¡
);

230 
	`BUG_ON
(!(
io
->
æag
 & 
EXT4_IO_END_UNWRITTEN
));

231 
	`li¡_d–_š™
(&
io
->
li¡
);

233 
”r
 = 
	`ext4_’d_io
(
io
);

234 ià(
	`uÆik–y
(!
»t
 && 
”r
))

235 
»t
 = 
”r
;

237  
»t
;

238 
	}
}

243 
	$ext4_’d_io_rsv_wÜk
(
wÜk_¡ruù
 *
wÜk
)

245 
ext4_šode_šfo
 *
ei
 = 
	`cÚš”_of
(
wÜk
, ext4_inode_info,

246 
i_rsv_cÚv”siÚ_wÜk
);

247 
	`ext4_do_æush_com¶‘ed_IO
(&
ei
->
vfs_šode
, &ei->
i_rsv_cÚv”siÚ_li¡
);

248 
	}
}

250 
ext4_io_’d_t
 *
	$ext4_š™_io_’d
(
šode
 *šode, 
gå_t
 
æags
)

252 
ext4_io_’d_t
 *
io
 = 
	`kmem_ÿche_z®loc
(
io_’d_ÿch•
, 
æags
);

253 ià(
io
) {

254 
io
->
šode
 = inode;

255 
	`INIT_LIST_HEAD
(&
io
->
li¡
);

256 
	`©omic_£t
(&
io
->
couÁ
, 1);

258  
io
;

259 
	}
}

261 
	$ext4_put_io_’d_deãr
(
ext4_io_’d_t
 *
io_’d
)

263 ià(
	`©omic_dec_ªd_‹¡
(&
io_’d
->
couÁ
)) {

264 ià(!(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
è|| !io_’d->
size
) {

265 
	`ext4_»Ëa£_io_’d
(
io_’d
);

268 
	`ext4_add_com¶‘e_io
(
io_’d
);

270 
	}
}

272 
	$ext4_put_io_’d
(
ext4_io_’d_t
 *
io_’d
)

274 
”r
 = 0;

276 ià(
	`©omic_dec_ªd_‹¡
(&
io_’d
->
couÁ
)) {

277 ià(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
) {

278 
”r
 = 
	`ext4_cÚv”t_unwr™‹n_ex‹Ás
(
io_’d
->
hªdË
,

279 
io_’d
->
šode
, io_’d->
off£t
,

280 
io_’d
->
size
);

281 
io_’d
->
hªdË
 = 
NULL
;

282 
	`ext4_ş—r_io_unwr™‹n_æag
(
io_’d
);

284 
	`ext4_»Ëa£_io_’d
(
io_’d
);

286  
”r
;

287 
	}
}

289 
ext4_io_’d_t
 *
	$ext4_g‘_io_’d
(
ext4_io_’d_t
 *
io_’d
)

291 
	`©omic_šc
(&
io_’d
->
couÁ
);

292  
io_’d
;

293 
	}
}

296 
	$ext4_’d_bio
(
bio
 *bio)

298 
ext4_io_’d_t
 *
io_’d
 = 
bio
->
bi_´iv©e
;

299 
£ùÜ_t
 
bi_£ùÜ
 = 
bio
->
bi_™”
.bi_sector;

300 
b
[
BDEVNAME_SIZE
];

302 ià(
	`WARN_ONCE
(!
io_’d
, "io_end is NULL: %s: sector %Lu†en %uƒrr %d\n",

303 
	`bdevÇme
(
bio
->
bi_bdev
, 
b
),

304 (è
bio
->
bi_™”
.
bi_£ùÜ
,

305 (è
	`bio_£ùÜs
(
bio
),

306 
bio
->
bi_¡©us
)) {

307 
	`ext4_fšish_bio
(
bio
);

308 
	`bio_put
(
bio
);

311 
bio
->
bi_’d_io
 = 
NULL
;

313 ià(
bio
->
bi_¡©us
) {

314 
šode
 *šodğ
io_’d
->inode;

316 
	`ext4_w¬nšg
(
šode
->
i_sb
, "I/Oƒrror %d writingo inode %lu "

318 
bio
->
bi_¡©us
, 
šode
->
i_šo
,

319 (è
io_’d
->
off£t
,

320 (è
io_’d
->
size
,

322 
bi_£ùÜ
 >> (
šode
->
i_blkb™s
 - 9));

323 
	`m­pšg_£t_”rÜ
(
šode
->
i_m­pšg
,

324 
	`blk_¡©us_to_”ºo
(
bio
->
bi_¡©us
));

327 ià(
io_’d
->
æag
 & 
EXT4_IO_END_UNWRITTEN
) {

333 
bio
->
bi_´iv©e
 = 
	`xchg
(&
io_’d
->bio, bio);

334 
	`ext4_put_io_’d_deãr
(
io_’d
);

340 
	`ext4_put_io_’d_deãr
(
io_’d
);

341 
	`ext4_fšish_bio
(
bio
);

342 
	`bio_put
(
bio
);

344 
	}
}

346 
	$ext4_io_subm™
(
ext4_io_subm™
 *
io
)

348 
bio
 *biØğ
io
->
io_bio
;

350 ià(
bio
) {

351 
io_İ_æags
 = 
io
->
io_wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
 ?

352 
REQ_SYNC
 : 0;

353 
io
->
io_bio
->
bi_wr™e_hšt
 = io->
io_’d
->
šode
->
i_wr™e_hšt
;

354 
	`bio_£t_İ_©Œs
(
io
->
io_bio
, 
REQ_OP_WRITE
, 
io_İ_æags
);

355 
	`subm™_bio
(
io
->
io_bio
);

357 
io
->
io_bio
 = 
NULL
;

358 
	}
}

360 
	$ext4_io_subm™_š™
(
ext4_io_subm™
 *
io
,

361 
wr™eback_cÚŒŞ
 *
wbc
)

363 
io
->
io_wbc
 = 
wbc
;

364 
io
->
io_bio
 = 
NULL
;

365 
io
->
io_’d
 = 
NULL
;

366 
	}
}

368 
	$io_subm™_š™_bio
(
ext4_io_subm™
 *
io
,

369 
bufãr_h—d
 *
bh
)

371 
bio
 *bio;

373 
bio
 = 
	`bio_®loc
(
GFP_NOIO
, 
BIO_MAX_PAGES
);

374 ià(!
bio
)

375  -
ENOMEM
;

376 
	`wbc_š™_bio
(
io
->
io_wbc
, 
bio
);

377 
bio
->
bi_™”
.
bi_£ùÜ
 = 
bh
->
b_blockÄ
 * (bh->
b_size
 >> 9);

378 
bio
->
bi_bdev
 = 
bh
->
b_bdev
;

379 
bio
->
bi_’d_io
 = 
ext4_’d_bio
;

380 
bio
->
bi_´iv©e
 = 
	`ext4_g‘_io_’d
(
io
->
io_’d
);

381 
io
->
io_bio
 = 
bio
;

382 
io
->
io_Ãxt_block
 = 
bh
->
b_blockÄ
;

384 
	}
}

386 
	$io_subm™_add_bh
(
ext4_io_subm™
 *
io
,

387 
šode
 *inode,

388 
·ge
 *page,

389 
bufãr_h—d
 *
bh
)

391 
»t
;

393 ià(
io
->
io_bio
 && 
bh
->
b_blockÄ
 !ğio->
io_Ãxt_block
) {

394 
subm™_ªd_»Œy
:

395 
	`ext4_io_subm™
(
io
);

397 ià(
io
->
io_bio
 =ğ
NULL
) {

398 
»t
 = 
	`io_subm™_š™_bio
(
io
, 
bh
);

399 ià(
»t
)

400  
»t
;

401 
io
->
io_bio
->
bi_wr™e_hšt
 = 
šode
->
i_wr™e_hšt
;

403 
»t
 = 
	`bio_add_·ge
(
io
->
io_bio
, 
·ge
, 
bh
->
b_size
, 
	`bh_off£t
(bh));

404 ià(
»t
 !ğ
bh
->
b_size
)

405 
subm™_ªd_»Œy
;

406 
	`wbc_accouÁ_io
(
io
->
io_wbc
, 
·ge
, 
bh
->
b_size
);

407 
io
->
io_Ãxt_block
++;

409 
	}
}

411 
	$ext4_bio_wr™e_·ge
(
ext4_io_subm™
 *
io
,

412 
·ge
 *page,

413 
Ën
,

414 
wr™eback_cÚŒŞ
 *
wbc
,

415 
boŞ
 
k“p_towr™e
)

417 
·ge
 *
d©a_·ge
 = 
NULL
;

418 
šode
 *šodğ
·ge
->
m­pšg
->
ho¡
;

419 
block_¡¬t
;

420 
bufãr_h—d
 *
bh
, *
h—d
;

421 
»t
 = 0;

422 
Ä_subm™‹d
 = 0;

423 
Ä_to_subm™
 = 0;

425 
	`BUG_ON
(!
	`PageLocked
(
·ge
));

426 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

428 ià(
k“p_towr™e
)

429 
	`£t_·ge_wr™eback_k“pwr™e
(
·ge
);

431 
	`£t_·ge_wr™eback
(
·ge
);

432 
	`CË¬PageE¼Ü
(
·ge
);

443 ià(
Ën
 < 
PAGE_SIZE
)

444 
	`z”o_u£r_£gm’t
(
·ge
, 
Ën
, 
PAGE_SIZE
);

452 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

454 
block_¡¬t
 = 
	`bh_off£t
(
bh
);

455 ià(
block_¡¬t
 >ğ
Ën
) {

456 
	`ş—r_bufãr_dœty
(
bh
);

457 
	`£t_bufãr_u±od©e
(
bh
);

460 ià(!
	`bufãr_dœty
(
bh
è|| 
	`bufãr_d–ay
(bh) ||

461 !
	`bufãr_m­³d
(
bh
è|| 
	`bufãr_unwr™‹n
(bh)) {

463 ià(!
	`bufãr_m­³d
(
bh
))

464 
	`ş—r_bufãr_dœty
(
bh
);

465 ià(
io
->
io_bio
)

466 
	`ext4_io_subm™
(
io
);

469 ià(
	`bufãr_Ãw
(
bh
)) {

470 
	`ş—r_bufãr_Ãw
(
bh
);

471 
	`ş—n_bdev_bh_®Ÿs
(
bh
);

473 
	`£t_bufãr_async_wr™e
(
bh
);

474 
Ä_to_subm™
++;

475 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

477 
bh
 = 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

479 ià(
	`ext4_’üy±ed_šode
(
šode
è&& 
	`S_ISREG
(šode->
i_mode
) &&

480 
Ä_to_subm™
) {

481 
gå_t
 
gå_æags
 = 
GFP_NOFS
;

483 
»Œy_’üy±
:

484 
d©a_·ge
 = 
	`fsüy±_’üy±_·ge
(
šode
, 
·ge
, 
PAGE_SIZE
, 0,

485 
·ge
->
šdex
, 
gå_æags
);

486 ià(
	`IS_ERR
(
d©a_·ge
)) {

487 
»t
 = 
	`PTR_ERR
(
d©a_·ge
);

488 ià(
»t
 =ğ-
ENOMEM
 && 
wbc
->
sync_mode
 =ğ
WB_SYNC_ALL
) {

489 ià(
io
->
io_bio
) {

490 
	`ext4_io_subm™
(
io
);

491 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/50);

493 
gå_æags
 |ğ
__GFP_NOFAIL
;

494 
»Œy_’üy±
;

496 
d©a_·ge
 = 
NULL
;

497 
out
;

503 ià(!
	`bufãr_async_wr™e
(
bh
))

505 
»t
 = 
	`io_subm™_add_bh
(
io
, 
šode
,

506 
d©a_·ge
 ? d©a_·g: 
·ge
, 
bh
);

507 ià(
»t
) {

515 
Ä_subm™‹d
++;

516 
	`ş—r_bufãr_dœty
(
bh
);

517 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

520 ià(
»t
) {

521 
out
:

522 ià(
d©a_·ge
)

523 
	`fsüy±_»¡Üe_cÚŒŞ_·ge
(
d©a_·ge
);

524 
	`´štk_¿‹lim™ed
(
KERN_ERR
 "%s:„‘ = %d\n", 
__func__
, 
»t
);

525 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

527 
	`ş—r_bufãr_async_wr™e
(
bh
);

528 
bh
 = bh->
b_this_·ge
;

529 } 
bh
 !ğ
h—d
);

531 
	`uÆock_·ge
(
·ge
);

533 ià(!
Ä_subm™‹d
)

534 
	`’d_·ge_wr™eback
(
·ge
);

535  
»t
;

536 
	}
}

	@readpage.c

30 
	~<lšux/k”Ãl.h
>

31 
	~<lšux/expÜt.h
>

32 
	~<lšux/mm.h
>

33 
	~<lšux/kdev_t.h
>

34 
	~<lšux/gå.h
>

35 
	~<lšux/bio.h
>

36 
	~<lšux/fs.h
>

37 
	~<lšux/bufãr_h—d.h
>

38 
	~<lšux/blkdev.h
>

39 
	~<lšux/highmem.h
>

40 
	~<lšux/´eãtch.h
>

41 
	~<lšux/m·ge.h
>

42 
	~<lšux/wr™eback.h
>

43 
	~<lšux/backšg-dev.h
>

44 
	~<lšux/·gevec.h
>

45 
	~<lšux/ş—nÿche.h
>

47 
	~"ext4.h
"

49 
šlše
 
boŞ
 
	$ext4_bio_’üy±ed
(
bio
 *bio)

51 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


52  
	`uÆik–y
(
bio
->
bi_´iv©e
 !ğ
NULL
);

54  
çl£
;

56 
	}
}

70 
	$m·ge_’d_io
(
bio
 *bio)

72 
bio_vec
 *
bv
;

73 
i
;

75 ià(
	`ext4_bio_’üy±ed
(
bio
)) {

76 ià(
bio
->
bi_¡©us
) {

77 
	`fsüy±_»Ëa£_ùx
(
bio
->
bi_´iv©e
);

79 
	`fsüy±_deüy±_bio_·ges
(
bio
->
bi_´iv©e
, bio);

83 
	`bio_fÜ_—ch_£gm’t_®l
(
bv
, 
bio
, 
i
) {

84 
·ge
 *·gğ
bv
->
bv_·ge
;

86 ià(!
bio
->
bi_¡©us
) {

87 
	`S‘PageU±od©e
(
·ge
);

89 
	`CË¬PageU±od©e
(
·ge
);

90 
	`S‘PageE¼Ü
(
·ge
);

92 
	`uÆock_·ge
(
·ge
);

95 
	`bio_put
(
bio
);

96 
	}
}

98 
	$ext4_m·ge_»ad·ges
(
add»ss_¥aû
 *
m­pšg
,

99 
li¡_h—d
 *
·ges
, 
·ge
 *page,

100 
Ä_·ges
)

102 
bio
 *biØğ
NULL
;

103 
£ùÜ_t
 
Ï¡_block_š_bio
 = 0;

105 
šode
 *šodğ
m­pšg
->
ho¡
;

106 cÚ¡ 
blkb™s
 = 
šode
->
i_blkb™s
;

107 cÚ¡ 
blocks_³r_·ge
 = 
PAGE_SIZE
 >> 
blkb™s
;

108 cÚ¡ 
blocksize
 = 1 << 
blkb™s
;

109 
£ùÜ_t
 
block_š_fe
;

110 
£ùÜ_t
 
Ï¡_block
;

111 
£ùÜ_t
 
Ï¡_block_š_fe
;

112 
£ùÜ_t
 
blocks
[
MAX_BUF_PER_PAGE
];

113 
·ge_block
;

114 
block_deviû
 *
bdev
 = 
šode
->
i_sb
->
s_bdev
;

115 
Ëngth
;

116 
»Ïtive_block
 = 0;

117 
ext4_m­_blocks
 
m­
;

119 
m­
.
m_pblk
 = 0;

120 
m­
.
m_lblk
 = 0;

121 
m­
.
m_Ën
 = 0;

122 
m­
.
m_æags
 = 0;

124 ; 
Ä_·ges
;‚r_pages--) {

125 
fuÎy_m­³d
 = 1;

126 
fœ¡_hŞe
 = 
blocks_³r_·ge
;

128 
	`´eãtchw
(&
·ge
->
æags
);

129 ià(
·ges
) {

130 
·ge
 = 
	`li¡_’Œy
(
·ges
->
´ev
, ·ge, 
Ìu
);

131 
	`li¡_d–
(&
·ge
->
Ìu
);

132 ià(
	`add_to_·ge_ÿche_Ìu
(
·ge
, 
m­pšg
,…age->
šdex
,

133 
	`»adah—d_gå_mask
(
m­pšg
)))

134 
Ãxt_·ge
;

137 ià(
	`·ge_has_bufãrs
(
·ge
))

138 
cÚfu£d
;

140 
block_š_fe
 = (
£ùÜ_t
)
·ge
->
šdex
 << (
PAGE_SHIFT
 - 
blkb™s
);

141 
Ï¡_block
 = 
block_š_fe
 + 
Ä_·ges
 * 
blocks_³r_·ge
;

142 
Ï¡_block_š_fe
 = (
	`i_size_»ad
(
šode
è+ 
blocksize
 - 1è>> 
blkb™s
;

143 ià(
Ï¡_block
 > 
Ï¡_block_š_fe
)

144 
Ï¡_block
 = 
Ï¡_block_š_fe
;

145 
·ge_block
 = 0;

150 ià((
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
) &&

151 
block_š_fe
 > 
m­
.
m_lblk
 &&

152 
block_š_fe
 < (
m­
.
m_lblk
 + m­.
m_Ën
)) {

153 
m­_off£t
 = 
block_š_fe
 - 
m­
.
m_lblk
;

154 
Ï¡
 = 
m­
.
m_Ën
 - 
m­_off£t
;

156 
»Ïtive_block
 = 0; ;„elative_block++) {

157 ià(
»Ïtive_block
 =ğ
Ï¡
) {

159 
m­
.
m_æags
 &ğ~
EXT4_MAP_MAPPED
;

162 ià(
·ge_block
 =ğ
blocks_³r_·ge
)

164 
blocks
[
·ge_block
] = 
m­
.
m_pblk
 + 
m­_off£t
 +

165 
»Ïtive_block
;

166 
·ge_block
++;

167 
block_š_fe
++;

175 
·ge_block
 < 
blocks_³r_·ge
) {

176 ià(
block_š_fe
 < 
Ï¡_block
) {

177 
m­
.
m_lblk
 = 
block_š_fe
;

178 
m­
.
m_Ën
 = 
Ï¡_block
 - 
block_š_fe
;

180 ià(
	`ext4_m­_blocks
(
NULL
, 
šode
, &
m­
, 0) < 0) {

181 
£t_”rÜ_·ge
:

182 
	`S‘PageE¼Ü
(
·ge
);

183 
	`z”o_u£r_£gm’t
(
·ge
, 0,

184 
PAGE_SIZE
);

185 
	`uÆock_·ge
(
·ge
);

186 
Ãxt_·ge
;

189 ià((
m­
.
m_æags
 & 
EXT4_MAP_MAPPED
) == 0) {

190 
fuÎy_m­³d
 = 0;

191 ià(
fœ¡_hŞe
 =ğ
blocks_³r_·ge
)

192 
fœ¡_hŞe
 = 
·ge_block
;

193 
·ge_block
++;

194 
block_š_fe
++;

197 ià(
fœ¡_hŞe
 !ğ
blocks_³r_·ge
)

198 
cÚfu£d
;

201 ià(
·ge_block
 && 
blocks
[·ge_block-1] !ğ
m­
.
m_pblk
-1)

202 
cÚfu£d
;

203 
»Ïtive_block
 = 0; ;„elative_block++) {

204 ià(
»Ïtive_block
 =ğ
m­
.
m_Ën
) {

206 
m­
.
m_æags
 &ğ~
EXT4_MAP_MAPPED
;

208 } ià(
·ge_block
 =ğ
blocks_³r_·ge
)

210 
blocks
[
·ge_block
] = 
m­
.
m_pblk
+
»Ïtive_block
;

211 
·ge_block
++;

212 
block_š_fe
++;

215 ià(
fœ¡_hŞe
 !ğ
blocks_³r_·ge
) {

216 
	`z”o_u£r_£gm’t
(
·ge
, 
fœ¡_hŞe
 << 
blkb™s
,

217 
PAGE_SIZE
);

218 ià(
fœ¡_hŞe
 == 0) {

219 
	`S‘PageU±od©e
(
·ge
);

220 
	`uÆock_·ge
(
·ge
);

221 
Ãxt_·ge
;

223 } ià(
fuÎy_m­³d
) {

224 
	`S‘PageM­³dToDisk
(
·ge
);

226 ià(
fuÎy_m­³d
 && 
blocks_³r_·ge
 == 1 &&

227 !
	`PageU±od©e
(
·ge
è&& 
	`ş—nÿche_g‘_·ge
(page) == 0) {

228 
	`S‘PageU±od©e
(
·ge
);

229 
cÚfu£d
;

236 ià(
bio
 && (
Ï¡_block_š_bio
 !ğ
blocks
[0] - 1)) {

237 
subm™_ªd_»®loc
:

238 
	`subm™_bio
(
bio
);

239 
bio
 = 
NULL
;

241 ià(
bio
 =ğ
NULL
) {

242 
fsüy±_ùx
 *
ùx
 = 
NULL
;

244 ià(
	`ext4_’üy±ed_šode
(
šode
) &&

245 
	`S_ISREG
(
šode
->
i_mode
)) {

246 
ùx
 = 
	`fsüy±_g‘_ùx
(
šode
, 
GFP_NOFS
);

247 ià(
	`IS_ERR
(
ùx
))

248 
£t_”rÜ_·ge
;

250 
bio
 = 
	`bio_®loc
(
GFP_KERNEL
,

251 
	`mš_t
(, 
Ä_·ges
, 
BIO_MAX_PAGES
));

252 ià(!
bio
) {

253 ià(
ùx
)

254 
	`fsüy±_»Ëa£_ùx
(
ùx
);

255 
£t_”rÜ_·ge
;

257 
bio
->
bi_bdev
 = 
bdev
;

258 
bio
->
bi_™”
.
bi_£ùÜ
 = 
blocks
[0] << (
blkb™s
 - 9);

259 
bio
->
bi_’d_io
 = 
m·ge_’d_io
;

260 
bio
->
bi_´iv©e
 = 
ùx
;

261 
	`bio_£t_İ_©Œs
(
bio
, 
REQ_OP_READ
, 0);

264 
Ëngth
 = 
fœ¡_hŞe
 << 
blkb™s
;

265 ià(
	`bio_add_·ge
(
bio
, 
·ge
, 
Ëngth
, 0) <†ength)

266 
subm™_ªd_»®loc
;

268 ià(((
m­
.
m_æags
 & 
EXT4_MAP_BOUNDARY
) &&

269 (
»Ïtive_block
 =ğ
m­
.
m_Ën
)) ||

270 (
fœ¡_hŞe
 !ğ
blocks_³r_·ge
)) {

271 
	`subm™_bio
(
bio
);

272 
bio
 = 
NULL
;

274 
Ï¡_block_š_bio
 = 
blocks
[
blocks_³r_·ge
 - 1];

275 
Ãxt_·ge
;

276 
cÚfu£d
:

277 ià(
bio
) {

278 
	`subm™_bio
(
bio
);

279 
bio
 = 
NULL
;

281 ià(!
	`PageU±od©e
(
·ge
))

282 
	`block_»ad_fuÎ_·ge
(
·ge
, 
ext4_g‘_block
);

284 
	`uÆock_·ge
(
·ge
);

285 
Ãxt_·ge
:

286 ià(
·ges
)

287 
	`put_·ge
(
·ge
);

289 
	`BUG_ON
(
·ges
 && !
	`li¡_em±y
(pages));

290 ià(
bio
)

291 
	`subm™_bio
(
bio
);

293 
	}
}

	@resize.c

12 
	#EXT4FS_DEBUG


	)

14 
	~<lšux/”ºo.h
>

15 
	~<lšux/¦ab.h
>

17 
	~"ext4_jbd2.h
"

19 
	$ext4_»size_begš
(
su³r_block
 *
sb
)

21 
»t
 = 0;

23 ià(!
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

24  -
EPERM
;

31 ià(
	`EXT4_SB
(
sb
)->
s_sbh
->
b_blockÄ
 !=

32 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_d©a_block
)) {

33 
	`ext4_w¬nšg
(
sb
, "won't„esize using backup superblock‡t %llu",

34 ()
	`EXT4_SB
(
sb
)->
s_sbh
->
b_blockÄ
);

35  -
EPERM
;

42 ià(
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 & 
EXT4_ERROR_FS
) {

43 
	`ext4_w¬nšg
(
sb
, "There‡reƒrrors inhe filesystem, "

45  -
EPERM
;

48 ià(
	`‹¡_ªd_£t_b™_lock
(
EXT4_FLAGS_RESIZING
,

49 &
	`EXT4_SB
(
sb
)->
s_ext4_æags
))

50 
»t
 = -
EBUSY
;

52  
»t
;

53 
	}
}

55 
	$ext4_»size_’d
(
su³r_block
 *
sb
)

57 
	`ş—r_b™_uÆock
(
EXT4_FLAGS_RESIZING
, &
	`EXT4_SB
(
sb
)->
s_ext4_æags
);

58 
	`smp_mb__aá”_©omic
();

59 
	}
}

61 
ext4_group_t
 
	$ext4_m‘a_bg_fœ¡_group
(
su³r_block
 *
sb
,

62 
ext4_group_t
 
group
) {

63  (
group
 >> 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
)) <<

64 
	`EXT4_DESC_PER_BLOCK_BITS
(
sb
);

65 
	}
}

67 
ext4_fsblk_t
 
	$ext4_m‘a_bg_fœ¡_block_no
(
su³r_block
 *
sb
,

68 
ext4_group_t
 
group
) {

69 
group
 = 
	`ext4_m‘a_bg_fœ¡_group
(
sb
, group);

70  
	`ext4_group_fœ¡_block_no
(
sb
, 
group
);

71 
	}
}

73 
ext4_g½blk_t
 
	$ext4_group_ov”h—d_blocks
(
su³r_block
 *
sb
,

74 
ext4_group_t
 
group
) {

75 
ext4_g½blk_t
 
ov”h—d
;

76 
ov”h—d
 = 
	`ext4_bg_num_gdb
(
sb
, 
group
);

77 ià(
	`ext4_bg_has_su³r
(
sb
, 
group
))

78 
ov”h—d
 += 1 +

79 
	`Ë16_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_»£rved_gdt_blocks
);

80  
ov”h—d
;

81 
	}
}

83 
	#outside
(
b
, 
fœ¡
, 
Ï¡
è((bè< (fœ¡è|| (bè>ğÖa¡))

	)

84 
	#šside
(
b
, 
fœ¡
, 
Ï¡
è((bè>ğ(fœ¡è&& (bè< (Ï¡))

	)

86 
	$v”ify_group_šput
(
su³r_block
 *
sb
,

87 
ext4_Ãw_group_d©a
 *
šput
)

89 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

90 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

91 
ext4_fsblk_t
 
¡¬t
 = 
	`ext4_blocks_couÁ
(
es
);

92 
ext4_fsblk_t
 
’d
 = 
¡¬t
 + 
šput
->
blocks_couÁ
;

93 
ext4_group_t
 
group
 = 
šput
->group;

94 
ext4_fsblk_t
 
™’d
 = 
šput
->
šode_bË
 + 
sbi
->
s_™b_³r_group
;

95 
ov”h—d
;

96 
ext4_fsblk_t
 
m‘«nd
;

97 
bufãr_h—d
 *
bh
 = 
NULL
;

98 
ext4_g½blk_t
 
ä“_blocks_couÁ
, 
off£t
;

99 
”r
 = -
EINVAL
;

101 ià(
group
 !ğ
sbi
->
s_groups_couÁ
) {

102 
	`ext4_w¬nšg
(
sb
, "Cannot‡dd‡t group %u (only %u groups)",

103 
šput
->
group
, 
sbi
->
s_groups_couÁ
);

104  -
EINVAL
;

107 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
group
);

108 
m‘«nd
 = 
¡¬t
 + 
ov”h—d
;

109 
šput
->
ä“_blocks_couÁ
 = free_blocks_count =

110 
šput
->
blocks_couÁ
 - 2 - 
ov”h—d
 - 
sbi
->
s_™b_³r_group
;

112 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

113 
	`´štk
(
KERN_DEBUG
 "EXT4-fs:‡dding %s group %u: %u blocks "

115 
	`ext4_bg_has_su³r
(
sb
, 
šput
->
group
) ? "normal" :

116 "no-su³r", 
šput
->
group
, iÅut->
blocks_couÁ
,

117 
ä“_blocks_couÁ
, 
šput
->
»£rved_blocks
);

119 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
¡¬t
, 
NULL
, &
off£t
);

120 ià(
off£t
 != 0)

121 
	`ext4_w¬nšg
(
sb
, "Last group‚ot full");

122 ià(
šput
->
»£rved_blocks
 > iÅut->
blocks_couÁ
 / 5)

123 
	`ext4_w¬nšg
(
sb
, "Reserved blocksoo high (%u)",

124 
šput
->
»£rved_blocks
);

125 ià(
ä“_blocks_couÁ
 < 0)

126 
	`ext4_w¬nšg
(
sb
, "Bad blocks count %u",

127 
šput
->
blocks_couÁ
);

128 ià(!(
bh
 = 
	`sb_b»ad
(
sb
, 
’d
 - 1)))

129 
	`ext4_w¬nšg
(
sb
, "Cannot„ead†ast block (%llu)",

130 
’d
 - 1);

131 ià(
	`outside
(
šput
->
block_b™m­
, 
¡¬t
, 
’d
))

132 
	`ext4_w¬nšg
(
sb
, "Block bitmap‚ot in group (block %llu)",

133 ()
šput
->
block_b™m­
);

134 ià(
	`outside
(
šput
->
šode_b™m­
, 
¡¬t
, 
’d
))

135 
	`ext4_w¬nšg
(
sb
, "Inode bitmap‚ot in group (block %llu)",

136 ()
šput
->
šode_b™m­
);

137 ià(
	`outside
(
šput
->
šode_bË
, 
¡¬t
, 
’d
) ||

138 
	`outside
(
™’d
 - 1, 
¡¬t
, 
’d
))

139 
	`ext4_w¬nšg
(
sb
, "Inodeable‚ot in group (blocks %llu-%llu)",

140 ()
šput
->
šode_bË
, 
™’d
 - 1);

141 ià(
šput
->
šode_b™m­
 =ğšput->
block_b™m­
)

142 
	`ext4_w¬nšg
(
sb
, "Block bitmap same‡s inode bitmap (%llu)",

143 ()
šput
->
block_b™m­
);

144 ià(
	`šside
(
šput
->
block_b™m­
, iÅut->
šode_bË
, 
™’d
))

145 
	`ext4_w¬nšg
(
sb
, "Block bitmap (%llu) in inodeable "

147 ()
šput
->
block_b™m­
,

148 ()
šput
->
šode_bË
, 
™’d
 - 1);

149 ià(
	`šside
(
šput
->
šode_b™m­
, iÅut->
šode_bË
, 
™’d
))

150 
	`ext4_w¬nšg
(
sb
, "Inode bitmap (%llu) in inodeable "

152 ()
šput
->
šode_b™m­
,

153 ()
šput
->
šode_bË
, 
™’d
 - 1);

154 ià(
	`šside
(
šput
->
block_b™m­
, 
¡¬t
, 
m‘«nd
))

155 
	`ext4_w¬nšg
(
sb
, "Block bitmap (%llu) in GDTable (%llu-%llu)",

156 ()
šput
->
block_b™m­
,

157 
¡¬t
, 
m‘«nd
 - 1);

158 ià(
	`šside
(
šput
->
šode_b™m­
, 
¡¬t
, 
m‘«nd
))

159 
	`ext4_w¬nšg
(
sb
, "Inode bitmap (%llu) in GDTable (%llu-%llu)",

160 ()
šput
->
šode_b™m­
,

161 
¡¬t
, 
m‘«nd
 - 1);

162 ià(
	`šside
(
šput
->
šode_bË
, 
¡¬t
, 
m‘«nd
) ||

163 
	`šside
(
™’d
 - 1, 
¡¬t
, 
m‘«nd
))

164 
	`ext4_w¬nšg
(
sb
, "Inodeable (%llu-%llu) overlaps GDTable "

166 ()
šput
->
šode_bË
,

167 
™’d
 - 1, 
¡¬t
, 
m‘«nd
 - 1);

169 
”r
 = 0;

170 
	`b»l£
(
bh
);

172  
”r
;

173 
	}
}

179 
	sext4_Ãw_æex_group_d©a
 {

180 
ext4_Ãw_group_d©a
 *
	mgroups
;

182 
__u16
 *
	mbg_æags
;

184 
ext4_group_t
 
	mcouÁ
;

194 
ext4_Ãw_æex_group_d©a
 *
	$®loc_æex_gd
(
æexbg_size
)

196 
ext4_Ãw_æex_group_d©a
 *
æex_gd
;

198 
æex_gd
 = 
	`km®loc
((*æex_gd), 
GFP_NOFS
);

199 ià(
æex_gd
 =ğ
NULL
)

200 
out3
;

202 ià(
æexbg_size
 >ğ
UINT_MAX
 / (
ext4_Ãw_group_d©a
))

203 
out2
;

204 
æex_gd
->
couÁ
 = 
æexbg_size
;

206 
æex_gd
->
groups
 = 
	`km®loc
((
ext4_Ãw_group_d©a
) *

207 
æexbg_size
, 
GFP_NOFS
);

208 ià(
æex_gd
->
groups
 =ğ
NULL
)

209 
out2
;

211 
æex_gd
->
bg_æags
 = 
	`km®loc
(
æexbg_size
 * (
__u16
), 
GFP_NOFS
);

212 ià(
æex_gd
->
bg_æags
 =ğ
NULL
)

213 
out1
;

215  
æex_gd
;

217 
out1
:

218 
	`kä“
(
æex_gd
->
groups
);

219 
out2
:

220 
	`kä“
(
æex_gd
);

221 
out3
:

222  
NULL
;

223 
	}
}

225 
	$ä“_æex_gd
(
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

227 
	`kä“
(
æex_gd
->
bg_æags
);

228 
	`kä“
(
æex_gd
->
groups
);

229 
	`kä“
(
æex_gd
);

230 
	}
}

245 
	$ext4_®loc_group_bËs
(
su³r_block
 *
sb
,

246 
ext4_Ãw_æex_group_d©a
 *
æex_gd
,

247 
æexbg_size
)

249 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

250 
ext4_fsblk_t
 
¡¬t_blk
;

251 
ext4_fsblk_t
 
Ï¡_blk
;

252 
ext4_group_t
 
¤c_group
;

253 
ext4_group_t
 
bb_šdex
 = 0;

254 
ext4_group_t
 
ib_šdex
 = 0;

255 
ext4_group_t
 
™_šdex
 = 0;

256 
ext4_group_t
 
group
;

257 
ext4_group_t
 
Ï¡_group
;

258 
ov”h—d
;

259 
__u16
 
unš™_mask
 = (
æexbg_size
 > 1è? ~
EXT4_BG_BLOCK_UNINIT
 : ~0;

261 
	`BUG_ON
(
æex_gd
->
couÁ
 =ğ0 || 
group_d©a
 =ğ
NULL
);

263 
¤c_group
 = 
group_d©a
[0].
group
;

264 
Ï¡_group
 = 
¤c_group
 + 
æex_gd
->
couÁ
 - 1;

266 
	`BUG_ON
((
æexbg_size
 > 1è&& ((
¤c_group
 & ~(flexbg_size - 1)) !=

267 (
Ï¡_group
 & ~(
æexbg_size
 - 1))));

268 
Ãxt_group
:

269 
group
 = 
group_d©a
[0].group;

270 ià(
¤c_group
 >ğ
group_d©a
[0].
group
 + 
æex_gd
->
couÁ
)

271  -
ENOSPC
;

272 
¡¬t_blk
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
¤c_group
);

273 
Ï¡_blk
 = 
¡¬t_blk
 + 
group_d©a
[
¤c_group
 - 
group
].
blocks_couÁ
;

275 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
¤c_group
);

277 
¡¬t_blk
 +ğ
ov”h—d
;

280 
¤c_group
++;

281 ; 
¤c_group
 <ğ
Ï¡_group
; src_group++) {

282 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
¤c_group
);

283 ià(
ov”h—d
 == 0)

284 
Ï¡_blk
 +ğ
group_d©a
[
¤c_group
 - 
group
].
blocks_couÁ
;

290 ; 
bb_šdex
 < 
æex_gd
->
couÁ
; bb_index++) {

291 ià(
¡¬t_blk
 >ğ
Ï¡_blk
)

292 
Ãxt_group
;

293 
group_d©a
[
bb_šdex
].
block_b™m­
 = 
¡¬t_blk
++;

294 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
¡¬t_blk
 - 1);

295 
group
 -ğ
group_d©a
[0].group;

296 
group_d©a
[
group
].
ä“_blocks_couÁ
--;

297 
æex_gd
->
bg_æags
[
group
] &ğ
unš™_mask
;

301 ; 
ib_šdex
 < 
æex_gd
->
couÁ
; ib_index++) {

302 ià(
¡¬t_blk
 >ğ
Ï¡_blk
)

303 
Ãxt_group
;

304 
group_d©a
[
ib_šdex
].
šode_b™m­
 = 
¡¬t_blk
++;

305 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
¡¬t_blk
 - 1);

306 
group
 -ğ
group_d©a
[0].group;

307 
group_d©a
[
group
].
ä“_blocks_couÁ
--;

308 
æex_gd
->
bg_æags
[
group
] &ğ
unš™_mask
;

312 ; 
™_šdex
 < 
æex_gd
->
couÁ
; it_index++) {

313 
™b
 = 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
;

314 
ext4_fsblk_t
 
Ãxt_group_¡¬t
;

316 ià(
¡¬t_blk
 + 
™b
 > 
Ï¡_blk
)

317 
Ãxt_group
;

318 
group_d©a
[
™_šdex
].
šode_bË
 = 
¡¬t_blk
;

319 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
¡¬t_blk
);

320 
Ãxt_group_¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
 + 1);

321 
group
 -ğ
group_d©a
[0].group;

323 ià(
¡¬t_blk
 + 
™b
 > 
Ãxt_group_¡¬t
) {

324 
æex_gd
->
bg_æags
[
group
 + 1] &ğ
unš™_mask
;

325 
ov”h—d
 = 
¡¬t_blk
 + 
™b
 - 
Ãxt_group_¡¬t
;

326 
group_d©a
[
group
 + 1].
ä“_blocks_couÁ
 -ğ
ov”h—d
;

327 
™b
 -ğ
ov”h—d
;

330 
group_d©a
[
group
].
ä“_blocks_couÁ
 -ğ
™b
;

331 
æex_gd
->
bg_æags
[
group
] &ğ
unš™_mask
;

332 
¡¬t_blk
 +ğ
	`EXT4_SB
(
sb
)->
s_™b_³r_group
;

335 ià(
	`‹¡_İt
(
sb
, 
DEBUG
)) {

336 
i
;

337 
group
 = 
group_d©a
[0].group;

339 
	`´štk
(
KERN_DEBUG
 "EXT4-fs:‡dding‡ flex group with "

340 "%d groups, fËxbg sizi %d:\n", 
æex_gd
->
couÁ
,

341 
æexbg_size
);

343 
i
 = 0; i < 
æex_gd
->
couÁ
; i++) {

344 
	`´štk
(
KERN_DEBUG
 "adding %s group %u: %u "

346 
	`ext4_bg_has_su³r
(
sb
, 
group
 + 
i
) ? "normal" :

347 "no-su³r", 
group
 + 
i
,

348 
group_d©a
[
i
].
blocks_couÁ
,

349 
group_d©a
[
i
].
ä“_blocks_couÁ
);

353 
	}
}

355 
bufãr_h—d
 *
	$bş—n
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

356 
ext4_fsblk_t
 
blk
)

358 
bufãr_h—d
 *
bh
;

359 
”r
;

361 
bh
 = 
	`sb_g‘blk
(
sb
, 
blk
);

362 ià(
	`uÆik–y
(!
bh
))

363  
	`ERR_PTR
(-
ENOMEM
);

364 
	`BUFFER_TRACE
(
bh
, "get_write_access");

365 ià((
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
))) {

366 
	`b»l£
(
bh
);

367 
bh
 = 
	`ERR_PTR
(
”r
);

369 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

370 
	`£t_bufãr_u±od©e
(
bh
);

373  
bh
;

374 
	}
}

381 
	$ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË_t
 *
hªdË
, 
th»sh
)

383 
”r
;

385 ià(
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
, 
th»sh
))

388 
”r
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
EXT4_MAX_TRANS_DATA
);

389 ià(
”r
 < 0)

390  
”r
;

391 ià(
”r
) {

392 
”r
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
EXT4_MAX_TRANS_DATA
);

393 ià(
”r
)

394  
”r
;

398 
	}
}

409 
	$£t_æexbg_block_b™m­
(
su³r_block
 *
sb
, 
hªdË_t
 *
hªdË
,

410 
ext4_Ãw_æex_group_d©a
 *
æex_gd
,

411 
ext4_fsblk_t
 
block
, 
ext4_group_t
 
couÁ
)

413 
ext4_group_t
 
couÁ2
;

415 
	`ext4_debug
("m¬k block [%Îu/%u] u£d\n", 
block
, 
couÁ
);

416 
couÁ2
 = 
couÁ
; couÁ > 0; couÁ -ğcouÁ2, 
block
 += count2) {

417 
ext4_fsblk_t
 
¡¬t
;

418 
bufãr_h—d
 *
bh
;

419 
ext4_group_t
 
group
;

420 
”r
;

422 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
block
);

423 
¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
);

424 
group
 -ğ
æex_gd
->
groups
[0].group;

426 
couÁ2
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
è- (
block
 - 
¡¬t
);

427 ià(
couÁ2
 > 
couÁ
)

428 
couÁ2
 = 
couÁ
;

430 ià(
æex_gd
->
bg_æags
[
group
] & 
EXT4_BG_BLOCK_UNINIT
) {

431 
	`BUG_ON
(
æex_gd
->
couÁ
 > 1);

435 
”r
 = 
	`ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË
, 1);

436 ià(
”r
)

437  
”r
;

439 
bh
 = 
	`sb_g‘blk
(
sb
, 
æex_gd
->
groups
[
group
].
block_b™m­
);

440 ià(
	`uÆik–y
(!
bh
))

441  -
ENOMEM
;

443 
	`BUFFER_TRACE
(
bh
, "get_write_access");

444 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

445 ià(
”r
)

446  
”r
;

447 
	`ext4_debug
("m¬k block b™m­ %#04Îx (+%Îu/%u)\n", 
block
,

448 
block
 - 
¡¬t
, 
couÁ2
);

449 
	`ext4_£t_b™s
(
bh
->
b_d©a
, 
block
 - 
¡¬t
, 
couÁ2
);

451 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

452 ià(
	`uÆik–y
(
”r
))

453  
”r
;

454 
	`b»l£
(
bh
);

458 
	}
}

474 
	$£tup_Ãw_æex_group_blocks
(
su³r_block
 *
sb
,

475 
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

477 
group_bË_couÁ
[] = {1, 1, 
	`EXT4_SB
(
sb
)->
s_™b_³r_group
};

478 
ext4_fsblk_t
 
¡¬t
;

479 
ext4_fsblk_t
 
block
;

480 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

481 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

482 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

483 
__u16
 *
bg_æags
 = 
æex_gd
->bg_flags;

484 
hªdË_t
 *
hªdË
;

485 
ext4_group_t
 
group
, 
couÁ
;

486 
bufãr_h—d
 *
bh
 = 
NULL
;

487 
»£rved_gdb
, 
i
, 
j
, 
”r
 = 0, 
”r2
;

488 
m‘a_bg
;

490 
	`BUG_ON
(!
æex_gd
->
couÁ
 || !
group_d©a
 ||

491 
group_d©a
[0].
group
 !ğ
sbi
->
s_groups_couÁ
);

493 
»£rved_gdb
 = 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
);

494 
m‘a_bg
 = 
	`ext4_has_ã©u»_m‘a_bg
(
sb
);

497 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 
EXT4_MAX_TRANS_DATA
);

498 ià(
	`IS_ERR
(
hªdË
))

499  
	`PTR_ERR
(
hªdË
);

501 
group
 = 
group_d©a
[0].group;

502 
i
 = 0; i < 
æex_gd
->
couÁ
; i++, 
group
++) {

503 
gdblocks
;

504 
ext4_g½blk_t
 
ov”h—d
;

506 
gdblocks
 = 
	`ext4_bg_num_gdb
(
sb
, 
group
);

507 
¡¬t
 = 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
);

509 ià(
m‘a_bg
 =ğ0 && !
	`ext4_bg_has_su³r
(
sb
, 
group
))

510 
hªdË_™b
;

512 ià(
m‘a_bg
 == 1) {

513 
ext4_group_t
 
fœ¡_group
;

514 
fœ¡_group
 = 
	`ext4_m‘a_bg_fœ¡_group
(
sb
, 
group
);

515 ià(
fœ¡_group
 !ğ
group
 + 1 &&

516 
fœ¡_group
 !ğ
group
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1)

517 
hªdË_™b
;

520 
block
 = 
¡¬t
 + 
	`ext4_bg_has_su³r
(
sb
, 
group
);

522 
j
 = 0; j < 
gdblocks
; j++, 
block
++) {

523 
bufãr_h—d
 *
gdb
;

525 
	`ext4_debug
("upd©backu°grou°%#04Îx\n", 
block
);

526 
”r
 = 
	`ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË
, 1);

527 ià(
”r
)

528 
out
;

530 
gdb
 = 
	`sb_g‘blk
(
sb
, 
block
);

531 ià(
	`uÆik–y
(!
gdb
)) {

532 
”r
 = -
ENOMEM
;

533 
out
;

536 
	`BUFFER_TRACE
(
gdb
, "get_write_access");

537 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdb
);

538 ià(
”r
) {

539 
	`b»l£
(
gdb
);

540 
out
;

542 
	`memıy
(
gdb
->
b_d©a
, 
sbi
->
s_group_desc
[
j
]->b_data,

543 
gdb
->
b_size
);

544 
	`£t_bufãr_u±od©e
(
gdb
);

546 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gdb
);

547 ià(
	`uÆik–y
(
”r
)) {

548 
	`b»l£
(
gdb
);

549 
out
;

551 
	`b»l£
(
gdb
);

557 ià(
	`ext4_bg_has_su³r
(
sb
, 
group
)) {

558 
”r
 = 
	`sb_issue_z”oout
(
sb
, 
gdblocks
 + 
¡¬t
 + 1,

559 
»£rved_gdb
, 
GFP_NOFS
);

560 ià(
”r
)

561 
out
;

564 
hªdË_™b
:

566 ià(!(
bg_æags
[
i
] & 
EXT4_BG_INODE_ZEROED
))

567 
hªdË_bb
;

570 
block
 = 
group_d©a
[
i
].
šode_bË
;

571 
	`ext4_debug
("clear inodeable blocks %#04llx -> %#04lx\n",

572 
block
, 
sbi
->
s_™b_³r_group
);

573 
”r
 = 
	`sb_issue_z”oout
(
sb
, 
block
, 
sbi
->
s_™b_³r_group
,

574 
GFP_NOFS
);

575 ià(
”r
)

576 
out
;

578 
hªdË_bb
:

579 ià(
bg_æags
[
i
] & 
EXT4_BG_BLOCK_UNINIT
)

580 
hªdË_ib
;

583 
block
 = 
group_d©a
[
i
].
block_b™m­
;

584 
”r
 = 
	`ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË
, 1);

585 ià(
”r
)

586 
out
;

588 
bh
 = 
	`bş—n
(
hªdË
, 
sb
, 
block
);

589 ià(
	`IS_ERR
(
bh
)) {

590 
”r
 = 
	`PTR_ERR
(
bh
);

591 
bh
 = 
NULL
;

592 
out
;

594 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
group
);

595 ià(
ov”h—d
 != 0) {

596 
	`ext4_debug
("mark backup superblock %#04llx (+0)\n",

597 
¡¬t
);

598 
	`ext4_£t_b™s
(
bh
->
b_d©a
, 0, 
ov”h—d
);

600 
	`ext4_m¬k_b™m­_’d
(
group_d©a
[
i
].
blocks_couÁ
,

601 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

602 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

603 ià(
”r
)

604 
out
;

605 
	`b»l£
(
bh
);

607 
hªdË_ib
:

608 ià(
bg_æags
[
i
] & 
EXT4_BG_INODE_UNINIT
)

612 
block
 = 
group_d©a
[
i
].
šode_b™m­
;

613 
”r
 = 
	`ex‹nd_Ü_»¡¬t_Œª§ùiÚ
(
hªdË
, 1);

614 ià(
”r
)

615 
out
;

617 
bh
 = 
	`bş—n
(
hªdË
, 
sb
, 
block
);

618 ià(
	`IS_ERR
(
bh
)) {

619 
”r
 = 
	`PTR_ERR
(
bh
);

620 
bh
 = 
NULL
;

621 
out
;

624 
	`ext4_m¬k_b™m­_’d
(
	`EXT4_INODES_PER_GROUP
(
sb
),

625 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

626 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

627 ià(
”r
)

628 
out
;

629 
	`b»l£
(
bh
);

631 
bh
 = 
NULL
;

634 
j
 = 0; j < 
GROUP_TABLE_COUNT
; j++) {

635 
couÁ
 = 
group_bË_couÁ
[
j
];

636 
¡¬t
 = (&
group_d©a
[0].
block_b™m­
)[
j
];

637 
block
 = 
¡¬t
;

638 
i
 = 1; i < 
æex_gd
->
couÁ
; i++) {

639 
block
 +ğ
group_bË_couÁ
[
j
];

640 ià(
block
 =ğ(&
group_d©a
[
i
].
block_b™m­
)[
j
]) {

641 
couÁ
 +ğ
group_bË_couÁ
[
j
];

644 
”r
 = 
	`£t_æexbg_block_b™m­
(
sb
, 
hªdË
,

645 
æex_gd
, 
¡¬t
, 
couÁ
);

646 ià(
”r
)

647 
out
;

648 
couÁ
 = 
group_bË_couÁ
[
j
];

649 
¡¬t
 = (&
group_d©a
[
i
].
block_b™m­
)[
j
];

650 
block
 = 
¡¬t
;

653 ià(
couÁ
) {

654 
”r
 = 
	`£t_æexbg_block_b™m­
(
sb
, 
hªdË
,

655 
æex_gd
, 
¡¬t
, 
couÁ
);

656 ià(
”r
)

657 
out
;

661 
out
:

662 
	`b»l£
(
bh
);

663 
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

664 ià(
”r2
 && !
”r
)

665 
”r
 = 
”r2
;

667  
”r
;

668 
	}
}

677 
	$ext4_li¡_backups
(
su³r_block
 *
sb
, *
th»e
,

678 *
five
, *
£v’
)

680 *
mš
 = 
th»e
;

681 
muÉ
 = 3;

682 
»t
;

684 ià(!
	`ext4_has_ã©u»_¥¬£_su³r
(
sb
)) {

685 
»t
 = *
mš
;

686 *
mš
 += 1;

687  
»t
;

690 ià(*
five
 < *
mš
) {

691 
mš
 = 
five
;

692 
muÉ
 = 5;

694 ià(*
£v’
 < *
mš
) {

695 
mš
 = 
£v’
;

696 
muÉ
 = 7;

699 
»t
 = *
mš
;

700 *
mš
 *ğ
muÉ
;

702  
»t
;

703 
	}
}

710 
	$v”ify_»£rved_gdb
(
su³r_block
 *
sb
,

711 
ext4_group_t
 
’d
,

712 
bufãr_h—d
 *
´im¬y
)

714 cÚ¡ 
ext4_fsblk_t
 
blk
 = 
´im¬y
->
b_blockÄ
;

715 
th»e
 = 1;

716 
five
 = 5;

717 
£v’
 = 7;

718 
g½
;

719 
__Ë32
 *
p
 = (__Ë32 *)
´im¬y
->
b_d©a
;

720 
gdbackups
 = 0;

722 (
g½
 = 
	`ext4_li¡_backups
(
sb
, &
th»e
, &
five
, &
£v’
)è< 
’d
) {

723 ià(
	`Ë32_to_ıu
(*
p
++) !=

724 
g½
 * 
	`EXT4_BLOCKS_PER_GROUP
(
sb
è+ 
blk
){

725 
	`ext4_w¬nšg
(
sb
, "reserved GDT %llu"

727 
blk
, 
g½
,

728 
g½
 *

729 (
ext4_fsblk_t
)
	`EXT4_BLOCKS_PER_GROUP
(
sb
) +

730 
blk
);

731  -
EINVAL
;

733 ià(++
gdbackups
 > 
	`EXT4_ADDR_PER_BLOCK
(
sb
))

734  -
EFBIG
;

737  
gdbackups
;

738 
	}
}

753 
	$add_Ãw_gdb
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

754 
ext4_group_t
 
group
)

756 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

757 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

758 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

759 
ext4_fsblk_t
 
gdblock
 = 
	`EXT4_SB
(
sb
)->
s_sbh
->
b_blockÄ
 + 1 + 
gdb_num
;

760 
bufãr_h—d
 **
o_group_desc
, **
n_group_desc
;

761 
bufãr_h—d
 *
dšd
;

762 
bufãr_h—d
 *
gdb_bh
;

763 
gdbackups
;

764 
ext4_oc
 
oc
;

765 
__Ë32
 *
d©a
;

766 
”r
;

768 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

769 
	`´štk
(
KERN_DEBUG


771 
gdb_num
);

773 
gdb_bh
 = 
	`sb_b»ad
(
sb
, 
gdblock
);

774 ià(!
gdb_bh
)

775  -
EIO
;

777 
gdbackups
 = 
	`v”ify_»£rved_gdb
(
sb
, 
group
, 
gdb_bh
);

778 ià(
gdbackups
 < 0) {

779 
”r
 = 
gdbackups
;

780 
ex™_bh
;

783 
d©a
 = 
	`EXT4_I
(
šode
)->
i_d©a
 + 
EXT4_DIND_BLOCK
;

784 
dšd
 = 
	`sb_b»ad
(
sb
, 
	`Ë32_to_ıu
(*
d©a
));

785 ià(!
dšd
) {

786 
”r
 = -
EIO
;

787 
ex™_bh
;

790 
d©a
 = (
__Ë32
 *)
dšd
->
b_d©a
;

791 ià(
	`Ë32_to_ıu
(
d©a
[
gdb_num
 % 
	`EXT4_ADDR_PER_BLOCK
(
sb
)]è!ğ
gdblock
) {

792 
	`ext4_w¬nšg
(
sb
, "new group %u GDT block %llu‚ot„eserved",

793 
group
, 
gdblock
);

794 
”r
 = -
EINVAL
;

795 
ex™_dšd
;

798 
	`BUFFER_TRACE
(
	`EXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

799 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
	`EXT4_SB
(
sb
)->
s_sbh
);

800 ià(
	`uÆik–y
(
”r
))

801 
ex™_dšd
;

803 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

804 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdb_bh
);

805 ià(
	`uÆik–y
(
”r
))

806 
ex™_dšd
;

808 
	`BUFFER_TRACE
(
dšd
, "get_write_access");

809 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
dšd
);

810 ià(
	`uÆik–y
(
”r
))

811 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

814 
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
);

815 ià(
	`uÆik–y
(
”r
))

816 
ex™_dšd
;

818 
n_group_desc
 = 
	`ext4_kvm®loc
((
gdb_num
 + 1) *

819 (
bufãr_h—d
 *),

820 
GFP_NOFS
);

821 ià(!
n_group_desc
) {

822 
”r
 = -
ENOMEM
;

823 
	`ext4_w¬nšg
(
sb
, "notƒnough memory for %lu groups",

824 
gdb_num
 + 1);

825 
ex™_šode
;

837 
d©a
[
gdb_num
 % 
	`EXT4_ADDR_PER_BLOCK
(
sb
)] = 0;

838 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
dšd
);

839 ià(
	`uÆik–y
(
”r
)) {

840 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

841 
ex™_šode
;

843 
šode
->
i_blocks
 -ğ(
gdbackups
 + 1è* 
sb
->
s_blocksize
 >> 9;

844 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

845 
	`mem£t
(
gdb_bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

846 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gdb_bh
);

847 ià(
	`uÆik–y
(
”r
)) {

848 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

849 
ex™_šode
;

851 
	`b»l£
(
dšd
);

853 
o_group_desc
 = 
	`EXT4_SB
(
sb
)->
s_group_desc
;

854 
	`memıy
(
n_group_desc
, 
o_group_desc
,

855 
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
 * (
bufãr_h—d
 *));

856 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

857 
	`EXT4_SB
(
sb
)->
s_group_desc
 = 
n_group_desc
;

858 
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
++;

859 
	`kvä“
(
o_group_desc
);

861 
	`Ë16_add_ıu
(&
es
->
s_»£rved_gdt_blocks
, -1);

862 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

863 ià(
”r
)

864 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

866  
”r
;

868 
ex™_šode
:

869 
	`kvä“
(
n_group_desc
);

870 
	`b»l£
(
oc
.
bh
);

871 
ex™_dšd
:

872 
	`b»l£
(
dšd
);

873 
ex™_bh
:

874 
	`b»l£
(
gdb_bh
);

876 
	`ext4_debug
("Ëavšg w™hƒ¼Ü %d\n", 
”r
);

877  
”r
;

878 
	}
}

883 
	$add_Ãw_gdb_m‘a_bg
(
su³r_block
 *
sb
,

884 
hªdË_t
 *
hªdË
, 
ext4_group_t
 
group
) {

885 
ext4_fsblk_t
 
gdblock
;

886 
bufãr_h—d
 *
gdb_bh
;

887 
bufãr_h—d
 **
o_group_desc
, **
n_group_desc
;

888 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

889 
”r
;

891 
gdblock
 = 
	`ext4_m‘a_bg_fœ¡_block_no
(
sb
, 
group
) +

892 
	`ext4_bg_has_su³r
(
sb
, 
group
);

893 
gdb_bh
 = 
	`sb_b»ad
(
sb
, 
gdblock
);

894 ià(!
gdb_bh
)

895  -
EIO
;

896 
n_group_desc
 = 
	`ext4_kvm®loc
((
gdb_num
 + 1) *

897 (
bufãr_h—d
 *),

898 
GFP_NOFS
);

899 ià(!
n_group_desc
) {

900 
”r
 = -
ENOMEM
;

901 
	`ext4_w¬nšg
(
sb
, "notƒnough memory for %lu groups",

902 
gdb_num
 + 1);

903  
”r
;

906 
o_group_desc
 = 
	`EXT4_SB
(
sb
)->
s_group_desc
;

907 
	`memıy
(
n_group_desc
, 
o_group_desc
,

908 
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
 * (
bufãr_h—d
 *));

909 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

910 
	`EXT4_SB
(
sb
)->
s_group_desc
 = 
n_group_desc
;

911 
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
++;

912 
	`kvä“
(
o_group_desc
);

913 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

914 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdb_bh
);

915 ià(
	`uÆik–y
(
”r
))

916 
	`b»l£
(
gdb_bh
);

917  
”r
;

918 
	}
}

933 
	$»£rve_backup_gdb
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

934 
ext4_group_t
 
group
)

936 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

937 
»£rved_gdb
 =
	`Ë16_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_»£rved_gdt_blocks
);

938 
bufãr_h—d
 **
´im¬y
;

939 
bufãr_h—d
 *
dšd
;

940 
ext4_oc
 
oc
;

941 
ext4_fsblk_t
 
blk
;

942 
__Ë32
 *
d©a
, *
’d
;

943 
gdbackups
 = 0;

944 
»s
, 
i
;

945 
”r
;

947 
´im¬y
 = 
	`km®loc
(
»£rved_gdb
 * (*´im¬y), 
GFP_NOFS
);

948 ià(!
´im¬y
)

949  -
ENOMEM
;

951 
d©a
 = 
	`EXT4_I
(
šode
)->
i_d©a
 + 
EXT4_DIND_BLOCK
;

952 
dšd
 = 
	`sb_b»ad
(
sb
, 
	`Ë32_to_ıu
(*
d©a
));

953 ià(!
dšd
) {

954 
”r
 = -
EIO
;

955 
ex™_ä“
;

958 
blk
 = 
	`EXT4_SB
(
sb
)->
s_sbh
->
b_blockÄ
 + 1 + EXT4_SB(sb)->
s_gdb_couÁ
;

959 
d©a
 = (
__Ë32
 *)
dšd
->
b_d©a
 + (
	`EXT4_SB
(
sb
)->
s_gdb_couÁ
 %

960 
	`EXT4_ADDR_PER_BLOCK
(
sb
));

961 
’d
 = (
__Ë32
 *)
dšd
->
b_d©a
 + 
	`EXT4_ADDR_PER_BLOCK
(
sb
);

964 
»s
 = 0;„e < 
»£rved_gdb
;„es++, 
blk
++) {

965 ià(
	`Ë32_to_ıu
(*
d©a
è!ğ
blk
) {

966 
	`ext4_w¬nšg
(
sb
, "reserved block %llu"

968 
blk
,

969 ()(
d©a
 - (
__Ë32
 *)
dšd
->
b_d©a
));

970 
”r
 = -
EINVAL
;

971 
ex™_bh
;

973 
´im¬y
[
»s
] = 
	`sb_b»ad
(
sb
, 
blk
);

974 ià(!
´im¬y
[
»s
]) {

975 
”r
 = -
EIO
;

976 
ex™_bh
;

978 
gdbackups
 = 
	`v”ify_»£rved_gdb
(
sb
, 
group
, 
´im¬y
[
»s
]);

979 ià(
gdbackups
 < 0) {

980 
	`b»l£
(
´im¬y
[
»s
]);

981 
”r
 = 
gdbackups
;

982 
ex™_bh
;

984 ià(++
d©a
 >ğ
’d
)

985 
d©a
 = (
__Ë32
 *)
dšd
->
b_d©a
;

988 
i
 = 0; i < 
»£rved_gdb
; i++) {

989 
	`BUFFER_TRACE
(
´im¬y
[
i
], "get_write_access");

990 ià((
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
´im¬y
[
i
])))

991 
ex™_bh
;

994 ià((
”r
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
oc
)))

995 
ex™_bh
;

1001 
blk
 = 
group
 * 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

1002 
i
 = 0; i < 
»£rved_gdb
; i++) {

1003 
”r2
;

1004 
d©a
 = (
__Ë32
 *)
´im¬y
[
i
]->
b_d©a
;

1008 
d©a
[
gdbackups
] = 
	`ıu_to_Ë32
(
blk
 + 
´im¬y
[
i
]->
b_blockÄ
);

1009 
”r2
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
´im¬y
[
i
]);

1010 ià(!
”r
)

1011 
”r
 = 
”r2
;

1013 
šode
->
i_blocks
 +ğ
»£rved_gdb
 * 
sb
->
s_blocksize
 >> 9;

1014 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
oc
);

1016 
ex™_bh
:

1017 --
»s
 >= 0)

1018 
	`b»l£
(
´im¬y
[
»s
]);

1019 
	`b»l£
(
dšd
);

1021 
ex™_ä“
:

1022 
	`kä“
(
´im¬y
);

1024  
”r
;

1025 
	}
}

1043 
	$upd©e_backups
(
su³r_block
 *
sb
, 
£ùÜ_t
 
blk_off
, *
d©a
,

1044 
size
, 
m‘a_bg
)

1046 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1047 
ext4_group_t
 
Ï¡
;

1048 cÚ¡ 
bpg
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

1049 
th»e
 = 1;

1050 
five
 = 5;

1051 
£v’
 = 7;

1052 
ext4_group_t
 
group
 = 0;

1053 
»¡
 = 
sb
->
s_blocksize
 - 
size
;

1054 
hªdË_t
 *
hªdË
;

1055 
”r
 = 0, 
”r2
;

1057 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 
EXT4_MAX_TRANS_DATA
);

1058 ià(
	`IS_ERR
(
hªdË
)) {

1059 
group
 = 1;

1060 
”r
 = 
	`PTR_ERR
(
hªdË
);

1061 
ex™_”r
;

1064 ià(
m‘a_bg
 == 0) {

1065 
group
 = 
	`ext4_li¡_backups
(
sb
, &
th»e
, &
five
, &
£v’
);

1066 
Ï¡
 = 
sbi
->
s_groups_couÁ
;

1068 
group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
blk_off
) + 1;

1069 
Ï¡
 = (
ext4_group_t
)(
group
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 2);

1072 
group
 < 
sbi
->
s_groups_couÁ
) {

1073 
bufãr_h—d
 *
bh
;

1074 
ext4_fsblk_t
 
backup_block
;

1077 ià(
	`ext4_hªdË_v®id
(
hªdË
) &&

1078 
hªdË
->
h_bufãr_üed™s
 == 0 &&

1079 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
EXT4_MAX_TRANS_DATA
) &&

1080 (
”r
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
EXT4_MAX_TRANS_DATA
)))

1083 ià(
m‘a_bg
 == 0)

1084 
backup_block
 = ((
ext4_fsblk_t
)
group
è* 
bpg
 + 
blk_off
;

1086 
backup_block
 = (
	`ext4_group_fœ¡_block_no
(
sb
, 
group
) +

1087 
	`ext4_bg_has_su³r
(
sb
, 
group
));

1089 
bh
 = 
	`sb_g‘blk
(
sb
, 
backup_block
);

1090 ià(
	`uÆik–y
(!
bh
)) {

1091 
”r
 = -
ENOMEM
;

1094 
	`ext4_debug
("update metadata backup %llu(+%llu)\n",

1095 
backup_block
, backup_block -

1096 
	`ext4_group_fœ¡_block_no
(
sb
, 
group
));

1097 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1098 ià((
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
)))

1100 
	`lock_bufãr
(
bh
);

1101 
	`memıy
(
bh
->
b_d©a
, 
d©a
, 
size
);

1102 ià(
»¡
)

1103 
	`mem£t
(
bh
->
b_d©a
 + 
size
, 0, 
»¡
);

1104 
	`£t_bufãr_u±od©e
(
bh
);

1105 
	`uÆock_bufãr
(
bh
);

1106 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

1107 ià(
	`uÆik–y
(
”r
))

1108 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1109 
	`b»l£
(
bh
);

1111 ià(
m‘a_bg
 == 0)

1112 
group
 = 
	`ext4_li¡_backups
(
sb
, &
th»e
, &
five
, &
£v’
);

1113 ià(
group
 =ğ
Ï¡
)

1116 
group
 = 
Ï¡
;

1118 ià((
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
)è&& !
”r
)

1119 
”r
 = 
”r2
;

1131 
ex™_”r
:

1132 ià(
”r
) {

1133 
	`ext4_w¬nšg
(
sb
, "can't update backup for group %u (err %d), "

1134 "fÜcšg fsck oÀÃxˆ»boÙ", 
group
, 
”r
);

1135 
sbi
->
s_mouÁ_¡©e
 &ğ~
EXT4_VALID_FS
;

1136 
sbi
->
s_es
->
s_¡©e
 &ğ
	`ıu_to_Ë16
(~
EXT4_VALID_FS
);

1137 
	`m¬k_bufãr_dœty
(
sbi
->
s_sbh
);

1139 
	}
}

1151 
	$ext4_add_Ãw_descs
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

1152 
ext4_group_t
 
group
, 
šode
 *
»size_šode
,

1153 
ext4_group_t
 
couÁ
)

1155 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1156 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1157 
bufãr_h—d
 *
gdb_bh
;

1158 
i
, 
gdb_off
, 
gdb_num
, 
”r
 = 0;

1159 
m‘a_bg
;

1161 
m‘a_bg
 = 
	`ext4_has_ã©u»_m‘a_bg
(
sb
);

1162 
i
 = 0; i < 
couÁ
; i++, 
group
++) {

1163 
»£rved_gdb
 = 
	`ext4_bg_has_su³r
(
sb
, 
group
) ?

1164 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
) : 0;

1166 
gdb_off
 = 
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1167 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1175 ià(
gdb_off
) {

1176 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1177 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

1178 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
gdb_bh
);

1180 ià(!
”r
 && 
»£rved_gdb
 && 
	`ext4_bg_num_gdb
(
sb
, 
group
))

1181 
”r
 = 
	`»£rve_backup_gdb
(
hªdË
, 
»size_šode
, 
group
);

1182 } ià(
m‘a_bg
 != 0) {

1183 
”r
 = 
	`add_Ãw_gdb_m‘a_bg
(
sb
, 
hªdË
, 
group
);

1185 
”r
 = 
	`add_Ãw_gdb
(
hªdË
, 
»size_šode
, 
group
);

1187 ià(
”r
)

1190  
”r
;

1191 
	}
}

1193 
bufãr_h—d
 *
	$ext4_g‘_b™m­
(
su³r_block
 *
sb
, 
__u64
 
block
)

1195 
bufãr_h—d
 *
bh
 = 
	`sb_g‘blk
(
sb
, 
block
);

1196 ià(
	`uÆik–y
(!
bh
))

1197  
NULL
;

1198 ià(!
	`bh_u±od©e_Ü_lock
(
bh
)) {

1199 ià(
	`bh_subm™_»ad
(
bh
) < 0) {

1200 
	`b»l£
(
bh
);

1201  
NULL
;

1205  
bh
;

1206 
	}
}

1208 
	$ext4_£t_b™m­_checksums
(
su³r_block
 *
sb
,

1209 
ext4_group_t
 
group
,

1210 
ext4_group_desc
 *
gdp
,

1211 
ext4_Ãw_group_d©a
 *
group_d©a
)

1213 
bufãr_h—d
 *
bh
;

1215 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

1218 
bh
 = 
	`ext4_g‘_b™m­
(
sb
, 
group_d©a
->
šode_b™m­
);

1219 ià(!
bh
)

1220  -
EIO
;

1221 
	`ext4_šode_b™m­_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
,

1222 
	`EXT4_INODES_PER_GROUP
(
sb
) / 8);

1223 
	`b»l£
(
bh
);

1225 
bh
 = 
	`ext4_g‘_b™m­
(
sb
, 
group_d©a
->
block_b™m­
);

1226 ià(!
bh
)

1227  -
EIO
;

1228 
	`ext4_block_b™m­_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
);

1229 
	`b»l£
(
bh
);

1232 
	}
}

1237 
	$ext4_£tup_Ãw_descs
(
hªdË_t
 *
hªdË
, 
su³r_block
 *
sb
,

1238 
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

1240 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

1241 
ext4_group_desc
 *
gdp
;

1242 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1243 
bufãr_h—d
 *
gdb_bh
;

1244 
ext4_group_t
 
group
;

1245 
__u16
 *
bg_æags
 = 
æex_gd
->bg_flags;

1246 
i
, 
gdb_off
, 
gdb_num
, 
”r
 = 0;

1249 
i
 = 0; i < 
æex_gd
->
couÁ
; i++, 
group_d©a
++, 
bg_æags
++) {

1250 
group
 = 
group_d©a
->group;

1252 
gdb_off
 = 
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1253 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1258 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1260 
gdp
 = (
ext4_group_desc
 *)(
gdb_bh
->
b_d©a
 +

1261 
gdb_off
 * 
	`EXT4_DESC_SIZE
(
sb
));

1263 
	`mem£t
(
gdp
, 0, 
	`EXT4_DESC_SIZE
(
sb
));

1264 
	`ext4_block_b™m­_£t
(
sb
, 
gdp
, 
group_d©a
->
block_b™m­
);

1265 
	`ext4_šode_b™m­_£t
(
sb
, 
gdp
, 
group_d©a
->
šode_b™m­
);

1266 
”r
 = 
	`ext4_£t_b™m­_checksums
(
sb
, 
group
, 
gdp
, 
group_d©a
);

1267 ià(
”r
) {

1268 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1272 
	`ext4_šode_bË_£t
(
sb
, 
gdp
, 
group_d©a
->
šode_bË
);

1273 
	`ext4_ä“_group_şu¡”s_£t
(
sb
, 
gdp
,

1274 
	`EXT4_NUM_B2C
(
sbi
, 
group_d©a
->
ä“_blocks_couÁ
));

1275 
	`ext4_ä“_šodes_£t
(
sb
, 
gdp
, 
	`EXT4_INODES_PER_GROUP
(sb));

1276 ià(
	`ext4_has_group_desc_csum
(
sb
))

1277 
	`ext4_™abË_unu£d_£t
(
sb
, 
gdp
,

1278 
	`EXT4_INODES_PER_GROUP
(
sb
));

1279 
gdp
->
bg_æags
 = 
	`ıu_to_Ë16
(*bg_flags);

1280 
	`ext4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1282 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
gdb_bh
);

1283 ià(
	`uÆik–y
(
”r
)) {

1284 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1292 
”r
 = 
	`ext4_mb_add_groupšfo
(
sb
, 
group
, 
gdp
);

1293 ià(
”r
)

1296  
”r
;

1297 
	}
}

1306 
	$ext4_upd©e_su³r
(
su³r_block
 *
sb
,

1307 
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

1309 
ext4_fsblk_t
 
blocks_couÁ
 = 0;

1310 
ext4_fsblk_t
 
ä“_blocks
 = 0;

1311 
ext4_fsblk_t
 
»£rved_blocks
 = 0;

1312 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

1313 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1314 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1315 
i
;

1317 
	`BUG_ON
(
æex_gd
->
couÁ
 =ğ0 || 
group_d©a
 =ğ
NULL
);

1328 
i
 = 0; i < 
æex_gd
->
couÁ
; i++) {

1329 
blocks_couÁ
 +ğ
group_d©a
[
i
].blocks_count;

1330 
ä“_blocks
 +ğ
group_d©a
[
i
].
ä“_blocks_couÁ
;

1333 
»£rved_blocks
 = 
	`ext4_r_blocks_couÁ
(
es
) * 100;

1334 
»£rved_blocks
 = 
	`div64_u64
Ôe£rved_blocks, 
	`ext4_blocks_couÁ
(
es
));

1335 
»£rved_blocks
 *ğ
blocks_couÁ
;

1336 
	`do_div
(
»£rved_blocks
, 100);

1338 
	`ext4_blocks_couÁ_£t
(
es
, 
	`ext4_blocks_couÁ
Ósè+ 
blocks_couÁ
);

1339 
	`ext4_ä“_blocks_couÁ_£t
(
es
, 
	`ext4_ä“_blocks_couÁ
Ósè+ 
ä“_blocks
);

1340 
	`Ë32_add_ıu
(&
es
->
s_šodes_couÁ
, 
	`EXT4_INODES_PER_GROUP
(
sb
) *

1341 
æex_gd
->
couÁ
);

1342 
	`Ë32_add_ıu
(&
es
->
s_ä“_šodes_couÁ
, 
	`EXT4_INODES_PER_GROUP
(
sb
) *

1343 
æex_gd
->
couÁ
);

1345 
	`ext4_debug
("ä“ block couÁ %Îu", 
	`ext4_ä“_blocks_couÁ
(
es
));

1364 
	`smp_wmb
();

1367 
sbi
->
s_groups_couÁ
 +ğ
æex_gd
->
couÁ
;

1368 
sbi
->
s_blockfe_groups
 = 
	`mš_t
(
ext4_group_t
, sbi->
s_groups_couÁ
,

1369 (
EXT4_MAX_BLOCK_FILE_PHYS
 / 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)));

1373 
	`ext4_r_blocks_couÁ_£t
(
es
, 
	`ext4_r_blocks_couÁ
(es) +

1374 
»£rved_blocks
);

1377 
	`³rıu_couÁ”_add
(&
sbi
->
s_ä“şu¡”s_couÁ”
,

1378 
	`EXT4_NUM_B2C
(
sbi
, 
ä“_blocks
));

1379 
	`³rıu_couÁ”_add
(&
sbi
->
s_ä“šodes_couÁ”
,

1380 
	`EXT4_INODES_PER_GROUP
(
sb
è* 
æex_gd
->
couÁ
);

1382 
	`ext4_debug
("free blocks count %llu",

1383 
	`³rıu_couÁ”_»ad
(&
sbi
->
s_ä“şu¡”s_couÁ”
));

1384 ià(
	`ext4_has_ã©u»_æex_bg
(
sb
è&& 
sbi
->
s_log_groups_³r_æex
) {

1385 
ext4_group_t
 
æex_group
;

1386 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
group_d©a
[0].
group
);

1387 
	`©omic64_add
(
	`EXT4_NUM_B2C
(
sbi
, 
ä“_blocks
),

1388 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

1389 
	`©omic_add
(
	`EXT4_INODES_PER_GROUP
(
sb
è* 
æex_gd
->
couÁ
,

1390 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_šodes
);

1396 
	`ext4_ÿlcuÏ‹_ov”h—d
(
sb
);

1398 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

1399 
	`´štk
(
KERN_DEBUG
 "EXT4-fs:‡dded group %u:"

1400 "%Îu blocks(%Îu f»%Îu„e£rved)\n", 
æex_gd
->
couÁ
,

1401 
blocks_couÁ
, 
ä“_blocks
, 
»£rved_blocks
);

1402 
	}
}

1408 
	$ext4_æex_group_add
(
su³r_block
 *
sb
,

1409 
šode
 *
»size_šode
,

1410 
ext4_Ãw_æex_group_d©a
 *
æex_gd
)

1412 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1413 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1414 
ext4_fsblk_t
 
o_blocks_couÁ
;

1415 
ext4_g½blk_t
 
Ï¡
;

1416 
ext4_group_t
 
group
;

1417 
hªdË_t
 *
hªdË
;

1418 
»£rved_gdb
;

1419 
”r
 = 0, 
”r2
 = 0, 
üed™
;

1421 
	`BUG_ON
(!
æex_gd
->
couÁ
 || !æex_gd->
groups
 || !æex_gd->
bg_æags
);

1423 
»£rved_gdb
 = 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
);

1424 
o_blocks_couÁ
 = 
	`ext4_blocks_couÁ
(
es
);

1425 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
o_blocks_couÁ
, &
group
, &
Ï¡
);

1426 
	`BUG_ON
(
Ï¡
);

1428 
”r
 = 
	`£tup_Ãw_æex_group_blocks
(
sb
, 
æex_gd
);

1429 ià(
”r
)

1430 
ex™
;

1438 
üed™
 = 3;

1440 
üed™
 +ğ1 + 
	`DIV_ROUND_UP
(
æex_gd
->
couÁ
, 
	`EXT4_DESC_PER_BLOCK
(
sb
));

1441 
üed™
 +ğ
»£rved_gdb
;

1442 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 
üed™
);

1443 ià(
	`IS_ERR
(
hªdË
)) {

1444 
”r
 = 
	`PTR_ERR
(
hªdË
);

1445 
ex™
;

1448 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1449 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

1450 ià(
”r
)

1451 
ex™_jouº®
;

1453 
group
 = 
æex_gd
->
groups
[0].group;

1454 
	`BUG_ON
(
group
 !ğ
	`EXT4_SB
(
sb
)->
s_groups_couÁ
);

1455 
”r
 = 
	`ext4_add_Ãw_descs
(
hªdË
, 
sb
, 
group
,

1456 
»size_šode
, 
æex_gd
->
couÁ
);

1457 ià(
”r
)

1458 
ex™_jouº®
;

1460 
”r
 = 
	`ext4_£tup_Ãw_descs
(
hªdË
, 
sb
, 
æex_gd
);

1461 ià(
”r
)

1462 
ex™_jouº®
;

1464 
	`ext4_upd©e_su³r
(
sb
, 
æex_gd
);

1466 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

1468 
ex™_jouº®
:

1469 
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1470 ià(!
”r
)

1471 
”r
 = 
”r2
;

1473 ià(!
”r
) {

1474 
gdb_num
 = 
group
 / 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1475 
gdb_num_’d
 = ((
group
 + 
æex_gd
->
couÁ
 - 1) /

1476 
	`EXT4_DESC_PER_BLOCK
(
sb
));

1477 
m‘a_bg
 = 
	`ext4_has_ã©u»_m‘a_bg
(
sb
);

1478 
£ùÜ_t
 
Şd_gdb
 = 0;

1480 
	`upd©e_backups
(
sb
, 
sbi
->
s_sbh
->
b_blockÄ
, (*)
es
,

1481 (
ext4_su³r_block
), 0);

1482 ; 
gdb_num
 <ğ
gdb_num_’d
; gdb_num++) {

1483 
bufãr_h—d
 *
gdb_bh
;

1485 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1486 ià(
Şd_gdb
 =ğ
gdb_bh
->
b_blockÄ
)

1488 
	`upd©e_backups
(
sb
, 
gdb_bh
->
b_blockÄ
, gdb_bh->
b_d©a
,

1489 
gdb_bh
->
b_size
, 
m‘a_bg
);

1490 
Şd_gdb
 = 
gdb_bh
->
b_blockÄ
;

1493 
ex™
:

1494  
”r
;

1495 
	}
}

1497 
	$ext4_£tup_Ãxt_æex_gd
(
su³r_block
 *
sb
,

1498 
ext4_Ãw_æex_group_d©a
 *
æex_gd
,

1499 
ext4_fsblk_t
 
n_blocks_couÁ
,

1500 
æexbg_size
)

1502 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

1503 
ext4_Ãw_group_d©a
 *
group_d©a
 = 
æex_gd
->
groups
;

1504 
ext4_fsblk_t
 
o_blocks_couÁ
;

1505 
ext4_group_t
 
n_group
;

1506 
ext4_group_t
 
group
;

1507 
ext4_group_t
 
Ï¡_group
;

1508 
ext4_g½blk_t
 
Ï¡
;

1509 
ext4_g½blk_t
 
blocks_³r_group
;

1510 
i
;

1512 
blocks_³r_group
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

1514 
o_blocks_couÁ
 = 
	`ext4_blocks_couÁ
(
es
);

1516 ià(
o_blocks_couÁ
 =ğ
n_blocks_couÁ
)

1519 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
o_blocks_couÁ
, &
group
, &
Ï¡
);

1520 
	`BUG_ON
(
Ï¡
);

1521 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
n_blocks_couÁ
 - 1, &
n_group
, &
Ï¡
);

1523 
Ï¡_group
 = 
group
 | (
æexbg_size
 - 1);

1524 ià(
Ï¡_group
 > 
n_group
)

1525 
Ï¡_group
 = 
n_group
;

1527 
æex_gd
->
couÁ
 = 
Ï¡_group
 - 
group
 + 1;

1529 
i
 = 0; i < 
æex_gd
->
couÁ
; i++) {

1530 
ov”h—d
;

1532 
group_d©a
[
i
].
group
 = group + i;

1533 
group_d©a
[
i
].
blocks_couÁ
 = 
blocks_³r_group
;

1534 
ov”h—d
 = 
	`ext4_group_ov”h—d_blocks
(
sb
, 
group
 + 
i
);

1535 
group_d©a
[
i
].
ä“_blocks_couÁ
 = 
blocks_³r_group
 - 
ov”h—d
;

1536 ià(
	`ext4_has_group_desc_csum
(
sb
)) {

1537 
æex_gd
->
bg_æags
[
i
] = 
EXT4_BG_BLOCK_UNINIT
 |

1538 
EXT4_BG_INODE_UNINIT
;

1539 ià(!
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
))

1540 
æex_gd
->
bg_æags
[
i
] |ğ
EXT4_BG_INODE_ZEROED
;

1542 
æex_gd
->
bg_æags
[
i
] = 
EXT4_BG_INODE_ZEROED
;

1545 ià(
Ï¡_group
 =ğ
n_group
 && 
	`ext4_has_group_desc_csum
(
sb
))

1547 
æex_gd
->
bg_æags
[
i
 - 1] &ğ~
EXT4_BG_BLOCK_UNINIT
;

1549 ià((
Ï¡_group
 =ğ
n_group
è&& (
Ï¡
 !ğ
blocks_³r_group
 - 1)) {

1550 
group_d©a
[
i
 - 1].
blocks_couÁ
 = 
Ï¡
 + 1;

1551 
group_d©a
[
i
 - 1].
ä“_blocks_couÁ
 -ğ
blocks_³r_group
-

1552 
Ï¡
 - 1;

1556 
	}
}

1571 
	$ext4_group_add
(
su³r_block
 *
sb
, 
ext4_Ãw_group_d©a
 *
šput
)

1573 
ext4_Ãw_æex_group_d©a
 
æex_gd
;

1574 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1575 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1576 
»£rved_gdb
 = 
	`ext4_bg_has_su³r
(
sb
, 
šput
->
group
) ?

1577 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
) : 0;

1578 
šode
 *šodğ
NULL
;

1579 
gdb_off
;

1580 
”r
;

1581 
__u16
 
bg_æags
 = 0;

1583 
gdb_off
 = 
šput
->
group
 % 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1585 ià(
gdb_off
 =ğ0 && !
	`ext4_has_ã©u»_¥¬£_su³r
(
sb
)) {

1586 
	`ext4_w¬nšg
(
sb
, "Can't„esize‚on-sparse filesystem further");

1587  -
EPERM
;

1590 ià(
	`ext4_blocks_couÁ
(
es
è+ 
šput
->
blocks_couÁ
 <

1591 
	`ext4_blocks_couÁ
(
es
)) {

1592 
	`ext4_w¬nšg
(
sb
, "blocks_count overflow");

1593  -
EINVAL
;

1596 ià(
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
è+ 
	`EXT4_INODES_PER_GROUP
(
sb
) <

1597 
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
)) {

1598 
	`ext4_w¬nšg
(
sb
, "inodes_count overflow");

1599  -
EINVAL
;

1602 ià(
»£rved_gdb
 || 
gdb_off
 == 0) {

1603 ià(
	`ext4_has_ã©u»_»size_šode
(
sb
) ||

1604 !
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
)) {

1605 
	`ext4_w¬nšg
(
sb
,

1607  -
EPERM
;

1609 
šode
 = 
	`ext4_ig‘
(
sb
, 
EXT4_RESIZE_INO
);

1610 ià(
	`IS_ERR
(
šode
)) {

1611 
	`ext4_w¬nšg
(
sb
, "Error opening„esize inode");

1612  
	`PTR_ERR
(
šode
);

1617 
”r
 = 
	`v”ify_group_šput
(
sb
, 
šput
);

1618 ià(
”r
)

1619 
out
;

1621 
”r
 = 
	`ext4_®loc_æex_bg_¬¿y
(
sb
, 
šput
->
group
 + 1);

1622 ià(
”r
)

1623 
out
;

1625 
”r
 = 
	`ext4_mb_®loc_groupšfo
(
sb
, 
šput
->
group
 + 1);

1626 ià(
”r
)

1627 
out
;

1629 
æex_gd
.
couÁ
 = 1;

1630 
æex_gd
.
groups
 = 
šput
;

1631 
æex_gd
.
bg_æags
 = &bg_flags;

1632 
”r
 = 
	`ext4_æex_group_add
(
sb
, 
šode
, &
æex_gd
);

1633 
out
:

1634 
	`ut
(
šode
);

1635  
”r
;

1636 
	}
}

1641 
	$ext4_group_ex‹nd_no_check
(
su³r_block
 *
sb
,

1642 
ext4_fsblk_t
 
o_blocks_couÁ
, 
ext4_g½blk_t
 
add
)

1644 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

1645 
hªdË_t
 *
hªdË
;

1646 
”r
 = 0, 
”r2
;

1651 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 3);

1652 ià(
	`IS_ERR
(
hªdË
)) {

1653 
”r
 = 
	`PTR_ERR
(
hªdË
);

1654 
	`ext4_w¬nšg
(
sb
, "”rÜ %d oÀjouº® s¹", 
”r
);

1655  
”r
;

1658 
	`BUFFER_TRACE
(
	`EXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

1659 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
	`EXT4_SB
(
sb
)->
s_sbh
);

1660 ià(
”r
) {

1661 
	`ext4_w¬nšg
(
sb
, "”rÜ %d oÀjouº® wr™acûss", 
”r
);

1662 
”rout
;

1665 
	`ext4_blocks_couÁ_£t
(
es
, 
o_blocks_couÁ
 + 
add
);

1666 
	`ext4_ä“_blocks_couÁ_£t
(
es
, 
	`ext4_ä“_blocks_couÁ
Ósè+ 
add
);

1667 
	`ext4_debug
("ä“šg block %Îuhrough %Îu\n", 
o_blocks_couÁ
,

1668 
o_blocks_couÁ
 + 
add
);

1670 
”r
 = 
	`ext4_group_add_blocks
(
hªdË
, 
sb
, 
o_blocks_couÁ
, 
add
);

1671 ià(
”r
)

1672 
”rout
;

1673 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

1674 
	`ext4_debug
("ä“d block %Îuhrough %Îu\n", 
o_blocks_couÁ
,

1675 
o_blocks_couÁ
 + 
add
);

1676 
”rout
:

1677 
”r2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1678 ià(
”r2
 && !
”r
)

1679 
”r
 = 
”r2
;

1681 ià(!
”r
) {

1682 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

1683 
	`´štk
(
KERN_DEBUG
 "EXT4-fs:ƒxtended groupo %llu "

1684 "blocks\n", 
	`ext4_blocks_couÁ
(
es
));

1685 
	`upd©e_backups
(
sb
, 
	`EXT4_SB
(sb)->
s_sbh
->
b_blockÄ
,

1686 (*)
es
, (
ext4_su³r_block
), 0);

1688  
”r
;

1689 
	}
}

1701 
	$ext4_group_ex‹nd
(
su³r_block
 *
sb
, 
ext4_su³r_block
 *
es
,

1702 
ext4_fsblk_t
 
n_blocks_couÁ
)

1704 
ext4_fsblk_t
 
o_blocks_couÁ
;

1705 
ext4_g½blk_t
 
Ï¡
;

1706 
ext4_g½blk_t
 
add
;

1707 
bufãr_h—d
 *
bh
;

1708 
”r
;

1709 
ext4_group_t
 
group
;

1711 
o_blocks_couÁ
 = 
	`ext4_blocks_couÁ
(
es
);

1713 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

1714 
	`ext4_msg
(
sb
, 
KERN_DEBUG
,

1716 
o_blocks_couÁ
, 
n_blocks_couÁ
);

1718 ià(
n_blocks_couÁ
 =ğ0 ||‚_blocks_couÁ =ğ
o_blocks_couÁ
)

1721 ià(
n_blocks_couÁ
 > (
£ùÜ_t
)(~0ULLè>> (
sb
->
s_blocksize_b™s
 - 9)) {

1722 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1724 
n_blocks_couÁ
);

1725 ià((
£ùÜ_t
) < 8)

1726 
	`ext4_w¬nšg
(
sb
, "CONFIG_LBDAF‚otƒnabled");

1727  -
EINVAL
;

1730 ià(
n_blocks_couÁ
 < 
o_blocks_couÁ
) {

1731 
	`ext4_w¬nšg
(
sb
, "can't shrink FS -„esize‡borted");

1732  -
EINVAL
;

1736 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
o_blocks_couÁ
, &
group
, &
Ï¡
);

1738 ià(
Ï¡
 == 0) {

1739 
	`ext4_w¬nšg
(
sb
, "needo useƒxt2onlineo„esize further");

1740  -
EPERM
;

1743 
add
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
è- 
Ï¡
;

1745 ià(
o_blocks_couÁ
 + 
add
 < o_blocks_count) {

1746 
	`ext4_w¬nšg
(
sb
, "blocks_count overflow");

1747  -
EINVAL
;

1750 ià(
o_blocks_couÁ
 + 
add
 > 
n_blocks_couÁ
)

1751 
add
 = 
n_blocks_couÁ
 - 
o_blocks_couÁ
;

1753 ià(
o_blocks_couÁ
 + 
add
 < 
n_blocks_couÁ
)

1754 
	`ext4_w¬nšg
(
sb
, "will only finish group (%llu blocks, %u‚ew)",

1755 
o_blocks_couÁ
 + 
add
,‡dd);

1758 
bh
 = 
	`sb_b»ad
(
sb
, 
o_blocks_couÁ
 + 
add
 - 1);

1759 ià(!
bh
) {

1760 
	`ext4_w¬nšg
(
sb
, "can't„ead†ast block,„esize‡borted");

1761  -
ENOSPC
;

1763 
	`b»l£
(
bh
);

1765 
”r
 = 
	`ext4_group_ex‹nd_no_check
(
sb
, 
o_blocks_couÁ
, 
add
);

1766  
”r
;

1767 
	}
}

1770 
	$num_desc_blocks
(
su³r_block
 *
sb
, 
ext4_group_t
 
groups
)

1772  (
groups
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1) / EXT4_DESC_PER_BLOCK(sb);

1773 
	}
}

1780 
	$ext4_cÚv”t_m‘a_bg
(
su³r_block
 *
sb
, 
šode
 *inode)

1782 
hªdË_t
 *
hªdË
;

1783 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1784 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1785 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

1786 
ext4_fsblk_t
 
Ä
;

1787 
i
, 
»t
, 
”r
 = 0;

1788 
üed™s
 = 1;

1790 
	`ext4_msg
(
sb
, 
KERN_INFO
, "Converting file systemo meta_bg");

1791 ià(
šode
) {

1792 ià(
es
->
s_»£rved_gdt_blocks
) {

1793 
	`ext4_”rÜ
(
sb
, "Unexpected‚on-zero "

1795  -
EPERM
;

1799 ià(
šode
->
i_blocks
 !ğ1 << (šode->
i_blkb™s
 - 9))

1800 
šv®id_»size_šode
;

1801 
i
 = 0; i < 
EXT4_N_BLOCKS
; i++) {

1802 ià(
i
 =ğ
EXT4_DIND_BLOCK
) {

1803 ià(
ei
->
i_d©a
[
i
])

1806 
šv®id_»size_šode
;

1808 ià(
ei
->
i_d©a
[
i
])

1809 
šv®id_»size_šode
;

1811 
üed™s
 += 3;

1814 
hªdË
 = 
	`ext4_jouº®_¡¬t_sb
(
sb
, 
EXT4_HT_RESIZE
, 
üed™s
);

1815 ià(
	`IS_ERR
(
hªdË
))

1816  
	`PTR_ERR
(
hªdË
);

1818 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1819 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
sbi
->
s_sbh
);

1820 ià(
”r
)

1821 
”rout
;

1823 
	`ext4_ş—r_ã©u»_»size_šode
(
sb
);

1824 
	`ext4_£t_ã©u»_m‘a_bg
(
sb
);

1825 
sbi
->
s_es
->
s_fœ¡_m‘a_bg
 =

1826 
	`ıu_to_Ë32
(
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_couÁ
));

1828 
”r
 = 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

1829 ià(
”r
) {

1830 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1831 
”rout
;

1834 ià(
šode
) {

1835 
Ä
 = 
	`Ë32_to_ıu
(
ei
->
i_d©a
[
EXT4_DIND_BLOCK
]);

1836 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
Ä
, 1,

1837 
EXT4_FREE_BLOCKS_METADATA
 |

1838 
EXT4_FREE_BLOCKS_FORGET
);

1839 
ei
->
i_d©a
[
EXT4_DIND_BLOCK
] = 0;

1840 
šode
->
i_blocks
 = 0;

1842 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1843 ià(
”r
)

1844 
	`ext4_¡d_”rÜ
(
sb
, 
”r
);

1847 
”rout
:

1848 
»t
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1849 ià(!
”r
)

1850 
”r
 = 
»t
;

1851  
»t
;

1853 
šv®id_»size_šode
:

1854 
	`ext4_”rÜ
(
sb
, "corrupted/inconsistent„esize inode");

1855  -
EINVAL
;

1856 
	}
}

1864 
	$ext4_»size_fs
(
su³r_block
 *
sb
, 
ext4_fsblk_t
 
n_blocks_couÁ
)

1866 
ext4_Ãw_æex_group_d©a
 *
æex_gd
 = 
NULL
;

1867 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1868 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

1869 
bufãr_h—d
 *
bh
;

1870 
šode
 *
»size_šode
 = 
NULL
;

1871 
ext4_g½blk_t
 
add
, 
off£t
;

1872 
n_desc_blocks
;

1873 
o_desc_blocks
;

1874 
ext4_group_t
 
o_group
;

1875 
ext4_group_t
 
n_group
;

1876 
ext4_fsblk_t
 
o_blocks_couÁ
;

1877 
ext4_fsblk_t
 
n_blocks_couÁ_»Œy
 = 0;

1878 
Ï¡_upd©e_time
 = 0;

1879 
”r
 = 0, 
æexbg_size
 = 1 << 
sbi
->
s_log_groups_³r_æex
;

1880 
m‘a_bg
;

1883 
bh
 = 
	`sb_b»ad
(
sb
, 
n_blocks_couÁ
 - 1);

1884 ià(!
bh
) {

1885 
	`ext4_w¬nšg
(
sb
, "can't„ead†ast block,„esize‡borted");

1886  -
ENOSPC
;

1888 
	`b»l£
(
bh
);

1890 
»Œy
:

1891 
o_blocks_couÁ
 = 
	`ext4_blocks_couÁ
(
es
);

1893 
	`ext4_msg
(
sb
, 
KERN_INFO
, "resizing filesystem from %llu "

1894 "tØ%Îu blocks", 
o_blocks_couÁ
, 
n_blocks_couÁ
);

1896 ià(
n_blocks_couÁ
 < 
o_blocks_couÁ
) {

1898 
	`ext4_w¬nšg
(
sb
, "can't shrink FS -„esize‡borted");

1899  -
EINVAL
;

1902 ià(
n_blocks_couÁ
 =ğ
o_blocks_couÁ
)

1906 
n_group
 = 
	`ext4_g‘_group_numb”
(
sb
, 
n_blocks_couÁ
 - 1);

1907 ià(
n_group
 > (0xFFFFFFFFUL / 
	`EXT4_INODES_PER_GROUP
(
sb
))) {

1908 
	`ext4_w¬nšg
(
sb
, "resize would cause inodes_count overflow");

1909  -
EINVAL
;

1911 
	`ext4_g‘_group_no_ªd_off£t
(
sb
, 
o_blocks_couÁ
 - 1, &
o_group
, &
off£t
);

1913 
n_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
n_group
 + 1);

1914 
o_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_couÁ
);

1916 
m‘a_bg
 = 
	`ext4_has_ã©u»_m‘a_bg
(
sb
);

1918 ià(
	`ext4_has_ã©u»_»size_šode
(
sb
)) {

1919 ià(
m‘a_bg
) {

1920 
	`ext4_”rÜ
(
sb
, "resize_inode‡nd meta_bgƒnabled "

1922  -
EINVAL
;

1924 ià(
n_desc_blocks
 > 
o_desc_blocks
 +

1925 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
)) {

1926 
n_blocks_couÁ_»Œy
 = 
n_blocks_couÁ
;

1927 
n_desc_blocks
 = 
o_desc_blocks
 +

1928 
	`Ë16_to_ıu
(
es
->
s_»£rved_gdt_blocks
);

1929 
n_group
 = 
n_desc_blocks
 * 
	`EXT4_DESC_PER_BLOCK
(
sb
);

1930 
n_blocks_couÁ
 = (
ext4_fsblk_t
)
n_group
 *

1931 
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

1932 
n_group
--;

1935 ià(!
»size_šode
)

1936 
»size_šode
 = 
	`ext4_ig‘
(
sb
, 
EXT4_RESIZE_INO
);

1937 ià(
	`IS_ERR
(
»size_šode
)) {

1938 
	`ext4_w¬nšg
(
sb
, "Error opening„esize inode");

1939  
	`PTR_ERR
(
»size_šode
);

1943 ià((!
»size_šode
 && !
m‘a_bg
è|| 
n_blocks_couÁ
 =ğ
o_blocks_couÁ
) {

1944 
”r
 = 
	`ext4_cÚv”t_m‘a_bg
(
sb
, 
»size_šode
);

1945 ià(
”r
)

1946 
out
;

1947 ià(
»size_šode
) {

1948 
	`ut
(
»size_šode
);

1949 
»size_šode
 = 
NULL
;

1951 ià(
n_blocks_couÁ_»Œy
) {

1952 
n_blocks_couÁ
 = 
n_blocks_couÁ_»Œy
;

1953 
n_blocks_couÁ_»Œy
 = 0;

1954 
»Œy
;

1959 ià(
n_group
 =ğ
o_group
)

1960 
add
 = 
n_blocks_couÁ
 - 
o_blocks_couÁ
;

1962 
add
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
è- (
off£t
 + 1);

1963 ià(
add
 > 0) {

1964 
”r
 = 
	`ext4_group_ex‹nd_no_check
(
sb
, 
o_blocks_couÁ
, 
add
);

1965 ià(
”r
)

1966 
out
;

1969 ià(
	`ext4_blocks_couÁ
(
es
è=ğ
n_blocks_couÁ
)

1970 
out
;

1972 
”r
 = 
	`ext4_®loc_æex_bg_¬¿y
(
sb
, 
n_group
 + 1);

1973 ià(
”r
)

1974  
”r
;

1976 
”r
 = 
	`ext4_mb_®loc_groupšfo
(
sb
, 
n_group
 + 1);

1977 ià(
”r
)

1978 
out
;

1980 
æex_gd
 = 
	`®loc_æex_gd
(
æexbg_size
);

1981 ià(
æex_gd
 =ğ
NULL
) {

1982 
”r
 = -
ENOMEM
;

1983 
out
;

1989 
	`ext4_£tup_Ãxt_æex_gd
(
sb
, 
æex_gd
, 
n_blocks_couÁ
,

1990 
æexbg_size
)) {

1991 ià(
jiff›s
 - 
Ï¡_upd©e_time
 > 
HZ
 * 10) {

1992 ià(
Ï¡_upd©e_time
)

1993 
	`ext4_msg
(
sb
, 
KERN_INFO
,

1995 
	`ext4_blocks_couÁ
(
es
));

1996 
Ï¡_upd©e_time
 = 
jiff›s
;

1998 ià(
	`ext4_®loc_group_bËs
(
sb
, 
æex_gd
, 
æexbg_size
) != 0)

2000 
”r
 = 
	`ext4_æex_group_add
(
sb
, 
»size_šode
, 
æex_gd
);

2001 ià(
	`uÆik–y
(
”r
))

2005 ià(!
”r
 && 
n_blocks_couÁ_»Œy
) {

2006 
n_blocks_couÁ
 = 
n_blocks_couÁ_»Œy
;

2007 
n_blocks_couÁ_»Œy
 = 0;

2008 
	`ä“_æex_gd
(
æex_gd
);

2009 
æex_gd
 = 
NULL
;

2010 
»Œy
;

2013 
out
:

2014 ià(
æex_gd
)

2015 
	`ä“_æex_gd
(
æex_gd
);

2016 ià(
»size_šode
 !ğ
NULL
)

2017 
	`ut
(
»size_šode
);

2018 
	`ext4_msg
(
sb
, 
KERN_INFO
, "»sized fesy¡emØ%Îu", 
n_blocks_couÁ
);

2019  
”r
;

2020 
	}
}

	@stats.c

	@super.c

19 
	~<lšux/moduË.h
>

20 
	~<lšux/¡ršg.h
>

21 
	~<lšux/fs.h
>

22 
	~<lšux/time.h
>

23 
	~<lšux/vm®loc.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/š™.h
>

26 
	~<lšux/blkdev.h
>

27 
	~<lšux/backšg-dev.h
>

28 
	~<lšux/·r£r.h
>

29 
	~<lšux/bufãr_h—d.h
>

30 
	~<lšux/expÜtfs.h
>

31 
	~<lšux/vfs.h
>

32 
	~<lšux/¿ndom.h
>

33 
	~<lšux/mouÁ.h
>

34 
	~<lšux/Çmei.h
>

35 
	~<lšux/quÙaİs.h
>

36 
	~<lšux/£q_fe.h
>

37 
	~<lšux/ùy³.h
>

38 
	~<lšux/log2.h
>

39 
	~<lšux/üc16.h
>

40 
	~<lšux/dax.h
>

41 
	~<lšux/ş—nÿche.h
>

42 
	~<lšux/uacûss.h
>

44 
	~<lšux/kth»ad.h
>

45 
	~<lšux/ä“z”.h
>

47 
	~"ext4.h
"

48 
	~"ext4_ex‹Ás.h
"

49 
	~"ext4_jbd2.h
"

50 
	~"x©Œ.h
"

51 
	~"aş.h
"

52 
	~"mb®loc.h
"

53 
	~"fsm­.h
"

55 
	#CREATE_TRACE_POINTS


	)

56 
	~<Œaû/ev’ts/ext4.h
>

58 
ext4_Ïzy_š™
 *
	gext4_li_šfo
;

59 
mu‹x
 
	gext4_li_mtx
;

60 
¿‹lim™_¡©e
 
	gext4_mouÁ_msg_¿‹lim™
;

62 
ext4_lßd_jouº®
(
su³r_block
 *, 
ext4_su³r_block
 *,

63 
jouº®_devnum
);

64 
ext4_show_İtiÚs
(
£q_fe
 *
£q
, 
d’Œy
 *
roÙ
);

65 
ext4_comm™_su³r
(
su³r_block
 *
sb
, 
sync
);

66 
ext4_m¬k_»cov”y_com¶‘e
(
su³r_block
 *
sb
,

67 
ext4_su³r_block
 *
es
);

68 
ext4_ş—r_jouº®_”r
(
su³r_block
 *
sb
,

69 
ext4_su³r_block
 *
es
);

70 
ext4_sync_fs
(
su³r_block
 *
sb
, 
wa™
);

71 
ext4_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
);

72 
ext4_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
);

73 
ext4_unä“ze
(
su³r_block
 *
sb
);

74 
ext4_ä“ze
(
su³r_block
 *
sb
);

75 
d’Œy
 *
ext4_mouÁ
(
fe_sy¡em_ty³
 *
fs_ty³
, 
æags
,

76 cÚ¡ *
dev_Çme
, *
d©a
);

77 
šlše
 
ext2_ã©u»_£t_ok
(
su³r_block
 *
sb
);

78 
šlše
 
ext3_ã©u»_£t_ok
(
su³r_block
 *
sb
);

79 
ext4_ã©u»_£t_ok
(
su³r_block
 *
sb
, 
»adÚly
);

80 
ext4_de¡roy_Ïzyš™_th»ad
();

81 
ext4_uÄegi¡”_li_»que¡
(
su³r_block
 *
sb
);

82 
ext4_ş—r_»que¡_li¡
();

83 
šode
 *
ext4_g‘_jouº®_šode
(
su³r_block
 *
sb
,

84 
jouº®_šum
);

116 #ià!
defšed
(
CONFIG_EXT2_FS
è&& !defšed(
CONFIG_EXT2_FS_MODULE
è&& defšed(
CONFIG_EXT4_USE_FOR_EXT2
)

117 
fe_sy¡em_ty³
 
	gext2_fs_ty³
 = {

118 .
owÃr
 = 
THIS_MODULE
,

119 .
	gÇme
 = "ext2",

120 .
	gmouÁ
 = 
ext4_mouÁ
,

121 .
	gkl_sb
 = 
kl_block_su³r
,

122 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

124 
MODULE_ALIAS_FS
("ext2");

125 
MODULE_ALIAS
("ext2");

126 
	#IS_EXT2_SB
(
sb
è((sb)->
s_bdev
->
bd_hŞd”
 =ğ&
ext2_fs_ty³
)

	)

128 
	#IS_EXT2_SB
(
sb
è(0)

	)

132 
fe_sy¡em_ty³
 
	gext3_fs_ty³
 = {

133 .
owÃr
 = 
THIS_MODULE
,

134 .
	gÇme
 = "ext3",

135 .
	gmouÁ
 = 
ext4_mouÁ
,

136 .
	gkl_sb
 = 
kl_block_su³r
,

137 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

139 
MODULE_ALIAS_FS
("ext3");

140 
MODULE_ALIAS
("ext3");

141 
	#IS_EXT3_SB
(
sb
è((sb)->
s_bdev
->
bd_hŞd”
 =ğ&
ext3_fs_ty³
)

	)

143 
	$ext4_v”ify_csum_ty³
(
su³r_block
 *
sb
,

144 
ext4_su³r_block
 *
es
)

146 ià(!
	`ext4_has_ã©u»_m‘ad©a_csum
(
sb
))

149  
es
->
s_checksum_ty³
 =ğ
EXT4_CRC32C_CHKSUM
;

150 
	}
}

152 
__Ë32
 
	$ext4_su³rblock_csum
(
su³r_block
 *
sb
,

153 
ext4_su³r_block
 *
es
)

155 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

156 
off£t
 = 
	`off£tof
(
ext4_su³r_block
, 
s_checksum
);

157 
__u32
 
csum
;

159 
csum
 = 
	`ext4_chksum
(
sbi
, ~0, (*)
es
, 
off£t
);

161  
	`ıu_to_Ë32
(
csum
);

162 
	}
}

164 
	$ext4_su³rblock_csum_v”ify
(
su³r_block
 *
sb
,

165 
ext4_su³r_block
 *
es
)

167 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

170  
es
->
s_checksum
 =ğ
	`ext4_su³rblock_csum
(
sb
,ƒs);

171 
	}
}

173 
	$ext4_su³rblock_csum_£t
(
su³r_block
 *
sb
)

175 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

177 ià(!
	`ext4_has_m‘ad©a_csum
(
sb
))

180 
es
->
s_checksum
 = 
	`ext4_su³rblock_csum
(
sb
,ƒs);

181 
	}
}

183 *
	$ext4_kvm®loc
(
size_t
 
size
, 
gå_t
 
æags
)

185 *
»t
;

187 
»t
 = 
	`km®loc
(
size
, 
æags
 | 
__GFP_NOWARN
);

188 ià(!
»t
)

189 
»t
 = 
	`__vm®loc
(
size
, 
æags
, 
PAGE_KERNEL
);

190  
»t
;

191 
	}
}

193 *
	$ext4_kvz®loc
(
size_t
 
size
, 
gå_t
 
æags
)

195 *
»t
;

197 
»t
 = 
	`kz®loc
(
size
, 
æags
 | 
__GFP_NOWARN
);

198 ià(!
»t
)

199 
»t
 = 
	`__vm®loc
(
size
, 
æags
 | 
__GFP_ZERO
, 
PAGE_KERNEL
);

200  
»t
;

201 
	}
}

203 
ext4_fsblk_t
 
	$ext4_block_b™m­
(
su³r_block
 *
sb
,

204 
ext4_group_desc
 *
bg
)

206  
	`Ë32_to_ıu
(
bg
->
bg_block_b™m­_lo
) |

207 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

208 (
ext4_fsblk_t
)
	`Ë32_to_ıu
(
bg
->
bg_block_b™m­_hi
) << 32 : 0);

209 
	}
}

211 
ext4_fsblk_t
 
	$ext4_šode_b™m­
(
su³r_block
 *
sb
,

212 
ext4_group_desc
 *
bg
)

214  
	`Ë32_to_ıu
(
bg
->
bg_šode_b™m­_lo
) |

215 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

216 (
ext4_fsblk_t
)
	`Ë32_to_ıu
(
bg
->
bg_šode_b™m­_hi
) << 32 : 0);

217 
	}
}

219 
ext4_fsblk_t
 
	$ext4_šode_bË
(
su³r_block
 *
sb
,

220 
ext4_group_desc
 *
bg
)

222  
	`Ë32_to_ıu
(
bg
->
bg_šode_bË_lo
) |

223 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

224 (
ext4_fsblk_t
)
	`Ë32_to_ıu
(
bg
->
bg_šode_bË_hi
) << 32 : 0);

225 
	}
}

227 
__u32
 
	$ext4_ä“_group_şu¡”s
(
su³r_block
 *
sb
,

228 
ext4_group_desc
 *
bg
)

230  
	`Ë16_to_ıu
(
bg
->
bg_ä“_blocks_couÁ_lo
) |

231 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

232 (
__u32
)
	`Ë16_to_ıu
(
bg
->
bg_ä“_blocks_couÁ_hi
) << 16 : 0);

233 
	}
}

235 
__u32
 
	$ext4_ä“_šodes_couÁ
(
su³r_block
 *
sb
,

236 
ext4_group_desc
 *
bg
)

238  
	`Ë16_to_ıu
(
bg
->
bg_ä“_šodes_couÁ_lo
) |

239 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

240 (
__u32
)
	`Ë16_to_ıu
(
bg
->
bg_ä“_šodes_couÁ_hi
) << 16 : 0);

241 
	}
}

243 
__u32
 
	$ext4_u£d_dœs_couÁ
(
su³r_block
 *
sb
,

244 
ext4_group_desc
 *
bg
)

246  
	`Ë16_to_ıu
(
bg
->
bg_u£d_dœs_couÁ_lo
) |

247 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

248 (
__u32
)
	`Ë16_to_ıu
(
bg
->
bg_u£d_dœs_couÁ_hi
) << 16 : 0);

249 
	}
}

251 
__u32
 
	$ext4_™abË_unu£d_couÁ
(
su³r_block
 *
sb
,

252 
ext4_group_desc
 *
bg
)

254  
	`Ë16_to_ıu
(
bg
->
bg_™abË_unu£d_lo
) |

255 (
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
 ?

256 (
__u32
)
	`Ë16_to_ıu
(
bg
->
bg_™abË_unu£d_hi
) << 16 : 0);

257 
	}
}

259 
	$ext4_block_b™m­_£t
(
su³r_block
 *
sb
,

260 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
)

262 
bg
->
bg_block_b™m­_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

263 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

264 
bg
->
bg_block_b™m­_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

265 
	}
}

267 
	$ext4_šode_b™m­_£t
(
su³r_block
 *
sb
,

268 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
)

270 
bg
->
bg_šode_b™m­_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

271 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

272 
bg
->
bg_šode_b™m­_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

273 
	}
}

275 
	$ext4_šode_bË_£t
(
su³r_block
 *
sb
,

276 
ext4_group_desc
 *
bg
, 
ext4_fsblk_t
 
blk
)

278 
bg
->
bg_šode_bË_lo
 = 
	`ıu_to_Ë32
((
u32
)
blk
);

279 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

280 
bg
->
bg_šode_bË_hi
 = 
	`ıu_to_Ë32
(
blk
 >> 32);

281 
	}
}

283 
	$ext4_ä“_group_şu¡”s_£t
(
su³r_block
 *
sb
,

284 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
)

286 
bg
->
bg_ä“_blocks_couÁ_lo
 = 
	`ıu_to_Ë16
((
__u16
)
couÁ
);

287 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

288 
bg
->
bg_ä“_blocks_couÁ_hi
 = 
	`ıu_to_Ë16
(
couÁ
 >> 16);

289 
	}
}

291 
	$ext4_ä“_šodes_£t
(
su³r_block
 *
sb
,

292 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
)

294 
bg
->
bg_ä“_šodes_couÁ_lo
 = 
	`ıu_to_Ë16
((
__u16
)
couÁ
);

295 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

296 
bg
->
bg_ä“_šodes_couÁ_hi
 = 
	`ıu_to_Ë16
(
couÁ
 >> 16);

297 
	}
}

299 
	$ext4_u£d_dœs_£t
(
su³r_block
 *
sb
,

300 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
)

302 
bg
->
bg_u£d_dœs_couÁ_lo
 = 
	`ıu_to_Ë16
((
__u16
)
couÁ
);

303 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

304 
bg
->
bg_u£d_dœs_couÁ_hi
 = 
	`ıu_to_Ë16
(
couÁ
 >> 16);

305 
	}
}

307 
	$ext4_™abË_unu£d_£t
(
su³r_block
 *
sb
,

308 
ext4_group_desc
 *
bg
, 
__u32
 
couÁ
)

310 
bg
->
bg_™abË_unu£d_lo
 = 
	`ıu_to_Ë16
((
__u16
)
couÁ
);

311 ià(
	`EXT4_DESC_SIZE
(
sb
è>ğ
EXT4_MIN_DESC_SIZE_64BIT
)

312 
bg
->
bg_™abË_unu£d_hi
 = 
	`ıu_to_Ë16
(
couÁ
 >> 16);

313 
	}
}

316 
	$__§ve_”rÜ_šfo
(
su³r_block
 *
sb
, cÚ¡ *
func
,

317 
lše
)

319 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

321 
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 |ğ
EXT4_ERROR_FS
;

322 ià(
	`bdev_»ad_Úly
(
sb
->
s_bdev
))

324 
es
->
s_¡©e
 |ğ
	`ıu_to_Ë16
(
EXT4_ERROR_FS
);

325 
es
->
s_Ï¡_”rÜ_time
 = 
	`ıu_to_Ë32
(
	`g‘_£cÚds
());

326 
	`¡ºıy
(
es
->
s_Ï¡_”rÜ_func
, 
func
, (es->s_last_error_func));

327 
es
->
s_Ï¡_”rÜ_lše
 = 
	`ıu_to_Ë32
(
lše
);

328 ià(!
es
->
s_fœ¡_”rÜ_time
) {

329 
es
->
s_fœ¡_”rÜ_time
 =ƒs->
s_Ï¡_”rÜ_time
;

330 
	`¡ºıy
(
es
->
s_fœ¡_”rÜ_func
, 
func
,

331 (
es
->
s_fœ¡_”rÜ_func
));

332 
es
->
s_fœ¡_”rÜ_lše
 = 
	`ıu_to_Ë32
(
lše
);

333 
es
->
s_fœ¡_”rÜ_šo
 =ƒs->
s_Ï¡_”rÜ_šo
;

334 
es
->
s_fœ¡_”rÜ_block
 =ƒs->
s_Ï¡_”rÜ_block
;

340 ià(!
es
->
s_”rÜ_couÁ
)

341 
	`mod_tim”
(&
	`EXT4_SB
(
sb
)->
s_”r_»pÜt
, 
jiff›s
 + 24*60*60*
HZ
);

342 
	`Ë32_add_ıu
(&
es
->
s_”rÜ_couÁ
, 1);

343 
	}
}

345 
	$§ve_”rÜ_šfo
(
su³r_block
 *
sb
, cÚ¡ *
func
,

346 
lše
)

348 
	`__§ve_”rÜ_šfo
(
sb
, 
func
, 
lše
);

349 
	`ext4_comm™_su³r
(
sb
, 1);

350 
	}
}

360 
	$block_deviû_ejeùed
(
su³r_block
 *
sb
)

362 
šode
 *
bd_šode
 = 
sb
->
s_bdev
->bd_inode;

363 
backšg_dev_šfo
 *
bdi
 = 
	`šode_to_bdi
(
bd_šode
);

365  
bdi
->
dev
 =ğ
NULL
;

366 
	}
}

368 
	$ext4_jouº®_comm™_ÿÎback
(
jouº®_t
 *
jouº®
, 
Œª§ùiÚ_t
 *
txn
)

370 
su³r_block
 *
sb
 = 
jouº®
->
j_´iv©e
;

371 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

372 
”rÜ
 = 
	`is_jouº®_abÜ‹d
(
jouº®
);

373 
ext4_jouº®_cb_’Œy
 *
jû
;

375 
	`BUG_ON
(
txn
->
t_¡©e
 =ğ
T_FINISHED
);

377 
	`ext4_´oûss_ä“d_d©a
(
sb
, 
txn
->
t_tid
);

379 
	`¥š_lock
(&
sbi
->
s_md_lock
);

380 !
	`li¡_em±y
(&
txn
->
t_´iv©e_li¡
)) {

381 
jû
 = 
	`li¡_’Œy
(
txn
->
t_´iv©e_li¡
.
Ãxt
,

382 
ext4_jouº®_cb_’Œy
, 
jû_li¡
);

383 
	`li¡_d–_š™
(&
jû
->
jû_li¡
);

384 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

385 
jû
->
	`jû_func
(
sb
, jû, 
”rÜ
);

386 
	`¥š_lock
(&
sbi
->
s_md_lock
);

388 
	`¥š_uÆock
(&
sbi
->
s_md_lock
);

389 
	}
}

406 
	$ext4_hªdË_”rÜ
(
su³r_block
 *
sb
)

408 ià(
sb
->
s_æags
 & 
MS_RDONLY
)

411 ià(!
	`‹¡_İt
(
sb
, 
ERRORS_CONT
)) {

412 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

414 
	`EXT4_SB
(
sb
)->
s_mouÁ_æags
 |ğ
EXT4_MF_FS_ABORTED
;

415 ià(
jouº®
)

416 
	`jbd2_jouº®_abÜt
(
jouº®
, -
EIO
);

418 ià(
	`‹¡_İt
(
sb
, 
ERRORS_RO
)) {

419 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystem„ead-only");

424 
	`smp_wmb
();

425 
sb
->
s_æags
 |ğ
MS_RDONLY
;

427 ià(
	`‹¡_İt
(
sb
, 
ERRORS_PANIC
)) {

428 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
 &&

429 !(
	`EXT4_SB
(
sb
)->
s_jouº®
->
j_æags
 & 
JBD2_REC_ERR
))

431 
	`·nic
("EXT4-fs (device %s):…anic forced‡fterƒrror\n",

432 
sb
->
s_id
);

434 
	}
}

436 
	#ext4_”rÜ_¿‹lim™
(
sb
) \

437 
	`___¿‹lim™
(&(
	`EXT4_SB
(
sb
)->
s_”r_¿‹lim™_¡©e
), \

438 "EXT4-f ”rÜ")

	)

440 
	$__ext4_”rÜ
(
su³r_block
 *
sb
, cÚ¡ *
funùiÚ
,

441 
lše
, cÚ¡ *
fmt
, ...)

443 
va_fÜm©
 
vaf
;

444 
va_li¡
 
¬gs
;

446 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

449 ià(
	`ext4_”rÜ_¿‹lim™
(
sb
)) {

450 
	`va_¡¬t
(
¬gs
, 
fmt
);

451 
vaf
.
fmt
 = fmt;

452 
vaf
.
va
 = &
¬gs
;

453 
	`´štk
(
KERN_CRIT


455 
sb
->
s_id
, 
funùiÚ
, 
lše
, 
cu¼’t
->
comm
, &
vaf
);

456 
	`va_’d
(
¬gs
);

458 
	`§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

459 
	`ext4_hªdË_”rÜ
(
sb
);

460 
	}
}

462 
	$__ext4_”rÜ_šode
(
šode
 *šode, cÚ¡ *
funùiÚ
,

463 
lše
, 
ext4_fsblk_t
 
block
,

464 cÚ¡ *
fmt
, ...)

466 
va_li¡
 
¬gs
;

467 
va_fÜm©
 
vaf
;

468 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

470 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

473 
es
->
s_Ï¡_”rÜ_šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

474 
es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
block
);

475 ià(
	`ext4_”rÜ_¿‹lim™
(
šode
->
i_sb
)) {

476 
	`va_¡¬t
(
¬gs
, 
fmt
);

477 
vaf
.
fmt
 = fmt;

478 
vaf
.
va
 = &
¬gs
;

479 ià(
block
)

480 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s): %s:%d: "

482 
šode
->
i_sb
->
s_id
, 
funùiÚ
, 
lše
, inode->
i_šo
,

483 
block
, 
cu¼’t
->
comm
, &
vaf
);

485 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s): %s:%d: "

487 
šode
->
i_sb
->
s_id
, 
funùiÚ
, 
lše
, inode->
i_šo
,

488 
cu¼’t
->
comm
, &
vaf
);

489 
	`va_’d
(
¬gs
);

491 
	`§ve_”rÜ_šfo
(
šode
->
i_sb
, 
funùiÚ
, 
lše
);

492 
	`ext4_hªdË_”rÜ
(
šode
->
i_sb
);

493 
	}
}

495 
	$__ext4_”rÜ_fe
(
fe
 *fe, cÚ¡ *
funùiÚ
,

496 
lše
, 
ext4_fsblk_t
 
block
,

497 cÚ¡ *
fmt
, ...)

499 
va_li¡
 
¬gs
;

500 
va_fÜm©
 
vaf
;

501 
ext4_su³r_block
 *
es
;

502 
šode
 *šodğ
	`fe_šode
(
fe
);

503 
·thÇme
[80], *
·th
;

505 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

508 
es
 = 
	`EXT4_SB
(
šode
->
i_sb
)->
s_es
;

509 
es
->
s_Ï¡_”rÜ_šo
 = 
	`ıu_to_Ë32
(
šode
->
i_šo
);

510 ià(
	`ext4_”rÜ_¿‹lim™
(
šode
->
i_sb
)) {

511 
·th
 = 
	`fe_·th
(
fe
, 
·thÇme
, (pathname));

512 ià(
	`IS_ERR
(
·th
))

513 
·th
 = "(unknown)";

514 
	`va_¡¬t
(
¬gs
, 
fmt
);

515 
vaf
.
fmt
 = fmt;

516 
vaf
.
va
 = &
¬gs
;

517 ià(
block
)

518 
	`´štk
(
KERN_CRIT


521 
šode
->
i_sb
->
s_id
, 
funùiÚ
, 
lše
, inode->
i_šo
,

522 
block
, 
cu¼’t
->
comm
, 
·th
, &
vaf
);

524 
	`´štk
(
KERN_CRIT


527 
šode
->
i_sb
->
s_id
, 
funùiÚ
, 
lše
, inode->
i_šo
,

528 
cu¼’t
->
comm
, 
·th
, &
vaf
);

529 
	`va_’d
(
¬gs
);

531 
	`§ve_”rÜ_šfo
(
šode
->
i_sb
, 
funùiÚ
, 
lše
);

532 
	`ext4_hªdË_”rÜ
(
šode
->
i_sb
);

533 
	}
}

535 cÚ¡ *
	$ext4_decode_”rÜ
(
su³r_block
 *
sb
, 
”ºo
,

536 
nbuf
[16])

538 *
”r¡r
 = 
NULL
;

540 
”ºo
) {

541 -
EFSCORRUPTED
:

542 
”r¡r
 = "Corrupt filesystem";

544 -
EFSBADCRC
:

545 
”r¡r
 = "Filesystem failed CRC";

547 -
EIO
:

548 
”r¡r
 = "IO failure";

550 -
ENOMEM
:

551 
”r¡r
 = "Out of memory";

553 -
EROFS
:

554 ià(!
sb
 || (
	`EXT4_SB
(sb)->
s_jouº®
 &&

555 
	`EXT4_SB
(
sb
)->
s_jouº®
->
j_æags
 & 
JBD2_ABORT
))

556 
”r¡r
 = "Journal has‡borted";

558 
”r¡r
 = "Readonly filesystem";

564 ià(
nbuf
) {

566 ià(
	`¢´štf
(
nbuf
, 16, "”rÜ %d", -
”ºo
) >= 0)

567 
”r¡r
 = 
nbuf
;

572  
”r¡r
;

573 
	}
}

578 
	$__ext4_¡d_”rÜ
(
su³r_block
 *
sb
, cÚ¡ *
funùiÚ
,

579 
lše
, 
”ºo
)

581 
nbuf
[16];

582 cÚ¡ *
”r¡r
;

584 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

590 ià(
”ºo
 =ğ-
EROFS
 && 
	`jouº®_cu¼’t_hªdË
(è=ğ
NULL
 &&

591 (
sb
->
s_æags
 & 
MS_RDONLY
))

594 ià(
	`ext4_”rÜ_¿‹lim™
(
sb
)) {

595 
”r¡r
 = 
	`ext4_decode_”rÜ
(
sb
, 
”ºo
, 
nbuf
);

596 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s) in %s:%d: %s\n",

597 
sb
->
s_id
, 
funùiÚ
, 
lše
, 
”r¡r
);

600 
	`§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

601 
	`ext4_hªdË_”rÜ
(
sb
);

602 
	}
}

614 
	$__ext4_abÜt
(
su³r_block
 *
sb
, cÚ¡ *
funùiÚ
,

615 
lše
, cÚ¡ *
fmt
, ...)

617 
va_fÜm©
 
vaf
;

618 
va_li¡
 
¬gs
;

620 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

623 
	`§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

624 
	`va_¡¬t
(
¬gs
, 
fmt
);

625 
vaf
.
fmt
 = fmt;

626 
vaf
.
va
 = &
¬gs
;

627 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s): %s:%d: %pV\n",

628 
sb
->
s_id
, 
funùiÚ
, 
lše
, &
vaf
);

629 
	`va_’d
(
¬gs
);

631 ià((
sb
->
s_æags
 & 
MS_RDONLY
) == 0) {

632 
	`ext4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystem„ead-only");

633 
	`EXT4_SB
(
sb
)->
s_mouÁ_æags
 |ğ
EXT4_MF_FS_ABORTED
;

638 
	`smp_wmb
();

639 
sb
->
s_æags
 |ğ
MS_RDONLY
;

640 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
)

641 
	`jbd2_jouº®_abÜt
(
	`EXT4_SB
(
sb
)->
s_jouº®
, -
EIO
);

642 
	`§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

644 ià(
	`‹¡_İt
(
sb
, 
ERRORS_PANIC
)) {

645 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
 &&

646 !(
	`EXT4_SB
(
sb
)->
s_jouº®
->
j_æags
 & 
JBD2_REC_ERR
))

648 
	`·nic
("EXT4-fs…anic from…reviousƒrror\n");

650 
	}
}

652 
	$__ext4_msg
(
su³r_block
 *
sb
,

653 cÚ¡ *
´efix
, cÚ¡ *
fmt
, ...)

655 
va_fÜm©
 
vaf
;

656 
va_li¡
 
¬gs
;

658 ià(!
	`___¿‹lim™
(&(
	`EXT4_SB
(
sb
)->
s_msg_¿‹lim™_¡©e
), "EXT4-fs"))

661 
	`va_¡¬t
(
¬gs
, 
fmt
);

662 
vaf
.
fmt
 = fmt;

663 
vaf
.
va
 = &
¬gs
;

664 
	`´štk
("%sEXT4-f (%s): %pV\n", 
´efix
, 
sb
->
s_id
, &
vaf
);

665 
	`va_’d
(
¬gs
);

666 
	}
}

668 
	#ext4_w¬nšg_¿‹lim™
(
sb
) \

669 
	`___¿‹lim™
(&(
	`EXT4_SB
(
sb
)->
s_w¬nšg_¿‹lim™_¡©e
), \

670 "EXT4-f w¬nšg")

	)

672 
	$__ext4_w¬nšg
(
su³r_block
 *
sb
, cÚ¡ *
funùiÚ
,

673 
lše
, cÚ¡ *
fmt
, ...)

675 
va_fÜm©
 
vaf
;

676 
va_li¡
 
¬gs
;

678 ià(!
	`ext4_w¬nšg_¿‹lim™
(
sb
))

681 
	`va_¡¬t
(
¬gs
, 
fmt
);

682 
vaf
.
fmt
 = fmt;

683 
vaf
.
va
 = &
¬gs
;

684 
	`´štk
(
KERN_WARNING
 "EXT4-fs warning (device %s): %s:%d: %pV\n",

685 
sb
->
s_id
, 
funùiÚ
, 
lše
, &
vaf
);

686 
	`va_’d
(
¬gs
);

687 
	}
}

689 
	$__ext4_w¬nšg_šode
(cÚ¡ 
šode
 *šode, cÚ¡ *
funùiÚ
,

690 
lše
, cÚ¡ *
fmt
, ...)

692 
va_fÜm©
 
vaf
;

693 
va_li¡
 
¬gs
;

695 ià(!
	`ext4_w¬nšg_¿‹lim™
(
šode
->
i_sb
))

698 
	`va_¡¬t
(
¬gs
, 
fmt
);

699 
vaf
.
fmt
 = fmt;

700 
vaf
.
va
 = &
¬gs
;

701 
	`´štk
(
KERN_WARNING
 "EXT4-fs warning (device %s): %s:%d: "

702 "šod#%lu: comm %s: %pV\n", 
šode
->
i_sb
->
s_id
,

703 
funùiÚ
, 
lše
, 
šode
->
i_šo
, 
cu¼’t
->
comm
, &
vaf
);

704 
	`va_’d
(
¬gs
);

705 
	}
}

707 
	$__ext4_g½_locked_”rÜ
(cÚ¡ *
funùiÚ
, 
lše
,

708 
su³r_block
 *
sb
, 
ext4_group_t
 
g½
,

709 
šo
, 
ext4_fsblk_t
 
block
,

710 cÚ¡ *
fmt
, ...)

711 
	$__»Ëa£s
(
b™lock
)

712 
	$__acquœes
(
b™lock
)

714 
va_fÜm©
 
vaf
;

715 
va_li¡
 
¬gs
;

716 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

718 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

721 
es
->
s_Ï¡_”rÜ_šo
 = 
	`ıu_to_Ë32
(
šo
);

722 
es
->
s_Ï¡_”rÜ_block
 = 
	`ıu_to_Ë64
(
block
);

723 
	`__§ve_”rÜ_šfo
(
sb
, 
funùiÚ
, 
lše
);

725 ià(
	`ext4_”rÜ_¿‹lim™
(
sb
)) {

726 
	`va_¡¬t
(
¬gs
, 
fmt
);

727 
vaf
.
fmt
 = fmt;

728 
vaf
.
va
 = &
¬gs
;

729 
	`´štk
(
KERN_CRIT
 "EXT4-fsƒrror (device %s): %s:%d: group %u, ",

730 
sb
->
s_id
, 
funùiÚ
, 
lše
, 
g½
);

731 ià(
šo
)

732 
	`´štk
(
KERN_CONT
 "šod%lu: ", 
šo
);

733 ià(
block
)

734 
	`´štk
(
KERN_CONT
 "block %llu:",

735 (è
block
);

736 
	`´štk
(
KERN_CONT
 "%pV\n", &
vaf
);

737 
	`va_’d
(
¬gs
);

740 ià(
	`‹¡_İt
(
sb
, 
ERRORS_CONT
)) {

741 
	`ext4_comm™_su³r
(
sb
, 0);

745 
	`ext4_uÆock_group
(
sb
, 
g½
);

746 
	`ext4_hªdË_”rÜ
(
sb
);

758 
	`ext4_lock_group
(
sb
, 
g½
);

760 
	}
}

762 
	$ext4_upd©e_dyÇmic_»v
(
su³r_block
 *
sb
)

764 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

766 ià(
	`Ë32_to_ıu
(
es
->
s_»v_Ëv–
è> 
EXT4_GOOD_OLD_REV
)

769 
	`ext4_w¬nšg
(
sb
,

772 
EXT4_DYNAMIC_REV
);

774 
es
->
s_fœ¡_šo
 = 
	`ıu_to_Ë32
(
EXT4_GOOD_OLD_FIRST_INO
);

775 
es
->
s_šode_size
 = 
	`ıu_to_Ë16
(
EXT4_GOOD_OLD_INODE_SIZE
);

776 
es
->
s_»v_Ëv–
 = 
	`ıu_to_Ë32
(
EXT4_DYNAMIC_REV
);

785 
	}
}

790 
block_deviû
 *
	$ext4_blkdev_g‘
(
dev_t
 
dev
, 
su³r_block
 *
sb
)

792 
block_deviû
 *
bdev
;

793 
b
[
BDEVNAME_SIZE
];

795 
bdev
 = 
	`blkdev_g‘_by_dev
(
dev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
, 
sb
);

796 ià(
	`IS_ERR
(
bdev
))

797 
ç
;

798  
bdev
;

800 
ç
:

801 
	`ext4_msg
(
sb
, 
KERN_ERR
, "failedo open journal device %s: %ld",

802 
	`__bdevÇme
(
dev
, 
b
), 
	`PTR_ERR
(
bdev
));

803  
NULL
;

804 
	}
}

809 
	$ext4_blkdev_put
(
block_deviû
 *
bdev
)

811 
	`blkdev_put
(
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

812 
	}
}

814 
	$ext4_blkdev_»move
(
ext4_sb_šfo
 *
sbi
)

816 
block_deviû
 *
bdev
;

817 
bdev
 = 
sbi
->
jouº®_bdev
;

818 ià(
bdev
) {

819 
	`ext4_blkdev_put
(
bdev
);

820 
sbi
->
jouº®_bdev
 = 
NULL
;

822 
	}
}

824 
šlše
 
šode
 *
	$Üphª_li¡_’Œy
(
li¡_h—d
 *
l
)

826  &
	`li¡_’Œy
(
l
, 
ext4_šode_šfo
, 
i_Üphª
)->
vfs_šode
;

827 
	}
}

829 
	$dump_Üphª_li¡
(
su³r_block
 *
sb
, 
ext4_sb_šfo
 *
sbi
)

831 
li¡_h—d
 *
l
;

833 
	`ext4_msg
(
sb
, 
KERN_ERR
, "sb orphan head is %d",

834 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_Ï¡_Üphª
));

836 
	`´štk
(
KERN_ERR
 "sb_info orphan†ist:\n");

837 
	`li¡_fÜ_—ch
(
l
, &
sbi
->
s_Üphª
) {

838 
šode
 *šodğ
	`Üphª_li¡_’Œy
(
l
);

839 
	`´štk
(
KERN_ERR
 " "

841 
šode
->
i_sb
->
s_id
, inode->
i_šo
, inode,

842 
šode
->
i_mode
, inode->
i_Æšk
,

843 
	`NEXT_ORPHAN
(
šode
));

845 
	}
}

847 #ifdeà
CONFIG_QUOTA


848 
ext4_quÙa_off
(
su³r_block
 *
sb
, 
ty³
);

850 
šlše
 
	$ext4_quÙa_off_umouÁ
(
su³r_block
 *
sb
)

852 
ty³
;

855 
ty³
 = 0;y³ < 
EXT4_MAXQUOTAS
;ype++)

856 
	`ext4_quÙa_off
(
sb
, 
ty³
);

857 
	}
}

859 
šlše
 
	$ext4_quÙa_off_umouÁ
(
su³r_block
 *
sb
)

861 
	}
}

864 
	$ext4_put_su³r
(
su³r_block
 *
sb
)

866 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

867 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

868 
abÜ‹d
 = 0;

869 
i
, 
”r
;

871 
	`ext4_uÄegi¡”_li_»que¡
(
sb
);

872 
	`ext4_quÙa_off_umouÁ
(
sb
);

874 
	`æush_wÜkqueue
(
sbi
->
rsv_cÚv”siÚ_wq
);

875 
	`de¡roy_wÜkqueue
(
sbi
->
rsv_cÚv”siÚ_wq
);

877 ià(
sbi
->
s_jouº®
) {

878 
abÜ‹d
 = 
	`is_jouº®_abÜ‹d
(
sbi
->
s_jouº®
);

879 
”r
 = 
	`jbd2_jouº®_de¡roy
(
sbi
->
s_jouº®
);

880 
sbi
->
s_jouº®
 = 
NULL
;

881 ià((
”r
 < 0è&& !
abÜ‹d
)

882 
	`ext4_abÜt
(
sb
, "Couldn't clean uphe journal");

885 
	`ext4_uÄegi¡”_sysfs
(
sb
);

886 
	`ext4_es_uÄegi¡”_shršk”
(
sbi
);

887 
	`d–_tim”_sync
(&
sbi
->
s_”r_»pÜt
);

888 
	`ext4_»Ëa£_sy¡em_zÚe
(
sb
);

889 
	`ext4_mb_»Ëa£
(
sb
);

890 
	`ext4_ext_»Ëa£
(
sb
);

892 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
è&& !
abÜ‹d
) {

893 
	`ext4_ş—r_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

894 
es
->
s_¡©e
 = 
	`ıu_to_Ë16
(
sbi
->
s_mouÁ_¡©e
);

896 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
))

897 
	`ext4_comm™_su³r
(
sb
, 1);

899 
i
 = 0; i < 
sbi
->
s_gdb_couÁ
; i++)

900 
	`b»l£
(
sbi
->
s_group_desc
[
i
]);

901 
	`kvä“
(
sbi
->
s_group_desc
);

902 
	`kvä“
(
sbi
->
s_æex_groups
);

903 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_ä“şu¡”s_couÁ”
);

904 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_ä“šodes_couÁ”
);

905 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_dœs_couÁ”
);

906 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_dœtyşu¡”s_couÁ”
);

907 
	`³rıu_ä“_rw£m
(&
sbi
->
s_jouº®_æag_rw£m
);

908 #ifdeà
CONFIG_QUOTA


909 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++)

910 
	`kä“
(
sbi
->
s_qf_Çmes
[
i
]);

917 ià(!
	`li¡_em±y
(&
sbi
->
s_Üphª
))

918 
	`dump_Üphª_li¡
(
sb
, 
sbi
);

919 
	`J_ASSERT
(
	`li¡_em±y
(&
sbi
->
s_Üphª
));

921 
	`sync_blockdev
(
sb
->
s_bdev
);

922 
	`šv®id©e_bdev
(
sb
->
s_bdev
);

923 ià(
sbi
->
jouº®_bdev
 && sbi->jouº®_bdev !ğ
sb
->
s_bdev
) {

929 
	`sync_blockdev
(
sbi
->
jouº®_bdev
);

930 
	`šv®id©e_bdev
(
sbi
->
jouº®_bdev
);

931 
	`ext4_blkdev_»move
(
sbi
);

933 ià(
sbi
->
s_—_šode_ÿche
) {

934 
	`ext4_x©Œ_de¡roy_ÿche
(
sbi
->
s_—_šode_ÿche
);

935 
sbi
->
s_—_šode_ÿche
 = 
NULL
;

937 ià(
sbi
->
s_—_block_ÿche
) {

938 
	`ext4_x©Œ_de¡roy_ÿche
(
sbi
->
s_—_block_ÿche
);

939 
sbi
->
s_—_block_ÿche
 = 
NULL
;

941 ià(
sbi
->
s_mmp_tsk
)

942 
	`kth»ad_¡İ
(
sbi
->
s_mmp_tsk
);

943 
	`b»l£
(
sbi
->
s_sbh
);

944 
sb
->
s_fs_šfo
 = 
NULL
;

949 
	`kobjeù_put
(&
sbi
->
s_kobj
);

950 
	`wa™_fÜ_com¶‘iÚ
(&
sbi
->
s_kobj_uÄegi¡”
);

951 ià(
sbi
->
s_chksum_driv”
)

952 
	`üy±o_ä“_shash
(
sbi
->
s_chksum_driv”
);

953 
	`kä“
(
sbi
->
s_blockgroup_lock
);

954 
	`kä“
(
sbi
);

955 
	}
}

957 
kmem_ÿche
 *
	gext4_šode_ÿch•
;

962 
šode
 *
	$ext4_®loc_šode
(
su³r_block
 *
sb
)

964 
ext4_šode_šfo
 *
ei
;

966 
ei
 = 
	`kmem_ÿche_®loc
(
ext4_šode_ÿch•
, 
GFP_NOFS
);

967 ià(!
ei
)

968  
NULL
;

970 
ei
->
vfs_šode
.
i_v”siÚ
 = 1;

971 
	`¥š_lock_š™
(&
ei
->
i_¿w_lock
);

972 
	`INIT_LIST_HEAD
(&
ei
->
i_´—Îoc_li¡
);

973 
	`¥š_lock_š™
(&
ei
->
i_´—Îoc_lock
);

974 
	`ext4_es_š™_Œ“
(&
ei
->
i_es_Œ“
);

975 
	`rwlock_š™
(&
ei
->
i_es_lock
);

976 
	`INIT_LIST_HEAD
(&
ei
->
i_es_li¡
);

977 
ei
->
i_es_®l_Ä
 = 0;

978 
ei
->
i_es_shk_Ä
 = 0;

979 
ei
->
i_es_shršk_lblk
 = 0;

980 
ei
->
i_»£rved_d©a_blocks
 = 0;

981 
ei
->
i_da_m‘ad©a_ÿlc_Ën
 = 0;

982 
ei
->
i_da_m‘ad©a_ÿlc_Ï¡_lblock
 = 0;

983 
	`¥š_lock_š™
(&(
ei
->
i_block_»£rv©iÚ_lock
));

984 #ifdeà
CONFIG_QUOTA


985 
ei
->
i_»£rved_quÙa
 = 0;

986 
	`mem£t
(&
ei
->
i_dquÙ
, 0, (ei->i_dquot));

988 
ei
->
jšode
 = 
NULL
;

989 
	`INIT_LIST_HEAD
(&
ei
->
i_rsv_cÚv”siÚ_li¡
);

990 
	`¥š_lock_š™
(&
ei
->
i_com¶‘ed_io_lock
);

991 
ei
->
i_sync_tid
 = 0;

992 
ei
->
i_d©async_tid
 = 0;

993 
	`©omic_£t
(&
ei
->
i_unwr™‹n
, 0);

994 
	`INIT_WORK
(&
ei
->
i_rsv_cÚv”siÚ_wÜk
, 
ext4_’d_io_rsv_wÜk
);

995 
	`ext4_š™_šode_fc_šfo
(&
ei
->
vfs_šode
);

996 
	`rwlock_š™
(&
ei
->
i_fc_lock
);

997  &
ei
->
vfs_šode
;

998 
	}
}

1000 
	$ext4_drİ_šode
(
šode
 *inode)

1002 
drİ
 = 
	`g’”ic_drİ_šode
(
šode
);

1003 ià(
drİ
) {

1004 
	`¥š_uÆock
(&
šode
->
i_lock
);

1005 ià(!
	`li¡_em±y
(&
	`EXT4_I
(
šode
)->
i_fc_li¡
))

1006 
drİ
 = 0;

1007 
	`¥š_lock
(&
šode
->
i_lock
);

1010 
	`Œaû_ext4_drİ_šode
(
šode
, 
drİ
);

1011  
drİ
;

1012 
	}
}

1014 
	$ext4_i_ÿÎback
(
rcu_h—d
 *
h—d
)

1016 
šode
 *šodğ
	`cÚš”_of
(
h—d
, šode, 
i_rcu
);

1017 
	`kmem_ÿche_ä“
(
ext4_šode_ÿch•
, 
	`EXT4_I
(
šode
));

1018 
	}
}

1020 
	$ext4_de¡roy_šode
(
šode
 *inode)

1022 ià(!
	`li¡_em±y
(&(
	`EXT4_I
(
šode
)->
i_Üphª
))) {

1023 
	`ext4_msg
(
šode
->
i_sb
, 
KERN_ERR
,

1025 
šode
->
i_šo
, 
	`EXT4_I
(inode));

1026 
	`´št_hex_dump
(
KERN_INFO
, "", 
DUMP_PREFIX_ADDRESS
, 16, 4,

1027 
	`EXT4_I
(
šode
), (
ext4_šode_šfo
),

1028 
Œue
);

1029 
	`dump_¡ack
();

1032 ià(!
	`li¡_em±y
(&
	`EXT4_I
(
šode
)->
i_fc_li¡
)) {

1033 
	`¥š_lock
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_fc_lock
);

1034 
	`li¡_d–_š™
(&
	`EXT4_I
(
šode
)->
i_fc_li¡
);

1035 
	`¥š_uÆock
(&
	`EXT4_SB
(
šode
->
i_sb
)->
s_fc_lock
);

1039 
	`ÿÎ_rcu
(&
šode
->
i_rcu
, 
ext4_i_ÿÎback
);

1040 
	}
}

1042 
	$š™_Úû
(*
foo
)

1044 
ext4_šode_šfo
 *
ei
 = (ext4_šode_šfØ*è
foo
;

1046 
	`INIT_LIST_HEAD
(&
ei
->
i_Üphª
);

1047 
	`š™_rw£m
(&
ei
->
x©Œ_£m
);

1048 
	`š™_rw£m
(&
ei
->
i_d©a_£m
);

1049 
	`š™_rw£m
(&
ei
->
i_mm­_£m
);

1050 
	`šode_š™_Úû
(&
ei
->
vfs_šode
);

1051 
	`ext4_š™_šode_fc_šfo
(&
ei
->
vfs_šode
);

1052 
	}
}

1054 
__š™
 
	$š™_šodeÿche
()

1056 
ext4_šode_ÿch•
 = 
	`kmem_ÿche_ü—‹
("ext4_inode_cache",

1057 (
ext4_šode_šfo
),

1058 0, (
SLAB_RECLAIM_ACCOUNT
|

1059 
SLAB_MEM_SPREAD
|
SLAB_ACCOUNT
),

1060 
š™_Úû
);

1061 ià(
ext4_šode_ÿch•
 =ğ
NULL
)

1062  -
ENOMEM
;

1064 
	}
}

1066 
	$de¡roy_šodeÿche
()

1072 
	`rcu_b¬r›r
();

1073 
	`kmem_ÿche_de¡roy
(
ext4_šode_ÿch•
);

1074 
	}
}

1076 
	$ext4_ş—r_šode
(
šode
 *inode)

1078 
	`ext4_fc_d–
(
šode
);

1079 
	`šv®id©e_šode_bufãrs
(
šode
);

1080 
	`ş—r_šode
(
šode
);

1081 
	`dquÙ_drİ
(
šode
);

1082 
	`ext4_disÿrd_´—ÎoÿtiÚs
(
šode
);

1083 
	`ext4_es_»move_ex‹Á
(
šode
, 0, 
EXT_MAX_BLOCKS
);

1084 ià(
	`EXT4_I
(
šode
)->
jšode
) {

1085 
	`jbd2_jouº®_»Ëa£_jbd_šode
(
	`EXT4_JOURNAL
(
šode
),

1086 
	`EXT4_I
(
šode
)->
jšode
);

1087 
	`jbd2_ä“_šode
(
	`EXT4_I
(
šode
)->
jšode
);

1088 
	`EXT4_I
(
šode
)->
jšode
 = 
NULL
;

1090 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


1091 
	`fsüy±_put_’üy±iÚ_šfo
(
šode
, 
NULL
);

1093 
	}
}

1095 
šode
 *
	$ext4_nfs_g‘_šode
(
su³r_block
 *
sb
,

1096 
u64
 
šo
, 
u32
 
g’”©iÚ
)

1098 
šode
 *inode;

1100 ià(
šo
 < 
	`EXT4_FIRST_INO
(
sb
è&& inØ!ğ
EXT4_ROOT_INO
)

1101  
	`ERR_PTR
(-
ESTALE
);

1102 ià(
šo
 > 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_šodes_couÁ
))

1103  
	`ERR_PTR
(-
ESTALE
);

1113 
šode
 = 
	`ext4_ig‘_nÜm®
(
sb
, 
šo
);

1114 ià(
	`IS_ERR
(
šode
))

1115  
	`ERR_CAST
(
šode
);

1116 ià(
g’”©iÚ
 && 
šode
->
i_g’”©iÚ
 != generation) {

1117 
	`ut
(
šode
);

1118  
	`ERR_PTR
(-
ESTALE
);

1121  
šode
;

1122 
	}
}

1124 
d’Œy
 *
	$ext4_fh_to_d’Œy
(
su³r_block
 *
sb
, 
fid
 *fid,

1125 
fh_Ën
, 
fh_ty³
)

1127  
	`g’”ic_fh_to_d’Œy
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

1128 
ext4_nfs_g‘_šode
);

1129 
	}
}

1131 
d’Œy
 *
	$ext4_fh_to_·»Á
(
su³r_block
 *
sb
, 
fid
 *fid,

1132 
fh_Ën
, 
fh_ty³
)

1134  
	`g’”ic_fh_to_·»Á
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

1135 
ext4_nfs_g‘_šode
);

1136 
	}
}

1144 
	$bdev_Œy_to_ä“_·ge
(
su³r_block
 *
sb
, 
·ge
 *page,

1145 
gå_t
 
wa™
)

1147 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

1149 
	`WARN_ON
(
	`PageChecked
(
·ge
));

1150 ià(!
	`·ge_has_bufãrs
(
·ge
))

1152 ià(
jouº®
)

1153  
	`jbd2_jouº®_Œy_to_ä“_bufãrs
(
jouº®
, 
·ge
,

1154 
wa™
 & ~
__GFP_DIRECT_RECLAIM
);

1155  
	`Œy_to_ä“_bufãrs
(
·ge
);

1156 
	}
}

1158 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


1159 
	$ext4_g‘_cÚ‹xt
(
šode
 *šode, *
ùx
, 
size_t
 
Ën
)

1161  
	`ext4_x©Œ_g‘
(
šode
, 
EXT4_XATTR_INDEX_ENCRYPTION
,

1162 
EXT4_XATTR_NAME_ENCRYPTION_CONTEXT
, 
ùx
, 
Ën
);

1163 
	}
}

1165 
	$ext4_£t_cÚ‹xt
(
šode
 *šode, cÚ¡ *
ùx
, 
size_t
 
Ën
,

1166 *
fs_d©a
)

1168 
hªdË_t
 *
hªdË
 = 
fs_d©a
;

1169 
»s
, 
»s2
, 
üed™s
, 
»Œ›s
 = 0;

1177 ià(
šode
->
i_šo
 =ğ
EXT4_ROOT_INO
)

1178  -
EPERM
;

1180 
»s
 = 
	`ext4_cÚv”t_šlše_d©a
(
šode
);

1181 ià(
»s
)

1182  
»s
;

1192 ià(
hªdË
) {

1193 
»s
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
,

1194 
EXT4_XATTR_INDEX_ENCRYPTION
,

1195 
EXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1196 
ùx
, 
Ën
, 0);

1197 ià(!
»s
) {

1198 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_ENCRYPT
);

1199 
	`ext4_ş—r_šode_¡©e
(
šode
,

1200 
EXT4_STATE_MAY_INLINE_DATA
);

1204 
	`ext4_£t_šode_æags
(
šode
);

1206  
»s
;

1209 
»s
 = 
	`dquÙ_š™Ÿlize
(
šode
);

1210 ià(
»s
)

1211  
»s
;

1212 
»Œy
:

1213 
»s
 = 
	`ext4_x©Œ_£t_üed™s
(
šode
, 
Ën
, 
çl£
 ,

1214 &
üed™s
);

1215 ià(
»s
)

1216  
»s
;

1218 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_MISC
, 
üed™s
);

1219 ià(
	`IS_ERR
(
hªdË
))

1220  
	`PTR_ERR
(
hªdË
);

1222 
»s
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
, 
EXT4_XATTR_INDEX_ENCRYPTION
,

1223 
EXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1224 
ùx
, 
Ën
, 0);

1225 ià(!
»s
) {

1226 
	`ext4_£t_šode_æag
(
šode
, 
EXT4_INODE_ENCRYPT
);

1228 
	`ext4_£t_šode_æags
(
šode
);

1229 
	`ext4_fc_Œack_šode
(
šode
);

1230 
»s
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

1231 ià(
»s
)

1232 
	`EXT4_ERROR_INODE
(
šode
, "Failedo mark inode dirty");

1234 
»s2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

1236 ià(
»s
 =ğ-
ENOSPC
 && 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
))

1237 
»Œy
;

1238 ià(!
»s
)

1239 
»s
 = 
»s2
;

1240  
»s
;

1241 
	}
}

1243 
boŞ
 
	$ext4_dummy_cÚ‹xt
(
šode
 *inode)

1245  
	`DUMMY_ENCRYPTION_ENABLED
(
	`EXT4_SB
(
šode
->
i_sb
));

1246 
	}
}

1248 
	$ext4_max_Çm–’
(
šode
 *inode)

1250  
	`S_ISLNK
(
šode
->
i_mode
è? inode->
i_sb
->
s_blocksize
 :

1251 
EXT4_NAME_LEN
;

1252 
	}
}

1254 cÚ¡ 
fsüy±_İ”©iÚs
 
	gext4_üy±İs
 = {

1255 .
key_´efix
 = "ext4:",

1256 .
	gg‘_cÚ‹xt
 = 
ext4_g‘_cÚ‹xt
,

1257 .
	g£t_cÚ‹xt
 = 
ext4_£t_cÚ‹xt
,

1258 .
	gdummy_cÚ‹xt
 = 
ext4_dummy_cÚ‹xt
,

1259 .
	gis_’üy±ed
 = 
ext4_’üy±ed_šode
,

1260 .
	gem±y_dœ
 = 
ext4_em±y_dœ
,

1261 .
	gmax_Çm–’
 = 
ext4_max_Çm–’
,

1264 cÚ¡ 
fsüy±_İ”©iÚs
 
	gext4_üy±İs
 = {

1265 .
is_’üy±ed
 = 
ext4_’üy±ed_šode
,

1269 #ifdeà
CONFIG_QUOTA


1270 cÚ¡ * cÚ¡ 
	gquÙ©y³s
[] = 
INITQFNAMES
;

1271 
	#QTYPE2NAME
(
t
è(
quÙ©y³s
[t])

	)

1273 
ext4_wr™e_dquÙ
(
dquÙ
 *dquot);

1274 
ext4_acquœe_dquÙ
(
dquÙ
 *dquot);

1275 
ext4_»Ëa£_dquÙ
(
dquÙ
 *dquot);

1276 
ext4_m¬k_dquÙ_dœty
(
dquÙ
 *dquot);

1277 
ext4_wr™e_šfo
(
su³r_block
 *
sb
, 
ty³
);

1278 
ext4_quÙa_Ú
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

1279 cÚ¡ 
·th
 *path);

1280 
ext4_quÙa_Ú_mouÁ
(
su³r_block
 *
sb
, 
ty³
);

1281 
ssize_t
 
ext4_quÙa_»ad
(
su³r_block
 *
sb
, 
ty³
, *
d©a
,

1282 
size_t
 
Ën
, 
loff_t
 
off
);

1283 
ssize_t
 
ext4_quÙa_wr™e
(
su³r_block
 *
sb
, 
ty³
,

1284 cÚ¡ *
d©a
, 
size_t
 
Ën
, 
loff_t
 
off
);

1285 
ext4_quÙa_’abË
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

1286 
æags
);

1287 
ext4_’abË_quÙas
(
su³r_block
 *
sb
);

1288 
ext4_g‘_Ãxt_id
(
su³r_block
 *
sb
, 
kqid
 *
qid
);

1290 
dquÙ
 **
	$ext4_g‘_dquÙs
(
šode
 *inode)

1292  
	`EXT4_I
(
šode
)->
i_dquÙ
;

1293 
	}
}

1295 cÚ¡ 
dquÙ_İ”©iÚs
 
	gext4_quÙa_İ”©iÚs
 = {

1296 .
g‘_»£rved_¥aû
 = 
ext4_g‘_»£rved_¥aû
,

1297 .
	gwr™e_dquÙ
 = 
ext4_wr™e_dquÙ
,

1298 .
	gacquœe_dquÙ
 = 
ext4_acquœe_dquÙ
,

1299 .
	g»Ëa£_dquÙ
 = 
ext4_»Ëa£_dquÙ
,

1300 .
	gm¬k_dœty
 = 
ext4_m¬k_dquÙ_dœty
,

1301 .
	gwr™e_šfo
 = 
ext4_wr™e_šfo
,

1302 .
	g®loc_dquÙ
 = 
dquÙ_®loc
,

1303 .
	gde¡roy_dquÙ
 = 
dquÙ_de¡roy
,

1304 .
	gg‘_´ojid
 = 
ext4_g‘_´ojid
,

1305 .
	gg‘_šode_u§ge
 = 
ext4_g‘_šode_u§ge
,

1306 .
	gg‘_Ãxt_id
 = 
ext4_g‘_Ãxt_id
,

1309 cÚ¡ 
quÙaùl_İs
 
	gext4_qùl_İ”©iÚs
 = {

1310 .
quÙa_Ú
 = 
ext4_quÙa_Ú
,

1311 .
	gquÙa_off
 = 
ext4_quÙa_off
,

1312 .
	gquÙa_sync
 = 
dquÙ_quÙa_sync
,

1313 .
	gg‘_¡©e
 = 
dquÙ_g‘_¡©e
,

1314 .
	g£t_šfo
 = 
dquÙ_£t_dqšfo
,

1315 .
	gg‘_dqblk
 = 
dquÙ_g‘_dqblk
,

1316 .
	g£t_dqblk
 = 
dquÙ_£t_dqblk
,

1317 .
	gg‘_Ãxtdqblk
 = 
dquÙ_g‘_Ãxt_dqblk
,

1321 cÚ¡ 
su³r_İ”©iÚs
 
	gext4_sİs
 = {

1322 .
®loc_šode
 = 
ext4_®loc_šode
,

1323 .
	gde¡roy_šode
 = 
ext4_de¡roy_šode
,

1324 .
	gwr™e_šode
 = 
ext4_wr™e_šode
,

1325 .
	gdœty_šode
 = 
ext4_dœty_šode
,

1326 .
	gdrİ_šode
 = 
ext4_drİ_šode
,

1327 .
	geviù_šode
 = 
ext4_eviù_šode
,

1328 .
	gput_su³r
 = 
ext4_put_su³r
,

1329 .
	gsync_fs
 = 
ext4_sync_fs
,

1330 .
	gä“ze_fs
 = 
ext4_ä“ze
,

1331 .
	gunä“ze_fs
 = 
ext4_unä“ze
,

1332 .
	g¡©fs
 = 
ext4_¡©fs
,

1333 .
	g»mouÁ_fs
 = 
ext4_»mouÁ
,

1334 .
	gshow_İtiÚs
 = 
ext4_show_İtiÚs
,

1335 #ifdeà
CONFIG_QUOTA


1336 .
	gquÙa_»ad
 = 
ext4_quÙa_»ad
,

1337 .
	gquÙa_wr™e
 = 
ext4_quÙa_wr™e
,

1338 .
	gg‘_dquÙs
 = 
ext4_g‘_dquÙs
,

1340 .
	gbdev_Œy_to_ä“_·ge
 = 
bdev_Œy_to_ä“_·ge
,

1343 cÚ¡ 
expÜt_İ”©iÚs
 
	gext4_expÜt_İs
 = {

1344 .
fh_to_d’Œy
 = 
ext4_fh_to_d’Œy
,

1345 .
	gfh_to_·»Á
 = 
ext4_fh_to_·»Á
,

1346 .
	gg‘_·»Á
 = 
ext4_g‘_·»Á
,

1350 
	mO±_bsd_df
, 
	mO±_mšix_df
, 
	mO±_g½id
, 
	mO±_nog½id
,

1351 
	mO±_»sgid
, 
	mO±_»suid
, 
	mO±_sb
, 
	mO±_”r_cÚt
, 
	mO±_”r_·nic
, 
	mO±_”r_ro
,

1352 
	mO±_nouid32
, 
	mO±_debug
, 
	mO±_»moved
,

1353 
	mO±_u£r_x©Œ
, 
	mO±_nou£r_x©Œ
, 
	mO±_aş
, 
	mO±_nßş
,

1354 
	mO±_auto_da_®loc
, 
	mO±_nßuto_da_®loc
, 
	mO±_nŞßd
,

1355 
	mO±_comm™
, 
	mO±_mš_b©ch_time
, 
	mO±_max_b©ch_time
, 
	mO±_jouº®_dev
,

1356 
	mO±_jouº®_·th
, 
	mO±_jouº®_checksum
, 
	mO±_jouº®_async_comm™
,

1357 
	mO±_abÜt
, 
	mO±_d©a_jouº®
, 
	mO±_d©a_Üd”ed
, 
	mO±_d©a_wr™eback
,

1358 
	mO±_d©a_”r_abÜt
, 
	mO±_d©a_”r_ignÜe
, 
	mO±_‹¡_dummy_’üy±iÚ
,

1359 
	mO±_u¤jquÙa
, 
	mO±_g½jquÙa
, 
	mO±_offu¤jquÙa
, 
	mO±_offg½jquÙa
,

1360 
	mO±_jqfmt_vfsŞd
, 
	mO±_jqfmt_vfsv0
, 
	mO±_jqfmt_vfsv1
, 
	mO±_quÙa
,

1361 
	mO±_noquÙa
, 
	mO±_b¬r›r
, 
	mO±_nob¬r›r
, 
	mO±_”r
,

1362 
	mO±_u¤quÙa
, 
	mO±_g½quÙa
, 
	mO±_´jquÙa
, 
	mO±_i_v”siÚ
, 
	mO±_dax
,

1363 
	mO±_¡re
, 
	mO±_d–®loc
, 
	mO±_nod–®loc
, 
	mO±_mblk_io_subm™
,

1364 
	mO±_Ïzytime
, 
	mO±_nŞazytime
, 
	mO±_debug_wªt_exŒa_isize
,

1365 
	mO±_nomblk_io_subm™
, 
	mO±_block_v®id™y
, 
	mO±_noblock_v®id™y
,

1366 
	mO±_šode_»adah—d_blks
, 
	mO±_jouº®_iİrio
,

1367 
	mO±_diÜ—d_nŞock
, 
	mO±_diÜ—d_lock
,

1368 
	mO±_disÿrd
, 
	mO±_nodisÿrd
, 
	mO±_š™_™abË
, 
	mO±_noš™_™abË
,

1369 
	mO±_max_dœ_size_kb
, 
	mO±_nojouº®_checksum
, 
	mO±_nombÿche
,

1370 
	mO±_no_fc
, 
	mO±_fc_soá_cÚsi¡’cy


1373 cÚ¡ 
m©ch_bË_t
 
	gtok’s
 = {

1374 {
O±_bsd_df
, "bsddf"},

1375 {
O±_mšix_df
, "minixdf"},

1376 {
O±_g½id
, "grpid"},

1377 {
O±_g½id
, "bsdgroups"},

1378 {
O±_nog½id
, "nogrpid"},

1379 {
O±_nog½id
, "sysvgroups"},

1380 {
O±_»sgid
, "resgid=%u"},

1381 {
O±_»suid
, "resuid=%u"},

1382 {
O±_sb
, "sb=%u"},

1383 {
O±_”r_cÚt
, "errors=continue"},

1384 {
O±_”r_·nic
, "errors=panic"},

1385 {
O±_”r_ro
, "errors=remount-ro"},

1386 {
O±_nouid32
, "nouid32"},

1387 {
O±_debug
, "debug"},

1388 {
O±_»moved
, "oldalloc"},

1389 {
O±_»moved
, "orlov"},

1390 {
O±_u£r_x©Œ
, "user_xattr"},

1391 {
O±_nou£r_x©Œ
, "nouser_xattr"},

1392 {
O±_aş
, "acl"},

1393 {
O±_nßş
, "noacl"},

1394 {
O±_nŞßd
, "norecovery"},

1395 {
O±_nŞßd
, "noload"},

1396 {
O±_»moved
, "nobh"},

1397 {
O±_»moved
, "bh"},

1398 {
O±_comm™
, "commit=%u"},

1399 {
O±_mš_b©ch_time
, "min_batch_time=%u"},

1400 {
O±_max_b©ch_time
, "max_batch_time=%u"},

1401 {
O±_jouº®_dev
, "journal_dev=%u"},

1402 {
O±_jouº®_·th
, "journal_path=%s"},

1403 {
O±_jouº®_checksum
, "journal_checksum"},

1404 {
O±_nojouº®_checksum
, "nojournal_checksum"},

1405 {
O±_jouº®_async_comm™
, "journal_async_commit"},

1406 {
O±_abÜt
, "abort"},

1407 {
O±_d©a_jouº®
, "data=journal"},

1408 {
O±_d©a_Üd”ed
, "data=ordered"},

1409 {
O±_d©a_wr™eback
, "data=writeback"},

1410 {
O±_d©a_”r_abÜt
, "data_err=abort"},

1411 {
O±_d©a_”r_ignÜe
, "data_err=ignore"},

1412 {
O±_offu¤jquÙa
, "usrjquota="},

1413 {
O±_u¤jquÙa
, "usrjquota=%s"},

1414 {
O±_offg½jquÙa
, "grpjquota="},

1415 {
O±_g½jquÙa
, "grpjquota=%s"},

1416 {
O±_jqfmt_vfsŞd
, "jqfmt=vfsold"},

1417 {
O±_jqfmt_vfsv0
, "jqfmt=vfsv0"},

1418 {
O±_jqfmt_vfsv1
, "jqfmt=vfsv1"},

1419 {
O±_g½quÙa
, "grpquota"},

1420 {
O±_noquÙa
, "noquota"},

1421 {
O±_quÙa
, "quota"},

1422 {
O±_u¤quÙa
, "usrquota"},

1423 {
O±_´jquÙa
, "prjquota"},

1424 {
O±_b¬r›r
, "barrier=%u"},

1425 {
O±_b¬r›r
, "barrier"},

1426 {
O±_nob¬r›r
, "nobarrier"},

1427 {
O±_i_v”siÚ
, "i_version"},

1428 {
O±_dax
, "dax"},

1429 {
O±_¡re
, "stripe=%u"},

1430 {
O±_d–®loc
, "delalloc"},

1431 {
O±_Ïzytime
, "lazytime"},

1432 {
O±_nŞazytime
, "nolazytime"},

1433 {
O±_debug_wªt_exŒa_isize
, "debug_want_extra_isize=%u"},

1434 {
O±_nod–®loc
, "nodelalloc"},

1435 {
O±_»moved
, "mblk_io_submit"},

1436 {
O±_»moved
, "nomblk_io_submit"},

1437 {
O±_block_v®id™y
, "block_validity"},

1438 {
O±_noblock_v®id™y
, "noblock_validity"},

1439 {
O±_šode_»adah—d_blks
, "inode_readahead_blks=%u"},

1440 {
O±_jouº®_iİrio
, "journal_ioprio=%u"},

1441 {
O±_auto_da_®loc
, "auto_da_alloc=%u"},

1442 {
O±_auto_da_®loc
, "auto_da_alloc"},

1443 {
O±_nßuto_da_®loc
, "noauto_da_alloc"},

1444 {
O±_diÜ—d_nŞock
, "dioread_nolock"},

1445 {
O±_diÜ—d_lock
, "dioread_lock"},

1446 {
O±_disÿrd
, "discard"},

1447 {
O±_nodisÿrd
, "nodiscard"},

1448 {
O±_š™_™abË
, "init_itable=%u"},

1449 {
O±_š™_™abË
, "init_itable"},

1450 {
O±_noš™_™abË
, "noinit_itable"},

1451 {
O±_no_fc
, "no_fc"},

1452 {
O±_fc_soá_cÚsi¡’cy
, "fc_soft_consistency"},

1453 {
O±_max_dœ_size_kb
, "max_dir_size_kb=%u"},

1454 {
O±_‹¡_dummy_’üy±iÚ
, "test_dummy_encryption"},

1455 {
O±_nombÿche
, "nombcache"},

1456 {
O±_nombÿche
, "no_mbcache"},

1457 {
O±_»moved
, "check=none"},

1458 {
O±_»moved
, "nocheck"},

1459 {
O±_»moved
, "reservation"},

1460 {
O±_»moved
, "noreservation"},

1461 {
O±_»moved
, "journal=%u"},

1462 {
O±_”r
, 
NULL
},

1465 
ext4_fsblk_t
 
	$g‘_sb_block
(**
d©a
)

1467 
ext4_fsblk_t
 
sb_block
;

1468 *
İtiÚs
 = (*è*
d©a
;

1470 ià(!
İtiÚs
 || 
	`¡ºcmp
(options, "sb=", 3) != 0)

1473 
İtiÚs
 += 3;

1475 
sb_block
 = 
	`sim¶e_¡¹oul
(
İtiÚs
, &options, 0);

1476 ià(*
İtiÚs
 && *options != ',') {

1477 
	`´štk
(
KERN_ERR
 "EXT4-fs: Invalid sb specification: %s\n",

1478 (*è*
d©a
);

1481 ià(*
İtiÚs
 == ',')

1482 
İtiÚs
++;

1483 *
d©a
 = (*è
İtiÚs
;

1485  
sb_block
;

1486 
	}
}

1488 
	#DEFAULT_JOURNAL_IOPRIO
 (
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 3))

	)

1489 cÚ¡ 
	gd•»ÿ‹d_msg
[] =

1493 #ifdeà
CONFIG_QUOTA


1494 
	$£t_qf_Çme
(
su³r_block
 *
sb
, 
qty³
, 
sub¡ršg_t
 *
¬gs
)

1496 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1497 *
qÇme
;

1498 
»t
 = -1;

1500 ià(
	`sb_ªy_quÙa_lßded
(
sb
) &&

1501 !
sbi
->
s_qf_Çmes
[
qty³
]) {

1502 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1507 ià(
	`ext4_has_ã©u»_quÙa
(
sb
)) {

1508 
	`ext4_msg
(
sb
, 
KERN_INFO
, "Journaled quota options "

1512 
qÇme
 = 
	`m©ch_¡rdup
(
¬gs
);

1513 ià(!
qÇme
) {

1514 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1518 ià(
sbi
->
s_qf_Çmes
[
qty³
]) {

1519 ià(
	`¡rcmp
(
sbi
->
s_qf_Çmes
[
qty³
], 
qÇme
) == 0)

1520 
»t
 = 1;

1522 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1524 
	`QTYPE2NAME
(
qty³
));

1525 
”rout
;

1527 ià(
	`¡rchr
(
qÇme
, '/')) {

1528 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1530 
”rout
;

1532 
sbi
->
s_qf_Çmes
[
qty³
] = 
qÇme
;

1533 
	`£t_İt
(
sb
, 
QUOTA
);

1535 
”rout
:

1536 
	`kä“
(
qÇme
);

1537  
»t
;

1538 
	}
}

1540 
	$ş—r_qf_Çme
(
su³r_block
 *
sb
, 
qty³
)

1543 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1545 ià(
	`sb_ªy_quÙa_lßded
(
sb
) &&

1546 
sbi
->
s_qf_Çmes
[
qty³
]) {

1547 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled quota options"

1551 
	`kä“
(
sbi
->
s_qf_Çmes
[
qty³
]);

1552 
sbi
->
s_qf_Çmes
[
qty³
] = 
NULL
;

1554 
	}
}

1557 
	#MOPT_SET
 0x0001

	)

1558 
	#MOPT_CLEAR
 0x0002

	)

1559 
	#MOPT_NOSUPPORT
 0x0004

	)

1560 
	#MOPT_EXPLICIT
 0x0008

	)

1561 
	#MOPT_CLEAR_ERR
 0x0010

	)

1562 
	#MOPT_GTE0
 0x0020

	)

1563 #ifdeà
CONFIG_QUOTA


1564 
	#MOPT_Q
 0

	)

1565 
	#MOPT_QFMT
 0x0040

	)

1567 
	#MOPT_Q
 
MOPT_NOSUPPORT


	)

1568 
	#MOPT_QFMT
 
MOPT_NOSUPPORT


	)

1570 
	#MOPT_DATAJ
 0x0080

	)

1571 
	#MOPT_NO_EXT2
 0x0100

	)

1572 
	#MOPT_NO_EXT3
 0x0200

	)

1573 
	#MOPT_EXT4_ONLY
 (
MOPT_NO_EXT2
 | 
MOPT_NO_EXT3
)

	)

1574 
	#MOPT_STRING
 0x0400

	)

1575 
	#MOPT_2
 0x0800

	)

1577 cÚ¡ 
	smouÁ_İts
 {

1578 
	mtok’
;

1579 
	mmouÁ_İt
;

1580 
	mæags
;

1581 } 
	gext4_mouÁ_İts
[] = {

1582 {
O±_mšix_df
, 
EXT4_MOUNT_MINIX_DF
, 
MOPT_SET
},

1583 {
O±_bsd_df
, 
EXT4_MOUNT_MINIX_DF
, 
MOPT_CLEAR
},

1584 {
O±_g½id
, 
EXT4_MOUNT_GRPID
, 
MOPT_SET
},

1585 {
O±_nog½id
, 
EXT4_MOUNT_GRPID
, 
MOPT_CLEAR
},

1586 {
O±_block_v®id™y
, 
EXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_SET
},

1587 {
O±_noblock_v®id™y
, 
EXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_CLEAR
},

1588 {
O±_diÜ—d_nŞock
, 
EXT4_MOUNT_DIOREAD_NOLOCK
,

1589 
MOPT_EXT4_ONLY
 | 
MOPT_SET
},

1590 {
O±_diÜ—d_lock
, 
EXT4_MOUNT_DIOREAD_NOLOCK
,

1591 
MOPT_EXT4_ONLY
 | 
MOPT_CLEAR
},

1592 {
O±_disÿrd
, 
EXT4_MOUNT_DISCARD
, 
MOPT_SET
},

1593 {
O±_nodisÿrd
, 
EXT4_MOUNT_DISCARD
, 
MOPT_CLEAR
},

1594 {
O±_d–®loc
, 
EXT4_MOUNT_DELALLOC
,

1595 
MOPT_EXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1596 {
O±_nod–®loc
, 
EXT4_MOUNT_DELALLOC
,

1597 
MOPT_EXT4_ONLY
 | 
MOPT_CLEAR
},

1598 {
O±_nojouº®_checksum
, 
EXT4_MOUNT_JOURNAL_CHECKSUM
,

1599 
MOPT_EXT4_ONLY
 | 
MOPT_CLEAR
},

1600 {
O±_jouº®_checksum
, 
EXT4_MOUNT_JOURNAL_CHECKSUM
,

1601 
MOPT_EXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1602 {
O±_jouº®_async_comm™
, (
EXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 |

1603 
EXT4_MOUNT_JOURNAL_CHECKSUM
),

1604 
MOPT_EXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1605 {
O±_nŞßd
, 
EXT4_MOUNT_NOLOAD
, 
MOPT_NO_EXT2
 | 
MOPT_SET
},

1606 {
O±_”r_·nic
, 
EXT4_MOUNT_ERRORS_PANIC
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1607 {
O±_”r_ro
, 
EXT4_MOUNT_ERRORS_RO
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1608 {
O±_”r_cÚt
, 
EXT4_MOUNT_ERRORS_CONT
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1609 {
O±_d©a_”r_abÜt
, 
EXT4_MOUNT_DATA_ERR_ABORT
,

1610 
MOPT_NO_EXT2
},

1611 {
O±_d©a_”r_ignÜe
, 
EXT4_MOUNT_DATA_ERR_ABORT
,

1612 
MOPT_NO_EXT2
},

1613 {
O±_b¬r›r
, 
EXT4_MOUNT_BARRIER
, 
MOPT_SET
},

1614 {
O±_nob¬r›r
, 
EXT4_MOUNT_BARRIER
, 
MOPT_CLEAR
},

1615 {
O±_nßuto_da_®loc
, 
EXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_SET
},

1616 {
O±_auto_da_®loc
, 
EXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_CLEAR
},

1617 {
O±_noš™_™abË
, 
EXT4_MOUNT_INIT_INODE_TABLE
, 
MOPT_CLEAR
},

1618 {
O±_comm™
, 0, 
MOPT_GTE0
},

1619 {
O±_max_b©ch_time
, 0, 
MOPT_GTE0
},

1620 {
O±_mš_b©ch_time
, 0, 
MOPT_GTE0
},

1621 {
O±_šode_»adah—d_blks
, 0, 
MOPT_GTE0
},

1622 {
O±_š™_™abË
, 0, 
MOPT_GTE0
},

1623 {
O±_dax
, 
EXT4_MOUNT_DAX
, 
MOPT_SET
},

1624 {
O±_¡re
, 0, 
MOPT_GTE0
},

1625 {
O±_»suid
, 0, 
MOPT_GTE0
},

1626 {
O±_»sgid
, 0, 
MOPT_GTE0
},

1627 {
O±_jouº®_dev
, 0, 
MOPT_NO_EXT2
 | 
MOPT_GTE0
},

1628 {
O±_jouº®_·th
, 0, 
MOPT_NO_EXT2
 | 
MOPT_STRING
},

1629 {
O±_jouº®_iİrio
, 0, 
MOPT_NO_EXT2
 | 
MOPT_GTE0
},

1630 {
O±_d©a_jouº®
, 
EXT4_MOUNT_JOURNAL_DATA
, 
MOPT_NO_EXT2
 | 
MOPT_DATAJ
},

1631 {
O±_d©a_Üd”ed
, 
EXT4_MOUNT_ORDERED_DATA
, 
MOPT_NO_EXT2
 | 
MOPT_DATAJ
},

1632 {
O±_d©a_wr™eback
, 
EXT4_MOUNT_WRITEBACK_DATA
,

1633 
MOPT_NO_EXT2
 | 
MOPT_DATAJ
},

1634 {
O±_u£r_x©Œ
, 
EXT4_MOUNT_XATTR_USER
, 
MOPT_SET
},

1635 {
O±_nou£r_x©Œ
, 
EXT4_MOUNT_XATTR_USER
, 
MOPT_CLEAR
},

1636 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


1637 {
O±_aş
, 
EXT4_MOUNT_POSIX_ACL
, 
MOPT_SET
},

1638 {
O±_nßş
, 
EXT4_MOUNT_POSIX_ACL
, 
MOPT_CLEAR
},

1640 {
O±_aş
, 0, 
MOPT_NOSUPPORT
},

1641 {
O±_nßş
, 0, 
MOPT_NOSUPPORT
},

1643 {
O±_nouid32
, 
EXT4_MOUNT_NO_UID32
, 
MOPT_SET
},

1644 {
O±_debug
, 
EXT4_MOUNT_DEBUG
, 
MOPT_SET
},

1645 {
O±_debug_wªt_exŒa_isize
, 0, 
MOPT_GTE0
},

1646 {
O±_quÙa
, 
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_USRQUOTA
, 
MOPT_SET
 | 
MOPT_Q
},

1647 {
O±_u¤quÙa
, 
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_USRQUOTA
,

1648 
MOPT_SET
 | 
MOPT_Q
},

1649 {
O±_g½quÙa
, 
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_GRPQUOTA
,

1650 
MOPT_SET
 | 
MOPT_Q
},

1651 {
O±_´jquÙa
, 
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_PRJQUOTA
,

1652 
MOPT_SET
 | 
MOPT_Q
},

1653 {
O±_noquÙa
, (
EXT4_MOUNT_QUOTA
 | 
EXT4_MOUNT_USRQUOTA
 |

1654 
EXT4_MOUNT_GRPQUOTA
 | 
EXT4_MOUNT_PRJQUOTA
),

1655 
MOPT_CLEAR
 | 
MOPT_Q
},

1656 {
O±_u¤jquÙa
, 0, 
MOPT_Q
},

1657 {
O±_g½jquÙa
, 0, 
MOPT_Q
},

1658 {
O±_offu¤jquÙa
, 0, 
MOPT_Q
},

1659 {
O±_offg½jquÙa
, 0, 
MOPT_Q
},

1660 {
O±_jqfmt_vfsŞd
, 
QFMT_VFS_OLD
, 
MOPT_QFMT
},

1661 {
O±_jqfmt_vfsv0
, 
QFMT_VFS_V0
, 
MOPT_QFMT
},

1662 {
O±_jqfmt_vfsv1
, 
QFMT_VFS_V1
, 
MOPT_QFMT
},

1663 {
O±_max_dœ_size_kb
, 0, 
MOPT_GTE0
},

1664 {
O±_‹¡_dummy_’üy±iÚ
, 0, 
MOPT_GTE0
},

1665 {
O±_nombÿche
, 
EXT4_MOUNT_NO_MBCACHE
, 
MOPT_SET
},

1666 {
O±_no_fc
, 
EXT4_MOUNT2_JOURNAL_FAST_COMMIT
,

1667 
MOPT_CLEAR
 | 
MOPT_2
 | 
MOPT_EXT4_ONLY
},

1668 {
O±_fc_soá_cÚsi¡’cy
, 
EXT4_MOUNT2_JOURNAL_FC_SOFT_CONSISTENCY
,

1669 
MOPT_SET
 | 
MOPT_2
 | 
MOPT_EXT4_ONLY
},

1670 {
O±_”r
, 0, 0}

1673 
	$hªdË_mouÁ_İt
(
su³r_block
 *
sb
, *
İt
, 
tok’
,

1674 
sub¡ršg_t
 *
¬gs
, *
jouº®_devnum
,

1675 *
jouº®_iİrio
, 
is_»mouÁ
)

1677 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1678 cÚ¡ 
mouÁ_İts
 *
m
;

1679 
kuid_t
 
uid
;

1680 
kgid_t
 
gid
;

1681 
¬g
 = 0;

1683 #ifdeà
CONFIG_QUOTA


1684 ià(
tok’
 =ğ
O±_u¤jquÙa
)

1685  
	`£t_qf_Çme
(
sb
, 
USRQUOTA
, &
¬gs
[0]);

1686 ià(
tok’
 =ğ
O±_g½jquÙa
)

1687  
	`£t_qf_Çme
(
sb
, 
GRPQUOTA
, &
¬gs
[0]);

1688 ià(
tok’
 =ğ
O±_offu¤jquÙa
)

1689  
	`ş—r_qf_Çme
(
sb
, 
USRQUOTA
);

1690 ià(
tok’
 =ğ
O±_offg½jquÙa
)

1691  
	`ş—r_qf_Çme
(
sb
, 
GRPQUOTA
);

1693 
tok’
) {

1694 
O±_nßş
:

1695 
O±_nou£r_x©Œ
:

1696 
	`ext4_msg
(
sb
, 
KERN_WARNING
, 
d•»ÿ‹d_msg
, 
İt
, "3.5");

1698 
O±_sb
:

1700 
O±_»moved
:

1701 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "IgnÜšg„emoved % İtiÚ", 
İt
);

1703 
O±_abÜt
:

1704 
sbi
->
s_mouÁ_æags
 |ğ
EXT4_MF_FS_ABORTED
;

1706 
O±_i_v”siÚ
:

1707 
sb
->
s_æags
 |ğ
MS_I_VERSION
;

1709 
O±_Ïzytime
:

1710 
sb
->
s_æags
 |ğ
MS_LAZYTIME
;

1712 
O±_nŞazytime
:

1713 
sb
->
s_æags
 &ğ~
MS_LAZYTIME
;

1717 
m
 = 
ext4_mouÁ_İts
; m->
tok’
 !ğ
O±_”r
; m++)

1718 ià(
tok’
 =ğ
m
->token)

1721 ià(
m
->
tok’
 =ğ
O±_”r
) {

1722 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Unrecognized mount option \"%s\" "

1723 "Ü missšg v®ue", 
İt
);

1727 ià((
m
->
æags
 & 
MOPT_NO_EXT2
è&& 
	`IS_EXT2_SB
(
sb
)) {

1728 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1729 "MouÁ o±iÚ \"%s\" incom·tibË w™hƒxt2", 
İt
);

1732 ià((
m
->
æags
 & 
MOPT_NO_EXT3
è&& 
	`IS_EXT3_SB
(
sb
)) {

1733 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1734 "MouÁ o±iÚ \"%s\" incom·tibË w™hƒxt3", 
İt
);

1738 ià(
¬gs
->
äom
 && !(
m
->
æags
 & 
MOPT_STRING
è&& 
	`m©ch_št
×rgs, &
¬g
))

1740 ià(
¬gs
->
äom
 && (
m
->
æags
 & 
MOPT_GTE0
è&& (
¬g
 < 0))

1742 ià(
m
->
æags
 & 
MOPT_EXPLICIT
) {

1743 ià(
m
->
mouÁ_İt
 & 
EXT4_MOUNT_DELALLOC
) {

1744 
	`£t_İt2
(
sb
, 
EXPLICIT_DELALLOC
);

1745 } ià(
m
->
mouÁ_İt
 & 
EXT4_MOUNT_JOURNAL_CHECKSUM
) {

1746 
	`£t_İt2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
);

1750 ià(
m
->
æags
 & 
MOPT_CLEAR_ERR
)

1751 
	`ş—r_İt
(
sb
, 
ERRORS_MASK
);

1752 ià(
tok’
 =ğ
O±_noquÙa
 && 
	`sb_ªy_quÙa_lßded
(
sb
)) {

1753 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Cannot change quota "

1758 ià(
m
->
æags
 & 
MOPT_NOSUPPORT
) {

1759 
	`ext4_msg
(
sb
, 
KERN_ERR
, "% İtiÚ‚Ù suµÜ‹d", 
İt
);

1760 } ià(
tok’
 =ğ
O±_comm™
) {

1761 ià(
¬g
 == 0)

1762 
¬g
 = 
JBD2_DEFAULT_MAX_COMMIT_AGE
;

1763 
sbi
->
s_comm™_š‹rv®
 = 
HZ
 * 
¬g
;

1764 } ià(
tok’
 =ğ
O±_debug_wªt_exŒa_isize
) {

1765 
sbi
->
s_wªt_exŒa_isize
 = 
¬g
;

1766 } ià(
tok’
 =ğ
O±_max_b©ch_time
) {

1767 
sbi
->
s_max_b©ch_time
 = 
¬g
;

1768 } ià(
tok’
 =ğ
O±_mš_b©ch_time
) {

1769 
sbi
->
s_mš_b©ch_time
 = 
¬g
;

1770 } ià(
tok’
 =ğ
O±_šode_»adah—d_blks
) {

1771 ià(
¬g
 && (¬g > (1 << 30è|| !
	`is_pow”_of_2
(arg))) {

1772 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1777 
sbi
->
s_šode_»adah—d_blks
 = 
¬g
;

1778 } ià(
tok’
 =ğ
O±_š™_™abË
) {

1779 
	`£t_İt
(
sb
, 
INIT_INODE_TABLE
);

1780 ià(!
¬gs
->
äom
)

1781 
¬g
 = 
EXT4_DEF_LI_WAIT_MULT
;

1782 
sbi
->
s_li_wa™_muÉ
 = 
¬g
;

1783 } ià(
tok’
 =ğ
O±_max_dœ_size_kb
) {

1784 
sbi
->
s_max_dœ_size_kb
 = 
¬g
;

1785 } ià(
tok’
 =ğ
O±_¡re
) {

1786 
sbi
->
s_¡re
 = 
¬g
;

1787 } ià(
tok’
 =ğ
O±_»suid
) {

1788 
uid
 = 
	`make_kuid
(
	`cu¼’t_u£r_ns
(), 
¬g
);

1789 ià(!
	`uid_v®id
(
uid
)) {

1790 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Inv®id uid v®u%d", 
¬g
);

1793 
sbi
->
s_»suid
 = 
uid
;

1794 } ià(
tok’
 =ğ
O±_»sgid
) {

1795 
gid
 = 
	`make_kgid
(
	`cu¼’t_u£r_ns
(), 
¬g
);

1796 ià(!
	`gid_v®id
(
gid
)) {

1797 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Inv®id gid v®u%d", 
¬g
);

1800 
sbi
->
s_»sgid
 = 
gid
;

1801 } ià(
tok’
 =ğ
O±_jouº®_dev
) {

1802 ià(
is_»mouÁ
) {

1803 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1807 *
jouº®_devnum
 = 
¬g
;

1808 } ià(
tok’
 =ğ
O±_jouº®_·th
) {

1809 *
jouº®_·th
;

1810 
šode
 *
jouº®_šode
;

1811 
·th
…ath;

1812 
”rÜ
;

1814 ià(
is_»mouÁ
) {

1815 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1819 
jouº®_·th
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

1820 ià(!
jouº®_·th
) {

1821 
	`ext4_msg
(
sb
, 
KERN_ERR
, "error: could‚ot dup "

1826 
”rÜ
 = 
	`k”n_·th
(
jouº®_·th
, 
LOOKUP_FOLLOW
, &
·th
);

1827 ià(
”rÜ
) {

1828 
	`ext4_msg
(
sb
, 
KERN_ERR
, "error: could‚ot find "

1829 "jouº® deviû…©h:ƒ¼Ü %d", 
”rÜ
);

1830 
	`kä“
(
jouº®_·th
);

1834 
jouº®_šode
 = 
	`d_šode
(
·th
.
d’Œy
);

1835 ià(!
	`S_ISBLK
(
jouº®_šode
->
i_mode
)) {

1836 
	`ext4_msg
(
sb
, 
KERN_ERR
, "error: journal…ath %s "

1837 "i nÙ‡ block deviû", 
jouº®_·th
);

1838 
	`·th_put
(&
·th
);

1839 
	`kä“
(
jouº®_·th
);

1843 *
jouº®_devnum
 = 
	`Ãw_’code_dev
(
jouº®_šode
->
i_rdev
);

1844 
	`·th_put
(&
·th
);

1845 
	`kä“
(
jouº®_·th
);

1846 } ià(
tok’
 =ğ
O±_jouº®_iİrio
) {

1847 ià(
¬g
 > 7) {

1848 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Invalid journal IO…riority"

1852 *
jouº®_iİrio
 =

1853 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
¬g
);

1854 } ià(
tok’
 =ğ
O±_‹¡_dummy_’üy±iÚ
) {

1855 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


1856 
sbi
->
s_mouÁ_æags
 |ğ
EXT4_MF_TEST_DUMMY_ENCRYPTION
;

1857 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

1860 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

1863 } ià(
m
->
æags
 & 
MOPT_DATAJ
) {

1864 ià(
is_»mouÁ
) {

1865 ià(!
sbi
->
s_jouº®
)

1866 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "Remounting file system with‚o journal so ignoring journalled data option");

1867 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è!ğ
m
->
mouÁ_İt
) {

1868 
	`ext4_msg
(
sb
, 
KERN_ERR
,

1873 
	`ş—r_İt
(
sb
, 
DATA_FLAGS
);

1874 
sbi
->
s_mouÁ_İt
 |ğ
m
->
mouÁ_İt
;

1876 #ifdeà
CONFIG_QUOTA


1877 } ià(
m
->
æags
 & 
MOPT_QFMT
) {

1878 ià(
	`sb_ªy_quÙa_lßded
(
sb
) &&

1879 
sbi
->
s_jquÙa_fmt
 !ğ
m
->
mouÁ_İt
) {

1880 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled "

1884 ià(
	`ext4_has_ã©u»_quÙa
(
sb
)) {

1885 
	`ext4_msg
(
sb
, 
KERN_INFO
,

1890 
sbi
->
s_jquÙa_fmt
 = 
m
->
mouÁ_İt
;

1892 } ià(
tok’
 =ğ
O±_dax
) {

1893 #ifdeà
CONFIG_FS_DAX


1894 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

1896 
sbi
->
s_mouÁ_İt
 |ğ
m
->
mouÁ_İt
;

1898 
	`ext4_msg
(
sb
, 
KERN_INFO
, "dax option‚ot supported");

1901 } ià(
tok’
 =ğ
O±_d©a_”r_abÜt
) {

1902 
sbi
->
s_mouÁ_İt
 |ğ
m
->
mouÁ_İt
;

1903 } ià(
tok’
 =ğ
O±_d©a_”r_ignÜe
) {

1904 
sbi
->
s_mouÁ_İt
 &ğ~
m
->
mouÁ_İt
;

1906 ià(!
¬gs
->
äom
)

1907 
¬g
 = 1;

1908 ià(
m
->
æags
 & 
MOPT_CLEAR
)

1909 
¬g
 = !arg;

1910 ià(
	`uÆik–y
(!(
m
->
æags
 & 
MOPT_SET
))) {

1911 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

1912 "buggy hªdlšg oàİtiÚ %s", 
İt
);

1913 
	`WARN_ON
(1);

1916 ià(
m
->
æags
 & 
MOPT_2
) {

1917 ià(
¬g
 != 0)

1918 
sbi
->
s_mouÁ_İt2
 |ğ
m
->
mouÁ_İt
;

1920 
sbi
->
s_mouÁ_İt2
 &ğ~
m
->
mouÁ_İt
;

1922 ià(
¬g
 != 0)

1923 
sbi
->
s_mouÁ_İt
 |ğ
m
->
mouÁ_İt
;

1925 
sbi
->
s_mouÁ_İt
 &ğ~
m
->
mouÁ_İt
;

1929 
	}
}

1931 
	$·r£_İtiÚs
(*
İtiÚs
, 
su³r_block
 *
sb
,

1932 *
jouº®_devnum
,

1933 *
jouº®_iİrio
,

1934 
is_»mouÁ
)

1936 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

1937 *
p
;

1938 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

1939 
tok’
;

1941 ià(!
İtiÚs
)

1944 (
p
 = 
	`¡r£p
(&
İtiÚs
, ",")è!ğ
NULL
) {

1945 ià(!*
p
)

1951 
¬gs
[0].
to
 =‡rgs[0].
äom
 = 
NULL
;

1952 
tok’
 = 
	`m©ch_tok’
(
p
, 
tok’s
, 
¬gs
);

1953 ià(
	`hªdË_mouÁ_İt
(
sb
, 
p
, 
tok’
, 
¬gs
, 
jouº®_devnum
,

1954 
jouº®_iİrio
, 
is_»mouÁ
) < 0)

1957 #ifdeà
CONFIG_QUOTA


1963 ià(
	`‹¡_İt
(
sb
, 
PRJQUOTA
è&& !
	`ext4_has_ã©u»_´ojeù
(sb)) {

1964 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Project quota feature‚otƒnabled. "

1968 ià(
sbi
->
s_qf_Çmes
[
USRQUOTA
] || sbi->s_qf_Çmes[
GRPQUOTA
]) {

1969 ià(
	`‹¡_İt
(
sb
, 
USRQUOTA
è&& 
sbi
->
s_qf_Çmes
[USRQUOTA])

1970 
	`ş—r_İt
(
sb
, 
USRQUOTA
);

1972 ià(
	`‹¡_İt
(
sb
, 
GRPQUOTA
è&& 
sbi
->
s_qf_Çmes
[GRPQUOTA])

1973 
	`ş—r_İt
(
sb
, 
GRPQUOTA
);

1975 ià(
	`‹¡_İt
(
sb
, 
GRPQUOTA
è||e¡_İt(sb, 
USRQUOTA
)) {

1976 
	`ext4_msg
(
sb
, 
KERN_ERR
, "old‡nd‚ew quota "

1981 ià(!
sbi
->
s_jquÙa_fmt
) {

1982 
	`ext4_msg
(
sb
, 
KERN_ERR
, "journaled quota format "

1988 ià(
	`‹¡_İt
(
sb
, 
DIOREAD_NOLOCK
)) {

1989 
blocksize
 =

1990 
BLOCK_SIZE
 << 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_log_block_size
);

1992 ià(
blocksize
 < 
PAGE_SIZE
) {

1993 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

1999 
	}
}

2001 
šlše
 
	$ext4_show_quÙa_İtiÚs
(
£q_fe
 *
£q
,

2002 
su³r_block
 *
sb
)

2004 #ià
	`defšed
(
CONFIG_QUOTA
)

2005 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2007 ià(
sbi
->
s_jquÙa_fmt
) {

2008 *
fmŠame
 = "";

2010 
sbi
->
s_jquÙa_fmt
) {

2011 
QFMT_VFS_OLD
:

2012 
fmŠame
 = "vfsold";

2014 
QFMT_VFS_V0
:

2015 
fmŠame
 = "vfsv0";

2017 
QFMT_VFS_V1
:

2018 
fmŠame
 = "vfsv1";

2021 
	`£q_´štf
(
£q
, ",jqfmt=%s", 
fmŠame
);

2024 ià(
sbi
->
s_qf_Çmes
[
USRQUOTA
])

2025 
	`£q_show_İtiÚ
(
£q
, "u¤jquÙa", 
sbi
->
s_qf_Çmes
[
USRQUOTA
]);

2027 ià(
sbi
->
s_qf_Çmes
[
GRPQUOTA
])

2028 
	`£q_show_İtiÚ
(
£q
, "g½jquÙa", 
sbi
->
s_qf_Çmes
[
GRPQUOTA
]);

2030 
	}
}

2032 cÚ¡ *
	$tok’2¡r
(
tok’
)

2034 cÚ¡ 
m©ch_tok’
 *
t
;

2036 
t
 = 
tok’s
;->
tok’
 !ğ
O±_”r
;++)

2037 ià(
t
->
tok’
 =ğtok’ && !
	`¡rchr
Ñ->
·‰”n
, '='))

2039  
t
->
·‰”n
;

2040 
	}
}

2047 
	$_ext4_show_İtiÚs
(
£q_fe
 *
£q
, 
su³r_block
 *
sb
,

2048 
nodefs
)

2050 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2051 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

2052 
def_”rÜs
, 
def_mouÁ_İt
 = 
nodefs
 ? 0 : 
sbi
->
s_def_mouÁ_İt
;

2053 cÚ¡ 
mouÁ_İts
 *
m
;

2054 
£p
 = 
nodefs
 ? '\n' : ',';

2056 
	#SEQ_OPTS_PUTS
(
¡r
è
	`£q_´štf
(
£q
, "%c" sŒ, 
£p
)

	)

2057 
	#SEQ_OPTS_PRINT
(
¡r
, 
¬g
è
	`£q_´štf
(
£q
, "%c" sŒ, 
£p
,‡rg)

	)

2059 ià(
sbi
->
s_sb_block
 != 1)

2060 
	`SEQ_OPTS_PRINT
("sb=%Îu", 
sbi
->
s_sb_block
);

2062 
m
 = 
ext4_mouÁ_İts
; m->
tok’
 !ğ
O±_”r
; m++) {

2063 
wªt_£t
 = 
m
->
æags
 & 
MOPT_SET
;

2064 ià(((
m
->
æags
 & (
MOPT_SET
|
MOPT_CLEAR
)) == 0) ||

2065 (
m
->
æags
 & 
MOPT_CLEAR_ERR
))

2067 ià(!(
m
->
mouÁ_İt
 & (
sbi
->
s_mouÁ_İt
 ^ 
def_mouÁ_İt
)))

2069 ià((
wªt_£t
 &&

2070 (
sbi
->
s_mouÁ_İt
 & 
m
->
mouÁ_İt
) != m->mount_opt) ||

2071 (!
wªt_£t
 && (
sbi
->
s_mouÁ_İt
 & 
m
->
mouÁ_İt
)))

2073 
	`SEQ_OPTS_PRINT
("%s", 
	`tok’2¡r
(
m
->
tok’
));

2076 ià(
nodefs
 || !
	`uid_eq
(
sbi
->
s_»suid
, 
	`make_kuid
(&
š™_u£r_ns
, 
EXT4_DEF_RESUID
)) ||

2077 
	`Ë16_to_ıu
(
es
->
s_def_»suid
è!ğ
EXT4_DEF_RESUID
)

2078 
	`SEQ_OPTS_PRINT
("resuid=%u",

2079 
	`äom_kuid_munged
(&
š™_u£r_ns
, 
sbi
->
s_»suid
));

2080 ià(
nodefs
 || !
	`gid_eq
(
sbi
->
s_»sgid
, 
	`make_kgid
(&
š™_u£r_ns
, 
EXT4_DEF_RESGID
)) ||

2081 
	`Ë16_to_ıu
(
es
->
s_def_»sgid
è!ğ
EXT4_DEF_RESGID
)

2082 
	`SEQ_OPTS_PRINT
("resgid=%u",

2083 
	`äom_kgid_munged
(&
š™_u£r_ns
, 
sbi
->
s_»sgid
));

2084 
def_”rÜs
 = 
nodefs
 ? -1 : 
	`Ë16_to_ıu
(
es
->
s_”rÜs
);

2085 ià(
	`‹¡_İt
(
sb
, 
ERRORS_RO
è&& 
def_”rÜs
 !ğ
EXT4_ERRORS_RO
)

2086 
	`SEQ_OPTS_PUTS
("errors=remount-ro");

2087 ià(
	`‹¡_İt
(
sb
, 
ERRORS_CONT
è&& 
def_”rÜs
 !ğ
EXT4_ERRORS_CONTINUE
)

2088 
	`SEQ_OPTS_PUTS
("errors=continue");

2089 ià(
	`‹¡_İt
(
sb
, 
ERRORS_PANIC
è&& 
def_”rÜs
 !ğ
EXT4_ERRORS_PANIC
)

2090 
	`SEQ_OPTS_PUTS
("errors=panic");

2091 ià(
nodefs
 || 
sbi
->
s_comm™_š‹rv®
 !ğ
JBD2_DEFAULT_MAX_COMMIT_AGE
*
HZ
)

2092 
	`SEQ_OPTS_PRINT
("comm™=%lu", 
sbi
->
s_comm™_š‹rv®
 / 
HZ
);

2093 ià(
nodefs
 || 
sbi
->
s_mš_b©ch_time
 !ğ
EXT4_DEF_MIN_BATCH_TIME
)

2094 
	`SEQ_OPTS_PRINT
("mš_b©ch_time=%u", 
sbi
->
s_mš_b©ch_time
);

2095 ià(
nodefs
 || 
sbi
->
s_max_b©ch_time
 !ğ
EXT4_DEF_MAX_BATCH_TIME
)

2096 
	`SEQ_OPTS_PRINT
("max_b©ch_time=%u", 
sbi
->
s_max_b©ch_time
);

2097 ià(
sb
->
s_æags
 & 
MS_I_VERSION
)

2098 
	`SEQ_OPTS_PUTS
("i_version");

2099 ià(
nodefs
 || 
sbi
->
s_¡re
)

2100 
	`SEQ_OPTS_PRINT
("¡re=%lu", 
sbi
->
s_¡re
);

2101 ià(
EXT4_MOUNT_DATA_FLAGS
 & (
sbi
->
s_mouÁ_İt
 ^ 
def_mouÁ_İt
)) {

2102 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
)

2103 
	`SEQ_OPTS_PUTS
("data=journal");

2104 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
)

2105 
	`SEQ_OPTS_PUTS
("data=ordered");

2106 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_WRITEBACK_DATA
)

2107 
	`SEQ_OPTS_PUTS
("data=writeback");

2109 ià(
nodefs
 ||

2110 
sbi
->
s_šode_»adah—d_blks
 !ğ
EXT4_DEF_INODE_READAHEAD_BLKS
)

2111 
	`SEQ_OPTS_PRINT
("inode_readahead_blks=%u",

2112 
sbi
->
s_šode_»adah—d_blks
);

2114 ià(
nodefs
 || (
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
) &&

2115 (
sbi
->
s_li_wa™_muÉ
 !ğ
EXT4_DEF_LI_WAIT_MULT
)))

2116 
	`SEQ_OPTS_PRINT
("š™_™abË=%u", 
sbi
->
s_li_wa™_muÉ
);

2117 ià(
nodefs
 || 
sbi
->
s_max_dœ_size_kb
)

2118 
	`SEQ_OPTS_PRINT
("max_dœ_size_kb=%u", 
sbi
->
s_max_dœ_size_kb
);

2119 ià(
	`‹¡_İt
(
sb
, 
DATA_ERR_ABORT
))

2120 
	`SEQ_OPTS_PUTS
("data_err=abort");

2122 
	`ext4_show_quÙa_İtiÚs
(
£q
, 
sb
);

2124 
	}
}

2126 
	$ext4_show_İtiÚs
(
£q_fe
 *
£q
, 
d’Œy
 *
roÙ
)

2128  
	`_ext4_show_İtiÚs
(
£q
, 
roÙ
->
d_sb
, 0);

2129 
	}
}

2131 
	$ext4_£q_İtiÚs_show
(
£q_fe
 *
£q
, *
off£t
)

2133 
su³r_block
 *
sb
 = 
£q
->
´iv©e
;

2134 
rc
;

2136 
	`£q_puts
(
£q
, (
sb
->
s_æags
 & 
MS_RDONLY
) ? "ro" : "rw");

2137 
rc
 = 
	`_ext4_show_İtiÚs
(
£q
, 
sb
, 1);

2138 
	`£q_puts
(
£q
, "\n");

2139  
rc
;

2140 
	}
}

2142 
	$ext4_£tup_su³r
(
su³r_block
 *
sb
, 
ext4_su³r_block
 *
es
,

2143 
»ad_Úly
)

2145 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2146 
»s
 = 0;

2148 ià(
	`Ë32_to_ıu
(
es
->
s_»v_Ëv–
è> 
EXT4_MAX_SUPP_REV
) {

2149 
	`ext4_msg
(
sb
, 
KERN_ERR
, "revision†eveloo high, "

2151 
»s
 = 
MS_RDONLY
;

2153 ià(
»ad_Úly
)

2154 
dÚe
;

2155 ià(!(
sbi
->
s_mouÁ_¡©e
 & 
EXT4_VALID_FS
))

2156 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "warning: mounting unchecked fs, "

2158 ià(
sbi
->
s_mouÁ_¡©e
 & 
EXT4_ERROR_FS
)

2159 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

2162 ià((
__s16
è
	`Ë16_to_ıu
(
es
->
s_max_mÁ_couÁ
) > 0 &&

2163 
	`Ë16_to_ıu
(
es
->
s_mÁ_couÁ
) >=

2164 (è(
__s16
è
	`Ë16_to_ıu
(
es
->
s_max_mÁ_couÁ
))

2165 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

2168 ià(
	`Ë32_to_ıu
(
es
->
s_checkš‹rv®
) &&

2169 (
	`Ë32_to_ıu
(
es
->
s_Ï¡check
) +

2170 
	`Ë32_to_ıu
(
es
->
s_checkš‹rv®
è<ğ
	`g‘_£cÚds
()))

2171 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

2174 ià(!
sbi
->
s_jouº®
)

2175 
es
->
s_¡©e
 &ğ
	`ıu_to_Ë16
(~
EXT4_VALID_FS
);

2176 ià(!(
__s16
è
	`Ë16_to_ıu
(
es
->
s_max_mÁ_couÁ
))

2177 
es
->
s_max_mÁ_couÁ
 = 
	`ıu_to_Ë16
(
EXT4_DFL_MAX_MNT_COUNT
);

2178 
	`Ë16_add_ıu
(&
es
->
s_mÁ_couÁ
, 1);

2179 
es
->
s_mtime
 = 
	`ıu_to_Ë32
(
	`g‘_£cÚds
());

2180 
	`ext4_upd©e_dyÇmic_»v
(
sb
);

2181 ià(
sbi
->
s_jouº®
)

2182 
	`ext4_£t_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

2184 
	`ext4_comm™_su³r
(
sb
, 1);

2185 
dÚe
:

2186 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

2187 
	`´štk
(
KERN_INFO
 "[EXT4 FS bs=%lu, gc=%u, "

2189 
sb
->
s_blocksize
,

2190 
sbi
->
s_groups_couÁ
,

2191 
	`EXT4_BLOCKS_PER_GROUP
(
sb
),

2192 
	`EXT4_INODES_PER_GROUP
(
sb
),

2193 
sbi
->
s_mouÁ_İt
, sbi->
s_mouÁ_İt2
);

2195 
	`ş—nÿche_š™_fs
(
sb
);

2196  
»s
;

2197 
	}
}

2199 
	$ext4_®loc_æex_bg_¬¿y
(
su³r_block
 *
sb
, 
ext4_group_t
 
ngroup
)

2201 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2202 
æex_groups
 *
Ãw_groups
;

2203 
size
;

2205 ià(!
sbi
->
s_log_groups_³r_æex
)

2208 
size
 = 
	`ext4_æex_group
(
sbi
, 
ngroup
 - 1) + 1;

2209 ià(
size
 <ğ
sbi
->
s_æex_groups_®loÿ‹d
)

2212 
size
 = 
	`roundup_pow_of_two
(siz* (
æex_groups
));

2213 
Ãw_groups
 = 
	`kvz®loc
(
size
, 
GFP_KERNEL
);

2214 ià(!
Ãw_groups
) {

2215 
	`ext4_msg
(
sb
, 
KERN_ERR
, "notƒnough memory for %d flex groups",

2216 
size
 / (è(
æex_groups
));

2217  -
ENOMEM
;

2220 ià(
sbi
->
s_æex_groups
) {

2221 
	`memıy
(
Ãw_groups
, 
sbi
->
s_æex_groups
,

2222 (
sbi
->
s_æex_groups_®loÿ‹d
 *

2223 (
æex_groups
)));

2224 
	`kvä“
(
sbi
->
s_æex_groups
);

2226 
sbi
->
s_æex_groups
 = 
Ãw_groups
;

2227 
sbi
->
s_æex_groups_®loÿ‹d
 = 
size
 / (
æex_groups
);

2229 
	}
}

2231 
	$ext4_fl_æex_šfo
(
su³r_block
 *
sb
)

2233 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2234 
ext4_group_desc
 *
gdp
 = 
NULL
;

2235 
ext4_group_t
 
æex_group
;

2236 
i
, 
”r
;

2238 
sbi
->
s_log_groups_³r_æex
 = sbi->
s_es
->s_log_groups_per_flex;

2239 ià(
sbi
->
s_log_groups_³r_æex
 < 1 || sbi->s_log_groups_per_flex > 31) {

2240 
sbi
->
s_log_groups_³r_æex
 = 0;

2244 
”r
 = 
	`ext4_®loc_æex_bg_¬¿y
(
sb
, 
sbi
->
s_groups_couÁ
);

2245 ià(
”r
)

2246 
çed
;

2248 
i
 = 0; i < 
sbi
->
s_groups_couÁ
; i++) {

2249 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

2251 
æex_group
 = 
	`ext4_æex_group
(
sbi
, 
i
);

2252 
	`©omic_add
(
	`ext4_ä“_šodes_couÁ
(
sb
, 
gdp
),

2253 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_šodes
);

2254 
	`©omic64_add
(
	`ext4_ä“_group_şu¡”s
(
sb
, 
gdp
),

2255 &
sbi
->
s_æex_groups
[
æex_group
].
ä“_şu¡”s
);

2256 
	`©omic_add
(
	`ext4_u£d_dœs_couÁ
(
sb
, 
gdp
),

2257 &
sbi
->
s_æex_groups
[
æex_group
].
u£d_dœs
);

2261 
çed
:

2263 
	}
}

2265 
__Ë16
 
	$ext4_group_desc_csum
(
su³r_block
 *
sb
, 
__u32
 
block_group
,

2266 
ext4_group_desc
 *
gdp
)

2268 
off£t
 = 
	`off£tof
(
ext4_group_desc
, 
bg_checksum
);

2269 
__u16
 
üc
 = 0;

2270 
__Ë32
 
Ë_group
 = 
	`ıu_to_Ë32
(
block_group
);

2271 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2273 ià(
	`ext4_has_m‘ad©a_csum
(
sbi
->
s_sb
)) {

2275 
__u32
 
csum32
;

2276 
__u16
 
dummy_csum
 = 0;

2278 
csum32
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
Ë_group
,

2279 (
Ë_group
));

2280 
csum32
 = 
	`ext4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
, 
off£t
);

2281 
csum32
 = 
	`ext4_chksum
(
sbi
, csum32, (
__u8
 *)&
dummy_csum
,

2282 (
dummy_csum
));

2283 
off£t
 +ğ(
dummy_csum
);

2284 ià(
off£t
 < 
sbi
->
s_desc_size
)

2285 
csum32
 = 
	`ext4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
 + 
off£t
,

2286 
sbi
->
s_desc_size
 - 
off£t
);

2288 
üc
 = 
csum32
 & 0xFFFF;

2289 
out
;

2293 ià(!
	`ext4_has_ã©u»_gdt_csum
(
sb
))

2296 
üc
 = 
	`üc16
(~0, 
sbi
->
s_es
->
s_uuid
, (sbi->s_es->s_uuid));

2297 
üc
 = 
	`üc16
(üc, (
__u8
 *)&
Ë_group
, (le_group));

2298 
üc
 = 
	`üc16
(üc, (
__u8
 *)
gdp
, 
off£t
);

2299 
off£t
 +ğ(
gdp
->
bg_checksum
);

2301 ià(
	`ext4_has_ã©u»_64b™
(
sb
) &&

2302 
off£t
 < 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_desc_size
))

2303 
üc
 = 
	`üc16
(üc, (
__u8
 *)
gdp
 + 
off£t
,

2304 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_desc_size
) -

2305 
off£t
);

2307 
out
:

2308  
	`ıu_to_Ë16
(
üc
);

2309 
	}
}

2311 
	$ext4_group_desc_csum_v”ify
(
su³r_block
 *
sb
, 
__u32
 
block_group
,

2312 
ext4_group_desc
 *
gdp
)

2314 ià(
	`ext4_has_group_desc_csum
(
sb
) &&

2315 (
gdp
->
bg_checksum
 !ğ
	`ext4_group_desc_csum
(
sb
, 
block_group
, gdp)))

2319 
	}
}

2321 
	$ext4_group_desc_csum_£t
(
su³r_block
 *
sb
, 
__u32
 
block_group
,

2322 
ext4_group_desc
 *
gdp
)

2324 ià(!
	`ext4_has_group_desc_csum
(
sb
))

2326 
gdp
->
bg_checksum
 = 
	`ext4_group_desc_csum
(
sb
, 
block_group
, gdp);

2327 
	}
}

2330 
	$ext4_check_desütÜs
(
su³r_block
 *
sb
,

2331 
ext4_fsblk_t
 
sb_block
,

2332 
ext4_group_t
 *
fœ¡_nÙ_z”Ûd
)

2334 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2335 
ext4_fsblk_t
 
fœ¡_block
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
);

2336 
ext4_fsblk_t
 
Ï¡_block
;

2337 
ext4_fsblk_t
 
block_b™m­
;

2338 
ext4_fsblk_t
 
šode_b™m­
;

2339 
ext4_fsblk_t
 
šode_bË
;

2340 
æexbg_æag
 = 0;

2341 
ext4_group_t
 
i
, 
g½
 = 
sbi
->
s_groups_couÁ
;

2343 ià(
	`ext4_has_ã©u»_æex_bg
(
sb
))

2344 
æexbg_æag
 = 1;

2346 
	`ext4_debug
("Checking group descriptors");

2348 
i
 = 0; i < 
sbi
->
s_groups_couÁ
; i++) {

2349 
ext4_group_desc
 *
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

2351 ià(
i
 =ğ
sbi
->
s_groups_couÁ
 - 1 || 
æexbg_æag
)

2352 
Ï¡_block
 = 
	`ext4_blocks_couÁ
(
sbi
->
s_es
) - 1;

2354 
Ï¡_block
 = 
fœ¡_block
 +

2355 (
	`EXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

2357 ià((
g½
 =ğ
sbi
->
s_groups_couÁ
) &&

2358 !(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
)))

2359 
g½
 = 
i
;

2361 
block_b™m­
 = 
	`ext4_block_b™m­
(
sb
, 
gdp
);

2362 ià(
block_b™m­
 =ğ
sb_block
) {

2363 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2365 "su³rblock", 
i
);

2367 ià(
block_b™m­
 < 
fœ¡_block
 || block_b™m­ > 
Ï¡_block
) {

2368 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2370 "(block %Îu)!", 
i
, 
block_b™m­
);

2373 
šode_b™m­
 = 
	`ext4_šode_b™m­
(
sb
, 
gdp
);

2374 ià(
šode_b™m­
 =ğ
sb_block
) {

2375 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2377 "su³rblock", 
i
);

2379 ià(
šode_b™m­
 < 
fœ¡_block
 || inode_b™m­ > 
Ï¡_block
) {

2380 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2382 "(block %Îu)!", 
i
, 
šode_b™m­
);

2385 
šode_bË
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

2386 ià(
šode_bË
 =ğ
sb_block
) {

2387 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2389 "su³rblock", 
i
);

2391 ià(
šode_bË
 < 
fœ¡_block
 ||

2392 
šode_bË
 + 
sbi
->
s_™b_³r_group
 - 1 > 
Ï¡_block
) {

2393 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2395 "(block %Îu)!", 
i
, 
šode_bË
);

2398 
	`ext4_lock_group
(
sb
, 
i
);

2399 ià(!
	`ext4_group_desc_csum_v”ify
(
sb
, 
i
, 
gdp
)) {

2400 
	`ext4_msg
(
sb
, 
KERN_ERR
, "ext4_check_descriptors: "

2402 
i
, 
	`Ë16_to_ıu
(
	`ext4_group_desc_csum
(
sb
, i,

2403 
gdp
)), 
	`Ë16_to_ıu
(gdp->
bg_checksum
));

2404 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
)) {

2405 
	`ext4_uÆock_group
(
sb
, 
i
);

2409 
	`ext4_uÆock_group
(
sb
, 
i
);

2410 ià(!
æexbg_æag
)

2411 
fœ¡_block
 +ğ
	`EXT4_BLOCKS_PER_GROUP
(
sb
);

2413 ià(
NULL
 !ğ
fœ¡_nÙ_z”Ûd
)

2414 *
fœ¡_nÙ_z”Ûd
 = 
g½
;

2416 
	}
}

2435 
	$ext4_Üphª_ş—nup
(
su³r_block
 *
sb
,

2436 
ext4_su³r_block
 *
es
)

2438 
s_æags
 = 
sb
->s_flags;

2439 
»t
, 
Ä_Üphªs
 = 0, 
Ä_Œunÿ‹s
 = 0;

2440 #ifdeà
CONFIG_QUOTA


2441 
i
;

2443 ià(!
es
->
s_Ï¡_Üphª
) {

2444 
	`jbd_debug
(4, "no orphan inodeso clean up\n");

2448 ià(
	`bdev_»ad_Úly
(
sb
->
s_bdev
)) {

2449 
	`ext4_msg
(
sb
, 
KERN_ERR
, "write‡ccess "

2455 ià(!
	`ext4_ã©u»_£t_ok
(
sb
, 0)) {

2456 
	`ext4_msg
(
sb
, 
KERN_INFO
, "Skipping orphan cleanup dueo "

2461 ià(
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 & 
EXT4_ERROR_FS
) {

2463 ià(
es
->
s_Ï¡_Üphª
 && !(
s_æags
 & 
MS_RDONLY
)) {

2464 
	`ext4_msg
(
sb
, 
KERN_INFO
, "Errors on filesystem, "

2466 
es
->
s_Ï¡_Üphª
 = 0;

2468 
	`jbd_debug
(1, "Skipping orphan„ecovery on fs withƒrrors.\n");

2472 ià(
s_æags
 & 
MS_RDONLY
) {

2473 
	`ext4_msg
(
sb
, 
KERN_INFO
, "orphan cleanup on„eadonly fs");

2474 
sb
->
s_æags
 &ğ~
MS_RDONLY
;

2476 #ifdeà
CONFIG_QUOTA


2478 
sb
->
s_æags
 |ğ
MS_ACTIVE
;

2480 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++) {

2481 ià(
	`EXT4_SB
(
sb
)->
s_qf_Çmes
[
i
]) {

2482 
»t
 = 
	`ext4_quÙa_Ú_mouÁ
(
sb
, 
i
);

2483 ià(
»t
 < 0)

2484 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2486 "quÙa:ƒ¼Ü %d", 
»t
);

2491 
es
->
s_Ï¡_Üphª
) {

2492 
šode
 *inode;

2498 ià(
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 & 
EXT4_ERROR_FS
) {

2499 
	`jbd_debug
(1, "Skipping orphan„ecovery on fs withƒrrors.\n");

2500 
es
->
s_Ï¡_Üphª
 = 0;

2504 
šode
 = 
	`ext4_Üphª_g‘
(
sb
, 
	`Ë32_to_ıu
(
es
->
s_Ï¡_Üphª
));

2505 ià(
	`IS_ERR
(
šode
)) {

2506 
es
->
s_Ï¡_Üphª
 = 0;

2510 
	`li¡_add
(&
	`EXT4_I
(
šode
)->
i_Üphª
, &
	`EXT4_SB
(
sb
)->
s_Üphª
);

2511 
	`dquÙ_š™Ÿlize
(
šode
);

2512 ià(
šode
->
i_Æšk
) {

2513 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

2514 
	`ext4_msg
(
sb
, 
KERN_DEBUG
,

2516 
__func__
, 
šode
->
i_šo
, inode->
i_size
);

2517 
	`jbd_debug
(2, "truncating inode %luo %lld bytes\n",

2518 
šode
->
i_šo
, inode->
i_size
);

2519 
	`šode_lock
(
šode
);

2520 
	`Œunÿ‹_šode_·ges
(
šode
->
i_m­pšg
, inode->
i_size
);

2521 
»t
 = 
	`ext4_Œunÿ‹
(
šode
);

2522 ià(
»t
)

2523 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
»t
);

2524 
	`šode_uÆock
(
šode
);

2525 
Ä_Œunÿ‹s
++;

2527 ià(
	`‹¡_İt
(
sb
, 
DEBUG
))

2528 
	`ext4_msg
(
sb
, 
KERN_DEBUG
,

2530 
__func__
, 
šode
->
i_šo
);

2531 
	`jbd_debug
(2, "deleting unreferenced inode %lu\n",

2532 
šode
->
i_šo
);

2533 
Ä_Üphªs
++;

2535 
	`ut
(
šode
);

2538 
	#PLURAL
(
x
è(x), ((xè=ğ1è? "" : "s"

	)

2540 ià(
Ä_Üphªs
)

2541 
	`ext4_msg
(
sb
, 
KERN_INFO
, "%d orphan inode%s deleted",

2542 
	`PLURAL
(
Ä_Üphªs
));

2543 ià(
Ä_Œunÿ‹s
)

2544 
	`ext4_msg
(
sb
, 
KERN_INFO
, "%druncate%s cleaned up",

2545 
	`PLURAL
(
Ä_Œunÿ‹s
));

2546 #ifdeà
CONFIG_QUOTA


2548 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++) {

2549 ià(
	`sb_dqİt
(
sb
)->
fes
[
i
])

2550 
	`dquÙ_quÙa_off
(
sb
, 
i
);

2553 
sb
->
s_æags
 = s_flags;

2554 
	}
}

2571 
loff_t
 
	$ext4_max_size
(
blkb™s
, 
has_huge_fes
)

2573 
loff_t
 
»s
;

2574 
loff_t
 
uµ”_lim™
 = 
MAX_LFS_FILESIZE
;

2577 ià(!
has_huge_fes
 || (
blkút_t
è< (
u64
)) {

2583 
uµ”_lim™
 = (1LL << 32) - 1;

2586 
uµ”_lim™
 >>ğ(
blkb™s
 - 9);

2587 
uµ”_lim™
 <<ğ
blkb™s
;

2595 
»s
 = (1LL << 32) - 1;

2596 
»s
 <<ğ
blkb™s
;

2599 ià(
»s
 > 
uµ”_lim™
)

2600 
»s
 = 
uµ”_lim™
;

2602  
»s
;

2603 
	}
}

2610 
loff_t
 
	$ext4_max_b™m­_size
(
b™s
, 
has_huge_fes
)

2612 
loff_t
 
»s
 = 
EXT4_NDIR_BLOCKS
;

2613 
m‘a_blocks
;

2614 
loff_t
 
uµ”_lim™
;

2623 ià(!
has_huge_fes
 || (
blkút_t
è< (
u64
)) {

2629 
uµ”_lim™
 = (1LL << 32) - 1;

2632 
uµ”_lim™
 >>ğ(
b™s
 - 9);

2641 
uµ”_lim™
 = (1LL << 48) - 1;

2646 
m‘a_blocks
 = 1;

2648 
m‘a_blocks
 +ğ1 + (1LL << (
b™s
-2));

2650 
m‘a_blocks
 +ğ1 + (1LL << (
b™s
-2)) + (1LL << (2*(bits-2)));

2652 
uµ”_lim™
 -ğ
m‘a_blocks
;

2653 
uµ”_lim™
 <<ğ
b™s
;

2655 
»s
 +ğ1LL << (
b™s
-2);

2656 
»s
 +ğ1LL << (2*(
b™s
-2));

2657 
»s
 +ğ1LL << (3*(
b™s
-2));

2658 
»s
 <<ğ
b™s
;

2659 ià(
»s
 > 
uµ”_lim™
)

2660 
»s
 = 
uµ”_lim™
;

2662 ià(
»s
 > 
MAX_LFS_FILESIZE
)

2663 
»s
 = 
MAX_LFS_FILESIZE
;

2665  
»s
;

2666 
	}
}

2668 
ext4_fsblk_t
 
	$desütÜ_loc
(
su³r_block
 *
sb
,

2669 
ext4_fsblk_t
 
logiÿl_sb_block
, 
Ä
)

2671 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

2672 
ext4_group_t
 
bg
, 
fœ¡_m‘a_bg
;

2673 
has_su³r
 = 0;

2675 
fœ¡_m‘a_bg
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_m‘a_bg
);

2677 ià(!
	`ext4_has_ã©u»_m‘a_bg
(
sb
è|| 
Ä
 < 
fœ¡_m‘a_bg
)

2678  
logiÿl_sb_block
 + 
Ä
 + 1;

2679 
bg
 = 
sbi
->
s_desc_³r_block
 * 
Ä
;

2680 ià(
	`ext4_bg_has_su³r
(
sb
, 
bg
))

2681 
has_su³r
 = 1;

2689 ià(
sb
->
s_blocksize
 =ğ1024 && 
Ä
 == 0 &&

2690 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_fœ¡_d©a_block
) == 0)

2691 
has_su³r
++;

2693  (
has_su³r
 + 
	`ext4_group_fœ¡_block_no
(
sb
, 
bg
));

2694 
	}
}

2707 
	$ext4_g‘_¡re_size
(
ext4_sb_šfo
 *
sbi
)

2709 
¡ride
 = 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_¿id_¡ride
);

2710 
¡re_width
 =

2711 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_¿id_¡re_width
);

2712 
»t
;

2714 ià(
sbi
->
s_¡re
 && sbi->s_¡r<ğsbi->
s_blocks_³r_group
)

2715 
»t
 = 
sbi
->
s_¡re
;

2716 ià(
¡re_width
 && sŒe_width <ğ
sbi
->
s_blocks_³r_group
)

2717 
»t
 = 
¡re_width
;

2718 ià(
¡ride
 && sŒid<ğ
sbi
->
s_blocks_³r_group
)

2719 
»t
 = 
¡ride
;

2721 
»t
 = 0;

2727 ià(
»t
 <= 1)

2728 
»t
 = 0;

2730  
»t
;

2731 
	}
}

2739 
	$ext4_ã©u»_£t_ok
(
su³r_block
 *
sb
, 
»adÚly
)

2741 ià(
	`ext4_has_unknown_ext4_šcom·t_ã©u»s
(
sb
)) {

2742 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2745 (
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_šcom·t
) &

2746 ~
EXT4_FEATURE_INCOMPAT_SUPP
));

2750 ià(
»adÚly
)

2753 ià(
	`ext4_has_ã©u»_»adÚly
(
sb
)) {

2754 
	`ext4_msg
(
sb
, 
KERN_INFO
, "filesystem is„ead-only");

2755 
sb
->
s_æags
 |ğ
MS_RDONLY
;

2760 ià(
	`ext4_has_unknown_ext4_ro_com·t_ã©u»s
(
sb
)) {

2761 
	`ext4_msg
(
sb
, 
KERN_ERR
, "couldn't mount RDWR because of "

2763 (
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_ã©u»_ro_com·t
) &

2764 ~
EXT4_FEATURE_RO_COMPAT_SUPP
));

2771 ià(
	`ext4_has_ã©u»_huge_fe
(
sb
)) {

2772 ià((
blkút_t
è< (
u64
)) {

2773 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Filesystem with huge files "

2779 ià(
	`ext4_has_ã©u»_big®loc
(
sb
è&& !
	`ext4_has_ã©u»_ex‹Ás
(sb)) {

2780 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2786 #iâdeà
CONFIG_QUOTA


2787 ià(
	`ext4_has_ã©u»_quÙa
(
sb
è&& !
»adÚly
) {

2788 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2793 ià(
	`ext4_has_ã©u»_´ojeù
(
sb
è&& !
»adÚly
) {

2794 
	`ext4_msg
(
sb
, 
KERN_ERR
,

2801 
	}
}

2807 
	$´št_day_”rÜ_šfo
(
¬g
)

2809 
su³r_block
 *
sb
 = (su³r_block *è
¬g
;

2810 
ext4_sb_šfo
 *
sbi
;

2811 
ext4_su³r_block
 *
es
;

2813 
sbi
 = 
	`EXT4_SB
(
sb
);

2814 
es
 = 
sbi
->
s_es
;

2816 ià(
es
->
s_”rÜ_couÁ
)

2818 
	`ext4_msg
(
sb
, 
KERN_NOTICE
, "error count since†ast fsck: %u",

2819 
	`Ë32_to_ıu
(
es
->
s_”rÜ_couÁ
));

2820 ià(
es
->
s_fœ¡_”rÜ_time
) {

2821 
	`´štk
(
KERN_NOTICE
 "EXT4-fs (%s): initialƒrror‡time %u: %.*s:%d",

2822 
sb
->
s_id
, 
	`Ë32_to_ıu
(
es
->
s_fœ¡_”rÜ_time
),

2823 (è(
es
->
s_fœ¡_”rÜ_func
),

2824 
es
->
s_fœ¡_”rÜ_func
,

2825 
	`Ë32_to_ıu
(
es
->
s_fœ¡_”rÜ_lše
));

2826 ià(
es
->
s_fœ¡_”rÜ_šo
)

2827 
	`´štk
(
KERN_CONT
 ": inode %u",

2828 
	`Ë32_to_ıu
(
es
->
s_fœ¡_”rÜ_šo
));

2829 ià(
es
->
s_fœ¡_”rÜ_block
)

2830 
	`´štk
(
KERN_CONT
 ": block %llu", ()

2831 
	`Ë64_to_ıu
(
es
->
s_fœ¡_”rÜ_block
));

2832 
	`´štk
(
KERN_CONT
 "\n");

2834 ià(
es
->
s_Ï¡_”rÜ_time
) {

2835 
	`´štk
(
KERN_NOTICE
 "EXT4-fs (%s):†astƒrror‡time %u: %.*s:%d",

2836 
sb
->
s_id
, 
	`Ë32_to_ıu
(
es
->
s_Ï¡_”rÜ_time
),

2837 (è(
es
->
s_Ï¡_”rÜ_func
),

2838 
es
->
s_Ï¡_”rÜ_func
,

2839 
	`Ë32_to_ıu
(
es
->
s_Ï¡_”rÜ_lše
));

2840 ià(
es
->
s_Ï¡_”rÜ_šo
)

2841 
	`´štk
(
KERN_CONT
 ": inode %u",

2842 
	`Ë32_to_ıu
(
es
->
s_Ï¡_”rÜ_šo
));

2843 ià(
es
->
s_Ï¡_”rÜ_block
)

2844 
	`´štk
(
KERN_CONT
 ": block %llu", ()

2845 
	`Ë64_to_ıu
(
es
->
s_Ï¡_”rÜ_block
));

2846 
	`´štk
(
KERN_CONT
 "\n");

2848 
	`mod_tim”
(&
sbi
->
s_”r_»pÜt
, 
jiff›s
 + 24*60*60*
HZ
);

2849 
	}
}

2852 
	$ext4_run_li_»que¡
(
ext4_li_»que¡
 *
–r
)

2854 
ext4_group_desc
 *
gdp
 = 
NULL
;

2855 
ext4_group_t
 
group
, 
ngroups
;

2856 
su³r_block
 *
sb
;

2857 
timeout
 = 0;

2858 
»t
 = 0;

2860 
sb
 = 
–r
->
Ì_su³r
;

2861 
ngroups
 = 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;

2863 
group
 = 
–r
->
Ì_Ãxt_group
; grou°< 
ngroups
; group++) {

2864 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, 
NULL
);

2865 ià(!
gdp
) {

2866 
»t
 = 1;

2870 ià(!(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
)))

2874 ià(
group
 >ğ
ngroups
)

2875 
»t
 = 1;

2877 ià(!
»t
) {

2878 
timeout
 = 
jiff›s
;

2879 
»t
 = 
	`ext4_š™_šode_bË
(
sb
, 
group
,

2880 
–r
->
Ì_timeout
 ? 0 : 1);

2881 ià(
–r
->
Ì_timeout
 == 0) {

2882 
timeout
 = (
jiff›s
 -imeout) *

2883 
–r
->
Ì_sbi
->
s_li_wa™_muÉ
;

2884 
–r
->
Ì_timeout
 = 
timeout
;

2886 
–r
->
Ì_Ãxt_sched
 = 
jiff›s
 +ƒÌ->
Ì_timeout
;

2887 
–r
->
Ì_Ãxt_group
 = 
group
 + 1;

2889  
»t
;

2890 
	}
}

2896 
	$ext4_»move_li_»que¡
(
ext4_li_»que¡
 *
–r
)

2898 
ext4_sb_šfo
 *
sbi
;

2900 ià(!
–r
)

2903 
sbi
 = 
–r
->
Ì_sbi
;

2905 
	`li¡_d–
(&
–r
->
Ì_»que¡
);

2906 
sbi
->
s_li_»que¡
 = 
NULL
;

2907 
	`kä“
(
–r
);

2908 
	}
}

2910 
	$ext4_uÄegi¡”_li_»que¡
(
su³r_block
 *
sb
)

2912 
	`mu‹x_lock
(&
ext4_li_mtx
);

2913 ià(!
ext4_li_šfo
) {

2914 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

2918 
	`mu‹x_lock
(&
ext4_li_šfo
->
li_li¡_mtx
);

2919 
	`ext4_»move_li_»que¡
(
	`EXT4_SB
(
sb
)->
s_li_»que¡
);

2920 
	`mu‹x_uÆock
(&
ext4_li_šfo
->
li_li¡_mtx
);

2921 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

2922 
	}
}

2924 
sk_¡ruù
 *
	gext4_Ïzyš™_sk
;

2935 
	$ext4_Ïzyš™_th»ad
(*
¬g
)

2937 
ext4_Ïzy_š™
 *
–i
 = (ext4_Ïzy_š™ *)
¬g
;

2938 
li¡_h—d
 *
pos
, *
n
;

2939 
ext4_li_»que¡
 *
–r
;

2940 
Ãxt_wakeup
, 
cur
;

2942 
	`BUG_ON
(
NULL
 =ğ
–i
);

2944 
cÚt_th»ad
:

2945 
Œue
) {

2946 
Ãxt_wakeup
 = 
MAX_JIFFY_OFFSET
;

2948 
	`mu‹x_lock
(&
–i
->
li_li¡_mtx
);

2949 ià(
	`li¡_em±y
(&
–i
->
li_»que¡_li¡
)) {

2950 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

2951 
ex™_th»ad
;

2953 
	`li¡_fÜ_—ch_§ã
(
pos
, 
n
, &
–i
->
li_»que¡_li¡
) {

2954 
”r
 = 0;

2955 
´og»ss
 = 0;

2956 
–r
 = 
	`li¡_’Œy
(
pos
, 
ext4_li_»que¡
,

2957 
Ì_»que¡
);

2959 ià(
	`time_befÜe
(
jiff›s
, 
–r
->
Ì_Ãxt_sched
)) {

2960 ià(
	`time_befÜe
(
–r
->
Ì_Ãxt_sched
, 
Ãxt_wakeup
))

2961 
Ãxt_wakeup
 = 
–r
->
Ì_Ãxt_sched
;

2964 ià(
	`down_»ad_Œylock
(&
–r
->
Ì_su³r
->
s_umouÁ
)) {

2965 ià(
	`sb_¡¬t_wr™e_Œylock
(
–r
->
Ì_su³r
)) {

2966 
´og»ss
 = 1;

2972 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

2973 
”r
 = 
	`ext4_run_li_»que¡
(
–r
);

2974 
	`sb_’d_wr™e
(
–r
->
Ì_su³r
);

2975 
	`mu‹x_lock
(&
–i
->
li_li¡_mtx
);

2976 
n
 = 
pos
->
Ãxt
;

2978 
	`up_»ad
((&
–r
->
Ì_su³r
->
s_umouÁ
));

2981 ià(
”r
) {

2982 
	`ext4_»move_li_»que¡
(
–r
);

2985 ià(!
´og»ss
) {

2986 
–r
->
Ì_Ãxt_sched
 = 
jiff›s
 +

2987 (
	`´ªdom_u32
()

2988 % (
EXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

2990 ià(
	`time_befÜe
(
–r
->
Ì_Ãxt_sched
, 
Ãxt_wakeup
))

2991 
Ãxt_wakeup
 = 
–r
->
Ì_Ãxt_sched
;

2993 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

2995 
	`Œy_to_ä“ze
();

2997 
cur
 = 
jiff›s
;

2998 ià((
	`time_aá”_eq
(
cur
, 
Ãxt_wakeup
)) ||

2999 (
MAX_JIFFY_OFFSET
 =ğ
Ãxt_wakeup
)) {

3000 
	`cÚd_»sched
();

3004 
	`scheduË_timeout_š‹¼u±ibË
(
Ãxt_wakeup
 - 
cur
);

3006 ià(
	`kth»ad_should_¡İ
()) {

3007 
	`ext4_ş—r_»que¡_li¡
();

3008 
ex™_th»ad
;

3012 
ex™_th»ad
:

3021 
	`mu‹x_lock
(&
ext4_li_mtx
);

3022 
	`mu‹x_lock
(&
–i
->
li_li¡_mtx
);

3023 ià(!
	`li¡_em±y
(&
–i
->
li_»que¡_li¡
)) {

3024 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

3025 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

3026 
cÚt_th»ad
;

3028 
	`mu‹x_uÆock
(&
–i
->
li_li¡_mtx
);

3029 
	`kä“
(
ext4_li_šfo
);

3030 
ext4_li_šfo
 = 
NULL
;

3031 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

3034 
	}
}

3036 
	$ext4_ş—r_»que¡_li¡
()

3038 
li¡_h—d
 *
pos
, *
n
;

3039 
ext4_li_»que¡
 *
–r
;

3041 
	`mu‹x_lock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3042 
	`li¡_fÜ_—ch_§ã
(
pos
, 
n
, &
ext4_li_šfo
->
li_»que¡_li¡
) {

3043 
–r
 = 
	`li¡_’Œy
(
pos
, 
ext4_li_»que¡
,

3044 
Ì_»que¡
);

3045 
	`ext4_»move_li_»que¡
(
–r
);

3047 
	`mu‹x_uÆock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3048 
	}
}

3050 
	$ext4_run_Ïzyš™_th»ad
()

3052 
ext4_Ïzyš™_sk
 = 
	`kth»ad_run
(
ext4_Ïzyš™_th»ad
,

3053 
ext4_li_šfo
, "ext4lazyinit");

3054 ià(
	`IS_ERR
(
ext4_Ïzyš™_sk
)) {

3055 
”r
 = 
	`PTR_ERR
(
ext4_Ïzyš™_sk
);

3056 
	`ext4_ş—r_»que¡_li¡
();

3057 
	`kä“
(
ext4_li_šfo
);

3058 
ext4_li_šfo
 = 
NULL
;

3059 
	`´štk
(
KERN_CRIT
 "EXT4-fs:ƒrror %d creating inodeable "

3061 
”r
);

3062  
”r
;

3064 
ext4_li_šfo
->
li_¡©e
 |ğ
EXT4_LAZYINIT_RUNNING
;

3066 
	}
}

3074 
ext4_group_t
 
	$ext4_has_unš™_™abË
(
su³r_block
 *
sb
)

3076 
ext4_group_t
 
group
, 
ngroups
 = 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;

3077 
ext4_group_desc
 *
gdp
 = 
NULL
;

3079 
group
 = 0; grou°< 
ngroups
; group++) {

3080 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
group
, 
NULL
);

3081 ià(!
gdp
)

3084 ià(!(
gdp
->
bg_æags
 & 
	`ıu_to_Ë16
(
EXT4_BG_INODE_ZEROED
)))

3088  
group
;

3089 
	}
}

3091 
	$ext4_li_šfo_Ãw
()

3093 
ext4_Ïzy_š™
 *
–i
 = 
NULL
;

3095 
–i
 = 
	`kz®loc
((*–i), 
GFP_KERNEL
);

3096 ià(!
–i
)

3097  -
ENOMEM
;

3099 
	`INIT_LIST_HEAD
(&
–i
->
li_»que¡_li¡
);

3100 
	`mu‹x_š™
(&
–i
->
li_li¡_mtx
);

3102 
–i
->
li_¡©e
 |ğ
EXT4_LAZYINIT_QUIT
;

3104 
ext4_li_šfo
 = 
–i
;

3107 
	}
}

3109 
ext4_li_»que¡
 *
	$ext4_li_»que¡_Ãw
(
su³r_block
 *
sb
,

3110 
ext4_group_t
 
¡¬t
)

3112 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3113 
ext4_li_»que¡
 *
–r
;

3115 
–r
 = 
	`kz®loc
((*–r), 
GFP_KERNEL
);

3116 ià(!
–r
)

3117  
NULL
;

3119 
–r
->
Ì_su³r
 = 
sb
;

3120 
–r
->
Ì_sbi
 = 
sbi
;

3121 
–r
->
Ì_Ãxt_group
 = 
¡¬t
;

3128 
–r
->
Ì_Ãxt_sched
 = 
jiff›s
 + (
	`´ªdom_u32
() %

3129 (
EXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3130  
–r
;

3131 
	}
}

3133 
	$ext4_»gi¡”_li_»que¡
(
su³r_block
 *
sb
,

3134 
ext4_group_t
 
fœ¡_nÙ_z”Ûd
)

3136 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3137 
ext4_li_»que¡
 *
–r
 = 
NULL
;

3138 
ext4_group_t
 
ngroups
 = 
	`EXT4_SB
(
sb
)->
s_groups_couÁ
;

3139 
»t
 = 0;

3141 
	`mu‹x_lock
(&
ext4_li_mtx
);

3142 ià(
sbi
->
s_li_»que¡
 !ğ
NULL
) {

3147 
sbi
->
s_li_»que¡
->
Ì_timeout
 = 0;

3148 
out
;

3151 ià(
fœ¡_nÙ_z”Ûd
 =ğ
ngroups
 ||

3152 (
sb
->
s_æags
 & 
MS_RDONLY
) ||

3153 !
	`‹¡_İt
(
sb
, 
INIT_INODE_TABLE
))

3154 
out
;

3156 
–r
 = 
	`ext4_li_»que¡_Ãw
(
sb
, 
fœ¡_nÙ_z”Ûd
);

3157 ià(!
–r
) {

3158 
»t
 = -
ENOMEM
;

3159 
out
;

3162 ià(
NULL
 =ğ
ext4_li_šfo
) {

3163 
»t
 = 
	`ext4_li_šfo_Ãw
();

3164 ià(
»t
)

3165 
out
;

3168 
	`mu‹x_lock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3169 
	`li¡_add
(&
–r
->
Ì_»que¡
, &
ext4_li_šfo
->
li_»que¡_li¡
);

3170 
	`mu‹x_uÆock
(&
ext4_li_šfo
->
li_li¡_mtx
);

3172 
sbi
->
s_li_»que¡
 = 
–r
;

3178 
–r
 = 
NULL
;

3180 ià(!(
ext4_li_šfo
->
li_¡©e
 & 
EXT4_LAZYINIT_RUNNING
)) {

3181 
»t
 = 
	`ext4_run_Ïzyš™_th»ad
();

3182 ià(
»t
)

3183 
out
;

3185 
out
:

3186 
	`mu‹x_uÆock
(&
ext4_li_mtx
);

3187 ià(
»t
)

3188 
	`kä“
(
–r
);

3189  
»t
;

3190 
	}
}

3196 
	$ext4_de¡roy_Ïzyš™_th»ad
()

3202 ià(!
ext4_li_šfo
 || !
ext4_Ïzyš™_sk
)

3205 
	`kth»ad_¡İ
(
ext4_Ïzyš™_sk
);

3206 
	}
}

3208 
	$£t_jouº®_csum_ã©u»_£t
(
su³r_block
 *
sb
)

3210 
»t
 = 1;

3211 
com·t
, 
šcom·t
;

3212 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3214 ià(
	`ext4_has_m‘ad©a_csum
(
sb
)) {

3216 
com·t
 = 0;

3217 
šcom·t
 = 
JBD2_FEATURE_INCOMPAT_CSUM_V3
;

3220 
com·t
 = 
JBD2_FEATURE_COMPAT_CHECKSUM
;

3221 
šcom·t
 = 0;

3224 
	`jbd2_jouº®_ş—r_ã©u»s
(
sbi
->
s_jouº®
,

3225 
JBD2_FEATURE_COMPAT_CHECKSUM
, 0,

3226 
JBD2_FEATURE_INCOMPAT_CSUM_V3
 |

3227 
JBD2_FEATURE_INCOMPAT_CSUM_V2
);

3228 ià(
	`‹¡_İt
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

3229 
»t
 = 
	`jbd2_jouº®_£t_ã©u»s
(
sbi
->
s_jouº®
,

3230 
com·t
, 0,

3231 
JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT
 |

3232 
šcom·t
);

3233 } ià(
	`‹¡_İt
(
sb
, 
JOURNAL_CHECKSUM
)) {

3234 
»t
 = 
	`jbd2_jouº®_£t_ã©u»s
(
sbi
->
s_jouº®
,

3235 
com·t
, 0,

3236 
šcom·t
);

3237 
	`jbd2_jouº®_ş—r_ã©u»s
(
sbi
->
s_jouº®
, 0, 0,

3238 
JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3240 
	`jbd2_jouº®_ş—r_ã©u»s
(
sbi
->
s_jouº®
, 0, 0,

3241 
JBD2_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3244  
»t
;

3245 
	}
}

3262 
	$couÁ_ov”h—d
(
su³r_block
 *
sb
, 
ext4_group_t
 
g½
,

3263 *
buf
)

3265 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3266 
ext4_group_desc
 *
gdp
;

3267 
ext4_fsblk_t
 
fœ¡_block
, 
Ï¡_block
, 
b
;

3268 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

3269 
s
, 
j
, 
couÁ
 = 0;

3271 ià(!
	`ext4_has_ã©u»_big®loc
(
sb
))

3272  (
	`ext4_bg_has_su³r
(
sb
, 
g½
è+ 
	`ext4_bg_num_gdb
(sb, grp) +

3273 
sbi
->
s_™b_³r_group
 + 2);

3275 
fœ¡_block
 = 
	`Ë32_to_ıu
(
sbi
->
s_es
->
s_fœ¡_d©a_block
) +

3276 (
g½
 * 
	`EXT4_BLOCKS_PER_GROUP
(
sb
));

3277 
Ï¡_block
 = 
fœ¡_block
 + 
	`EXT4_BLOCKS_PER_GROUP
(
sb
) - 1;

3278 
i
 = 0; i < 
ngroups
; i++) {

3279 
gdp
 = 
	`ext4_g‘_group_desc
(
sb
, 
i
, 
NULL
);

3280 
b
 = 
	`ext4_block_b™m­
(
sb
, 
gdp
);

3281 ià(
b
 >ğ
fœ¡_block
 && b <ğ
Ï¡_block
) {

3282 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
b
 - 
fœ¡_block
), 
buf
);

3283 
couÁ
++;

3285 
b
 = 
	`ext4_šode_b™m­
(
sb
, 
gdp
);

3286 ià(
b
 >ğ
fœ¡_block
 && b <ğ
Ï¡_block
) {

3287 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
b
 - 
fœ¡_block
), 
buf
);

3288 
couÁ
++;

3290 
b
 = 
	`ext4_šode_bË
(
sb
, 
gdp
);

3291 ià(
b
 >ğ
fœ¡_block
 && b + 
sbi
->
s_™b_³r_group
 <ğ
Ï¡_block
)

3292 
j
 = 0; j < 
sbi
->
s_™b_³r_group
; j++, 
b
++) {

3293 
c
 = 
	`EXT4_B2C
(
sbi
, 
b
 - 
fœ¡_block
);

3294 
	`ext4_£t_b™
(
c
, 
buf
);

3295 
couÁ
++;

3297 ià(
i
 !ğ
g½
)

3299 
s
 = 0;

3300 ià(
	`ext4_bg_has_su³r
(
sb
, 
g½
)) {

3301 
	`ext4_£t_b™
(
s
++, 
buf
);

3302 
couÁ
++;

3304 
j
 = 
	`ext4_bg_num_gdb
(
sb
, 
g½
);

3305 ià(
s
 + 
j
 > 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)) {

3306 
	`ext4_”rÜ
(
sb
, "Invalid‚umber of block group "

3307 "desütÜ blocks: %d", 
j
);

3308 
j
 = 
	`EXT4_BLOCKS_PER_GROUP
(
sb
è- 
s
;

3310 
couÁ
 +ğ
j
;

3311 ; 
j
 > 0; j--)

3312 
	`ext4_£t_b™
(
	`EXT4_B2C
(
sbi
, 
s
++), 
buf
);

3314 ià(!
couÁ
)

3316  
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) -

3317 
	`ext4_couÁ_ä“
(
buf
, 
	`EXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

3318 
	}
}

3323 
	$ext4_ÿlcuÏ‹_ov”h—d
(
su³r_block
 *
sb
)

3325 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3326 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

3327 
šode
 *
j_šode
;

3328 
j_blocks
, 
j_šum
 = 
	`Ë32_to_ıu
(
es
->
s_jouº®_šum
);

3329 
ext4_group_t
 
i
, 
ngroups
 = 
	`ext4_g‘_groups_couÁ
(
sb
);

3330 
ext4_fsblk_t
 
ov”h—d
 = 0;

3331 *
buf
 = (*è
	`g‘_z”Ûd_·ge
(
GFP_NOFS
);

3333 ià(!
buf
)

3334  -
ENOMEM
;

3345 
ov”h—d
 = 
	`EXT4_B2C
(
sbi
, 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
));

3350 
i
 = 0; i < 
ngroups
; i++) {

3351 
blks
;

3353 
blks
 = 
	`couÁ_ov”h—d
(
sb
, 
i
, 
buf
);

3354 
ov”h—d
 +ğ
blks
;

3355 ià(
blks
)

3356 
	`mem£t
(
buf
, 0, 
PAGE_SIZE
);

3357 
	`cÚd_»sched
();

3364 ià(
sbi
->
s_jouº®
 && !sbi->
jouº®_bdev
)

3365 
ov”h—d
 +ğ
	`EXT4_NUM_B2C
(
sbi
, sbi->
s_jouº®
->
j_maxËn
);

3366 ià(
	`ext4_has_ã©u»_jouº®
(
sb
è&& !
sbi
->
s_jouº®
) {

3367 
j_šode
 = 
	`ext4_g‘_jouº®_šode
(
sb
, 
j_šum
);

3368 ià(
j_šode
) {

3369 
j_blocks
 = 
j_šode
->
i_size
 >> 
sb
->
s_blocksize_b™s
;

3370 
ov”h—d
 +ğ
	`EXT4_NUM_B2C
(
sbi
, 
j_blocks
);

3371 
	`ut
(
j_šode
);

3373 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't get journal size");

3376 
sbi
->
s_ov”h—d
 = 
ov”h—d
;

3377 
	`smp_wmb
();

3378 
	`ä“_·ge
((è
buf
);

3380 
	}
}

3382 
	$ext4_£t_»sv_şu¡”s
(
su³r_block
 *
sb
)

3384 
ext4_fsblk_t
 
»sv_şu¡”s
;

3385 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

3393 ià(!
	`ext4_has_ã©u»_ex‹Ás
(
sb
))

3403 
»sv_şu¡”s
 = (
	`ext4_blocks_couÁ
(
sbi
->
s_es
) >>

3404 
sbi
->
s_şu¡”_b™s
);

3406 
	`do_div
(
»sv_şu¡”s
, 50);

3407 
»sv_şu¡”s
 = 
	`mš_t
(
ext4_fsblk_t
,„esv_clusters, 4096);

3409 
	`©omic64_£t
(&
sbi
->
s_»sv_şu¡”s
, 
»sv_şu¡”s
);

3410 
	}
}

3412 
	$ext4_fl_su³r
(
su³r_block
 *
sb
, *
d©a
, 
s’t
)

3414 *
Üig_d©a
 = 
	`k¡rdup
(
d©a
, 
GFP_KERNEL
);

3415 
bufãr_h—d
 *
bh
;

3416 
ext4_su³r_block
 *
es
 = 
NULL
;

3417 
ext4_sb_šfo
 *
sbi
 = 
	`kz®loc
((*sbi), 
GFP_KERNEL
);

3418 
ext4_fsblk_t
 
block
;

3419 
ext4_fsblk_t
 
sb_block
 = 
	`g‘_sb_block
(&
d©a
);

3420 
ext4_fsblk_t
 
logiÿl_sb_block
;

3421 
off£t
 = 0;

3422 
jouº®_devnum
 = 0;

3423 
def_mouÁ_İts
;

3424 
šode
 *
roÙ
;

3425 cÚ¡ *
desü
;

3426 
»t
 = -
ENOMEM
;

3427 
blocksize
, 
şu¡”size
;

3428 
db_couÁ
;

3429 
i
;

3430 
Ãeds_»cov”y
, 
has_huge_fes
, 
has_big®loc
;

3431 
__u64
 
blocks_couÁ
;

3432 
”r
 = 0;

3433 
jouº®_iİrio
 = 
DEFAULT_JOURNAL_IOPRIO
;

3434 
ext4_group_t
 
fœ¡_nÙ_z”Ûd
;

3436 ià((
d©a
 && !
Üig_d©a
è|| !
sbi
)

3437 
out_ä“_ba£
;

3439 
sbi
->
s_blockgroup_lock
 =

3440 
	`kz®loc
((
blockgroup_lock
), 
GFP_KERNEL
);

3441 ià(!
sbi
->
s_blockgroup_lock
)

3442 
out_ä“_ba£
;

3444 
sb
->
s_fs_šfo
 = 
sbi
;

3445 
sbi
->
s_sb
 = 
sb
;

3446 
sbi
->
s_šode_»adah—d_blks
 = 
EXT4_DEF_INODE_READAHEAD_BLKS
;

3447 
sbi
->
s_sb_block
 = 
sb_block
;

3448 ià(
sb
->
s_bdev
->
bd_·¹
)

3449 
sbi
->
s_£ùÜs_wr™‹n_¡¬t
 =

3450 
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
, 
£ùÜs
[1]);

3453 
	`¡¼•Ïû
(
sb
->
s_id
, '/', '!');

3456 
»t
 = -
EINVAL
;

3457 
blocksize
 = 
	`sb_mš_blocksize
(
sb
, 
EXT4_MIN_BLOCK_SIZE
);

3458 ià(!
blocksize
) {

3459 
	`ext4_msg
(
sb
, 
KERN_ERR
, "unableo set blocksize");

3460 
out_ç
;

3467 ià(
blocksize
 !ğ
EXT4_MIN_BLOCK_SIZE
) {

3468 
logiÿl_sb_block
 = 
sb_block
 * 
EXT4_MIN_BLOCK_SIZE
;

3469 
off£t
 = 
	`do_div
(
logiÿl_sb_block
, 
blocksize
);

3471 
logiÿl_sb_block
 = 
sb_block
;

3474 ià(!(
bh
 = 
	`sb_b»ad_unmovabË
(
sb
, 
logiÿl_sb_block
))) {

3475 
	`ext4_msg
(
sb
, 
KERN_ERR
, "unableo„ead superblock");

3476 
out_ç
;

3482 
es
 = (
ext4_su³r_block
 *è(
bh
->
b_d©a
 + 
off£t
);

3483 
sbi
->
s_es
 = 
es
;

3484 
sb
->
s_magic
 = 
	`Ë16_to_ıu
(
es
->s_magic);

3485 ià(
sb
->
s_magic
 !ğ
EXT4_SUPER_MAGIC
)

3486 
ÿÁfšd_ext4
;

3487 
sbi
->
s_kby‹s_wr™‹n
 = 
	`Ë64_to_ıu
(
es
->s_kbytes_written);

3490 ià(
	`ext4_has_ã©u»_m‘ad©a_csum
(
sb
) &&

3491 
	`ext4_has_ã©u»_gdt_csum
(
sb
))

3492 
	`ext4_w¬nšg
(
sb
, "metadata_csum‡nd uninit_bg‡re "

3496 ià(!
	`ext4_v”ify_csum_ty³
(
sb
, 
es
)) {

3497 
	`ext4_msg
(
sb
, 
KERN_ERR
, "VFS: Foundƒxt4 filesystem with "

3499 
s’t
 = 1;

3500 
ÿÁfšd_ext4
;

3504 ià(
	`ext4_has_ã©u»_m‘ad©a_csum
(
sb
) ||

3505 
	`ext4_has_ã©u»_—_šode
(
sb
)) {

3506 
sbi
->
s_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

3507 ià(
	`IS_ERR
(
sbi
->
s_chksum_driv”
)) {

3508 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Cannot†oad crc32c driver.");

3509 
»t
 = 
	`PTR_ERR
(
sbi
->
s_chksum_driv”
);

3510 
sbi
->
s_chksum_driv”
 = 
NULL
;

3511 
çed_mouÁ
;

3516 ià(!
	`ext4_su³rblock_csum_v”ify
(
sb
, 
es
)) {

3517 
	`ext4_msg
(
sb
, 
KERN_ERR
, "VFS: Foundƒxt4 filesystem with "

3519 
s’t
 = 1;

3520 
»t
 = -
EFSBADCRC
;

3521 
ÿÁfšd_ext4
;

3525 ià(
	`ext4_has_ã©u»_csum_£ed
(
sb
))

3526 
sbi
->
s_csum_£ed
 = 
	`Ë32_to_ıu
(
es
->
s_checksum_£ed
);

3527 ià(
	`ext4_has_m‘ad©a_csum
(
sb
è|| 
	`ext4_has_ã©u»_—_šode
(sb))

3528 
sbi
->
s_csum_£ed
 = 
	`ext4_chksum
(sbi, ~0, 
es
->
s_uuid
,

3529 (
es
->
s_uuid
));

3532 
def_mouÁ_İts
 = 
	`Ë32_to_ıu
(
es
->
s_deçuÉ_mouÁ_İts
);

3533 
	`£t_İt
(
sb
, 
INIT_INODE_TABLE
);

3534 ià(
def_mouÁ_İts
 & 
EXT4_DEFM_DEBUG
)

3535 
	`£t_İt
(
sb
, 
DEBUG
);

3536 ià(
def_mouÁ_İts
 & 
EXT4_DEFM_BSDGROUPS
)

3537 
	`£t_İt
(
sb
, 
GRPID
);

3538 ià(
def_mouÁ_İts
 & 
EXT4_DEFM_UID16
)

3539 
	`£t_İt
(
sb
, 
NO_UID32
);

3541 
	`£t_İt
(
sb
, 
XATTR_USER
);

3542 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


3543 
	`£t_İt
(
sb
, 
POSIX_ACL
);

3545 ià(
	`ext4_has_ã©u»_ç¡_comm™
(
sb
))

3546 
	`£t_İt2
(
sb
, 
JOURNAL_FAST_COMMIT
);

3549 ià(
	`ext4_has_m‘ad©a_csum
(
sb
))

3550 
	`£t_İt
(
sb
, 
JOURNAL_CHECKSUM
);

3552 ià((
def_mouÁ_İts
 & 
EXT4_DEFM_JMODE
è=ğ
EXT4_DEFM_JMODE_DATA
)

3553 
	`£t_İt
(
sb
, 
JOURNAL_DATA
);

3554 ià((
def_mouÁ_İts
 & 
EXT4_DEFM_JMODE
è=ğ
EXT4_DEFM_JMODE_ORDERED
)

3555 
	`£t_İt
(
sb
, 
ORDERED_DATA
);

3556 ià((
def_mouÁ_İts
 & 
EXT4_DEFM_JMODE
è=ğ
EXT4_DEFM_JMODE_WBACK
)

3557 
	`£t_İt
(
sb
, 
WRITEBACK_DATA
);

3559 ià(
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_”rÜs
è=ğ
EXT4_ERRORS_PANIC
)

3560 
	`£t_İt
(
sb
, 
ERRORS_PANIC
);

3561 ià(
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_”rÜs
è=ğ
EXT4_ERRORS_CONTINUE
)

3562 
	`£t_İt
(
sb
, 
ERRORS_CONT
);

3564 
	`£t_İt
(
sb
, 
ERRORS_RO
);

3566 
	`£t_İt
(
sb
, 
BLOCK_VALIDITY
);

3567 ià(
def_mouÁ_İts
 & 
EXT4_DEFM_DISCARD
)

3568 
	`£t_İt
(
sb
, 
DISCARD
);

3570 
sbi
->
s_»suid
 = 
	`make_kuid
(&
š™_u£r_ns
, 
	`Ë16_to_ıu
(
es
->
s_def_»suid
));

3571 
sbi
->
s_»sgid
 = 
	`make_kgid
(&
š™_u£r_ns
, 
	`Ë16_to_ıu
(
es
->
s_def_»sgid
));

3572 
sbi
->
s_comm™_š‹rv®
 = 
JBD2_DEFAULT_MAX_COMMIT_AGE
 * 
HZ
;

3573 
sbi
->
s_mš_b©ch_time
 = 
EXT4_DEF_MIN_BATCH_TIME
;

3574 
sbi
->
s_max_b©ch_time
 = 
EXT4_DEF_MAX_BATCH_TIME
;

3576 ià((
def_mouÁ_İts
 & 
EXT4_DEFM_NOBARRIER
) == 0)

3577 
	`£t_İt
(
sb
, 
BARRIER
);

3583 ià(!
	`IS_EXT3_SB
(
sb
è&& !
	`IS_EXT2_SB
(sb) &&

3584 ((
def_mouÁ_İts
 & 
EXT4_DEFM_NODELALLOC
) == 0))

3585 
	`£t_İt
(
sb
, 
DELALLOC
);

3591 
sbi
->
s_li_wa™_muÉ
 = 
EXT4_DEF_LI_WAIT_MULT
;

3593 ià(
sbi
->
s_es
->
s_mouÁ_İts
[0]) {

3594 *
s_mouÁ_İts
 = 
	`k¡ºdup
(
sbi
->
s_es
->s_mount_opts,

3595 (
sbi
->
s_es
->
s_mouÁ_İts
),

3596 
GFP_KERNEL
);

3597 ià(!
s_mouÁ_İts
)

3598 
çed_mouÁ
;

3599 ià(!
	`·r£_İtiÚs
(
s_mouÁ_İts
, 
sb
, &
jouº®_devnum
,

3600 &
jouº®_iİrio
, 0)) {

3601 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

3603 
s_mouÁ_İts
);

3605 
	`kä“
(
s_mouÁ_İts
);

3607 
sbi
->
s_def_mouÁ_İt
 = sbi->
s_mouÁ_İt
;

3608 ià(!
	`·r£_İtiÚs
((*è
d©a
, 
sb
, &
jouº®_devnum
,

3609 &
jouº®_iİrio
, 0))

3610 
çed_mouÁ
;

3612 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
) {

3613 
	`´štk_Úû
(
KERN_WARNING
 "EXT4-fs: Warning: mounting "

3616 ià(
	`‹¡_İt2
(
sb
, 
EXPLICIT_DELALLOC
)) {

3617 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3619 
çed_mouÁ
;

3621 ià(
	`‹¡_İt
(
sb
, 
DIOREAD_NOLOCK
)) {

3622 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3624 
çed_mouÁ
;

3626 ià(
	`‹¡_İt
(
sb
, 
DAX
)) {

3627 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3629 
çed_mouÁ
;

3631 ià(
	`ext4_has_ã©u»_’üy±
(
sb
)) {

3632 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

3636 ià(
	`‹¡_İt
(
sb
, 
DELALLOC
))

3637 
	`ş—r_İt
(
sb
, 
DELALLOC
);

3639 
sb
->
s_iæags
 |ğ
SB_I_CGROUPWB
;

3642 
sb
->
s_æags
 = (sb->s_æag & ~
MS_POSIXACL
) |

3643 (
	`‹¡_İt
(
sb
, 
POSIX_ACL
è? 
MS_POSIXACL
 : 0);

3645 ià(
	`Ë32_to_ıu
(
es
->
s_»v_Ëv–
è=ğ
EXT4_GOOD_OLD_REV
 &&

3646 (
	`ext4_has_com·t_ã©u»s
(
sb
) ||

3647 
	`ext4_has_ro_com·t_ã©u»s
(
sb
) ||

3648 
	`ext4_has_šcom·t_ã©u»s
(
sb
)))

3649 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

3653 ià(
es
->
s_ü—tÜ_os
 =ğ
	`ıu_to_Ë32
(
EXT4_OS_HURD
)) {

3654 
	`£t_İt2
(
sb
, 
HURD_COMPAT
);

3655 ià(
	`ext4_has_ã©u»_64b™
(
sb
)) {

3656 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3658 
çed_mouÁ
;

3665 ià(
	`ext4_has_ã©u»_—_šode
(
sb
)) {

3666 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3668 
çed_mouÁ
;

3672 ià(
	`IS_EXT2_SB
(
sb
)) {

3673 ià(
	`ext2_ã©u»_£t_ok
(
sb
))

3674 
	`ext4_msg
(
sb
, 
KERN_INFO
, "mountingƒxt2 file system "

3677 
	`ext4_msg
(
sb
, 
KERN_ERR
, "couldn't mount‡sƒxt2 due "

3679 
çed_mouÁ
;

3683 ià(
	`IS_EXT3_SB
(
sb
)) {

3684 ià(
	`ext3_ã©u»_£t_ok
(
sb
))

3685 
	`ext4_msg
(
sb
, 
KERN_INFO
, "mountingƒxt3 file system "

3688 
	`ext4_msg
(
sb
, 
KERN_ERR
, "couldn't mount‡sƒxt3 due "

3690 
çed_mouÁ
;

3699 ià(!
	`ext4_ã©u»_£t_ok
(
sb
, (sb->
s_æags
 & 
MS_RDONLY
)))

3700 
çed_mouÁ
;

3702 
blocksize
 = 
BLOCK_SIZE
 << 
	`Ë32_to_ıu
(
es
->
s_log_block_size
);

3703 ià(
blocksize
 < 
EXT4_MIN_BLOCK_SIZE
 ||

3704 
blocksize
 > 
EXT4_MAX_BLOCK_SIZE
) {

3705 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3707 
blocksize
, 
	`Ë32_to_ıu
(
es
->
s_log_block_size
));

3708 
çed_mouÁ
;

3710 ià(
	`Ë32_to_ıu
(
es
->
s_log_block_size
) >

3711 (
EXT4_MAX_BLOCK_LOG_SIZE
 - 
EXT4_MIN_BLOCK_LOG_SIZE
)) {

3712 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3714 
	`Ë32_to_ıu
(
es
->
s_log_block_size
));

3715 
çed_mouÁ
;

3718 ià(
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_»£rved_gdt_blocks
è> (
blocksize
 / 4)) {

3719 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3721 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_»£rved_gdt_blocks
));

3722 
çed_mouÁ
;

3725 ià(
sbi
->
s_mouÁ_İt
 & 
EXT4_MOUNT_DAX
) {

3726 
”r
 = 
	`bdev_dax_suµÜ‹d
(
sb
, 
blocksize
);

3727 ià(
”r
)

3728 
çed_mouÁ
;

3731 ià(
	`ext4_has_ã©u»_’üy±
(
sb
è&& 
es
->
s_’üy±iÚ_Ëv–
) {

3732 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Unsupportedƒncryption†evel %d",

3733 
es
->
s_’üy±iÚ_Ëv–
);

3734 
çed_mouÁ
;

3737 ià(
sb
->
s_blocksize
 !ğ
blocksize
) {

3739 ià(!
	`sb_£t_blocksize
(
sb
, 
blocksize
)) {

3740 
	`ext4_msg
(
sb
, 
KERN_ERR
, "bad block size %d",

3741 
blocksize
);

3742 
çed_mouÁ
;

3745 
	`b»l£
(
bh
);

3746 
logiÿl_sb_block
 = 
sb_block
 * 
EXT4_MIN_BLOCK_SIZE
;

3747 
off£t
 = 
	`do_div
(
logiÿl_sb_block
, 
blocksize
);

3748 
bh
 = 
	`sb_b»ad_unmovabË
(
sb
, 
logiÿl_sb_block
);

3749 ià(!
bh
) {

3750 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3752 
çed_mouÁ
;

3754 
es
 = (
ext4_su³r_block
 *)(
bh
->
b_d©a
 + 
off£t
);

3755 
sbi
->
s_es
 = 
es
;

3756 ià(
es
->
s_magic
 !ğ
	`ıu_to_Ë16
(
EXT4_SUPER_MAGIC
)) {

3757 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3759 
çed_mouÁ
;

3763 
has_huge_fes
 = 
	`ext4_has_ã©u»_huge_fe
(
sb
);

3764 
sbi
->
s_b™m­_maxby‹s
 = 
	`ext4_max_b™m­_size
(
sb
->
s_blocksize_b™s
,

3765 
has_huge_fes
);

3766 
sb
->
s_maxby‹s
 = 
	`ext4_max_size
(sb->
s_blocksize_b™s
, 
has_huge_fes
);

3768 ià(
	`Ë32_to_ıu
(
es
->
s_»v_Ëv–
è=ğ
EXT4_GOOD_OLD_REV
) {

3769 
sbi
->
s_šode_size
 = 
EXT4_GOOD_OLD_INODE_SIZE
;

3770 
sbi
->
s_fœ¡_šo
 = 
EXT4_GOOD_OLD_FIRST_INO
;

3772 
sbi
->
s_šode_size
 = 
	`Ë16_to_ıu
(
es
->s_inode_size);

3773 
sbi
->
s_fœ¡_šo
 = 
	`Ë32_to_ıu
(
es
->s_first_ino);

3774 ià((
sbi
->
s_šode_size
 < 
EXT4_GOOD_OLD_INODE_SIZE
) ||

3775 (!
	`is_pow”_of_2
(
sbi
->
s_šode_size
)) ||

3776 (
sbi
->
s_šode_size
 > 
blocksize
)) {

3777 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3779 
sbi
->
s_šode_size
);

3780 
çed_mouÁ
;

3782 ià(
sbi
->
s_šode_size
 > 
EXT4_GOOD_OLD_INODE_SIZE
)

3783 
sb
->
s_time_g¿n
 = 1 << (
EXT4_EPOCH_BITS
 - 2);

3786 
sbi
->
s_desc_size
 = 
	`Ë16_to_ıu
(
es
->s_desc_size);

3787 ià(
	`ext4_has_ã©u»_64b™
(
sb
)) {

3788 ià(
sbi
->
s_desc_size
 < 
EXT4_MIN_DESC_SIZE_64BIT
 ||

3789 
sbi
->
s_desc_size
 > 
EXT4_MAX_DESC_SIZE
 ||

3790 !
	`is_pow”_of_2
(
sbi
->
s_desc_size
)) {

3791 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3793 
sbi
->
s_desc_size
);

3794 
çed_mouÁ
;

3797 
sbi
->
s_desc_size
 = 
EXT4_MIN_DESC_SIZE
;

3799 
sbi
->
s_blocks_³r_group
 = 
	`Ë32_to_ıu
(
es
->s_blocks_per_group);

3800 
sbi
->
s_šodes_³r_group
 = 
	`Ë32_to_ıu
(
es
->s_inodes_per_group);

3802 
sbi
->
s_šodes_³r_block
 = 
blocksize
 / 
	`EXT4_INODE_SIZE
(
sb
);

3803 ià(
sbi
->
s_šodes_³r_block
 == 0)

3804 
ÿÁfšd_ext4
;

3805 ià(
sbi
->
s_šodes_³r_group
 < sbi->
s_šodes_³r_block
 ||

3806 
sbi
->
s_šodes_³r_group
 > 
blocksize
 * 8) {

3807 
	`ext4_msg
(
sb
, 
KERN_ERR
, "invalid inodes…er group: %lu\n",

3808 
sbi
->
s_blocks_³r_group
);

3809 
çed_mouÁ
;

3811 
sbi
->
s_™b_³r_group
 = sbi->
s_šodes_³r_group
 /

3812 
sbi
->
s_šodes_³r_block
;

3813 
sbi
->
s_desc_³r_block
 = 
blocksize
 / 
	`EXT4_DESC_SIZE
(
sb
);

3814 
sbi
->
s_sbh
 = 
bh
;

3815 
sbi
->
s_mouÁ_¡©e
 = 
	`Ë16_to_ıu
(
es
->
s_¡©e
);

3816 
sbi
->
s_addr_³r_block_b™s
 = 
	`og2
(
	`EXT4_ADDR_PER_BLOCK
(
sb
));

3817 
sbi
->
s_desc_³r_block_b™s
 = 
	`og2
(
	`EXT4_DESC_PER_BLOCK
(
sb
));

3819 
i
 = 0; i < 4; i++)

3820 
sbi
->
s_hash_£ed
[
i
] = 
	`Ë32_to_ıu
(
es
->s_hash_seed[i]);

3821 
sbi
->
s_def_hash_v”siÚ
 = 
es
->s_def_hash_version;

3822 ià(
	`ext4_has_ã©u»_dœ_šdex
(
sb
)) {

3823 
i
 = 
	`Ë32_to_ıu
(
es
->
s_æags
);

3824 ià(
i
 & 
EXT2_FLAGS_UNSIGNED_HASH
)

3825 
sbi
->
s_hash_unsigÃd
 = 3;

3826 ià((
i
 & 
EXT2_FLAGS_SIGNED_HASH
) == 0) {

3827 #ifdeà
__CHAR_UNSIGNED__


3828 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
))

3829 
es
->
s_æags
 |=

3830 
	`ıu_to_Ë32
(
EXT2_FLAGS_UNSIGNED_HASH
);

3831 
sbi
->
s_hash_unsigÃd
 = 3;

3833 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
))

3834 
es
->
s_æags
 |=

3835 
	`ıu_to_Ë32
(
EXT2_FLAGS_SIGNED_HASH
);

3841 
şu¡”size
 = 
BLOCK_SIZE
 << 
	`Ë32_to_ıu
(
es
->
s_log_şu¡”_size
);

3842 
has_big®loc
 = 
	`ext4_has_ã©u»_big®loc
(
sb
);

3843 ià(
has_big®loc
) {

3844 ià(
şu¡”size
 < 
blocksize
) {

3845 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3847 "block siz(%d)", 
şu¡”size
, 
blocksize
);

3848 
çed_mouÁ
;

3850 ià(
	`Ë32_to_ıu
(
es
->
s_log_şu¡”_size
) >

3851 (
EXT4_MAX_CLUSTER_LOG_SIZE
 - 
EXT4_MIN_BLOCK_LOG_SIZE
)) {

3852 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3854 
	`Ë32_to_ıu
(
es
->
s_log_şu¡”_size
));

3855 
çed_mouÁ
;

3857 
sbi
->
s_şu¡”_b™s
 = 
	`Ë32_to_ıu
(
es
->
s_log_şu¡”_size
) -

3858 
	`Ë32_to_ıu
(
es
->
s_log_block_size
);

3859 
sbi
->
s_şu¡”s_³r_group
 =

3860 
	`Ë32_to_ıu
(
es
->
s_şu¡”s_³r_group
);

3861 ià(
sbi
->
s_şu¡”s_³r_group
 > 
blocksize
 * 8) {

3862 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3864 
sbi
->
s_şu¡”s_³r_group
);

3865 
çed_mouÁ
;

3867 ià(
sbi
->
s_blocks_³r_group
 !=

3868 (
sbi
->
s_şu¡”s_³r_group
 * (
şu¡”size
 / 
blocksize
))) {

3869 
	`ext4_msg
(
sb
, 
KERN_ERR
, "blocks…er group (%lu)‡nd "

3871 
sbi
->
s_blocks_³r_group
,

3872 
sbi
->
s_şu¡”s_³r_group
);

3873 
çed_mouÁ
;

3876 ià(
şu¡”size
 !ğ
blocksize
) {

3877 
	`ext4_w¬nšg
(
sb
, "fragment/cluster size (%d) != "

3878 "block siz(%d)", 
şu¡”size
,

3879 
blocksize
);

3880 
şu¡”size
 = 
blocksize
;

3882 ià(
sbi
->
s_blocks_³r_group
 > 
blocksize
 * 8) {

3883 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3885 
sbi
->
s_blocks_³r_group
);

3886 
çed_mouÁ
;

3888 
sbi
->
s_şu¡”s_³r_group
 = sbi->
s_blocks_³r_group
;

3889 
sbi
->
s_şu¡”_b™s
 = 0;

3891 
sbi
->
s_şu¡”_¿tio
 = 
şu¡”size
 / 
blocksize
;

3894 ià(
sbi
->
s_blocks_³r_group
 =ğ
şu¡”size
 << 3)

3895 
	`£t_İt2
(
sb
, 
STD_GROUP_SIZE
);

3901 
”r
 = 
	`g’”ic_check_add»s§bË
(
sb
->
s_blocksize_b™s
,

3902 
	`ext4_blocks_couÁ
(
es
));

3903 ià(
”r
) {

3904 
	`ext4_msg
(
sb
, 
KERN_ERR
, "filesystem"

3906 ià((
£ùÜ_t
) < 8)

3907 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "CONFIG_LBDAF‚otƒnabled");

3908 
çed_mouÁ
;

3911 ià(
	`EXT4_BLOCKS_PER_GROUP
(
sb
) == 0)

3912 
ÿÁfšd_ext4
;

3915 
blocks_couÁ
 = 
sb
->
s_bdev
->
bd_šode
->
i_size
 >> sb->
s_blocksize_b™s
;

3916 ià(
blocks_couÁ
 && 
	`ext4_blocks_couÁ
(
es
) > blocks_count) {

3917 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: block count %llu "

3919 
	`ext4_blocks_couÁ
(
es
), 
blocks_couÁ
);

3920 
çed_mouÁ
;

3927 ià(
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
è>ğ
	`ext4_blocks_couÁ
(es)) {

3928 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

3930 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
),

3931 
	`ext4_blocks_couÁ
(
es
));

3932 
çed_mouÁ
;

3934 
blocks_couÁ
 = (
	`ext4_blocks_couÁ
(
es
) -

3935 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
) +

3936 
	`EXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

3937 
	`do_div
(
blocks_couÁ
, 
	`EXT4_BLOCKS_PER_GROUP
(
sb
));

3938 ià(
blocks_couÁ
 > ((
ušt64_t
)1<<32è- 
	`EXT4_DESC_PER_BLOCK
(
sb
)) {

3939 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "groups countoo†arge: %u "

3941 "block ³¸grou°%lu)", 
sbi
->
s_groups_couÁ
,

3942 
	`ext4_blocks_couÁ
(
es
),

3943 
	`Ë32_to_ıu
(
es
->
s_fœ¡_d©a_block
),

3944 
	`EXT4_BLOCKS_PER_GROUP
(
sb
));

3945 
çed_mouÁ
;

3947 
sbi
->
s_groups_couÁ
 = 
blocks_couÁ
;

3948 
sbi
->
s_blockfe_groups
 = 
	`mš_t
(
ext4_group_t
, sbi->
s_groups_couÁ
,

3949 (
EXT4_MAX_BLOCK_FILE_PHYS
 / 
	`EXT4_BLOCKS_PER_GROUP
(
sb
)));

3950 
db_couÁ
 = (
sbi
->
s_groups_couÁ
 + 
	`EXT4_DESC_PER_BLOCK
(
sb
) - 1) /

3951 
	`EXT4_DESC_PER_BLOCK
(
sb
);

3952 ià(
	`ext4_has_ã©u»_m‘a_bg
(
sb
)) {

3953 ià(
	`Ë32_to_ıu
(
es
->
s_fœ¡_m‘a_bg
è> 
db_couÁ
) {

3954 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

3957 
	`Ë32_to_ıu
(
es
->
s_fœ¡_m‘a_bg
), 
db_couÁ
);

3958 
çed_mouÁ
;

3961 
sbi
->
s_group_desc
 = 
	`kvm®loc
(
db_couÁ
 *

3962 (
bufãr_h—d
 *),

3963 
GFP_KERNEL
);

3964 ià(
sbi
->
s_group_desc
 =ğ
NULL
) {

3965 
	`ext4_msg
(
sb
, 
KERN_ERR
, "notƒnough memory");

3966 
»t
 = -
ENOMEM
;

3967 
çed_mouÁ
;

3970 
	`bgl_lock_š™
(
sbi
->
s_blockgroup_lock
);

3973 
i
 = 0; i < 
db_couÁ
; i++) {

3974 
block
 = 
	`desütÜ_loc
(
sb
, 
logiÿl_sb_block
, 
i
);

3975 
	`sb_b»adah—d
(
sb
, 
block
);

3978 
i
 = 0; i < 
db_couÁ
; i++) {

3979 
block
 = 
	`desütÜ_loc
(
sb
, 
logiÿl_sb_block
, 
i
);

3980 
sbi
->
s_group_desc
[
i
] = 
	`sb_b»ad_unmovabË
(
sb
, 
block
);

3981 ià(!
sbi
->
s_group_desc
[
i
]) {

3982 
	`ext4_msg
(
sb
, 
KERN_ERR
,

3983 "ÿn'ˆ»ad grou°desütÜ %d", 
i
);

3984 
db_couÁ
 = 
i
;

3985 
çed_mouÁ2
;

3988 ià(!
	`ext4_check_desütÜs
(
sb
, 
logiÿl_sb_block
, &
fœ¡_nÙ_z”Ûd
)) {

3989 
	`ext4_msg
(
sb
, 
KERN_ERR
, "group descriptors corrupted!");

3990 
»t
 = -
EFSCORRUPTED
;

3991 
çed_mouÁ2
;

3994 
sbi
->
s_gdb_couÁ
 = 
db_couÁ
;

3995 
	`g‘_¿ndom_by‹s
(&
sbi
->
s_Ãxt_g’”©iÚ
, (
u32
));

3996 
	`¥š_lock_š™
(&
sbi
->
s_Ãxt_g’_lock
);

3998 
	`£tup_tim”
(&
sbi
->
s_”r_»pÜt
, 
´št_day_”rÜ_šfo
,

3999 (è
sb
);

4002 ià(
	`ext4_es_»gi¡”_shršk”
(
sbi
))

4003 
çed_mouÁ3
;

4005 
sbi
->
s_¡re
 = 
	`ext4_g‘_¡re_size
(sbi);

4006 
sbi
->
s_ex‹Á_max_z”oout_kb
 = 32;

4011 
sb
->
s_İ
 = &
ext4_sİs
;

4012 
sb
->
s_expÜt_İ
 = &
ext4_expÜt_İs
;

4013 
sb
->
s_x©Œ
 = 
ext4_x©Œ_hªdËrs
;

4014 
sb
->
s_cİ
 = &
ext4_üy±İs
;

4015 #ifdeà
CONFIG_QUOTA


4016 
sb
->
dq_İ
 = &
ext4_quÙa_İ”©iÚs
;

4017 ià(
	`ext4_has_ã©u»_quÙa
(
sb
))

4018 
sb
->
s_qcİ
 = &
dquÙ_quÙaùl_sysfe_İs
;

4020 
sb
->
s_qcİ
 = &
ext4_qùl_İ”©iÚs
;

4021 
sb
->
s_quÙa_ty³s
 = 
QTYPE_MASK_USR
 | 
QTYPE_MASK_GRP
 | 
QTYPE_MASK_PRJ
;

4023 
	`memıy
(&
sb
->
s_uuid
, 
es
->s_uuid, (es->s_uuid));

4025 
	`INIT_LIST_HEAD
(&
sbi
->
s_Üphª
);

4026 
	`mu‹x_š™
(&
sbi
->
s_Üphª_lock
);

4028 
	`INIT_LIST_HEAD
(&
sbi
->
s_fc_q
);

4029 
	`INIT_LIST_HEAD
(&
sbi
->
s_fc_d’Œy_q
);

4030 
sbi
->
s_mouÁ_¡©e
 &ğ~
EXT4_FC_INELIGIBLE
;

4031 
	`¥š_lock_š™
(&
sbi
->
s_fc_lock
);

4032 
	`mem£t
(&
sbi
->
s_fc_¡©s
, 0, (sbi->s_fc_stats));

4034 
sb
->
s_roÙ
 = 
NULL
;

4036 
Ãeds_»cov”y
 = (
es
->
s_Ï¡_Üphª
 != 0 ||

4037 
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
));

4039 ià(
	`ext4_has_ã©u»_mmp
(
sb
è&& !(sb->
s_æags
 & 
MS_RDONLY
))

4040 ià(
	`ext4_muÉi_mouÁ_´Ùeù
(
sb
, 
	`Ë64_to_ıu
(
es
->
s_mmp_block
)))

4041 
çed_mouÁ3a
;

4047 ià(!
	`‹¡_İt
(
sb
, 
NOLOAD
è&& 
	`ext4_has_ã©u»_jouº®
(sb)) {

4048 
”r
 = 
	`ext4_lßd_jouº®
(
sb
, 
es
, 
jouº®_devnum
);

4049 ià(
”r
)

4050 
çed_mouÁ3a
;

4051 } ià(
	`‹¡_İt
(
sb
, 
NOLOAD
è&& !(sb->
s_æags
 & 
MS_RDONLY
) &&

4052 
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
)) {

4053 
	`ext4_msg
(
sb
, 
KERN_ERR
, "required journal„ecovery "

4055 
çed_mouÁ_wq
;

4058 ià(
	`‹¡_İt2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
)) {

4059 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4061 
çed_mouÁ_wq
;

4063 ià(
	`‹¡_İt
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4064 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4066 
çed_mouÁ_wq
;

4068 ià(
sbi
->
s_comm™_š‹rv®
 !ğ
JBD2_DEFAULT_MAX_COMMIT_AGE
*
HZ
) {

4069 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4071 
sbi
->
s_comm™_š‹rv®
 / 
HZ
);

4072 
çed_mouÁ_wq
;

4074 ià(
EXT4_MOUNT_DATA_FLAGS
 &

4075 (
sbi
->
s_mouÁ_İt
 ^ sbi->
s_def_mouÁ_İt
)) {

4076 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4078 
çed_mouÁ_wq
;

4080 
sbi
->
s_def_mouÁ_İt
 &ğ
EXT4_MOUNT_JOURNAL_CHECKSUM
;

4081 
	`ş—r_İt
(
sb
, 
JOURNAL_CHECKSUM
);

4082 
	`ş—r_İt
(
sb
, 
DATA_FLAGS
);

4083 
	`ş—r_İt2
(
sb
, 
JOURNAL_FAST_COMMIT
);

4084 
sbi
->
s_jouº®
 = 
NULL
;

4085 
Ãeds_»cov”y
 = 0;

4086 
no_jouº®
;

4089 ià(
	`ext4_has_ã©u»_64b™
(
sb
) &&

4090 !
	`jbd2_jouº®_£t_ã©u»s
(
	`EXT4_SB
(
sb
)->
s_jouº®
, 0, 0,

4091 
JBD2_FEATURE_INCOMPAT_64BIT
)) {

4092 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Failedo set 64-bit journal feature");

4093 
çed_mouÁ_wq
;

4096 ià(!
	`£t_jouº®_csum_ã©u»_£t
(
sb
)) {

4097 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Failedo set journal checksum "

4099 
çed_mouÁ_wq
;

4104 
	`‹¡_İt
(
sb
, 
DATA_FLAGS
)) {

4110 ià(
jbd2_jouº®_check_avaabË_ã©u»s


4111 (
sbi
->
s_jouº®
, 0, 0, 
JBD2_FEATURE_INCOMPAT_REVOKE
))

4112 
	`£t_İt
(
sb
, 
ORDERED_DATA
);

4114 
	`£t_İt
(
sb
, 
JOURNAL_DATA
);

4117 
EXT4_MOUNT_ORDERED_DATA
:

4118 
EXT4_MOUNT_WRITEBACK_DATA
:

4119 ià(!
jbd2_jouº®_check_avaabË_ã©u»s


4120 (
sbi
->
s_jouº®
, 0, 0, 
JBD2_FEATURE_INCOMPAT_REVOKE
)) {

4121 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Journal does‚ot support "

4123 
çed_mouÁ_wq
;

4129 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
 &&

4130 
	`‹¡_İt
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4131 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4133 
çed_mouÁ_wq
;

4136 
	`£t_sk_iİrio
(
sbi
->
s_jouº®
->
j_sk
, 
jouº®_iİrio
);

4138 
sbi
->
s_jouº®
->
j_comm™_ÿÎback
 = 
ext4_jouº®_comm™_ÿÎback
;

4140 
no_jouº®
:

4141 ià(!
	`‹¡_İt
(
sb
, 
NO_MBCACHE
)) {

4142 
sbi
->
s_—_block_ÿche
 = 
	`ext4_x©Œ_ü—‹_ÿche
();

4143 ià(!
sbi
->
s_—_block_ÿche
) {

4144 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4146 
çed_mouÁ_wq
;

4149 ià(
	`ext4_has_ã©u»_—_šode
(
sb
)) {

4150 
sbi
->
s_—_šode_ÿche
 = 
	`ext4_x©Œ_ü—‹_ÿche
();

4151 ià(!
sbi
->
s_—_šode_ÿche
) {

4152 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4154 
çed_mouÁ_wq
;

4159 ià((
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
è|| 
	`ext4_has_ã©u»_’üy±
(
sb
)) &&

4160 (
blocksize
 !ğ
PAGE_SIZE
)) {

4161 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4163 
çed_mouÁ_wq
;

4166 ià(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
è&& !(
sb
->
s_æags
 & 
MS_RDONLY
) &&

4167 !
	`ext4_has_ã©u»_’üy±
(
sb
)) {

4168 
	`ext4_£t_ã©u»_’üy±
(
sb
);

4169 
	`ext4_comm™_su³r
(
sb
, 1);

4176 ià(
es
->
s_ov”h—d_şu¡”s
)

4177 
sbi
->
s_ov”h—d
 = 
	`Ë32_to_ıu
(
es
->
s_ov”h—d_şu¡”s
);

4179 
”r
 = 
	`ext4_ÿlcuÏ‹_ov”h—d
(
sb
);

4180 ià(
”r
)

4181 
çed_mouÁ_wq
;

4188 
	`EXT4_SB
(
sb
)->
rsv_cÚv”siÚ_wq
 =

4189 
	`®loc_wÜkqueue
("ext4-rsv-cÚv”siÚ", 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 1);

4190 ià(!
	`EXT4_SB
(
sb
)->
rsv_cÚv”siÚ_wq
) {

4191 
	`´štk
(
KERN_ERR
 "EXT4-fs: failedo create workqueue\n");

4192 
»t
 = -
ENOMEM
;

4193 
çed_mouÁ4
;

4201 
roÙ
 = 
	`ext4_ig‘
(
sb
, 
EXT4_ROOT_INO
);

4202 ià(
	`IS_ERR
(
roÙ
)) {

4203 
	`ext4_msg
(
sb
, 
KERN_ERR
, "get„oot inode failed");

4204 
»t
 = 
	`PTR_ERR
(
roÙ
);

4205 
roÙ
 = 
NULL
;

4206 
çed_mouÁ4
;

4208 ià(!
	`S_ISDIR
(
roÙ
->
i_mode
è|| !roÙ->
i_blocks
 || !roÙ->
i_size
) {

4209 
	`ext4_msg
(
sb
, 
KERN_ERR
, "corrupt„oot inode,„unƒ2fsck");

4210 
	`ut
(
roÙ
);

4211 
çed_mouÁ4
;

4213 
sb
->
s_roÙ
 = 
	`d_make_roÙ
(
roÙ
);

4214 ià(!
sb
->
s_roÙ
) {

4215 
	`ext4_msg
(
sb
, 
KERN_ERR
, "get„oot dentry failed");

4216 
»t
 = -
ENOMEM
;

4217 
çed_mouÁ4
;

4220 ià(
	`ext4_£tup_su³r
(
sb
, 
es
, sb->
s_æags
 & 
MS_RDONLY
))

4221 
sb
->
s_æags
 |ğ
MS_RDONLY
;

4224 ià(
sbi
->
s_šode_size
 > 
EXT4_GOOD_OLD_INODE_SIZE
 &&

4225 
sbi
->
s_wªt_exŒa_isize
 == 0) {

4226 
sbi
->
s_wªt_exŒa_isize
 = (
ext4_šode
) -

4227 
EXT4_GOOD_OLD_INODE_SIZE
;

4228 ià(
	`ext4_has_ã©u»_exŒa_isize
(
sb
)) {

4229 ià(
sbi
->
s_wªt_exŒa_isize
 <

4230 
	`Ë16_to_ıu
(
es
->
s_wªt_exŒa_isize
))

4231 
sbi
->
s_wªt_exŒa_isize
 =

4232 
	`Ë16_to_ıu
(
es
->
s_wªt_exŒa_isize
);

4233 ià(
sbi
->
s_wªt_exŒa_isize
 <

4234 
	`Ë16_to_ıu
(
es
->
s_mš_exŒa_isize
))

4235 
sbi
->
s_wªt_exŒa_isize
 =

4236 
	`Ë16_to_ıu
(
es
->
s_mš_exŒa_isize
);

4240 ià(
EXT4_GOOD_OLD_INODE_SIZE
 + 
sbi
->
s_wªt_exŒa_isize
 >

4241 
sbi
->
s_šode_size
) {

4242 
sbi
->
s_wªt_exŒa_isize
 = (
ext4_šode
) -

4243 
EXT4_GOOD_OLD_INODE_SIZE
;

4244 
	`ext4_msg
(
sb
, 
KERN_INFO
, "requiredƒxtra inode space‚ot"

4248 
	`ext4_£t_»sv_şu¡”s
(
sb
);

4250 
”r
 = 
	`ext4_£tup_sy¡em_zÚe
(
sb
);

4251 ià(
”r
) {

4252 
	`ext4_msg
(
sb
, 
KERN_ERR
, "failedo initialize system "

4253 "zÚ(%d)", 
”r
);

4254 
çed_mouÁ4a
;

4257 
	`ext4_ext_š™
(
sb
);

4258 
”r
 = 
	`ext4_mb_š™
(
sb
);

4259 ià(
”r
) {

4260 
	`ext4_msg
(
sb
, 
KERN_ERR
, "failedo initialize mballoc (%d)",

4261 
”r
);

4262 
çed_mouÁ5
;

4265 
block
 = 
	`ext4_couÁ_ä“_şu¡”s
(
sb
);

4266 
	`ext4_ä“_blocks_couÁ_£t
(
sbi
->
s_es
,

4267 
	`EXT4_C2B
(
sbi
, 
block
));

4268 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_ä“şu¡”s_couÁ”
, 
block
,

4269 
GFP_KERNEL
);

4270 ià(!
”r
) {

4271 
ä“i
 = 
	`ext4_couÁ_ä“_šodes
(
sb
);

4272 
sbi
->
s_es
->
s_ä“_šodes_couÁ
 = 
	`ıu_to_Ë32
(
ä“i
);

4273 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_ä“šodes_couÁ”
, 
ä“i
,

4274 
GFP_KERNEL
);

4276 ià(!
”r
)

4277 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_dœs_couÁ”
,

4278 
	`ext4_couÁ_dœs
(
sb
), 
GFP_KERNEL
);

4279 ià(!
”r
)

4280 
”r
 = 
	`³rıu_couÁ”_š™
(&
sbi
->
s_dœtyşu¡”s_couÁ”
, 0,

4281 
GFP_KERNEL
);

4282 ià(!
”r
)

4283 
”r
 = 
	`³rıu_š™_rw£m
(&
sbi
->
s_jouº®_æag_rw£m
);

4285 ià(
”r
) {

4286 
	`ext4_msg
(
sb
, 
KERN_ERR
, "insufficient memory");

4287 
çed_mouÁ6
;

4290 ià(
	`ext4_has_ã©u»_æex_bg
(
sb
))

4291 ià(!
	`ext4_fl_æex_šfo
(
sb
)) {

4292 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4295 
çed_mouÁ6
;

4298 
”r
 = 
	`ext4_»gi¡”_li_»que¡
(
sb
, 
fœ¡_nÙ_z”Ûd
);

4299 ià(
”r
)

4300 
çed_mouÁ6
;

4302 
”r
 = 
	`ext4_»gi¡”_sysfs
(
sb
);

4303 ià(
”r
)

4304 
çed_mouÁ7
;

4306 #ifdeà
CONFIG_QUOTA


4308 ià(
	`ext4_has_ã©u»_quÙa
(
sb
è&& !(sb->
s_æags
 & 
MS_RDONLY
)) {

4309 
”r
 = 
	`ext4_’abË_quÙas
(
sb
);

4310 ià(
”r
)

4311 
çed_mouÁ8
;

4315 
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 |ğ
EXT4_ORPHAN_FS
;

4316 
	`ext4_Üphª_ş—nup
(
sb
, 
es
);

4317 
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 &ğ~
EXT4_ORPHAN_FS
;

4318 ià(
Ãeds_»cov”y
) {

4319 
	`ext4_msg
(
sb
, 
KERN_INFO
, "recovery complete");

4320 
	`ext4_m¬k_»cov”y_com¶‘e
(
sb
, 
es
);

4322 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

4323 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
)

4324 
desü
 = " journalled data mode";

4325 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
)

4326 
desü
 = " ordered data mode";

4328 
desü
 = " writeback data mode";

4330 
desü
 = "out journal";

4332 ià(
	`‹¡_İt
(
sb
, 
DISCARD
)) {

4333 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

4334 ià(!
	`blk_queue_disÿrd
(
q
))

4335 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

4340 ià(
	`___¿‹lim™
(&
ext4_mouÁ_msg_¿‹lim™
, "EXT4-fs mount"))

4341 
	`ext4_msg
(
sb
, 
KERN_INFO
, "mounted filesystem with%s. "

4342 "O±s: %.*s%s%s", 
desü
,

4343 (è(
sbi
->
s_es
->
s_mouÁ_İts
),

4344 
sbi
->
s_es
->
s_mouÁ_İts
,

4345 *
sbi
->
s_es
->
s_mouÁ_İts
 ? "; " : "", 
Üig_d©a
);

4347 ià(
es
->
s_”rÜ_couÁ
)

4348 
	`mod_tim”
(&
sbi
->
s_”r_»pÜt
, 
jiff›s
 + 300*
HZ
);

4351 
	`¿‹lim™_¡©e_š™
(&
sbi
->
s_”r_¿‹lim™_¡©e
, 5 * 
HZ
, 10);

4352 
	`¿‹lim™_¡©e_š™
(&
sbi
->
s_w¬nšg_¿‹lim™_¡©e
, 5 * 
HZ
, 10);

4353 
	`¿‹lim™_¡©e_š™
(&
sbi
->
s_msg_¿‹lim™_¡©e
, 5 * 
HZ
, 10);

4355 
	`kä“
(
Üig_d©a
);

4358 
ÿÁfšd_ext4
:

4359 ià(!
s’t
)

4360 
	`ext4_msg
(
sb
, 
KERN_ERR
, "VFS: Can't findƒxt4 filesystem");

4361 
çed_mouÁ
;

4363 #ifdeà
CONFIG_QUOTA


4364 
çed_mouÁ8
:

4365 
	`ext4_uÄegi¡”_sysfs
(
sb
);

4367 
çed_mouÁ7
:

4368 
	`ext4_uÄegi¡”_li_»que¡
(
sb
);

4369 
çed_mouÁ6
:

4370 
	`ext4_mb_»Ëa£
(
sb
);

4371 ià(
sbi
->
s_æex_groups
)

4372 
	`kvä“
(
sbi
->
s_æex_groups
);

4373 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_ä“şu¡”s_couÁ”
);

4374 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_ä“šodes_couÁ”
);

4375 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_dœs_couÁ”
);

4376 
	`³rıu_couÁ”_de¡roy
(&
sbi
->
s_dœtyşu¡”s_couÁ”
);

4377 
çed_mouÁ5
:

4378 
	`ext4_ext_»Ëa£
(
sb
);

4379 
	`ext4_»Ëa£_sy¡em_zÚe
(
sb
);

4380 
çed_mouÁ4a
:

4381 
	`dput
(
sb
->
s_roÙ
);

4382 
sb
->
s_roÙ
 = 
NULL
;

4383 
çed_mouÁ4
:

4384 
	`ext4_msg
(
sb
, 
KERN_ERR
, "mount failed");

4385 ià(
	`EXT4_SB
(
sb
)->
rsv_cÚv”siÚ_wq
)

4386 
	`de¡roy_wÜkqueue
(
	`EXT4_SB
(
sb
)->
rsv_cÚv”siÚ_wq
);

4387 
çed_mouÁ_wq
:

4388 ià(
sbi
->
s_—_šode_ÿche
) {

4389 
	`ext4_x©Œ_de¡roy_ÿche
(
sbi
->
s_—_šode_ÿche
);

4390 
sbi
->
s_—_šode_ÿche
 = 
NULL
;

4392 ià(
sbi
->
s_—_block_ÿche
) {

4393 
	`ext4_x©Œ_de¡roy_ÿche
(
sbi
->
s_—_block_ÿche
);

4394 
sbi
->
s_—_block_ÿche
 = 
NULL
;

4396 ià(
sbi
->
s_jouº®
) {

4397 
	`jbd2_jouº®_de¡roy
(
sbi
->
s_jouº®
);

4398 
sbi
->
s_jouº®
 = 
NULL
;

4400 
çed_mouÁ3a
:

4401 
	`ext4_es_uÄegi¡”_shršk”
(
sbi
);

4402 
çed_mouÁ3
:

4403 
	`d–_tim”_sync
(&
sbi
->
s_”r_»pÜt
);

4404 ià(
sbi
->
s_mmp_tsk
)

4405 
	`kth»ad_¡İ
(
sbi
->
s_mmp_tsk
);

4406 
çed_mouÁ2
:

4407 
i
 = 0; i < 
db_couÁ
; i++)

4408 
	`b»l£
(
sbi
->
s_group_desc
[
i
]);

4409 
	`kvä“
(
sbi
->
s_group_desc
);

4410 
çed_mouÁ
:

4411 ià(
sbi
->
s_chksum_driv”
)

4412 
	`üy±o_ä“_shash
(
sbi
->
s_chksum_driv”
);

4413 #ifdeà
CONFIG_QUOTA


4414 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++)

4415 
	`kä“
(
sbi
->
s_qf_Çmes
[
i
]);

4417 
	`ext4_blkdev_»move
(
sbi
);

4418 
	`b»l£
(
bh
);

4419 
out_ç
:

4420 
sb
->
s_fs_šfo
 = 
NULL
;

4421 
	`kä“
(
sbi
->
s_blockgroup_lock
);

4422 
out_ä“_ba£
:

4423 
	`kä“
(
sbi
);

4424 
	`kä“
(
Üig_d©a
);

4425  
”r
 ?ƒ¼ : 
»t
;

4426 
	}
}

4433 
	$ext4_š™_jouº®_·¿ms
(
su³r_block
 *
sb
, 
jouº®_t
 *
jouº®
)

4435 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4437 
jouº®
->
j_comm™_š‹rv®
 = 
sbi
->
s_comm™_š‹rv®
;

4438 
jouº®
->
j_mš_b©ch_time
 = 
sbi
->
s_mš_b©ch_time
;

4439 
jouº®
->
j_max_b©ch_time
 = 
sbi
->
s_max_b©ch_time
;

4440 
	`ext4_š™_ç¡_comm™
(
sb
, 
jouº®
);

4442 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

4443 ià(
	`‹¡_İt
(
sb
, 
BARRIER
))

4444 
jouº®
->
j_æags
 |ğ
JBD2_BARRIER
;

4446 
jouº®
->
j_æags
 &ğ~
JBD2_BARRIER
;

4447 ià(
	`‹¡_İt
(
sb
, 
DATA_ERR_ABORT
))

4448 
jouº®
->
j_æags
 |ğ
JBD2_ABORT_ON_SYNCDATA_ERR
;

4450 
jouº®
->
j_æags
 &ğ~
JBD2_ABORT_ON_SYNCDATA_ERR
;

4451 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

4452 
	}
}

4454 
šode
 *
	$ext4_g‘_jouº®_šode
(
su³r_block
 *
sb
,

4455 
jouº®_šum
)

4457 
šode
 *
jouº®_šode
;

4464 
jouº®_šode
 = 
	`ext4_ig‘
(
sb
, 
jouº®_šum
);

4465 ià(
	`IS_ERR
(
jouº®_šode
)) {

4466 
	`ext4_msg
(
sb
, 
KERN_ERR
, "no journal found");

4467  
NULL
;

4469 ià(!
jouº®_šode
->
i_Æšk
) {

4470 
	`make_bad_šode
(
jouº®_šode
);

4471 
	`ut
(
jouº®_šode
);

4472 
	`ext4_msg
(
sb
, 
KERN_ERR
, "journal inode is deleted");

4473  
NULL
;

4476 
	`jbd_debug
(2, "Journal inode found‡t %p: %lld bytes\n",

4477 
jouº®_šode
, jouº®_šode->
i_size
);

4478 ià(!
	`S_ISREG
(
jouº®_šode
->
i_mode
)) {

4479 
	`ext4_msg
(
sb
, 
KERN_ERR
, "invalid journal inode");

4480 
	`ut
(
jouº®_šode
);

4481  
NULL
;

4483  
jouº®_šode
;

4484 
	}
}

4486 
jouº®_t
 *
	$ext4_g‘_jouº®
(
su³r_block
 *
sb
,

4487 
jouº®_šum
)

4489 
šode
 *
jouº®_šode
;

4490 
jouº®_t
 *
jouº®
;

4492 
	`BUG_ON
(!
	`ext4_has_ã©u»_jouº®
(
sb
));

4494 
jouº®_šode
 = 
	`ext4_g‘_jouº®_šode
(
sb
, 
jouº®_šum
);

4495 ià(!
jouº®_šode
)

4496  
NULL
;

4498 
jouº®
 = 
	`jbd2_jouº®_š™_šode
(
jouº®_šode
);

4499 ià(!
jouº®
) {

4500 
	`ext4_msg
(
sb
, 
KERN_ERR
, "Could‚ot†oad journal inode");

4501 
	`ut
(
jouº®_šode
);

4502  
NULL
;

4504 
jouº®
->
j_´iv©e
 = 
sb
;

4505 
	`ext4_š™_jouº®_·¿ms
(
sb
, 
jouº®
);

4506  
jouº®
;

4507 
	}
}

4509 
jouº®_t
 *
	$ext4_g‘_dev_jouº®
(
su³r_block
 *
sb
,

4510 
dev_t
 
j_dev
)

4512 
bufãr_h—d
 *
bh
;

4513 
jouº®_t
 *
jouº®
;

4514 
ext4_fsblk_t
 
¡¬t
;

4515 
ext4_fsblk_t
 
Ën
;

4516 
hblock
, 
blocksize
;

4517 
ext4_fsblk_t
 
sb_block
;

4518 
off£t
;

4519 
ext4_su³r_block
 *
es
;

4520 
block_deviû
 *
bdev
;

4522 
	`BUG_ON
(!
	`ext4_has_ã©u»_jouº®
(
sb
));

4524 
bdev
 = 
	`ext4_blkdev_g‘
(
j_dev
, 
sb
);

4525 ià(
bdev
 =ğ
NULL
)

4526  
NULL
;

4528 
blocksize
 = 
sb
->
s_blocksize
;

4529 
hblock
 = 
	`bdev_logiÿl_block_size
(
bdev
);

4530 ià(
blocksize
 < 
hblock
) {

4531 
	`ext4_msg
(
sb
, 
KERN_ERR
,

4533 
out_bdev
;

4536 
sb_block
 = 
EXT4_MIN_BLOCK_SIZE
 / 
blocksize
;

4537 
off£t
 = 
EXT4_MIN_BLOCK_SIZE
 % 
blocksize
;

4538 
	`£t_blocksize
(
bdev
, 
blocksize
);

4539 ià(!(
bh
 = 
	`__b»ad
(
bdev
, 
sb_block
, 
blocksize
))) {

4540 
	`ext4_msg
(
sb
, 
KERN_ERR
, "couldn't„ead superblock of "

4542 
out_bdev
;

4545 
es
 = (
ext4_su³r_block
 *è(
bh
->
b_d©a
 + 
off£t
);

4546 ià((
	`Ë16_to_ıu
(
es
->
s_magic
è!ğ
EXT4_SUPER_MAGIC
) ||

4547 !(
	`Ë32_to_ıu
(
es
->
s_ã©u»_šcom·t
) &

4548 
EXT4_FEATURE_INCOMPAT_JOURNAL_DEV
)) {

4549 
	`ext4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4551 
	`b»l£
(
bh
);

4552 
out_bdev
;

4555 ià((
	`Ë32_to_ıu
(
es
->
s_ã©u»_ro_com·t
) &

4556 
EXT4_FEATURE_RO_COMPAT_METADATA_CSUM
) &&

4557 
es
->
s_checksum
 !ğ
	`ext4_su³rblock_csum
(
sb
,ƒs)) {

4558 
	`ext4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4560 
	`b»l£
(
bh
);

4561 
out_bdev
;

4564 ià(
	`memcmp
(
	`EXT4_SB
(
sb
)->
s_es
->
s_jouº®_uuid
, 
es
->
s_uuid
, 16)) {

4565 
	`ext4_msg
(
sb
, 
KERN_ERR
, "journal UUID does‚ot match");

4566 
	`b»l£
(
bh
);

4567 
out_bdev
;

4570 
Ën
 = 
	`ext4_blocks_couÁ
(
es
);

4571 
¡¬t
 = 
sb_block
 + 1;

4572 
	`b»l£
(
bh
);

4574 
jouº®
 = 
	`jbd2_jouº®_š™_dev
(
bdev
, 
sb
->
s_bdev
,

4575 
¡¬t
, 
Ën
, 
blocksize
);

4576 ià(!
jouº®
) {

4577 
	`ext4_msg
(
sb
, 
KERN_ERR
, "failedo create device journal");

4578 
out_bdev
;

4580 
jouº®
->
j_´iv©e
 = 
sb
;

4581 
	`Î_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
jouº®
->
j_sb_bufãr
);

4582 
	`wa™_Ú_bufãr
(
jouº®
->
j_sb_bufãr
);

4583 ià(!
	`bufãr_u±od©e
(
jouº®
->
j_sb_bufãr
)) {

4584 
	`ext4_msg
(
sb
, 
KERN_ERR
, "I/Oƒrror on journal device");

4585 
out_jouº®
;

4587 ià(
	`be32_to_ıu
(
jouº®
->
j_su³rblock
->
s_Ä_u£rs
) != 1) {

4588 
	`ext4_msg
(
sb
, 
KERN_ERR
, "External journal has morehan one "

4590 
	`be32_to_ıu
(
jouº®
->
j_su³rblock
->
s_Ä_u£rs
));

4591 
out_jouº®
;

4593 
	`EXT4_SB
(
sb
)->
jouº®_bdev
 = 
bdev
;

4594 
	`ext4_š™_jouº®_·¿ms
(
sb
, 
jouº®
);

4595  
jouº®
;

4597 
out_jouº®
:

4598 
	`jbd2_jouº®_de¡roy
(
jouº®
);

4599 
out_bdev
:

4600 
	`ext4_blkdev_put
(
bdev
);

4601  
NULL
;

4602 
	}
}

4604 
	$ext4_lßd_jouº®
(
su³r_block
 *
sb
,

4605 
ext4_su³r_block
 *
es
,

4606 
jouº®_devnum
)

4608 
jouº®_t
 *
jouº®
;

4609 
jouº®_šum
 = 
	`Ë32_to_ıu
(
es
->
s_jouº®_šum
);

4610 
dev_t
 
jouº®_dev
;

4611 
”r
 = 0;

4612 
»®ly_»ad_Úly
;

4614 
	`BUG_ON
(!
	`ext4_has_ã©u»_jouº®
(
sb
));

4616 ià(
jouº®_devnum
 &&

4617 
jouº®_devnum
 !ğ
	`Ë32_to_ıu
(
es
->
s_jouº®_dev
)) {

4618 
	`ext4_msg
(
sb
, 
KERN_INFO
, "external journal device major/minor "

4620 
jouº®_dev
 = 
	`Ãw_decode_dev
(
jouº®_devnum
);

4622 
jouº®_dev
 = 
	`Ãw_decode_dev
(
	`Ë32_to_ıu
(
es
->
s_jouº®_dev
));

4624 
»®ly_»ad_Úly
 = 
	`bdev_»ad_Úly
(
sb
->
s_bdev
);

4631 ià(
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
)) {

4632 ià(
sb
->
s_æags
 & 
MS_RDONLY
) {

4633 
	`ext4_msg
(
sb
, 
KERN_INFO
, "INFO:„ecovery "

4635 ià(
»®ly_»ad_Úly
) {

4636 
	`ext4_msg
(
sb
, 
KERN_ERR
, "write‡ccess "

4638  -
EROFS
;

4640 
	`ext4_msg
(
sb
, 
KERN_INFO
, "write‡ccess will "

4645 ià(
jouº®_šum
 && 
jouº®_dev
) {

4646 
	`ext4_msg
(
sb
, 
KERN_ERR
, "filesystem has both journal "

4648  -
EINVAL
;

4651 ià(
jouº®_šum
) {

4652 ià(!(
jouº®
 = 
	`ext4_g‘_jouº®
(
sb
, 
jouº®_šum
)))

4653  -
EINVAL
;

4655 ià(!(
jouº®
 = 
	`ext4_g‘_dev_jouº®
(
sb
, 
jouº®_dev
)))

4656  -
EINVAL
;

4659 ià(!(
jouº®
->
j_æags
 & 
JBD2_BARRIER
))

4660 
	`ext4_msg
(
sb
, 
KERN_INFO
, "barriers disabled");

4662 ià(!
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
))

4663 
”r
 = 
	`jbd2_jouº®_we
(
jouº®
, !
»®ly_»ad_Úly
);

4664 ià(!
”r
) {

4665 *
§ve
 = 
	`km®loc
(
EXT4_S_ERR_LEN
, 
GFP_KERNEL
);

4666 ià(
§ve
)

4667 
	`memıy
(
§ve
, ((*è
es
) +

4668 
EXT4_S_ERR_START
, 
EXT4_S_ERR_LEN
);

4669 
”r
 = 
	`jbd2_jouº®_lßd
(
jouº®
);

4670 ià(
§ve
)

4671 
	`memıy
(((*è
es
è+ 
EXT4_S_ERR_START
,

4672 
§ve
, 
EXT4_S_ERR_LEN
);

4673 
	`kä“
(
§ve
);

4676 ià(
”r
) {

4677 
	`ext4_msg
(
sb
, 
KERN_ERR
, "error†oading journal");

4678 
	`jbd2_jouº®_de¡roy
(
jouº®
);

4679  
”r
;

4682 
	`EXT4_SB
(
sb
)->
s_jouº®
 = 
jouº®
;

4683 
	`ext4_ş—r_jouº®_”r
(
sb
, 
es
);

4685 ià(!
»®ly_»ad_Úly
 && 
jouº®_devnum
 &&

4686 
jouº®_devnum
 !ğ
	`Ë32_to_ıu
(
es
->
s_jouº®_dev
)) {

4687 
es
->
s_jouº®_dev
 = 
	`ıu_to_Ë32
(
jouº®_devnum
);

4690 
	`ext4_comm™_su³r
(
sb
, 1);

4694 
	}
}

4696 
	$ext4_comm™_su³r
(
su³r_block
 *
sb
, 
sync
)

4698 
ext4_su³r_block
 *
es
 = 
	`EXT4_SB
(
sb
)->
s_es
;

4699 
bufãr_h—d
 *
sbh
 = 
	`EXT4_SB
(
sb
)->
s_sbh
;

4700 
”rÜ
 = 0;

4702 ià(!
sbh
 || 
	`block_deviû_ejeùed
(
sb
))

4703  
”rÜ
;

4714 ià(!(
sb
->
s_æags
 & 
MS_RDONLY
))

4715 
es
->
s_wtime
 = 
	`ıu_to_Ë32
(
	`g‘_£cÚds
());

4716 ià(
sb
->
s_bdev
->
bd_·¹
)

4717 
es
->
s_kby‹s_wr™‹n
 =

4718 
	`ıu_to_Ë64
(
	`EXT4_SB
(
sb
)->
s_kby‹s_wr™‹n
 +

4719 ((
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
, 
£ùÜs
[1]) -

4720 
	`EXT4_SB
(
sb
)->
s_£ùÜs_wr™‹n_¡¬t
) >> 1));

4722 
es
->
s_kby‹s_wr™‹n
 =

4723 
	`ıu_to_Ë64
(
	`EXT4_SB
(
sb
)->
s_kby‹s_wr™‹n
);

4724 ià(
	`³rıu_couÁ”_š™Ÿlized
(&
	`EXT4_SB
(
sb
)->
s_ä“şu¡”s_couÁ”
))

4725 
	`ext4_ä“_blocks_couÁ_£t
(
es
,

4726 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 
	`³rıu_couÁ”_sum_pos™ive
(

4727 &
	`EXT4_SB
(
sb
)->
s_ä“şu¡”s_couÁ”
)));

4728 ià(
	`³rıu_couÁ”_š™Ÿlized
(&
	`EXT4_SB
(
sb
)->
s_ä“šodes_couÁ”
))

4729 
es
->
s_ä“_šodes_couÁ
 =

4730 
	`ıu_to_Ë32
(
	`³rıu_couÁ”_sum_pos™ive
(

4731 &
	`EXT4_SB
(
sb
)->
s_ä“šodes_couÁ”
));

4732 
	`BUFFER_TRACE
(
sbh
, "marking dirty");

4733 
	`ext4_su³rblock_csum_£t
(
sb
);

4734 ià(
sync
)

4735 
	`lock_bufãr
(
sbh
);

4736 ià(
	`bufãr_wr™e_io_”rÜ
(
sbh
)) {

4745 
	`ext4_msg
(
sb
, 
KERN_ERR
, "previous I/Oƒrroro "

4747 
	`ş—r_bufãr_wr™e_io_”rÜ
(
sbh
);

4748 
	`£t_bufãr_u±od©e
(
sbh
);

4750 
	`m¬k_bufãr_dœty
(
sbh
);

4751 ià(
sync
) {

4752 
	`uÆock_bufãr
(
sbh
);

4753 
”rÜ
 = 
	`__sync_dœty_bufãr
(
sbh
,

4754 
REQ_SYNC
 | (
	`‹¡_İt
(
sb
, 
BARRIER
è? 
REQ_FUA
 : 0));

4755 ià(
”rÜ
)

4756  
”rÜ
;

4758 
”rÜ
 = 
	`bufãr_wr™e_io_”rÜ
(
sbh
);

4759 ià(
”rÜ
) {

4760 
	`ext4_msg
(
sb
, 
KERN_ERR
, "I/Oƒrror while writing "

4762 
	`ş—r_bufãr_wr™e_io_”rÜ
(
sbh
);

4763 
	`£t_bufãr_u±od©e
(
sbh
);

4766  
”rÜ
;

4767 
	}
}

4774 
	$ext4_m¬k_»cov”y_com¶‘e
(
su³r_block
 *
sb
,

4775 
ext4_su³r_block
 *
es
)

4777 
jouº®_t
 *
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

4779 ià(!
	`ext4_has_ã©u»_jouº®
(
sb
)) {

4780 
	`BUG_ON
(
jouº®
 !ğ
NULL
);

4783 
	`jbd2_jouº®_lock_upd©es
(
jouº®
);

4784 ià(
	`jbd2_jouº®_æush
(
jouº®
) < 0)

4785 
out
;

4787 ià(
	`ext4_has_ã©u»_jouº®_Ãeds_»cov”y
(
sb
) &&

4788 
sb
->
s_æags
 & 
MS_RDONLY
) {

4789 
	`ext4_ş—r_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

4790 
	`ext4_comm™_su³r
(
sb
, 1);

4793 
out
:

4794 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

4795 
	}
}

4802 
	$ext4_ş—r_jouº®_”r
(
su³r_block
 *
sb
,

4803 
ext4_su³r_block
 *
es
)

4805 
jouº®_t
 *
jouº®
;

4806 
j_”ºo
;

4807 cÚ¡ *
”r¡r
;

4809 
	`BUG_ON
(!
	`ext4_has_ã©u»_jouº®
(
sb
));

4811 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

4818 
j_”ºo
 = 
	`jbd2_jouº®_”ºo
(
jouº®
);

4819 ià(
j_”ºo
) {

4820 
nbuf
[16];

4822 
”r¡r
 = 
	`ext4_decode_”rÜ
(
sb
, 
j_”ºo
, 
nbuf
);

4823 
	`ext4_w¬nšg
(
sb
, "Filesystemƒrror„ecorded "

4824 "äom…»viou mouÁ: %s", 
”r¡r
);

4825 
	`ext4_w¬nšg
(
sb
, "Marking fs in‚eed of filesystem check.");

4827 
	`EXT4_SB
(
sb
)->
s_mouÁ_¡©e
 |ğ
EXT4_ERROR_FS
;

4828 
es
->
s_¡©e
 |ğ
	`ıu_to_Ë16
(
EXT4_ERROR_FS
);

4829 
	`ext4_comm™_su³r
(
sb
, 1);

4831 
	`jbd2_jouº®_ş—r_”r
(
jouº®
);

4832 
	`jbd2_jouº®_upd©e_sb_”ºo
(
jouº®
);

4834 
	}
}

4840 
	$ext4_fÜû_comm™
(
su³r_block
 *
sb
)

4842 
jouº®_t
 *
jouº®
;

4844 ià(
sb
->
s_æags
 & 
MS_RDONLY
)

4847 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

4848  
	`ext4_jouº®_fÜû_comm™
(
jouº®
);

4849 
	}
}

4851 
	$ext4_sync_fs
(
su³r_block
 *
sb
, 
wa™
)

4853 
»t
 = 0;

4854 
tid_t
 
rg‘
;

4855 
boŞ
 
Ãeds_b¬r›r
 = 
çl£
;

4856 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4858 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
sb
))))

4861 
	`Œaû_ext4_sync_fs
(
sb
, 
wa™
);

4862 
	`æush_wÜkqueue
(
sbi
->
rsv_cÚv”siÚ_wq
);

4867 
	`dquÙ_wr™eback_dquÙs
(
sb
, -1);

4873 ià(
sbi
->
s_jouº®
) {

4874 
rg‘
 = 
	`jbd2_g‘_Ï‹¡_Œª§ùiÚ
(
sbi
->
s_jouº®
);

4875 ià(
wa™
 && 
sbi
->
s_jouº®
->
j_æags
 & 
JBD2_BARRIER
 &&

4876 !
	`jbd2_Œªs_wl_£nd_d©a_b¬r›r
(
sbi
->
s_jouº®
, 
rg‘
))

4877 
Ãeds_b¬r›r
 = 
Œue
;

4879 ià(
	`jbd2_jouº®_¡¬t_comm™
(
sbi
->
s_jouº®
, &
rg‘
)) {

4880 ià(
wa™
)

4881 
»t
 = 
	`jbd2_log_wa™_comm™
(
sbi
->
s_jouº®
,

4882 
rg‘
);

4884 } ià(
wa™
 && 
	`‹¡_İt
(
sb
, 
BARRIER
))

4885 
Ãeds_b¬r›r
 = 
Œue
;

4886 ià(
Ãeds_b¬r›r
) {

4887 
”r
;

4888 
”r
 = 
	`blkdev_issue_æush
(
sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

4889 ià(!
»t
)

4890 
»t
 = 
”r
;

4893  
»t
;

4894 
	}
}

4904 
	$ext4_ä“ze
(
su³r_block
 *
sb
)

4906 
”rÜ
 = 0;

4907 
jouº®_t
 *
jouº®
;

4909 ià(
sb
->
s_æags
 & 
MS_RDONLY
)

4912 
jouº®
 = 
	`EXT4_SB
(
sb
)->
s_jouº®
;

4914 ià(
jouº®
) {

4916 
	`jbd2_jouº®_lock_upd©es
(
jouº®
);

4922 
”rÜ
 = 
	`jbd2_jouº®_æush
(
jouº®
);

4923 ià(
”rÜ
 < 0)

4924 
out
;

4927 
	`ext4_ş—r_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

4930 
”rÜ
 = 
	`ext4_comm™_su³r
(
sb
, 1);

4931 
out
:

4932 ià(
jouº®
)

4934 
	`jbd2_jouº®_uÆock_upd©es
(
jouº®
);

4935  
”rÜ
;

4936 
	}
}

4942 
	$ext4_unä“ze
(
su³r_block
 *
sb
)

4944 ià((
sb
->
s_æags
 & 
MS_RDONLY
è|| 
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(sb)))

4947 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
) {

4949 
	`ext4_£t_ã©u»_jouº®_Ãeds_»cov”y
(
sb
);

4952 
	`ext4_comm™_su³r
(
sb
, 1);

4954 
	}
}

4959 
	sext4_mouÁ_İtiÚs
 {

4960 
	ms_mouÁ_İt
;

4961 
	ms_mouÁ_İt2
;

4962 
kuid_t
 
	ms_»suid
;

4963 
kgid_t
 
	ms_»sgid
;

4964 
	ms_comm™_š‹rv®
;

4965 
u32
 
	ms_mš_b©ch_time
, 
	ms_max_b©ch_time
;

4966 #ifdeà
CONFIG_QUOTA


4967 
	ms_jquÙa_fmt
;

4968 *
	ms_qf_Çmes
[
EXT4_MAXQUOTAS
];

4972 
	$ext4_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
)

4974 
ext4_su³r_block
 *
es
;

4975 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

4976 
Şd_sb_æags
;

4977 
ext4_mouÁ_İtiÚs
 
Şd_İts
;

4978 
’abË_quÙa
 = 0;

4979 
ext4_group_t
 
g
;

4980 
jouº®_iİrio
 = 
DEFAULT_JOURNAL_IOPRIO
;

4981 
”r
 = 0;

4982 #ifdeà
CONFIG_QUOTA


4983 
i
, 
j
;

4985 *
Üig_d©a
 = 
	`k¡rdup
(
d©a
, 
GFP_KERNEL
);

4988 
Şd_sb_æags
 = 
sb
->
s_æags
;

4989 
Şd_İts
.
s_mouÁ_İt
 = 
sbi
->s_mount_opt;

4990 
Şd_İts
.
s_mouÁ_İt2
 = 
sbi
->s_mount_opt2;

4991 
Şd_İts
.
s_»suid
 = 
sbi
->s_resuid;

4992 
Şd_İts
.
s_»sgid
 = 
sbi
->s_resgid;

4993 
Şd_İts
.
s_comm™_š‹rv®
 = 
sbi
->s_commit_interval;

4994 
Şd_İts
.
s_mš_b©ch_time
 = 
sbi
->s_min_batch_time;

4995 
Şd_İts
.
s_max_b©ch_time
 = 
sbi
->s_max_batch_time;

4996 #ifdeà
CONFIG_QUOTA


4997 
Şd_İts
.
s_jquÙa_fmt
 = 
sbi
->s_jquota_fmt;

4998 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++)

4999 ià(
sbi
->
s_qf_Çmes
[
i
]) {

5000 
Şd_İts
.
s_qf_Çmes
[
i
] = 
	`k¡rdup
(
sbi
->s_qf_names[i],

5001 
GFP_KERNEL
);

5002 ià(!
Şd_İts
.
s_qf_Çmes
[
i
]) {

5003 
j
 = 0; j < 
i
; j++)

5004 
	`kä“
(
Şd_İts
.
s_qf_Çmes
[
j
]);

5005 
	`kä“
(
Üig_d©a
);

5006  -
ENOMEM
;

5009 
Şd_İts
.
s_qf_Çmes
[
i
] = 
NULL
;

5011 ià(
sbi
->
s_jouº®
 && sbi->s_jouº®->
j_sk
->
io_cÚ‹xt
)

5012 
jouº®_iİrio
 = 
sbi
->
s_jouº®
->
j_sk
->
io_cÚ‹xt
->
iİrio
;

5014 ià(!
	`·r£_İtiÚs
(
d©a
, 
sb
, 
NULL
, &
jouº®_iİrio
, 1)) {

5015 
”r
 = -
EINVAL
;

5016 
»¡Üe_İts
;

5019 ià((
Şd_İts
.
s_mouÁ_İt
 & 
EXT4_MOUNT_JOURNAL_CHECKSUM
) ^

5020 
	`‹¡_İt
(
sb
, 
JOURNAL_CHECKSUM
)) {

5021 
	`ext4_msg
(
sb
, 
KERN_ERR
, "changing journal_checksum "

5023 
sbi
->
s_mouÁ_İt
 ^ğ
EXT4_MOUNT_JOURNAL_CHECKSUM
;

5026 ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_JOURNAL_DATA
) {

5027 ià(
	`‹¡_İt2
(
sb
, 
EXPLICIT_DELALLOC
)) {

5028 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5030 
”r
 = -
EINVAL
;

5031 
»¡Üe_İts
;

5033 ià(
	`‹¡_İt
(
sb
, 
DIOREAD_NOLOCK
)) {

5034 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5036 
”r
 = -
EINVAL
;

5037 
»¡Üe_İts
;

5039 ià(
	`‹¡_İt
(
sb
, 
DAX
)) {

5040 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5042 
”r
 = -
EINVAL
;

5043 
»¡Üe_İts
;

5045 } ià(
	`‹¡_İt
(
sb
, 
DATA_FLAGS
è=ğ
EXT4_MOUNT_ORDERED_DATA
) {

5046 ià(
	`‹¡_İt
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

5047 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5049 
”r
 = -
EINVAL
;

5050 
»¡Üe_İts
;

5054 ià((
sbi
->
s_mouÁ_İt
 ^ 
Şd_İts
.s_mouÁ_İtè& 
EXT4_MOUNT_NO_MBCACHE
) {

5055 
	`ext4_msg
(
sb
, 
KERN_ERR
, "can'tƒnable‚ombcache during„emount");

5056 
”r
 = -
EINVAL
;

5057 
»¡Üe_İts
;

5060 ià((
sbi
->
s_mouÁ_İt
 ^ 
Şd_İts
.s_mouÁ_İtè& 
EXT4_MOUNT_DAX
) {

5061 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "warning:„efusing change of "

5063 
sbi
->
s_mouÁ_İt
 ^ğ
EXT4_MOUNT_DAX
;

5066 ià(
sbi
->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
)

5067 
	`ext4_abÜt
(
sb
, "Abort forced by user");

5069 
sb
->
s_æags
 = (sb->s_æag & ~
MS_POSIXACL
) |

5070 (
	`‹¡_İt
(
sb
, 
POSIX_ACL
è? 
MS_POSIXACL
 : 0);

5072 
es
 = 
sbi
->
s_es
;

5074 ià(
sbi
->
s_jouº®
) {

5075 
	`ext4_š™_jouº®_·¿ms
(
sb
, 
sbi
->
s_jouº®
);

5076 
	`£t_sk_iİrio
(
sbi
->
s_jouº®
->
j_sk
, 
jouº®_iİrio
);

5079 ià(*
æags
 & 
MS_LAZYTIME
)

5080 
sb
->
s_æags
 |ğ
MS_LAZYTIME
;

5082 ià((*
æags
 & 
MS_RDONLY
è!ğ(
sb
->
s_æags
 & MS_RDONLY)) {

5083 ià(
sbi
->
s_mouÁ_æags
 & 
EXT4_MF_FS_ABORTED
) {

5084 
”r
 = -
EROFS
;

5085 
»¡Üe_İts
;

5088 ià(*
æags
 & 
MS_RDONLY
) {

5089 
”r
 = 
	`sync_fesy¡em
(
sb
);

5090 ià(
”r
 < 0)

5091 
»¡Üe_İts
;

5092 
”r
 = 
	`dquÙ_su¥’d
(
sb
, -1);

5093 ià(
”r
 < 0)

5094 
»¡Üe_İts
;

5100 
sb
->
s_æags
 |ğ
MS_RDONLY
;

5107 ià(!(
es
->
s_¡©e
 & 
	`ıu_to_Ë16
(
EXT4_VALID_FS
)) &&

5108 (
sbi
->
s_mouÁ_¡©e
 & 
EXT4_VALID_FS
))

5109 
es
->
s_¡©e
 = 
	`ıu_to_Ë16
(
sbi
->
s_mouÁ_¡©e
);

5111 ià(
sbi
->
s_jouº®
)

5112 
	`ext4_m¬k_»cov”y_com¶‘e
(
sb
, 
es
);

5115 ià(
	`ext4_has_ã©u»_»adÚly
(
sb
) ||

5116 !
	`ext4_ã©u»_£t_ok
(
sb
, 0)) {

5117 
”r
 = -
EROFS
;

5118 
»¡Üe_İts
;

5124 
g
 = 0; g < 
sbi
->
s_groups_couÁ
; g++) {

5125 
ext4_group_desc
 *
gdp
 =

5126 
	`ext4_g‘_group_desc
(
sb
, 
g
, 
NULL
);

5128 ià(!
	`ext4_group_desc_csum_v”ify
(
sb
, 
g
, 
gdp
)) {

5129 
	`ext4_msg
(
sb
, 
KERN_ERR
,

5131 
g
, 
	`Ë16_to_ıu
(
	`ext4_group_desc_csum
(
sb
, g, 
gdp
)),

5132 
	`Ë16_to_ıu
(
gdp
->
bg_checksum
));

5133 
”r
 = -
EFSBADCRC
;

5134 
»¡Üe_İts
;

5143 ià(
es
->
s_Ï¡_Üphª
) {

5144 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "Couldn't "

5148 
”r
 = -
EINVAL
;

5149 
»¡Üe_İts
;

5158 ià(
sbi
->
s_jouº®
)

5159 
	`ext4_ş—r_jouº®_”r
(
sb
, 
es
);

5160 
sbi
->
s_mouÁ_¡©e
 = 
	`Ë16_to_ıu
(
es
->
s_¡©e
);

5161 ià(!
	`ext4_£tup_su³r
(
sb
, 
es
, 0))

5162 
sb
->
s_æags
 &ğ~
MS_RDONLY
;

5163 ià(
	`ext4_has_ã©u»_mmp
(
sb
))

5164 ià(
	`ext4_muÉi_mouÁ_´Ùeù
(
sb
,

5165 
	`Ë64_to_ıu
(
es
->
s_mmp_block
))) {

5166 
”r
 = -
EROFS
;

5167 
»¡Üe_İts
;

5169 
’abË_quÙa
 = 1;

5177 ià((
sb
->
s_æags
 & 
MS_RDONLY
è|| !
	`‹¡_İt
(sb, 
INIT_INODE_TABLE
))

5178 
	`ext4_uÄegi¡”_li_»que¡
(
sb
);

5180 
ext4_group_t
 
fœ¡_nÙ_z”Ûd
;

5181 
fœ¡_nÙ_z”Ûd
 = 
	`ext4_has_unš™_™abË
(
sb
);

5182 
	`ext4_»gi¡”_li_»que¡
(
sb
, 
fœ¡_nÙ_z”Ûd
);

5185 
	`ext4_£tup_sy¡em_zÚe
(
sb
);

5186 ià(
sbi
->
s_jouº®
 =ğ
NULL
 && !(
Şd_sb_æags
 & 
MS_RDONLY
))

5187 
	`ext4_comm™_su³r
(
sb
, 1);

5189 #ifdeà
CONFIG_QUOTA


5191 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++)

5192 
	`kä“
(
Şd_İts
.
s_qf_Çmes
[
i
]);

5193 ià(
’abË_quÙa
) {

5194 ià(
	`sb_ªy_quÙa_su¥’ded
(
sb
))

5195 
	`dquÙ_»sume
(
sb
, -1);

5196 ià(
	`ext4_has_ã©u»_quÙa
(
sb
)) {

5197 
”r
 = 
	`ext4_’abË_quÙas
(
sb
);

5198 ià(
”r
)

5199 
»¡Üe_İts
;

5204 *
æags
 = (*æag & ~
MS_LAZYTIME
è| (
sb
->
s_æags
 & MS_LAZYTIME);

5205 
	`ext4_msg
(
sb
, 
KERN_INFO
, "»-mouÁed. O±s: %s", 
Üig_d©a
);

5206 
	`kä“
(
Üig_d©a
);

5209 
»¡Üe_İts
:

5210 
sb
->
s_æags
 = 
Şd_sb_æags
;

5211 
sbi
->
s_mouÁ_İt
 = 
Şd_İts
.s_mount_opt;

5212 
sbi
->
s_mouÁ_İt2
 = 
Şd_İts
.s_mount_opt2;

5213 
sbi
->
s_»suid
 = 
Şd_İts
.s_resuid;

5214 
sbi
->
s_»sgid
 = 
Şd_İts
.s_resgid;

5215 
sbi
->
s_comm™_š‹rv®
 = 
Şd_İts
.s_commit_interval;

5216 
sbi
->
s_mš_b©ch_time
 = 
Şd_İts
.s_min_batch_time;

5217 
sbi
->
s_max_b©ch_time
 = 
Şd_İts
.s_max_batch_time;

5218 #ifdeà
CONFIG_QUOTA


5219 
sbi
->
s_jquÙa_fmt
 = 
Şd_İts
.s_jquota_fmt;

5220 
i
 = 0; i < 
EXT4_MAXQUOTAS
; i++) {

5221 
	`kä“
(
sbi
->
s_qf_Çmes
[
i
]);

5222 
sbi
->
s_qf_Çmes
[
i
] = 
Şd_İts
.s_qf_names[i];

5225 
	`kä“
(
Üig_d©a
);

5226  
”r
;

5227 
	}
}

5229 #ifdeà
CONFIG_QUOTA


5230 
	$ext4_¡©fs_´ojeù
(
su³r_block
 *
sb
,

5231 
k´ojid_t
 
´ojid
, 
k¡©fs
 *
buf
)

5233 
kqid
 
qid
;

5234 
dquÙ
 *dquot;

5235 
u64
 
lim™
;

5236 
u64
 
curblock
;

5238 
qid
 = 
	`make_kqid_´ojid
(
´ojid
);

5239 
dquÙ
 = 
	`dqg‘
(
sb
, 
qid
);

5240 ià(
	`IS_ERR
(
dquÙ
))

5241  
	`PTR_ERR
(
dquÙ
);

5242 
	`¥š_lock
(&
dq_d©a_lock
);

5244 
lim™
 = (
dquÙ
->
dq_dqb
.
dqb_bsoálim™
 ?

5245 
dquÙ
->
dq_dqb
.
dqb_bsoálim™
 :

5246 
dquÙ
->
dq_dqb
.
dqb_bh¬dlim™
è>> 
sb
->
s_blocksize_b™s
;

5247 ià(
lim™
 && 
buf
->
f_blocks
 >†imit) {

5248 
curblock
 = 
dquÙ
->
dq_dqb
.
dqb_cur¥aû
 >> 
sb
->
s_blocksize_b™s
;

5249 
buf
->
f_blocks
 = 
lim™
;

5250 
buf
->
f_bä“
 = buf->
f_bava
 =

5251 (
buf
->
f_blocks
 > 
curblock
) ?

5252 (
buf
->
f_blocks
 - 
curblock
) : 0;

5255 
lim™
 = 
dquÙ
->
dq_dqb
.
dqb_isoálim™
 ?

5256 
dquÙ
->
dq_dqb
.
dqb_isoálim™
 :

5257 
dquÙ
->
dq_dqb
.
dqb_ih¬dlim™
;

5258 ià(
lim™
 && 
buf
->
f_fes
 >†imit) {

5259 
buf
->
f_fes
 = 
lim™
;

5260 
buf
->
f_fä“
 =

5261 (
buf
->
f_fes
 > 
dquÙ
->
dq_dqb
.
dqb_curšodes
) ?

5262 (
buf
->
f_fes
 - 
dquÙ
->
dq_dqb
.
dqb_curšodes
) : 0;

5265 
	`¥š_uÆock
(&
dq_d©a_lock
);

5266 
	`dqput
(
dquÙ
);

5268 
	}
}

5271 
	$ext4_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
)

5273 
su³r_block
 *
sb
 = 
d’Œy
->
d_sb
;

5274 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

5275 
ext4_su³r_block
 *
es
 = 
sbi
->
s_es
;

5276 
ext4_fsblk_t
 
ov”h—d
 = 0, 
»sv_blocks
;

5277 
u64
 
fsid
;

5278 
s64
 
bä“
;

5279 
»sv_blocks
 = 
	`EXT4_C2B
(
sbi
, 
	`©omic64_»ad
(&sbi->
s_»sv_şu¡”s
));

5281 ià(!
	`‹¡_İt
(
sb
, 
MINIX_DF
))

5282 
ov”h—d
 = 
sbi
->
s_ov”h—d
;

5284 
buf
->
f_ty³
 = 
EXT4_SUPER_MAGIC
;

5285 
buf
->
f_bsize
 = 
sb
->
s_blocksize
;

5286 
buf
->
f_blocks
 = 
	`ext4_blocks_couÁ
(
es
è- 
	`EXT4_C2B
(
sbi
, 
ov”h—d
);

5287 
bä“
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
s_ä“şu¡”s_couÁ”
) -

5288 
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
s_dœtyşu¡”s_couÁ”
);

5290 
buf
->
f_bä“
 = 
	`EXT4_C2B
(
sbi
, 
	`max_t
(
s64
, 
bä“
, 0));

5291 
buf
->
f_bava
 = buf->
f_bä“
 -

5292 (
	`ext4_r_blocks_couÁ
(
es
è+ 
»sv_blocks
);

5293 ià(
buf
->
f_bä“
 < (
	`ext4_r_blocks_couÁ
(
es
è+ 
»sv_blocks
))

5294 
buf
->
f_bava
 = 0;

5295 
buf
->
f_fes
 = 
	`Ë32_to_ıu
(
es
->
s_šodes_couÁ
);

5296 
buf
->
f_fä“
 = 
	`³rıu_couÁ”_sum_pos™ive
(&
sbi
->
s_ä“šodes_couÁ”
);

5297 
buf
->
f_Çm–’
 = 
EXT4_NAME_LEN
;

5298 
fsid
 = 
	`Ë64_to_ıup
((*)
es
->
s_uuid
) ^

5299 
	`Ë64_to_ıup
((*)
es
->
s_uuid
 + (
u64
));

5300 
buf
->
f_fsid
.
v®
[0] = 
fsid
 & 0xFFFFFFFFUL;

5301 
buf
->
f_fsid
.
v®
[1] = (
fsid
 >> 32) & 0xFFFFFFFFUL;

5303 #ifdeà
CONFIG_QUOTA


5304 ià(
	`ext4_‹¡_šode_æag
(
d’Œy
->
d_šode
, 
EXT4_INODE_PROJINHERIT
) &&

5305 
	`sb_has_quÙa_lim™s_’abËd
(
sb
, 
PRJQUOTA
))

5306 
	`ext4_¡©fs_´ojeù
(
sb
, 
	`EXT4_I
(
d’Œy
->
d_šode
)->
i_´ojid
, 
buf
);

5309 
	}
}

5321 #ifdeà
CONFIG_QUOTA


5323 
šlše
 
šode
 *
	$dquÙ_to_šode
(
dquÙ
 *dquot)

5325  
	`sb_dqİt
(
dquÙ
->
dq_sb
)->
fes
[dquÙ->
dq_id
.
ty³
];

5326 
	}
}

5328 
	$ext4_wr™e_dquÙ
(
dquÙ
 *dquot)

5330 
»t
, 
”r
;

5331 
hªdË_t
 *
hªdË
;

5332 
šode
 *inode;

5334 
šode
 = 
	`dquÙ_to_šode
(
dquÙ
);

5335 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
,

5336 
	`EXT4_QUOTA_TRANS_BLOCKS
(
dquÙ
->
dq_sb
));

5337 ià(
	`IS_ERR
(
hªdË
))

5338  
	`PTR_ERR
(
hªdË
);

5339 
»t
 = 
	`dquÙ_comm™
(
dquÙ
);

5340 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5341 ià(!
»t
)

5342 
»t
 = 
”r
;

5343  
»t
;

5344 
	}
}

5346 
	$ext4_acquœe_dquÙ
(
dquÙ
 *dquot)

5348 
»t
, 
”r
;

5349 
hªdË_t
 *
hªdË
;

5351 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
	`dquÙ_to_šode
(
dquÙ
), 
EXT4_HT_QUOTA
,

5352 
	`EXT4_QUOTA_INIT_BLOCKS
(
dquÙ
->
dq_sb
));

5353 ià(
	`IS_ERR
(
hªdË
))

5354  
	`PTR_ERR
(
hªdË
);

5355 
»t
 = 
	`dquÙ_acquœe
(
dquÙ
);

5356 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5357 ià(!
»t
)

5358 
»t
 = 
”r
;

5359  
»t
;

5360 
	}
}

5362 
	$ext4_»Ëa£_dquÙ
(
dquÙ
 *dquot)

5364 
»t
, 
”r
;

5365 
hªdË_t
 *
hªdË
;

5367 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
	`dquÙ_to_šode
(
dquÙ
), 
EXT4_HT_QUOTA
,

5368 
	`EXT4_QUOTA_DEL_BLOCKS
(
dquÙ
->
dq_sb
));

5369 ià(
	`IS_ERR
(
hªdË
)) {

5371 
	`dquÙ_»Ëa£
(
dquÙ
);

5372  
	`PTR_ERR
(
hªdË
);

5374 
»t
 = 
	`dquÙ_»Ëa£
(
dquÙ
);

5375 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5376 ià(!
»t
)

5377 
»t
 = 
”r
;

5378  
»t
;

5379 
	}
}

5381 
	$ext4_m¬k_dquÙ_dœty
(
dquÙ
 *dquot)

5383 
su³r_block
 *
sb
 = 
dquÙ
->
dq_sb
;

5384 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

5387 ià(
	`ext4_has_ã©u»_quÙa
(
sb
) ||

5388 
sbi
->
s_qf_Çmes
[
USRQUOTA
] || sbi->s_qf_Çmes[
GRPQUOTA
]) {

5389 
	`dquÙ_m¬k_dquÙ_dœty
(
dquÙ
);

5390  
	`ext4_wr™e_dquÙ
(
dquÙ
);

5392  
	`dquÙ_m¬k_dquÙ_dœty
(
dquÙ
);

5394 
	}
}

5396 
	$ext4_wr™e_šfo
(
su³r_block
 *
sb
, 
ty³
)

5398 
»t
, 
”r
;

5399 
hªdË_t
 *
hªdË
;

5402 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
	`d_šode
(
sb
->
s_roÙ
), 
EXT4_HT_QUOTA
, 2);

5403 ià(
	`IS_ERR
(
hªdË
))

5404  
	`PTR_ERR
(
hªdË
);

5405 
»t
 = 
	`dquÙ_comm™_šfo
(
sb
, 
ty³
);

5406 
”r
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

5407 ià(!
»t
)

5408 
»t
 = 
”r
;

5409  
»t
;

5410 
	}
}

5416 
	$ext4_quÙa_Ú_mouÁ
(
su³r_block
 *
sb
, 
ty³
)

5418  
	`dquÙ_quÙa_Ú_mouÁ
(
sb
, 
	`EXT4_SB
(sb)->
s_qf_Çmes
[
ty³
],

5419 
	`EXT4_SB
(
sb
)->
s_jquÙa_fmt
, 
ty³
);

5420 
	}
}

5422 
	$lockd•_£t_quÙa_šode
(
šode
 *šode, 
subşass
)

5424 
ext4_šode_šfo
 *
ei
 = 
	`EXT4_I
(
šode
);

5432 (è
ei
;

5433 
	`lockd•_£t_subşass
(&
ei
->
i_d©a_£m
, 
subşass
);

5434 
	}
}

5439 
	$ext4_quÙa_Ú
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

5440 cÚ¡ 
·th
 *path)

5442 
”r
;

5444 ià(!
	`‹¡_İt
(
sb
, 
QUOTA
))

5445  -
EINVAL
;

5448 ià(
·th
->
d’Œy
->
d_sb
 !ğ
sb
)

5449  -
EXDEV
;

5451 ià(
	`EXT4_SB
(
sb
)->
s_qf_Çmes
[
ty³
]) {

5453 ià(
·th
->
d’Œy
->
d_·»Á
 !ğ
sb
->
s_roÙ
)

5454 
	`ext4_msg
(
sb
, 
KERN_WARNING
,

5463 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
 &&

5464 
	`ext4_should_jouº®_d©a
(
	`d_šode
(
·th
->
d’Œy
))) {

5469 
	`jbd2_jouº®_lock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

5470 
”r
 = 
	`jbd2_jouº®_æush
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

5471 
	`jbd2_jouº®_uÆock_upd©es
(
	`EXT4_SB
(
sb
)->
s_jouº®
);

5472 ià(
”r
)

5473  
”r
;

5476 
	`lockd•_£t_quÙa_šode
(
·th
->
d’Œy
->
d_šode
, 
I_DATA_SEM_QUOTA
);

5477 
”r
 = 
	`dquÙ_quÙa_Ú
(
sb
, 
ty³
, 
fÜm©_id
, 
·th
);

5478 ià(
”r
) {

5479 
	`lockd•_£t_quÙa_šode
(
·th
->
d’Œy
->
d_šode
,

5480 
I_DATA_SEM_NORMAL
);

5482 
šode
 *šodğ
	`d_šode
(
·th
->
d’Œy
);

5483 
hªdË_t
 *
hªdË
;

5490 
	`šode_lock
(
šode
);

5491 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
, 1);

5492 ià(
	`IS_ERR
(
hªdË
))

5493 
uÆock_šode
;

5494 
	`EXT4_I
(
šode
)->
i_æags
 |ğ
EXT4_NOATIME_FL
 | 
EXT4_IMMUTABLE_FL
;

5495 
	`šode_£t_æags
(
šode
, 
S_NOATIME
 | 
S_IMMUTABLE
,

5496 
S_NOATIME
 | 
S_IMMUTABLE
);

5497 
	`ext4_fc_Œack_šode
(
šode
);

5498 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5499 
	`ext4_jouº®_¡İ
(
hªdË
);

5500 
uÆock_šode
:

5501 
	`šode_uÆock
(
šode
);

5503  
”r
;

5504 
	}
}

5506 
	$ext4_quÙa_’abË
(
su³r_block
 *
sb
, 
ty³
, 
fÜm©_id
,

5507 
æags
)

5509 
”r
;

5510 
šode
 *
qf_šode
;

5511 
qf_šums
[
EXT4_MAXQUOTAS
] = {

5512 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_u¤_quÙa_šum
),

5513 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_g½_quÙa_šum
),

5514 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_´j_quÙa_šum
)

5517 
	`BUG_ON
(!
	`ext4_has_ã©u»_quÙa
(
sb
));

5519 ià(!
qf_šums
[
ty³
])

5520  -
EPERM
;

5522 
qf_šode
 = 
	`ext4_ig‘
(
sb
, 
qf_šums
[
ty³
]);

5523 ià(
	`IS_ERR
(
qf_šode
)) {

5524 
	`ext4_”rÜ
(
sb
, "Bad quÙ¨šod# %lu", 
qf_šums
[
ty³
]);

5525  
	`PTR_ERR
(
qf_šode
);

5529 
qf_šode
->
i_æags
 |ğ
S_NOQUOTA
;

5530 
	`lockd•_£t_quÙa_šode
(
qf_šode
, 
I_DATA_SEM_QUOTA
);

5531 
”r
 = 
	`dquÙ_’abË
(
qf_šode
, 
ty³
, 
fÜm©_id
, 
æags
);

5532 
	`ut
(
qf_šode
);

5533 ià(
”r
)

5534 
	`lockd•_£t_quÙa_šode
(
qf_šode
, 
I_DATA_SEM_NORMAL
);

5536  
”r
;

5537 
	}
}

5540 
	$ext4_’abË_quÙas
(
su³r_block
 *
sb
)

5542 
ty³
, 
”r
 = 0;

5543 
qf_šums
[
EXT4_MAXQUOTAS
] = {

5544 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_u¤_quÙa_šum
),

5545 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_g½_quÙa_šum
),

5546 
	`Ë32_to_ıu
(
	`EXT4_SB
(
sb
)->
s_es
->
s_´j_quÙa_šum
)

5548 
boŞ
 
quÙa_mİt
[
EXT4_MAXQUOTAS
] = {

5549 
	`‹¡_İt
(
sb
, 
USRQUOTA
),

5550 
	`‹¡_İt
(
sb
, 
GRPQUOTA
),

5551 
	`‹¡_İt
(
sb
, 
PRJQUOTA
),

5554 
	`sb_dqİt
(
sb
)->
æags
 |ğ
DQUOT_QUOTA_SYS_FILE
;

5555 
ty³
 = 0;y³ < 
EXT4_MAXQUOTAS
;ype++) {

5556 ià(
qf_šums
[
ty³
]) {

5557 
”r
 = 
	`ext4_quÙa_’abË
(
sb
, 
ty³
, 
QFMT_VFS_V1
,

5558 
DQUOT_USAGE_ENABLED
 |

5559 (
quÙa_mİt
[
ty³
] ? 
DQUOT_LIMITS_ENABLED
 : 0));

5560 ià(
”r
) {

5561 
	`ext4_w¬nšg
(
sb
,

5564 "e2fsckØfix.", 
ty³
, 
”r
);

5565  
”r
;

5570 
	}
}

5572 
	$ext4_quÙa_off
(
su³r_block
 *
sb
, 
ty³
)

5574 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

5575 
hªdË_t
 *
hªdË
;

5576 
”r
;

5580 ià(
	`‹¡_İt
(
sb
, 
DELALLOC
))

5581 
	`sync_fesy¡em
(
sb
);

5583 ià(!
šode
 || !
	`ig¿b
(inode))

5584 
out
;

5586 
”r
 = 
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

5587 ià(
”r
 || 
	`ext4_has_ã©u»_quÙa
(
sb
))

5588 
out_put
;

5590 
	`šode_lock
(
šode
);

5596 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_QUOTA
, 1);

5597 ià(
	`IS_ERR
(
hªdË
))

5598 
out_uÆock
;

5599 
	`EXT4_I
(
šode
)->
i_æags
 &ğ~(
EXT4_NOATIME_FL
 | 
EXT4_IMMUTABLE_FL
);

5600 
	`šode_£t_æags
(
šode
, 0, 
S_NOATIME
 | 
S_IMMUTABLE
);

5601 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

5602 
	`ext4_fc_Œack_šode
(
šode
);

5603 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5604 
	`ext4_jouº®_¡İ
(
hªdË
);

5605 
out_uÆock
:

5606 
	`šode_uÆock
(
šode
);

5607 
out_put
:

5608 
	`lockd•_£t_quÙa_šode
(
šode
, 
I_DATA_SEM_NORMAL
);

5609 
	`ut
(
šode
);

5610  
”r
;

5611 
out
:

5612  
	`dquÙ_quÙa_off
(
sb
, 
ty³
);

5613 
	}
}

5619 
ssize_t
 
	$ext4_quÙa_»ad
(
su³r_block
 *
sb
, 
ty³
, *
d©a
,

5620 
size_t
 
Ën
, 
loff_t
 
off
)

5622 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

5623 
ext4_lblk_t
 
blk
 = 
off
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5624 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

5625 
tocİy
;

5626 
size_t
 
tÜ—d
;

5627 
bufãr_h—d
 *
bh
;

5628 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

5630 ià(
off
 > 
i_size
)

5632 ià(
off
+
Ën
 > 
i_size
)

5633 
Ën
 = 
i_size
-
off
;

5634 
tÜ—d
 = 
Ën
;

5635 
tÜ—d
 > 0) {

5636 
tocİy
 = 
sb
->
s_blocksize
 - 
off£t
 < 
tÜ—d
 ?

5637 
sb
->
s_blocksize
 - 
off£t
 : 
tÜ—d
;

5638 
bh
 = 
	`ext4_b»ad
(
NULL
, 
šode
, 
blk
, 0);

5639 ià(
	`IS_ERR
(
bh
))

5640  
	`PTR_ERR
(
bh
);

5641 ià(!
bh
)

5642 
	`mem£t
(
d©a
, 0, 
tocİy
);

5644 
	`memıy
(
d©a
, 
bh
->
b_d©a
+
off£t
, 
tocİy
);

5645 
	`b»l£
(
bh
);

5646 
off£t
 = 0;

5647 
tÜ—d
 -ğ
tocİy
;

5648 
d©a
 +ğ
tocİy
;

5649 
blk
++;

5651  
Ën
;

5652 
	}
}

5656 
ssize_t
 
	$ext4_quÙa_wr™e
(
su³r_block
 *
sb
, 
ty³
,

5657 cÚ¡ *
d©a
, 
size_t
 
Ën
, 
loff_t
 
off
)

5659 
šode
 *šodğ
	`sb_dqİt
(
sb
)->
fes
[
ty³
];

5660 
ext4_lblk_t
 
blk
 = 
off
 >> 
	`EXT4_BLOCK_SIZE_BITS
(
sb
);

5661 
”r
, 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

5662 
»Œ›s
 = 0;

5663 
bufãr_h—d
 *
bh
;

5664 
hªdË_t
 *
hªdË
 = 
	`jouº®_cu¼’t_hªdË
();

5666 ià(
	`EXT4_SB
(
sb
)->
s_jouº®
 && !
hªdË
) {

5667 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,†en=%llu)"

5669 ()
off
, ()
Ën
);

5670  -
EIO
;

5676 ià(
sb
->
s_blocksize
 - 
off£t
 < 
Ën
) {

5677 
	`ext4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,†en=%llu)"

5679 ()
off
, ()
Ën
);

5680  -
EIO
;

5684 
bh
 = 
	`ext4_b»ad
(
hªdË
, 
šode
, 
blk
,

5685 
EXT4_GET_BLOCKS_CREATE
 |

5686 
EXT4_GET_BLOCKS_METADATA_NOFAIL
);

5687 } 
	`IS_ERR
(
bh
è&& (
	`PTR_ERR
(bhè=ğ-
ENOSPC
) &&

5688 
	`ext4_should_»Œy_®loc
(
šode
->
i_sb
, &
»Œ›s
));

5689 ià(
	`IS_ERR
(
bh
))

5690  
	`PTR_ERR
(
bh
);

5691 ià(!
bh
)

5692 
out
;

5693 
	`BUFFER_TRACE
(
bh
, "get write‡ccess");

5694 
”r
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

5695 ià(
”r
) {

5696 
	`b»l£
(
bh
);

5697  
”r
;

5699 
	`lock_bufãr
(
bh
);

5700 
	`memıy
(
bh
->
b_d©a
+
off£t
, 
d©a
, 
Ën
);

5701 
	`æush_dÿche_·ge
(
bh
->
b_·ge
);

5702 
	`uÆock_bufãr
(
bh
);

5703 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

5704 
	`b»l£
(
bh
);

5705 
out
:

5706 ià(
šode
->
i_size
 < 
off
 + 
Ën
) {

5707 
	`ext4_fc_Œack_¿nge
(
šode
,

5708 
šode
->
i_size
 >> inode->
i_sb
->
s_blocksize_b™s
,

5709 (
off
 + 
Ën
è>> 
šode
->
i_sb
->
s_blocksize_b™s
);

5710 
	`i_size_wr™e
(
šode
, 
off
 + 
Ën
);

5711 
	`EXT4_I
(
šode
)->
i_disksize
 = inode->
i_size
;

5712 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

5714  
Ën
;

5715 
	}
}

5717 
	$ext4_g‘_Ãxt_id
(
su³r_block
 *
sb
, 
kqid
 *
qid
)

5719 cÚ¡ 
quÙa_fÜm©_İs
 *
İs
;

5721 ià(!
	`sb_has_quÙa_lßded
(
sb
, 
qid
->
ty³
))

5722  -
ESRCH
;

5723 
İs
 = 
	`sb_dqİt
(
sb
)->İs[
qid
->
ty³
];

5724 ià(!
İs
 || !İs->
g‘_Ãxt_id
)

5725  -
ENOSYS
;

5726  
	`dquÙ_g‘_Ãxt_id
(
sb
, 
qid
);

5727 
	}
}

5730 
d’Œy
 *
	$ext4_mouÁ
(
fe_sy¡em_ty³
 *
fs_ty³
, 
æags
,

5731 cÚ¡ *
dev_Çme
, *
d©a
)

5733  
	`mouÁ_bdev
(
fs_ty³
, 
æags
, 
dev_Çme
, 
d©a
, 
ext4_fl_su³r
);

5734 
	}
}

5736 #ià!
defšed
(
CONFIG_EXT2_FS
è&& !defšed(
CONFIG_EXT2_FS_MODULE
è&& defšed(
CONFIG_EXT4_USE_FOR_EXT2
)

5737 
šlše
 
	$»gi¡”_as_ext2
()

5739 
”r
 = 
	`»gi¡”_fesy¡em
(&
ext2_fs_ty³
);

5740 ià(
”r
)

5741 
	`´štk
(
KERN_WARNING


5742 "EXT4-fs: UÇbËØ»gi¡”‡ ext2 (%d)\n", 
”r
);

5743 
	}
}

5745 
šlše
 
	$uÄegi¡”_as_ext2
()

5747 
	`uÄegi¡”_fesy¡em
(&
ext2_fs_ty³
);

5748 
	}
}

5750 
šlše
 
	$ext2_ã©u»_£t_ok
(
su³r_block
 *
sb
)

5752 ià(
	`ext4_has_unknown_ext2_šcom·t_ã©u»s
(
sb
))

5754 ià(
sb
->
s_æags
 & 
MS_RDONLY
)

5756 ià(
	`ext4_has_unknown_ext2_ro_com·t_ã©u»s
(
sb
))

5759 
	}
}

5761 
šlše
 
	$»gi¡”_as_ext2
(è{ 
	}
}

5762 
šlše
 
	$uÄegi¡”_as_ext2
(è{ 
	}
}

5763 
šlše
 
	$ext2_ã©u»_£t_ok
(
su³r_block
 *
sb
è{  0; 
	}
}

5766 
šlše
 
	$»gi¡”_as_ext3
()

5768 
”r
 = 
	`»gi¡”_fesy¡em
(&
ext3_fs_ty³
);

5769 ià(
”r
)

5770 
	`´štk
(
KERN_WARNING


5771 "EXT4-fs: UÇbËØ»gi¡”‡ ext3 (%d)\n", 
”r
);

5772 
	}
}

5774 
šlše
 
	$uÄegi¡”_as_ext3
()

5776 
	`uÄegi¡”_fesy¡em
(&
ext3_fs_ty³
);

5777 
	}
}

5779 
šlše
 
	$ext3_ã©u»_£t_ok
(
su³r_block
 *
sb
)

5781 ià(
	`ext4_has_unknown_ext3_šcom·t_ã©u»s
(
sb
))

5783 ià(!
	`ext4_has_ã©u»_jouº®
(
sb
))

5785 ià(
sb
->
s_æags
 & 
MS_RDONLY
)

5787 ià(
	`ext4_has_unknown_ext3_ro_com·t_ã©u»s
(
sb
))

5790 
	}
}

5792 
fe_sy¡em_ty³
 
	gext4_fs_ty³
 = {

5793 .
owÃr
 = 
THIS_MODULE
,

5794 .
	gÇme
 = "orig_ext4_fc",

5795 .
	gmouÁ
 = 
ext4_mouÁ
,

5796 .
	gkl_sb
 = 
kl_block_su³r
,

5797 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

5799 
MODULE_ALIAS_FS
("ext4");

5802 
wa™_queue_h—d_t
 
	gext4__iÛnd_wq
[
EXT4_WQ_HASH_SZ
];

5804 
__š™
 
	$ext4_š™_fs
()

5806 
i
, 
”r
;

5808 
	`¿‹lim™_¡©e_š™
(&
ext4_mouÁ_msg_¿‹lim™
, 30 * 
HZ
, 64);

5809 
ext4_li_šfo
 = 
NULL
;

5810 
	`mu‹x_š™
(&
ext4_li_mtx
);

5813 
	`ext4_check_æag_v®ues
();

5815 
i
 = 0; i < 
EXT4_WQ_HASH_SZ
; i++)

5816 
	`š™_wa™queue_h—d
(&
ext4__iÛnd_wq
[
i
]);

5818 
”r
 = 
	`ext4_š™_es
();

5819 ià(
”r
)

5820  
”r
;

5822 
”r
 = 
	`ext4_š™_·geio
();

5823 ià(
”r
)

5824 
out5
;

5826 
”r
 = 
	`ext4_š™_sy¡em_zÚe
();

5827 ià(
”r
)

5828 
out4
;

5830 
”r
 = 
	`ext4_š™_sysfs
();

5831 ià(
”r
)

5832 
out3
;

5834 
”r
 = 
	`ext4_š™_mb®loc
();

5835 ià(
”r
)

5836 
out2
;

5837 
”r
 = 
	`š™_šodeÿche
();

5838 ià(
”r
)

5839 
out1
;

5841 
”r
 = 
	`ext4_š™_fc_d’Œy_ÿche
();

5842 ià(
”r
)

5843 
out05
;

5847 
”r
 = 
	`»gi¡”_fesy¡em
(&
ext4_fs_ty³
);

5848 ià(
”r
)

5849 
out
;

5852 
out
:

5855 
out05
:

5856 
	`de¡roy_šodeÿche
();

5857 
out1
:

5858 
	`ext4_ex™_mb®loc
();

5859 
out2
:

5861 
out3
:

5862 
	`ext4_ex™_sy¡em_zÚe
();

5863 
out4
:

5864 
	`ext4_ex™_·geio
();

5865 
out5
:

5866 
	`ext4_ex™_es
();

5868  
”r
;

5869 
	}
}

5871 
__ex™
 
	$ext4_ex™_fs
()

5873 
	`ext4_de¡roy_Ïzyš™_th»ad
();

5876 
	`uÄegi¡”_fesy¡em
(&
ext4_fs_ty³
);

5877 
	`de¡roy_šodeÿche
();

5878 
	`ext4_ex™_mb®loc
();

5879 
	`ext4_ex™_sysfs
();

5880 
	`ext4_ex™_sy¡em_zÚe
();

5881 
	`ext4_ex™_·geio
();

5882 
	`ext4_ex™_es
();

5883 
	}
}

5885 
MODULE_AUTHOR
("Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts'o‡nd others");

5886 
MODULE_DESCRIPTION
("Fourth Extended Filesystem");

5887 
MODULE_LICENSE
("GPL");

5888 
	$moduË_š™
(
ext4_š™_fs
)

5889 
	`moduË_ex™
(
ext4_ex™_fs
)

	@symlink.c

20 
	~<lšux/fs.h
>

21 
	~<lšux/Çmei.h
>

22 
	~"ext4.h
"

23 
	~"x©Œ.h
"

25 cÚ¡ *
	$ext4_’üy±ed_g‘_lšk
(
d’Œy
 *dentry,

26 
šode
 *inode,

27 
d–ayed_ÿÎ
 *
dÚe
)

29 
·ge
 *
ıage
 = 
NULL
;

30 *
ÿddr
, *
·ddr
 = 
NULL
;

31 
fsüy±_¡r
 
c¡r
, 
p¡r
;

32 
fsüy±_symlšk_d©a
 *
sd
;

33 
»s
;

34 
u32
 
max_size
 = 
šode
->
i_sb
->
s_blocksize
;

36 ià(!
d’Œy
)

37  
	`ERR_PTR
(-
ECHILD
);

39 
»s
 = 
	`fsüy±_g‘_’üy±iÚ_šfo
(
šode
);

40 ià(
»s
)

41  
	`ERR_PTR
(
»s
);

43 ià(
	`ext4_šode_is_ç¡_symlšk
(
šode
)) {

44 
ÿddr
 = (*è
	`EXT4_I
(
šode
)->
i_d©a
;

45 
max_size
 = (
	`EXT4_I
(
šode
)->
i_d©a
);

47 
ıage
 = 
	`»ad_m­pšg_·ge
(
šode
->
i_m­pšg
, 0, 
NULL
);

48 ià(
	`IS_ERR
(
ıage
))

49  
	`ERR_CAST
(
ıage
);

50 
ÿddr
 = 
	`·ge_add»ss
(
ıage
);

54 
sd
 = (
fsüy±_symlšk_d©a
 *)
ÿddr
;

55 
c¡r
.
Çme
 = 
sd
->
’üy±ed_·th
;

56 
c¡r
.
Ën
 = 
	`Ë16_to_ıu
(
sd
->len);

57 ià((
c¡r
.
Ën
 + (
fsüy±_symlšk_d©a
è- 1è> 
max_size
) {

59 
»s
 = -
EFSCORRUPTED
;

60 
”rout
;

63 
»s
 = 
	`fsüy±_âame_®loc_bufãr
(
šode
, 
c¡r
.
Ën
, &
p¡r
);

64 ià(
»s
)

65 
”rout
;

66 
·ddr
 = 
p¡r
.
Çme
;

68 
»s
 = 
	`fsüy±_âame_disk_to_u¤
(
šode
, 0, 0, &
c¡r
, &
p¡r
);

69 ià(
»s
)

70 
”rout
;

73 
·ddr
[
p¡r
.
Ën
] = '\0';

74 ià(
ıage
)

75 
	`put_·ge
(
ıage
);

76 
	`£t_d–ayed_ÿÎ
(
dÚe
, 
kä“_lšk
, 
·ddr
);

77  
·ddr
;

78 
”rout
:

79 ià(
ıage
)

80 
	`put_·ge
(
ıage
);

81 
	`kä“
(
·ddr
);

82  
	`ERR_PTR
(
»s
);

83 
	}
}

85 cÚ¡ 
šode_İ”©iÚs
 
	gext4_’üy±ed_symlšk_šode_İ”©iÚs
 = {

86 .
g‘_lšk
 = 
ext4_’üy±ed_g‘_lšk
,

87 .
	g£‰r
 = 
ext4_£‰r
,

88 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

89 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

92 cÚ¡ 
šode_İ”©iÚs
 
	gext4_symlšk_šode_İ”©iÚs
 = {

93 .
g‘_lšk
 = 
·ge_g‘_lšk
,

94 .
	g£‰r
 = 
ext4_£‰r
,

95 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

96 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

99 cÚ¡ 
šode_İ”©iÚs
 
	gext4_ç¡_symlšk_šode_İ”©iÚs
 = {

100 .
g‘_lšk
 = 
sim¶e_g‘_lšk
,

101 .
	g£‰r
 = 
ext4_£‰r
,

102 .
	gg‘©Œ
 = 
ext4_g‘©Œ
,

103 .
	gli¡x©Œ
 = 
ext4_li¡x©Œ
,

	@sysfs.c

10 
	~<lšux/time.h
>

11 
	~<lšux/fs.h
>

12 
	~<lšux/£q_fe.h
>

13 
	~<lšux/´oc_fs.h
>

15 
	~"ext4.h
"

16 
	~"ext4_jbd2.h
"

19 
	m©Œ_noİ
,

20 
	m©Œ_d–ayed_®loÿtiÚ_blocks
,

21 
	m©Œ_£ssiÚ_wr™e_kby‹s
,

22 
	m©Œ_liãtime_wr™e_kby‹s
,

23 
	m©Œ_»£rved_şu¡”s
,

24 
	m©Œ_šode_»adah—d
,

25 
	m©Œ_Œigg”_‹¡_”rÜ
,

26 
	m©Œ_ã©u»
,

27 
	m©Œ_poš‹r_ui
,

28 
	m©Œ_poš‹r_©omic
,

29 } 
	t©Œ_id_t
;

32 
	m±r_ex¶ic™
,

33 
	m±r_ext4_sb_šfo_off£t
,

34 
	m±r_ext4_su³r_block_off£t
,

35 } 
	t©Œ_±r_t
;

37 cÚ¡ 
	g´oc_dœÇme
[] = "fs/orig_ext4_fc";

38 
´oc_dœ_’Œy
 *
	gext4_´oc_roÙ
;

40 
	sext4_©Œ
 {

41 
©Œibu‹
 
	m©Œ
;

42 
	m©Œ_id
;

43 
	m©Œ_±r
;

45 
	moff£t
;

46 *
	mex¶ic™_±r
;

47 } 
	mu
;

50 
ssize_t
 
	$£ssiÚ_wr™e_kby‹s_show
(
ext4_©Œ
 *
a
,

51 
ext4_sb_šfo
 *
sbi
, *
buf
)

53 
su³r_block
 *
sb
 = 
sbi
->
s_buddy_ÿche
->
i_sb
;

55 ià(!
sb
->
s_bdev
->
bd_·¹
)

56  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "0\n");

57  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%lu\n",

58 (
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
, 
£ùÜs
[1]) -

59 
sbi
->
s_£ùÜs_wr™‹n_¡¬t
) >> 1);

60 
	}
}

62 
ssize_t
 
	$liãtime_wr™e_kby‹s_show
(
ext4_©Œ
 *
a
,

63 
ext4_sb_šfo
 *
sbi
, *
buf
)

65 
su³r_block
 *
sb
 = 
sbi
->
s_buddy_ÿche
->
i_sb
;

67 ià(!
sb
->
s_bdev
->
bd_·¹
)

68  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "0\n");

69  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

70 ()(
sbi
->
s_kby‹s_wr™‹n
 +

71 ((
	`·¹_¡©_»ad
(
sb
->
s_bdev
->
bd_·¹
, 
£ùÜs
[1]) -

72 
	`EXT4_SB
(
sb
)->
s_£ùÜs_wr™‹n_¡¬t
) >> 1)));

73 
	}
}

75 
ssize_t
 
	$šode_»adah—d_blks_¡Üe
(
ext4_©Œ
 *
a
,

76 
ext4_sb_šfo
 *
sbi
,

77 cÚ¡ *
buf
, 
size_t
 
couÁ
)

79 
t
;

80 
»t
;

82 
»t
 = 
	`k¡¹oul
(
	`sk_¥aûs
(
buf
), 0, &
t
);

83 ià(
»t
)

84  
»t
;

86 ià(
t
 && (!
	`is_pow”_of_2
(t) || > 0x40000000))

87  -
EINVAL
;

89 
sbi
->
s_šode_»adah—d_blks
 = 
t
;

90  
couÁ
;

91 
	}
}

93 
ssize_t
 
	$»£rved_şu¡”s_¡Üe
(
ext4_©Œ
 *
a
,

94 
ext4_sb_šfo
 *
sbi
,

95 cÚ¡ *
buf
, 
size_t
 
couÁ
)

97 
v®
;

98 
ext4_fsblk_t
 
şu¡”s
 = (
	`ext4_blocks_couÁ
(
sbi
->
s_es
) >>

99 
sbi
->
s_şu¡”_b™s
);

100 
»t
;

102 
»t
 = 
	`k¡¹ouÎ
(
	`sk_¥aûs
(
buf
), 0, &
v®
);

103 ià(
»t
 || 
v®
 >ğ
şu¡”s
)

104  -
EINVAL
;

106 
	`©omic64_£t
(&
sbi
->
s_»sv_şu¡”s
, 
v®
);

107  
couÁ
;

108 
	}
}

110 
ssize_t
 
	$Œigg”_‹¡_”rÜ
(
ext4_©Œ
 *
a
,

111 
ext4_sb_šfo
 *
sbi
,

112 cÚ¡ *
buf
, 
size_t
 
couÁ
)

114 
Ën
 = 
couÁ
;

116 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

117  -
EPERM
;

119 ià(
Ën
 && 
buf
[len-1] == '\n')

120 
Ën
--;

122 ià(
Ën
)

123 
	`ext4_”rÜ
(
sbi
->
s_sb
, "%.*s", 
Ën
, 
buf
);

124  
couÁ
;

125 
	}
}

127 
	#EXT4_ATTR
(
_Çme
,
_mode
,
_id
) \

128 
ext4_©Œ
 
ext4_©Œ_
##
_Çme
 = { \

129 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

130 .
©Œ_id
 = 
©Œ_
##
_id
, \

131 }

	)

133 
	#EXT4_ATTR_FUNC
(
_Çme
,
_mode
è
	`EXT4_ATTR
(_Çme,_mode,_Çme)

	)

135 
	#EXT4_ATTR_FEATURE
(
_Çme
è
	`EXT4_ATTR
(_Çme, 0444, 
ã©u»
)

	)

137 
	#EXT4_ATTR_OFFSET
(
_Çme
,
_mode
,
_id
,
_¡ruù
,
_–Çme
) \

138 
ext4_©Œ
 
ext4_©Œ_
##
_Çme
 = { \

139 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

140 .
©Œ_id
 = 
©Œ_
##
_id
, \

141 .
©Œ_±r
 = 
±r_
##
_¡ruù
##
_off£t
, \

142 .
u
 = { \

143 .
off£t
 = 
	`off£tof
(
_¡ruù
, 
_–Çme
),\

145 }

	)

147 
	#EXT4_RO_ATTR_ES_UI
(
_Çme
,
_–Çme
) \

148 
	`EXT4_ATTR_OFFSET
(
_Çme
, 0444, 
poš‹r_ui
, 
ext4_su³r_block
, 
_–Çme
)

	)

150 
	#EXT4_RW_ATTR_SBI_UI
(
_Çme
,
_–Çme
) \

151 
	`EXT4_ATTR_OFFSET
(
_Çme
, 0644, 
poš‹r_ui
, 
ext4_sb_šfo
, 
_–Çme
)

	)

153 
	#EXT4_ATTR_PTR
(
_Çme
,
_mode
,
_id
,
_±r
) \

154 
ext4_©Œ
 
ext4_©Œ_
##
_Çme
 = { \

155 .
©Œ
 = {.
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

156 .
©Œ_id
 = 
©Œ_
##
_id
, \

157 .
©Œ_±r
 = 
±r_ex¶ic™
, \

158 .
u
 = { \

159 .
ex¶ic™_±r
 = 
_±r
, \

161 }

	)

163 
	#ATTR_LIST
(
Çme
è&
ext4_©Œ_
##Çme.
©Œ


	)

165 
EXT4_ATTR_FUNC
(
d–ayed_®loÿtiÚ_blocks
, 0444);

166 
EXT4_ATTR_FUNC
(
£ssiÚ_wr™e_kby‹s
, 0444);

167 
EXT4_ATTR_FUNC
(
liãtime_wr™e_kby‹s
, 0444);

168 
EXT4_ATTR_FUNC
(
»£rved_şu¡”s
, 0644);

170 
EXT4_ATTR_OFFSET
(
šode_»adah—d_blks
, 0644, 
šode_»adah—d
,

171 
ext4_sb_šfo
, 
s_šode_»adah—d_blks
);

172 
EXT4_RW_ATTR_SBI_UI
(
šode_gßl
, 
s_šode_gßl
);

173 
EXT4_RW_ATTR_SBI_UI
(
mb_¡©s
, 
s_mb_¡©s
);

174 
EXT4_RW_ATTR_SBI_UI
(
mb_max_to_sÿn
, 
s_mb_max_to_sÿn
);

175 
EXT4_RW_ATTR_SBI_UI
(
mb_mš_to_sÿn
, 
s_mb_mš_to_sÿn
);

176 
EXT4_RW_ATTR_SBI_UI
(
mb_Üd”2_»q
, 
s_mb_Üd”2_»qs
);

177 
EXT4_RW_ATTR_SBI_UI
(
mb_¡»am_»q
, 
s_mb_¡»am_»que¡
);

178 
EXT4_RW_ATTR_SBI_UI
(
mb_group_´—Îoc
, 
s_mb_group_´—Îoc
);

179 
EXT4_RW_ATTR_SBI_UI
(
ex‹Á_max_z”oout_kb
, 
s_ex‹Á_max_z”oout_kb
);

180 
EXT4_ATTR
(
Œigg”_fs_”rÜ
, 0200, 
Œigg”_‹¡_”rÜ
);

181 
EXT4_RW_ATTR_SBI_UI
(
”r_¿‹lim™_š‹rv®_ms
, 
s_”r_¿‹lim™_¡©e
.
š‹rv®
);

182 
EXT4_RW_ATTR_SBI_UI
(
”r_¿‹lim™_bur¡
, 
s_”r_¿‹lim™_¡©e
.
bur¡
);

183 
EXT4_RW_ATTR_SBI_UI
(
w¬nšg_¿‹lim™_š‹rv®_ms
, 
s_w¬nšg_¿‹lim™_¡©e
.
š‹rv®
);

184 
EXT4_RW_ATTR_SBI_UI
(
w¬nšg_¿‹lim™_bur¡
, 
s_w¬nšg_¿‹lim™_¡©e
.
bur¡
);

185 
EXT4_RW_ATTR_SBI_UI
(
msg_¿‹lim™_š‹rv®_ms
, 
s_msg_¿‹lim™_¡©e
.
š‹rv®
);

186 
EXT4_RW_ATTR_SBI_UI
(
msg_¿‹lim™_bur¡
, 
s_msg_¿‹lim™_¡©e
.
bur¡
);

187 
EXT4_RO_ATTR_ES_UI
(
”rÜs_couÁ
, 
s_”rÜ_couÁ
);

188 
EXT4_RO_ATTR_ES_UI
(
fœ¡_”rÜ_time
, 
s_fœ¡_”rÜ_time
);

189 
EXT4_RO_ATTR_ES_UI
(
Ï¡_”rÜ_time
, 
s_Ï¡_”rÜ_time
);

191 
	gŞd_bump_v®
 = 128;

192 
EXT4_ATTR_PTR
(
max_wr™eback_mb_bump
, 0444, 
poš‹r_ui
, &
Şd_bump_v®
);

194 
©Œibu‹
 *
	gext4_©Œs
[] = {

195 
ATTR_LIST
(
d–ayed_®loÿtiÚ_blocks
),

196 
ATTR_LIST
(
£ssiÚ_wr™e_kby‹s
),

197 
ATTR_LIST
(
liãtime_wr™e_kby‹s
),

198 
ATTR_LIST
(
»£rved_şu¡”s
),

199 
ATTR_LIST
(
šode_»adah—d_blks
),

200 
ATTR_LIST
(
šode_gßl
),

201 
ATTR_LIST
(
mb_¡©s
),

202 
ATTR_LIST
(
mb_max_to_sÿn
),

203 
ATTR_LIST
(
mb_mš_to_sÿn
),

204 
ATTR_LIST
(
mb_Üd”2_»q
),

205 
ATTR_LIST
(
mb_¡»am_»q
),

206 
ATTR_LIST
(
mb_group_´—Îoc
),

207 
ATTR_LIST
(
max_wr™eback_mb_bump
),

208 
ATTR_LIST
(
ex‹Á_max_z”oout_kb
),

209 
ATTR_LIST
(
Œigg”_fs_”rÜ
),

210 
ATTR_LIST
(
”r_¿‹lim™_š‹rv®_ms
),

211 
ATTR_LIST
(
”r_¿‹lim™_bur¡
),

212 
ATTR_LIST
(
w¬nšg_¿‹lim™_š‹rv®_ms
),

213 
ATTR_LIST
(
w¬nšg_¿‹lim™_bur¡
),

214 
ATTR_LIST
(
msg_¿‹lim™_š‹rv®_ms
),

215 
ATTR_LIST
(
msg_¿‹lim™_bur¡
),

216 
ATTR_LIST
(
”rÜs_couÁ
),

217 
ATTR_LIST
(
fœ¡_”rÜ_time
),

218 
ATTR_LIST
(
Ï¡_”rÜ_time
),

219 
NULL
,

223 
EXT4_ATTR_FEATURE
(
Ïzy_™abË_š™
);

224 
EXT4_ATTR_FEATURE
(
b©ched_disÿrd
);

225 
EXT4_ATTR_FEATURE
(
m‘a_bg_»size
);

226 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


227 
EXT4_ATTR_FEATURE
(
’üy±iÚ
);

229 
EXT4_ATTR_FEATURE
(
m‘ad©a_csum_£ed
);

231 
©Œibu‹
 *
	gext4_ã©_©Œs
[] = {

232 
ATTR_LIST
(
Ïzy_™abË_š™
),

233 
ATTR_LIST
(
b©ched_disÿrd
),

234 
ATTR_LIST
(
m‘a_bg_»size
),

235 #ifdeà
CONFIG_EXT4_FS_ENCRYPTION


236 
ATTR_LIST
(
’üy±iÚ
),

238 
ATTR_LIST
(
m‘ad©a_csum_£ed
),

239 
NULL
,

242 *
	$ÿlc_±r
(
ext4_©Œ
 *
a
, 
ext4_sb_šfo
 *
sbi
)

244 
a
->
©Œ_±r
) {

245 
±r_ex¶ic™
:

246  
a
->
u
.
ex¶ic™_±r
;

247 
±r_ext4_sb_šfo_off£t
:

248  (*è(((*è
sbi
è+ 
a
->
u
.
off£t
);

249 
±r_ext4_su³r_block_off£t
:

250  (*è(((*è
sbi
->
s_es
è+ 
a
->
u
.
off£t
);

252  
NULL
;

253 
	}
}

255 
ssize_t
 
	$ext4_©Œ_show
(
kobjeù
 *
kobj
,

256 
©Œibu‹
 *
©Œ
, *
buf
)

258 
ext4_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, ext4_sb_info,

259 
s_kobj
);

260 
ext4_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, ext4_attr,‡ttr);

261 *
±r
 = 
	`ÿlc_±r
(
a
, 
sbi
);

263 
a
->
©Œ_id
) {

264 
©Œ_d–ayed_®loÿtiÚ_blocks
:

265  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

266 (
s64
è
	`EXT4_C2B
(
sbi
,

267 
	`³rıu_couÁ”_sum
(&
sbi
->
s_dœtyşu¡”s_couÁ”
)));

268 
©Œ_£ssiÚ_wr™e_kby‹s
:

269  
	`£ssiÚ_wr™e_kby‹s_show
(
a
, 
sbi
, 
buf
);

270 
©Œ_liãtime_wr™e_kby‹s
:

271  
	`liãtime_wr™e_kby‹s_show
(
a
, 
sbi
, 
buf
);

272 
©Œ_»£rved_şu¡”s
:

273  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%llu\n",

275 
	`©omic64_»ad
(&
sbi
->
s_»sv_şu¡”s
));

276 
©Œ_šode_»adah—d
:

277 
©Œ_poš‹r_ui
:

278 ià(!
±r
)

280  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n",

281 *((*è
±r
));

282 
©Œ_poš‹r_©omic
:

283 ià(!
±r
)

285  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%d\n",

286 
	`©omic_»ad
((
©omic_t
 *è
±r
));

287 
©Œ_ã©u»
:

288  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "supported\n");

292 
	}
}

294 
ssize_t
 
	$ext4_©Œ_¡Üe
(
kobjeù
 *
kobj
,

295 
©Œibu‹
 *
©Œ
,

296 cÚ¡ *
buf
, 
size_t
 
Ën
)

298 
ext4_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, ext4_sb_info,

299 
s_kobj
);

300 
ext4_©Œ
 *
a
 = 
	`cÚš”_of
(
©Œ
, ext4_attr,‡ttr);

301 *
±r
 = 
	`ÿlc_±r
(
a
, 
sbi
);

302 
t
;

303 
»t
;

305 
a
->
©Œ_id
) {

306 
©Œ_»£rved_şu¡”s
:

307  
	`»£rved_şu¡”s_¡Üe
(
a
, 
sbi
, 
buf
, 
Ën
);

308 
©Œ_poš‹r_ui
:

309 ià(!
±r
)

311 
»t
 = 
	`k¡¹oul
(
	`sk_¥aûs
(
buf
), 0, &
t
);

312 ià(
»t
)

313  
»t
;

314 *((*è
±r
èğ
t
;

315  
Ën
;

316 
©Œ_šode_»adah—d
:

317  
	`šode_»adah—d_blks_¡Üe
(
a
, 
sbi
, 
buf
, 
Ën
);

318 
©Œ_Œigg”_‹¡_”rÜ
:

319  
	`Œigg”_‹¡_”rÜ
(
a
, 
sbi
, 
buf
, 
Ën
);

322 
	}
}

324 
	$ext4_sb_»Ëa£
(
kobjeù
 *
kobj
)

326 
ext4_sb_šfo
 *
sbi
 = 
	`cÚš”_of
(
kobj
, ext4_sb_info,

327 
s_kobj
);

328 
	`com¶‘e
(&
sbi
->
s_kobj_uÄegi¡”
);

329 
	}
}

331 cÚ¡ 
sysfs_İs
 
	gext4_©Œ_İs
 = {

332 .
show
 = 
ext4_©Œ_show
,

333 .
	g¡Üe
 = 
ext4_©Œ_¡Üe
,

336 
kobj_ty³
 
	gext4_sb_kty³
 = {

337 .
deçuÉ_©Œs
 = 
ext4_©Œs
,

338 .
	gsysfs_İs
 = &
ext4_©Œ_İs
,

339 .
	g»Ëa£
 = 
ext4_sb_»Ëa£
,

342 
kobj_ty³
 
	gext4_kty³
 = {

343 .
sysfs_İs
 = &
ext4_©Œ_İs
,

346 
k£t
 
	gext4_k£t
 = {

347 .
kobj
 = {.
kty³
 = &
ext4_kty³
},

350 
kobj_ty³
 
	gext4_ã©_kty³
 = {

351 .
deçuÉ_©Œs
 = 
ext4_ã©_©Œs
,

352 .
	gsysfs_İs
 = &
ext4_©Œ_İs
,

355 
kobjeù
 
	gext4_ã©
 = {

356 .
k£t
 = &
ext4_k£t
,

359 
	#PROC_FILE_SHOW_DEFN
(
Çme
) \

360 
Çme
##
	`_İ’
(
šode
 *šode, 
fe
 *file) \

362  
	`sšgË_İ’
(
fe
, 
ext4_£q_
##
Çme
##
_show
, 
	`PDE_DATA
(
šode
)); \

365 cÚ¡ 
fe_İ”©iÚs
 
ext4_£q_
##
Çme
##
_fİs
 = { \

366 .
İ’
 = 
Çme
##
_İ’
, \

367 .
»ad
 = 
£q_»ad
, \

368 .
Î£ek
 = 
£q_l£ek
, \

369 .
»Ëa£
 = 
sšgË_»Ëa£
, \

370 }

	)

372 
	#PROC_FILE_LIST
(
Çme
) \

373 { 
	`__¡ršgify
(
Çme
), &
ext4_£q_
##Çme##
_fİs
 }

	)

375 
PROC_FILE_SHOW_DEFN
(
es_shršk”_šfo
);

376 
PROC_FILE_SHOW_DEFN
(
İtiÚs
);

378 cÚ¡ 
	sext4_´oc_fes
 {

379 cÚ¡ *
	mÇme
;

380 cÚ¡ 
fe_İ”©iÚs
 *
	mfİs
;

381 } 
	g´oc_fes
[] = {

382 
PROC_FILE_LIST
(
İtiÚs
),

383 
PROC_FILE_LIST
(
es_shršk”_šfo
),

384 
PROC_FILE_LIST
(
mb_groups
),

385 { 
NULL
, NULL },

388 
	$ext4_»gi¡”_sysfs
(
su³r_block
 *
sb
)

390 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

391 cÚ¡ 
ext4_´oc_fes
 *
p
;

392 
”r
;

394 
sbi
->
s_kobj
.
k£t
 = &
ext4_k£t
;

395 
	`š™_com¶‘iÚ
(&
sbi
->
s_kobj_uÄegi¡”
);

396 
”r
 = 
	`kobjeù_š™_ªd_add
(&
sbi
->
s_kobj
, &
ext4_sb_kty³
, 
NULL
,

397 "%s", 
sb
->
s_id
);

398 ià(
”r
)

399  
”r
;

401 ià(
ext4_´oc_roÙ
)

402 
sbi
->
s_´oc
 = 
	`´oc_mkdœ
(
sb
->
s_id
, 
ext4_´oc_roÙ
);

404 ià(
sbi
->
s_´oc
) {

405 
p
 = 
´oc_fes
;…->
Çme
;…++)

406 
	`´oc_ü—‹_d©a
(
p
->
Çme
, 
S_IRUGO
, 
sbi
->
s_´oc
,

407 
p
->
fİs
, 
sb
);

410 
	}
}

412 
	$ext4_uÄegi¡”_sysfs
(
su³r_block
 *
sb
)

414 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
sb
);

415 cÚ¡ 
ext4_´oc_fes
 *
p
;

417 ià(
sbi
->
s_´oc
) {

418 
p
 = 
´oc_fes
;…->
Çme
;…++)

419 
	`»move_´oc_’Œy
(
p
->
Çme
, 
sbi
->
s_´oc
);

420 
	`»move_´oc_’Œy
(
sb
->
s_id
, 
ext4_´oc_roÙ
);

422 
	`kobjeù_d–
(&
sbi
->
s_kobj
);

423 
	}
}

425 
__š™
 
	$ext4_š™_sysfs
()

427 
»t
;

429 
	`kobjeù_£t_Çme
(&
ext4_k£t
.
kobj
, "orig_ext4_fc");

430 
ext4_k£t
.
kobj
.
·»Á
 = 
fs_kobj
;

431 
»t
 = 
	`k£t_»gi¡”
(&
ext4_k£t
);

432 ià(
»t
)

433  
»t
;

435 
»t
 = 
	`kobjeù_š™_ªd_add
(&
ext4_ã©
, &
ext4_ã©_kty³
,

436 
NULL
, "features");

437 ià(
»t
)

438 
	`k£t_uÄegi¡”
(&
ext4_k£t
);

440 
ext4_´oc_roÙ
 = 
	`´oc_mkdœ
(
´oc_dœÇme
, 
NULL
);

441  
»t
;

442 
	}
}

444 
	$ext4_ex™_sysfs
()

446 
	`kobjeù_put
(&
ext4_ã©
);

447 
	`k£t_uÄegi¡”
(&
ext4_k£t
);

448 
	`»move_´oc_’Œy
(
´oc_dœÇme
, 
NULL
);

449 
ext4_´oc_roÙ
 = 
NULL
;

450 
	}
}

	@truncate.h

11 
šlše
 
	$ext4_Œunÿ‹_çed_wr™e
(
šode
 *inode)

13 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

14 
	`Œunÿ‹_šode_·ges
(
šode
->
i_m­pšg
, inode->
i_size
);

15 
	`ext4_Œunÿ‹
(
šode
);

16 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
i_mm­_£m
);

17 
	}
}

23 
šlše
 
	$ext4_blocks_fÜ_Œunÿ‹
(
šode
 *inode)

25 
ext4_lblk_t
 
Ãeded
;

27 
Ãeded
 = 
šode
->
i_blocks
 >> (šode->
i_sb
->
s_blocksize_b™s
 - 9);

35 ià(
Ãeded
 < 2)

36 
Ãeded
 = 2;

40 ià(
Ãeded
 > 
EXT4_MAX_TRANS_DATA
)

41 
Ãeded
 = 
EXT4_MAX_TRANS_DATA
;

43  
	`EXT4_DATA_TRANS_BLOCKS
(
šode
->
i_sb
è+ 
Ãeded
;

44 
	}
}

	@xattr.c

53 
	~<lšux/š™.h
>

54 
	~<lšux/fs.h
>

55 
	~<lšux/¦ab.h
>

56 
	~<lšux/mbÿche.h
>

57 
	~<lšux/quÙaİs.h
>

58 
	~"ext4_jbd2.h
"

59 
	~"ext4.h
"

60 
	~"x©Œ.h
"

61 
	~"aş.h
"

63 #ifdeà
EXT4_XATTR_DEBUG


64 
	#—_idebug
(
šode
, 
fmt
, ...) \

65 
	`´štk
(
KERN_DEBUG
 "šod%s:%lu: " 
fmt
 "\n", \

66 
šode
->
i_sb
->
s_id
, inode->
i_šo
, ##
__VA_ARGS__
)

	)

67 
	#—_bdebug
(
bh
, 
fmt
, ...) \

68 
	`´štk
(
KERN_DEBUG
 "block %pg:%lu: " 
fmt
 "\n", \

69 
bh
->
b_bdev
, ()bh->
b_blockÄ
, ##
__VA_ARGS__
)

	)

71 
	#—_idebug
(
šode
, 
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

72 
	#—_bdebug
(
bh
, 
fmt
, ...è
	`no_´štk
(fmt, ##
__VA_ARGS__
)

	)

75 
ext4_x©Œ_block_ÿche_š£¹
(
mb_ÿche
 *,

76 
bufãr_h—d
 *);

77 
bufãr_h—d
 *

78 
ext4_x©Œ_block_ÿche_fšd
(
šode
 *, 
ext4_x©Œ_h—d”
 *,

79 
mb_ÿche_’Œy
 **);

80 
__Ë32
 
ext4_x©Œ_hash_’Œy
(*
Çme
, 
size_t
 
Çme_Ën
, __Ë32 *
v®ue
,

81 
size_t
 
v®ue_couÁ
);

82 
ext4_x©Œ_»hash
(
ext4_x©Œ_h—d”
 *);

84 cÚ¡ 
x©Œ_hªdËr
 * cÚ¡ 
	gext4_x©Œ_hªdËr_m­
[] = {

85 [
EXT4_XATTR_INDEX_USER
] = &
ext4_x©Œ_u£r_hªdËr
,

86 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


87 [
EXT4_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_aş_acûss_x©Œ_hªdËr
,

88 [
EXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_aş_deçuÉ_x©Œ_hªdËr
,

90 [
EXT4_XATTR_INDEX_TRUSTED
] = &
ext4_x©Œ_Œu¡ed_hªdËr
,

91 #ifdeà
CONFIG_EXT4_FS_SECURITY


92 [
EXT4_XATTR_INDEX_SECURITY
] = &
ext4_x©Œ_£cur™y_hªdËr
,

96 cÚ¡ 
x©Œ_hªdËr
 *
	gext4_x©Œ_hªdËrs
[] = {

97 &
ext4_x©Œ_u£r_hªdËr
,

98 &
ext4_x©Œ_Œu¡ed_hªdËr
,

99 #ifdeà
CONFIG_EXT4_FS_POSIX_ACL


100 &
posix_aş_acûss_x©Œ_hªdËr
,

101 &
posix_aş_deçuÉ_x©Œ_hªdËr
,

103 #ifdeà
CONFIG_EXT4_FS_SECURITY


104 &
ext4_x©Œ_£cur™y_hªdËr
,

106 
NULL


109 
	#EA_BLOCK_CACHE
(
šode
è(((
ext4_sb_šfo
 *) \

110 
šode
->
i_sb
->
s_fs_šfo
)->
s_—_block_ÿche
)

	)

112 
	#EA_INODE_CACHE
(
šode
è(((
ext4_sb_šfo
 *) \

113 
šode
->
i_sb
->
s_fs_šfo
)->
s_—_šode_ÿche
)

	)

116 
ext4_ex·nd_šode_¬¿y
(
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

117 
šode
 *inode);

119 #ifdeà
CONFIG_LOCKDEP


120 
	$ext4_x©Œ_šode_£t_şass
(
šode
 *
—_šode
)

122 
	`lockd•_£t_subşass
(&
—_šode
->
i_rw£m
, 1);

123 
	}
}

126 
__Ë32
 
	$ext4_x©Œ_block_csum
(
šode
 *inode,

127 
£ùÜ_t
 
block_Ä
,

128 
ext4_x©Œ_h—d”
 *
hdr
)

130 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

131 
__u32
 
csum
;

132 
__Ë64
 
dsk_block_Ä
 = 
	`ıu_to_Ë64
(
block_Ä
);

133 
__u32
 
dummy_csum
 = 0;

134 
off£t
 = 
	`off£tof
(
ext4_x©Œ_h—d”
, 
h_checksum
);

136 
csum
 = 
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
dsk_block_Ä
,

137 (
dsk_block_Ä
));

138 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
, 
off£t
);

139 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

140 
off£t
 +ğ(
dummy_csum
);

141 
csum
 = 
	`ext4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
 + 
off£t
,

142 
	`EXT4_BLOCK_SIZE
(
šode
->
i_sb
è- 
off£t
);

144  
	`ıu_to_Ë32
(
csum
);

145 
	}
}

147 
	$ext4_x©Œ_block_csum_v”ify
(
šode
 *inode,

148 
bufãr_h—d
 *
bh
)

150 
ext4_x©Œ_h—d”
 *
hdr
 = 
	`BHDR
(
bh
);

151 
»t
 = 1;

153 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
)) {

154 
	`lock_bufãr
(
bh
);

155 
»t
 = (
hdr
->
h_checksum
 =ğ
	`ext4_x©Œ_block_csum
(
šode
,

156 
bh
->
b_blockÄ
, 
hdr
));

157 
	`uÆock_bufãr
(
bh
);

159  
»t
;

160 
	}
}

162 
	$ext4_x©Œ_block_csum_£t
(
šode
 *inode,

163 
bufãr_h—d
 *
bh
)

165 ià(
	`ext4_has_m‘ad©a_csum
(
šode
->
i_sb
))

166 
	`BHDR
(
bh
)->
h_checksum
 = 
	`ext4_x©Œ_block_csum
(
šode
,

167 
bh
->
b_blockÄ
, 
	`BHDR
(bh));

168 
	}
}

170 
šlše
 cÚ¡ 
x©Œ_hªdËr
 *

171 
	$ext4_x©Œ_hªdËr
(
Çme_šdex
)

173 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 = 
NULL
;

175 ià(
Çme_šdex
 > 0 &&‚ame_šdex < 
	`ARRAY_SIZE
(
ext4_x©Œ_hªdËr_m­
))

176 
hªdËr
 = 
ext4_x©Œ_hªdËr_m­
[
Çme_šdex
];

177  
hªdËr
;

178 
	}
}

181 
	$ext4_x©Œ_check_’Œ›s
(
ext4_x©Œ_’Œy
 *
’Œy
, *
’d
,

182 *
v®ue_¡¬t
)

184 
ext4_x©Œ_’Œy
 *
e
 = 
’Œy
;

187 !
	`IS_LAST_ENTRY
(
e
)) {

188 
ext4_x©Œ_’Œy
 *
Ãxt
 = 
	`EXT4_XATTR_NEXT
(
e
);

189 ià((*)
Ãxt
 >ğ
’d
)

190  -
EFSCORRUPTED
;

191 
e
 = 
Ãxt
;

195 !
	`IS_LAST_ENTRY
(
’Œy
)) {

196 ià(
’Œy
->
e_v®ue_size
 != 0 &&

197 
’Œy
->
e_v®ue_šum
 == 0) {

198 
u16
 
offs
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

199 
u32
 
size
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
);

200 *
v®ue
;

208 ià(
offs
 > 
’d
 - 
v®ue_¡¬t
)

209  -
EFSCORRUPTED
;

210 
v®ue
 = 
v®ue_¡¬t
 + 
offs
;

211 ià(
v®ue
 < (*)
e
 + (
u32
) ||

212 
size
 > 
’d
 - 
v®ue
 ||

213 
	`EXT4_XATTR_SIZE
(
size
è> 
’d
 - 
v®ue
)

214  -
EFSCORRUPTED
;

216 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry);

220 
	}
}

222 
šlše
 

223 
	$ext4_x©Œ_check_block
(
šode
 *šode, 
bufãr_h—d
 *
bh
)

225 
”rÜ
;

227 ià(
	`bufãr_v”if›d
(
bh
))

230 ià(
	`BHDR
(
bh
)->
h_magic
 !ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
) ||

231 
	`BHDR
(
bh
)->
h_blocks
 !ğ
	`ıu_to_Ë32
(1))

232  -
EFSCORRUPTED
;

233 ià(!
	`ext4_x©Œ_block_csum_v”ify
(
šode
, 
bh
))

234  -
EFSBADCRC
;

235 
”rÜ
 = 
	`ext4_x©Œ_check_’Œ›s
(
	`BFIRST
(
bh
), bh->
b_d©a
 + bh->
b_size
,

236 
bh
->
b_d©a
);

237 ià(!
”rÜ
)

238 
	`£t_bufãr_v”if›d
(
bh
);

239  
”rÜ
;

240 
	}
}

243 
	$__x©Œ_check_šode
(
šode
 *šode, 
ext4_x©Œ_ibody_h—d”
 *
h—d”
,

244 *
’d
, cÚ¡ *
funùiÚ
, 
lše
)

246 
”rÜ
 = -
EFSCORRUPTED
;

248 ià(
’d
 - (*)
h—d”
 < (*h—d”è+ (
u32
) ||

249 (
h—d”
->
h_magic
 !ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
)))

250 
”rout
;

251 
”rÜ
 = 
	`ext4_x©Œ_check_’Œ›s
(
	`IFIRST
(
h—d”
), 
’d
, IFIRST(header));

252 
”rout
:

253 ià(
”rÜ
)

254 
	`__ext4_”rÜ_šode
(
šode
, 
funùiÚ
, 
lše
, 0,

256  
”rÜ
;

257 
	}
}

259 
	#x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
) \

260 
	`__x©Œ_check_šode
((
šode
), (
h—d”
), (
’d
), 
__func__
, 
__LINE__
)

	)

263 
	$ext4_x©Œ_fšd_’Œy
(
ext4_x©Œ_’Œy
 **
³Áry
, 
Çme_šdex
,

264 cÚ¡ *
Çme
, 
sÜ‹d
)

266 
ext4_x©Œ_’Œy
 *
’Œy
;

267 
size_t
 
Çme_Ën
;

268 
cmp
 = 1;

270 ià(
Çme
 =ğ
NULL
)

271  -
EINVAL
;

272 
Çme_Ën
 = 
	`¡¾’
(
Çme
);

273 
’Œy
 = *
³Áry
;

274 ; !
	`IS_LAST_ENTRY
(
’Œy
);ƒÁry = 
	`EXT4_XATTR_NEXT
(entry)) {

275 
cmp
 = 
Çme_šdex
 - 
’Œy
->
e_Çme_šdex
;

276 ià(!
cmp
)

277 
cmp
 = 
Çme_Ën
 - 
’Œy
->
e_Çme_Ën
;

278 ià(!
cmp
)

279 
cmp
 = 
	`memcmp
(
Çme
, 
’Œy
->
e_Çme
, 
Çme_Ën
);

280 ià(
cmp
 <ğ0 && (
sÜ‹d
 || cmp == 0))

283 *
³Áry
 = 
’Œy
;

284  
cmp
 ? -
ENODATA
 : 0;

285 
	}
}

287 
u32


288 
	$ext4_x©Œ_šode_hash
(
ext4_sb_šfo
 *
sbi
, cÚ¡ *
bufãr
, 
size_t
 
size
)

290  
	`ext4_chksum
(
sbi
, sbi->
s_csum_£ed
, 
bufãr
, 
size
);

291 
	}
}

293 
u64
 
	$ext4_x©Œ_šode_g‘_»f
(
šode
 *
—_šode
)

295  ((
u64
)
—_šode
->
i_ùime
.
tv_£c
 << 32) |

296 ((
u32
)
—_šode
->
i_v”siÚ
);

297 
	}
}

299 
	$ext4_x©Œ_šode_£t_»f
(
šode
 *
—_šode
, 
u64
 
»f_couÁ
)

301 
—_šode
->
i_ùime
.
tv_£c
 = (
u32
)(
»f_couÁ
 >> 32);

302 
—_šode
->
i_v”siÚ
 = (
u32
)
»f_couÁ
;

303 
	}
}

305 
u32
 
	$ext4_x©Œ_šode_g‘_hash
(
šode
 *
—_šode
)

307  (
u32
)
—_šode
->
i_©ime
.
tv_£c
;

308 
	}
}

310 
	$ext4_x©Œ_šode_£t_hash
(
šode
 *
—_šode
, 
u32
 
hash
)

312 
—_šode
->
i_©ime
.
tv_£c
 = 
hash
;

313 
	}
}

318 
	$ext4_x©Œ_šode_»ad
(
šode
 *
—_šode
, *
buf
, 
size_t
 
size
)

320 
blocksize
 = 1 << 
—_šode
->
i_blkb™s
;

321 
bh_couÁ
 = (
size
 + 
blocksize
 - 1è>> 
—_šode
->
i_blkb™s
;

322 
_size
 = (
size
 % 
blocksize
) ?: blocksize;

323 
bufãr_h—d
 *
bhs_šlše
[8];

324 
bufãr_h—d
 **
bhs
 = 
bhs_šlše
;

325 
i
, 
»t
;

327 ià(
bh_couÁ
 > 
	`ARRAY_SIZE
(
bhs_šlše
)) {

328 
bhs
 = 
	`km®loc_¬¿y
(
bh_couÁ
, (*bhs), 
GFP_NOFS
);

329 ià(!
bhs
)

330  -
ENOMEM
;

333 
»t
 = 
	`ext4_b»ad_b©ch
(
—_šode
, 0 , 
bh_couÁ
,

334 
Œue
 , 
bhs
);

335 ià(
»t
)

336 
ä“_bhs
;

338 
i
 = 0; i < 
bh_couÁ
; i++) {

340 ià(!
bhs
[
i
]) {

341 
»t
 = -
EFSCORRUPTED
;

342 
put_bhs
;

344 
	`memıy
((*)
buf
 + 
blocksize
 * 
i
, 
bhs
[i]->
b_d©a
,

345 
i
 < 
bh_couÁ
 - 1 ? 
blocksize
 : 
_size
);

347 
»t
 = 0;

348 
put_bhs
:

349 
i
 = 0; i < 
bh_couÁ
; i++)

350 
	`b»l£
(
bhs
[
i
]);

351 
ä“_bhs
:

352 ià(
bhs
 !ğ
bhs_šlše
)

353 
	`kä“
(
bhs
);

354  
»t
;

355 
	}
}

357 
	$ext4_x©Œ_šode_ig‘
(
šode
 *
·»Á
, 
—_šo
,

358 
šode
 **
—_šode
)

360 
šode
 *inode;

361 
”r
;

363 
šode
 = 
	`ext4_ig‘
(
·»Á
->
i_sb
, 
—_šo
);

364 ià(
	`IS_ERR
(
šode
)) {

365 
”r
 = 
	`PTR_ERR
(
šode
);

366 
	`ext4_”rÜ
(
·»Á
->
i_sb
,

367 "”rÜ wh»adšg EA inod%luƒ¼=%d", 
—_šo
,

368 
”r
);

369  
”r
;

372 ià(
	`is_bad_šode
(
šode
)) {

373 
	`ext4_”rÜ
(
·»Á
->
i_sb
,

375 
—_šo
);

376 
”r
 = -
EIO
;

377 
”rÜ
;

380 ià(!(
	`EXT4_I
(
šode
)->
i_æags
 & 
EXT4_EA_INODE_FL
)) {

381 
	`ext4_”rÜ
(
·»Á
->
i_sb
,

383 
—_šo
);

384 
”r
 = -
EINVAL
;

385 
”rÜ
;

388 *
—_šode
 = 
šode
;

390 
”rÜ
:

391 
	`ut
(
šode
);

392  
”r
;

393 
	}
}

396 
	$ext4_x©Œ_šode_v”ify_hashes
(
šode
 *
—_šode
,

397 
ext4_x©Œ_’Œy
 *
’Œy
, *
bufãr
,

398 
size_t
 
size
)

400 
u32
 
hash
;

403 
hash
 = 
	`ext4_x©Œ_šode_hash
(
	`EXT4_SB
(
—_šode
->
i_sb
), 
bufãr
, 
size
);

404 ià(
hash
 !ğ
	`ext4_x©Œ_šode_g‘_hash
(
—_šode
))

405  -
EFSCORRUPTED
;

407 ià(
’Œy
) {

408 
__Ë32
 
e_hash
, 
tmp_d©a
;

411 
tmp_d©a
 = 
	`ıu_to_Ë32
(
hash
);

412 
e_hash
 = 
	`ext4_x©Œ_hash_’Œy
(
’Œy
->
e_Çme
,ƒÁry->
e_Çme_Ën
,

413 &
tmp_d©a
, 1);

414 ià(
e_hash
 !ğ
’Œy
->e_hash)

415  -
EFSCORRUPTED
;

418 
	}
}

420 
	#EXT4_XATTR_INODE_GET_PARENT
(
šode
è((
__u32
)(šode)->
i_mtime
.
tv_£c
)

	)

426 
	$ext4_x©Œ_šode_g‘
(
šode
 *šode, 
ext4_x©Œ_’Œy
 *
’Œy
,

427 *
bufãr
, 
size_t
 
size
)

429 
mb_ÿche
 *
—_šode_ÿche
 = 
	`EA_INODE_CACHE
(
šode
);

430 
šode
 *
—_šode
;

431 
”r
;

433 
”r
 = 
	`ext4_x©Œ_šode_ig‘
(
šode
, 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_šum
),

434 &
—_šode
);

435 ià(
”r
) {

436 
—_šode
 = 
NULL
;

437 
out
;

440 ià(
	`i_size_»ad
(
—_šode
è!ğ
size
) {

441 
	`ext4_w¬nšg_šode
(
—_šode
,

443 
	`i_size_»ad
(
—_šode
), 
size
);

444 
”r
 = -
EFSCORRUPTED
;

445 
out
;

448 
”r
 = 
	`ext4_x©Œ_šode_»ad
(
—_šode
, 
bufãr
, 
size
);

449 ià(
”r
)

450 
out
;

452 
”r
 = 
	`ext4_x©Œ_šode_v”ify_hashes
(
—_šode
, 
’Œy
, 
bufãr
, 
size
);

458 ià(
”r
 =ğ-
EFSCORRUPTED
) {

459 ià(
	`EXT4_XATTR_INODE_GET_PARENT
(
—_šode
è!ğ
šode
->
i_šo
 ||

460 
—_šode
->
i_g’”©iÚ
 !ğ
šode
->i_generation) {

461 
	`ext4_w¬nšg_šode
(
—_šode
,

463 
out
;

466 
—_šode_ÿche
 = 
NULL
;

467 
”r
 = 0;

468 } ià(
”r
)

469 
out
;

471 ià(
—_šode_ÿche
)

472 
	`mb_ÿche_’Œy_ü—‹
(
—_šode_ÿche
, 
GFP_NOFS
,

473 
	`ext4_x©Œ_šode_g‘_hash
(
—_šode
),

474 
—_šode
->
i_šo
, 
Œue
 );

475 
out
:

476 
	`ut
(
—_šode
);

477  
”r
;

478 
	}
}

481 
	$ext4_x©Œ_block_g‘
(
šode
 *šode, 
Çme_šdex
, cÚ¡ *
Çme
,

482 *
bufãr
, 
size_t
 
bufãr_size
)

484 
bufãr_h—d
 *
bh
 = 
NULL
;

485 
ext4_x©Œ_’Œy
 *
’Œy
;

486 
size_t
 
size
;

487 
”rÜ
;

488 
mb_ÿche
 *
—_block_ÿche
 = 
	`EA_BLOCK_CACHE
(
šode
);

490 
	`—_idebug
(
šode
, "name=%d.%s, buffer=%p, buffer_size=%ld",

491 
Çme_šdex
, 
Çme
, 
bufãr
, ()
bufãr_size
);

493 
”rÜ
 = -
ENODATA
;

494 ià(!
	`EXT4_I
(
šode
)->
i_fe_aş
)

495 
ş—nup
;

496 
	`—_idebug
(
šode
, "reading block %llu",

497 ()
	`EXT4_I
(
šode
)->
i_fe_aş
);

498 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
);

499 ià(!
bh
)

500 
ş—nup
;

501 
	`—_bdebug
(
bh
, "b_count=%d,„efcount=%d",

502 
	`©omic_»ad
(&(
bh
->
b_couÁ
)), 
	`Ë32_to_ıu
(
	`BHDR
(bh)->
h_»fcouÁ
));

503 ià(
	`ext4_x©Œ_check_block
(
šode
, 
bh
)) {

504 
	`EXT4_ERROR_INODE
(
šode
, "bad block %llu",

505 
	`EXT4_I
(
šode
)->
i_fe_aş
);

506 
”rÜ
 = -
EFSCORRUPTED
;

507 
ş—nup
;

509 
	`ext4_x©Œ_block_ÿche_š£¹
(
—_block_ÿche
, 
bh
);

510 
’Œy
 = 
	`BFIRST
(
bh
);

511 
”rÜ
 = 
	`ext4_x©Œ_fšd_’Œy
(&
’Œy
, 
Çme_šdex
, 
Çme
, 1);

512 ià(
”rÜ
)

513 
ş—nup
;

514 
size
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
);

515 ià(
bufãr
) {

516 
”rÜ
 = -
ERANGE
;

517 ià(
size
 > 
bufãr_size
)

518 
ş—nup
;

519 ià(
’Œy
->
e_v®ue_šum
) {

520 
”rÜ
 = 
	`ext4_x©Œ_šode_g‘
(
šode
, 
’Œy
, 
bufãr
,

521 
size
);

522 ià(
”rÜ
)

523 
ş—nup
;

525 
	`memıy
(
bufãr
, 
bh
->
b_d©a
 +

526 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
), 
size
);

529 
”rÜ
 = 
size
;

531 
ş—nup
:

532 
	`b»l£
(
bh
);

533  
”rÜ
;

534 
	}
}

537 
	$ext4_x©Œ_ibody_g‘
(
šode
 *šode, 
Çme_šdex
, cÚ¡ *
Çme
,

538 *
bufãr
, 
size_t
 
bufãr_size
)

540 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

541 
ext4_x©Œ_’Œy
 *
’Œy
;

542 
ext4_šode
 *
¿w_šode
;

543 
ext4_oc
 
oc
;

544 
size_t
 
size
;

545 *
’d
;

546 
”rÜ
;

548 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
))

549  -
ENODATA
;

550 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

551 ià(
”rÜ
)

552  
”rÜ
;

553 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

554 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

555 
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

556 
”rÜ
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
);

557 ià(
”rÜ
)

558 
ş—nup
;

559 
’Œy
 = 
	`IFIRST
(
h—d”
);

560 
”rÜ
 = 
	`ext4_x©Œ_fšd_’Œy
(&
’Œy
, 
Çme_šdex
, 
Çme
, 0);

561 ià(
”rÜ
)

562 
ş—nup
;

563 
size
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
);

564 ià(
bufãr
) {

565 
”rÜ
 = -
ERANGE
;

566 ià(
size
 > 
bufãr_size
)

567 
ş—nup
;

568 ià(
’Œy
->
e_v®ue_šum
) {

569 
”rÜ
 = 
	`ext4_x©Œ_šode_g‘
(
šode
, 
’Œy
, 
bufãr
,

570 
size
);

571 ià(
”rÜ
)

572 
ş—nup
;

574 
	`memıy
(
bufãr
, (*)
	`IFIRST
(
h—d”
) +

575 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
), 
size
);

578 
”rÜ
 = 
size
;

580 
ş—nup
:

581 
	`b»l£
(
oc
.
bh
);

582  
”rÜ
;

583 
	}
}

596 
	$ext4_x©Œ_g‘
(
šode
 *šode, 
Çme_šdex
, cÚ¡ *
Çme
,

597 *
bufãr
, 
size_t
 
bufãr_size
)

599 
”rÜ
;

601 ià(
	`uÆik–y
(
	`ext4_fÜûd_shutdown
(
	`EXT4_SB
(
šode
->
i_sb
))))

602  -
EIO
;

604 ià(
	`¡¾’
(
Çme
) > 255)

605  -
ERANGE
;

607 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

608 
”rÜ
 = 
	`ext4_x©Œ_ibody_g‘
(
šode
, 
Çme_šdex
, 
Çme
, 
bufãr
,

609 
bufãr_size
);

610 ià(
”rÜ
 =ğ-
ENODATA
)

611 
”rÜ
 = 
	`ext4_x©Œ_block_g‘
(
šode
, 
Çme_šdex
, 
Çme
, 
bufãr
,

612 
bufãr_size
);

613 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

614  
”rÜ
;

615 
	}
}

618 
	$ext4_x©Œ_li¡_’Œ›s
(
d’Œy
 *d’Œy, 
ext4_x©Œ_’Œy
 *
’Œy
,

619 *
bufãr
, 
size_t
 
bufãr_size
)

621 
size_t
 
»¡
 = 
bufãr_size
;

623 ; !
	`IS_LAST_ENTRY
(
’Œy
);ƒÁry = 
	`EXT4_XATTR_NEXT
(entry)) {

624 cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
 =

625 
	`ext4_x©Œ_hªdËr
(
’Œy
->
e_Çme_šdex
);

627 ià(
hªdËr
 && (!hªdËr->
li¡
 || hªdËr->
	`li¡
(
d’Œy
))) {

628 cÚ¡ *
´efix
 = 
hªdËr
->´efix ?: hªdËr->
Çme
;

629 
size_t
 
´efix_Ën
 = 
	`¡¾’
(
´efix
);

630 
size_t
 
size
 = 
´efix_Ën
 + 
’Œy
->
e_Çme_Ën
 + 1;

632 ià(
bufãr
) {

633 ià(
size
 > 
»¡
)

634  -
ERANGE
;

635 
	`memıy
(
bufãr
, 
´efix
, 
´efix_Ën
);

636 
bufãr
 +ğ
´efix_Ën
;

637 
	`memıy
(
bufãr
, 
’Œy
->
e_Çme
,ƒÁry->
e_Çme_Ën
);

638 
bufãr
 +ğ
’Œy
->
e_Çme_Ën
;

639 *
bufãr
++ = 0;

641 
»¡
 -ğ
size
;

644  
bufãr_size
 - 
»¡
;

645 
	}
}

648 
	$ext4_x©Œ_block_li¡
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
bufãr_size
)

650 
šode
 *šodğ
	`d_šode
(
d’Œy
);

651 
bufãr_h—d
 *
bh
 = 
NULL
;

652 
”rÜ
;

654 
	`—_idebug
(
šode
, "buffer=%p, buffer_size=%ld",

655 
bufãr
, ()
bufãr_size
);

657 
”rÜ
 = 0;

658 ià(!
	`EXT4_I
(
šode
)->
i_fe_aş
)

659 
ş—nup
;

660 
	`—_idebug
(
šode
, "reading block %llu",

661 ()
	`EXT4_I
(
šode
)->
i_fe_aş
);

662 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
);

663 
”rÜ
 = -
EIO
;

664 ià(!
bh
)

665 
ş—nup
;

666 
	`—_bdebug
(
bh
, "b_count=%d,„efcount=%d",

667 
	`©omic_»ad
(&(
bh
->
b_couÁ
)), 
	`Ë32_to_ıu
(
	`BHDR
(bh)->
h_»fcouÁ
));

668 ià(
	`ext4_x©Œ_check_block
(
šode
, 
bh
)) {

669 
	`EXT4_ERROR_INODE
(
šode
, "bad block %llu",

670 
	`EXT4_I
(
šode
)->
i_fe_aş
);

671 
”rÜ
 = -
EFSCORRUPTED
;

672 
ş—nup
;

674 
	`ext4_x©Œ_block_ÿche_š£¹
(
	`EA_BLOCK_CACHE
(
šode
), 
bh
);

675 
”rÜ
 = 
	`ext4_x©Œ_li¡_’Œ›s
(
d’Œy
, 
	`BFIRST
(
bh
), 
bufãr
, 
bufãr_size
);

677 
ş—nup
:

678 
	`b»l£
(
bh
);

680  
”rÜ
;

681 
	}
}

684 
	$ext4_x©Œ_ibody_li¡
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
bufãr_size
)

686 
šode
 *šodğ
	`d_šode
(
d’Œy
);

687 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

688 
ext4_šode
 *
¿w_šode
;

689 
ext4_oc
 
oc
;

690 *
’d
;

691 
”rÜ
;

693 ià(!
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
))

695 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

696 ià(
”rÜ
)

697  
”rÜ
;

698 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

699 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

700 
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

701 
”rÜ
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
);

702 ià(
”rÜ
)

703 
ş—nup
;

704 
”rÜ
 = 
	`ext4_x©Œ_li¡_’Œ›s
(
d’Œy
, 
	`IFIRST
(
h—d”
),

705 
bufãr
, 
bufãr_size
);

707 
ş—nup
:

708 
	`b»l£
(
oc
.
bh
);

709  
”rÜ
;

710 
	}
}

724 
ssize_t


725 
	$ext4_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
bufãr_size
)

727 
»t
, 
»t2
;

729 
	`down_»ad
(&
	`EXT4_I
(
	`d_šode
(
d’Œy
))->
x©Œ_£m
);

730 
»t
 = 
»t2
 = 
	`ext4_x©Œ_ibody_li¡
(
d’Œy
, 
bufãr
, 
bufãr_size
);

731 ià(
»t
 < 0)

732 
”rout
;

733 ià(
bufãr
) {

734 
bufãr
 +ğ
»t
;

735 
bufãr_size
 -ğ
»t
;

737 
»t
 = 
	`ext4_x©Œ_block_li¡
(
d’Œy
, 
bufãr
, 
bufãr_size
);

738 ià(
»t
 < 0)

739 
”rout
;

740 
»t
 +ğ
»t2
;

741 
”rout
:

742 
	`up_»ad
(&
	`EXT4_I
(
	`d_šode
(
d’Œy
))->
x©Œ_£m
);

743  
»t
;

744 
	}
}

750 
	$ext4_x©Œ_upd©e_su³r_block
(
hªdË_t
 *
hªdË
,

751 
su³r_block
 *
sb
)

753 ià(
	`ext4_has_ã©u»_x©Œ
(
sb
))

756 
	`BUFFER_TRACE
(
	`EXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

757 ià(
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
	`EXT4_SB
(
sb
)->
s_sbh
) == 0) {

758 
	`ext4_£t_ã©u»_x©Œ
(
sb
);

759 
	`ext4_hªdË_dœty_su³r
(
hªdË
, 
sb
);

761 
	}
}

763 
	$ext4_g‘_šode_u§ge
(
šode
 *šode, 
qsize_t
 *
u§ge
)

765 
ext4_oc
 
oc
 = { .
bh
 = 
NULL
 };

766 
bufãr_h—d
 *
bh
 = 
NULL
;

767 
ext4_šode
 *
¿w_šode
;

768 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

769 
ext4_x©Œ_’Œy
 *
’Œy
;

770 
qsize_t
 
—_šode_»fs
 = 0;

771 *
’d
;

772 
»t
;

774 
	`lockd•_as£¹_h–d_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

776 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
)) {

777 
»t
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

778 ià(
»t
)

779 
out
;

780 
¿w_šode
 = 
	`ext4_¿w_šode
(&
oc
);

781 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

782 
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

783 
»t
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
);

784 ià(
»t
)

785 
out
;

787 
’Œy
 = 
	`IFIRST
(
h—d”
); !
	`IS_LAST_ENTRY
(entry);

788 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry))

789 ià(
’Œy
->
e_v®ue_šum
)

790 
—_šode_»fs
++;

793 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
) {

794 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
);

795 ià(!
bh
) {

796 
»t
 = -
EIO
;

797 
out
;

800 ià(
	`ext4_x©Œ_check_block
(
šode
, 
bh
)) {

801 
»t
 = -
EFSCORRUPTED
;

802 
out
;

805 
’Œy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

806 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry))

807 ià(
’Œy
->
e_v®ue_šum
)

808 
—_šode_»fs
++;

810 *
u§ge
 = 
—_šode_»fs
 + 1;

811 
»t
 = 0;

812 
out
:

813 
	`b»l£
(
oc
.
bh
);

814 
	`b»l£
(
bh
);

815  
»t
;

816 
	}
}

818 
šlše
 
size_t
 
	$round_up_şu¡”
(
šode
 *šode, 
size_t
 
Ëngth
)

820 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

821 
size_t
 
şu¡”_size
 = 1 << (
	`EXT4_SB
(
sb
)->
s_şu¡”_b™s
 +

822 
šode
->
i_blkb™s
);

823 
size_t
 
mask
 = ~(
şu¡”_size
 - 1);

825  (
Ëngth
 + 
şu¡”_size
 - 1è& 
mask
;

826 
	}
}

828 
	$ext4_x©Œ_šode_®loc_quÙa
(
šode
 *šode, 
size_t
 
Ën
)

830 
”r
;

832 
”r
 = 
	`dquÙ_®loc_šode
(
šode
);

833 ià(
”r
)

834  
”r
;

835 
”r
 = 
	`dquÙ_®loc_¥aû_nodœty
(
šode
, 
	`round_up_şu¡”
(šode, 
Ën
));

836 ià(
”r
)

837 
	`dquÙ_ä“_šode
(
šode
);

838  
”r
;

839 
	}
}

841 
	$ext4_x©Œ_šode_ä“_quÙa
(
šode
 *šode, 
size_t
 
Ën
)

843 
	`dquÙ_ä“_¥aû_nodœty
(
šode
, 
	`round_up_şu¡”
(šode, 
Ën
));

844 
	`dquÙ_ä“_šode
(
šode
);

845 
	}
}

847 
	$__ext4_x©Œ_£t_üed™s
(
su³r_block
 *
sb
, 
šode
 *inode,

848 
bufãr_h—d
 *
block_bh
, 
size_t
 
v®ue_Ën
,

849 
boŞ
 
is_ü—‹
)

851 
üed™s
;

852 
blocks
;

867 
üed™s
 = 7;

870 
üed™s
 +ğ
	`EXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
);

876 ià(
šode
 && 
	`ext4_has_šlše_d©a
(inode))

877 
üed™s
 +ğ
	`ext4_wr™•age_Œªs_blocks
(
šode
) + 1;

880 ià(!
	`ext4_has_ã©u»_—_šode
(
sb
))

881  
üed™s
;

884 
üed™s
 += 4;

887 
blocks
 = (
v®ue_Ën
 + 
sb
->
s_blocksize
 - 1è>> sb->
s_blocksize_b™s
;

890 
blocks
 += 1;

893 
üed™s
 +ğ
blocks
 * 2;

896 
üed™s
 +ğ
blocks
;

898 ià(!
is_ü—‹
) {

902 
üed™s
 += 4;

905 
blocks
 = 
XATTR_SIZE_MAX
 >> 
sb
->
s_blocksize_b™s
;

910 
blocks
 += 1;

913 
üed™s
 +ğ
blocks
 * 2;

919 ià(
block_bh
) {

920 
ext4_x©Œ_’Œy
 *
’Œy
 = 
	`BFIRST
(
block_bh
);

922 ; !
	`IS_LAST_ENTRY
(
’Œy
);ƒÁry = 
	`EXT4_XATTR_NEXT
(entry))

923 ià(
’Œy
->
e_v®ue_šum
)

925 
üed™s
 += 1;

927  
üed™s
;

928 
	}
}

930 
	$ext4_x©Œ_’su»_üed™s
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

931 
üed™s
, 
bufãr_h—d
 *
bh
,

932 
boŞ
 
dœty
, boŞ 
block_csum
)

934 
”rÜ
;

936 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

939 ià(
hªdË
->
h_bufãr_üed™s
 >ğ
üed™s
)

942 
”rÜ
 = 
	`ext4_jouº®_ex‹nd
(
hªdË
, 
üed™s
 - hªdË->
h_bufãr_üed™s
);

943 ià(!
”rÜ
)

945 ià(
”rÜ
 < 0) {

946 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Ex‹nd jouº® (”rÜ %d)", 
”rÜ
);

947  
”rÜ
;

950 ià(
bh
 && 
dœty
) {

951 ià(
block_csum
)

952 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
bh
);

953 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

954 ià(
”rÜ
) {

955 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Handle metadata (error %d)",

956 
”rÜ
);

957  
”rÜ
;

961 
”rÜ
 = 
	`ext4_jouº®_»¡¬t
(
hªdË
, 
üed™s
);

962 ià(
”rÜ
) {

963 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Re¡¬ˆjouº® (”rÜ %d)", 
”rÜ
);

964  
”rÜ
;

967 ià(
bh
) {

968 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

969 ià(
”rÜ
) {

970 
	`ext4_w¬nšg
(
šode
->
i_sb
,

972 
”rÜ
);

973  
”rÜ
;

977 
	}
}

979 
	$ext4_x©Œ_šode_upd©e_»f
(
hªdË_t
 *
hªdË
, 
šode
 *
—_šode
,

980 
»f_chªge
)

982 
mb_ÿche
 *
—_šode_ÿche
 = 
	`EA_INODE_CACHE
(
—_šode
);

983 
ext4_oc
 
oc
;

984 
s64
 
»f_couÁ
;

985 
u32
 
hash
;

986 
»t
;

988 
	`šode_lock
(
—_šode
);

990 
»t
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
—_šode
, &
oc
);

991 ià(
»t
) {

992 
oc
.
bh
 = 
NULL
;

993 
out
;

996 
»f_couÁ
 = 
	`ext4_x©Œ_šode_g‘_»f
(
—_šode
);

997 
»f_couÁ
 +ğ
»f_chªge
;

998 
	`ext4_x©Œ_šode_£t_»f
(
—_šode
, 
»f_couÁ
);

1000 ià(
»f_chªge
 > 0) {

1001 
	`WARN_ONCE
(
»f_couÁ
 <= 0, "EA inode %lu„ef_count=%lld",

1002 
—_šode
->
i_šo
, 
»f_couÁ
);

1004 ià(
»f_couÁ
 == 1) {

1005 
	`WARN_ONCE
(
—_šode
->
i_Æšk
, "EA inode %lu i_nlink=%u",

1006 
—_šode
->
i_šo
,ƒa_šode->
i_Æšk
);

1008 
	`£t_Æšk
(
—_šode
, 1);

1009 
	`ext4_Üphª_d–
(
hªdË
, 
—_šode
);

1011 ià(
—_šode_ÿche
) {

1012 
hash
 = 
	`ext4_x©Œ_šode_g‘_hash
(
—_šode
);

1013 
	`mb_ÿche_’Œy_ü—‹
(
—_šode_ÿche
,

1014 
GFP_NOFS
, 
hash
,

1015 
—_šode
->
i_šo
,

1016 
Œue
 );

1020 
	`WARN_ONCE
(
»f_couÁ
 < 0, "EA inode %lu„ef_count=%lld",

1021 
—_šode
->
i_šo
, 
»f_couÁ
);

1023 ià(
»f_couÁ
 == 0) {

1024 
	`WARN_ONCE
(
—_šode
->
i_Æšk
 != 1,

1026 
—_šode
->
i_šo
,ƒa_šode->
i_Æšk
);

1028 
	`ş—r_Æšk
(
—_šode
);

1029 
	`ext4_Üphª_add
(
hªdË
, 
—_šode
);

1031 ià(
—_šode_ÿche
) {

1032 
hash
 = 
	`ext4_x©Œ_šode_g‘_hash
(
—_šode
);

1033 
	`mb_ÿche_’Œy_d–‘e
(
—_šode_ÿche
, 
hash
,

1034 
—_šode
->
i_šo
);

1039 
»t
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
—_šode
, &
oc
);

1040 
oc
.
bh
 = 
NULL
;

1041 ià(
»t
)

1042 
	`ext4_w¬nšg_šode
(
—_šode
,

1043 "ext4_m¬k_oc_dœty(èçed„‘=%d", 
»t
);

1044 
out
:

1045 
	`b»l£
(
oc
.
bh
);

1046 
	`šode_uÆock
(
—_šode
);

1047  
»t
;

1048 
	}
}

1050 
	$ext4_x©Œ_šode_šc_»f
(
hªdË_t
 *
hªdË
, 
šode
 *
—_šode
)

1052  
	`ext4_x©Œ_šode_upd©e_»f
(
hªdË
, 
—_šode
, 1);

1053 
	}
}

1055 
	$ext4_x©Œ_šode_dec_»f
(
hªdË_t
 *
hªdË
, 
šode
 *
—_šode
)

1057  
	`ext4_x©Œ_šode_upd©e_»f
(
hªdË
, 
—_šode
, -1);

1058 
	}
}

1060 
	$ext4_x©Œ_šode_šc_»f_®l
(
hªdË_t
 *
hªdË
, 
šode
 *
·»Á
,

1061 
ext4_x©Œ_’Œy
 *
fœ¡
)

1063 
šode
 *
—_šode
;

1064 
ext4_x©Œ_’Œy
 *
’Œy
;

1065 
ext4_x©Œ_’Œy
 *
çed_’Œy
;

1066 
—_šo
;

1067 
”r
, 
§ved_”r
;

1069 
’Œy
 = 
fœ¡
; !
	`IS_LAST_ENTRY
(entry);

1070 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry)) {

1071 ià(!
’Œy
->
e_v®ue_šum
)

1073 
—_šo
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_šum
);

1074 
”r
 = 
	`ext4_x©Œ_šode_ig‘
(
·»Á
, 
—_šo
, &
—_šode
);

1075 ià(
”r
)

1076 
ş—nup
;

1077 
”r
 = 
	`ext4_x©Œ_šode_šc_»f
(
hªdË
, 
—_šode
);

1078 ià(
”r
) {

1079 
	`ext4_w¬nšg_šode
(
—_šode
, "šø»à”rÜ %d", 
”r
);

1080 
	`ut
(
—_šode
);

1081 
ş—nup
;

1083 
	`ut
(
—_šode
);

1087 
ş—nup
:

1088 
§ved_”r
 = 
”r
;

1089 
çed_’Œy
 = 
’Œy
;

1091 
’Œy
 = 
fœ¡
;ƒÁry !ğ
çed_’Œy
;

1092 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry)) {

1093 ià(!
’Œy
->
e_v®ue_šum
)

1095 
—_šo
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_šum
);

1096 
”r
 = 
	`ext4_x©Œ_šode_ig‘
(
·»Á
, 
—_šo
, &
—_šode
);

1097 ià(
”r
) {

1098 
	`ext4_w¬nšg
(
·»Á
->
i_sb
,

1099 "ş—nu°—_šØ%u ig‘ƒ¼Ü %d", 
—_šo
,

1100 
”r
);

1103 
”r
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
—_šode
);

1104 ià(
”r
)

1105 
	`ext4_w¬nšg_šode
(
—_šode
, "cleanup dec„efƒrror %d",

1106 
”r
);

1107 
	`ut
(
—_šode
);

1109  
§ved_”r
;

1110 
	}
}

1113 
	$ext4_x©Œ_šode_dec_»f_®l
(
hªdË_t
 *
hªdË
, 
šode
 *
·»Á
,

1114 
bufãr_h—d
 *
bh
,

1115 
ext4_x©Œ_’Œy
 *
fœ¡
, 
boŞ
 
block_csum
,

1116 
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

1117 
exŒa_üed™s
, 
boŞ
 
sk_quÙa
)

1119 
šode
 *
—_šode
;

1120 
ext4_x©Œ_’Œy
 *
’Œy
;

1121 
boŞ
 
dœty
 = 
çl£
;

1122 
—_šo
;

1123 
”r
;

1124 
üed™s
;

1127 
üed™s
 = 2 + 
exŒa_üed™s
;

1129 
’Œy
 = 
fœ¡
; !
	`IS_LAST_ENTRY
(entry);

1130 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry)) {

1131 ià(!
’Œy
->
e_v®ue_šum
)

1133 
—_šo
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_šum
);

1134 
”r
 = 
	`ext4_x©Œ_šode_ig‘
(
·»Á
, 
—_šo
, &
—_šode
);

1135 ià(
”r
)

1138 
”r
 = 
	`ext4_ex·nd_šode_¬¿y
(
—_šode_¬¿y
, 
—_šode
);

1139 ià(
”r
) {

1140 
	`ext4_w¬nšg_šode
(
—_šode
,

1141 "Ex·nd inod¬¿yƒ¼=%d", 
”r
);

1142 
	`ut
(
—_šode
);

1146 
”r
 = 
	`ext4_x©Œ_’su»_üed™s
(
hªdË
, 
·»Á
, 
üed™s
, 
bh
,

1147 
dœty
, 
block_csum
);

1148 ià(
”r
) {

1149 
	`ext4_w¬nšg_šode
(
—_šode
, "Ensure creditsƒrr=%d",

1150 
”r
);

1154 
”r
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
—_šode
);

1155 ià(
”r
) {

1156 
	`ext4_w¬nšg_šode
(
—_šode
, "ea_inode dec„efƒrr=%d",

1157 
”r
);

1161 ià(!
sk_quÙa
)

1162 
	`ext4_x©Œ_šode_ä“_quÙa
(
·»Á
,

1163 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

1171 
’Œy
->
e_v®ue_šum
 = 0;

1172 
’Œy
->
e_v®ue_size
 = 0;

1174 
dœty
 = 
Œue
;

1177 ià(
dœty
) {

1184 
”r
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
NULL
, 
bh
);

1185 ià(
”r
)

1186 
	`ext4_w¬nšg_šode
(
·»Á
,

1187 "hªdË dœty m‘ad©¨”r=%d", 
”r
);

1189 
	}
}

1196 
	$ext4_x©Œ_»Ëa£_block
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1197 
bufãr_h—d
 *
bh
,

1198 
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

1199 
exŒa_üed™s
)

1201 
mb_ÿche
 *
—_block_ÿche
 = 
	`EA_BLOCK_CACHE
(
šode
);

1202 
u32
 
hash
, 
»f
;

1203 
”rÜ
 = 0;

1205 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1206 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1207 ià(
”rÜ
)

1208 
out
;

1210 
	`lock_bufãr
(
bh
);

1211 
hash
 = 
	`Ë32_to_ıu
(
	`BHDR
(
bh
)->
h_hash
);

1212 
»f
 = 
	`Ë32_to_ıu
(
	`BHDR
(
bh
)->
h_»fcouÁ
);

1213 ià(
»f
 == 1) {

1214 
	`—_bdebug
(
bh
, "refcount‚ow=0; freeing");

1219 ià(
—_block_ÿche
)

1220 
	`mb_ÿche_’Œy_d–‘e
(
—_block_ÿche
, 
hash
,

1221 
bh
->
b_blockÄ
);

1222 
	`g‘_bh
(
bh
);

1223 
	`uÆock_bufãr
(
bh
);

1225 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
))

1226 
	`ext4_x©Œ_šode_dec_»f_®l
(
hªdË
, 
šode
, 
bh
,

1227 
	`BFIRST
(
bh
),

1228 
Œue
 ,

1229 
—_šode_¬¿y
,

1230 
exŒa_üed™s
,

1231 
Œue
 );

1232 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
bh
, 0, 1,

1233 
EXT4_FREE_BLOCKS_METADATA
 |

1234 
EXT4_FREE_BLOCKS_FORGET
);

1236 
»f
--;

1237 
	`BHDR
(
bh
)->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(
»f
);

1238 ià(
»f
 =ğ
EXT4_XATTR_REFCOUNT_MAX
 - 1) {

1239 
mb_ÿche_’Œy
 *
û
;

1241 ià(
—_block_ÿche
) {

1242 
û
 = 
	`mb_ÿche_’Œy_g‘
(
—_block_ÿche
, 
hash
,

1243 
bh
->
b_blockÄ
);

1244 ià(
û
) {

1245 
û
->
e_»u§bË
 = 1;

1246 
	`mb_ÿche_’Œy_put
(
—_block_ÿche
, 
û
);

1251 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
bh
);

1262 ià(
	`ext4_hªdË_v®id
(
hªdË
))

1263 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1264 
	`uÆock_bufãr
(
bh
);

1265 ià(!
	`ext4_hªdË_v®id
(
hªdË
))

1266 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
, 
bh
);

1267 ià(
	`IS_SYNC
(
šode
))

1268 
	`ext4_hªdË_sync
(
hªdË
);

1269 
	`dquÙ_ä“_block
(
šode
, 
	`EXT4_C2B
(
	`EXT4_SB
(šode->
i_sb
), 1));

1270 
	`—_bdebug
(
bh
, "refcount‚ow=%d;„eleasing",

1271 
	`Ë32_to_ıu
(
	`BHDR
(
bh
)->
h_»fcouÁ
));

1273 
out
:

1274 
	`ext4_¡d_”rÜ
(
šode
->
i_sb
, 
”rÜ
);

1276 
	}
}

1282 
size_t
 
	$ext4_x©Œ_ä“_¥aû
(
ext4_x©Œ_’Œy
 *
Ï¡
,

1283 
size_t
 *
mš_offs
, *
ba£
, *
tÙ®
)

1285 ; !
	`IS_LAST_ENTRY
(
Ï¡
);†a¡ = 
	`EXT4_XATTR_NEXT
(last)) {

1286 ià(!
Ï¡
->
e_v®ue_šum
 &&†a¡->
e_v®ue_size
) {

1287 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
Ï¡
->
e_v®ue_offs
);

1288 ià(
offs
 < *
mš_offs
)

1289 *
mš_offs
 = 
offs
;

1291 ià(
tÙ®
)

1292 *
tÙ®
 +ğ
	`EXT4_XATTR_LEN
(
Ï¡
->
e_Çme_Ën
);

1294  (*
mš_offs
 - ((*)
Ï¡
 - 
ba£
è- (
__u32
));

1295 
	}
}

1300 
	$ext4_x©Œ_šode_wr™e
(
hªdË_t
 *
hªdË
, 
šode
 *
—_šode
,

1301 cÚ¡ *
buf
, 
bufsize
)

1303 
bufãr_h—d
 *
bh
 = 
NULL
;

1304 
block
 = 0;

1305 
blocksize
 = 
—_šode
->
i_sb
->
s_blocksize
;

1306 
max_blocks
 = (
bufsize
 + 
blocksize
 - 1è>> 
—_šode
->
i_blkb™s
;

1307 
csize
, 
wsize
 = 0;

1308 
»t
 = 0;

1309 
»Œ›s
 = 0;

1311 
»Œy
:

1312 
»t
 >ğ0 &&„‘ < 
max_blocks
) {

1313 
ext4_m­_blocks
 
m­
;

1314 
m­
.
m_lblk
 = 
block
 +ğ
»t
;

1315 
m­
.
m_Ën
 = 
max_blocks
 -ğ
»t
;

1317 
»t
 = 
	`ext4_m­_blocks
(
hªdË
, 
—_šode
, &
m­
,

1318 
EXT4_GET_BLOCKS_CREATE
);

1319 ià(
»t
 <= 0) {

1320 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
—_šode
);

1321 ià(
»t
 =ğ-
ENOSPC
 &&

1322 
	`ext4_should_»Œy_®loc
(
—_šode
->
i_sb
, &
»Œ›s
)) {

1323 
»t
 = 0;

1324 
»Œy
;

1330 ià(
»t
 < 0)

1331  
»t
;

1333 
block
 = 0;

1334 
wsize
 < 
bufsize
) {

1335 ià(
bh
 !ğ
NULL
)

1336 
	`b»l£
(
bh
);

1337 
csize
 = (
bufsize
 - 
wsize
è> 
blocksize
 ? blocksize :

1338 
bufsize
 - 
wsize
;

1339 
bh
 = 
	`ext4_g‘blk
(
hªdË
, 
—_šode
, 
block
, 0);

1340 ià(
	`IS_ERR
(
bh
))

1341  
	`PTR_ERR
(
bh
);

1342 
»t
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bh
);

1343 ià(
»t
)

1344 
out
;

1346 
	`memıy
(
bh
->
b_d©a
, 
buf
, 
csize
);

1347 
	`£t_bufãr_u±od©e
(
bh
);

1348 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
—_šode
, 
bh
);

1350 
buf
 +ğ
csize
;

1351 
wsize
 +ğ
csize
;

1352 
block
 += 1;

1355 
	`šode_lock
(
—_šode
);

1356 
	`i_size_wr™e
(
—_šode
, 
wsize
);

1357 
	`ext4_upd©e_i_disksize
(
—_šode
, 
wsize
);

1358 
	`šode_uÆock
(
—_šode
);

1360 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
—_šode
);

1362 
out
:

1363 
	`b»l£
(
bh
);

1365  
»t
;

1366 
	}
}

1371 
šode
 *
	$ext4_x©Œ_šode_ü—‹
(
hªdË_t
 *
hªdË
,

1372 
šode
 *šode, 
u32
 
hash
)

1374 
šode
 *
—_šode
 = 
NULL
;

1375 
uid_t
 
owÃr
[2] = { 
	`i_uid_»ad
(
šode
), 
	`i_gid_»ad
(inode) };

1376 
”r
;

1382 
—_šode
 = 
	`ext4_Ãw_šode
(
hªdË
, 
šode
->
i_sb
->
s_roÙ
->
d_šode
,

1383 
S_IFREG
 | 0600, 
NULL
, 
šode
->
i_šo
 + 1, 
owÃr
,

1384 
EXT4_EA_INODE_FL
);

1385 ià(!
	`IS_ERR
(
—_šode
)) {

1386 
—_šode
->
i_İ
 = &
ext4_fe_šode_İ”©iÚs
;

1387 
—_šode
->
i_fİ
 = &
ext4_fe_İ”©iÚs
;

1388 
	`ext4_£t_aİs
(
—_šode
);

1389 
	`ext4_x©Œ_šode_£t_şass
(
—_šode
);

1390 
	`uÆock_Ãw_šode
(
—_šode
);

1391 
	`ext4_x©Œ_šode_£t_»f
(
—_šode
, 1);

1392 
	`ext4_x©Œ_šode_£t_hash
(
—_šode
, 
hash
);

1393 
”r
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
—_šode
);

1394 ià(!
”r
)

1395 
”r
 = 
	`ext4_šode_©ch_jšode
(
—_šode
);

1396 ià(
”r
) {

1397 
	`ut
(
—_šode
);

1398  
	`ERR_PTR
(
”r
);

1405 
	`dquÙ_ä“_šode
(
—_šode
);

1406 
	`dquÙ_drİ
(
—_šode
);

1407 
	`šode_lock
(
—_šode
);

1408 
—_šode
->
i_æags
 |ğ
S_NOQUOTA
;

1409 
	`šode_uÆock
(
—_šode
);

1412  
—_šode
;

1413 
	}
}

1415 
šode
 *

1416 
	$ext4_x©Œ_šode_ÿche_fšd
(
šode
 *šode, cÚ¡ *
v®ue
,

1417 
size_t
 
v®ue_Ën
, 
u32
 
hash
)

1419 
šode
 *
—_šode
;

1420 
mb_ÿche_’Œy
 *
û
;

1421 
mb_ÿche
 *
—_šode_ÿche
 = 
	`EA_INODE_CACHE
(
šode
);

1422 *
—_d©a
;

1424 ià(!
—_šode_ÿche
)

1425  
NULL
;

1427 
û
 = 
	`mb_ÿche_’Œy_fšd_fœ¡
(
—_šode_ÿche
, 
hash
);

1428 ià(!
û
)

1429  
NULL
;

1431 
—_d©a
 = 
	`ext4_kvm®loc
(
v®ue_Ën
, 
GFP_NOFS
);

1432 ià(!
—_d©a
) {

1433 
	`mb_ÿche_’Œy_put
(
—_šode_ÿche
, 
û
);

1434  
NULL
;

1437 
û
) {

1438 
—_šode
 = 
	`ext4_ig‘
(
šode
->
i_sb
, 
û
->
e_v®ue
);

1439 ià(!
	`IS_ERR
(
—_šode
) &&

1440 !
	`is_bad_šode
(
—_šode
) &&

1441 (
	`EXT4_I
(
—_šode
)->
i_æags
 & 
EXT4_EA_INODE_FL
) &&

1442 
	`i_size_»ad
(
—_šode
è=ğ
v®ue_Ën
 &&

1443 !
	`ext4_x©Œ_šode_»ad
(
—_šode
, 
—_d©a
, 
v®ue_Ën
) &&

1444 !
	`ext4_x©Œ_šode_v”ify_hashes
(
—_šode
, 
NULL
, 
—_d©a
,

1445 
v®ue_Ën
) &&

1446 !
	`memcmp
(
v®ue
, 
—_d©a
, 
v®ue_Ën
)) {

1447 
	`mb_ÿche_’Œy_touch
(
—_šode_ÿche
, 
û
);

1448 
	`mb_ÿche_’Œy_put
(
—_šode_ÿche
, 
û
);

1449 
	`kvä“
(
—_d©a
);

1450  
—_šode
;

1453 ià(!
	`IS_ERR
(
—_šode
))

1454 
	`ut
(
—_šode
);

1455 
û
 = 
	`mb_ÿche_’Œy_fšd_Ãxt
(
—_šode_ÿche
, ce);

1457 
	`kvä“
(
—_d©a
);

1458  
NULL
;

1459 
	}
}

1464 
	$ext4_x©Œ_šode_lookup_ü—‹
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1465 cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
,

1466 
šode
 **
»t_šode
)

1468 
šode
 *
—_šode
;

1469 
u32
 
hash
;

1470 
”r
;

1472 
hash
 = 
	`ext4_x©Œ_šode_hash
(
	`EXT4_SB
(
šode
->
i_sb
), 
v®ue
, 
v®ue_Ën
);

1473 
—_šode
 = 
	`ext4_x©Œ_šode_ÿche_fšd
(
šode
, 
v®ue
, 
v®ue_Ën
, 
hash
);

1474 ià(
—_šode
) {

1475 
”r
 = 
	`ext4_x©Œ_šode_šc_»f
(
hªdË
, 
—_šode
);

1476 ià(
”r
) {

1477 
	`ut
(
—_šode
);

1478  
”r
;

1481 *
»t_šode
 = 
—_šode
;

1486 
—_šode
 = 
	`ext4_x©Œ_šode_ü—‹
(
hªdË
, 
šode
, 
hash
);

1487 ià(
	`IS_ERR
(
—_šode
))

1488  
	`PTR_ERR
(
—_šode
);

1490 
”r
 = 
	`ext4_x©Œ_šode_wr™e
(
hªdË
, 
—_šode
, 
v®ue
, 
v®ue_Ën
);

1491 ià(
”r
) {

1492 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
—_šode
);

1493 
	`ut
(
—_šode
);

1494  
”r
;

1497 ià(
	`EA_INODE_CACHE
(
šode
))

1498 
	`mb_ÿche_’Œy_ü—‹
(
	`EA_INODE_CACHE
(
šode
), 
GFP_NOFS
, 
hash
,

1499 
—_šode
->
i_šo
, 
Œue
 );

1501 *
»t_šode
 = 
—_šode
;

1503 
	}
}

1509 
	#EXT4_XATTR_BLOCK_RESERVE
(
šode
è
	`mš
(
	`i_blocksize
(šode)/8, 1024U)

	)

1511 
	$ext4_x©Œ_£t_’Œy
(
ext4_x©Œ_šfo
 *
i
,

1512 
ext4_x©Œ_£¬ch
 *
s
,

1513 
hªdË_t
 *
hªdË
, 
šode
 *inode,

1514 
boŞ
 
is_block
)

1516 
ext4_x©Œ_’Œy
 *
Ï¡
;

1517 
ext4_x©Œ_’Œy
 *
h”e
 = 
s
->here;

1518 
size_t
 
mš_offs
 = 
s
->
’d
 - s->
ba£
, 
Çme_Ën
 = 
	`¡¾’
(
i
->
Çme
);

1519 
š_šode
 = 
i
->in_inode;

1520 
šode
 *
Şd_—_šode
 = 
NULL
;

1521 
šode
 *
Ãw_—_šode
 = 
NULL
;

1522 
size_t
 
Şd_size
, 
Ãw_size
;

1523 
»t
;

1526 
Şd_size
 = (!
s
->
nÙ_found
 && !
h”e
->
e_v®ue_šum
) ?

1527 
	`EXT4_XATTR_SIZE
(
	`Ë32_to_ıu
(
h”e
->
e_v®ue_size
)) : 0;

1528 
Ãw_size
 = (
i
->
v®ue
 && !
š_šode
è? 
	`EXT4_XATTR_SIZE
(i->
v®ue_Ën
) : 0;

1534 ià(
Ãw_size
 &&‚ew_siz=ğ
Şd_size
) {

1535 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
h”e
->
e_v®ue_offs
);

1536 *
v®
 = 
s
->
ba£
 + 
offs
;

1538 
h”e
->
e_v®ue_size
 = 
	`ıu_to_Ë32
(
i
->
v®ue_Ën
);

1539 ià(
i
->
v®ue
 =ğ
EXT4_ZERO_XATTR_VALUE
) {

1540 
	`mem£t
(
v®
, 0, 
Ãw_size
);

1542 
	`memıy
(
v®
, 
i
->
v®ue
, i->
v®ue_Ën
);

1544 
	`mem£t
(
v®
 + 
i
->
v®ue_Ën
, 0, 
Ãw_size
 - i->value_len);

1546 
upd©e_hash
;

1550 
Ï¡
 = 
s
->
fœ¡
;

1551 ; !
	`IS_LAST_ENTRY
(
Ï¡
);†a¡ = 
	`EXT4_XATTR_NEXT
(last)) {

1552 ià(!
Ï¡
->
e_v®ue_šum
 &&†a¡->
e_v®ue_size
) {

1553 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
Ï¡
->
e_v®ue_offs
);

1554 ià(
offs
 < 
mš_offs
)

1555 
mš_offs
 = 
offs
;

1560 ià(
i
->
v®ue
) {

1561 
size_t
 
ä“
;

1563 
ä“
 = 
mš_offs
 - ((*)
Ï¡
 - 
s
->
ba£
è- (
__u32
);

1564 ià(!
s
->
nÙ_found
)

1565 
ä“
 +ğ
	`EXT4_XATTR_LEN
(
Çme_Ën
è+ 
Şd_size
;

1567 ià(
ä“
 < 
	`EXT4_XATTR_LEN
(
Çme_Ën
è+ 
Ãw_size
) {

1568 
»t
 = -
ENOSPC
;

1569 
out
;

1578 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
) &&

1579 
Ãw_size
 && 
is_block
 &&

1580 (
mš_offs
 + 
Şd_size
 - 
Ãw_size
) <

1581 
	`EXT4_XATTR_BLOCK_RESERVE
(
šode
)) {

1582 
»t
 = -
ENOSPC
;

1583 
out
;

1591 ià(!
s
->
nÙ_found
 && 
h”e
->
e_v®ue_šum
) {

1592 
»t
 = 
	`ext4_x©Œ_šode_ig‘
(
šode
,

1593 
	`Ë32_to_ıu
(
h”e
->
e_v®ue_šum
),

1594 &
Şd_—_šode
);

1595 ià(
»t
) {

1596 
Şd_—_šode
 = 
NULL
;

1597 
out
;

1600 ià(
i
->
v®ue
 && 
š_šode
) {

1601 
	`WARN_ON_ONCE
(!
i
->
v®ue_Ën
);

1603 
»t
 = 
	`ext4_x©Œ_šode_®loc_quÙa
(
šode
, 
i
->
v®ue_Ën
);

1604 ià(
»t
)

1605 
out
;

1607 
»t
 = 
	`ext4_x©Œ_šode_lookup_ü—‹
(
hªdË
, 
šode
, 
i
->
v®ue
,

1608 
i
->
v®ue_Ën
,

1609 &
Ãw_—_šode
);

1610 ià(
»t
) {

1611 
Ãw_—_šode
 = 
NULL
;

1612 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
, 
i
->
v®ue_Ën
);

1613 
out
;

1617 ià(
Şd_—_šode
) {

1619 
»t
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
Şd_—_šode
);

1620 ià(
»t
) {

1622 ià(
Ãw_—_šode
) {

1623 
”r
;

1625 
”r
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
,

1626 
Ãw_—_šode
);

1627 ià(
”r
)

1628 
	`ext4_w¬nšg_šode
(
Ãw_—_šode
,

1630 
”r
);

1631 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
,

1632 
i
->
v®ue_Ën
);

1634 
out
;

1637 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
,

1638 
	`Ë32_to_ıu
(
h”e
->
e_v®ue_size
));

1643 ià(!
s
->
nÙ_found
 && 
h”e
->
e_v®ue_offs
) {

1645 *
fœ¡_v®
 = 
s
->
ba£
 + 
mš_offs
;

1646 
size_t
 
offs
 = 
	`Ë16_to_ıu
(
h”e
->
e_v®ue_offs
);

1647 *
v®
 = 
s
->
ba£
 + 
offs
;

1649 
	`memmove
(
fœ¡_v®
 + 
Şd_size
, fœ¡_v®, 
v®
 - first_val);

1650 
	`mem£t
(
fœ¡_v®
, 0, 
Şd_size
);

1651 
mš_offs
 +ğ
Şd_size
;

1654 
Ï¡
 = 
s
->
fœ¡
;

1655 !
	`IS_LAST_ENTRY
(
Ï¡
)) {

1656 
size_t
 
o
 = 
	`Ë16_to_ıu
(
Ï¡
->
e_v®ue_offs
);

1658 ià(!
Ï¡
->
e_v®ue_šum
 &&

1659 
Ï¡
->
e_v®ue_size
 && 
o
 < 
offs
)

1660 
Ï¡
->
e_v®ue_offs
 = 
	`ıu_to_Ë16
(
o
 + 
Şd_size
);

1661 
Ï¡
 = 
	`EXT4_XATTR_NEXT
(last);

1665 ià(!
i
->
v®ue
) {

1667 
size_t
 
size
 = 
	`EXT4_XATTR_LEN
(
Çme_Ën
);

1669 
Ï¡
 = 
	`ENTRY
((*îa¡ - 
size
);

1670 
	`memmove
(
h”e
, (*)h”+ 
size
,

1671 (*)
Ï¡
 - (*)
h”e
 + (
__u32
));

1672 
	`mem£t
(
Ï¡
, 0, 
size
);

1673 } ià(
s
->
nÙ_found
) {

1675 
size_t
 
size
 = 
	`EXT4_XATTR_LEN
(
Çme_Ën
);

1676 
size_t
 
»¡
 = (*)
Ï¡
 - (*)
h”e
 + (
__u32
);

1678 
	`memmove
((*)
h”e
 + 
size
, h”e, 
»¡
);

1679 
	`mem£t
(
h”e
, 0, 
size
);

1680 
h”e
->
e_Çme_šdex
 = 
i
->
Çme_šdex
;

1681 
h”e
->
e_Çme_Ën
 = 
Çme_Ën
;

1682 
	`memıy
(
h”e
->
e_Çme
, 
i
->
Çme
, 
Çme_Ën
);

1685 
h”e
->
e_v®ue_šum
 = 0;

1686 
h”e
->
e_v®ue_offs
 = 0;

1687 
h”e
->
e_v®ue_size
 = 0;

1690 ià(
i
->
v®ue
) {

1692 ià(
š_šode
) {

1693 
h”e
->
e_v®ue_šum
 = 
	`ıu_to_Ë32
(
Ãw_—_šode
->
i_šo
);

1694 } ià(
i
->
v®ue_Ën
) {

1695 *
v®
 = 
s
->
ba£
 + 
mš_offs
 - 
Ãw_size
;

1697 
h”e
->
e_v®ue_offs
 = 
	`ıu_to_Ë16
(
mš_offs
 - 
Ãw_size
);

1698 ià(
i
->
v®ue
 =ğ
EXT4_ZERO_XATTR_VALUE
) {

1699 
	`mem£t
(
v®
, 0, 
Ãw_size
);

1701 
	`memıy
(
v®
, 
i
->
v®ue
, i->
v®ue_Ën
);

1703 
	`mem£t
(
v®
 + 
i
->
v®ue_Ën
, 0,

1704 
Ãw_size
 - 
i
->
v®ue_Ën
);

1707 
h”e
->
e_v®ue_size
 = 
	`ıu_to_Ë32
(
i
->
v®ue_Ën
);

1710 
upd©e_hash
:

1711 ià(
i
->
v®ue
) {

1712 
__Ë32
 
hash
 = 0;

1715 ià(
š_šode
) {

1716 
__Ë32
 
üc32c_hash
;

1723 
üc32c_hash
 = 
	`ıu_to_Ë32
(

1724 
	`ext4_x©Œ_šode_g‘_hash
(
Ãw_—_šode
));

1725 
hash
 = 
	`ext4_x©Œ_hash_’Œy
(
h”e
->
e_Çme
,

1726 
h”e
->
e_Çme_Ën
,

1727 &
üc32c_hash
, 1);

1728 } ià(
is_block
) {

1729 
__Ë32
 *
v®ue
 = 
s
->
ba£
 + 
	`Ë16_to_ıu
(

1730 
h”e
->
e_v®ue_offs
);

1732 
hash
 = 
	`ext4_x©Œ_hash_’Œy
(
h”e
->
e_Çme
,

1733 
h”e
->
e_Çme_Ën
, 
v®ue
,

1734 
Ãw_size
 >> 2);

1736 
h”e
->
e_hash
 = 
hash
;

1739 ià(
is_block
)

1740 
	`ext4_x©Œ_»hash
((
ext4_x©Œ_h—d”
 *)
s
->
ba£
);

1742 
»t
 = 0;

1743 
out
:

1744 
	`ut
(
Şd_—_šode
);

1745 
	`ut
(
Ãw_—_šode
);

1746  
»t
;

1747 
	}
}

1749 
	sext4_x©Œ_block_fšd
 {

1750 
ext4_x©Œ_£¬ch
 
	ms
;

1751 
bufãr_h—d
 *
	mbh
;

1755 
	$ext4_x©Œ_block_fšd
(
šode
 *šode, 
ext4_x©Œ_šfo
 *
i
,

1756 
ext4_x©Œ_block_fšd
 *
bs
)

1758 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1759 
”rÜ
;

1761 
	`—_idebug
(
šode
, "name=%d.%s, value=%p, value_len=%ld",

1762 
i
->
Çme_šdex
, i->
Çme
, i->
v®ue
, ()i->
v®ue_Ën
);

1764 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
) {

1766 
bs
->
bh
 = 
	`sb_b»ad
(
sb
, 
	`EXT4_I
(
šode
)->
i_fe_aş
);

1767 
”rÜ
 = -
EIO
;

1768 ià(!
bs
->
bh
)

1769 
ş—nup
;

1770 
	`—_bdebug
(
bs
->
bh
, "b_count=%d,„efcount=%d",

1771 
	`©omic_»ad
(&(
bs
->
bh
->
b_couÁ
)),

1772 
	`Ë32_to_ıu
(
	`BHDR
(
bs
->
bh
)->
h_»fcouÁ
));

1773 ià(
	`ext4_x©Œ_check_block
(
šode
, 
bs
->
bh
)) {

1774 
	`EXT4_ERROR_INODE
(
šode
, "bad block %llu",

1775 
	`EXT4_I
(
šode
)->
i_fe_aş
);

1776 
”rÜ
 = -
EFSCORRUPTED
;

1777 
ş—nup
;

1780 
bs
->
s
.
ba£
 = 
	`BHDR
(bs->
bh
);

1781 
bs
->
s
.
fœ¡
 = 
	`BFIRST
(bs->
bh
);

1782 
bs
->
s
.
’d
 = bs->
bh
->
b_d©a
 + bs->bh->
b_size
;

1783 
bs
->
s
.
h”e
 = bs->s.
fœ¡
;

1784 
”rÜ
 = 
	`ext4_x©Œ_fšd_’Œy
(&
bs
->
s
.
h”e
, 
i
->
Çme_šdex
,

1785 
i
->
Çme
, 1);

1786 ià(
”rÜ
 &&ƒ¼Ü !ğ-
ENODATA
)

1787 
ş—nup
;

1788 
bs
->
s
.
nÙ_found
 = 
”rÜ
;

1790 
”rÜ
 = 0;

1792 
ş—nup
:

1793  
”rÜ
;

1794 
	}
}

1797 
	$ext4_x©Œ_block_£t
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

1798 
ext4_x©Œ_šfo
 *
i
,

1799 
ext4_x©Œ_block_fšd
 *
bs
)

1801 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1802 
bufãr_h—d
 *
Ãw_bh
 = 
NULL
;

1803 
ext4_x©Œ_£¬ch
 
s_cİy
 = 
bs
->
s
;

1804 
ext4_x©Œ_£¬ch
 *
s
 = &
s_cİy
;

1805 
mb_ÿche_’Œy
 *
û
 = 
NULL
;

1806 
”rÜ
 = 0;

1807 
mb_ÿche
 *
—_block_ÿche
 = 
	`EA_BLOCK_CACHE
(
šode
);

1808 
šode
 *
—_šode
 = 
NULL
;

1809 
size_t
 
Şd_—_šode_size
 = 0;

1811 
	#h—d”
(
x
è((
ext4_x©Œ_h—d”
 *)(x))

	)

1813 ià(
s
->
ba£
) {

1814 
	`BUFFER_TRACE
(
bs
->
bh
, "get_write_access");

1815 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
bs
->
bh
);

1816 ià(
”rÜ
)

1817 
ş—nup
;

1818 
	`lock_bufãr
(
bs
->
bh
);

1820 ià(
	`h—d”
(
s
->
ba£
)->
h_»fcouÁ
 =ğ
	`ıu_to_Ë32
(1)) {

1821 
__u32
 
hash
 = 
	`Ë32_to_ıu
(
	`BHDR
(
bs
->
bh
)->
h_hash
);

1828 ià(
—_block_ÿche
)

1829 
	`mb_ÿche_’Œy_d–‘e
(
—_block_ÿche
, 
hash
,

1830 
bs
->
bh
->
b_blockÄ
);

1831 
	`—_bdebug
(
bs
->
bh
, "modifying in-place");

1832 
”rÜ
 = 
	`ext4_x©Œ_£t_’Œy
(
i
, 
s
, 
hªdË
, 
šode
,

1833 
Œue
 );

1834 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
bs
->
bh
);

1835 
	`uÆock_bufãr
(
bs
->
bh
);

1836 ià(
”rÜ
 =ğ-
EFSCORRUPTED
)

1837 
bad_block
;

1838 ià(!
”rÜ
)

1839 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
,

1840 
šode
,

1841 
bs
->
bh
);

1842 ià(
”rÜ
)

1843 
ş—nup
;

1844 
š£¹ed
;

1846 
off£t
 = (*)
s
->
h”e
 - 
bs
->
bh
->
b_d©a
;

1848 
	`uÆock_bufãr
(
bs
->
bh
);

1849 
	`—_bdebug
(
bs
->
bh
, "cloning");

1850 
s
->
ba£
 = 
	`km®loc
(
bs
->
bh
->
b_size
, 
GFP_NOFS
);

1851 
”rÜ
 = -
ENOMEM
;

1852 ià(
s
->
ba£
 =ğ
NULL
)

1853 
ş—nup
;

1854 
	`memıy
(
s
->
ba£
, 
	`BHDR
(
bs
->
bh
), bs->bh->
b_size
);

1855 
s
->
fœ¡
 = 
	`ENTRY
(
	`h—d”
(s->
ba£
)+1);

1856 
	`h—d”
(
s
->
ba£
)->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(1);

1857 
s
->
h”e
 = 
	`ENTRY
(s->
ba£
 + 
off£t
);

1858 
s
->
’d
 = s->
ba£
 + 
bs
->
bh
->
b_size
;

1867 ià(!
s
->
nÙ_found
 && s->
h”e
->
e_v®ue_šum
) {

1872 
Şd_—_šode_size
 = 
	`Ë32_to_ıu
(

1873 
s
->
h”e
->
e_v®ue_size
);

1874 
s
->
h”e
->
e_v®ue_šum
 = 0;

1875 
s
->
h”e
->
e_v®ue_size
 = 0;

1880 
s
->
ba£
 = 
	`kz®loc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

1882 
”rÜ
 = -
ENOMEM
;

1883 ià(
s
->
ba£
 =ğ
NULL
)

1884 
ş—nup
;

1885 
	`h—d”
(
s
->
ba£
)->
h_magic
 = 
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
);

1886 
	`h—d”
(
s
->
ba£
)->
h_blocks
 = 
	`ıu_to_Ë32
(1);

1887 
	`h—d”
(
s
->
ba£
)->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(1);

1888 
s
->
fœ¡
 = 
	`ENTRY
(
	`h—d”
(s->
ba£
)+1);

1889 
s
->
h”e
 = 
	`ENTRY
(
	`h—d”
(s->
ba£
)+1);

1890 
s
->
’d
 = s->
ba£
 + 
sb
->
s_blocksize
;

1893 
”rÜ
 = 
	`ext4_x©Œ_£t_’Œy
(
i
, 
s
, 
hªdË
, 
šode
, 
Œue
 );

1894 ià(
”rÜ
 =ğ-
EFSCORRUPTED
)

1895 
bad_block
;

1896 ià(
”rÜ
)

1897 
ş—nup
;

1899 ià(
i
->
v®ue
 && 
s
->
h”e
->
e_v®ue_šum
) {

1900 
—_šo
;

1908 
—_šo
 = 
	`Ë32_to_ıu
(
s
->
h”e
->
e_v®ue_šum
);

1909 
”rÜ
 = 
	`ext4_x©Œ_šode_ig‘
(
šode
, 
—_šo
, &
—_šode
);

1910 ià(
”rÜ
) {

1911 
—_šode
 = 
NULL
;

1912 
ş—nup
;

1916 
š£¹ed
:

1917 ià(!
	`IS_LAST_ENTRY
(
s
->
fœ¡
)) {

1918 
Ãw_bh
 = 
	`ext4_x©Œ_block_ÿche_fšd
(
šode
, 
	`h—d”
(
s
->
ba£
),

1919 &
û
);

1920 ià(
Ãw_bh
) {

1922 ià(
Ãw_bh
 =ğ
bs
->
bh
)

1923 
	`—_bdebug
(
Ãw_bh
, "keeping");

1925 
u32
 
»f
;

1927 
	`WARN_ON_ONCE
(
	`dquÙ_š™Ÿlize_Ãeded
(
šode
));

1931 
”rÜ
 = 
	`dquÙ_®loc_block
(
šode
,

1932 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 1));

1933 ià(
”rÜ
)

1934 
ş—nup
;

1935 
	`BUFFER_TRACE
(
Ãw_bh
, "get_write_access");

1936 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
,

1937 
Ãw_bh
);

1938 ià(
”rÜ
)

1939 
ş—nup_dquÙ
;

1940 
	`lock_bufãr
(
Ãw_bh
);

1953 ià(
	`hli¡_bl_unhashed
(&
û
->
e_hash_li¡
) ||

1954 !
û
->
e_»u§bË
) {

1959 
	`uÆock_bufãr
(
Ãw_bh
);

1960 
	`dquÙ_ä“_block
(
šode
,

1961 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
),

1963 
	`b»l£
(
Ãw_bh
);

1964 
	`mb_ÿche_’Œy_put
(
—_block_ÿche
, 
û
);

1965 
û
 = 
NULL
;

1966 
Ãw_bh
 = 
NULL
;

1967 
š£¹ed
;

1969 
»f
 = 
	`Ë32_to_ıu
(
	`BHDR
(
Ãw_bh
)->
h_»fcouÁ
) + 1;

1970 
	`BHDR
(
Ãw_bh
)->
h_»fcouÁ
 = 
	`ıu_to_Ë32
(
»f
);

1971 ià(
»f
 >ğ
EXT4_XATTR_REFCOUNT_MAX
)

1972 
û
->
e_»u§bË
 = 0;

1973 
	`—_bdebug
(
Ãw_bh
, "reusing;„efcount‚ow=%d",

1974 
»f
);

1975 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
Ãw_bh
);

1976 
	`uÆock_bufãr
(
Ãw_bh
);

1977 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
,

1978 
šode
,

1979 
Ãw_bh
);

1980 ià(
”rÜ
)

1981 
ş—nup_dquÙ
;

1983 
	`mb_ÿche_’Œy_touch
(
—_block_ÿche
, 
û
);

1984 
	`mb_ÿche_’Œy_put
(
—_block_ÿche
, 
û
);

1985 
û
 = 
NULL
;

1986 } ià(
bs
->
bh
 && 
s
->
ba£
 =ğbs->bh->
b_d©a
) {

1988 
	`—_bdebug
(
bs
->
bh
, "keepinghis block");

1989 
	`ext4_x©Œ_block_ÿche_š£¹
(
—_block_ÿche
, 
bs
->
bh
);

1990 
Ãw_bh
 = 
bs
->
bh
;

1991 
	`g‘_bh
(
Ãw_bh
);

1994 
ext4_fsblk_t
 
gßl
, 
block
;

1996 
	`WARN_ON_ONCE
(
	`dquÙ_š™Ÿlize_Ãeded
(
šode
));

1998 
gßl
 = 
	`ext4_group_fœ¡_block_no
(
sb
,

1999 
	`EXT4_I
(
šode
)->
i_block_group
);

2002 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

2003 
gßl
 = gßÈ& 
EXT4_MAX_BLOCK_FILE_PHYS
;

2005 
block
 = 
	`ext4_Ãw_m‘a_blocks
(
hªdË
, 
šode
, 
gßl
, 0,

2006 
NULL
, &
”rÜ
);

2007 ià(
”rÜ
)

2008 
ş—nup
;

2010 ià(!(
	`ext4_‹¡_šode_æag
(
šode
, 
EXT4_INODE_EXTENTS
)))

2011 
	`BUG_ON
(
block
 > 
EXT4_MAX_BLOCK_FILE_PHYS
);

2013 
	`—_idebug
(
šode
, "creating block %llu",

2014 ()
block
);

2016 
Ãw_bh
 = 
	`sb_g‘blk
(
sb
, 
block
);

2017 ià(
	`uÆik–y
(!
Ãw_bh
)) {

2018 
”rÜ
 = -
ENOMEM
;

2019 
g‘blk_çed
:

2020 
	`ext4_ä“_blocks
(
hªdË
, 
šode
, 
NULL
, 
block
, 1,

2021 
EXT4_FREE_BLOCKS_METADATA
);

2022 
ş—nup
;

2024 
”rÜ
 = 
	`ext4_x©Œ_šode_šc_»f_®l
(
hªdË
, 
šode
,

2025 
	`ENTRY
(
	`h—d”
(
s
->
ba£
)+1));

2026 ià(
”rÜ
)

2027 
g‘blk_çed
;

2028 ià(
—_šode
) {

2030 
”rÜ
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
,

2031 
—_šode
);

2032 ià(
”rÜ
)

2033 
	`ext4_w¬nšg_šode
(
—_šode
,

2035 
”rÜ
);

2036 
	`ut
(
—_šode
);

2037 
—_šode
 = 
NULL
;

2040 
	`lock_bufãr
(
Ãw_bh
);

2041 
”rÜ
 = 
	`ext4_jouº®_g‘_ü—‹_acûss
(
hªdË
, 
Ãw_bh
);

2042 ià(
”rÜ
) {

2043 
	`uÆock_bufãr
(
Ãw_bh
);

2044 
”rÜ
 = -
EIO
;

2045 
g‘blk_çed
;

2047 
	`memıy
(
Ãw_bh
->
b_d©a
, 
s
->
ba£
,‚ew_bh->
b_size
);

2048 
	`ext4_x©Œ_block_csum_£t
(
šode
, 
Ãw_bh
);

2049 
	`£t_bufãr_u±od©e
(
Ãw_bh
);

2050 
	`uÆock_bufãr
(
Ãw_bh
);

2051 
	`ext4_x©Œ_block_ÿche_š£¹
(
—_block_ÿche
, 
Ãw_bh
);

2052 
”rÜ
 = 
	`ext4_hªdË_dœty_m‘ad©a
(
hªdË
, 
šode
,

2053 
Ãw_bh
);

2054 ià(
”rÜ
)

2055 
ş—nup
;

2059 ià(
Şd_—_šode_size
)

2060 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
, 
Şd_—_šode_size
);

2063 
	`EXT4_I
(
šode
)->
i_fe_aş
 = 
Ãw_bh
 ?‚ew_bh->
b_blockÄ
 : 0;

2066 ià(
bs
->
bh
 && bs->bh !ğ
Ãw_bh
) {

2067 
ext4_x©Œ_šode_¬¿y
 *
—_šode_¬¿y
 = 
NULL
;

2069 
	`ext4_x©Œ_»Ëa£_block
(
hªdË
, 
šode
, 
bs
->
bh
,

2070 &
—_šode_¬¿y
,

2072 
	`ext4_x©Œ_šode_¬¿y_ä“
(
—_šode_¬¿y
);

2074 
”rÜ
 = 0;

2076 
ş—nup
:

2077 ià(
—_šode
) {

2078 
”rÜ2
;

2080 
”rÜ2
 = 
	`ext4_x©Œ_šode_dec_»f
(
hªdË
, 
—_šode
);

2081 ià(
”rÜ2
)

2082 
	`ext4_w¬nšg_šode
(
—_šode
, "dec„efƒrror=%d",

2083 
”rÜ2
);

2086 ià(
”rÜ
)

2087 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
,

2088 
	`i_size_»ad
(
—_šode
));

2089 
	`ut
(
—_šode
);

2091 ià(
û
)

2092 
	`mb_ÿche_’Œy_put
(
—_block_ÿche
, 
û
);

2093 
	`b»l£
(
Ãw_bh
);

2094 ià(!(
bs
->
bh
 && 
s
->
ba£
 =ğbs->bh->
b_d©a
))

2095 
	`kä“
(
s
->
ba£
);

2097  
”rÜ
;

2099 
ş—nup_dquÙ
:

2100 
	`dquÙ_ä“_block
(
šode
, 
	`EXT4_C2B
(
	`EXT4_SB
(
sb
), 1));

2101 
ş—nup
;

2103 
bad_block
:

2104 
	`EXT4_ERROR_INODE
(
šode
, "bad block %llu",

2105 
	`EXT4_I
(
šode
)->
i_fe_aş
);

2106 
ş—nup
;

2108 #undeà
h—d”


2109 
	}
}

2111 
	$ext4_x©Œ_ibody_fšd
(
šode
 *šode, 
ext4_x©Œ_šfo
 *
i
,

2112 
ext4_x©Œ_ibody_fšd
 *
is
)

2114 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2115 
ext4_šode
 *
¿w_šode
;

2116 
”rÜ
;

2118 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

2120 
¿w_šode
 = 
	`ext4_¿w_šode
(&
is
->
oc
);

2121 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

2122 
is
->
s
.
ba£
 = is->s.
fœ¡
 = 
	`IFIRST
(
h—d”
);

2123 
is
->
s
.
h”e
 = is->s.
fœ¡
;

2124 
is
->
s
.
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

2125 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
)) {

2126 
”rÜ
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
is
->
s
.
’d
);

2127 ià(
”rÜ
)

2128  
”rÜ
;

2130 
”rÜ
 = 
	`ext4_x©Œ_fšd_’Œy
(&
is
->
s
.
h”e
, 
i
->
Çme_šdex
,

2131 
i
->
Çme
, 0);

2132 ià(
”rÜ
 &&ƒ¼Ü !ğ-
ENODATA
)

2133  
”rÜ
;

2134 
is
->
s
.
nÙ_found
 = 
”rÜ
;

2137 
	}
}

2139 
	$ext4_x©Œ_ibody_šlše_£t
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2140 
ext4_x©Œ_šfo
 *
i
,

2141 
ext4_x©Œ_ibody_fšd
 *
is
)

2143 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2144 
ext4_x©Œ_£¬ch
 *
s
 = &
is
->s;

2145 
”rÜ
;

2147 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

2148  -
ENOSPC
;

2149 
”rÜ
 = 
	`ext4_x©Œ_£t_’Œy
(
i
, 
s
, 
hªdË
, 
šode
, 
çl£
 );

2150 ià(
”rÜ
) {

2151 ià(
”rÜ
 =ğ-
ENOSPC
 &&

2152 
	`ext4_has_šlše_d©a
(
šode
)) {

2153 
”rÜ
 = 
	`ext4_Œy_to_eviù_šlše_d©a
(
hªdË
, 
šode
,

2154 
	`EXT4_XATTR_LEN
(
	`¡¾’
(
i
->
Çme
) +

2155 
	`EXT4_XATTR_SIZE
(
i
->
v®ue_Ën
)));

2156 ià(
”rÜ
)

2157  
”rÜ
;

2158 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, 
i
, 
is
);

2159 ià(
”rÜ
)

2160  
”rÜ
;

2161 
”rÜ
 = 
	`ext4_x©Œ_£t_’Œy
(
i
, 
s
, 
hªdË
, 
šode
,

2162 
çl£
 );

2164 ià(
”rÜ
)

2165  
”rÜ
;

2167 
h—d”
 = 
	`IHDR
(
šode
, 
	`ext4_¿w_šode
(&
is
->
oc
));

2168 ià(!
	`IS_LAST_ENTRY
(
s
->
fœ¡
)) {

2169 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
);

2170 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

2172 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(0);

2173 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

2176 
	}
}

2178 
	$ext4_x©Œ_ibody_£t
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2179 
ext4_x©Œ_šfo
 *
i
,

2180 
ext4_x©Œ_ibody_fšd
 *
is
)

2182 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2183 
ext4_x©Œ_£¬ch
 *
s
 = &
is
->s;

2184 
”rÜ
;

2186 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 == 0)

2187  -
ENOSPC
;

2188 
”rÜ
 = 
	`ext4_x©Œ_£t_’Œy
(
i
, 
s
, 
hªdË
, 
šode
, 
çl£
 );

2189 ià(
”rÜ
)

2190  
”rÜ
;

2191 
h—d”
 = 
	`IHDR
(
šode
, 
	`ext4_¿w_šode
(&
is
->
oc
));

2192 ià(!
	`IS_LAST_ENTRY
(
s
->
fœ¡
)) {

2193 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
);

2194 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

2196 
h—d”
->
h_magic
 = 
	`ıu_to_Ë32
(0);

2197 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
);

2200 
	}
}

2202 
	$ext4_x©Œ_v®ue_§me
(
ext4_x©Œ_£¬ch
 *
s
,

2203 
ext4_x©Œ_šfo
 *
i
)

2205 *
v®ue
;

2208 ià(
s
->
h”e
->
e_v®ue_šum
)

2210 ià(
	`Ë32_to_ıu
(
s
->
h”e
->
e_v®ue_size
è!ğ
i
->
v®ue_Ën
)

2212 
v®ue
 = ((*)
s
->
ba£
è+ 
	`Ë16_to_ıu
(s->
h”e
->
e_v®ue_offs
);

2213  !
	`memcmp
(
v®ue
, 
i
->v®ue, i->
v®ue_Ën
);

2214 
	}
}

2216 
bufãr_h—d
 *
	$ext4_x©Œ_g‘_block
(
šode
 *inode)

2218 
bufãr_h—d
 *
bh
;

2219 
”rÜ
;

2221 ià(!
	`EXT4_I
(
šode
)->
i_fe_aş
)

2222  
NULL
;

2223 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
);

2224 ià(!
bh
)

2225  
	`ERR_PTR
(-
EIO
);

2226 
”rÜ
 = 
	`ext4_x©Œ_check_block
(
šode
, 
bh
);

2227 ià(
”rÜ
)

2228  
	`ERR_PTR
(
”rÜ
);

2229  
bh
;

2230 
	}
}

2245 
	$ext4_x©Œ_£t_hªdË
(
hªdË_t
 *
hªdË
, 
šode
 *šode, 
Çme_šdex
,

2246 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
,

2247 
æags
)

2249 
ext4_x©Œ_šfo
 
i
 = {

2250 .
Çme_šdex
 =‚ame_index,

2251 .
Çme
 =‚ame,

2252 .
v®ue
 = value,

2253 .
v®ue_Ën
 = value_len,

2254 .
š_šode
 = 0,

2256 
ext4_x©Œ_ibody_fšd
 
is
 = {

2257 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

2259 
ext4_x©Œ_block_fšd
 
bs
 = {

2260 .
s
 = { .
nÙ_found
 = -
ENODATA
, },

2262 
no_ex·nd
;

2263 
”rÜ
;

2265 ià(!
Çme
)

2266  -
EINVAL
;

2267 ià(
	`¡¾’
(
Çme
) > 255)

2268  -
ERANGE
;

2270 
	`ext4_wr™e_lock_x©Œ
(
šode
, &
no_ex·nd
);

2273 ià(
	`ext4_hªdË_v®id
(
hªdË
)) {

2274 
bufãr_h—d
 *
bh
;

2275 
üed™s
;

2277 
bh
 = 
	`ext4_x©Œ_g‘_block
(
šode
);

2278 ià(
	`IS_ERR
(
bh
)) {

2279 
”rÜ
 = 
	`PTR_ERR
(
bh
);

2280 
ş—nup
;

2283 
üed™s
 = 
	`__ext4_x©Œ_£t_üed™s
(
šode
->
i_sb
, inode, 
bh
,

2284 
v®ue_Ën
,

2285 
æags
 & 
XATTR_CREATE
);

2286 
	`b»l£
(
bh
);

2288 ià(!
	`ext4_hªdË_has_’ough_üed™s
(
hªdË
, 
üed™s
)) {

2289 
”rÜ
 = -
ENOSPC
;

2290 
ş—nup
;

2294 
”rÜ
 = 
	`ext4_»£rve_šode_wr™e
(
hªdË
, 
šode
, &
is
.
oc
);

2295 ià(
”rÜ
)

2296 
ş—nup
;

2298 ià(
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
)) {

2299 
ext4_šode
 *
¿w_šode
 = 
	`ext4_¿w_šode
(&
is
.
oc
);

2300 
	`mem£t
(
¿w_šode
, 0, 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
);

2301 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_NEW
);

2304 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, &
is
);

2305 ià(
”rÜ
)

2306 
ş—nup
;

2307 ià(
is
.
s
.
nÙ_found
)

2308 
”rÜ
 = 
	`ext4_x©Œ_block_fšd
(
šode
, &
i
, &
bs
);

2309 ià(
”rÜ
)

2310 
ş—nup
;

2311 ià(
is
.
s
.
nÙ_found
 && 
bs
.s.not_found) {

2312 
”rÜ
 = -
ENODATA
;

2313 ià(
æags
 & 
XATTR_REPLACE
)

2314 
ş—nup
;

2315 
”rÜ
 = 0;

2316 ià(!
v®ue
)

2317 
ş—nup
;

2319 
”rÜ
 = -
EEXIST
;

2320 ià(
æags
 & 
XATTR_CREATE
)

2321 
ş—nup
;

2324 ià(!
v®ue
) {

2325 ià(!
is
.
s
.
nÙ_found
)

2326 
”rÜ
 = 
	`ext4_x©Œ_ibody_£t
(
hªdË
, 
šode
, &
i
, &
is
);

2327 ià(!
bs
.
s
.
nÙ_found
)

2328 
”rÜ
 = 
	`ext4_x©Œ_block_£t
(
hªdË
, 
šode
, &
i
, &
bs
);

2330 
”rÜ
 = 0;

2332 ià(!
is
.
s
.
nÙ_found
 && 
	`ext4_x©Œ_v®ue_§me
(&is.s, &
i
))

2333 
ş—nup
;

2334 ià(!
bs
.
s
.
nÙ_found
 && 
	`ext4_x©Œ_v®ue_§me
(&bs.s, &
i
))

2335 
ş—nup
;

2337 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
) &&

2338 (
	`EXT4_XATTR_SIZE
(
i
.
v®ue_Ën
) >

2339 
	`EXT4_XATTR_MIN_LARGE_EA_SIZE
(
šode
->
i_sb
->
s_blocksize
)))

2340 
i
.
š_šode
 = 1;

2341 
»Œy_šode
:

2342 
”rÜ
 = 
	`ext4_x©Œ_ibody_£t
(
hªdË
, 
šode
, &
i
, &
is
);

2343 ià(!
”rÜ
 && !
bs
.
s
.
nÙ_found
) {

2344 
i
.
v®ue
 = 
NULL
;

2345 
”rÜ
 = 
	`ext4_x©Œ_block_£t
(
hªdË
, 
šode
, &
i
, &
bs
);

2346 } ià(
”rÜ
 =ğ-
ENOSPC
) {

2347 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
 && !
bs
.
s
.
ba£
) {

2348 
”rÜ
 = 
	`ext4_x©Œ_block_fšd
(
šode
, &
i
, &
bs
);

2349 ià(
”rÜ
)

2350 
ş—nup
;

2352 
”rÜ
 = 
	`ext4_x©Œ_block_£t
(
hªdË
, 
šode
, &
i
, &
bs
);

2353 ià(!
”rÜ
 && !
is
.
s
.
nÙ_found
) {

2354 
i
.
v®ue
 = 
NULL
;

2355 
”rÜ
 = 
	`ext4_x©Œ_ibody_£t
(
hªdË
, 
šode
, &
i
,

2356 &
is
);

2357 } ià(
”rÜ
 =ğ-
ENOSPC
) {

2362 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
) &&

2363 !
i
.
š_šode
) {

2364 
i
.
š_šode
 = 1;

2365 
»Œy_šode
;

2370 ià(!
”rÜ
) {

2371 
	`ext4_x©Œ_upd©e_su³r_block
(
hªdË
, 
šode
->
i_sb
);

2372 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

2373 ià(!
v®ue
)

2374 
no_ex·nd
 = 0;

2375 
”rÜ
 = 
	`ext4_m¬k_oc_dœty
(
hªdË
, 
šode
, &
is
.
oc
);

2380 
is
.
oc
.
bh
 = 
NULL
;

2381 ià(
	`IS_SYNC
(
šode
))

2382 
	`ext4_hªdË_sync
(
hªdË
);

2384 
	`ext4_fc_m¬k_š–igibË
(
šode
,

2385 
EXT4_FC_REASON_XATTR
);

2387 
ş—nup
:

2388 
	`b»l£
(
is
.
oc
.
bh
);

2389 
	`b»l£
(
bs
.
bh
);

2390 
	`ext4_wr™e_uÆock_x©Œ
(
šode
, &
no_ex·nd
);

2391  
”rÜ
;

2392 
	}
}

2394 
	$ext4_x©Œ_£t_üed™s
(
šode
 *šode, 
size_t
 
v®ue_Ën
,

2395 
boŞ
 
is_ü—‹
, *
üed™s
)

2397 
bufãr_h—d
 *
bh
;

2398 
”r
;

2400 *
üed™s
 = 0;

2402 ià(!
	`EXT4_SB
(
šode
->
i_sb
)->
s_jouº®
)

2405 
	`down_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

2407 
bh
 = 
	`ext4_x©Œ_g‘_block
(
šode
);

2408 ià(
	`IS_ERR
(
bh
)) {

2409 
”r
 = 
	`PTR_ERR
(
bh
);

2411 *
üed™s
 = 
	`__ext4_x©Œ_£t_üed™s
(
šode
->
i_sb
, inode, 
bh
,

2412 
v®ue_Ën
, 
is_ü—‹
);

2413 
	`b»l£
(
bh
);

2414 
”r
 = 0;

2417 
	`up_»ad
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

2418  
”r
;

2419 
	}
}

2430 
	$ext4_x©Œ_£t
(
šode
 *šode, 
Çme_šdex
, cÚ¡ *
Çme
,

2431 cÚ¡ *
v®ue
, 
size_t
 
v®ue_Ën
, 
æags
)

2433 
hªdË_t
 *
hªdË
;

2434 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

2435 
”rÜ
, 
»Œ›s
 = 0;

2436 
üed™s
;

2438 
”rÜ
 = 
	`dquÙ_š™Ÿlize
(
šode
);

2439 ià(
”rÜ
)

2440  
”rÜ
;

2442 
»Œy
:

2443 
”rÜ
 = 
	`ext4_x©Œ_£t_üed™s
(
šode
, 
v®ue_Ën
, 
æags
 & 
XATTR_CREATE
,

2444 &
üed™s
);

2445 ià(
”rÜ
)

2446  
”rÜ
;

2448 
hªdË
 = 
	`ext4_jouº®_¡¬t
(
šode
, 
EXT4_HT_XATTR
, 
üed™s
);

2449 ià(
	`IS_ERR
(
hªdË
)) {

2450 
”rÜ
 = 
	`PTR_ERR
(
hªdË
);

2452 
”rÜ2
;

2454 
”rÜ
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
, 
Çme_šdex
, 
Çme
,

2455 
v®ue
, 
v®ue_Ën
, 
æags
);

2456 
”rÜ2
 = 
	`ext4_jouº®_¡İ
(
hªdË
);

2457 ià(
”rÜ
 =ğ-
ENOSPC
 &&

2458 
	`ext4_should_»Œy_®loc
(
sb
, &
»Œ›s
))

2459 
»Œy
;

2460 ià(
”rÜ
 == 0)

2461 
”rÜ
 = 
”rÜ2
;

2463 
	`ext4_fc_m¬k_š–igibË
(
šode
,

2464 
EXT4_FC_REASON_XATTR
);

2466  
”rÜ
;

2467 
	}
}

2473 
	$ext4_x©Œ_shiá_’Œ›s
(
ext4_x©Œ_’Œy
 *
’Œy
,

2474 
v®ue_offs_shiá
, *
to
,

2475 *
äom
, 
size_t
 
n
)

2477 
ext4_x©Œ_’Œy
 *
Ï¡
 = 
’Œy
;

2478 
Ãw_offs
;

2481 
	`BUG_ON
(
v®ue_offs_shiá
 > 0);

2484 ; !
	`IS_LAST_ENTRY
(
Ï¡
);†a¡ = 
	`EXT4_XATTR_NEXT
(last)) {

2485 ià(!
Ï¡
->
e_v®ue_šum
 &&†a¡->
e_v®ue_size
) {

2486 
Ãw_offs
 = 
	`Ë16_to_ıu
(
Ï¡
->
e_v®ue_offs
) +

2487 
v®ue_offs_shiá
;

2488 
Ï¡
->
e_v®ue_offs
 = 
	`ıu_to_Ë16
(
Ãw_offs
);

2492 
	`memmove
(
to
, 
äom
, 
n
);

2493 
	}
}

2498 
	$ext4_x©Œ_move_to_block
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2499 
ext4_šode
 *
¿w_šode
,

2500 
ext4_x©Œ_’Œy
 *
’Œy
)

2502 
ext4_x©Œ_ibody_fšd
 *
is
 = 
NULL
;

2503 
ext4_x©Œ_block_fšd
 *
bs
 = 
NULL
;

2504 *
bufãr
 = 
NULL
, *
b_’Œy_Çme
 = NULL;

2505 
size_t
 
v®ue_size
 = 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
);

2506 
ext4_x©Œ_šfo
 
i
 = {

2507 .
v®ue
 = 
NULL
,

2508 .
v®ue_Ën
 = 0,

2509 .
Çme_šdex
 = 
’Œy
->
e_Çme_šdex
,

2510 .
š_šode
 = !!
’Œy
->
e_v®ue_šum
,

2512 
ext4_x©Œ_ibody_h—d”
 *
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

2513 
”rÜ
;

2515 
is
 = 
	`kz®loc
((
ext4_x©Œ_ibody_fšd
), 
GFP_NOFS
);

2516 
bs
 = 
	`kz®loc
((
ext4_x©Œ_block_fšd
), 
GFP_NOFS
);

2517 
bufãr
 = 
	`km®loc
(
v®ue_size
, 
GFP_NOFS
);

2518 
b_’Œy_Çme
 = 
	`km®loc
(
’Œy
->
e_Çme_Ën
 + 1, 
GFP_NOFS
);

2519 ià(!
is
 || !
bs
 || !
bufãr
 || !
b_’Œy_Çme
) {

2520 
”rÜ
 = -
ENOMEM
;

2521 
out
;

2524 
is
->
s
.
nÙ_found
 = -
ENODATA
;

2525 
bs
->
s
.
nÙ_found
 = -
ENODATA
;

2526 
is
->
oc
.
bh
 = 
NULL
;

2527 
bs
->
bh
 = 
NULL
;

2530 ià(
’Œy
->
e_v®ue_šum
) {

2531 
”rÜ
 = 
	`ext4_x©Œ_šode_g‘
(
šode
, 
’Œy
, 
bufãr
, 
v®ue_size
);

2532 ià(
”rÜ
)

2533 
out
;

2535 
size_t
 
v®ue_offs
 = 
	`Ë16_to_ıu
(
’Œy
->
e_v®ue_offs
);

2536 
	`memıy
(
bufãr
, (*)
	`IFIRST
(
h—d”
è+ 
v®ue_offs
, 
v®ue_size
);

2539 
	`memıy
(
b_’Œy_Çme
, 
’Œy
->
e_Çme
,ƒÁry->
e_Çme_Ën
);

2540 
b_’Œy_Çme
[
’Œy
->
e_Çme_Ën
] = '\0';

2541 
i
.
Çme
 = 
b_’Œy_Çme
;

2543 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
is
->
oc
);

2544 ià(
”rÜ
)

2545 
out
;

2547 
”rÜ
 = 
	`ext4_x©Œ_ibody_fšd
(
šode
, &
i
, 
is
);

2548 ià(
”rÜ
)

2549 
out
;

2552 
”rÜ
 = 
	`ext4_x©Œ_ibody_£t
(
hªdË
, 
šode
, &
i
, 
is
);

2553 ià(
”rÜ
)

2554 
out
;

2556 
i
.
v®ue
 = 
bufãr
;

2557 
i
.
v®ue_Ën
 = 
v®ue_size
;

2558 
”rÜ
 = 
	`ext4_x©Œ_block_fšd
(
šode
, &
i
, 
bs
);

2559 ià(
”rÜ
)

2560 
out
;

2563 
”rÜ
 = 
	`ext4_x©Œ_block_£t
(
hªdË
, 
šode
, &
i
, 
bs
);

2564 ià(
”rÜ
)

2565 
out
;

2566 
”rÜ
 = 0;

2567 
out
:

2568 
	`kä“
(
b_’Œy_Çme
);

2569 
	`kä“
(
bufãr
);

2570 ià(
is
)

2571 
	`b»l£
(
is
->
oc
.
bh
);

2572 
	`kä“
(
is
);

2573 
	`kä“
(
bs
);

2575  
”rÜ
;

2576 
	}
}

2578 
	$ext4_x©Œ_make_šode_¥aû
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2579 
ext4_šode
 *
¿w_šode
,

2580 
isize_diff
, 
size_t
 
iä“
,

2581 
size_t
 
bä“
, *
tÙ®_šo
)

2583 
ext4_x©Œ_ibody_h—d”
 *
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

2584 
ext4_x©Œ_’Œy
 *
sm®l_’Œy
;

2585 
ext4_x©Œ_’Œy
 *
’Œy
;

2586 
ext4_x©Œ_’Œy
 *
Ï¡
;

2587 
’Œy_size
;

2588 
tÙ®_size
;

2589 
mš_tÙ®_size
;

2590 
”rÜ
;

2592 
isize_diff
 > 
iä“
) {

2593 
’Œy
 = 
NULL
;

2594 
sm®l_’Œy
 = 
NULL
;

2595 
mš_tÙ®_size
 = ~0U;

2596 
Ï¡
 = 
	`IFIRST
(
h—d”
);

2598 ; !
	`IS_LAST_ENTRY
(
Ï¡
);†a¡ = 
	`EXT4_XATTR_NEXT
(last)) {

2599 
tÙ®_size
 = 
	`EXT4_XATTR_LEN
(
Ï¡
->
e_Çme_Ën
);

2600 ià(!
Ï¡
->
e_v®ue_šum
)

2601 
tÙ®_size
 +ğ
	`EXT4_XATTR_SIZE
(

2602 
	`Ë32_to_ıu
(
Ï¡
->
e_v®ue_size
));

2603 ià(
tÙ®_size
 <ğ
bä“
 &&

2604 
tÙ®_size
 < 
mš_tÙ®_size
) {

2605 ià(
tÙ®_size
 + 
iä“
 < 
isize_diff
) {

2606 
sm®l_’Œy
 = 
Ï¡
;

2608 
’Œy
 = 
Ï¡
;

2609 
mš_tÙ®_size
 = 
tÙ®_size
;

2614 ià(
’Œy
 =ğ
NULL
) {

2615 ià(
sm®l_’Œy
 =ğ
NULL
)

2616  -
ENOSPC
;

2617 
’Œy
 = 
sm®l_’Œy
;

2620 
’Œy_size
 = 
	`EXT4_XATTR_LEN
(
’Œy
->
e_Çme_Ën
);

2621 
tÙ®_size
 = 
’Œy_size
;

2622 ià(!
’Œy
->
e_v®ue_šum
)

2623 
tÙ®_size
 +ğ
	`EXT4_XATTR_SIZE
(

2624 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

2625 
”rÜ
 = 
	`ext4_x©Œ_move_to_block
(
hªdË
, 
šode
, 
¿w_šode
,

2626 
’Œy
);

2627 ià(
”rÜ
)

2628  
”rÜ
;

2630 *
tÙ®_šo
 -ğ
’Œy_size
;

2631 
iä“
 +ğ
tÙ®_size
;

2632 
bä“
 -ğ
tÙ®_size
;

2636 
	}
}

2642 
	$ext4_ex·nd_exŒa_isize_—
(
šode
 *šode, 
Ãw_exŒa_isize
,

2643 
ext4_šode
 *
¿w_šode
, 
hªdË_t
 *
hªdË
)

2645 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2646 
bufãr_h—d
 *
bh
;

2647 
ext4_sb_šfo
 *
sbi
 = 
	`EXT4_SB
(
šode
->
i_sb
);

2648 
mÁ_couÁ
;

2649 
size_t
 
mš_offs
;

2650 
size_t
 
iä“
, 
bä“
;

2651 
tÙ®_šo
;

2652 *
ba£
, *
’d
;

2653 
”rÜ
 = 0, 
Œ›d_mš_exŒa_isize
 = 0;

2654 
s_mš_exŒa_isize
 = 
	`Ë16_to_ıu
(
sbi
->
s_es
->s_min_extra_isize);

2655 
isize_diff
;

2657 
»Œy
:

2658 
isize_diff
 = 
Ãw_exŒa_isize
 - 
	`EXT4_I
(
šode
)->
i_exŒa_isize
;

2659 ià(
	`EXT4_I
(
šode
)->
i_exŒa_isize
 >ğ
Ãw_exŒa_isize
)

2662 
h—d”
 = 
	`IHDR
(
šode
, 
¿w_šode
);

2669 
ba£
 = 
	`IFIRST
(
h—d”
);

2670 
’d
 = (*)
¿w_šode
 + 
	`EXT4_SB
(
šode
->
i_sb
)->
s_šode_size
;

2671 
mš_offs
 = 
’d
 - 
ba£
;

2672 
tÙ®_šo
 = (
ext4_x©Œ_ibody_h—d”
);

2674 
”rÜ
 = 
	`x©Œ_check_šode
(
šode
, 
h—d”
, 
’d
);

2675 ià(
”rÜ
)

2676 
ş—nup
;

2678 
iä“
 = 
	`ext4_x©Œ_ä“_¥aû
(
ba£
, &
mš_offs
, ba£, &
tÙ®_šo
);

2679 ià(
iä“
 >ğ
isize_diff
)

2680 
shiá
;

2686 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
) {

2687 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
);

2688 
”rÜ
 = -
EIO
;

2689 ià(!
bh
)

2690 
ş—nup
;

2691 ià(
	`ext4_x©Œ_check_block
(
šode
, 
bh
)) {

2692 
	`EXT4_ERROR_INODE
(
šode
, "bad block %llu",

2693 
	`EXT4_I
(
šode
)->
i_fe_aş
);

2694 
”rÜ
 = -
EFSCORRUPTED
;

2695 
	`b»l£
(
bh
);

2696 
ş—nup
;

2698 
ba£
 = 
	`BHDR
(
bh
);

2699 
’d
 = 
bh
->
b_d©a
 + bh->
b_size
;

2700 
mš_offs
 = 
’d
 - 
ba£
;

2701 
bä“
 = 
	`ext4_x©Œ_ä“_¥aû
(
	`BFIRST
(
bh
), &
mš_offs
, 
ba£
,

2702 
NULL
);

2703 
	`b»l£
(
bh
);

2704 ià(
bä“
 + 
iä“
 < 
isize_diff
) {

2705 ià(!
Œ›d_mš_exŒa_isize
 && 
s_mš_exŒa_isize
) {

2706 
Œ›d_mš_exŒa_isize
++;

2707 
Ãw_exŒa_isize
 = 
s_mš_exŒa_isize
;

2708 
»Œy
;

2710 
”rÜ
 = -
ENOSPC
;

2711 
ş—nup
;

2714 
bä“
 = 
šode
->
i_sb
->
s_blocksize
;

2717 
”rÜ
 = 
	`ext4_x©Œ_make_šode_¥aû
(
hªdË
, 
šode
, 
¿w_šode
,

2718 
isize_diff
, 
iä“
, 
bä“
,

2719 &
tÙ®_šo
);

2720 ià(
”rÜ
) {

2721 ià(
”rÜ
 =ğ-
ENOSPC
 && !
Œ›d_mš_exŒa_isize
 &&

2722 
s_mš_exŒa_isize
) {

2723 
Œ›d_mš_exŒa_isize
++;

2724 
Ãw_exŒa_isize
 = 
s_mš_exŒa_isize
;

2725 
»Œy
;

2727 
ş—nup
;

2729 
shiá
:

2731 
	`ext4_x©Œ_shiá_’Œ›s
(
	`IFIRST
(
h—d”
), 
	`EXT4_I
(
šode
)->
i_exŒa_isize


2732 - 
Ãw_exŒa_isize
, (*)
¿w_šode
 +

2733 
EXT4_GOOD_OLD_INODE_SIZE
 + 
Ãw_exŒa_isize
,

2734 (*)
h—d”
, 
tÙ®_šo
);

2735 
	`EXT4_I
(
šode
)->
i_exŒa_isize
 = 
Ãw_exŒa_isize
;

2737 
ş—nup
:

2738 ià(
”rÜ
 && (
mÁ_couÁ
 !ğ
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_mÁ_couÁ
))) {

2739 
	`ext4_w¬nšg
(
šode
->
i_sb
, "Unableoƒxpand inode %lu. Delete some EAs or„unƒ2fsck.",

2740 
šode
->
i_šo
);

2741 
mÁ_couÁ
 = 
	`Ë16_to_ıu
(
sbi
->
s_es
->
s_mÁ_couÁ
);

2743  
”rÜ
;

2744 
	}
}

2746 
	#EIA_INCR
 16

	)

2747 
	#EIA_MASK
 (
EIA_INCR
 - 1)

	)

2754 
	$ext4_ex·nd_šode_¬¿y
(
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

2755 
šode
 *inode)

2757 ià(*
—_šode_¬¿y
 =ğ
NULL
) {

2762 (*
—_šode_¬¿y
) =

2763 
	`km®loc
(
	`off£tof
(
ext4_x©Œ_šode_¬¿y
,

2764 
šodes
[
EIA_MASK
]),

2765 
GFP_NOFS
);

2766 ià(*
—_šode_¬¿y
 =ğ
NULL
)

2767  -
ENOMEM
;

2768 (*
—_šode_¬¿y
)->
couÁ
 = 0;

2769 } ià(((*
—_šode_¬¿y
)->
couÁ
 & 
EIA_MASK
) == EIA_MASK) {

2771 
ext4_x©Œ_šode_¬¿y
 *
Ãw_¬¿y
 = 
NULL
;

2772 
couÁ
 = (*
—_šode_¬¿y
)->count;

2775 
Ãw_¬¿y
 = 
	`km®loc
(

2776 
	`off£tof
(
ext4_x©Œ_šode_¬¿y
,

2777 
šodes
[
couÁ
 + 
EIA_INCR
]),

2778 
GFP_NOFS
);

2779 ià(
Ãw_¬¿y
 =ğ
NULL
)

2780  -
ENOMEM
;

2781 
	`memıy
(
Ãw_¬¿y
, *
—_šode_¬¿y
,

2782 
	`off£tof
(
ext4_x©Œ_šode_¬¿y
, 
šodes
[
couÁ
]));

2783 
	`kä“
(*
—_šode_¬¿y
);

2784 *
—_šode_¬¿y
 = 
Ãw_¬¿y
;

2786 (*
—_šode_¬¿y
)->
šodes
[(*—_šode_¬¿y)->
couÁ
++] = 
šode
;

2788 
	}
}

2799 
	$ext4_x©Œ_d–‘e_šode
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

2800 
ext4_x©Œ_šode_¬¿y
 **
—_šode_¬¿y
,

2801 
exŒa_üed™s
)

2803 
bufãr_h—d
 *
bh
 = 
NULL
;

2804 
ext4_x©Œ_ibody_h—d”
 *
h—d”
;

2805 
ext4_oc
 
oc
 = { .
bh
 = 
NULL
 };

2806 
ext4_x©Œ_’Œy
 *
’Œy
;

2807 
”rÜ
;

2809 
”rÜ
 = 
	`ext4_x©Œ_’su»_üed™s
(
hªdË
, 
šode
, 
exŒa_üed™s
,

2810 
NULL
 ,

2811 
çl£
 ,

2812 
çl£
 );

2813 ià(
”rÜ
) {

2814 
	`EXT4_ERROR_INODE
(
šode
, "’su» c»d™ Ó¼Ü %d)", 
”rÜ
);

2815 
ş—nup
;

2818 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
) &&

2819 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_XATTR
)) {

2821 
”rÜ
 = 
	`ext4_g‘_šode_loc
(
šode
, &
oc
);

2822 ià(
”rÜ
) {

2823 
	`EXT4_ERROR_INODE
(
šode
, "šodloøÓ¼Ü %d)", 
”rÜ
);

2824 
ş—nup
;

2827 
”rÜ
 = 
	`ext4_jouº®_g‘_wr™e_acûss
(
hªdË
, 
oc
.
bh
);

2828 ià(
”rÜ
) {

2829 
	`EXT4_ERROR_INODE
(
šode
, "write‡ccess (error %d)",

2830 
”rÜ
);

2831 
ş—nup
;

2834 
h—d”
 = 
	`IHDR
(
šode
, 
	`ext4_¿w_šode
(&
oc
));

2835 ià(
h—d”
->
h_magic
 =ğ
	`ıu_to_Ë32
(
EXT4_XATTR_MAGIC
))

2836 
	`ext4_x©Œ_šode_dec_»f_®l
(
hªdË
, 
šode
, 
oc
.
bh
,

2837 
	`IFIRST
(
h—d”
),

2838 
çl£
 ,

2839 
—_šode_¬¿y
,

2840 
exŒa_üed™s
,

2841 
çl£
 );

2844 ià(
	`EXT4_I
(
šode
)->
i_fe_aş
) {

2845 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
	`EXT4_I
(šode)->
i_fe_aş
);

2846 ià(!
bh
) {

2847 
	`EXT4_ERROR_INODE
(
šode
, "block %llu„eadƒrror",

2848 
	`EXT4_I
(
šode
)->
i_fe_aş
);

2849 
”rÜ
 = -
EIO
;

2850 
ş—nup
;

2852 
”rÜ
 = 
	`ext4_x©Œ_check_block
(
šode
, 
bh
);

2853 ià(
”rÜ
) {

2854 
	`EXT4_ERROR_INODE
(
šode
, "bad block %llu (error %d)",

2855 
	`EXT4_I
(
šode
)->
i_fe_aş
, 
”rÜ
);

2856 
ş—nup
;

2859 ià(
	`ext4_has_ã©u»_—_šode
(
šode
->
i_sb
)) {

2860 
’Œy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

2861 
’Œy
 = 
	`EXT4_XATTR_NEXT
(entry))

2862 ià(
’Œy
->
e_v®ue_šum
)

2863 
	`ext4_x©Œ_šode_ä“_quÙa
(
šode
,

2864 
	`Ë32_to_ıu
(
’Œy
->
e_v®ue_size
));

2868 
	`ext4_x©Œ_»Ëa£_block
(
hªdË
, 
šode
, 
bh
, 
—_šode_¬¿y
,

2869 
exŒa_üed™s
);

2874 
	`EXT4_I
(
šode
)->
i_fe_aş
 = 0;

2875 
”rÜ
 = 
	`ext4_m¬k_šode_dœty
(
hªdË
, 
šode
);

2876 ià(
”rÜ
) {

2877 
	`EXT4_ERROR_INODE
(
šode
, "mark inode dirty (error %d)",

2878 
”rÜ
);

2879 
ş—nup
;

2881 
	`ext4_fc_m¬k_š–igibË
(
šode
,

2882 
EXT4_FC_REASON_XATTR
);

2884 
”rÜ
 = 0;

2885 
ş—nup
:

2886 
	`b»l£
(
oc
.
bh
);

2887 
	`b»l£
(
bh
);

2888  
”rÜ
;

2889 
	}
}

2891 
	$ext4_x©Œ_šode_¬¿y_ä“
(
ext4_x©Œ_šode_¬¿y
 *
—_šode_¬¿y
)

2893 
idx
;

2895 ià(
—_šode_¬¿y
 =ğ
NULL
)

2898 
idx
 = 0; idx < 
—_šode_¬¿y
->
couÁ
; ++idx)

2899 
	`ut
(
—_šode_¬¿y
->
šodes
[
idx
]);

2900 
	`kä“
(
—_šode_¬¿y
);

2901 
	}
}

2912 
	$ext4_x©Œ_block_ÿche_š£¹
(
mb_ÿche
 *
—_block_ÿche
,

2913 
bufãr_h—d
 *
bh
)

2915 
ext4_x©Œ_h—d”
 *
h—d”
 = 
	`BHDR
(
bh
);

2916 
__u32
 
hash
 = 
	`Ë32_to_ıu
(
h—d”
->
h_hash
);

2917 
»u§bË
 = 
	`Ë32_to_ıu
(
h—d”
->
h_»fcouÁ
) <

2918 
EXT4_XATTR_REFCOUNT_MAX
;

2919 
”rÜ
;

2921 ià(!
—_block_ÿche
)

2923 
”rÜ
 = 
	`mb_ÿche_’Œy_ü—‹
(
—_block_ÿche
, 
GFP_NOFS
, 
hash
,

2924 
bh
->
b_blockÄ
, 
»u§bË
);

2925 ià(
”rÜ
) {

2926 ià(
”rÜ
 =ğ-
EBUSY
)

2927 
	`—_bdebug
(
bh
, "already in cache");

2929 
	`—_bdebug
(
bh
, "š£¹šg [%x]", ()
hash
);

2930 
	}
}

2941 
	$ext4_x©Œ_cmp
(
ext4_x©Œ_h—d”
 *
h—d”1
,

2942 
ext4_x©Œ_h—d”
 *
h—d”2
)

2944 
ext4_x©Œ_’Œy
 *
’Œy1
, *
’Œy2
;

2946 
’Œy1
 = 
	`ENTRY
(
h—d”1
+1);

2947 
’Œy2
 = 
	`ENTRY
(
h—d”2
+1);

2948 !
	`IS_LAST_ENTRY
(
’Œy1
)) {

2949 ià(
	`IS_LAST_ENTRY
(
’Œy2
))

2951 ià(
’Œy1
->
e_hash
 !ğ
’Œy2
->e_hash ||

2952 
’Œy1
->
e_Çme_šdex
 !ğ
’Œy2
->e_name_index ||

2953 
’Œy1
->
e_Çme_Ën
 !ğ
’Œy2
->e_name_len ||

2954 
’Œy1
->
e_v®ue_size
 !ğ
’Œy2
->e_value_size ||

2955 
’Œy1
->
e_v®ue_šum
 !ğ
’Œy2
->e_value_inum ||

2956 
	`memcmp
(
’Œy1
->
e_Çme
, 
’Œy2
->e_Çme,ƒÁry1->
e_Çme_Ën
))

2958 ià(!
’Œy1
->
e_v®ue_šum
 &&

2959 
	`memcmp
((*)
h—d”1
 + 
	`Ë16_to_ıu
(
’Œy1
->
e_v®ue_offs
),

2960 (*)
h—d”2
 + 
	`Ë16_to_ıu
(
’Œy2
->
e_v®ue_offs
),

2961 
	`Ë32_to_ıu
(
’Œy1
->
e_v®ue_size
)))

2964 
’Œy1
 = 
	`EXT4_XATTR_NEXT
(entry1);

2965 
’Œy2
 = 
	`EXT4_XATTR_NEXT
(entry2);

2967 ià(!
	`IS_LAST_ENTRY
(
’Œy2
))

2970 
	}
}

2980 
bufãr_h—d
 *

2981 
	$ext4_x©Œ_block_ÿche_fšd
(
šode
 *inode,

2982 
ext4_x©Œ_h—d”
 *
h—d”
,

2983 
mb_ÿche_’Œy
 **
pû
)

2985 
__u32
 
hash
 = 
	`Ë32_to_ıu
(
h—d”
->
h_hash
);

2986 
mb_ÿche_’Œy
 *
û
;

2987 
mb_ÿche
 *
—_block_ÿche
 = 
	`EA_BLOCK_CACHE
(
šode
);

2989 ià(!
—_block_ÿche
)

2990  
NULL
;

2991 ià(!
h—d”
->
h_hash
)

2992  
NULL
;

2993 
	`—_idebug
(
šode
, "lookšg fÜ cached block [%x]", ()
hash
);

2994 
û
 = 
	`mb_ÿche_’Œy_fšd_fœ¡
(
—_block_ÿche
, 
hash
);

2995 
û
) {

2996 
bufãr_h—d
 *
bh
;

2998 
bh
 = 
	`sb_b»ad
(
šode
->
i_sb
, 
û
->
e_v®ue
);

2999 ià(!
bh
) {

3000 
	`EXT4_ERROR_INODE
(
šode
, "block %lu„eadƒrror",

3001 ()
û
->
e_v®ue
);

3002 } ià(
	`ext4_x©Œ_cmp
(
h—d”
, 
	`BHDR
(
bh
)) == 0) {

3003 *
pû
 = 
û
;

3004  
bh
;

3006 
	`b»l£
(
bh
);

3007 
û
 = 
	`mb_ÿche_’Œy_fšd_Ãxt
(
—_block_ÿche
, ce);

3009  
NULL
;

3010 
	}
}

3012 
	#NAME_HASH_SHIFT
 5

	)

3013 
	#VALUE_HASH_SHIFT
 16

	)

3020 
__Ë32
 
	$ext4_x©Œ_hash_’Œy
(*
Çme
, 
size_t
 
Çme_Ën
, 
__Ë32
 *
v®ue
,

3021 
size_t
 
v®ue_couÁ
)

3023 
__u32
 
hash
 = 0;

3025 
Çme_Ën
--) {

3026 
hash
 = (hash << 
NAME_HASH_SHIFT
) ^

3027 (
hash
 >> (8*(hashè- 
NAME_HASH_SHIFT
)) ^

3028 *
Çme
++;

3030 
v®ue_couÁ
--) {

3031 
hash
 = (hash << 
VALUE_HASH_SHIFT
) ^

3032 (
hash
 >> (8*(hashè- 
VALUE_HASH_SHIFT
)) ^

3033 
	`Ë32_to_ıu
(*
v®ue
++);

3035  
	`ıu_to_Ë32
(
hash
);

3036 
	}
}

3038 #undeà
NAME_HASH_SHIFT


3039 #undeà
VALUE_HASH_SHIFT


3041 
	#BLOCK_HASH_SHIFT
 16

	)

3048 
	$ext4_x©Œ_»hash
(
ext4_x©Œ_h—d”
 *
h—d”
)

3050 
ext4_x©Œ_’Œy
 *
h”e
;

3051 
__u32
 
hash
 = 0;

3053 
h”e
 = 
	`ENTRY
(
h—d”
+1);

3054 !
	`IS_LAST_ENTRY
(
h”e
)) {

3055 ià(!
h”e
->
e_hash
) {

3057 
hash
 = 0;

3060 
hash
 = (hash << 
BLOCK_HASH_SHIFT
) ^

3061 (
hash
 >> (8*(hashè- 
BLOCK_HASH_SHIFT
)) ^

3062 
	`Ë32_to_ıu
(
h”e
->
e_hash
);

3063 
h”e
 = 
	`EXT4_XATTR_NEXT
(here);

3065 
h—d”
->
h_hash
 = 
	`ıu_to_Ë32
(
hash
);

3066 
	}
}

3068 #undeà
BLOCK_HASH_SHIFT


3070 
	#HASH_BUCKET_BITS
 10

	)

3072 
mb_ÿche
 *

3073 
	$ext4_x©Œ_ü—‹_ÿche
()

3075  
	`mb_ÿche_ü—‹
(
HASH_BUCKET_BITS
);

3076 
	}
}

3078 
	$ext4_x©Œ_de¡roy_ÿche
(
mb_ÿche
 *
ÿche
)

3080 ià(
ÿche
)

3081 
	`mb_ÿche_de¡roy
(
ÿche
);

3082 
	}
}

	@xattr.h

9 
	~<lšux/x©Œ.h
>

12 
	#EXT4_XATTR_MAGIC
 0xEA020000

	)

15 
	#EXT4_XATTR_REFCOUNT_MAX
 1024

	)

18 
	#EXT4_XATTR_INDEX_USER
 1

	)

19 
	#EXT4_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

20 
	#EXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

21 
	#EXT4_XATTR_INDEX_TRUSTED
 4

	)

22 
	#EXT4_XATTR_INDEX_LUSTRE
 5

	)

23 
	#EXT4_XATTR_INDEX_SECURITY
 6

	)

24 
	#EXT4_XATTR_INDEX_SYSTEM
 7

	)

25 
	#EXT4_XATTR_INDEX_RICHACL
 8

	)

26 
	#EXT4_XATTR_INDEX_ENCRYPTION
 9

	)

27 
	#EXT4_XATTR_INDEX_HURD
 10

	)

29 
	sext4_x©Œ_h—d”
 {

30 
__Ë32
 
	mh_magic
;

31 
__Ë32
 
	mh_»fcouÁ
;

32 
__Ë32
 
	mh_blocks
;

33 
__Ë32
 
	mh_hash
;

34 
__Ë32
 
	mh_checksum
;

36 
__u32
 
	mh_»£rved
[3];

39 
	sext4_x©Œ_ibody_h—d”
 {

40 
__Ë32
 
	mh_magic
;

43 
	sext4_x©Œ_’Œy
 {

44 
__u8
 
	me_Çme_Ën
;

45 
__u8
 
	me_Çme_šdex
;

46 
__Ë16
 
	me_v®ue_offs
;

47 
__Ë32
 
	me_v®ue_šum
;

48 
__Ë32
 
	me_v®ue_size
;

49 
__Ë32
 
	me_hash
;

50 
	me_Çme
[0];

53 
	#EXT4_XATTR_PAD_BITS
 2

	)

54 
	#EXT4_XATTR_PAD
 (1<<
EXT4_XATTR_PAD_BITS
)

	)

55 
	#EXT4_XATTR_ROUND
 (
EXT4_XATTR_PAD
-1)

	)

56 
	#EXT4_XATTR_LEN
(
Çme_Ën
) \

57 (((
Çme_Ën
è+ 
EXT4_XATTR_ROUND
 + \

58 (
ext4_x©Œ_’Œy
)è& ~
EXT4_XATTR_ROUND
)

	)

59 
	#EXT4_XATTR_NEXT
(
’Œy
) \

60 ((
ext4_x©Œ_’Œy
 *)( \

61 (*)(
’Œy
è+ 
	`EXT4_XATTR_LEN
(ÓÁry)->
e_Çme_Ën
)))

	)

62 
	#EXT4_XATTR_SIZE
(
size
) \

63 (((
size
è+ 
EXT4_XATTR_ROUND
è& ~EXT4_XATTR_ROUND)

	)

65 
	#IHDR
(
šode
, 
¿w_šode
) \

66 ((
ext4_x©Œ_ibody_h—d”
 *) \

67 ((*)
¿w_šode
 + \

68 
EXT4_GOOD_OLD_INODE_SIZE
 + \

69 
	`EXT4_I
(
šode
)->
i_exŒa_isize
))

	)

70 
	#IFIRST
(
hdr
è((
ext4_x©Œ_’Œy
 *)((hdr)+1))

	)

76 
	#EXT4_XATTR_MIN_LARGE_EA_SIZE
(
b
) \

77 ((
b
è- 
	`EXT4_XATTR_LEN
(3è- (
ext4_x©Œ_h—d”
è- 4)

	)

79 
	#BHDR
(
bh
è((
ext4_x©Œ_h—d”
 *)((bh)->
b_d©a
))

	)

80 
	#ENTRY
(
±r
è((
ext4_x©Œ_’Œy
 *)ÕŒ))

	)

81 
	#BFIRST
(
bh
è
	`ENTRY
(
	`BHDR
(bh)+1)

	)

82 
	#IS_LAST_ENTRY
(
’Œy
è(*(
__u32
 *)ÓÁryè=ğ0)

	)

84 
	#EXT4_ZERO_XATTR_VALUE
 ((*)-1)

	)

86 
	sext4_x©Œ_šfo
 {

87 cÚ¡ *
	mÇme
;

88 cÚ¡ *
	mv®ue
;

89 
size_t
 
	mv®ue_Ën
;

90 
	mÇme_šdex
;

91 
	mš_šode
;

94 
	sext4_x©Œ_£¬ch
 {

95 
ext4_x©Œ_’Œy
 *
	mfœ¡
;

96 *
	mba£
;

97 *
	m’d
;

98 
ext4_x©Œ_’Œy
 *
	mh”e
;

99 
	mnÙ_found
;

102 
	sext4_x©Œ_ibody_fšd
 {

103 
ext4_x©Œ_£¬ch
 
	ms
;

104 
ext4_oc
 
	moc
;

107 
	sext4_x©Œ_šode_¬¿y
 {

108 
	mcouÁ
;

109 
šode
 *
	mšodes
[0];

112 cÚ¡ 
x©Œ_hªdËr
 
ext4_x©Œ_u£r_hªdËr
;

113 cÚ¡ 
x©Œ_hªdËr
 
ext4_x©Œ_Œu¡ed_hªdËr
;

114 cÚ¡ 
x©Œ_hªdËr
 
ext4_x©Œ_£cur™y_hªdËr
;

116 
	#EXT4_XATTR_NAME_ENCRYPTION_CONTEXT
 "c"

	)

127 
šlše
 
	$ext4_wr™e_lock_x©Œ
(
šode
 *šode, *
§ve
)

129 
	`down_wr™e
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

130 *
§ve
 = 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

131 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

132 
	}
}

134 
šlše
 
	$ext4_wr™e_Œylock_x©Œ
(
šode
 *šode, *
§ve
)

136 ià(
	`down_wr™e_Œylock
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
) == 0)

138 *
§ve
 = 
	`ext4_‹¡_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

139 
	`ext4_£t_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

141 
	}
}

143 
šlše
 
	$ext4_wr™e_uÆock_x©Œ
(
šode
 *šode, *
§ve
)

145 ià(*
§ve
 == 0)

146 
	`ext4_ş—r_šode_¡©e
(
šode
, 
EXT4_STATE_NO_EXPAND
);

147 
	`up_wr™e
(&
	`EXT4_I
(
šode
)->
x©Œ_£m
);

148 
	}
}

150 
ssize_t
 
ext4_li¡x©Œ
(
d’Œy
 *, *, 
size_t
);

152 
ext4_x©Œ_g‘
(
šode
 *, , cÚ¡ *, *, 
size_t
);

153 
ext4_x©Œ_£t
(
šode
 *, , cÚ¡ *, cÚ¡ *, 
size_t
, );

154 
ext4_x©Œ_£t_hªdË
(
hªdË_t
 *, 
šode
 *, , cÚ¡ *, cÚ¡ *, 
size_t
, );

155 
ext4_x©Œ_£t_üed™s
(
šode
 *šode, 
size_t
 
v®ue_Ën
,

156 
boŞ
 
is_ü—‹
, *
üed™s
);

157 
__ext4_x©Œ_£t_üed™s
(
su³r_block
 *
sb
, 
šode
 *inode,

158 
bufãr_h—d
 *
block_bh
, 
size_t
 
v®ue_Ën
,

159 
boŞ
 
is_ü—‹
);

161 
ext4_x©Œ_d–‘e_šode
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

162 
ext4_x©Œ_šode_¬¿y
 **
¬¿y
,

163 
exŒa_üed™s
);

164 
ext4_x©Œ_šode_¬¿y_ä“
(
ext4_x©Œ_šode_¬¿y
 *
¬¿y
);

166 
ext4_ex·nd_exŒa_isize_—
(
šode
 *šode, 
Ãw_exŒa_isize
,

167 
ext4_šode
 *
¿w_šode
, 
hªdË_t
 *
hªdË
);

169 cÚ¡ 
x©Œ_hªdËr
 *
ext4_x©Œ_hªdËrs
[];

171 
ext4_x©Œ_ibody_fšd
(
šode
 *šode, 
ext4_x©Œ_šfo
 *
i
,

172 
ext4_x©Œ_ibody_fšd
 *
is
);

173 
ext4_x©Œ_ibody_g‘
(
šode
 *šode, 
Çme_šdex
,

174 cÚ¡ *
Çme
,

175 *
bufãr
, 
size_t
 
bufãr_size
);

176 
ext4_x©Œ_ibody_šlše_£t
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

177 
ext4_x©Œ_šfo
 *
i
,

178 
ext4_x©Œ_ibody_fšd
 *
is
);

180 
mb_ÿche
 *
ext4_x©Œ_ü—‹_ÿche
();

181 
ext4_x©Œ_de¡roy_ÿche
(
mb_ÿche
 *);

183 #ifdeà
CONFIG_EXT4_FS_SECURITY


184 
ext4_š™_£cur™y
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

185 
šode
 *
dœ
, cÚ¡ 
q¡r
 *qstr);

187 
šlše
 
	$ext4_š™_£cur™y
(
hªdË_t
 *
hªdË
, 
šode
 *inode,

188 
šode
 *
dœ
, cÚ¡ 
q¡r
 *qstr)

191 
	}
}

194 #ifdeà
CONFIG_LOCKDEP


195 
ext4_x©Œ_šode_£t_şass
(
šode
 *
—_šode
);

197 
šlše
 
	$ext4_x©Œ_šode_£t_şass
(
šode
 *
—_šode
è{ 
	}
}

200 
ext4_g‘_šode_u§ge
(
šode
 *šode, 
qsize_t
 *
u§ge
);

	@xattr_security.c

6 
	~<lšux/¡ršg.h
>

7 
	~<lšux/fs.h
>

8 
	~<lšux/£cur™y.h
>

9 
	~<lšux/¦ab.h
>

10 
	~"ext4_jbd2.h
"

11 
	~"ext4.h
"

12 
	~"x©Œ.h
"

15 
	$ext4_x©Œ_£cur™y_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

16 
d’Œy
 *
unu£d
, 
šode
 *inode,

17 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

19  
	`ext4_x©Œ_g‘
(
šode
, 
EXT4_XATTR_INDEX_SECURITY
,

20 
Çme
, 
bufãr
, 
size
);

21 
	}
}

24 
	$ext4_x©Œ_£cur™y_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

25 
d’Œy
 *
unu£d
, 
šode
 *inode,

26 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

27 
size_t
 
size
, 
æags
)

29  
	`ext4_x©Œ_£t
(
šode
, 
EXT4_XATTR_INDEX_SECURITY
,

30 
Çme
, 
v®ue
, 
size
, 
æags
);

31 
	}
}

34 
	$ext4_š™x©Œs
(
šode
 *šode, cÚ¡ 
x©Œ
 *
x©Œ_¬¿y
,

35 *
fs_šfo
)

37 cÚ¡ 
x©Œ
 *xattr;

38 
hªdË_t
 *
hªdË
 = 
fs_šfo
;

39 
”r
 = 0;

41 
x©Œ
 = 
x©Œ_¬¿y
; x©Œ->
Çme
 !ğ
NULL
; xattr++) {

42 
”r
 = 
	`ext4_x©Œ_£t_hªdË
(
hªdË
, 
šode
,

43 
EXT4_XATTR_INDEX_SECURITY
,

44 
x©Œ
->
Çme
, x©Œ->
v®ue
,

45 
x©Œ
->
v®ue_Ën
, 0);

46 ià(
”r
 < 0)

49  
”r
;

50 
	}
}

53 
	$ext4_š™_£cur™y
(
hªdË_t
 *
hªdË
, 
šode
 *šode, šod*
dœ
,

54 cÚ¡ 
q¡r
 *qstr)

56  
	`£cur™y_šode_š™_£cur™y
(
šode
, 
dœ
, 
q¡r
,

57 &
ext4_š™x©Œs
, 
hªdË
);

58 
	}
}

60 cÚ¡ 
x©Œ_hªdËr
 
	gext4_x©Œ_£cur™y_hªdËr
 = {

61 .
´efix
 = 
XATTR_SECURITY_PREFIX
,

62 .
	gg‘
 = 
ext4_x©Œ_£cur™y_g‘
,

63 .
	g£t
 = 
ext4_x©Œ_£cur™y_£t
,

	@xattr_trusted.c

8 
	~<lšux/¡ršg.h
>

9 
	~<lšux/ÿ·b™y.h
>

10 
	~<lšux/fs.h
>

11 
	~"ext4_jbd2.h
"

12 
	~"ext4.h
"

13 
	~"x©Œ.h
"

15 
boŞ


16 
	$ext4_x©Œ_Œu¡ed_li¡
(
d’Œy
 *dentry)

18  
	`ÿ·bË
(
CAP_SYS_ADMIN
);

19 
	}
}

22 
	$ext4_x©Œ_Œu¡ed_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

23 
d’Œy
 *
unu£d
, 
šode
 *inode,

24 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

26  
	`ext4_x©Œ_g‘
(
šode
, 
EXT4_XATTR_INDEX_TRUSTED
,

27 
Çme
, 
bufãr
, 
size
);

28 
	}
}

31 
	$ext4_x©Œ_Œu¡ed_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

32 
d’Œy
 *
unu£d
, 
šode
 *inode,

33 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

34 
size_t
 
size
, 
æags
)

36  
	`ext4_x©Œ_£t
(
šode
, 
EXT4_XATTR_INDEX_TRUSTED
,

37 
Çme
, 
v®ue
, 
size
, 
æags
);

38 
	}
}

40 cÚ¡ 
x©Œ_hªdËr
 
	gext4_x©Œ_Œu¡ed_hªdËr
 = {

41 .
´efix
 = 
XATTR_TRUSTED_PREFIX
,

42 .
	gli¡
 = 
ext4_x©Œ_Œu¡ed_li¡
,

43 .
	gg‘
 = 
ext4_x©Œ_Œu¡ed_g‘
,

44 .
	g£t
 = 
ext4_x©Œ_Œu¡ed_£t
,

	@xattr_user.c

8 
	~<lšux/¡ršg.h
>

9 
	~<lšux/fs.h
>

10 
	~"ext4_jbd2.h
"

11 
	~"ext4.h
"

12 
	~"x©Œ.h
"

14 
boŞ


15 
	$ext4_x©Œ_u£r_li¡
(
d’Œy
 *dentry)

17  
	`‹¡_İt
(
d’Œy
->
d_sb
, 
XATTR_USER
);

18 
	}
}

21 
	$ext4_x©Œ_u£r_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

22 
d’Œy
 *
unu£d
, 
šode
 *inode,

23 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

25 ià(!
	`‹¡_İt
(
šode
->
i_sb
, 
XATTR_USER
))

26  -
EOPNOTSUPP
;

27  
	`ext4_x©Œ_g‘
(
šode
, 
EXT4_XATTR_INDEX_USER
,

28 
Çme
, 
bufãr
, 
size
);

29 
	}
}

32 
	$ext4_x©Œ_u£r_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

33 
d’Œy
 *
unu£d
, 
šode
 *inode,

34 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

35 
size_t
 
size
, 
æags
)

37 ià(!
	`‹¡_İt
(
šode
->
i_sb
, 
XATTR_USER
))

38  -
EOPNOTSUPP
;

39  
	`ext4_x©Œ_£t
(
šode
, 
EXT4_XATTR_INDEX_USER
,

40 
Çme
, 
v®ue
, 
size
, 
æags
);

41 
	}
}

43 cÚ¡ 
x©Œ_hªdËr
 
	gext4_x©Œ_u£r_hªdËr
 = {

44 .
´efix
 = 
XATTR_USER_PREFIX
,

45 .
	gli¡
 = 
ext4_x©Œ_u£r_li¡
,

46 .
	gg‘
 = 
ext4_x©Œ_u£r_g‘
,

47 .
	g£t
 = 
ext4_x©Œ_u£r_£t
,

	@/usr/include/asm/byteorder.h

2 #iâdeà
_ASM_X86_BYTEORDER_H


3 
	#_ASM_X86_BYTEORDER_H


	)

5 
	~<lšux/by‹Üd”/l™e_’dŸn.h
>

	@/usr/include/linux/capability.h

14 #iâdeà
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<lšux/ty³s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ÿp_h—d”_¡ruù
 {

40 
__u32
 
	mv”siÚ
;

41 
	mpid
;

42 } *
	tÿp_u£r_h—d”_t
;

44 
	s__u£r_ÿp_d©a_¡ruù
 {

45 
__u32
 
	mefãùive
;

46 
__u32
 
	m³rm™‹d
;

47 
__u32
 
	mšh”™abË
;

48 } *
	tÿp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__Ë32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ÿp_d©a
 {

73 
__Ë32
 
	mmagic_‘c
;

75 
__Ë32
 
	m³rm™‹d
;

76 
__Ë32
 
	mšh”™abË
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ÿp_d©a
 {

84 
__Ë32
 
	mmagic_‘c
;

86 
__Ë32
 
	m³rm™‹d
;

87 
__Ë32
 
	mšh”™abË
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__Ë32
 
	mroÙid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

289 
	#CAP_SYS_NICE
 23

	)

303 
	#CAP_SYS_RESOURCE
 24

	)

309 
	#CAP_SYS_TIME
 25

	)

314 
	#CAP_SYS_TTY_CONFIG
 26

	)

318 
	#CAP_MKNOD
 27

	)

322 
	#CAP_LEASE
 28

	)

326 
	#CAP_AUDIT_WRITE
 29

	)

330 
	#CAP_AUDIT_CONTROL
 30

	)

332 
	#CAP_SETFCAP
 31

	)

340 
	#CAP_MAC_OVERRIDE
 32

	)

349 
	#CAP_MAC_ADMIN
 33

	)

353 
	#CAP_SYSLOG
 34

	)

357 
	#CAP_WAKE_ALARM
 35

	)

361 
	#CAP_BLOCK_SUSPEND
 36

	)

365 
	#CAP_AUDIT_READ
 37

	)

368 
	#CAP_LAST_CAP
 
CAP_AUDIT_READ


	)

370 
	#ÿp_v®id
(
x
è((xè>ğ0 && (xè<ğ
CAP_LAST_CAP
)

	)

376 
	#CAP_TO_INDEX
(
x
è((xè>> 5è

	)

377 
	#CAP_TO_MASK
(
x
è(1 << ((xè& 31)è

	)

	@/usr/include/linux/errno.h

1 
	~<asm/”ºo.h
>

	@/usr/include/linux/falloc.h

2 #iâdeà
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fcntl.h

2 #iâdeà
_LINUX_FCNTL_H


3 
	#_LINUX_FCNTL_H


	)

5 
	~<asm/fú.h
>

7 
	#F_SETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 0)

	)

8 
	#F_GETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 1)

	)

14 
	#F_CANCELLK
 (
F_LINUX_SPECIFIC_BASE
 + 5)

	)

17 
	#F_DUPFD_CLOEXEC
 (
F_LINUX_SPECIFIC_BASE
 + 6)

	)

23 
	#F_NOTIFY
 (
F_LINUX_SPECIFIC_BASE
+2)

	)

28 
	#F_SETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 7)

	)

29 
	#F_GETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 8)

	)

34 
	#F_ADD_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 9)

	)

35 
	#F_GET_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 10)

	)

40 
	#F_SEAL_SEAL
 0x0001

	)

41 
	#F_SEAL_SHRINK
 0x0002

	)

42 
	#F_SEAL_GROW
 0x0004

	)

43 
	#F_SEAL_WRITE
 0x0008

	)

51 
	#F_GET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 11)

	)

52 
	#F_SET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 12)

	)

53 
	#F_GET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 13)

	)

54 
	#F_SET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 14)

	)

60 
	#RWF_WRITE_LIFE_NOT_SET
 0

	)

61 
	#RWH_WRITE_LIFE_NONE
 1

	)

62 
	#RWH_WRITE_LIFE_SHORT
 2

	)

63 
	#RWH_WRITE_LIFE_MEDIUM
 3

	)

64 
	#RWH_WRITE_LIFE_LONG
 4

	)

65 
	#RWH_WRITE_LIFE_EXTREME
 5

	)

70 
	#DN_ACCESS
 0x00000001

	)

71 
	#DN_MODIFY
 0x00000002

	)

72 
	#DN_CREATE
 0x00000004

	)

73 
	#DN_DELETE
 0x00000008

	)

74 
	#DN_RENAME
 0x00000010

	)

75 
	#DN_ATTRIB
 0x00000020

	)

76 
	#DN_MULTISHOT
 0x80000000

	)

78 
	#AT_FDCWD
 -100

	)

81 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

82 
	#AT_REMOVEDIR
 0x200

	)

84 
	#AT_SYMLINK_FOLLOW
 0x400

	)

85 
	#AT_NO_AUTOMOUNT
 0x800

	)

86 
	#AT_EMPTY_PATH
 0x1000

	)

88 
	#AT_STATX_SYNC_TYPE
 0x6000

	)

89 
	#AT_STATX_SYNC_AS_STAT
 0x0000

	)

90 
	#AT_STATX_FORCE_SYNC
 0x2000

	)

91 
	#AT_STATX_DONT_SYNC
 0x4000

	)

	@/usr/include/linux/fiemap.h

12 #iâdeà
_LINUX_FIEMAP_H


13 
	#_LINUX_FIEMAP_H


	)

15 
	~<lšux/ty³s.h
>

17 
	sf›m­_ex‹Á
 {

18 
__u64
 
	mã_logiÿl
;

20 
__u64
 
	mã_physiÿl
;

22 
__u64
 
	mã_Ëngth
;

23 
__u64
 
	mã_»£rved64
[2];

24 
__u32
 
	mã_æags
;

25 
__u32
 
	mã_»£rved
[3];

28 
	sf›m­
 {

29 
__u64
 
	mfm_¡¬t
;

31 
__u64
 
	mfm_Ëngth
;

33 
__u32
 
	mfm_æags
;

34 
__u32
 
	mfm_m­³d_ex‹Ás
;

35 
__u32
 
	mfm_ex‹Á_couÁ
;

36 
__u32
 
	mfm_»£rved
;

37 
f›m­_ex‹Á
 
	mfm_ex‹Ás
[0];

40 
	#FIEMAP_MAX_OFFSET
 (~0ULL)

	)

42 
	#FIEMAP_FLAG_SYNC
 0x00000001

	)

43 
	#FIEMAP_FLAG_XATTR
 0x00000002

	)

44 
	#FIEMAP_FLAG_CACHE
 0x00000004

	)

46 
	#FIEMAP_FLAGS_COMPAT
 (
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
)

	)

48 
	#FIEMAP_EXTENT_LAST
 0x00000001

	)

49 
	#FIEMAP_EXTENT_UNKNOWN
 0x00000002

	)

50 
	#FIEMAP_EXTENT_DELALLOC
 0x00000004

	)

52 
	#FIEMAP_EXTENT_ENCODED
 0x00000008

	)

54 
	#FIEMAP_EXTENT_DATA_ENCRYPTED
 0x00000080

	)

56 
	#FIEMAP_EXTENT_NOT_ALIGNED
 0x00000100

	)

58 
	#FIEMAP_EXTENT_DATA_INLINE
 0x00000200

	)

60 
	#FIEMAP_EXTENT_DATA_TAIL
 0x00000400

	)

62 
	#FIEMAP_EXTENT_UNWRITTEN
 0x00000800

	)

64 
	#FIEMAP_EXTENT_MERGED
 0x00001000

	)

67 
	#FIEMAP_EXTENT_SHARED
 0x00002000

	)

	@/usr/include/linux/fs.h

2 #iâdeà
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<lšux/lim™s.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

18 
	~<lšux/mouÁ.h
>

31 #undeà
NR_OPEN


32 
	#INR_OPEN_CUR
 1024

	)

33 
	#INR_OPEN_MAX
 4096

	)

35 
	#BLOCK_SIZE_BITS
 10

	)

36 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

38 
	#SEEK_SET
 0

	)

39 
	#SEEK_CUR
 1

	)

40 
	#SEEK_END
 2

	)

41 
	#SEEK_DATA
 3

	)

42 
	#SEEK_HOLE
 4

	)

43 
	#SEEK_MAX
 
SEEK_HOLE


	)

45 
	#RENAME_NOREPLACE
 (1 << 0è

	)

46 
	#RENAME_EXCHANGE
 (1 << 1è

	)

47 
	#RENAME_WHITEOUT
 (1 << 2è

	)

49 
	sfe_şÚe_¿nge
 {

50 
__s64
 
	m¤c_fd
;

51 
__u64
 
	m¤c_off£t
;

52 
__u64
 
	m¤c_Ëngth
;

53 
__u64
 
	mde¡_off£t
;

56 
	sf¡rim_¿nge
 {

57 
__u64
 
	m¡¬t
;

58 
__u64
 
	mËn
;

59 
__u64
 
	mmšËn
;

63 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

64 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

67 
	sfe_dedu³_¿nge_šfo
 {

68 
__s64
 
	mde¡_fd
;

69 
__u64
 
	mde¡_off£t
;

70 
__u64
 
	mby‹s_dedu³d
;

77 
__s32
 
	m¡©us
;

78 
__u32
 
	m»£rved
;

82 
	sfe_dedu³_¿nge
 {

83 
__u64
 
	m¤c_off£t
;

84 
__u64
 
	m¤c_Ëngth
;

85 
__u16
 
	mde¡_couÁ
;

86 
__u16
 
	m»£rved1
;

87 
__u32
 
	m»£rved2
;

88 
fe_dedu³_¿nge_šfo
 
	mšfo
[0];

92 
	sfes_¡©_¡ruù
 {

93 
	mÄ_fes
;

94 
	mÄ_ä“_fes
;

95 
	mmax_fes
;

98 
	sšodes_¡©_t
 {

99 
	mÄ_šodes
;

100 
	mÄ_unu£d
;

101 
	mdummy
[5];

105 
	#NR_FILE
 8192

	)

110 
	sfsx©Œ
 {

111 
__u32
 
	mfsx_xæags
;

112 
__u32
 
	mfsx_extsize
;

113 
__u32
 
	mfsx_Ãx‹Ás
;

114 
__u32
 
	mfsx_´ojid
;

115 
__u32
 
	mfsx_cowextsize
;

116 
	mfsx_·d
[8];

122 
	#FS_XFLAG_REALTIME
 0x00000001

	)

123 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

124 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

125 
	#FS_XFLAG_APPEND
 0x00000010

	)

126 
	#FS_XFLAG_SYNC
 0x00000020

	)

127 
	#FS_XFLAG_NOATIME
 0x00000040

	)

128 
	#FS_XFLAG_NODUMP
 0x00000080

	)

129 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

130 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

131 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

132 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

133 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

134 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

135 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

136 
	#FS_XFLAG_DAX
 0x00008000

	)

137 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

138 
	#FS_XFLAG_HASATTR
 0x80000000

	)

143 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

144 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

145 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

146 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

147 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

148 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

149 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

150 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

151 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

152 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

153 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

154 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

156 
	#BLKPG
 
	`_IO
(0x12,105)

	)

160 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

161 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

166 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

167 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

168 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

169 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

170 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

171 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

172 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

173 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

174 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

175 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

176 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

177 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

178 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

179 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

180 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

181 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

187 
	#BMAP_IOCTL
 1

	)

188 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

189 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

190 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

191 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

192 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

193 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

194 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fe_şÚe_¿nge
)

	)

195 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fe_dedu³_¿nge
)

	)

197 
	#FSLABEL_MAX
 256

	)

199 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

200 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

201 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

202 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

203 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

204 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

205 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

206 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

207 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

208 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©Œ
)

	)

209 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©Œ
)

	)

210 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

211 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

217 
	#FS_KEY_DESCRIPTOR_SIZE
 8

	)

219 
	#FS_POLICY_FLAGS_PAD_4
 0x00

	)

220 
	#FS_POLICY_FLAGS_PAD_8
 0x01

	)

221 
	#FS_POLICY_FLAGS_PAD_16
 0x02

	)

222 
	#FS_POLICY_FLAGS_PAD_32
 0x03

	)

223 
	#FS_POLICY_FLAGS_PAD_MASK
 0x03

	)

224 
	#FS_POLICY_FLAG_DIRECT_KEY
 0x04

	)

225 
	#FS_POLICY_FLAGS_VALID
 0x07

	)

228 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

229 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 1

	)

230 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

231 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

232 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 4

	)

233 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 5

	)

234 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 6

	)

235 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

236 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

237 
	#FS_ENCRYPTION_MODE_ADIANTUM
 9

	)

239 
	sfsüy±_pŞicy
 {

240 
__u8
 
	mv”siÚ
;

241 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

242 
__u8
 
	mf’ames_’üy±iÚ_mode
;

243 
__u8
 
	mæags
;

244 
__u8
 
	mma¡”_key_desütÜ
[
FS_KEY_DESCRIPTOR_SIZE
];

247 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fsüy±_pŞicy
)

	)

248 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

249 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fsüy±_pŞicy
)

	)

252 
	#FS_KEY_DESC_PREFIX
 "fsüy±:"

	)

253 
	#FS_KEY_DESC_PREFIX_SIZE
 8

	)

256 
	#FS_MAX_KEY_SIZE
 64

	)

258 
	sfsüy±_key
 {

259 
__u32
 
	mmode
;

260 
__u8
 
	m¿w
[
FS_MAX_KEY_SIZE
];

261 
__u32
 
	msize
;

284 
	#FS_SECRM_FL
 0x00000001

	)

285 
	#FS_UNRM_FL
 0x00000002

	)

286 
	#FS_COMPR_FL
 0x00000004

	)

287 
	#FS_SYNC_FL
 0x00000008

	)

288 
	#FS_IMMUTABLE_FL
 0x00000010

	)

289 
	#FS_APPEND_FL
 0x00000020

	)

290 
	#FS_NODUMP_FL
 0x00000040

	)

291 
	#FS_NOATIME_FL
 0x00000080

	)

293 
	#FS_DIRTY_FL
 0x00000100

	)

294 
	#FS_COMPRBLK_FL
 0x00000200

	)

295 
	#FS_NOCOMP_FL
 0x00000400

	)

297 
	#FS_ENCRYPT_FL
 0x00000800

	)

298 
	#FS_BTREE_FL
 0x00001000

	)

299 
	#FS_INDEX_FL
 0x00001000

	)

300 
	#FS_IMAGIC_FL
 0x00002000

	)

301 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

302 
	#FS_NOTAIL_FL
 0x00008000

	)

303 
	#FS_DIRSYNC_FL
 0x00010000

	)

304 
	#FS_TOPDIR_FL
 0x00020000

	)

305 
	#FS_HUGE_FILE_FL
 0x00040000

	)

306 
	#FS_EXTENT_FL
 0x00080000

	)

307 
	#FS_EA_INODE_FL
 0x00200000

	)

308 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

309 
	#FS_NOCOW_FL
 0x00800000

	)

310 
	#FS_INLINE_DATA_FL
 0x10000000

	)

311 
	#FS_PROJINHERIT_FL
 0x20000000

	)

312 
	#FS_RESERVED_FL
 0x80000000

	)

314 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

315 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

318 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

319 
	#SYNC_FILE_RANGE_WRITE
 2

	)

320 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

326 
	t__b™wi£
 
	t__k”Ãl_rwf_t
;

329 
	#RWF_HIPRI
 ((
__k”Ãl_rwf_t
)0x00000001)

	)

332 
	#RWF_DSYNC
 ((
__k”Ãl_rwf_t
)0x00000002)

	)

335 
	#RWF_SYNC
 ((
__k”Ãl_rwf_t
)0x00000004)

	)

338 
	#RWF_NOWAIT
 ((
__k”Ãl_rwf_t
)0x00000008)

	)

341 
	#RWF_APPEND
 ((
__k”Ãl_rwf_t
)0x00000010)

	)

344 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

345 
RWF_APPEND
)

	)

	@/usr/include/linux/fsmap.h

9 #iâdeà
_LINUX_FSMAP_H


10 
	#_LINUX_FSMAP_H


	)

12 
	~<lšux/ty³s.h
>

50 
	sfsm­
 {

51 
__u32
 
	mfmr_deviû
;

52 
__u32
 
	mfmr_æags
;

53 
__u64
 
	mfmr_physiÿl
;

54 
__u64
 
	mfmr_owÃr
;

55 
__u64
 
	mfmr_off£t
;

56 
__u64
 
	mfmr_Ëngth
;

57 
__u64
 
	mfmr_»£rved
[3];

60 
	sfsm­_h—d
 {

61 
__u32
 
	mfmh_iæags
;

62 
__u32
 
	mfmh_oæags
;

63 
__u32
 
	mfmh_couÁ
;

64 
__u32
 
	mfmh_’Œ›s
;

65 
__u64
 
	mfmh_»£rved
[6];

67 
fsm­
 
	mfmh_keys
[2];

68 
fsm­
 
	mfmh_»cs
[];

72 
__šlše__
 
size_t


73 
	$fsm­_sizeof
(

74 
Ä
)

76  (
fsm­_h—d
è+ 
Ä
 * (
fsm­
);

77 
	}
}

80 
__šlše__
 

81 
	$fsm­_advªû
(

82 
fsm­_h—d
 *
h—d
)

84 
h—d
->
fmh_keys
[0] = h—d->
fmh_»cs
[h—d->
fmh_’Œ›s
 - 1];

85 
	}
}

89 
	#FMH_IF_VALID
 0

	)

92 
	#FMH_OF_DEV_T
 0x1

	)

95 
	#FMR_OF_PREALLOC
 0x1

	)

96 
	#FMR_OF_ATTR_FORK
 0x2

	)

97 
	#FMR_OF_EXTENT_MAP
 0x4

	)

98 
	#FMR_OF_SHARED
 0x8

	)

99 
	#FMR_OF_SPECIAL_OWNER
 0x10

	)

100 
	#FMR_OF_LAST
 0x20

	)

103 
	#FMR_OWNER
(
ty³
, 
code
è(((
__u64
)type << 32) | \

104 ((
__u64
)
code
 & 0xFFFFFFFFULL))

	)

105 
	#FMR_OWNER_TYPE
(
owÃr
è((
__u32
)((
__u64
)owÃ¸>> 32))

	)

106 
	#FMR_OWNER_CODE
(
owÃr
è((
__u32
)(((
__u64
)owÃ¸& 0xFFFFFFFFULL)))

	)

107 
	#FMR_OWN_FREE
 
	`FMR_OWNER
(0, 1è

	)

108 
	#FMR_OWN_UNKNOWN
 
	`FMR_OWNER
(0, 2è

	)

109 
	#FMR_OWN_METADATA
 
	`FMR_OWNER
(0, 3è

	)

111 
	#FS_IOC_GETFSMAP
 
	`_IOWR
('X', 59, 
fsm­_h—d
)

	)

	@/usr/include/linux/kdev_t.h

2 #iâdeà
_LINUX_KDEV_T_H


3 
	#_LINUX_KDEV_T_H


	)

9 
	#MAJOR
(
dev
è((dev)>>8)

	)

10 
	#MINOR
(
dev
è((devè& 0xff)

	)

11 
	#MKDEV
(
ma
,
mi
è((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

2 #iâdeà
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<lšux/sysšfo.h
>

10 
	#__ALIGN_KERNEL
(
x
, 
a
è
	`__ALIGN_KERNEL_MASK
(x, (
	`ty³of
(x))×è- 1)

	)

11 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
è(((xè+ (mask)è& ~(mask))

	)

13 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
è((Òè+ (dè- 1è/ (d))

	)

	@/usr/include/linux/magic.h

2 #iâdeà
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

23 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

24 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

25 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

26 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

27 
	#NILFS_SUPER_MAGIC
 0x3434

	)

28 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

29 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

30 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

31 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

32 
	#XFS_SUPER_MAGIC
 0x58465342

	)

33 
	#PSTOREFS_MAGIC
 0x6165676C

	)

34 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

35 
	#HOSTFS_SUPER_MAGIC
 0x00c0fãe

	)

36 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

38 
	#MINIX_SUPER_MAGIC
 0x137F

	)

39 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

40 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

41 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

42 
	#MINIX3_SUPER_MAGIC
 0x4d5¨

	)

44 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

45 
	#NCP_SUPER_MAGIC
 0x564ø

	)

46 
	#NFS_SUPER_MAGIC
 0x6969

	)

47 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

48 
	#OPENPROM_SUPER_MAGIC
 0x9ç1

	)

49 
	#QNX4_SUPER_MAGIC
 0x002à

	)

50 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

51 
	#AFS_FS_MAGIC
 0x6B414653

	)

53 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

56 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

57 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

58 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

60 
	#SMB_SUPER_MAGIC
 0x517B

	)

61 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

62 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

64 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

66 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

68 
	#TRACEFS_MAGIC
 0x74726163

	)

70 
	#V9FS_MAGIC
 0x01021997

	)

72 
	#BDEVFS_MAGIC
 0x62646576

	)

73 
	#DAXFS_MAGIC
 0x64646178

	)

74 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

75 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

76 
	#BINDERFS_SUPER_MAGIC
 0x6c6f6f70

	)

77 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

78 
	#PIPEFS_MAGIC
 0x50495045

	)

79 
	#PROC_SUPER_MAGIC
 0x9ç0

	)

80 
	#SOCKFS_MAGIC
 0x534F434B

	)

81 
	#SYSFS_MAGIC
 0x62656572

	)

82 
	#USBDEVICE_SUPER_MAGIC
 0x9ç2

	)

83 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

84 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

85 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

86 
	#NSFS_MAGIC
 0x6e736673

	)

87 
	#BPF_FS_MAGIC
 0xÿã4a11

	)

88 
	#AAFS_MAGIC
 0x5a3c69f0

	)

91 
	#UDF_SUPER_MAGIC
 0x15013346

	)

92 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

93 
	#ZSMALLOC_MAGIC
 0x58295829

	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/mount.h

1 #iâdeà
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

11 
	#MS_RDONLY
 1

	)

12 
	#MS_NOSUID
 2

	)

13 
	#MS_NODEV
 4

	)

14 
	#MS_NOEXEC
 8

	)

15 
	#MS_SYNCHRONOUS
 16

	)

16 
	#MS_REMOUNT
 32

	)

17 
	#MS_MANDLOCK
 64

	)

18 
	#MS_DIRSYNC
 128

	)

19 
	#MS_NOATIME
 1024

	)

20 
	#MS_NODIRATIME
 2048

	)

21 
	#MS_BIND
 4096

	)

22 
	#MS_MOVE
 8192

	)

23 
	#MS_REC
 16384

	)

24 
	#MS_VERBOSE
 32768

	)

26 
	#MS_SILENT
 32768

	)

27 
	#MS_POSIXACL
 (1<<16è

	)

28 
	#MS_UNBINDABLE
 (1<<17è

	)

29 
	#MS_PRIVATE
 (1<<18è

	)

30 
	#MS_SLAVE
 (1<<19è

	)

31 
	#MS_SHARED
 (1<<20è

	)

32 
	#MS_RELATIME
 (1<<21è

	)

33 
	#MS_KERNMOUNT
 (1<<22è

	)

34 
	#MS_I_VERSION
 (1<<23è

	)

35 
	#MS_STRICTATIME
 (1<<24è

	)

36 
	#MS_LAZYTIME
 (1<<25è

	)

39 
	#MS_SUBMOUNT
 (1<<26)

	)

40 
	#MS_NOREMOTELOCK
 (1<<27)

	)

41 
	#MS_NOSEC
 (1<<28)

	)

42 
	#MS_BORN
 (1<<29)

	)

43 
	#MS_ACTIVE
 (1<<30)

	)

44 
	#MS_NOUSER
 (1<<31)

	)

49 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

50 
MS_LAZYTIME
)

	)

55 
	#MS_MGC_VAL
 0xC0ED0000

	)

56 
	#MS_MGC_MSK
 0xffff0000

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #iâdeà
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<lšux/ty³s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_aş_x©Œ_’Œy
 {

30 
__Ë16
 
	me_g
;

31 
__Ë16
 
	me_³rm
;

32 
__Ë32
 
	me_id
;

35 
	sposix_aş_x©Œ_h—d”
 {

36 
__Ë32
 
	ma_v”siÚ
;

	@/usr/include/linux/quota.h

33 #iâdeà
_LINUX_QUOTA_


34 
	#_LINUX_QUOTA_


	)

36 
	~<lšux/ty³s.h
>

38 
	#__DQUOT_VERSION__
 "dquÙ_6.6.0"

	)

40 
	#MAXQUOTAS
 3

	)

41 
	#USRQUOTA
 0

	)

42 
	#GRPQUOTA
 1

	)

43 
	#PRJQUOTA
 2

	)

48 
	#INITQFNAMES
 { \

53 };

	)

61 
	#SUBCMDMASK
 0x00ff

	)

62 
	#SUBCMDSHIFT
 8

	)

63 
	#QCMD
(
cmd
, 
ty³
è(((cmdè<< 
SUBCMDSHIFT
è| (Ñy³è& 
SUBCMDMASK
))

	)

65 
	#Q_SYNC
 0x800001

	)

66 
	#Q_QUOTAON
 0x800002

	)

67 
	#Q_QUOTAOFF
 0x800003

	)

68 
	#Q_GETFMT
 0x800004

	)

69 
	#Q_GETINFO
 0x800005

	)

70 
	#Q_SETINFO
 0x800006

	)

71 
	#Q_GETQUOTA
 0x800007

	)

72 
	#Q_SETQUOTA
 0x800008

	)

73 
	#Q_GETNEXTQUOTA
 0x800009

	)

76 
	#QFMT_VFS_OLD
 1

	)

77 
	#QFMT_VFS_V0
 2

	)

78 
	#QFMT_OCFS2
 3

	)

79 
	#QFMT_VFS_V1
 4

	)

83 
	#QIF_DQBLKSIZE_BITS
 10

	)

84 
	#QIF_DQBLKSIZE
 (1 << 
QIF_DQBLKSIZE_BITS
)

	)

91 
	mQIF_BLIMITS_B
 = 0,

92 
	mQIF_SPACE_B
,

93 
	mQIF_ILIMITS_B
,

94 
	mQIF_INODES_B
,

95 
	mQIF_BTIME_B
,

96 
	mQIF_ITIME_B
,

99 
	#QIF_BLIMITS
 (1 << 
QIF_BLIMITS_B
)

	)

100 
	#QIF_SPACE
 (1 << 
QIF_SPACE_B
)

	)

101 
	#QIF_ILIMITS
 (1 << 
QIF_ILIMITS_B
)

	)

102 
	#QIF_INODES
 (1 << 
QIF_INODES_B
)

	)

103 
	#QIF_BTIME
 (1 << 
QIF_BTIME_B
)

	)

104 
	#QIF_ITIME
 (1 << 
QIF_ITIME_B
)

	)

105 
	#QIF_LIMITS
 (
QIF_BLIMITS
 | 
QIF_ILIMITS
)

	)

106 
	#QIF_USAGE
 (
QIF_SPACE
 | 
QIF_INODES
)

	)

107 
	#QIF_TIMES
 (
QIF_BTIME
 | 
QIF_ITIME
)

	)

108 
	#QIF_ALL
 (
QIF_LIMITS
 | 
QIF_USAGE
 | 
QIF_TIMES
)

	)

110 
	sif_dqblk
 {

111 
__u64
 
	mdqb_bh¬dlim™
;

112 
__u64
 
	mdqb_bsoálim™
;

113 
__u64
 
	mdqb_cur¥aû
;

114 
__u64
 
	mdqb_ih¬dlim™
;

115 
__u64
 
	mdqb_isoálim™
;

116 
__u64
 
	mdqb_curšodes
;

117 
__u64
 
	mdqb_btime
;

118 
__u64
 
	mdqb_™ime
;

119 
__u32
 
	mdqb_v®id
;

122 
	sif_Ãxtdqblk
 {

123 
__u64
 
	mdqb_bh¬dlim™
;

124 
__u64
 
	mdqb_bsoálim™
;

125 
__u64
 
	mdqb_cur¥aû
;

126 
__u64
 
	mdqb_ih¬dlim™
;

127 
__u64
 
	mdqb_isoálim™
;

128 
__u64
 
	mdqb_curšodes
;

129 
__u64
 
	mdqb_btime
;

130 
__u64
 
	mdqb_™ime
;

131 
__u32
 
	mdqb_v®id
;

132 
__u32
 
	mdqb_id
;

139 
	#IIF_BGRACE
 1

	)

140 
	#IIF_IGRACE
 2

	)

141 
	#IIF_FLAGS
 4

	)

142 
	#IIF_ALL
 (
IIF_BGRACE
 | 
IIF_IGRACE
 | 
IIF_FLAGS
)

	)

145 
	mDQF_ROOT_SQUASH_B
 = 0,

146 
	mDQF_SYS_FILE_B
 = 16,

148 
	mDQF_PRIVATE


152 
	#DQF_ROOT_SQUASH
 (1 << 
DQF_ROOT_SQUASH_B
)

	)

154 
	#DQF_SYS_FILE
 (1 << 
DQF_SYS_FILE_B
)

	)

156 
	sif_dqšfo
 {

157 
__u64
 
	mdqi_bg¿û
;

158 
__u64
 
	mdqi_ig¿û
;

159 
__u32
 
	mdqi_æags
;

160 
__u32
 
	mdqi_v®id
;

166 
	#QUOTA_NL_NOWARN
 0

	)

167 
	#QUOTA_NL_IHARDWARN
 1

	)

168 
	#QUOTA_NL_ISOFTLONGWARN
 2

	)

169 
	#QUOTA_NL_ISOFTWARN
 3

	)

170 
	#QUOTA_NL_BHARDWARN
 4

	)

171 
	#QUOTA_NL_BSOFTLONGWARN
 5

	)

172 
	#QUOTA_NL_BSOFTWARN
 6

	)

173 
	#QUOTA_NL_IHARDBELOW
 7

	)

174 
	#QUOTA_NL_ISOFTBELOW
 8

	)

175 
	#QUOTA_NL_BHARDBELOW
 9

	)

176 
	#QUOTA_NL_BSOFTBELOW
 10

	)

179 
	mQUOTA_NL_C_UNSPEC
,

180 
	mQUOTA_NL_C_WARNING
,

181 
	m__QUOTA_NL_C_MAX
,

183 
	#QUOTA_NL_C_MAX
 (
__QUOTA_NL_C_MAX
 - 1)

	)

186 
	mQUOTA_NL_A_UNSPEC
,

187 
	mQUOTA_NL_A_QTYPE
,

188 
	mQUOTA_NL_A_EXCESS_ID
,

189 
	mQUOTA_NL_A_WARNING
,

190 
	mQUOTA_NL_A_DEV_MAJOR
,

191 
	mQUOTA_NL_A_DEV_MINOR
,

192 
	mQUOTA_NL_A_CAUSED_ID
,

193 
	mQUOTA_NL_A_PAD
,

194 
	m__QUOTA_NL_A_MAX
,

196 
	#QUOTA_NL_A_MAX
 (
__QUOTA_NL_A_MAX
 - 1)

	)

	@/usr/include/linux/random.h

8 #iâdeà
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<lšux/ty³s.h
>

12 
	~<lšux/ioùl.h
>

13 
	~<lšux/œqÄ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
Ğ'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
Ğ'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
Ğ'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
Ğ'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
Ğ'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
Ğ'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
Ğ'R', 0x07 )

	)

41 
	s¿nd_poŞ_šfo
 {

42 
	m’Œİy_couÁ
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[0];

53 
	#GRND_NONBLOCK
 0x0001

	)

54 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

2 #iâdeà
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

8 
	#CSIGNAL
 0x000000fà

	)

9 
	#CLONE_VM
 0x00000100

	)

10 
	#CLONE_FS
 0x00000200

	)

11 
	#CLONE_FILES
 0x00000400

	)

12 
	#CLONE_SIGHAND
 0x00000800

	)

13 
	#CLONE_PTRACE
 0x00002000

	)

14 
	#CLONE_VFORK
 0x00004000

	)

15 
	#CLONE_PARENT
 0x00008000

	)

16 
	#CLONE_THREAD
 0x00010000

	)

17 
	#CLONE_NEWNS
 0x00020000

	)

18 
	#CLONE_SYSVSEM
 0x00040000

	)

19 
	#CLONE_SETTLS
 0x00080000

	)

20 
	#CLONE_PARENT_SETTID
 0x00100000

	)

21 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

22 
	#CLONE_DETACHED
 0x00400000

	)

23 
	#CLONE_UNTRACED
 0x00800000

	)

24 
	#CLONE_CHILD_SETTID
 0x01000000

	)

25 
	#CLONE_NEWCGROUP
 0x02000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

42 
	#SCHED_DEADLINE
 6

	)

45 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

50 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

51 
	#SCHED_FLAG_RECLAIM
 0x02

	)

52 
	#SCHED_FLAG_DL_OVERRUN
 0x04

	)

54 
	#SCHED_FLAG_ALL
 (
SCHED_FLAG_RESET_ON_FORK
 | \

55 
SCHED_FLAG_RECLAIM
 | \

56 
SCHED_FLAG_DL_OVERRUN
)

	)

	@/usr/include/linux/stat.h

2 #iâdeà
_LINUX_STAT_H


3 
	#_LINUX_STAT_H


	)

5 
	~<lšux/ty³s.h
>

7 #ià
defšed
(
__KERNEL__
è|| !defšed(
__GLIBC__
) || (__GLIBC__ < 2)

9 
	#S_IFMT
 00170000

	)

10 
	#S_IFSOCK
 0140000

	)

11 
	#S_IFLNK
 0120000

	)

12 
	#S_IFREG
 0100000

	)

13 
	#S_IFBLK
 0060000

	)

14 
	#S_IFDIR
 0040000

	)

15 
	#S_IFCHR
 0020000

	)

16 
	#S_IFIFO
 0010000

	)

17 
	#S_ISUID
 0004000

	)

18 
	#S_ISGID
 0002000

	)

19 
	#S_ISVTX
 0001000

	)

21 
	#S_ISLNK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFLNK
)

	)

22 
	#S_ISREG
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFREG
)

	)

23 
	#S_ISDIR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFDIR
)

	)

24 
	#S_ISCHR
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFCHR
)

	)

25 
	#S_ISBLK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFBLK
)

	)

26 
	#S_ISFIFO
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFIFO
)

	)

27 
	#S_ISSOCK
(
m
è(((mè& 
S_IFMT
è=ğ
S_IFSOCK
)

	)

29 
	#S_IRWXU
 00700

	)

30 
	#S_IRUSR
 00400

	)

31 
	#S_IWUSR
 00200

	)

32 
	#S_IXUSR
 00100

	)

34 
	#S_IRWXG
 00070

	)

35 
	#S_IRGRP
 00040

	)

36 
	#S_IWGRP
 00020

	)

37 
	#S_IXGRP
 00010

	)

39 
	#S_IRWXO
 00007

	)

40 
	#S_IROTH
 00004

	)

41 
	#S_IWOTH
 00002

	)

42 
	#S_IXOTH
 00001

	)

56 
	s¡©x_time¡amp
 {

57 
__s64
 
	mtv_£c
;

58 
__u32
 
	mtv_n£c
;

59 
__s32
 
	m__»£rved
;

99 
	s¡©x
 {

101 
__u32
 
	m¡x_mask
;

102 
__u32
 
	m¡x_blksize
;

103 
__u64
 
	m¡x_©Œibu‹s
;

105 
__u32
 
	m¡x_Æšk
;

106 
__u32
 
	m¡x_uid
;

107 
__u32
 
	m¡x_gid
;

108 
__u16
 
	m¡x_mode
;

109 
__u16
 
	m__¥¬e0
[1];

111 
__u64
 
	m¡x_šo
;

112 
__u64
 
	m¡x_size
;

113 
__u64
 
	m¡x_blocks
;

114 
__u64
 
	m¡x_©Œibu‹s_mask
;

116 
¡©x_time¡amp
 
	m¡x_©ime
;

117 
¡©x_time¡amp
 
	m¡x_btime
;

118 
¡©x_time¡amp
 
	m¡x_ùime
;

119 
¡©x_time¡amp
 
	m¡x_mtime
;

121 
__u32
 
	m¡x_rdev_majÜ
;

122 
__u32
 
	m¡x_rdev_mšÜ
;

123 
__u32
 
	m¡x_dev_majÜ
;

124 
__u32
 
	m¡x_dev_mšÜ
;

126 
__u64
 
	m__¥¬e2
[14];

138 
	#STATX_TYPE
 0x00000001U

	)

139 
	#STATX_MODE
 0x00000002U

	)

140 
	#STATX_NLINK
 0x00000004U

	)

141 
	#STATX_UID
 0x00000008U

	)

142 
	#STATX_GID
 0x00000010U

	)

143 
	#STATX_ATIME
 0x00000020U

	)

144 
	#STATX_MTIME
 0x00000040U

	)

145 
	#STATX_CTIME
 0x00000080U

	)

146 
	#STATX_INO
 0x00000100U

	)

147 
	#STATX_SIZE
 0x00000200U

	)

148 
	#STATX_BLOCKS
 0x00000400U

	)

149 
	#STATX_BASIC_STATS
 0x000007ffU

	)

150 
	#STATX_BTIME
 0x00000800U

	)

151 
	#STATX_ALL
 0x00000fffU

	)

152 
	#STATX__RESERVED
 0x80000000U

	)

165 
	#STATX_ATTR_COMPRESSED
 0x00000004

	)

166 
	#STATX_ATTR_IMMUTABLE
 0x00000010

	)

167 
	#STATX_ATTR_APPEND
 0x00000020

	)

168 
	#STATX_ATTR_NODUMP
 0x00000040

	)

169 
	#STATX_ATTR_ENCRYPTED
 0x00000800

	)

171 
	#STATX_ATTR_AUTOMOUNT
 0x00001000

	)

	@/usr/include/linux/string.h

2 #iâdeà
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<¡ršg.h
>

	@/usr/include/linux/time.h

2 #iâdeà
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<lšux/ty³s.h
>

8 #iâdeà
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime¥ec
 {

11 
__k”Ãl_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimev®
 {

17 
__k”Ãl_time_t
 
	mtv_£c
;

18 
__k”Ãl_su£cÚds_t
 
	mtv_u£c
;

21 
	stimezÚe
 {

22 
	mtz_mšu‹swe¡
;

23 
	mtz_d¡time
;

31 
	#ITIMER_REAL
 0

	)

32 
	#ITIMER_VIRTUAL
 1

	)

33 
	#ITIMER_PROF
 2

	)

35 
	s™im”¥ec
 {

36 
time¥ec
 
	m™_š‹rv®
;

37 
time¥ec
 
	m™_v®ue
;

40 
	s™im”v®
 {

41 
timev®
 
	m™_š‹rv®
;

42 
timev®
 
	m™_v®ue
;

45 #iâdeà
__k”Ãl_time¥ec


46 
	s__k”Ãl_time¥ec
 {

47 
__k”Ãl_time64_t
 
	mtv_£c
;

48 
	mtv_n£c
;

52 #iâdeà
__k”Ãl_™im”¥ec


53 
	s__k”Ãl_™im”¥ec
 {

54 
__k”Ãl_time¥ec
 
	m™_š‹rv®
;

55 
__k”Ãl_time¥ec
 
	m™_v®ue
;

66 
	s__k”Ãl_Şd_timev®
 {

67 
__k”Ãl_lÚg_t
 
	mtv_£c
;

68 
__k”Ãl_lÚg_t
 
	mtv_u£c
;

74 
	#CLOCK_REALTIME
 0

	)

75 
	#CLOCK_MONOTONIC
 1

	)

76 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

77 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

78 
	#CLOCK_MONOTONIC_RAW
 4

	)

79 
	#CLOCK_REALTIME_COARSE
 5

	)

80 
	#CLOCK_MONOTONIC_COARSE
 6

	)

81 
	#CLOCK_BOOTTIME
 7

	)

82 
	#CLOCK_REALTIME_ALARM
 8

	)

83 
	#CLOCK_BOOTTIME_ALARM
 9

	)

88 
	#CLOCK_SGI_CYCLE
 10

	)

89 
	#CLOCK_TAI
 11

	)

91 
	#MAX_CLOCKS
 16

	)

92 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

93 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

98 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

17 #ifdeà
__CHECKER__


18 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

20 
	#__b™wi£__


	)

22 
	#__b™wi£
 
__b™wi£__


	)

24 
__u16
 
	t__b™wi£
 
	t__Ë16
;

25 
__u16
 
	t__b™wi£
 
	t__be16
;

26 
__u32
 
	t__b™wi£
 
	t__Ë32
;

27 
__u32
 
	t__b™wi£
 
	t__be32
;

28 
__u64
 
	t__b™wi£
 
	t__Ë64
;

29 
__u64
 
	t__b™wi£
 
	t__be64
;

31 
__u16
 
	t__b™wi£
 
	t__sum16
;

32 
__u32
 
	t__b™wi£
 
	t__wsum
;

43 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

44 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

45 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	t__b™wi£
 
	t__pŞl_t
;

	@/usr/include/linux/uio.h

10 #iâdeà
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<lšux/ty³s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__k”Ãl_size_t
 
	miov_Ën
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/utsname.h

2 #iâdeà
_LINUX_UTSNAME_H


3 
	#_LINUX_UTSNAME_H


	)

5 
	#__OLD_UTS_LEN
 8

	)

7 
	sŞdŞd_ut¢ame
 {

8 
	msy¢ame
[9];

9 
	mnod’ame
[9];

10 
	m»Ëa£
[9];

11 
	mv”siÚ
[9];

12 
	mmachše
[9];

15 
	#__NEW_UTS_LEN
 64

	)

17 
	sŞd_ut¢ame
 {

18 
	msy¢ame
[65];

19 
	mnod’ame
[65];

20 
	m»Ëa£
[65];

21 
	mv”siÚ
[65];

22 
	mmachše
[65];

25 
	sÃw_ut¢ame
 {

26 
	msy¢ame
[
__NEW_UTS_LEN
 + 1];

27 
	mnod’ame
[
__NEW_UTS_LEN
 + 1];

28 
	m»Ëa£
[
__NEW_UTS_LEN
 + 1];

29 
	mv”siÚ
[
__NEW_UTS_LEN
 + 1];

30 
	mmachše
[
__NEW_UTS_LEN
 + 1];

31 
	mdomašÇme
[
__NEW_UTS_LEN
 + 1];

	@/usr/include/linux/uuid.h

18 #iâdeà
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<lšux/ty³s.h
>

24 
__u8
 
	mb
[16];

25 } 
	tguid_t
;

27 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

28 ((
guid_t
) \

29 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

30 (
b
) & 0xff, ((b) >> 8) & 0xff, \

31 (
c
) & 0xff, ((c) >> 8) & 0xff, \

32 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
è}})

	)

35 
guid_t
 
	tuuid_Ë
;

36 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

37 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

38 
	#NULL_UUID_LE
 \

39 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

40 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 327689

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/linux/wait.h

2 #iâdeà
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

	@/usr/include/linux/xattr.h

12 
	~<lšux/libc-com·t.h
>

14 #iâdeà
_LINUX_XATTR_H


15 
	#_LINUX_XATTR_H


	)

17 #ià
__UAPI_DEF_XATTR


18 
	#__USE_KERNEL_XATTR_DEFS


	)

20 
	#XATTR_CREATE
 0x1

	)

21 
	#XATTR_REPLACE
 0x2

	)

25 
	#XATTR_OS2_PREFIX
 "os2."

	)

26 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
è- 1)

	)

28 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

29 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
è- 1)

	)

31 
	#XATTR_BTRFS_PREFIX
 "bŒfs."

	)

32 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
è- 1)

	)

34 
	#XATTR_SECURITY_PREFIX
 "£cur™y."

	)

35 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
è- 1)

	)

37 
	#XATTR_SYSTEM_PREFIX
 "sy¡em."

	)

38 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
è- 1)

	)

40 
	#XATTR_TRUSTED_PREFIX
 "Œu¡ed."

	)

41 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
è- 1)

	)

43 
	#XATTR_USER_PREFIX
 "u£r."

	)

44 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
è- 1)

	)

47 
	#XATTR_EVM_SUFFIX
 "evm"

	)

48 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

50 
	#XATTR_IMA_SUFFIX
 "ima"

	)

51 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

53 
	#XATTR_SELINUX_SUFFIX
 "£lšux"

	)

54 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

56 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

57 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

58 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

59 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

60 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

61 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

62 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

63 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

64 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

65 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

66 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

67 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

69 
	#XATTR_APPARMOR_SUFFIX
 "­·rmÜ"

	)

70 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

72 
	#XATTR_CAPS_SUFFIX
 "ÿ·b™y"

	)

73 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

75 
	#XATTR_POSIX_ACL_ACCESS
 "posix_aş_acûss"

	)

76 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

77 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_aş_deçuÉ"

	)

78 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm/errno.h

1 
	~<asm-g’”ic/”ºo.h
>

	@/usr/include/asm/fcntl.h

1 
	~<asm-g’”ic/fú.h
>

	@/usr/include/asm/types.h

2 #iâdeà
_ASM_X86_TYPES_H


3 
	#_ASM_X86_TYPES_H


	)

5 
	~<asm-g’”ic/ty³s.h
>

	@/usr/include/linux/byteorder/little_endian.h

2 #iâdeà
_LINUX_BYTEORDER_LITTLE_ENDIAN_H


3 
	#_LINUX_BYTEORDER_LITTLE_ENDIAN_H


	)

5 #iâdeà
__LITTLE_ENDIAN


6 
	#__LITTLE_ENDIAN
 1234

	)

8 #iâdeà
__LITTLE_ENDIAN_BITFIELD


9 
	#__LITTLE_ENDIAN_BITFIELD


	)

12 
	~<lšux/ty³s.h
>

13 
	~<lšux/swab.h
>

15 
	#__cÚ¡ªt_htÚl
(
x
è((
__be32
)
	`___cÚ¡ªt_swab32
((x)))

	)

16 
	#__cÚ¡ªt_Áohl
(
x
è
	`___cÚ¡ªt_swab32
((
__be32
)(x))

	)

17 
	#__cÚ¡ªt_htÚs
(
x
è((
__be16
)
	`___cÚ¡ªt_swab16
((x)))

	)

18 
	#__cÚ¡ªt_Áohs
(
x
è
	`___cÚ¡ªt_swab16
((
__be16
)(x))

	)

19 
	#__cÚ¡ªt_ıu_to_Ë64
(
x
è((
__Ë64
)(
__u64
)(x))

	)

20 
	#__cÚ¡ªt_Ë64_to_ıu
(
x
è((
__u64
)(
__Ë64
)(x))

	)

21 
	#__cÚ¡ªt_ıu_to_Ë32
(
x
è((
__Ë32
)(
__u32
)(x))

	)

22 
	#__cÚ¡ªt_Ë32_to_ıu
(
x
è((
__u32
)(
__Ë32
)(x))

	)

23 
	#__cÚ¡ªt_ıu_to_Ë16
(
x
è((
__Ë16
)(
__u16
)(x))

	)

24 
	#__cÚ¡ªt_Ë16_to_ıu
(
x
è((
__u16
)(
__Ë16
)(x))

	)

25 
	#__cÚ¡ªt_ıu_to_be64
(
x
è((
__be64
)
	`___cÚ¡ªt_swab64
((x)))

	)

26 
	#__cÚ¡ªt_be64_to_ıu
(
x
è
	`___cÚ¡ªt_swab64
((
__u64
)(
__be64
)(x))

	)

27 
	#__cÚ¡ªt_ıu_to_be32
(
x
è((
__be32
)
	`___cÚ¡ªt_swab32
((x)))

	)

28 
	#__cÚ¡ªt_be32_to_ıu
(
x
è
	`___cÚ¡ªt_swab32
((
__u32
)(
__be32
)(x))

	)

29 
	#__cÚ¡ªt_ıu_to_be16
(
x
è((
__be16
)
	`___cÚ¡ªt_swab16
((x)))

	)

30 
	#__cÚ¡ªt_be16_to_ıu
(
x
è
	`___cÚ¡ªt_swab16
((
__u16
)(
__be16
)(x))

	)

31 
	#__ıu_to_Ë64
(
x
è((
__Ë64
)(
__u64
)(x))

	)

32 
	#__Ë64_to_ıu
(
x
è((
__u64
)(
__Ë64
)(x))

	)

33 
	#__ıu_to_Ë32
(
x
è((
__Ë32
)(
__u32
)(x))

	)

34 
	#__Ë32_to_ıu
(
x
è((
__u32
)(
__Ë32
)(x))

	)

35 
	#__ıu_to_Ë16
(
x
è((
__Ë16
)(
__u16
)(x))

	)

36 
	#__Ë16_to_ıu
(
x
è((
__u16
)(
__Ë16
)(x))

	)

37 
	#__ıu_to_be64
(
x
è((
__be64
)
	`__swab64
((x)))

	)

38 
	#__be64_to_ıu
(
x
è
	`__swab64
((
__u64
)(
__be64
)(x))

	)

39 
	#__ıu_to_be32
(
x
è((
__be32
)
	`__swab32
((x)))

	)

40 
	#__be32_to_ıu
(
x
è
	`__swab32
((
__u32
)(
__be32
)(x))

	)

41 
	#__ıu_to_be16
(
x
è((
__be16
)
	`__swab16
((x)))

	)

42 
	#__be16_to_ıu
(
x
è
	`__swab16
((
__u16
)(
__be16
)(x))

	)

44 
__®ways_šlše
 
__Ë64
 
	$__ıu_to_Ë64p
(cÚ¡ 
__u64
 *
p
)

46  (
__Ë64
)*
p
;

47 
	}
}

48 
__®ways_šlše
 
__u64
 
	$__Ë64_to_ıup
(cÚ¡ 
__Ë64
 *
p
)

50  (
__u64
)*
p
;

51 
	}
}

52 
__®ways_šlše
 
__Ë32
 
	$__ıu_to_Ë32p
(cÚ¡ 
__u32
 *
p
)

54  (
__Ë32
)*
p
;

55 
	}
}

56 
__®ways_šlše
 
__u32
 
	$__Ë32_to_ıup
(cÚ¡ 
__Ë32
 *
p
)

58  (
__u32
)*
p
;

59 
	}
}

60 
__®ways_šlše
 
__Ë16
 
	$__ıu_to_Ë16p
(cÚ¡ 
__u16
 *
p
)

62  (
__Ë16
)*
p
;

63 
	}
}

64 
__®ways_šlše
 
__u16
 
	$__Ë16_to_ıup
(cÚ¡ 
__Ë16
 *
p
)

66  (
__u16
)*
p
;

67 
	}
}

68 
__®ways_šlše
 
__be64
 
	$__ıu_to_be64p
(cÚ¡ 
__u64
 *
p
)

70  (
__be64
)
	`__swab64p
(
p
);

71 
	}
}

72 
__®ways_šlše
 
__u64
 
	$__be64_to_ıup
(cÚ¡ 
__be64
 *
p
)

74  
	`__swab64p
((
__u64
 *)
p
);

75 
	}
}

76 
__®ways_šlše
 
__be32
 
	$__ıu_to_be32p
(cÚ¡ 
__u32
 *
p
)

78  (
__be32
)
	`__swab32p
(
p
);

79 
	}
}

80 
__®ways_šlše
 
__u32
 
	$__be32_to_ıup
(cÚ¡ 
__be32
 *
p
)

82  
	`__swab32p
((
__u32
 *)
p
);

83 
	}
}

84 
__®ways_šlše
 
__be16
 
	$__ıu_to_be16p
(cÚ¡ 
__u16
 *
p
)

86  (
__be16
)
	`__swab16p
(
p
);

87 
	}
}

88 
__®ways_šlše
 
__u16
 
	$__be16_to_ıup
(cÚ¡ 
__be16
 *
p
)

90  
	`__swab16p
((
__u16
 *)
p
);

91 
	}
}

92 
	#__ıu_to_Ë64s
(
x
èdØ{ ()(x); } 0)

	)

93 
	#__Ë64_to_ıus
(
x
èdØ{ ()(x); } 0)

	)

94 
	#__ıu_to_Ë32s
(
x
èdØ{ ()(x); } 0)

	)

95 
	#__Ë32_to_ıus
(
x
èdØ{ ()(x); } 0)

	)

96 
	#__ıu_to_Ë16s
(
x
èdØ{ ()(x); } 0)

	)

97 
	#__Ë16_to_ıus
(
x
èdØ{ ()(x); } 0)

	)

98 
	#__ıu_to_be64s
(
x
è
	`__swab64s
((x))

	)

99 
	#__be64_to_ıus
(
x
è
	`__swab64s
((x))

	)

100 
	#__ıu_to_be32s
(
x
è
	`__swab32s
((x))

	)

101 
	#__be32_to_ıus
(
x
è
	`__swab32s
((x))

	)

102 
	#__ıu_to_be16s
(
x
è
	`__swab16s
((x))

	)

103 
	#__be16_to_ıus
(
x
è
	`__swab16s
((x))

	)

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

49 #iâdeà
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #ià
defšed
(
__GLIBC__
)

56 #ià
defšed
(
_NET_IF_H
è&& defšed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #ià
defšed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #ià
defšed
(
__USE_MISC
è|| defšed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #ià
defšed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #ià
defšed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #iâdeà
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #iâdeà
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #iâdeà
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #iâdeà
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #iâdeà
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #iâdeà
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #iâdeà
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #iâdeà
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #iâdeà
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #iâdeà
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #iâdeà
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #iâdeà
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #iâdeà
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #iâdeà
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #iâdeà
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #iâdeà
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #iâdeà
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #iâdeà
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #iâdeà
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #iâdeà
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #iâdeà
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #iâdeà
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #iâdeà
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #iâdeà
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #iâdeà
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/sysinfo.h

2 #iâdeà
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<lšux/ty³s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysšfo
 {

9 
__k”Ãl_lÚg_t
 
	mu±ime
;

10 
__k”Ãl_ulÚg_t
 
	mlßds
[3];

11 
__k”Ãl_ulÚg_t
 
	mtÙ®¿m
;

12 
__k”Ãl_ulÚg_t
 
	mä“¿m
;

13 
__k”Ãl_ulÚg_t
 
	msh¬ed¿m
;

14 
__k”Ãl_ulÚg_t
 
	mbufã¼am
;

15 
__k”Ãl_ulÚg_t
 
	mtÙ®sw­
;

16 
__k”Ãl_ulÚg_t
 
	mä“sw­
;

17 
__u16
 
	m´ocs
;

18 
__u16
 
	m·d
;

19 
__k”Ãl_ulÚg_t
 
	mtÙ®high
;

20 
__k”Ãl_ulÚg_t
 
	mä“high
;

21 
__u32
 
	mmem_un™
;

22 
	m_f
[20-2*(
__k”Ãl_ulÚg_t
)-(
__u32
)];

	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

36 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

37 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

52 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


53 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

54 
__c
, 
size_t
 
__n
)

55 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

63 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

64 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

67 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


70 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

71 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

72 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

75 #ifdeà
__OPTIMIZE__


76 
__ex‹º_®ways_šlše
 *

77 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


79  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

82 
__ex‹º_®ways_šlše
 const *

83 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


85  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

88 
	}
}

90 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

91 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

94 #ifdeà
__USE_GNU


97 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


98 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

99 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

100 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

101 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

108 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


109 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

110 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

112 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

121 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

122 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

124 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

125 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

129 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

132 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

133 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

137 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

139 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

140 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

146 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

147 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

148 
__THROW
 
	`__nÚnuÎ
 ((2));

150 #ifdeà
__USE_XOPEN2K8


152 
	~<b™s/ty³s/loÿË_t.h
>

155 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__l
)

156 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

159 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

160 
loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

163 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8
 \

164 || 
	$__GLIBC_USE
 (
LIB_EXT2
))

166 *
	$¡rdup
 (cÚ¡ *
__s
)

167 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

173 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

174 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

175 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


180 
	#¡rdu·
(
s
) \

181 (
__ex‹nsiÚ__
 \

183 cÚ¡ *
__Şd
 = (
s
); \

184 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

185 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

186 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

187 
	}
}))

	)

190 
	#¡ºdu·
(
s
, 
n
) \

191 (
__ex‹nsiÚ__
 \

193 cÚ¡ *
__Şd
 = (
s
); \

194 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

195 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

196 
__Ãw
[
__Ën
] = '\0'; \

197 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

198 }))

	)

202 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


205 *
¡rchr
 (*
__s
, 
__c
)

206 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

207 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

208 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

210 #ifdeà
__OPTIMIZE__


211 
__ex‹º_®ways_šlše
 *

212 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


214  
__butš_¡rchr
 (
__s
, 
__c
);

217 
__ex‹º_®ways_šlše
 const *

218 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

225 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

226 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

229 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


232 *
	`¡¼chr
 (*
__s
, 
__c
)

233 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

234 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

235 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

237 #ifdeà
__OPTIMIZE__


238 
__ex‹º_®ways_šlše
 *

239 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


241  
	`__butš_¡¼chr
 (
__s
, 
__c
);

244 
__ex‹º_®ways_šlše
 const *

245 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
	}
}

252 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

253 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

256 #ifdeà
__USE_GNU


259 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


260 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

261 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

262 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

263 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

265 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

266 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

276 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

277 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

279 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


282 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

283 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__OPTIMIZE__


288 
__ex‹º_®ways_šlše
 *

289 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


291  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

294 
__ex‹º_®ways_šlše
 const *

295 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


297  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

300 
	}
}

302 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

303 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

306 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


309 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

310 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

311 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

312 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__OPTIMIZE__


315 
__ex‹º_®ways_šlše
 *

316 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


318  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

321 
__ex‹º_®ways_šlše
 const *

322 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


324  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

327 
	}
}

329 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

330 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

335 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

336 
__THROW
 
	`__nÚnuÎ
 ((2));

340 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

341 cÚ¡ *
__»¡riù
 
__d–im
,

342 **
__»¡riù
 
__§ve_±r
)

343 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

344 #ifdeà
__USE_POSIX


345 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

346 **
__»¡riù
 
__§ve_±r
)

347 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

350 #ifdeà
__USE_GNU


352 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


353 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

354 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

355 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

356 cÚ¡ *
__ÃedË
)

357 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

359 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

360 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 #ifdeà
__USE_GNU


368 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

369 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

370 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

374 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

375 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

376 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

377 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

378 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

379 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

384 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

385 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

387 #ifdef 
__USE_XOPEN2K8


390 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

391 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

397 #ifdeà
__USE_XOPEN2K


405 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


408 #ifdeà
__REDIRECT_NTH


409 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

410 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

411 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

413 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

414 
__THROW
 
	`__nÚnuÎ
 ((2));

415 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

420 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

421 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

425 #ifdeà
__USE_XOPEN2K8


427 *
	$¡»¼Ü_l
 (
__”ºum
, 
loÿË_t
 
__l
è
__THROW
;

430 #ifdeà
__USE_MISC


431 
	~<¡ršgs.h
>

435 
	$ex¶ic™_bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

439 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

440 cÚ¡ *
__»¡riù
 
__d–im
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

444 #ifdef 
__USE_XOPEN2K8


446 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

449 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

450 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

451 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

452 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

456 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

457 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

458 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

460 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

461 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

464 #ifdef 
__USE_GNU


466 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

467 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

470 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

473 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

475 #iâdeà
ba£Çme


480 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


481 "C++" *
	$ba£Çme
 (*
__f’ame
)

482 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

483 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

484 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

486 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

491 #ià
	`__GNUC_PREREQ
 (3,4)

492 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


494 
	~<b™s/¡ršg_fÜtif›d.h
>

498 
__END_DECLS


	@/usr/include/asm-generic/errno.h

2 #iâdeà
_ASM_GENERIC_ERRNO_H


3 
	#_ASM_GENERIC_ERRNO_H


	)

5 
	~<asm-g’”ic/”ºo-ba£.h
>

7 
	#EDEADLK
 35

	)

8 
	#ENAMETOOLONG
 36

	)

9 
	#ENOLCK
 37

	)

18 
	#ENOSYS
 38

	)

20 
	#ENOTEMPTY
 39

	)

21 
	#ELOOP
 40

	)

22 
	#EWOULDBLOCK
 
EAGAIN


	)

23 
	#ENOMSG
 42

	)

24 
	#EIDRM
 43

	)

25 
	#ECHRNG
 44

	)

26 
	#EL2NSYNC
 45

	)

27 
	#EL3HLT
 46

	)

28 
	#EL3RST
 47

	)

29 
	#ELNRNG
 48

	)

30 
	#EUNATCH
 49

	)

31 
	#ENOCSI
 50

	)

32 
	#EL2HLT
 51

	)

33 
	#EBADE
 52

	)

34 
	#EBADR
 53

	)

35 
	#EXFULL
 54

	)

36 
	#ENOANO
 55

	)

37 
	#EBADRQC
 56

	)

38 
	#EBADSLT
 57

	)

40 
	#EDEADLOCK
 
EDEADLK


	)

42 
	#EBFONT
 59

	)

43 
	#ENOSTR
 60

	)

44 
	#ENODATA
 61

	)

45 
	#ETIME
 62

	)

46 
	#ENOSR
 63

	)

47 
	#ENONET
 64

	)

48 
	#ENOPKG
 65

	)

49 
	#EREMOTE
 66

	)

50 
	#ENOLINK
 67

	)

51 
	#EADV
 68

	)

52 
	#ESRMNT
 69

	)

53 
	#ECOMM
 70

	)

54 
	#EPROTO
 71

	)

55 
	#EMULTIHOP
 72

	)

56 
	#EDOTDOT
 73

	)

57 
	#EBADMSG
 74

	)

58 
	#EOVERFLOW
 75

	)

59 
	#ENOTUNIQ
 76

	)

60 
	#EBADFD
 77

	)

61 
	#EREMCHG
 78

	)

62 
	#ELIBACC
 79

	)

63 
	#ELIBBAD
 80

	)

64 
	#ELIBSCN
 81

	)

65 
	#ELIBMAX
 82

	)

66 
	#ELIBEXEC
 83

	)

67 
	#EILSEQ
 84

	)

68 
	#ERESTART
 85

	)

69 
	#ESTRPIPE
 86

	)

70 
	#EUSERS
 87

	)

71 
	#ENOTSOCK
 88

	)

72 
	#EDESTADDRREQ
 89

	)

73 
	#EMSGSIZE
 90

	)

74 
	#EPROTOTYPE
 91

	)

75 
	#ENOPROTOOPT
 92

	)

76 
	#EPROTONOSUPPORT
 93

	)

77 
	#ESOCKTNOSUPPORT
 94

	)

78 
	#EOPNOTSUPP
 95

	)

79 
	#EPFNOSUPPORT
 96

	)

80 
	#EAFNOSUPPORT
 97

	)

81 
	#EADDRINUSE
 98

	)

82 
	#EADDRNOTAVAIL
 99

	)

83 
	#ENETDOWN
 100

	)

84 
	#ENETUNREACH
 101

	)

85 
	#ENETRESET
 102

	)

86 
	#ECONNABORTED
 103

	)

87 
	#ECONNRESET
 104

	)

88 
	#ENOBUFS
 105

	)

89 
	#EISCONN
 106

	)

90 
	#ENOTCONN
 107

	)

91 
	#ESHUTDOWN
 108

	)

92 
	#ETOOMANYREFS
 109

	)

93 
	#ETIMEDOUT
 110

	)

94 
	#ECONNREFUSED
 111

	)

95 
	#EHOSTDOWN
 112

	)

96 
	#EHOSTUNREACH
 113

	)

97 
	#EALREADY
 114

	)

98 
	#EINPROGRESS
 115

	)

99 
	#ESTALE
 116

	)

100 
	#EUCLEAN
 117

	)

101 
	#ENOTNAM
 118

	)

102 
	#ENAVAIL
 119

	)

103 
	#EISNAM
 120

	)

104 
	#EREMOTEIO
 121

	)

105 
	#EDQUOT
 122

	)

107 
	#ENOMEDIUM
 123

	)

108 
	#EMEDIUMTYPE
 124

	)

109 
	#ECANCELED
 125

	)

110 
	#ENOKEY
 126

	)

111 
	#EKEYEXPIRED
 127

	)

112 
	#EKEYREVOKED
 128

	)

113 
	#EKEYREJECTED
 129

	)

116 
	#EOWNERDEAD
 130

	)

117 
	#ENOTRECOVERABLE
 131

	)

119 
	#ERFKILL
 132

	)

121 
	#EHWPOISON
 133

	)

	@/usr/include/asm-generic/fcntl.h

2 #iâdeà
_ASM_GENERIC_FCNTL_H


3 
	#_ASM_GENERIC_FCNTL_H


	)

5 
	~<lšux/ty³s.h
>

19 
	#O_ACCMODE
 00000003

	)

20 
	#O_RDONLY
 00000000

	)

21 
	#O_WRONLY
 00000001

	)

22 
	#O_RDWR
 00000002

	)

23 #iâdeà
O_CREAT


24 
	#O_CREAT
 00000100

	)

26 #iâdeà
O_EXCL


27 
	#O_EXCL
 00000200

	)

29 #iâdeà
O_NOCTTY


30 
	#O_NOCTTY
 00000400

	)

32 #iâdeà
O_TRUNC


33 
	#O_TRUNC
 00001000

	)

35 #iâdeà
O_APPEND


36 
	#O_APPEND
 00002000

	)

38 #iâdeà
O_NONBLOCK


39 
	#O_NONBLOCK
 00004000

	)

41 #iâdeà
O_DSYNC


42 
	#O_DSYNC
 00010000

	)

44 #iâdeà
FASYNC


45 
	#FASYNC
 00020000

	)

47 #iâdeà
O_DIRECT


48 
	#O_DIRECT
 00040000

	)

50 #iâdeà
O_LARGEFILE


51 
	#O_LARGEFILE
 00100000

	)

53 #iâdeà
O_DIRECTORY


54 
	#O_DIRECTORY
 00200000

	)

56 #iâdeà
O_NOFOLLOW


57 
	#O_NOFOLLOW
 00400000

	)

59 #iâdeà
O_NOATIME


60 
	#O_NOATIME
 01000000

	)

62 #iâdeà
O_CLOEXEC


63 
	#O_CLOEXEC
 02000000

	)

79 #iâdeà
O_SYNC


80 
	#__O_SYNC
 04000000

	)

81 
	#O_SYNC
 (
__O_SYNC
|
O_DSYNC
)

	)

84 #iâdeà
O_PATH


85 
	#O_PATH
 010000000

	)

88 #iâdeà
__O_TMPFILE


89 
	#__O_TMPFILE
 020000000

	)

93 
	#O_TMPFILE
 (
__O_TMPFILE
 | 
O_DIRECTORY
)

	)

94 
	#O_TMPFILE_MASK
 (
__O_TMPFILE
 | 
O_DIRECTORY
 | 
O_CREAT
)

	)

96 #iâdeà
O_NDELAY


97 
	#O_NDELAY
 
O_NONBLOCK


	)

100 
	#F_DUPFD
 0

	)

101 
	#F_GETFD
 1

	)

102 
	#F_SETFD
 2

	)

103 
	#F_GETFL
 3

	)

104 
	#F_SETFL
 4

	)

105 #iâdeà
F_GETLK


106 
	#F_GETLK
 5

	)

107 
	#F_SETLK
 6

	)

108 
	#F_SETLKW
 7

	)

110 #iâdeà
F_SETOWN


111 
	#F_SETOWN
 8

	)

112 
	#F_GETOWN
 9

	)

114 #iâdeà
F_SETSIG


115 
	#F_SETSIG
 10

	)

116 
	#F_GETSIG
 11

	)

119 #iâdeà
CONFIG_64BIT


120 #iâdeà
F_GETLK64


121 
	#F_GETLK64
 12

	)

122 
	#F_SETLK64
 13

	)

123 
	#F_SETLKW64
 14

	)

127 #iâdeà
F_SETOWN_EX


128 
	#F_SETOWN_EX
 15

	)

129 
	#F_GETOWN_EX
 16

	)

132 #iâdeà
F_GETOWNER_UIDS


133 
	#F_GETOWNER_UIDS
 17

	)

148 
	#F_OFD_GETLK
 36

	)

149 
	#F_OFD_SETLK
 37

	)

150 
	#F_OFD_SETLKW
 38

	)

152 
	#F_OWNER_TID
 0

	)

153 
	#F_OWNER_PID
 1

	)

154 
	#F_OWNER_PGRP
 2

	)

156 
	sf_owÃr_ex
 {

157 
	mty³
;

158 
__k”Ãl_pid_t
 
	mpid
;

162 
	#FD_CLOEXEC
 1

	)

165 #iâdeà
F_RDLCK


166 
	#F_RDLCK
 0

	)

167 
	#F_WRLCK
 1

	)

168 
	#F_UNLCK
 2

	)

172 #iâdeà
F_EXLCK


173 
	#F_EXLCK
 4

	)

174 
	#F_SHLCK
 8

	)

178 
	#LOCK_SH
 1

	)

179 
	#LOCK_EX
 2

	)

180 
	#LOCK_NB
 4

	)

182 
	#LOCK_UN
 8

	)

184 
	#LOCK_MAND
 32

	)

185 
	#LOCK_READ
 64

	)

186 
	#LOCK_WRITE
 128

	)

187 
	#LOCK_RW
 192

	)

189 
	#F_LINUX_SPECIFIC_BASE
 1024

	)

191 #iâdeà
HAVE_ARCH_STRUCT_FLOCK


192 #iâdeà
__ARCH_FLOCK_PAD


193 
	#__ARCH_FLOCK_PAD


	)

196 
	sæock
 {

197 
	ml_ty³
;

198 
	ml_wh’û
;

199 
__k”Ãl_off_t
 
	ml_¡¬t
;

200 
__k”Ãl_off_t
 
	ml_Ën
;

201 
__k”Ãl_pid_t
 
	ml_pid
;

202 
	m__ARCH_FLOCK_PAD


206 #iâdeà
HAVE_ARCH_STRUCT_FLOCK64


207 #iâdeà
__ARCH_FLOCK64_PAD


208 
	#__ARCH_FLOCK64_PAD


	)

211 
	sæock64
 {

212 
	ml_ty³
;

213 
	ml_wh’û
;

214 
__k”Ãl_loff_t
 
	ml_¡¬t
;

215 
__k”Ãl_loff_t
 
	ml_Ën
;

216 
__k”Ãl_pid_t
 
	ml_pid
;

217 
	m__ARCH_FLOCK64_PAD


	@/usr/include/asm-generic/types.h

2 #iâdeà
_ASM_GENERIC_TYPES_H


3 
	#_ASM_GENERIC_TYPES_H


	)

7 
	~<asm-g’”ic/št-Î64.h
>

	@/usr/include/asm/ioctl.h

1 
	~<asm-g’”ic/ioùl.h
>

	@/usr/include/asm/posix_types.h

2 #ifdeà
__i386__


3 
	~<asm/posix_ty³s_32.h
>

4 #–ià
defšed
(
__ILP32__
)

5 
	~<asm/posix_ty³s_x32.h
>

7 
	~<asm/posix_ty³s_64.h
>

	@/usr/include/bits/libc-header-start.h

27 #iâdeà
__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


31 #undeà
__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


33 
	~<ã©u»s.h
>

37 #undeà
__GLIBC_USE_LIB_EXT2


38 #ià(
defšed
 
__USE_GNU
 \

39 || (
defšed
 
	g__STDC_WANT_LIB_EXT2__
 && __STDC_WANT_LIB_EXT2__ > 0))

40 
	#__GLIBC_USE_LIB_EXT2
 1

	)

42 
	#__GLIBC_USE_LIB_EXT2
 0

	)

47 #undeà
__GLIBC_USE_IEC_60559_BFP_EXT


48 #ià
defšed
 
__USE_GNU
 || defšed 
__STDC_WANT_IEC_60559_BFP_EXT__


49 
	#__GLIBC_USE_IEC_60559_BFP_EXT
 1

	)

51 
	#__GLIBC_USE_IEC_60559_BFP_EXT
 0

	)

56 #undeà
__GLIBC_USE_IEC_60559_FUNCS_EXT


57 #ià
defšed
 
__USE_GNU
 || defšed 
__STDC_WANT_IEC_60559_FUNCS_EXT__


58 
	#__GLIBC_USE_IEC_60559_FUNCS_EXT
 1

	)

60 
	#__GLIBC_USE_IEC_60559_FUNCS_EXT
 0

	)

65 #undeà
__GLIBC_USE_IEC_60559_TYPES_EXT


66 #ià
defšed
 
__USE_GNU
 || defšed 
__STDC_WANT_IEC_60559_TYPES_EXT__


67 
	#__GLIBC_USE_IEC_60559_TYPES_EXT
 1

	)

69 
	#__GLIBC_USE_IEC_60559_TYPES_EXT
 0

	)

	@/usr/include/bits/string_fortified.h

18 #iâdeà
_BITS_STRING_FORTIFIED_H


19 
	#_BITS_STRING_FORTIFIED_H
 1

	)

21 #iâdeà
_STRING_H


25 #ià!
__GNUC_PREREQ
 (5,0)

26 
__w¬ndeş
 (
__w¬n_mem£t_z”o_Ën
,

30 
__fÜtify_funùiÚ
 *

31 
__NTH
 (
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

32 
size_t
 
__Ën
))

34  
	`__butš___memıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

35 
	}
}

37 
__fÜtify_funùiÚ
 *

38 
__NTH
 (
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__Ën
))

40  
	`__butš___memmove_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

41 
	}
}

43 #ifdeà
__USE_GNU


44 
__fÜtify_funùiÚ
 *

45 
__NTH
 (
	$mempıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

46 
size_t
 
__Ën
))

48  
	`__butš___mempıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

49 
	}
}

58 
__fÜtify_funùiÚ
 *

59 
__NTH
 (
	$mem£t
 (*
__de¡
, 
__ch
, 
size_t
 
__Ën
))

63 #ià!
	`__GNUC_PREREQ
 (5,0)

64 ià(
	`__butš_cÚ¡ªt_p
 (
__Ën
) && __len == 0

65 && (!
	`__butš_cÚ¡ªt_p
 (
__ch
) || __ch != 0))

67 
	`__w¬n_mem£t_z”o_Ën
 ();

68  
__de¡
;

71  
	`__butš___mem£t_chk
 (
__de¡
, 
__ch
, 
__Ën
, 
	`__bos0
 (__dest));

72 
	}
}

74 #ifdeà
__USE_MISC


75 
	~<b™s/¡ršgs_fÜtif›d.h
>

77 
	$__ex¶ic™_bz”o_chk
 (*
__de¡
, 
size_t
 
__Ën
, size_ˆ
__de¡Ën
)

78 
__THROW
 
	`__nÚnuÎ
 ((1));

80 
__fÜtify_funùiÚ
 

81 
	`__NTH
 (
	$ex¶ic™_bz”o
 (*
__de¡
, 
size_t
 
__Ën
))

83 
	`__ex¶ic™_bz”o_chk
 (
__de¡
, 
__Ën
, 
	`__bos0
 (__dest));

84 
	}
}

87 
__fÜtify_funùiÚ
 *

88 
__NTH
 (
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
))

90  
	`__butš___¡rıy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

91 
	}
}

93 #ifdeà
__USE_GNU


94 
__fÜtify_funùiÚ
 *

95 
__NTH
 (
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
))

97  
	`__butš___¡pıy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

98 
	}
}

102 
__fÜtify_funùiÚ
 *

103 
__NTH
 (
	$¡ºıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

104 
size_t
 
__Ën
))

106  
	`__butš___¡ºıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dest));

107 
	}
}

110 *
	$__¡²ıy_chk
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

111 
size_t
 
__de¡Ën
è
__THROW
;

112 *
	`__REDIRECT_NTH
 (
__¡²ıy_®Ÿs
, (*
__de¡
, cÚ¡ *
__¤c
,

113 
size_t
 
__n
), 
¡²ıy
);

115 
__fÜtify_funùiÚ
 *

116 
	`__NTH
 (
	$¡²ıy
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
))

118 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1

119 && (!
	`__butš_cÚ¡ªt_p
 (
__n
è|| __À> 
	`__bos
 (
__de¡
)))

120  
	`__¡²ıy_chk
 (
__de¡
, 
__¤c
, 
__n
, 
	`__bos
 (__dest));

121  
	`__¡²ıy_®Ÿs
 (
__de¡
, 
__¤c
, 
__n
);

122 
	}
}

125 
__fÜtify_funùiÚ
 *

126 
__NTH
 (
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
))

128  
	`__butš___¡rÿt_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

129 
	}
}

132 
__fÜtify_funùiÚ
 *

133 
__NTH
 (
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

134 
size_t
 
__Ën
))

136  
	`__butš___¡ºÿt_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dest));

137 
	}
}

	@/usr/include/bits/types/locale_t.h

19 #iâdeà
_BITS_TYPES_LOCALE_T_H


20 
	#_BITS_TYPES_LOCALE_T_H
 1

	)

22 
	~<b™s/ty³s/__loÿË_t.h
>

24 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/linux/stddef.h

4 #iâdeà
__®ways_šlše


5 
	#__®ways_šlše
 
__šlše__


	)

	@/usr/include/linux/swab.h

2 #iâdeà
_LINUX_SWAB_H


3 
	#_LINUX_SWAB_H


	)

5 
	~<lšux/ty³s.h
>

7 
	~<asm/swab.h
>

13 
	#___cÚ¡ªt_swab16
(
x
è((
__u16
)( \

14 (((
__u16
)(
x
) & (__u16)0x00ffU) << 8) | \

15 (((
__u16
)(
x
è& (__u16)0xff00Uè>> 8)))

	)

17 
	#___cÚ¡ªt_swab32
(
x
è((
__u32
)( \

18 (((
__u32
)(
x
) & (__u32)0x000000ffUL) << 24) | \

19 (((
__u32
)(
x
) & (__u32)0x0000ff00UL) << 8) | \

20 (((
__u32
)(
x
) & (__u32)0x00ff0000UL) >> 8) | \

21 (((
__u32
)(
x
è& (__u32)0xff000000ULè>> 24)))

	)

23 
	#___cÚ¡ªt_swab64
(
x
è((
__u64
)( \

24 (((
__u64
)(
x
) & (__u64)0x00000000000000ffULL) << 56) | \

25 (((
__u64
)(
x
) & (__u64)0x000000000000ff00ULL) << 40) | \

26 (((
__u64
)(
x
) & (__u64)0x0000000000ff0000ULL) << 24) | \

27 (((
__u64
)(
x
) & (__u64)0x00000000ff000000ULL) << 8) | \

28 (((
__u64
)(
x
) & (__u64)0x000000ff00000000ULL) >> 8) | \

29 (((
__u64
)(
x
) & (__u64)0x0000ff0000000000ULL) >> 24) | \

30 (((
__u64
)(
x
) & (__u64)0x00ff000000000000ULL) >> 40) | \

31 (((
__u64
)(
x
è& (__u64)0xff00000000000000ULLè>> 56)))

	)

33 
	#___cÚ¡ªt_swahw32
(
x
è((
__u32
)( \

34 (((
__u32
)(
x
) & (__u32)0x0000ffffUL) << 16) | \

35 (((
__u32
)(
x
è& (__u32)0xffff0000ULè>> 16)))

	)

37 
	#___cÚ¡ªt_swahb32
(
x
è((
__u32
)( \

38 (((
__u32
)(
x
) & (__u32)0x00ff00ffUL) << 8) | \

39 (((
__u32
)(
x
è& (__u32)0xff00ff00ULè>> 8)))

	)

47 
__šlše__
 
__u16
 
	$__fswab16
(
__u16
 
v®
)

49 #ià
	`defšed
 (
__¬ch_swab16
)

50  
	`__¬ch_swab16
(
v®
);

52  
	`___cÚ¡ªt_swab16
(
v®
);

54 
	}
}

56 
__šlše__
 
__u32
 
	$__fswab32
(
__u32
 
v®
)

58 #ià
	`defšed
(
__¬ch_swab32
)

59  
	`__¬ch_swab32
(
v®
);

61  
	`___cÚ¡ªt_swab32
(
v®
);

63 
	}
}

65 
__šlše__
 
__u64
 
	$__fswab64
(
__u64
 
v®
)

67 #ià
	`defšed
 (
__¬ch_swab64
)

68  
	`__¬ch_swab64
(
v®
);

69 #–ià
	`defšed
(
__SWAB_64_THRU_32__
)

70 
__u32
 
h
 = 
v®
 >> 32;

71 
__u32
 
l
 = 
v®
 & ((1ULL << 32) - 1);

72  (((
__u64
)
	`__fswab32
(
l
)è<< 32è| ((__u64)(__fswab32(
h
)));

74  
	`___cÚ¡ªt_swab64
(
v®
);

76 
	}
}

78 
__šlše__
 
__u32
 
	$__fswahw32
(
__u32
 
v®
)

80 #ifdeà
__¬ch_swahw32


81  
	`__¬ch_swahw32
(
v®
);

83  
	`___cÚ¡ªt_swahw32
(
v®
);

85 
	}
}

87 
__šlše__
 
__u32
 
	$__fswahb32
(
__u32
 
v®
)

89 #ifdeà
__¬ch_swahb32


90  
	`__¬ch_swahb32
(
v®
);

92  
	`___cÚ¡ªt_swahb32
(
v®
);

94 
	}
}

100 #ifdeà
__HAVE_BUILTIN_BSWAP16__


101 
	#__swab16
(
x
è(
__u16
)
	`__butš_bsw­16
((__u16)(x))

	)

103 
	#__swab16
(
x
) \

104 (
	`__butš_cÚ¡ªt_p
((
__u16
)(
x
)) ? \

105 
	`___cÚ¡ªt_swab16
(
x
) : \

106 
	`__fswab16
(
x
))

	)

113 #ifdeà
__HAVE_BUILTIN_BSWAP32__


114 
	#__swab32
(
x
è(
__u32
)
	`__butš_bsw­32
((__u32)(x))

	)

116 
	#__swab32
(
x
) \

117 (
	`__butš_cÚ¡ªt_p
((
__u32
)(
x
)) ? \

118 
	`___cÚ¡ªt_swab32
(
x
) : \

119 
	`__fswab32
(
x
))

	)

126 #ifdeà
__HAVE_BUILTIN_BSWAP64__


127 
	#__swab64
(
x
è(
__u64
)
	`__butš_bsw­64
((__u64)(x))

	)

129 
	#__swab64
(
x
) \

130 (
	`__butš_cÚ¡ªt_p
((
__u64
)(
x
)) ? \

131 
	`___cÚ¡ªt_swab64
(
x
) : \

132 
	`__fswab64
(
x
))

	)

141 
	#__swahw32
(
x
) \

142 (
	`__butš_cÚ¡ªt_p
((
__u32
)(
x
)) ? \

143 
	`___cÚ¡ªt_swahw32
(
x
) : \

144 
	`__fswahw32
(
x
))

	)

152 
	#__swahb32
(
x
) \

153 (
	`__butš_cÚ¡ªt_p
((
__u32
)(
x
)) ? \

154 
	`___cÚ¡ªt_swahb32
(
x
) : \

155 
	`__fswahb32
(
x
))

	)

161 
__®ways_šlše
 
__u16
 
	$__swab16p
(cÚ¡ 
__u16
 *
p
)

163 #ifdeà
__¬ch_swab16p


164  
	`__¬ch_swab16p
(
p
);

166  
	`__swab16
(*
p
);

168 
	}
}

174 
__®ways_šlše
 
__u32
 
	$__swab32p
(cÚ¡ 
__u32
 *
p
)

176 #ifdeà
__¬ch_swab32p


177  
	`__¬ch_swab32p
(
p
);

179  
	`__swab32
(*
p
);

181 
	}
}

187 
__®ways_šlše
 
__u64
 
	$__swab64p
(cÚ¡ 
__u64
 *
p
)

189 #ifdeà
__¬ch_swab64p


190  
	`__¬ch_swab64p
(
p
);

192  
	`__swab64
(*
p
);

194 
	}
}

202 
__šlše__
 
__u32
 
	$__swahw32p
(cÚ¡ 
__u32
 *
p
)

204 #ifdeà
__¬ch_swahw32p


205  
	`__¬ch_swahw32p
(
p
);

207  
	`__swahw32
(*
p
);

209 
	}
}

217 
__šlše__
 
__u32
 
	$__swahb32p
(cÚ¡ 
__u32
 *
p
)

219 #ifdeà
__¬ch_swahb32p


220  
	`__¬ch_swahb32p
(
p
);

222  
	`__swahb32
(*
p
);

224 
	}
}

230 
__šlše__
 
	$__swab16s
(
__u16
 *
p
)

232 #ifdeà
__¬ch_swab16s


233 
	`__¬ch_swab16s
(
p
);

235 *
p
 = 
	`__swab16p
(p);

237 
	}
}

242 
__®ways_šlše
 
	$__swab32s
(
__u32
 *
p
)

244 #ifdeà
__¬ch_swab32s


245 
	`__¬ch_swab32s
(
p
);

247 *
p
 = 
	`__swab32p
(p);

249 
	}
}

255 
__®ways_šlše
 
	$__swab64s
(
__u64
 *
p
)

257 #ifdeà
__¬ch_swab64s


258 
	`__¬ch_swab64s
(
p
);

260 *
p
 = 
	`__swab64p
(p);

262 
	}
}

270 
__šlše__
 
	$__swahw32s
(
__u32
 *
p
)

272 #ifdeà
__¬ch_swahw32s


273 
	`__¬ch_swahw32s
(
p
);

275 *
p
 = 
	`__swahw32p
(p);

277 
	}
}

285 
__šlše__
 
	$__swahb32s
(
__u32
 *
p
)

287 #ifdeà
__¬ch_swahb32s


288 
	`__¬ch_swahb32s
(
p
);

290 *
p
 = 
	`__swahb32p
(p);

292 
	}
}

	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	#__Ãed_size_t


	)

23 
	~<¡ddef.h
>

26 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


34 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

38 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

39 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

42 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

45 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`šdex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

50 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

53 #ià
defšed
 
__OPTIMIZE__


54 
__ex‹º_®ways_šlše
 *

55 
	`šdex
 (*
__s
, 
__c
è
__THROW


57  
	`__butš_šdex
 (
__s
, 
__c
);

60 
__ex‹º_®ways_šlše
 const *

61 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


63  
	`__butš_šdex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`ršdex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ià
defšed
 
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`ršdex
 (*
__s
, 
__c
è
__THROW


85  
	`__butš_ršdex
 (
__s
, 
__c
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


91  
	`__butš_ršdex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
è
__THROW
 
__©Œibu‹_cÚ¡__
;

109 #ifdef 
__USE_MISC


110 
	$ff¦
 (
__l
è
__THROW
 
__©Œibu‹_cÚ¡__
;

111 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

112 
__THROW
 
__©Œibu‹_cÚ¡__
;

116 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

117 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

120 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<b™s/ty³s/loÿË_t.h
>

128 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__loc
)

129 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

133 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

134 
size_t
 
__n
, 
loÿË_t
 
__loc
)

135 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

138 
__END_DECLS


140 #ià
	`__GNUC_PREREQ
 (3,4è&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
defšed
 
__fÜtify_funùiÚ


143 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


144 
	~<b™s/¡ršgs_fÜtif›d.h
>

	@/usr/include/asm-generic/errno-base.h

2 #iâdeà
_ASM_GENERIC_ERRNO_BASE_H


3 
	#_ASM_GENERIC_ERRNO_BASE_H


	)

5 
	#EPERM
 1

	)

6 
	#ENOENT
 2

	)

7 
	#ESRCH
 3

	)

8 
	#EINTR
 4

	)

9 
	#EIO
 5

	)

10 
	#ENXIO
 6

	)

11 
	#E2BIG
 7

	)

12 
	#ENOEXEC
 8

	)

13 
	#EBADF
 9

	)

14 
	#ECHILD
 10

	)

15 
	#EAGAIN
 11

	)

16 
	#ENOMEM
 12

	)

17 
	#EACCES
 13

	)

18 
	#EFAULT
 14

	)

19 
	#ENOTBLK
 15

	)

20 
	#EBUSY
 16

	)

21 
	#EEXIST
 17

	)

22 
	#EXDEV
 18

	)

23 
	#ENODEV
 19

	)

24 
	#ENOTDIR
 20

	)

25 
	#EISDIR
 21

	)

26 
	#EINVAL
 22

	)

27 
	#ENFILE
 23

	)

28 
	#EMFILE
 24

	)

29 
	#ENOTTY
 25

	)

30 
	#ETXTBSY
 26

	)

31 
	#EFBIG
 27

	)

32 
	#ENOSPC
 28

	)

33 
	#ESPIPE
 29

	)

34 
	#EROFS
 30

	)

35 
	#EMLINK
 31

	)

36 
	#EPIPE
 32

	)

37 
	#EDOM
 33

	)

38 
	#ERANGE
 34

	)

	@/usr/include/asm-generic/int-ll64.h

9 #iâdeà
_ASM_GENERIC_INT_LL64_H


10 
	#_ASM_GENERIC_INT_LL64_H


	)

12 
	~<asm/b™¥”lÚg.h
>

14 #iâdeà
__ASSEMBLY__


20 
__sigÃd__
 
	t__s8
;

21 
	t__u8
;

23 
__sigÃd__
 
	t__s16
;

24 
	t__u16
;

26 
__sigÃd__
 
	t__s32
;

27 
	t__u32
;

29 #ifdeà
__GNUC__


30 
__ex‹nsiÚ__
 
__sigÃd__
 
	t__s64
;

31 
__ex‹nsiÚ__
 
	t__u64
;

33 
__sigÃd__
 
	t__s64
;

34 
	t__u64
;

	@/usr/include/asm-generic/ioctl.h

2 #iâdeà
_ASM_GENERIC_IOCTL_H


3 
	#_ASM_GENERIC_IOCTL_H


	)

23 
	#_IOC_NRBITS
 8

	)

24 
	#_IOC_TYPEBITS
 8

	)

31 #iâdeà
_IOC_SIZEBITS


32 
	#_IOC_SIZEBITS
 14

	)

35 #iâdeà
_IOC_DIRBITS


36 
	#_IOC_DIRBITS
 2

	)

39 
	#_IOC_NRMASK
 ((1 << 
_IOC_NRBITS
)-1)

	)

40 
	#_IOC_TYPEMASK
 ((1 << 
_IOC_TYPEBITS
)-1)

	)

41 
	#_IOC_SIZEMASK
 ((1 << 
_IOC_SIZEBITS
)-1)

	)

42 
	#_IOC_DIRMASK
 ((1 << 
_IOC_DIRBITS
)-1)

	)

44 
	#_IOC_NRSHIFT
 0

	)

45 
	#_IOC_TYPESHIFT
 (
_IOC_NRSHIFT
+
_IOC_NRBITS
)

	)

46 
	#_IOC_SIZESHIFT
 (
_IOC_TYPESHIFT
+
_IOC_TYPEBITS
)

	)

47 
	#_IOC_DIRSHIFT
 (
_IOC_SIZESHIFT
+
_IOC_SIZEBITS
)

	)

57 #iâdeà
_IOC_NONE


58 
	#_IOC_NONE
 0U

	)

61 #iâdeà
_IOC_WRITE


62 
	#_IOC_WRITE
 1U

	)

65 #iâdeà
_IOC_READ


66 
	#_IOC_READ
 2U

	)

69 
	#_IOC
(
dœ
,
ty³
,
Ä
,
size
) \

70 (((
dœ
è<< 
_IOC_DIRSHIFT
) | \

71 ((
ty³
è<< 
_IOC_TYPESHIFT
) | \

72 ((
Ä
è<< 
_IOC_NRSHIFT
) | \

73 ((
size
è<< 
_IOC_SIZESHIFT
))

	)

75 
	#_IOC_TYPECHECK
(
t
è(Ñ))

	)

83 
	#_IO
(
ty³
,
Ä
è
	`_IOC
(
_IOC_NONE
,Ñy³),Òr),0)

	)

84 
	#_IOR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

85 
	#_IOW
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

86 
	#_IOWR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

87 
	#_IOR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(size))

	)

88 
	#_IOW_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(size))

	)

89 
	#_IOWR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(size))

	)

92 
	#_IOC_DIR
(
Ä
è((Òrè>> 
_IOC_DIRSHIFT
è& 
_IOC_DIRMASK
)

	)

93 
	#_IOC_TYPE
(
Ä
è((Òrè>> 
_IOC_TYPESHIFT
è& 
_IOC_TYPEMASK
)

	)

94 
	#_IOC_NR
(
Ä
è((Òrè>> 
_IOC_NRSHIFT
è& 
_IOC_NRMASK
)

	)

95 
	#_IOC_SIZE
(
Ä
è((Òrè>> 
_IOC_SIZESHIFT
è& 
_IOC_SIZEMASK
)

	)

99 
	#IOC_IN
 (
_IOC_WRITE
 << 
_IOC_DIRSHIFT
)

	)

100 
	#IOC_OUT
 (
_IOC_READ
 << 
_IOC_DIRSHIFT
)

	)

101 
	#IOC_INOUT
 ((
_IOC_WRITE
|
_IOC_READ
è<< 
_IOC_DIRSHIFT
)

	)

102 
	#IOCSIZE_MASK
 (
_IOC_SIZEMASK
 << 
_IOC_SIZESHIFT
)

	)

103 
	#IOCSIZE_SHIFT
 (
_IOC_SIZESHIFT
)

	)

	@/usr/include/asm/posix_types_32.h

2 #iâdeà
_ASM_X86_POSIX_TYPES_32_H


3 
	#_ASM_X86_POSIX_TYPES_32_H


	)

11 
	t__k”Ãl_mode_t
;

12 
	#__k”Ãl_mode_t
 
__k”Ãl_mode_t


	)

14 
	t__k”Ãl_c_pid_t
;

15 
	#__k”Ãl_c_pid_t
 
__k”Ãl_c_pid_t


	)

17 
	t__k”Ãl_uid_t
;

18 
	t__k”Ãl_gid_t
;

19 
	#__k”Ãl_uid_t
 
__k”Ãl_uid_t


	)

21 
	t__k”Ãl_Şd_dev_t
;

22 
	#__k”Ãl_Şd_dev_t
 
__k”Ãl_Şd_dev_t


	)

24 
	~<asm-g’”ic/posix_ty³s.h
>

	@/usr/include/asm/posix_types_64.h

2 #iâdeà
_ASM_X86_POSIX_TYPES_64_H


3 
	#_ASM_X86_POSIX_TYPES_64_H


	)

11 
	t__k”Ãl_Şd_uid_t
;

12 
	t__k”Ãl_Şd_gid_t
;

13 
	#__k”Ãl_Şd_uid_t
 
__k”Ãl_Şd_uid_t


	)

15 
	t__k”Ãl_Şd_dev_t
;

16 
	#__k”Ãl_Şd_dev_t
 
__k”Ãl_Şd_dev_t


	)

18 
	~<asm-g’”ic/posix_ty³s.h
>

	@/usr/include/asm/posix_types_x32.h

2 #iâdeà
_ASM_X86_POSIX_TYPES_X32_H


3 
	#_ASM_X86_POSIX_TYPES_X32_H


	)

14 
	t__k”Ãl_lÚg_t
;

15 
	t__k”Ãl_ulÚg_t
;

16 
	#__k”Ãl_lÚg_t
 
__k”Ãl_lÚg_t


	)

18 
	~<asm/posix_ty³s_64.h
>

	@/usr/include/asm/swab.h

2 #iâdeà
_ASM_X86_SWAB_H


3 
	#_ASM_X86_SWAB_H


	)

5 
	~<lšux/ty³s.h
>

8 
__šlše__
 
__u32
 
	$__¬ch_swab32
(
__u32
 
v®
)

10 
	`__asm__
("bsw­È%0" : "ô" (
v®
) : "0" (val));

11  
v®
;

12 
	}
}

13 
	#__¬ch_swab32
 
__¬ch_swab32


	)

15 
__šlše__
 
__u64
 
	$__¬ch_swab64
(
__u64
 
v®
)

17 #ifdeà
__i386__


20 
__u32
 
a
;

21 
__u32
 
b
;

22 } 
s
;

23 
__u64
 
u
;

24 } 
v
;

25 
v
.
u
 = 
v®
;

26 
	`__asm__
("bswapl %0 ; bswapl %1 ; xchgl %0,%1"

27 : "ô" (
v
.
s
.
a
), "ô" (v.s.
b
)

28 : "0" (
v
.
s
.
a
), "1" (v.s.
b
));

29  
v
.
u
;

31 
	`__asm__
("bsw­q %0" : "ô" (
v®
) : "0" (val));

32  
v®
;

34 
	}
}

35 
	#__¬ch_swab64
 
__¬ch_swab64


	)

	@/usr/include/bits/strings_fortified.h

19 #iâdeà
__STRINGS_FORTIFIED


20 
	#__STRINGS_FORTIFIED
 1

	)

22 
__fÜtify_funùiÚ
 

23 
__NTH
 (
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__Ën
))

25 (è
	`__butš___memmove_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

26 
	}
}

28 
__fÜtify_funùiÚ
 

29 
__NTH
 (
	$bz”o
 (*
__de¡
, 
size_t
 
__Ën
))

31 (è
	`__butš___mem£t_chk
 (
__de¡
, '\0', 
__Ën
, 
	`__bos0
 (__dest));

32 
	}
}

	@/usr/include/bits/types/__locale_t.h

20 #iâdeà
_BITS_TYPES___LOCALE_T_H


21 
	#_BITS_TYPES___LOCALE_T_H
 1

	)

28 
	s__loÿË_¡ruù


31 
__loÿË_d©a
 *
	m__loÿËs
[13];

34 cÚ¡ *
	m__ùy³_b
;

35 cÚ¡ *
	m__ùy³_tŞow”
;

36 cÚ¡ *
	m__ùy³_touµ”
;

39 cÚ¡ *
	m__Çmes
[13];

42 
__loÿË_¡ruù
 *
	t__loÿË_t
;

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

119 #undeà
__USE_ISOC11


120 #undeà
__USE_ISOC99


121 #undeà
__USE_ISOC95


122 #undeà
__USE_ISOCXX11


123 #undeà
__USE_POSIX


124 #undeà
__USE_POSIX2


125 #undeà
__USE_POSIX199309


126 #undeà
__USE_POSIX199506


127 #undeà
__USE_XOPEN


128 #undeà
__USE_XOPEN_EXTENDED


129 #undeà
__USE_UNIX98


130 #undeà
__USE_XOPEN2K


131 #undeà
__USE_XOPEN2KXSI


132 #undeà
__USE_XOPEN2K8


133 #undeà
__USE_XOPEN2K8XSI


134 #undeà
__USE_LARGEFILE


135 #undeà
__USE_LARGEFILE64


136 #undeà
__USE_FILE_OFFSET64


137 #undeà
__USE_MISC


138 #undeà
__USE_ATFILE


139 #undeà
__USE_GNU


140 #undeà
__USE_FORTIFY_LEVEL


141 #undeà
__KERNEL_STRICT_NAMES


142 #undeà
__GLIBC_USE_DEPRECATED_GETS


143 #undeà
__GLIBC_USE_DEPRECATED_SCANF


147 #iâdeà
_LOOSE_KERNEL_NAMES


148 
	#__KERNEL_STRICT_NAMES


	)

158 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


159 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

160 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

162 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

169 #ià
defšed
 
__şªg_majÜ__
 && defšed 
__şªg_mšÜ__


170 
	#__glibc_şªg_´”eq
(
maj
, 
mš
) \

171 ((
__şªg_majÜ__
 << 16è+ 
__şªg_mšÜ__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

173 
	#__glibc_şªg_´”eq
(
maj
, 
mš
è0

	)

177 
	#__GLIBC_USE
(
F
è
__GLIBC_USE_
 ## 
	)
F

183 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

184 && !
defšed
 
	g_DEFAULT_SOURCE


186 #undeà
_DEFAULT_SOURCE


187 
	#_DEFAULT_SOURCE
 1

	)

191 #ifdeà
_GNU_SOURCE


192 #undeà
_ISOC95_SOURCE


193 
	#_ISOC95_SOURCE
 1

	)

194 #undeà
_ISOC99_SOURCE


195 
	#_ISOC99_SOURCE
 1

	)

196 #undeà
_ISOC11_SOURCE


197 
	#_ISOC11_SOURCE
 1

	)

198 #undeà
_POSIX_SOURCE


199 
	#_POSIX_SOURCE
 1

	)

200 #undeà
_POSIX_C_SOURCE


201 
	#_POSIX_C_SOURCE
 200809L

	)

202 #undeà
_XOPEN_SOURCE


203 
	#_XOPEN_SOURCE
 700

	)

204 #undeà
_XOPEN_SOURCE_EXTENDED


205 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

206 #undeà
_LARGEFILE64_SOURCE


207 
	#_LARGEFILE64_SOURCE
 1

	)

208 #undeà
_DEFAULT_SOURCE


209 
	#_DEFAULT_SOURCE
 1

	)

210 #undeà
_ATFILE_SOURCE


211 
	#_ATFILE_SOURCE
 1

	)

216 #ià(
defšed
 
_DEFAULT_SOURCE
 \

217 || (!
defšed
 
	g__STRICT_ANSI__
 \

218 && !
defšed
 
	g_ISOC99_SOURCE
 && !defšed 
	g_ISOC11_SOURCE
 \

219 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

220 && !
defšed
 
	g_XOPEN_SOURCE
))

221 #undeà
_DEFAULT_SOURCE


222 
	#_DEFAULT_SOURCE
 1

	)

226 #ià(
defšed
 
_ISOC11_SOURCE
 \

227 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

228 
	#__USE_ISOC11
 1

	)

232 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

233 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

234 
	#__USE_ISOC99
 1

	)

238 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

239 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

240 
	#__USE_ISOC95
 1

	)

243 #ifdeà
__ılu¥lus


245 #ià
__ılu¥lus
 >= 201703L

246 
	#__USE_ISOC11
 1

	)

250 #ià
__ılu¥lus
 >ğ201103L || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__


251 
	#__USE_ISOCXX11
 1

	)

252 
	#__USE_ISOC99
 1

	)

259 #ifdeà
_DEFAULT_SOURCE


260 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


261 
	#__USE_POSIX_IMPLICITLY
 1

	)

263 #undeà
_POSIX_SOURCE


264 
	#_POSIX_SOURCE
 1

	)

265 #undeà
_POSIX_C_SOURCE


266 
	#_POSIX_C_SOURCE
 200809L

	)

269 #ià((!
defšed
 
__STRICT_ANSI__
 \

270 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

271 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

272 
	#_POSIX_SOURCE
 1

	)

273 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

274 
	#_POSIX_C_SOURCE
 2

	)

275 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

276 
	#_POSIX_C_SOURCE
 199506L

	)

277 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

278 
	#_POSIX_C_SOURCE
 200112L

	)

280 
	#_POSIX_C_SOURCE
 200809L

	)

282 
	#__USE_POSIX_IMPLICITLY
 1

	)

291 #ià((!
defšed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

292 && (
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE
))

293 
	#_POSIX_SOURCE
 1

	)

294 #undeà
_POSIX_C_SOURCE


295 
	#_POSIX_C_SOURCE
 199506L

	)

298 #ià(
defšed
 
_POSIX_SOURCE
 \

299 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

300 || 
defšed
 
_XOPEN_SOURCE
)

301 
	#__USE_POSIX
 1

	)

304 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


305 
	#__USE_POSIX2
 1

	)

308 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

309 
	#__USE_POSIX199309
 1

	)

312 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

313 
	#__USE_POSIX199506
 1

	)

316 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

317 
	#__USE_XOPEN2K
 1

	)

318 #undeà
__USE_ISOC95


319 
	#__USE_ISOC95
 1

	)

320 #undeà
__USE_ISOC99


321 
	#__USE_ISOC99
 1

	)

324 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

325 
	#__USE_XOPEN2K8
 1

	)

326 #undeà
_ATFILE_SOURCE


327 
	#_ATFILE_SOURCE
 1

	)

330 #ifdef 
_XOPEN_SOURCE


331 
	#__USE_XOPEN
 1

	)

332 #ià(
_XOPEN_SOURCE
 - 0) >= 500

333 
	#__USE_XOPEN_EXTENDED
 1

	)

334 
	#__USE_UNIX98
 1

	)

335 #undeà
_LARGEFILE_SOURCE


336 
	#_LARGEFILE_SOURCE
 1

	)

337 #ià(
_XOPEN_SOURCE
 - 0) >= 600

338 #ià(
_XOPEN_SOURCE
 - 0) >= 700

339 
	#__USE_XOPEN2K8
 1

	)

340 
	#__USE_XOPEN2K8XSI
 1

	)

342 
	#__USE_XOPEN2K
 1

	)

343 
	#__USE_XOPEN2KXSI
 1

	)

344 #undeà
__USE_ISOC95


345 
	#__USE_ISOC95
 1

	)

346 #undeà
__USE_ISOC99


347 
	#__USE_ISOC99
 1

	)

350 #ifdeà
_XOPEN_SOURCE_EXTENDED


351 
	#__USE_XOPEN_EXTENDED
 1

	)

356 #ifdeà
_LARGEFILE_SOURCE


357 
	#__USE_LARGEFILE
 1

	)

360 #ifdeà
_LARGEFILE64_SOURCE


361 
	#__USE_LARGEFILE64
 1

	)

364 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

365 
	#__USE_FILE_OFFSET64
 1

	)

368 #ià
defšed
 
_DEFAULT_SOURCE


369 
	#__USE_MISC
 1

	)

372 #ifdef 
_ATFILE_SOURCE


373 
	#__USE_ATFILE
 1

	)

376 #ifdef 
_GNU_SOURCE


377 
	#__USE_GNU
 1

	)

380 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0

381 #ià!
defšed
 
__OPTIMIZE__
 || __OPTIMIZE__ <= 0

382 #w¬nšg 
_FORTIFY_SOURCE
 
»quœes
 
compšg
 
w™h
 
İtimiz©iÚ
 (-
O
)

383 #–ià!
__GNUC_PREREQ
 (4, 1)

384 #w¬nšg 
_FORTIFY_SOURCE
 
»quœes
 
GCC
 4.1 
Ü
 
Ï‹r


385 #–ià
_FORTIFY_SOURCE
 > 1

386 
	#__USE_FORTIFY_LEVEL
 2

	)

388 
	#__USE_FORTIFY_LEVEL
 1

	)

391 #iâdeà
__USE_FORTIFY_LEVEL


392 
	#__USE_FORTIFY_LEVEL
 0

	)

399 #ià
defšed
 
__ılu¥lus
 ? __ılu¥lu >ğ201402L : defšed 
__USE_ISOC11


400 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

402 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

417 #ià
defšed
 
__USE_GNU
 && \

418 (
defšed
 
	g__ılu¥lus
 \

419 ? (
	g__ılu¥lus
 < 201103L && !
defšed
 
	g__GXX_EXPERIMENTAL_CXX0X__
) \

420 : (!
defšed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L))

421 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

423 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

428 
	~<¡dc-´edef.h
>

436 #undeà
__GNU_LIBRARY__


437 
	#__GNU_LIBRARY__
 6

	)

441 
	#__GLIBC__
 2

	)

442 
	#__GLIBC_MINOR__
 29

	)

444 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

445 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

448 #iâdeà
__ASSEMBLER__


449 #iâdeà
_SYS_CDEFS_H


450 
	~<sys/cdefs.h
>

455 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


456 
	#__USE_LARGEFILE
 1

	)

457 
	#__USE_LARGEFILE64
 1

	)

463 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

464 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

465 && 
defšed
 
	g__ex‹º_šlše


466 
	#__USE_EXTERN_INLINES
 1

	)

474 
	~<gnu/¡ubs.h
>

	@/usr/include/asm-generic/posix_types.h

2 #iâdeà
__ASM_GENERIC_POSIX_TYPES_H


3 
	#__ASM_GENERIC_POSIX_TYPES_H


	)

5 
	~<asm/b™¥”lÚg.h
>

14 #iâdeà
__k”Ãl_lÚg_t


15 
	t__k”Ãl_lÚg_t
;

16 
	t__k”Ãl_ulÚg_t
;

19 #iâdeà
__k”Ãl_šo_t


20 
__k”Ãl_ulÚg_t
 
	t__k”Ãl_šo_t
;

23 #iâdeà
__k”Ãl_mode_t


24 
	t__k”Ãl_mode_t
;

27 #iâdeà
__k”Ãl_pid_t


28 
	t__k”Ãl_pid_t
;

31 #iâdeà
__k”Ãl_c_pid_t


32 
	t__k”Ãl_c_pid_t
;

35 #iâdeà
__k”Ãl_uid_t


36 
	t__k”Ãl_uid_t
;

37 
	t__k”Ãl_gid_t
;

40 #iâdeà
__k”Ãl_su£cÚds_t


41 
__k”Ãl_lÚg_t
 
	t__k”Ãl_su£cÚds_t
;

44 #iâdeà
__k”Ãl_daddr_t


45 
	t__k”Ãl_daddr_t
;

48 #iâdeà
__k”Ãl_uid32_t


49 
	t__k”Ãl_uid32_t
;

50 
	t__k”Ãl_gid32_t
;

53 #iâdeà
__k”Ãl_Şd_uid_t


54 
__k”Ãl_uid_t
 
	t__k”Ãl_Şd_uid_t
;

55 
__k”Ãl_gid_t
 
	t__k”Ãl_Şd_gid_t
;

58 #iâdeà
__k”Ãl_Şd_dev_t


59 
	t__k”Ãl_Şd_dev_t
;

66 #iâdeà
__k”Ãl_size_t


67 #ià
__BITS_PER_LONG
 != 64

68 
	t__k”Ãl_size_t
;

69 
	t__k”Ãl_ssize_t
;

70 
	t__k”Ãl_±rdiff_t
;

72 
__k”Ãl_ulÚg_t
 
	t__k”Ãl_size_t
;

73 
__k”Ãl_lÚg_t
 
	t__k”Ãl_ssize_t
;

74 
__k”Ãl_lÚg_t
 
	t__k”Ãl_±rdiff_t
;

78 #iâdeà
__k”Ãl_fsid_t


80 
	mv®
[2];

81 } 
	t__k”Ãl_fsid_t
;

87 
__k”Ãl_lÚg_t
 
	t__k”Ãl_off_t
;

88 
	t__k”Ãl_loff_t
;

89 
__k”Ãl_lÚg_t
 
	t__k”Ãl_time_t
;

90 
	t__k”Ãl_time64_t
;

91 
__k”Ãl_lÚg_t
 
	t__k”Ãl_şock_t
;

92 
	t__k”Ãl_tim”_t
;

93 
	t__k”Ãl_şockid_t
;

94 * 
	t__k”Ãl_ÿddr_t
;

95 
	t__k”Ãl_uid16_t
;

96 
	t__k”Ãl_gid16_t
;

	@/usr/include/asm/bitsperlong.h

2 #iâdeà
__ASM_X86_BITSPERLONG_H


3 
	#__ASM_X86_BITSPERLONG_H


	)

5 #ià
defšed
(
__x86_64__
è&& !defšed(
__ILP32__
)

6 
	#__BITS_PER_LONG
 64

	)

8 
	#__BITS_PER_LONG
 32

	)

11 
	~<asm-g’”ic/b™¥”lÚg.h
>

	@/usr/include/gnu/stubs.h

6 #ià!
defšed
 
__x86_64__


7 
	~<gnu/¡ubs-32.h
>

9 #ià
defšed
 
__x86_64__
 && defšed 
__LP64__


10 
	~<gnu/¡ubs-64.h
>

12 #ià
defšed
 
__x86_64__
 && defšed 
__ILP32__


13 
	~<gnu/¡ubs-x32.h
>

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

	@/usr/include/sys/cdefs.h

18 #iâdef 
_SYS_CDEFS_H


19 
	#_SYS_CDEFS_H
 1

	)

22 #iâdeà
_FEATURES_H


23 
	~<ã©u»s.h
>

29 #ià
defšed
 
__GNUC__
 && !defšed 
__STDC__


34 #undeà
__P


35 #undeà
__PMT


37 #ifdeà
__GNUC__


41 #ià
__GNUC_PREREQ
 (4, 6è&& !
defšed
 
_LIBC


42 
	#__LEAF
 , 
__Ëaf__


	)

43 
	#__LEAF_ATTR
 
	`__©Œibu‹__
 ((
__Ëaf__
))

	)

45 
	#__LEAF


	)

46 
	#__LEAF_ATTR


	)

54 #ià!
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (3, 3)

55 
	#__THROW
 
	`__©Œibu‹__
 ((
__nÙhrow__
 
__LEAF
))

	)

56 
	#__THROWNL
 
	`__©Œibu‹__
 ((
__nÙhrow__
))

	)

57 
	#__NTH
(
fù
è
	`__©Œibu‹__
 ((
__nÙhrow__
 
__LEAF
)è
	)
fct

58 
	#__NTHNL
(
fù
è
	`__©Œibu‹__
 ((
__nÙhrow__
)è
	)
fct

60 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

61 
	#__THROW
 
	`throw
 ()

	)

62 
	#__THROWNL
 
	`throw
 ()

	)

63 
	#__NTH
(
fù
è
__LEAF_ATTR
 fù 
	`throw
 ()

	)

64 
	#__NTHNL
(
fù
èfù 
	`throw
 ()

	)

66 
	#__THROW


	)

67 
	#__THROWNL


	)

68 
	#__NTH
(
fù
è
	)
fct

69 
	#__NTHNL
(
fù
è
	)
fct

75 #ià(
defšed
 
__ılu¥lus
 \

76 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

77 
	#__šlše
 
šlše


	)

79 
	#__šlše


	)

82 
	#__THROW


	)

83 
	#__THROWNL


	)

84 
	#__NTH
(
fù
è
	)
fct

91 #ià
defšed
 
__şªg__
 && defšed 
__has_ex‹nsiÚ


92 
	#__glibc_şªg_has_ex‹nsiÚ
(
ext
è
	`__has_ex‹nsiÚ
 (ext)

	)

94 
	#__glibc_şªg_has_ex‹nsiÚ
(
ext
è0

	)

99 
	#__P
(
¬gs
è
	)
args

100 
	#__PMT
(
¬gs
è
	)
args

105 
	#__CONCAT
(
x
,
y
èx ## 
	)
y

106 
	#__STRING
(
x
è#x

	)

109 
	#__±r_t
 *

	)

113 #ifdef 
__ılu¥lus


114 
	#__BEGIN_DECLS
 "C" {

	)

115 
	#__END_DECLS
 }

	)

117 
	#__BEGIN_DECLS


	)

118 
	#__END_DECLS


	)

123 
	#__bos
(
±r
è
	`__butš_objeù_size
 (±r, 
__USE_FORTIFY_LEVEL
 > 1)

	)

124 
	#__bos0
(
±r
è
	`__butš_objeù_size
 (±r, 0)

	)

126 #ià
__GNUC_PREREQ
 (4,3)

127 
	#__w¬ndeş
(
Çme
, 
msg
) \

128 
	`Çme
 (è
	`__©Œibu‹__
((
	`__w¬nšg__
 (
msg
)))

	)

129 
	#__w¬Ç‰r
(
msg
è
	`__©Œibu‹__
((
	`__w¬nšg__
 (msg)))

	)

130 
	#__”rÜdeş
(
Çme
, 
msg
) \

131 
	`Çme
 (è
	`__©Œibu‹__
((
	`__”rÜ__
 (
msg
)))

	)

133 
	#__w¬ndeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

134 
	#__w¬Ç‰r
(
msg
)

	)

135 
	#__”rÜdeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

142 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

143 
	#__æex¬r
 []

	)

144 
	#__glibc_c99_æex¬r_avaabË
 1

	)

145 #–ià
__GNUC_PREREQ
 (2,97)

148 
	#__æex¬r
 []

	)

149 
	#__glibc_c99_æex¬r_avaabË
 1

	)

150 #–ià
defšed
 
__GNUC__


153 
	#__æex¬r
 [0]

	)

154 
	#__glibc_c99_æex¬r_avaabË
 1

	)

157 
	#__æex¬r
 [1]

	)

158 
	#__glibc_c99_æex¬r_avaabË
 0

	)

172 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

174 
	#__REDIRECT
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

175 #ifdeà
__ılu¥lus


176 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

177 
Çme
 
´Ùo
 
__THROW
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

178 
	#__REDIRECT_NTHNL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

179 
Çme
 
´Ùo
 
__THROWNL
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

181 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

182 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROW


	)

183 
	#__REDIRECT_NTHNL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

184 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROWNL


	)

186 
	#__ASMNAME
(
úame
è
	`__ASMNAME2
 (
__USER_LABEL_PREFIX__
, cÇme)

	)

187 
	#__ASMNAME2
(
´efix
, 
úame
è
	`__STRING
 (´efixè
	)
cname

200 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

201 
	#__©Œibu‹__
(
xyz
è

	)

207 #ià
__GNUC_PREREQ
 (2,96)

208 
	#__©Œibu‹_m®loc__
 
	`__©Œibu‹__
 ((
__m®loc__
))

	)

210 
	#__©Œibu‹_m®loc__


	)

215 #ià
__GNUC_PREREQ
 (4, 3)

216 
	#__©Œibu‹_®loc_size__
(
·¿ms
) \

217 
	`__©Œibu‹__
 ((
__®loc_size__
 
·¿ms
))

	)

219 
	#__©Œibu‹_®loc_size__
(
·¿ms
è

	)

225 #ià
__GNUC_PREREQ
 (2,96)

226 
	#__©Œibu‹_pu»__
 
	`__©Œibu‹__
 ((
__pu»__
))

	)

228 
	#__©Œibu‹_pu»__


	)

232 #ià
__GNUC_PREREQ
 (2,5)

233 
	#__©Œibu‹_cÚ¡__
 
	`__©Œibu‹__
 ((
__cÚ¡__
))

	)

235 
	#__©Œibu‹_cÚ¡__


	)

241 #ià
__GNUC_PREREQ
 (3,1)

242 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__u£d__
))

	)

243 
	#__©Œibu‹_nošlše__
 
	`__©Œibu‹__
 ((
__nošlše__
))

	)

245 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__unu£d__
))

	)

246 
	#__©Œibu‹_nošlše__


	)

250 #ià
__GNUC_PREREQ
 (3,2)

251 
	#__©Œibu‹_d•»ÿ‹d__
 
	`__©Œibu‹__
 ((
__d•»ÿ‹d__
))

	)

253 
	#__©Œibu‹_d•»ÿ‹d__


	)

259 #ià
__GNUC_PREREQ
 (4,5) || \

260 
	$__glibc_şªg_has_ex‹nsiÚ
 (
__©Œibu‹_d•»ÿ‹d_w™h_mes§ge__
)

261 
	#__©Œibu‹_d•»ÿ‹d_msg__
(
msg
) \

262 
	`__©Œibu‹__
 ((
	`__d•»ÿ‹d__
 (
msg
)))

	)

264 
	#__©Œibu‹_d•»ÿ‹d_msg__
(
msg
è
__©Œibu‹_d•»ÿ‹d__


	)

273 #ià
	`__GNUC_PREREQ
 (2,8)

274 
	#__©Œibu‹_fÜm©_¬g__
(
x
è
	`__©Œibu‹__
 ((
	`__fÜm©_¬g__
 (x)))

	)

276 
	#__©Œibu‹_fÜm©_¬g__
(
x
è

	)

283 #ià
	`__GNUC_PREREQ
 (2,97)

284 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
) \

285 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__¡rfmÚ__
, 
a
, 
b
)))

	)

287 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
è

	)

292 #ià
	`__GNUC_PREREQ
 (3,3)

293 
	#__nÚnuÎ
(
·¿ms
è
	`__©Œibu‹__
 ((
__nÚnuÎ__
…¬ams))

	)

295 
	#__nÚnuÎ
(
·¿ms
)

	)

300 #ià
	`__GNUC_PREREQ
 (3,4)

301 
	#__©Œibu‹_w¬n_unu£d_»suÉ__
 \

302 
	`__©Œibu‹__
 ((
__w¬n_unu£d_»suÉ__
))

	)

303 #ià
__USE_FORTIFY_LEVEL
 > 0

304 
	#__wur
 
__©Œibu‹_w¬n_unu£d_»suÉ__


	)

307 
	#__©Œibu‹_w¬n_unu£d_»suÉ__


	)

309 #iâdeà
__wur


310 
	#__wur


	)

314 #ià
	`__GNUC_PREREQ
 (3,2)

318 #undeà
__®ways_šlše


319 
	#__®ways_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__®ways_šlše__
))

	)

321 #undeà
__®ways_šlše


322 
	#__®ways_šlše
 
__šlše


	)

327 #ià
	`__GNUC_PREREQ
 (4,3)

328 
	#__©Œibu‹_¬tificŸl__
 
	`__©Œibu‹__
 ((
__¬tificŸl__
))

	)

330 
	#__©Œibu‹_¬tificŸl__


	)

342 #ià(!
defšed
 
__ılu¥lus
 || 
	`__GNUC_PREREQ
 (4,3) \

343 || (
defšed
 
__şªg__
 && (defšed 
__GNUC_STDC_INLINE__
 \

344 || 
defšed
 
__GNUC_GNU_INLINE__
)))

345 #ià
defšed
 
__GNUC_STDC_INLINE__
 || defšed 
__ılu¥lus


346 
	#__ex‹º_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

347 
	#__ex‹º_®ways_šlše
 \

348 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

350 
	#__ex‹º_šlše
 
__šlše


	)

351 
	#__ex‹º_®ways_šlše
 
__®ways_šlše


	)

355 #ifdeà
__ex‹º_®ways_šlše


356 
	#__fÜtify_funùiÚ
 
__ex‹º_®ways_šlše
 
__©Œibu‹_¬tificŸl__


	)

361 #ià
	`__GNUC_PREREQ
 (4,3)

362 
	#__va_¬g_·ck
(è
	`__butš_va_¬g_·ck
 ()

	)

363 
	#__va_¬g_·ck_Ën
(è
	`__butš_va_¬g_·ck_Ën
 ()

	)

370 #ià!
	`__GNUC_PREREQ
 (2,8)

371 
	#__ex‹nsiÚ__


	)

375 #ià!
	`__GNUC_PREREQ
 (2,92)

376 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

377 
	#__»¡riù
 
»¡riù


	)

379 
	#__»¡riù


	)

386 #ià
	`__GNUC_PREREQ
 (3,1è&& !
defšed
 
__GNUG__


387 
	#__»¡riù_¬r
 
__»¡riù


	)

389 #ifdeà
__GNUC__


390 
	#__»¡riù_¬r


	)

392 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

393 
	#__»¡riù_¬r
 
»¡riù


	)

396 
	#__»¡riù_¬r


	)

401 #ià
__GNUC__
 >= 3

402 
	#__glibc_uÆik–y
(
cÚd
è
	`__butš_ex³ù
 ((cÚd), 0)

	)

403 
	#__glibc_lik–y
(
cÚd
è
	`__butš_ex³ù
 ((cÚd), 1)

	)

405 
	#__glibc_uÆik–y
(
cÚd
è(cÚd)

	)

406 
	#__glibc_lik–y
(
cÚd
è(cÚd)

	)

409 #ifdeà
__has_©Œibu‹


410 
	#__glibc_has_©Œibu‹
(
©Œ
è
	`__has_©Œibu‹
 (©Œ)

	)

412 
	#__glibc_has_©Œibu‹
(
©Œ
è0

	)

415 #ià(!
defšed
 
_NÜ‘uº
 \

416 && (
defšed
 
__STDC_VERSION__
 ? __STDC_VERSION__ : 0) < 201112 \

417 && !
	$__GNUC_PREREQ
 (4,7))

418 #ià
	`__GNUC_PREREQ
 (2,8)

419 
	#_NÜ‘uº
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

	)

421 
	#_NÜ‘uº


	)

425 #ià
	`__GNUC_PREREQ
 (8, 0)

429 
	#__©Œibu‹_nÚ¡ršg__
 
	`__©Œibu‹__
 ((
__nÚ¡ršg__
))

	)

431 
	#__©Œibu‹_nÚ¡ršg__


	)

435 #undeà
__©Œibu‹_cİy__


436 #ià
	`__GNUC_PREREQ
 (9, 0)

439 
	#__©Œibu‹_cİy__
(
¬g
è
	`__©Œibu‹__
 ((
	`__cİy__
 (¬g)))

	)

441 
	#__©Œibu‹_cİy__
(
¬g
)

	)

444 #ià(!
defšed
 
_Stic_as£¹
 && !defšed 
__ılu¥lus
 \

445 && (
defšed
 
__STDC_VERSION__
 ? __STDC_VERSION__ : 0) < 201112 \

446 && (!
	`__GNUC_PREREQ
 (4, 6è|| 
defšed
 
__STRICT_ANSI__
))

447 
	#_Stic_as£¹
(
ex´
, 
dŸgno¡ic
) \

448 (*
	`__Stic_as£¹_funùiÚ
 ()) \

449 [!! (¡ruù { 
__”rÜ_if_Ãg©ive
: (
ex´
è? 2 : -1; })]

	)

452 
	~<b™s/wÜdsize.h
>

453 
	~<b™s/lÚg-doubË.h
>

455 #ià
defšed
 
__LONG_DOUBLE_MATH_OPTIONAL
 && defšed 
__NO_LONG_DOUBLE_MATH


456 
	#__LDBL_COMPAT
 1

	)

457 #ifdeà
__REDIRECT


458 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

459 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
) \

460 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

461 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT_NTH
 (Çme,…rÙo,‡lŸs)

	)

462 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
) \

463 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

464 
	#__LDBL_REDIR1_DECL
(
Çme
, 
®Ÿs
) \

465 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 (#®Ÿs));

	)

466 
	#__LDBL_REDIR_DECL
(
Çme
) \

467 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 ("__Ædbl_" #Çme));

	)

468 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

469 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

470 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

471 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

474 #ià!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT


475 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm
	)
proto

476 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
èÇm
	)
proto

477 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
__THROW


	)

478 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
èÇm´ÙØ
__THROW


	)

479 
	#__LDBL_REDIR_DECL
(
Çme
)

	)

480 #ifdeà
__REDIRECT


481 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

482 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

483 
	`__REDIRECT_NTH
 (
Çme
, 
´Ùo
, 
®Ÿs
)

	)

492 #ià
	`__GNUC_PREREQ
 (4,8è|| 
	`__glibc_şªg_´”eq
 (3,5)

493 
	#__glibc_maüo_w¬nšg1
(
mes§ge
è
	`_P¿gma
 (#mes§ge)

	)

494 
	#__glibc_maüo_w¬nšg
(
mes§ge
) \

495 
	`__glibc_maüo_w¬nšg1
 (
GCC
 
w¬nšg
 
mes§ge
)

	)

497 
	#__glibc_maüo_w¬nšg
(
msg
)

	)

507 #ià!
defšed
 
__ılu¥lus
 \

508 && (
	`__GNUC_PREREQ
 (4, 9) \

509 || 
	`__glibc_şªg_has_ex‹nsiÚ
 (
c_g’”ic_£ËùiÚs
) \

510 || (!
defšed
 
__GNUC__
 && defšed 
__STDC_VERSION__
 \

511 && 
__STDC_VERSION__
 >= 201112L))

512 
	#__HAVE_GENERIC_SELECTION
 1

	)

514 
	#__HAVE_GENERIC_SELECTION
 0

	)

	@/usr/include/asm-generic/bitsperlong.h

2 #iâdeà
__ASM_GENERIC_BITS_PER_LONG


3 
	#__ASM_GENERIC_BITS_PER_LONG


	)

12 #iâdeà
__BITS_PER_LONG


13 
	#__BITS_PER_LONG
 32

	)

	@/usr/include/bits/long-double.h

	@/usr/include/bits/wordsize.h

3 #ià
defšed
 
__x86_64__
 && !defšed 
__ILP32__


4 
	#__WORDSIZE
 64

	)

6 
	#__WORDSIZE
 32

	)

7 
	#__WORDSIZE32_SIZE_ULONG
 0

	)

8 
	#__WORDSIZE32_PTRDIFF_LONG
 0

	)

11 #ifdeà
__x86_64__


12 
	#__WORDSIZE_TIME64_COMPAT32
 1

	)

14 
	#__SYSCALL_WORDSIZE
 64

	)

16 
	#__WORDSIZE_TIME64_COMPAT32
 0

	)

	@/usr/include/gnu/stubs-64.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___com·t_bdæush


	)

11 
	#__¡ub_chæags


	)

12 
	#__¡ub_ç‰ach


	)

13 
	#__¡ub_fchæags


	)

14 
	#__¡ub_fd‘ach


	)

15 
	#__¡ub_g‘msg


	)

16 
	#__¡ub_g‰y


	)

17 
	#__¡ub_lchmod


	)

18 
	#__¡ub_putmsg


	)

19 
	#__¡ub_»voke


	)

20 
	#__¡ub_£ogš


	)

21 
	#__¡ub_sig»tuº


	)

22 
	#__¡ub_s¡k


	)

23 
	#__¡ub_¡ty


	)

	@
1
.
1
/usr/include
110
2438
acl.c
acl.h
balloc.c
bitmap.c
block_validity.c
dir.c
ext4.h
ext4_extents.h
ext4_jbd2.c
ext4_jbd2.h
extents.c
extents_status.c
extents_status.h
file.c
fsmap.c
fsmap.h
fsync.c
hash.c
ialloc.c
indirect.c
inline.c
inode.c
ioctl.c
mballoc.c
mballoc.h
migrate.c
mmp.c
move_extent.c
namei.c
page-io.c
readpage.c
resize.c
stats.c
super.c
symlink.c
sysfs.c
truncate.h
xattr.c
xattr.h
xattr_security.c
xattr_trusted.c
xattr_user.c
/usr/include/asm/byteorder.h
/usr/include/linux/capability.h
/usr/include/linux/errno.h
/usr/include/linux/falloc.h
/usr/include/linux/fcntl.h
/usr/include/linux/fiemap.h
/usr/include/linux/fs.h
/usr/include/linux/fsmap.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/quota.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/utsname.h
/usr/include/linux/uuid.h
/usr/include/linux/version.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/asm/errno.h
/usr/include/asm/fcntl.h
/usr/include/asm/types.h
/usr/include/linux/byteorder/little_endian.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/string.h
/usr/include/asm-generic/errno.h
/usr/include/asm-generic/fcntl.h
/usr/include/asm-generic/types.h
/usr/include/asm/ioctl.h
/usr/include/asm/posix_types.h
/usr/include/bits/libc-header-start.h
/usr/include/bits/string_fortified.h
/usr/include/bits/types/locale_t.h
/usr/include/linux/stddef.h
/usr/include/linux/swab.h
/usr/include/strings.h
/usr/include/asm-generic/errno-base.h
/usr/include/asm-generic/int-ll64.h
/usr/include/asm-generic/ioctl.h
/usr/include/asm/posix_types_32.h
/usr/include/asm/posix_types_64.h
/usr/include/asm/posix_types_x32.h
/usr/include/asm/swab.h
/usr/include/bits/strings_fortified.h
/usr/include/bits/types/__locale_t.h
/usr/include/features.h
/usr/include/asm-generic/posix_types.h
/usr/include/asm/bitsperlong.h
/usr/include/gnu/stubs.h
/usr/include/stdc-predef.h
/usr/include/sys/cdefs.h
/usr/include/asm-generic/bitsperlong.h
/usr/include/bits/long-double.h
/usr/include/bits/wordsize.h
/usr/include/gnu/stubs-64.h
